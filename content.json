[{"title":"Javaå®¹å™¨ç±»æºç ç ”ç©¶:Collection","date":"2017-09-06T07:48:58.000Z","path":"2017/09/06/Javaå®¹å™¨ç±»æºç ç ”ç©¶-Collection/","text":"é›†åˆç±»å…³ç³»ï¼šCollectionâ”œListâ”‚â”œLinkedListâ”‚â”œArrayListâ”‚â””Vectorâ”‚ â””Stackâ””SetMapâ”œHashtableâ”œHashMapâ””WeakHashMap Collectionjava.util.Collection Collectionæ˜¯Listå’ŒSetçš„çˆ¶æ¥å£ã€‚å®ƒç»§æ‰¿äº†Iterableæ¥å£ï¼Œæ‰€ä»¥æ¯ä¸ªCollectionçš„å­ç±»åº”è¯¥æ˜¯å¯ä»¥è¿­ä»£è®¿é—®å…¶ä¸­çš„å…ƒç´ çš„ã€‚ æˆ‘æ³¨æ„åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨Java1.8ä¸­å¼•å…¥ã€‚è¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯ä»é›†åˆä¸­åˆ é™¤æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ï¼Œä»£ç å®ç°å¹³å¹³æ— å¥‡ï¼Œä¸»è¦æ˜¯å‡½æ•°æœ‰ä¸€ä¸ªdefaultä¿®é¥°ã€‚Java8æä¾›äº†defaultè®©æ¥å£ä¸­ä¹Ÿå¯ä»¥å®ç°æ–¹æ³•ä½“ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©å¼€å‘è€…åœ¨ä¿®æ”¹interfaceæ—¶ï¼Œä¸å¿…å†ä¸€ä¸€ä¿®æ”¹å®ç°è¯¥æ¥å£çš„ç±»ï¼Œè¿™äº›ç±»å¯ä»¥ä½¿ç”¨é»˜è®¤çš„æ–¹æ³•å®ç°ã€‚ 123456789101112default boolean removeIf(Predicate&lt;? super E&gt; filter) &#123; Objects.requireNonNull(filter); boolean removed = false; final Iterator&lt;E&gt; each = iterator(); while (each.hasNext()) &#123; if (filter.test(each.next())) &#123; each.remove(); removed = true; &#125; &#125; return removed;&#125; Collectionçš„equalsæ–¹æ³•çš„é‡å†™éœ€è¦å°å¿ƒè°¨æ…ã€‚ç®€å•çš„ä½¿ç”¨å¼•ç”¨æ¯”è¾ƒè¿˜æ˜¯æ¯”è¾ƒç®€å•å®‰å…¨çš„ï¼Œå€¼æ¯”è¾ƒåˆ™ä¼šå˜å¤æ‚ã€‚ç›¸ç­‰å¿…é¡»æ˜¯å¯¹ç§°çš„ï¼Œçº¦å®šListåªèƒ½å’Œå…¶å®ƒListç›¸ç­‰ï¼ŒSetäº¦ç„¶ã€‚æ‰€ä»¥ä½ è‡ªå·±å®ç°çš„Collectionç±»åœ¨å’ŒListã€Setæ¯”è¾ƒæ—¶åº”è¯¥è¿”å›falseï¼Œå› ä¸ºå³ä½¿ä½ å®šåˆ¶çš„Collectionå¯ä»¥è¿”å›trueï¼Œä½†æ˜¯ä»Listçš„è§†è§’æ¥æ¯”è¾ƒï¼Œè¿”å›çš„æ˜¯falseï¼Œä¸æ»¡è¶³å¯¹ç§°æ€§ã€‚å› æ­¤ï¼Œä¹Ÿæ— æ³•æ­£ç¡®çš„å®ç°ä¸€ä¸ªæ—¢æœ‰Listæ¥å£ï¼Œåˆæœ‰Setæ¥å£çš„ç±»ã€‚ éµç…§çº¦å®šï¼Œå¦‚æœä½ é‡å†™äº†equalsæ–¹æ³•ï¼Œé‚£ä¹ˆä½ è¦åŒæ—¶é‡å†™hashCodeæ–¹æ³•ã€‚c1.equals(c2)æˆç«‹ï¼Œåˆ™c1.hashCode()==c2.hashCode()ã€‚ Spliteratoræ¥å£åœ¨Java8ä¸­å¼•å…¥ï¼Œè¿™ä¸ªå•è¯æ˜¯Splitå’Œiteratorçš„åˆæˆï¼Œç”¨æ¥åˆ†å‰²é›†åˆä»¥ç»™å¹¶è¡Œå¤„ç†æä¾›æ–¹ä¾¿ã€‚çœ‹ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122public class Ripper &#123; public static void main(String[] args) &#123; Collection&lt;Integer&gt; numbers = new ArrayList&lt;&gt;(); for (int i = 0; i &lt; 10; i++) &#123; numbers.add(i); &#125; Spliterator&lt;Integer&gt; sp = numbers.spliterator(); System.out.println(sp.characteristics()); System.out.println(sp.estimateSize()); Spliterator&lt;Integer&gt; sp2=sp.trySplit(); System.out.println(sp.estimateSize()); System.out.println(sp2.estimateSize()); Spliterator&lt;Integer&gt; sp3=sp.trySplit(); System.out.println(sp.estimateSize()); System.out.println(sp3.estimateSize()); sp3. &#125;&#125; è¿è¡Œç»“æœï¼š 12345616464105532 ç›¸è¾ƒäºä¼ ç»Ÿçš„iteratorï¼Œspliteratorå¯ä»¥é€’å½’çš„å¯¹é›†åˆè¿›è¡Œåˆ’åˆ†ï¼Œæ¯ä¸ªspliteratorç®¡ç†äº†åŸæ¥é›†åˆä¸­çš„éƒ¨åˆ†å…ƒç´ ã€‚ä½†æ˜¯ï¼Œæ¯ä¸ªspliteratorå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¹¶è¡Œå¤„ç†æ—¶ï¼Œè¦ä¿è¯æ¯ä¸€ä¸ªåˆ’åˆ†åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿›è¡Œå¤„ç†ã€‚ Collectionæä¾›Streamå¯¹å…ƒç´ è¿›è¡Œæµå¤„ç†ï¼Œå…¶ä¸­ç”¨åˆ°äº†spliteratorã€‚çœ‹ä¸ªä¾‹å­ï¼š 12345678910111213141516171819public class Ripper &#123; public static void main(String[] args) &#123; Collection&lt;Integer&gt; numbers = new ArrayList&lt;&gt;(); for (int i = 0; i &lt; 10; i++) &#123; numbers.add(i); &#125; Stream&lt;Integer&gt; stream = numbers.stream(); List&lt;Integer&gt; filterNum=stream.filter(item -&gt; item &gt; 5).collect(Collectors.toList()); for(Integer i:filterNum)&#123; System.out.print(i+\" \"); &#125; filterNum.set(0,100); System.out.println(); for(Integer i:numbers)&#123; System.out.print(i+\" \"); &#125; &#125;&#125; ç»“æœï¼š126 7 8 9 0 1 2 3 4 5 6 7 8 9 é›†åˆç»è¿‡ä¸¤æ­¥å¤„ç†ï¼Œè¿‡æ»¤å‡ºäº†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ã€‚Streamæ•´ä½“å¤„ç†è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š1.Configurationï¼Œ2.Processingã€‚Filteræ˜¯Configurationï¼Œcollectæ˜¯Processingã€‚è¿˜å¯ä»¥çœ‹å‡ºä¸€ç‚¹ï¼Œæœ€åè·å–çš„ç»“æœListæ˜¯ä¸€ä¸ªæ–°å»ºçš„Listï¼Œå¹¶ä¸å’ŒåŸListå…±äº«å†…å­˜ä¸­çš„å…ƒç´ ã€‚ å†çœ‹ä¸€ä¸ªreduceçš„ä¾‹å­ï¼š123456789101112public class Ripper &#123; public static void main(String[] args) &#123; Collection&lt;Integer&gt; numbers = new ArrayList&lt;&gt;(); for (int i = 0; i &lt; 10; i++) &#123; numbers.add(i); &#125; Stream&lt;Integer&gt; stream = numbers.stream(); int result=stream.reduce(0, (acc, item) -&gt; acc + item); System.out.println(result); &#125;&#125; ç»“æœæ˜¯ï¼š45ã€‚è¿™æ˜¯ä¸€ä¸ªæ±‚å’Œè¿ç®—ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°0æ˜¯accçš„åˆå§‹å€¼ï¼Œaccè¡¨ç¤ºä¸Šä¸€æ­¥(acc, item) -&gt; acc + itemçš„ç»“æœï¼Œitemæ˜¯æ¯æ¬¡ä»streamä¸­å–çš„å€¼ã€‚è¿™äº›Configurationå¹¶ä¸ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯ç­‰åˆ°æœ€åä¸€ä¸ªProcessingå‡½æ•°ï¼Œç»Ÿä¸€æ‰§è¡Œã€‚ åœ¨Collectionä¸­æœ‰parallelStreamæä¾›å¹¶è¡Œè¿ç®—ï¼Œå¹¶ä¸”ä½¿ç”¨äº†é»˜è®¤çš„spliteratorå¯¹é›†åˆè¿›è¡Œåˆ’åˆ†ã€‚ä¾‹å­å¦‚ä¸‹ï¼š 1234567891011121314public class Ripper &#123; public static void main(String[] args) &#123; Collection&lt;Integer&gt; numbers = new ArrayList&lt;&gt;(); for (int i = 0; i &lt; 10; i++) &#123; numbers.add(i); &#125; Stream&lt;Integer&gt; stream = numbers.parallelStream(); stream.forEach(item -&gt; System.out.print(item+\" \")); System.out.println(); stream=numbers.stream(); stream.forEach(item -&gt; System.out.print(item+\" \")); &#125;&#125; ç»“æœï¼š121 2 6 8 0 4 3 5 9 7 0 1 2 3 4 5 6 7 8 9 å¯è§ï¼Œå¹¶è¡Œè¿ç®—æ— æ³•ä¿è¯æ¯ä¸ªå…ƒç´ è¢«å¤„ç†çš„é¡ºåºã€‚","tags":[{"name":"Java","slug":"Java","permalink":"http://itanch.github.io/tags/Java/"},{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"}]},{"title":"ä½ çš„åå­—è§‚æ„Ÿ","date":"2017-09-05T07:16:14.000Z","path":"2017/09/05/ä½ çš„åå­—è§‚æ„Ÿ/","text":"ä½ çš„åå­—ï¼Œä¸€ç§é«˜ç«¯çš„çˆ±æƒ…è¡¨è¾¾å½¢å¼ã€‚ å½—æ˜Ÿæ¥ä¸´è‡´ä½¿æ—¶ç©ºé”™ä¹±ï¼Œä¸ä»–äººäº§ç”Ÿè·¨è¶Šæ—¶ç©ºçš„äº¤æµï¼Œè¿™ä¸ªè®¾å®šå¾ˆå¤šç”µå½±ä¸­å·²ç»ç”¨è¿‡ã€‚ ç¾å›½äººå¯èƒ½ä¼šä»¥æ­¤æ¥å†™ä¸€ä¸ªå„¿å­ä¸çˆ¶äº²è·¨è¶Šæ—¶ç©ºå¯¹è¯ï¼Œä¸€åŒç ´æ¡ˆçš„æ•…äº‹ï¼Œè§â€œé»‘æ´é¢‘ç‡ï¼ˆ2000ï¼‰â€ã€‚ ä¹Ÿå¯èƒ½ä¼šæä¸€ä¸ªæ—¶ç©ºé‡å ï¼ŒæŒ–æ˜äººæ€§çš„æ‚²å‰§ï¼Œæ¯”å¦‚â€œå½—æ˜Ÿæ¥çš„é‚£ä¸€å¤œâ€ã€‚ æ–°æµ·è¯šå´ç”¨æ­¤æ¥è¡¨ç°çˆ±æƒ…ã€‚ æˆ‘åœ¨â€œç§’é€Ÿäº”å˜ç±³â€å’Œè¿™ä¸ªæ•…äº‹ä¸­æ„Ÿè§‰æ˜¯ç›¸ä¼¼çš„ã€‚ é’æ˜¥æœŸçš„çˆ±æƒ…ï¼Œå°±åƒä¸€åœºæ¢¦ï¼Œé†’æ¥ååªå‰©ä¸‹æ¨¡ç³Šçš„è®°å¿†ã€‚ è‡ªå·±åœ¨é’æ˜¥æœŸæ—¶å¯¹çˆ±æƒ…çš„æ„Ÿè§‰ï¼Œè¢«æ–°æµ·è¯šçš„åŠ¨ç”»è®²è¿°å‡ºæ¥ï¼Œè¿™ç§æ„Ÿè§‰æ˜¯ç•…å¿«çš„ã€‚ é’æ˜¥æœŸæ—¶çš„çˆ±æƒ…æ˜¯æ— æ‰€ç•æƒ§çš„å¯»æ‰¾ï¼Œæ˜¯ä¸€æ—¶çš„å†²åŠ¨ä¸ç›²ç›®ã€‚ æ˜¯ä¸¤ä¸ªäººç›¸è§æ—¶çš„çƒ­æ³ªï¼Œæ˜¯æ— æ³•ç›¸è§çš„æŒ‚å¿µã€‚ æ˜¯é”™è¿‡ï¼Œæ˜¯é—æ†¾ã€‚ æ˜¯é”™è¿‡åï¼Œä¸ç»æ„é—´çš„å†æ¬¡ç›¸é‡ã€‚","tags":[{"name":"è®°å½•","slug":"è®°å½•","permalink":"http://itanch.github.io/tags/è®°å½•/"}]},{"title":"springå­¦ä¹ _beançš„è£…é…","date":"2017-06-25T11:48:39.000Z","path":"2017/06/25/springå­¦ä¹ -1/","text":"è£…é…beanDIå¯ä»¥é™ä½æ¨¡å—ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä¸€ä¸ªç±»é€šè¿‡å®šä¹‰æ¥å£æ¥è¢«æ³¨å…¥ä¾èµ–ã€‚é…ç½®æ–‡ä»¶æè¿°äº†å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒSpringå®¹å™¨ä¼šæ ¹æ®é…ç½®æ–‡ä»¶è£…é…beanã€‚ æœ‰ä¸‰ç§è£…é…beançš„æ–¹å¼ï¼š åœ¨javaä¸­ç°å¼é…ç½®ï¼› åœ¨XMLæ–‡ä»¶ä¸­ç°å¼é…ç½®ï¼› éšå¼beanå‘ç°å’Œè£…é…ã€‚ é¡¹ç›®å®è·µé’ˆå¯¹ä¸Šè¿°ä¸‰ç§è£…é…beançš„æ–¹å¼ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„é¡¹ç›®è¿›è¡Œå­¦ä¹ ã€‚ é¦–å…ˆåˆ›å»ºäº†mavené¡¹ç›®ï¼Œå¹¶ä¸”pom.xmlåŠ å…¥æ‰€éœ€çš„ä¾èµ–ï¼š 123456789101112131415161718192021222324252627282930313233343536&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;project xmlns=\"http://maven.pache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.tc&lt;/groupId&gt; &lt;artifactId&gt;spring&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;4.3.9.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-test --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-test&lt;/artifactId&gt; &lt;version&gt;4.3.9.RELEASE&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/project&gt; è‡ªåŠ¨åŒ–è£…é…beanç¤ºä¾‹ä¸­æœ‰ä¸¤ä¸ªbeanï¼Œå…¶ä¸­CDPlayeréœ€è¦è£…é…CompactDiskã€‚ 12345678910111213141516171819package com.tc;import org.springframework.stereotype.Component;//æ³¨è§£æŒ‡æ˜äº†éœ€è¦è¢«è‡ªåŠ¨å‘ç°çš„bean@Componentpublic class CompactDisc &#123; private String title = \"Sgt\"; private String artist = \"Beatles\"; static int count = 0; public CompactDisc() &#123; count++; &#125; public String play() &#123; return \"Playing \" + title + \" by \" + artist + \" \" + count; &#125;&#125; 12345678910111213141516171819package com.tc;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;@Componentpublic class CDPlayer &#123; private CompactDisc cd; //è‡ªåŠ¨è£…é…ä¾èµ–çš„bean @Autowired public CDPlayer(CompactDisc cd) &#123; this.cd = cd; &#125; public String play() &#123; return cd.play(); &#125;&#125; é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡æ˜è‡ªåŠ¨æ‰«æ package com.tc; import org.springframework.context.annotation.ComponentScan; import org.springframework.context.annotation.Configuration; //æŒ‡æ˜è¯¥classæ˜¯ä¸€ä¸ªé…ç½®ï¼Œå¹¶ä¸”é‡‡ç”¨è‡ªåŠ¨æ‰«æ @Configuration @ComponentScan public class CDPlayerConfig { } è¿›è¡Œæµ‹è¯•ï¼š package com.tc; import org.junit.Test; import org.junit.runner.RunWith; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.test.context.ContextConfiguration; import org.springframework.test.context.junit4.SpringJUnit4ClassRunner; import static org.junit.Assert.assertEquals; import static org.junit.Assert.assertNotNull; @RunWith(SpringJUnit4ClassRunner.class) @ContextConfiguration(classes = CDPlayerConfig.class) public class CDPlayerTest { @Autowired private CompactDisc cd; @Autowired private CDPlayer player; //cdä¼šè¢«è‡ªåŠ¨è£…é…ï¼Œä¸ä¼šä¸ºnull @Test public void cdShouldNotBeNull() { assertNotNull(cd); } @Test public void playIsRight() { assertEquals(\"Playing Sgt by Beatles 1\", player.play()); } //CompactDiscå®ä¾‹åªè¢«åˆ›å»ºäº†ä¸€æ¬¡ï¼Œspringé»˜è®¤beanæ˜¯å•ä¾‹æ¨¡å¼ @Test public void cdIsSingle() { assertEquals(cd.play(), player.play()); } } é€šè¿‡javaè£…é…beané€šè¿‡javaè£…é…beanå’Œè‡ªåŠ¨è£…é…CompactDiscä¸CDPlayerçš„åŒºåˆ«åœ¨äºï¼Œå»æ‰äº†@Componentå’Œ@Autowiredæ ‡æ³¨ï¼Œå°†è¿™äº›ç±»å˜æˆäº†æ™®é€šçš„ç±»ã€‚ è€Œåœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œéœ€è¦å¦‚ä¸‹ä¿®æ”¹ï¼š package com.tc; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; @Configuration public class CDPlayerConfig { @Bean public CompactDisc compactDisc(){ return new CompactDisc(); } @Bean public CDPlayer cdPlayer(CompactDisc cd){ return new CDPlayer(cd); } } ä½¿ç”¨åŸæ¥çš„æµ‹è¯•ä»£ç ï¼Œå¯ä»¥å‘ç°æµ‹è¯•å¯ä»¥æˆåŠŸçš„é€šè¿‡ã€‚ é€šè¿‡XMLè£…é…beanåˆ›å»ºxmlé…ç½®æ–‡ä»¶src\\main\\resources\\play.xmlï¼Œå¹¶å¡«å…¥å¦‚ä¸‹é…ç½®å†…å®¹ï¼š &lt;?xml version = \"1.0\" encoding = \"UTF-8\"?&gt; &lt;beans xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd\"&gt; &lt;bean id=\"compactDisc\" class=\"com.tc.CompactDisc\"/&gt; &lt;bean id=\"cdPlayer\" class=\"com.tc.CDPlayer\"&gt; &lt;constructor-arg ref=\"compactDisc\"/&gt; &lt;/bean&gt; &lt;/beans&gt; æŠŠåŸæ¥çš„javaé…ç½®æ–‡ä»¶CDPlayerConfig.javaåˆ é™¤ï¼Œå¯ä»¥è¿è¡Œæµ‹è¯•ï¼Œç»“æœä¾ç„¶æ­£ç¡®ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"java","slug":"java","permalink":"http://itanch.github.io/tags/java/"},{"name":"spring","slug":"spring","permalink":"http://itanch.github.io/tags/spring/"}]},{"title":"Nettyå…¥é—¨-æ¶æ„","date":"2017-05-30T12:48:48.000Z","path":"2017/05/30/Nettyå…¥é—¨-2/","text":"å¾ªç¯åŠ æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å®ç°å¼‚æ­¥å’Œäº‹ä»¶é©±åŠ¨çš„æœ‰æ•ˆæ–¹å¼ã€‚åœ¨Androidæ¡†æ¶å’ŒNodejsæ¡†æ¶ä¸­ï¼Œéƒ½é‡‡ç”¨äº†ç±»ä¼¼çš„æ¶æ„ã€‚ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç» æ•´ä½“æ¶æ„ ä¸€ä¸ªEventLoopGroupåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªEventLoopï¼› ä¸€ä¸ªEventLoopåœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸå†…åªå’Œä¸€ä¸ªThreadç»‘å®šï¼› ä¸€ä¸ªChannelåœ¨ç”Ÿå‘½å‘¨æœŸå†…åªå’Œä¸€ä¸ªEventLoopç»‘å®šï¼› EventLoopå¯ä»¥è¢«åˆ†é…ç»™å¤šä¸ªChannelï¼› ä¸€ä¸ªChannelæœ‰ä¸€ä¸ªChannelPipelineï¼› ChannelPipelineä¸­æœ‰åŒå‘çš„å…¥ç«™/å‡ºç«™çš„Channelhandleré“¾ã€‚ åŸºäºNIOå¼‚æ­¥æ¨¡å‹ã€ŠNettyå®æˆ˜ã€‹ä¸­ç”»çš„å·²ç»éå¸¸æ¸…æ¥šï¼Œè¿™é‡Œæˆ‘ç…§æ¬äº†ä¸‹æ¥ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Netty","slug":"Netty","permalink":"http://itanch.github.io/tags/Netty/"},{"name":"java","slug":"java","permalink":"http://itanch.github.io/tags/java/"}]},{"title":"Nettyå…¥é—¨-ç®€ä»‹","date":"2017-05-29T02:49:38.000Z","path":"2017/05/29/Nettyå…¥é—¨-1/","text":"Netty is an asynchronous event-driven network application frameworkfor rapid development of maintainable high performance protocol servers &amp; clients. è¿™é‡Œé€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„EchoæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ¥æ¼”ç¤ºNettyçš„ä½¿ç”¨ã€‚å‚è€ƒã€ŠNettyå®æˆ˜ã€‹ã€‚ ç¯å¢ƒjava version â€œ1.8.0_121â€Java(TM) SE Runtime Environment (build 1.8.0_121-b13)Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode) Maven: 3.5.0 Netty: 4.1.11.Final æ–‡ä»¶ç»“æ„123456789101112131415161718192021222324252627282930.echoâ”œâ”€â”€ Clientâ”‚ â”œâ”€â”€ pom.xmlâ”‚ â”œâ”€â”€ srcâ”‚ â”‚ â”œâ”€â”€ mainâ”‚ â”‚ â”‚ â”œâ”€â”€ javaâ”‚ â”‚ â”‚ â”‚ â””â”€â”€ comâ”‚ â”‚ â”‚ â”‚ â””â”€â”€ tcâ”‚ â”‚ â”‚ â”‚ â””â”€â”€ echoâ”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ EchoClient.javaâ”‚ â”‚ â”‚ â”‚ â””â”€â”€ EchoClientHandler.javaâ”‚ â”‚ â”‚ â””â”€â”€ resourcesâ”‚ â”‚ â””â”€â”€ testâ”‚ â”‚ â”œâ”€â”€ javaâ”‚ â”‚ â””â”€â”€ resourcesâ”‚ â””â”€â”€ targetâ”œâ”€â”€ Serverâ”‚ â”œâ”€â”€ pom.xmlâ”‚ â”œâ”€â”€ srcâ”‚ â”‚ â”œâ”€â”€ mainâ”‚ â”‚ â”‚ â””â”€â”€ javaâ”‚ â”‚ â”‚ â””â”€â”€ comâ”‚ â”‚ â”‚ â””â”€â”€ tcâ”‚ â”‚ â”‚ â””â”€â”€ echoâ”‚ â”‚ â”‚ â”œâ”€â”€ EchoServer.javaâ”‚ â”‚ â”‚ â””â”€â”€ EchoServerHandler.javaâ”‚ â”‚ â””â”€â”€ testâ”‚ â”‚ â””â”€â”€ javaâ”‚ â””â”€â”€ targetâ””â”€â”€ pom.xml é¦–å…ˆä¸»ç›®å½•ä¸­æœ‰ä¸€ä¸ªpom.xmlæ–‡ä»¶ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªå­æ¨¡å—Serverå’ŒClientï¼Œæ¯ä¸ªå­æ¨¡å—åˆæœ‰è‡ªå·±çš„pom.xmlæ–‡ä»¶ã€‚ æ ¹pom.xml12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;com.tc&lt;/groupId&gt; &lt;artifactId&gt;echo&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;packaging&gt;pom&lt;/packaging&gt; &lt;name&gt;echo&lt;/name&gt; &lt;description&gt; Build an Echo Server and Client &lt;/description&gt; &lt;modules&gt; &lt;module&gt;Client&lt;/module&gt; &lt;module&gt;Server&lt;/module&gt; &lt;/modules&gt; &lt;url&gt;http://maven.apache.org&lt;/url&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;echo-server.hostname&gt;localhost&lt;/echo-server.hostname&gt; &lt;echo-server.port&gt;8888&lt;/echo-server.port&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;3.8.1&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-all&lt;/artifactId&gt; &lt;version&gt;4.1.11.Final&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.3&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;1.7&lt;/source&gt; &lt;target&gt;1.7&lt;/target&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt; &lt;version&gt;2.18.1&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt; &lt;version&gt;2.18.1&lt;/version&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt; &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.2.1&lt;/version&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; æ³¨æ„æ ¹pom.xmlæ˜¯ä¸€ä¸ªpomé¡¹ç›®ï¼Œå¹¶ä¸”å®šä¹‰äº†ä¸¤ä¸ªmoduleï¼šClientï¼ŒServerã€‚æ ¹ç›®å½•ä¸‹åªæœ‰ä¸€ä¸ªpomæ–‡ä»¶å’Œä¸¤ä¸ªå­æ¨¡å—é¡¹ç›®ï¼Œæ²¡æœ‰å…·ä½“çš„ä»£ç ã€‚ è¿™é‡Œå…ˆå£°æ˜äº†æ•´ä¸ªé¡¹ç›®çš„æ‰€éœ€çš„ä¾èµ–netty-allï¼ŒåŒæ—¶å£°æ˜äº†ä¸€ä¸‹åç»­éœ€è¦ä½¿ç”¨çš„æ’ä»¶ã€‚ Server12345678910111213141516171819202122232425262728293031323334353637&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;com.tc&lt;/groupId&gt; &lt;artifactId&gt;echo&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;/parent&gt; &lt;artifactId&gt;Server&lt;/artifactId&gt; &lt;name&gt;Echo Server&lt;/name&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt; &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;run-server&lt;/id&gt; &lt;goals&gt; &lt;goal&gt;java&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;mainClass&gt;com.tc.echo.EchoServer&lt;/mainClass&gt; &lt;arguments&gt; &lt;argument&gt;$&#123;echo-server.port&#125;&lt;/argument&gt; &lt;/arguments&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; Serverçš„pomç»§æ‰¿äº†ä¸Šä¸€æ ¹é¡¹ç›®echoçš„pomï¼Œæ‰€ä»¥echoä¸­pomçš„å†…å®¹ä¹Ÿä¼šåº”ç”¨äºServerã€‚åŒæ—¶è¿™é‡Œè¿˜å®šä¹‰äº†æ‰§è¡Œæ–¹æ³•ï¼ŒæŒ‡å®šçš„ä¸»å‡½æ•°å…¥å£ï¼Œå¹¶ä¸”è®¾ç½®äº†éœ€è¦ä¼ å…¥çš„å‚æ•°ã€‚ EchoServerHandler.java:123456789101112131415161718192021222324252627282930313233343536373839404142434445package com.tc.echo;import io.netty.buffer.ByteBuf;import io.netty.buffer.Unpooled;import io.netty.channel.ChannelFutureListener;import io.netty.channel.ChannelHandler.Sharable;import io.netty.channel.ChannelHandlerContext;import io.netty.channel.ChannelInboundHandlerAdapter;import io.netty.util.CharsetUtil;/** * ä»£ç æ¸…å• 2-1 EchoServerHandler * * @author &lt;a href=\"mailto:norman.maurer@gmail.com\"&gt;Norman Maurer&lt;/a&gt; *///æ ‡ç¤ºä¸€ä¸ªChannelHandlerå¯ä»¥è¢«å¤šä¸ª Channel å®‰å…¨åœ°å…±äº«@Sharablepublic class EchoServerHandler extends ChannelInboundHandlerAdapter &#123; @Override public void channelRead(ChannelHandlerContext ctx, Object msg) &#123; ByteBuf in = (ByteBuf) msg; //å°†æ¶ˆæ¯è®°å½•åˆ°æ§åˆ¶å° System.out.println( \"Server received: \" + in.toString(CharsetUtil.UTF_8)); //å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯å†™ç»™å‘é€è€…ï¼Œè€Œä¸å†²åˆ·å‡ºç«™æ¶ˆæ¯ ctx.write(in); &#125; @Override public void channelReadComplete(ChannelHandlerContext ctx) throws Exception &#123; //å°†æœªå†³æ¶ˆæ¯å†²åˆ·åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œå¹¶ä¸”å…³é—­è¯¥ Channel ctx.writeAndFlush(Unpooled.EMPTY_BUFFER) .addListener(ChannelFutureListener.CLOSE); &#125; @Override public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) &#123; //æ‰“å°å¼‚å¸¸æ ˆè·Ÿè¸ª cause.printStackTrace(); //å…³é—­è¯¥Channel ctx.close(); &#125;&#125; åˆ›å»ºä¸€ä¸ªhandleræ¥å¤„ç†ç½‘ç»œé“¾æ¥ä¸­çš„äº‹åŠ¡ã€‚ EchoServer:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172package com.tc.echo;import io.netty.bootstrap.ServerBootstrap;import io.netty.channel.ChannelFuture;import io.netty.channel.ChannelInitializer;import io.netty.channel.EventLoopGroup;import io.netty.channel.nio.NioEventLoopGroup;import io.netty.channel.socket.SocketChannel;import io.netty.channel.socket.nio.NioServerSocketChannel;import java.net.InetSocketAddress;/** * ä»£ç æ¸…å• 2-2 EchoServer ç±» * * @author &lt;a href=\"mailto:norman.maurer@gmail.com\"&gt;Norman Maurer&lt;/a&gt; */public class EchoServer &#123; private final int port; public EchoServer(int port) &#123; this.port = port; &#125; public static void main(String[] args) throws Exception &#123; if (args.length != 1) &#123; System.err.println(\"Usage: \" + EchoServer.class.getSimpleName() + \" &lt;port&gt;\" ); return; &#125; //è®¾ç½®ç«¯å£å€¼ï¼ˆå¦‚æœç«¯å£å‚æ•°çš„æ ¼å¼ä¸æ­£ç¡®ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ªNumberFormatExceptionï¼‰ int port = Integer.parseInt(args[0]); //è°ƒç”¨æœåŠ¡å™¨çš„ start()æ–¹æ³• new EchoServer(port).start(); &#125; public void start() throws Exception &#123; final EchoServerHandler serverHandler = new EchoServerHandler(); //(1) åˆ›å»ºEventLoopGroup EventLoopGroup group = new NioEventLoopGroup(); try &#123; //(2) åˆ›å»ºServerBootstrap ServerBootstrap b = new ServerBootstrap(); b.group(group) //(3) æŒ‡å®šæ‰€ä½¿ç”¨çš„ NIO ä¼ è¾“ Channel .channel(NioServerSocketChannel.class) //(4) ä½¿ç”¨æŒ‡å®šçš„ç«¯å£è®¾ç½®å¥—æ¥å­—åœ°å€ .localAddress(new InetSocketAddress(port)) //(5) æ·»åŠ ä¸€ä¸ªEchoServerHandleråˆ°äºChannelçš„ ChannelPipeline .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override public void initChannel(SocketChannel ch) throws Exception &#123; //EchoServerHandler è¢«æ ‡æ³¨ä¸º@Shareableï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ€»æ˜¯ä½¿ç”¨åŒæ ·çš„å®ä¾‹ //è¿™é‡Œå¯¹äºæ‰€æœ‰çš„å®¢æˆ·ç«¯è¿æ¥æ¥è¯´ï¼Œéƒ½ä¼šä½¿ç”¨åŒä¸€ä¸ª EchoServerHandlerï¼Œå› ä¸ºå…¶è¢«æ ‡æ³¨ä¸º@Sharableï¼Œ //è¿™å°†åœ¨åé¢çš„ç« èŠ‚ä¸­è®²åˆ°ã€‚ ch.pipeline().addLast(serverHandler); &#125; &#125;); //(6) å¼‚æ­¥åœ°ç»‘å®šæœåŠ¡å™¨ï¼›è°ƒç”¨ sync()æ–¹æ³•é˜»å¡ç­‰å¾…ç›´åˆ°ç»‘å®šå®Œæˆ ChannelFuture f = b.bind().sync(); System.out.println(EchoServer.class.getName() + \" started and listening for connections on \" + f.channel().localAddress()); //(7) è·å– Channel çš„CloseFutureï¼Œå¹¶ä¸”é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å®ƒå®Œæˆ f.channel().closeFuture().sync(); &#125; finally &#123; //(8) å…³é—­ EventLoopGroupï¼Œé‡Šæ”¾æ‰€æœ‰çš„èµ„æº group.shutdownGracefully().sync(); &#125; &#125;&#125; å¯åŠ¨Serverã€‚ Clientpom.xml:123456789101112131415161718192021222324252627282930313233343536&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;com.tc&lt;/groupId&gt; &lt;artifactId&gt;echo&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;/parent&gt; &lt;artifactId&gt;Client&lt;/artifactId&gt; &lt;name&gt;Echo Client&lt;/name&gt; &lt;build&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt; &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;run-client&lt;/id&gt; &lt;goals&gt; &lt;goal&gt;java&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;mainClass&gt;com.tc.echo.EchoClient&lt;/mainClass&gt; &lt;arguments&gt; &lt;argument&gt;$&#123;echo-server.hostname&#125;&lt;/argument&gt; &lt;argument&gt;$&#123;echo-server.port&#125;&lt;/argument&gt; &lt;/arguments&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; EchoClientHandler.java:123456789101112131415161718192021222324252627282930313233343536373839package com.tc.echo;import io.netty.buffer.ByteBuf;import io.netty.buffer.Unpooled;import io.netty.channel.ChannelHandler.Sharable;import io.netty.channel.ChannelHandlerContext;import io.netty.channel.SimpleChannelInboundHandler;import io.netty.util.CharsetUtil;/** * ä»£ç æ¸…å• 2-3 å®¢æˆ·ç«¯çš„ ChannelHandler * * @author &lt;a href=\"mailto:norman.maurer@gmail.com\"&gt;Norman Maurer&lt;/a&gt; */@Sharable//æ ‡è®°è¯¥ç±»çš„å®ä¾‹å¯ä»¥è¢«å¤šä¸ª Channel å…±äº«public class EchoClientHandler extends SimpleChannelInboundHandler&lt;ByteBuf&gt; &#123; @Override public void channelActive(ChannelHandlerContext ctx) &#123; //å½“è¢«é€šçŸ¥ Channelæ˜¯æ´»è·ƒçš„æ—¶å€™ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ ctx.writeAndFlush(Unpooled.copiedBuffer(\"Netty rocks!\", CharsetUtil.UTF_8)); &#125; @Override public void channelRead0(ChannelHandlerContext ctx, ByteBuf in) &#123; //è®°å½•å·²æ¥æ”¶æ¶ˆæ¯çš„è½¬å‚¨ System.out.println( \"Client received: \" + in.toString(CharsetUtil.UTF_8)); &#125; @Override //åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè®°å½•é”™è¯¯å¹¶å…³é—­Channel public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) &#123; cause.printStackTrace(); ctx.close(); &#125;&#125; EchoClient.java:1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071package com.tc.echo;import io.netty.bootstrap.Bootstrap;import io.netty.channel.ChannelFuture;import io.netty.channel.ChannelInitializer;import io.netty.channel.EventLoopGroup;import io.netty.channel.nio.NioEventLoopGroup;import io.netty.channel.socket.SocketChannel;import io.netty.channel.socket.nio.NioSocketChannel;import java.net.InetSocketAddress;/** * ä»£ç æ¸…å• 2-4 å®¢æˆ·ç«¯çš„ä¸»ç±» * * @author &lt;a href=\"mailto:norman.maurer@gmail.com\"&gt;Norman Maurer&lt;/a&gt; */public class EchoClient &#123; private final String host; private final int port; public EchoClient(String host, int port) &#123; this.host = host; this.port = port; &#125; public void start() throws Exception &#123; EventLoopGroup group = new NioEventLoopGroup(); try &#123; //åˆ›å»º Bootstrap Bootstrap b = new Bootstrap(); //æŒ‡å®š EventLoopGroup ä»¥å¤„ç†å®¢æˆ·ç«¯äº‹ä»¶ï¼›éœ€è¦é€‚ç”¨äº NIO çš„å®ç° b.group(group) //é€‚ç”¨äº NIO ä¼ è¾“çš„Channel ç±»å‹ .channel(NioSocketChannel.class) //è®¾ç½®æœåŠ¡å™¨çš„InetSocketAddress .remoteAddress(new InetSocketAddress(host, port)) //åœ¨åˆ›å»ºChannelæ—¶ï¼Œå‘ ChannelPipelineä¸­æ·»åŠ ä¸€ä¸ª EchoClientHandlerå®ä¾‹ .handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override public void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast( new EchoClientHandler()); &#125; &#125;); //è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œé˜»å¡ç­‰å¾…ç›´åˆ°è¿æ¥å®Œæˆ ChannelFuture f = b.connect().sync(); //é˜»å¡ï¼Œç›´åˆ°Channel å…³é—­ f.channel().closeFuture().sync(); &#125; finally &#123; //å…³é—­çº¿ç¨‹æ± å¹¶ä¸”é‡Šæ”¾æ‰€æœ‰çš„èµ„æº group.shutdownGracefully().sync(); &#125; &#125; public static void main(String[] args) throws Exception &#123; if (args.length != 2) &#123; System.err.println(\"Usage: \" + EchoClient.class.getSimpleName() + \" &lt;host&gt; &lt;port&gt;\" ); return; &#125; final String host = args[0]; final int port = Integer.parseInt(args[1]); new EchoClient(host, port).start(); &#125;&#125; è¿è¡Œæ„å»º1mvn clean package åˆ°ä¸¤ä¸ªæ¨¡å—çš„ç›®å½•ä¸‹ï¼Œåˆ†åˆ«è¿è¡Œï¼š1mvn exec:java é‡åˆ°çš„å‘åˆ›å»ºå­æ¨¡å—ã€‚æ‰‹åŠ¨åˆ›å»ºå­ç›®å½•å’Œpomæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æ¯”è¾ƒéº»çƒ¦ã€‚åœ¨eclipseä¸­ï¼Œå¯ä»¥å³é”®ç‚¹å‡»echoé¡¹ç›®ï¼Œç„¶åæ–°å»ºä¸€ä¸ªmoduleç±»å‹çš„mavenå·¥ç¨‹å³å¯ï¼Œè¿™æ ·ä¼šè‡ªåŠ¨æ„å»ºç›¸åº”çš„æ–‡ä»¶ç›®å½•å’ŒåŸºæœ¬çš„pomæ–‡ä»¶ã€‚ Nettyåº“è§£æå¤±è´¥ã€‚è™½ç„¶Nettyå·²ç»é€šè¿‡mavenæ„å»ºæ·»åŠ å…¥classpathï¼Œä½†æ˜¯importæ—¶ä¼šå‡ºç°é”™è¯¯ï¼Œå½“ä½ ç‚¹å‡»å¼€Maven Dependencesä¼šå‘ç°ï¼Œé‡Œé¢çš„classæ–‡ä»¶æ˜¯æ‰“ä¸å¼€çš„ã€‚è¿™æ˜¯å› ä¸ºmavenä»“åº“å‡ºç°çš„é—®é¢˜ï¼Œé‡Œé¢æœ‰å†…å®¹é”™è¯¯ã€‚æˆ‘é€šè¿‡åˆ é™¤Homeä¸‹çš„.mä¸‹çš„ä»“åº“ï¼Œç„¶åå³é”®é¡¹ç›®&gt;Maven&gt;Update Projectã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Netty","slug":"Netty","permalink":"http://itanch.github.io/tags/Netty/"},{"name":"java","slug":"java","permalink":"http://itanch.github.io/tags/java/"}]},{"title":"kuberneteså…¥é—¨-å®‰è£…","date":"2017-05-16T11:55:41.000Z","path":"2017/05/16/kuberneteså…¥é—¨_1/","text":"è¿è¡Œç¯å¢ƒubuntu 14.04minikube version: v0.19.0Docker version 1.12.1 å®‰è£…minikubeminikubeæ˜¯kubernetesçš„å•æœºè¯•ç©ç‰ˆã€‚ Step 1 é¦–å…ˆéœ€è¦å®‰è£…ä¸€ä¸ªè™šæ‹Ÿæœºè½¯ä»¶ï¼Œè¿™é‡Œé‡‡ç”¨äº†VirtualBoxã€‚ Step 2 å®‰è£…kubernetesçš„å‘½ä»¤è¡Œå·¥å…·kubectlã€‚ ä¸‹è½½kubectl: 1curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl é…ç½®åˆ°ç¯å¢ƒä¸­ï¼š 12chmod +x ./kubectlsudo mv ./kubectl /usr/local/bin/kubectl æ£€æŸ¥æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š 1kubectl cluster-info Step 3 ä¸‹è½½å¹¶å®‰è£…minikube: 1curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.19.0/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/ deploymentDeploymentå¯ä»¥æ¥åˆ›å»ºå’Œæ›´æ–°ä¸€ä¸ªappã€‚ 1kubectl run kubernetes-bootcamp --image=docker.io/jocatalin/kubernetes-bootcamp:v1 --port=8080 Podå’ŒNodePod è¡¨ç¤ºäº†ä¸€ç»„å…³ç³»å¯†åˆ‡çš„å®¹å™¨ï¼Œè¿™äº›å®¹å™¨ä¹‹é—´ä¼šå…±äº«ä¸€äº›èµ„æºï¼Œå¦‚å­˜å‚¨èµ„æºã€ç½‘ç»œã€ç«¯å£ç­‰ã€‚ Podè¿è¡Œåœ¨ä¸€ä¸ªNodeä¸Šï¼ŒNodeæŒ‡ä¸€ä¸ªç‰©ç†æœºå™¨æˆ–è€…ä¸€ä¸ªè™šæ‹Ÿæœºã€‚Masterè´Ÿè´£ç®¡ç†Nodeï¼Œå°†Podåˆ†é…åˆ°Nodeä¸Šã€‚Kubeletè´Ÿè´£Masterå’ŒNodeä¹‹é—´çš„é€šä¿¡ã€‚Container runtime (like Docker, rkt)è´Ÿè´£è·å–å®¹å™¨é•œåƒå’Œè¿è¡Œå®¹å™¨ã€‚ ServiceServiceå®šä¹‰äº†ä¸€ç»„podçš„é€»è¾‘å…³ç³»ï¼Œå¹¶ä¸”è®¾ç½®äº†è®¿é—®è¿™äº›podçš„ç­–ç•¥ã€‚Podæ‹¥æœ‰ç‹¬ç«‹çš„IPï¼Œä¸å¯¹å¤–æš´éœ²ï¼ŒServiceè´Ÿè´£å°†å¯¹å¤–æš´éœ²åœ°å€ã€‚æ ¹æ®ä¸åŒçš„æš´éœ²æ–¹å¼ï¼ŒServiceè¢«åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ï¼š ClusterIP(é»˜è®¤)ï¼šåœ¨é›†ç¾¤ä¸­æš´éœ²ä¸€ä¸ªå†…å®¹IPï¼Œæ‰€ä»¥åªæœ‰åœ¨é›†ç¾¤å†…éƒ¨å¯ä»¥è®¿é—®serviceã€‚ NodePortï¼šä½¿ç”¨NATï¼Œæš´éœ²ä¸é›†ç¾¤ä¸­æ‰€é€‰çš„Nodeçš„portç›¸åŒçš„portã€‚è®©å¤–éƒ¨å¯ä»¥é€šè¿‡é›†ç¾¤IPçš„è¶…é›†è®¿é—®Serviceã€‚ LoadBalancerï¼šåœ¨å½“å‰äº‘ä¸­åˆ›å»ºä¸€ä¸ªè´Ÿè½½å¹³è¡¡å™¨ï¼Œå¹¶ä¸”ç»™å®šä¸€ä¸ªå¤–éƒ¨IPç»™è¿™ä¸ªserviceã€‚ ExternalNameï¼šExposes the Service using an arbitrary name (specified by externalName in the spec) by returning a CNAME record with the name. No proxy is used. This type requires v1.7 or higher of kube-dns. A Kubernetes Service sis an abstraction layer which defines a logical set of Pods and enables external traffic exposure, load balancing and service discovery for those Pods. Serviceä½¿ç”¨labelå’Œselectoræ¥åŒ¹é…ä¸€ç»„podã€‚labelæ˜¯ä¸€ç»„key/valueå¯¹ï¼Œå¯ä»¥æ ‡è®°å¯¹è±¡æ˜¯å¼€å‘ç‰ˆã€æµ‹è¯•ç‰ˆè¿˜æ˜¯å‘å¸ƒç‰ˆï¼Œè¿˜å¯ä»¥æ ‡è®°ç‰ˆæœ¬å·ç­‰ã€‚labelå¯ä»¥åœ¨åˆ›å»ºæ˜¯èµ‹äºˆï¼Œä¹Ÿå¯ä»¥åéšæ—¶æ›´æ”¹ã€‚ å‡è®¾é›†ç¾¤ä¸­å·²ç»æœ‰ä¸€ä¸ªdeployment kubernetes-bootcampã€‚ æ·»åŠ serviceï¼š1kubectl expose deployment/kubernetes-bootcamp --type=&quot;NodePort&quot; --port 8080 ç»™podæ‰“æ ‡ç­¾ï¼š1kubectl label pod kubernetes-bootcamp-3271566451-ddvkt app=v1 é€šè¿‡æ ‡ç­¾è·å–pod1kubectl get pods -l app=v1 åˆ é™¤servicesï¼š1kubectl delete service -l run=kubernetes-bootcamp appæ‰©å±•å’Œç¼©å‡å‰é¢çš„ä¾‹å­ä¸­ï¼Œä¸€ä¸ªappåªæœ‰ä¸€ä¸ªpodå’Œä¸€ä¸ªå®¹å™¨ã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®éœ€è¦ï¼Œæ‰©å±•å’Œç¼©å‡ä¸€ä¸ªappçš„è§„æ¨¡ã€‚ å°†åŸæ¥çš„deploymentæ‰©å±•åˆ°4ä¸ªå‰¯æœ¬ï¼š1kubectl scale deployments/kubernetes-bootcamp --replicas=4 Deploymentæ•°é‡å‘ç”Ÿå˜åŒ–ï¼š1234$ kubectl get deploymentsNAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGEhello-minikube 1 1 1 1 1dkubernetes-bootcamp 4 4 4 4 1d Podæ•°é‡ä¹Ÿå‘ç”Ÿæ”¹å˜ï¼š1234567$ kubectl get pods -o wideNAME READY STATUS RESTARTS AGE IP NODEhello-minikube-938614450-wn1r7 1/1 Running 0 1d 172.17.0.2 minikubekubernetes-bootcamp-3271566451-2cjjl 1/1 Running 0 4m 172.17.0.6 minikubekubernetes-bootcamp-3271566451-ddvkt 1/1 Running 0 1d 172.17.0.5 minikubekubernetes-bootcamp-3271566451-nnwq8 1/1 Running 0 4m 172.17.0.7 minikubekubernetes-bootcamp-3271566451-vtnzw 1/1 Running 0 4m 172.17.0.8 minikube é€šè¿‡å®šä¹‰çš„serviceæš´éœ²çš„ç«¯å£ï¼Œå¯ä»¥è®¿é—®kubernetes-bootcampåº”ç”¨ï¼Œå¯ä»¥å‘ç°è¯·æ±‚è¢«å‘é€åˆ°ä¸åŒçš„podä¸Šï¼Œä»è€Œä½“ç°äº†è´Ÿè½½å‡è¡¡çš„å®ç°ã€‚1234$ curl nodeip:31645Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-3271566451-2cjjl | v=1$ curl nodeip:31645Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-3271566451-vtnzw | v=1 å°†appå®ä¾‹ç¼©å‡åˆ°2ä¸ªï¼š1kubectl scale deployments/kubernetes-bootcamp --replicas=2 appæ›´æ–°Rolling updateså¯ä»¥å¢é‡çš„å°†podæ›´æ–°åˆ°æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¸”appä¸ä¼šå› æ­¤ä¸­æ–­ã€‚ åœ¨æ›´æ–°çš„æ—¶å€™ï¼Œserviceä¼šå°†ä¸šåŠ¡è´Ÿè½½å¹³è¡¡åˆ°å¯è·å¾—çš„podä¸Šé¢ã€‚Rolling updatesæ”¯æŒä»¥ä¸‹æ“ä½œï¼š Promote an application from one environment to another (via container image updates) Rollback to previous versions Continuous Integration and Continuous Delivery of applications with zero downtime ä¸‹é¢æ¥æ›´æ–°kubernetes-bootcampåº”ç”¨çš„ç‰ˆæœ¬æ¥ä½“ä¼šä¸€ä¸‹æ›´æ–°çš„è¿‡ç¨‹ã€‚ 1kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=docker.io/jocatalin/kubernetes-bootcamp:v2 å¯ä»¥è§‚å¯Ÿåˆ°å¦‚ä¸‹æ›´æ–°è¿‡ç¨‹ï¼š 1234567891011121314151617181920212223$ kubectl get podsNAME READY STATUS RESTARTS AGEhello-minikube-938614450-wn1r7 1/1 Running 0 2dkubernetes-bootcamp-3271566451-ddvkt 1/1 Running 0 1dkubernetes-bootcamp-3369739380-fbdtm 0/1 ContainerCreating 0 35skubernetes-bootcamp-3369739380-v98xt 0/1 ContainerCreating 0 35s//ä¸€æ®µæ—¶é—´å$ kubectl get podsNAME READY STATUS RESTARTS AGEhello-minikube-938614450-wn1r7 1/1 Running 0 2dkubernetes-bootcamp-3271566451-ddvkt 1/1 Terminating 0 2dkubernetes-bootcamp-3369739380-fbdtm 1/1 Running 0 4mkubernetes-bootcamp-3369739380-v98xt 1/1 Running 0 4m//ä¸€æ®µæ—¶é—´å$ kubectl get podsNAME READY STATUS RESTARTS AGEhello-minikube-938614450-wn1r7 1/1 Running 0 2dkubernetes-bootcamp-3369739380-fbdtm 1/1 Running 0 5mkubernetes-bootcamp-3369739380-v98xt 1/1 Running 0 5m å¦‚æœæ–°podæ›´æ–°å¤±è´¥ï¼Œåˆ™æ—§podä¸ä¼šè¢«å…¨éƒ¨æ€æ­»ï¼Œè‡³å°‘ä¼šä¿ç•™ä¸€ä¸ªç»´æŒæ­£å¸¸è¿è¡Œã€‚docker pull jocatalin/kubernetes-bootcamp æµ‹è¯•æ›´æ–°åçš„æ•ˆæœã€‚ é¦–å…ˆè·å–serviceæš´éœ²çš„ç«¯å£ï¼Œ31645:123$ kubectl get servicesNAME CLUSTER-IP EXTERNAL-IP PORT(S) AGEkubernetes-bootcamp 10.0.0.127 &lt;nodes&gt; 8080:31645/TCP 1h è·å–èŠ‚ç‚¹IPï¼š123456$ kubectl describe pods -l run=kubernetes-bootcamp//...å…³é”®å†…å®¹Name: kubernetes-bootcamp-3369739380-v98xtNamespace: defaultNode: minikube/192.168.99.100//... å‘é€è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°appæœåŠ¡ç‰ˆæœ¬ç¡®å®æ›´æ–°äº†ï¼š12$ curl 192.168.99.100:31645Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-3369739380-fbdtm | v=2 å›æ»šï¼Œæ¢å¤åˆ°æ›´æ–°ä¹‹å‰ã€‚ 1kubectl rollout undo deployments/kubernetes-bootcamp","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"docker","slug":"docker","permalink":"http://itanch.github.io/tags/docker/"},{"name":"kubernetes","slug":"kubernetes","permalink":"http://itanch.github.io/tags/kubernetes/"}]},{"title":"Eclipseæ¶æ„","date":"2017-04-11T09:24:23.000Z","path":"2017/04/11/eclipseæ¶æ„/","text":"çŸ«æƒ…çš„è¯åœ¨å‰ä¸€ç¯‡æ–‡ç« å·²ç»è¯´äº†ï¼Œè¿ç§»å®Œè¿™ç¯‡æ–‡ç« å°±æŠŠgithubä¸Šçš„è¿™ä¸ªä»“åº“åˆ äº†ã€‚ an integrated development environment(IDE) for anything and nothing in particular.eclipseæ˜¯ä¸€ä¸ªé›†æˆå¼€å‘ç¯å¢ƒï¼Œå®ƒæ—¢æ˜¯æ‰€æœ‰äº‹ç‰©çš„å¼€å‘ç¯å¢ƒï¼Œåˆä¸ä¸ºæŸä¸€ç‰¹å®šäº‹ç‰©çš„å¼€å‘ç¯å¢ƒã€‚ æœ€åˆçš„æ„¿æ™¯eclispe ä¸ä»…ä»…å±€é™äºä¸€ä¸ªå·¥å…·é›†åˆï¼Œè€Œæ˜¯ä¸€ä¸ªæ¡†æ¶ã€‚ä½œä¸ºä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒåº”è¯¥å…·æœ‰æ¨¡å—åŒ–å’Œå¯æ‰©å±•çš„ç‰¹ç‚¹ã€‚eclipse æ˜¯æƒ³ä½œä¸ºä¸€ä¸ªåŸºäºç»„ä»¶çš„å¹³å°ï¼Œä¸€ä¸ªå¯ä»¥ä¸ºå…¶ä»–å¼€å‘è€…å»ºç«‹è‡ªå·±çš„å·¥å…·è€ŒæœåŠ¡çš„å¹³å°ã€‚ Early eclipseæ—©æœŸçš„eclispeæ˜¯ä¸ºäº†å°†å¼€å‘è€…ä»ç¹ççš„å¼€å‘è¿‡ç¨‹ä¸­è§£æ”¾å‡ºæ¥ï¼Œä»è€Œå¼€å‘è€…å¯ä»¥æ›´åŠ ä¸“æ³¨äºå¼€å‘æ–°çš„å·¥å…·ã€‚æ—©æœŸä¸»è¦æœ‰ä¸‰å¤§å…ƒç´ ï¼šPlatform JDT(Java Development Tools) PDE(Plug-in Development Environment) 1.PlatformPlatform æ˜¯ç”±pluginç»„æˆçš„ã€‚pluginæ˜¯Eclipseç»„ä»¶æ¨¡å‹çš„åŸºç¡€ï¼Œå®ƒæ˜¯ç”±ä¸€ä¸ªJARæ–‡ä»¶å’Œmanifestæè¿°æ–‡ä»¶ç»„æˆã€‚manifestå­˜åœ¨plug-in.xmlæ–‡ä»¶é‡Œã€‚ requirespluginé€šè¿‡requiresæ¥è¯´æ˜å¯¹å…¶ä»–pluginçš„ä¾èµ–ã€‚ extension vs extension pointå¼€å‘è€…å¯ä»¥é€šè¿‡extensionå’Œextension point æœºåˆ¶æ¥å¯¹Ecipseè¿›è¡ŒåŠŸèƒ½ä¸Šçš„æ‰©å±•ã€‚å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨æ’åº§å’Œæ’å¤´æ¥æ¯”å–»ã€‚è¯¦ç»†å‚è€ƒ1 2ã€‚ extension pointæ’åº§ï¼šå¦‚æœä¸€ä¸ªpluginå¸Œæœ›å…¶å®ƒpluginèƒ½å¤Ÿå¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œåˆ™éœ€è¦å®šä¹‰extension pointã€‚extension pointè¯´æ˜äº†å¯¹å…¶æ‰©å±•çš„extensionéœ€è¦éµå®ˆçš„è§„çº¦ã€‚åªæœ‰ç‰¹å®šçš„æ’å¤´æ‰èƒ½ç¬¦åˆæ¡ä»¶ã€‚ ç§ç±»ï¼šè¯´æ˜æ€§çš„ï¼Œæ²¡æœ‰å…·ä½“ä»£ç ï¼›æä¾›å¯è¢«é‡å†™çš„æ¥å£ï¼›å°†å…³è”çš„å…ƒç´ ç»„ç»‡åœ¨ä¸€èµ·ï¼Œä¾‹å¦‚org.eclipse.ui.viewsextension pointå°†viewç»„ç»‡åœ¨ä¸€èµ·ç®¡ç†ã€‚extensionæ’å¤´ï¼šä¸ºæŸä¸ªpluginç‰¹å®šçš„extension pointæ‰©å±•åŠŸèƒ½ã€‚ä¾‹å¦‚org.eclipse.ui.viewsextension pointä¸‹ï¼Œå®šä¹‰çš„ä¸€äº›viewã€‚ pluginçš„æ¿€æ´»è¿‡ç¨‹å½“Eclipseå¯åŠ¨çš„æ—¶å€™ï¼Œruntime platformä¼šæ‰«æä½ å®‰è£…çš„æ‰€æœ‰pluginçš„manifestï¼Œåœ¨å†…å­˜é‡Œå»ºç«‹pluginæ³¨å†Œè¡¨ï¼Œå¹¶ä¸”è¯¥ä¿¡æ¯ä¼šå­˜åœ¨ç¡¬ç›˜ä¸­ï¼Œä¸‹æ¬¡å¯åŠ¨å¯ä»¥ç›´æ¥åŠ è½½ã€‚pluginé€šè¿‡æ³¨å†Œè¢«å‘ç°ï¼Œä½†æ˜¯ç›´åˆ°å®ƒä»¬è¢«ä½¿ç”¨çš„æ—¶å€™æ‰çœŸçš„è¢«æ¿€æ´»åŠ è½½ï¼Œè¿™ç§æ–¹å¼å«åšlazy activationã€‚ æ—©æœŸEclipseæ¶æ„ everything is a plugin workbenchworkbenchæ˜¯ç»„ç»‡Eclipseæ€ä¹ˆæ ·åœ¨æ¡Œé¢ä¸Šè¿›è¡Œæ˜¾ç¤ºçš„UIå…ƒç´ ã€‚å®ƒç”±perspective views editorsç»„æˆã€‚Eclipse workbenchæ˜¯å»ºç«‹åœ¨Standard Widget Toolkit(SWT)å’ŒJFaceä¹‹ä¸Šã€‚ SWTWidget toolkitsè¢«åˆ†ä¸ºä¸¤ç±»ï¼š1.native:ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥å®ç°UIç»„ä»¶ã€‚â€œåƒç´ ä¼˜å…ˆâ€ï¼Œå’Œæ¡Œé¢ä¸Šå¾—å…¶ä»–åº”ç”¨çœ‹ä¸Šå»å¾ˆå’Œè°ã€‚ä½†æ˜¯éšç€ç³»ç»Ÿçš„ä¸æ–­å˜åŒ–ï¼Œwidgetæ›´æ–°èµ·æ¥å¾ˆå›°éš¾ï¼Œå¹¶ä¸”é€ æˆä¸ä¸€è‡´æ€§ï¼Œå¯¼è‡´ç¨‹åºå¯ç§»æ¤æ€§ä¹Ÿå¾ˆå·®ã€‚2.emulated:ç‹¬ç«‹äºæ“ä½œç³»ç»Ÿã€‚è¯•å›¾æ¨¡ä»¿æ“ä½œç³»ç»Ÿçš„é£æ ¼ï¼Œå¾ˆå¤§çš„çµæ´»æ€§ã€‚ä½†æ˜¯è¿è¡Œå¾ˆæ…¢ï¼Œå’Œç³»ç»Ÿé£æ ¼ä¸åè°ƒã€‚ Abstract Window Toolkit(AWT)æ˜¯Javaæä¾›çš„ä¸€ä¸ªnativeçš„WTåº“,ä½†æ˜¯é”™è¯¯ç™¾å‡ºï¼Œé¥±å—è¯Ÿç—…ã€‚ç„¶ååˆå‡ºç°äº†Swingï¼Œä¸€ä¸ªemulatedçš„WTï¼ŒåŒæ ·ä¹Ÿæ˜¯æœ‰å¾ˆå¤šé”™è¯¯ï¼Œè€—è´¹æ—¶é—´å’Œå†…å­˜ã€‚æ‰€ä»¥è¿™äº›éƒ½ä¸æ˜¯ç†æƒ³çš„é€‰æ‹©ã€‚ æœ€åé€‰æ‹©äº†SWTï¼ŒSWTåœ¨å½“æ—¶æ¯”è¾ƒæˆåŠŸã€‚SWTæ˜¯nativeçš„ï¼Œå®ƒç”»è´¨ç²¾è‰¯ï¼Œè®©äººä¸ç¦æƒŠå¹ï¼šâ€œI canâ€™t believe itâ€™s a Java program.â€ã€‚ JFaceJFace æ˜¯å»ºç«‹åœ¨SWTä¸Šçš„UIç»„ä»¶ï¼Œä½†æ˜¯å®ƒæ˜¯çº¯JAVAä»£ç ï¼Œæ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿçš„ä»£ç ã€‚ Helpå¯ä»¥æ‰©å±•org.eclipse.help.tocæ¥å†™è‡ªå·±çš„helpã€‚ Teamä»£ç åº“æ”¯æŒç­‰ã€‚ Eclipse çš„ä¸€ä¸ªç›®çš„å°±æ˜¯é¼“åŠ±å¼€å‘äººå‘˜æ¥æ‰©å±•eclipse çš„åŠŸèƒ½ï¼Œå®ç°è‡ªå·±çš„å·¥å…·ï¼Œæ‰€ä»¥ä¸€ä¸ªç¨³å®šçš„APIæ˜¯ååˆ†å¿…è¦çš„ï¼Œæ‰€ä»¥æœ‰å¥è¯è¯´çš„å¥½ï¼šâ€œAPI is foreverâ€ã€‚ 2.Java Development Tools(JDT)JDT æä¾›äº†Javaç¼–è¾‘å™¨ï¼Œå¯¼èˆªï¼Œé‡æ„ï¼Œdebuggerï¼Œç¼–è¯‘å’Œå¢é‡ç¼–è¯‘ç­‰åŠŸèƒ½ã€‚ å…¶ä¸­ä¸ºäº†æ‘†è„±å‘½ä»¤è¡Œç¼–è¯‘çš„ç¹çï¼Œæ‰€ä»¥eclipseå›¢é˜Ÿå†™äº†ä¸€ä¸ªç‹¬ç«‹çš„ç¼–è¯‘å™¨ï¼Œå¹¶ä¸”è¯¥ç¼–è¯‘å™¨å¯ä»¥è¿›è¡Œå¢é‡ç¼–è¯‘ã€‚é€šè¿‡ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°†æ‰€æœ‰æœ‰å˜åŒ–çš„ç±»è¿›è¡Œé‡æ–°ç¼–è¯‘ï¼Œç„¶åå› ä¸ºè¯¥å˜åŒ–è€Œç‰µè¿çš„ç±»ä¹Ÿè¦æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…é‡æ–°ç¼–è¯‘ï¼Œæœ€åç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºä¸ºæ­¢ã€‚ 3.Plug-in Development Environment(PDE)PDEæä¾›äº†å¼€å‘ã€å»ºç«‹ã€é…ç½®å’Œæµ‹è¯•pluginçš„å·¥å…·ã€‚eclipseå›¢é˜Ÿè‡ªå·±å†™äº†PDE Buildæ¥åˆ›å»ºpluginã€‚ Eclipse 3.0:Runtime,RCP and Robots1.Runtimeè¯¥ç‰ˆæœ¬å¯¹åŸæ¥çš„requires,extensionså’Œextension pointsç»„ä»¶æ¨¡å‹è¿›è¡Œäº†æ”¹è¿›ï¼Œå†³å®šç”¨ä¸€ä¸ªç°æœ‰çš„æ–¹æ¡ˆæ¥æ›¿ä»£æ—§çš„æ–¹æ³•ï¼Œæœ€åé€‰æ‹©äº†OSGiã€‚ OSGi(Open Service Gateway Initiative)ä¸ºä»€ä¹ˆé€‰æ‹©OSGi?1.OSGiæ‹¥æœ‰è¯­ä¹‰ä¸Šçš„ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥æ¥å¤„ç†ä¾èµ–é—®é¢˜ã€‚å¯¹å¤–çš„æ¥å£ä¹Ÿæ˜¯æ˜ç¡®æŒ‡æ˜çš„ã€‚2.æ‹¥æœ‰è‡ªå·±çš„ç±»åŠ è½½å™¨ã€‚3.å¯ä»¥è¢«å¹¿æ³›çš„æ¥å—ã€‚4.OSGiç¤¾åŒºä¹Ÿæ˜¯å……æ»¡æ´»åŠ›çš„ã€‚5.è¿™ä¸ªæ¡†æ¶å®ç°äº†ä¸€ä¸ªä¼˜é›…ã€å®Œæ•´å’ŒåŠ¨æ€çš„ç»„ä»¶æ¨¡å‹ã€‚åº”ç”¨ç¨‹åºï¼ˆç§°ä¸ºbundleï¼‰æ— éœ€é‡æ–°å¼•å¯¼å¯ä»¥è¢«è¿œç¨‹å®‰è£…ã€å¯åŠ¨ã€å‡çº§å’Œå¸è½½ï¼ˆå…¶ä¸­JavaåŒ…ï¼ç±»çš„ç®¡ç†è¢«è¯¦ç»†å®šä¹‰ï¼‰ã€‚ é€‰æ‹©OSGiåEclipse pluginè¢«ç§°ä¸ºbundleã€‚plugin.xmlä»ç„¶ä¿ç•™extensionså’Œextension pointsè¿™äº›ä¿¡æ¯ï¼Œå…¶ä»–çš„ä¿¡æ¯è¢«è½¬ç§»åˆ°META-INF/MANIFEST.MFã€‚ ä¾èµ–é—®é¢˜OSGIæ¡†æ¶ä¼šé€šè¿‡æ£€æµ‹bundleçš„manifesté‡Œçš„ä¾èµ–ä¿¡æ¯æ¥ç”Ÿæˆè¯¥bundleçš„classpathã€‚åŒæ ·ï¼Œmanifestä¸­ä¼šæŒ‡æ˜å“ªäº›packageæ˜¯å¯¹å¤–å¼€æ”¾çš„ã€‚ ç”Ÿå‘½å‘¨æœŸOSGiæ˜¯ä¸€ä¸ªåŠ¨æ€æ¡†æ¶ï¼Œä¾æ—§ä¿æŒåŸæ¥Eclipseä¸­çš„lazy activationï¼Œéœ€è¦çš„æ—¶å€™ç±»æ‰ä¼šè¢«åŠ è½½ã€‚ ç‰ˆæœ¬å‘½åä¸€å¥—è§„èŒƒçš„å››éƒ¨åˆ†å‘½åè§„åˆ™ã€‚ Serviceæä¾›äº†è¿›ä¸€æ­¥çš„bundleä¹‹é—´çš„è§£è€¦ã€‚extensionæ˜¯è¢«å¯åŠ¨æ—¶å°±æ³¨å†Œï¼Œè€Œserviceæ˜¯åŠ¨æ€æ³¨å†Œã€‚ä½¿ç”¨serviceçš„bundleéœ€è¦importè¯¥packageï¼Œå¹¶ä¸”ç”±æ¡†æ¶å†³å®šè¯¥serviceçš„å¯ç”¨ã€‚ workbenchEclipse å¯åŠ¨è‡ªå·±çš„extensinæ˜¯org.eclipse.ui.ide.workbenchï¼Œæ˜¯å¯¹extension pointorg.eclipse.core.runtime.applicationçš„æ‰©å±•ã€‚ 2.Rich Client Platform(RCP)å› ä¸ºRCPä¸éœ€è¦æ‰€æœ‰çš„IDEåŠŸèƒ½ï¼Œæ‰€ä»¥å¯¹Eclipseè¿›è¡Œäº†é‡æ„ï¼Œå°†ä¸€äº›bundleåˆ†å‰²ï¼Œæ–¹ä¾¿å¼€å‘RCPåº”ç”¨ã€‚ Eclipse 3.4Featurefeatureæ˜¯ä¸€ç»„è¢«æ‰“åŒ…çš„bundle,å®ƒä»¬èƒ½å¤Ÿè¢«ç»Ÿä¸€çš„å»ºç«‹å’Œå®‰è£…ã€‚update managerå¯¹ä¸€ä¸ªbundleçš„å‡çº§éœ€è¦å‡çº§æ•´ä¸ªfeatureã€‚feature.xmlä¸­è¯´æ˜äº†åŒ…å«çš„bundleå’Œä¸€äº›æ€§è´¨ã€‚ p2 Conceptsp2æ˜¯å…³äºinstallation units(IU)çš„æ¦‚å¿µã€‚IUè¯´æ˜äº†å®‰è£…ç»„ä»¶çš„åå­—ã€idã€ç»„ä»¶çš„åŠŸèƒ½å’Œå®ƒçš„ä¾èµ–ã€‚å®ƒå¯ä»¥å¯¹å®‰è£…çš„ç»„ä»¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œå¹¶ä¸”æ–¹ä¾¿çš„è®©ç»„ä»¶ä»ä¸€ä¸ªç‰ˆæœ¬æ›´æ–°åˆ°å¦ä¸€ä¸ªç‰ˆæœ¬ã€‚å°†å†²çªåœ¨å®‰è£…æ—¶å‘ç°ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶å‘ç°ã€‚ profileä½ ç°æœ‰çš„å®‰è£…ç»„ä»¶çš„æ¸…å•ã€‚è¯´æ˜äº†ä¸€äº›è¿è¡Œç¯å¢ƒï¼Œå®‰è£…ä½ç½®ç­‰ã€‚directoræ‰§è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚planneræ£€æµ‹ç°æœ‰çš„profileï¼Œå†³å®šæ›´æ–°ä¸€ä¸ªå®‰è£…ç»„ä»¶çš„å¿…é¡»è¦æ‰§è¡Œçš„æ“ä½œã€‚engineæ‰§è¡ŒæŠŠæ–°çš„ç»„ä»¶å®‰è£…åˆ°ç¡¬ç›˜ä¸Šã€‚touchpointå¤„ç†è¿è¡Œç¯å¢ƒã€‚ Eclipse 4.0æ–°ç‰ˆæœ¬çš„ç›®çš„æ˜¯ç®€åŒ–Eclipseæ¨¡å‹ï¼Œå¸å¼•æ–°çš„ç¤¾åŒºåŠ å…¥ï¼Œè®©å¹³å°èƒ½å¤Ÿåˆ©ç”¨æ–°çš„ç½‘ç»œæŠ€æœ¯ã€‚ Model Workbenchmodelçš„å˜åŒ–ä¼šç«‹å³åœ¨workbenchä¸­å±•ç°å‡ºæ¥ã€‚ Cascading Style Sheet Sytlingå¯ä»¥ä½¿ç”¨CSS stylesheetsæ¥å±•ç°ç•Œé¢ã€‚ Dependency InjectionæœåŠ¡ç¼–ç¨‹æ¨¡å‹åŒ…å«ï¼šproducerï¼Œconsumerï¼Œbrokerã€‚ä¸­é—´äººæ˜¯è´Ÿè´£ç®¡ç†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚ç”Ÿäº§è€…å‘contextä¸­æ·»åŠ serviceå’Œå¯¹è±¡ã€‚serviceå‘æ¶ˆè´¹è€…æ³¨å…¥contextã€‚æ¶ˆè´¹è€…å£°æ˜è‡ªå·±çš„éœ€æ±‚ã€‚ Application Servicesä¸ºç”¨æˆ·æä¾›æ›´åŠ ç®€å•ç‹¬ç«‹çš„APIï¼Œè®©æœåŠ¡ä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–è¯­è¨€ã€‚ ConclusionåŸºäºç»„ä»¶æ¶æ„çš„Eclipseä¸æ–­å¸æ”¶æ–°çš„æŠ€æœ¯æ¥å‘å±•ï¼Œå¹¶ä¸”å…¼é¡¾æ—§çš„ç‰ˆæœ¬ã€‚æ‰€ä»¥Eclipseç¤¾åŒºä¸æ–­å£®å¤§ï¼Œç”¨æˆ·ä¹Ÿä¸æ–­å¢åŠ ã€‚","tags":[{"name":"è®°å½•","slug":"è®°å½•","permalink":"http://itanch.github.io/tags/è®°å½•/"},{"name":"æ¶æ„","slug":"æ¶æ„","permalink":"http://itanch.github.io/tags/æ¶æ„/"},{"name":"eclipse","slug":"eclipse","permalink":"http://itanch.github.io/tags/eclipse/"}]},{"title":"Gitæ¶æ„","date":"2017-04-11T09:08:21.000Z","path":"2017/04/11/Gitæ¶æ„/","text":"æ–‡ç« å†™äº2014å¹´11æœˆï¼Œå½“æ—¶çš„è‡ªå·±æœ¬ç§‘å››å¹´çº§ï¼Œå¯¼å¸ˆè®©æˆ‘ç¿»è¯‘ä¸€ä¸ªå«The Architecture of Open Source Applicationsçš„ä¹¦ï¼Œç„¶åå°±æœ‰äº†è¿™ä¸¤ç¯‡æ–‡ç« ã€‚è‡³äºä¸ºä»€ä¹ˆå°±ç¿»è¯‘äº†ä¸¤ç¯‡ï¼Œå› ä¸ºç¿»è¯‘åˆ°ç¬¬äºŒç¯‡çš„æ—¶å€™å¯¼å¸ˆå‘Šè¯‰æˆ‘æ˜¯å«æˆ‘çœ‹ï¼Œä¸æ˜¯è®©æˆ‘ç¿»è¯‘ã€‚æ˜¯ä¸æ˜¯æˆ‘çœŸçš„å¬é”™äº†å·²ç»ä¸å¾—è€ŒçŸ¥ï¼Œä¹Ÿè®¸æ˜¯çœ‹åˆ°æˆ‘ç¿»è¯‘çš„è¿™ä¹ˆçƒ‚ä¹Ÿä¸æƒ³è®©æˆ‘ç»§ç»­ä¸‹å»äº†ğŸ˜‚ã€‚ä¸¤ç¯‡æ–‡ç« å·²ç»ä¸¢åœ¨githubä¸Šæœ‰äº›å¹´å¤´äº†ï¼Œæœ¬æ¥æ˜¯æƒ³ç¿»è¯‘å®Œæ‰€æœ‰çš„æ–‡ç« ï¼Œæä¸ªå¤§æ–°é—»ï¼Œç»“æœå°±è¿™ä¸¤ç‰‡å­¤é›¶é›¶çš„åœ¨ä»“åº“é‡Œã€‚ç°åœ¨å›æƒ³èµ·æ¥æœ¬ç§‘å³å°†æ¯•ä¸šçš„è‡ªå·±ï¼Œé›„å¿ƒå‹ƒå‹ƒçš„è¦å¹²ä¸€ç•ªå¤§äº‹ä¸šï¼Œå¦‚ä»Šè¯»ç ”åˆ°äº†æ‰¾å·¥ä½œçš„æ—¶èŠ‚å´åˆå¤šäº›å¿ƒé…¸å’Œè¿·èŒ«ã€‚å¾€å‰èµ°ç»ˆä¼šæœ‰è·¯ï¼Œçƒ­è¡€ä¸ä¼šå†·å´ã€‚ 6.1 Gitç®€ä»‹Gitèƒ½å¤Ÿè®©åˆä½œè€…ä»¬ä½¿ç”¨ä¸€ä¸ªp2pçš„ç½‘ç»œä»“åº“æ¥ç»´æŠ¤å·¥ä½œçš„ç”µå­æ–‡æ¡£éƒ¨åˆ†ï¼ˆä¸ä»…ä»…å±€é™äºä»£ç ï¼‰ã€‚Gitæ”¯æŒåˆ†å¸ƒå¼çš„å·¥ä½œæµç¨‹ï¼Œå…è®¸éƒ¨åˆ†å·¥ä½œæš‚æ—¶çš„åˆ†æ•£ï¼Œæœ€åå†èšé›†ä¸€èµ·ã€‚ è¿™ä¸€ç« èŠ‚å°†ä¼šé˜æ˜Gitç”¨æ¥å®ç°è¿™äº›åŠŸèƒ½çš„è®¸å¤šä¸ä¸ºäººçŸ¥çš„æ–¹é¢ï¼Œå¹¶ä¸”ä¼šæåŠGitä¸å…¶å®ƒç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼ˆVCSsï¼‰çš„ä¸åŒä¹‹å¤„ã€‚ 6.2 Gitèµ·æºä¸ºäº†æ›´å¥½åœ°ç†è§£Gitçš„è®¾è®¡å“²å­¦ï¼Œé¦–å…ˆä½ è¦çŸ¥é“åœ¨Linuxå†…æ ¸ç¤¾åŒºä¸­Gité¡¹ç›®æ˜¯åœ¨ä»€ä¹ˆæ ·çš„ç¯å¢ƒä¸‹å¯åŠ¨çš„ã€‚ Linuxå†…æ ¸ç›¸å¯¹äºé‚£æ—¶çš„å…¶å®ƒå•†ä¸šè½¯ä»¶é¡¹ç›®è€Œè¨€æ˜¯ç‰¹ç«‹ç‹¬è¡Œçš„ï¼Œå› ä¸ºLinuxå†…æ ¸çš„è´¡çŒ®è€…æ•°é‡åºå¤§ï¼Œå¹¶ä¸”è´¡çŒ®è€…çš„å‚ä¸ç¨‹åº¦å’Œå¯¹ç°æœ‰ä»£ç åº“çš„äº†è§£ç¨‹åº¦å‚å·®ä¸é½ã€‚å‡ å¹´æ¥ï¼Œå†…æ ¸ä¸€ç›´æ˜¯åˆ©ç”¨æ‰“åŒ…å·¥å…·å’Œæ‰“è¡¥ä¸æ¥ç»´æŠ¤ï¼Œæ‰€ä»¥æ ¸å¿ƒå¼€å‘ç¤¾åŒºä¸€ç›´åœ¨ç«­åŠ›å¯»æ±‚ä¸€ä¸ªèƒ½å¤Ÿæ»¡è¶³ä»–ä»¬å¤§éƒ¨åˆ†éœ€æ±‚çš„VCSã€‚ ä¸ºäº†è§£å†³è¿™äº›éœ€æ±‚å’Œåœ¨2005å¹´é‡åˆ°çš„å›°å¢ƒï¼ŒGitä½œä¸ºä¸€ä¸ªå¼€æºé¡¹ç›®è¯ç”Ÿäº†ã€‚åœ¨å½“æ—¶ï¼Œæ ¸å¿ƒå¼€å‘æˆå‘˜ä»¬ä½¿ç”¨äº†ä¸¤ç§VCS:BitKeeperå’ŒCVSæ¥ç®¡ç†Linuxå†…æ ¸ä»£ç åº“ã€‚å…¶ä¸­BitKeeperæå‡ºäº†ä¸€ä¸ªä¸ä¼—ä¸åŒçš„è®¾è®¡ç†å¿µï¼Œæ·±å—Linuså–œæ¬¢ã€‚ åœ¨BitKeeperçš„å¼€å‘å•†BitMoverå®£å¸ƒè¦æ’¤é”€ä¸€äº›Linuxå†…æ ¸æ ¸å¿ƒå¼€å‘è€…çš„è®¸å¯è¯ä¹‹åä¸ä¹…ï¼ŒLinus Torvaldsæ€¥å¿™åœ°ç€æ‰‹å¼€å‘ä¸€ä¸ªè‡ªå·±çš„VCSï¼Œä¹Ÿå°±æ˜¯åæ¥çš„Gitã€‚ä»–å¼€å§‹æ—¶å†™äº†ä¸€ç»„è„šæœ¬æ¥å¸®åŠ©ä»–ç®¡ç†é‚®ä»¶è¡¥ä¸ï¼Œç„¶åé€æ¸åº”ç”¨äºç®¡ç†å…¶å®ƒè½¯ä»¶è¡¥ä¸ã€‚åŸå§‹è„šæœ¬çš„ç›®çš„æ˜¯èƒ½å¤Ÿå¿«é€Ÿåœ°ç»ˆæ­¢åˆå¹¶ï¼Œæ‰€ä»¥ç»´æŠ¤äººå‘˜å¯ä»¥æŠŠä¸­æœŸè¡¥ä¸æµä¿®æ”¹æˆæ‰‹åŠ¨åˆå¹¶ï¼Œç„¶åç»§ç»­åˆå¹¶åç»­çš„è¡¥ä¸ã€‚ ä»è¡¨é¢ä¸Šæ¥çœ‹ï¼Œå¯¹äºGitï¼ŒTorvalsæœ‰ä¸€ä¸ªå“²å­¦ç›®æ ‡â€“åCVSâ€“åŠ ä¸Šä¸‰ä¸ªå®ç”¨çš„è®¾è®¡ç›®æ ‡ï¼š å’ŒBitKeeperç±»ä¼¼ï¼ŒGitè¦èƒ½å¤Ÿæ”¯æŒåˆ†å¸ƒå¼å·¥ä½œæµ(distributed workflows) æä¾›é¿å…å†…å®¹é”™è¯¯çš„å®‰å…¨ä¿éšœ å…·æœ‰é«˜æ€§èƒ½ åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œè¿™äº›è®¾è®¡ç›®æ ‡å·²ç»è¢«å®ç°å¹¶å°†ä¿æŒä¸‹å»ï¼Œå°±åƒä¸‹é¢æˆ‘è¦å±•ç°çš„ä¸€æ ·ã€‚æ¥ä¸‹æ¥ä¼šæˆ‘è¯´æ˜Gitå¦‚ä½•åˆ©ç”¨æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰æ¥å¤„ç†å†…å®¹å­˜å‚¨ï¼Œå¤´éƒ¨æŒ‡é’ˆçš„å¼•ç”¨ï¼Œå¯¹è±¡æ¨¡å‹çš„è¡¨ç°å’Œè¿œç¨‹åè®®ï¼›æœ€åä¼šè¯´åˆ°Gitå¦‚ä½•è¿½è¸ªæ ‘çš„åˆå¹¶ã€‚ å°½ç®¡BitKeeperå¯¹Gitçš„æ—©æœŸè®¾è®¡äº§ç”Ÿäº†å½±å“ï¼Œä½†æ˜¯Gitçš„å®ç°ä½¿ç”¨äº†æ ¹æœ¬ä¸åŒçš„æ–¹æ³•ï¼Œå¹¶ä¸”Gitèƒ½å…è®¸ç”¨æˆ·åˆ†å¸ƒå¼åœ°å¢åŠ æ›´å¤šçš„æœ¬åœ°å·¥ä½œæµï¼Œè¿™ä¸€ç‚¹æ˜¯BitKeeperæ— æ³•åšåˆ°çš„ã€‚Monotoneï¼Œä¸€ä¸ªåœ¨2003å¹´å¯åŠ¨çš„å¼€æºåˆ†å¸ƒå¼VCSï¼Œå¯èƒ½æ˜¯æ—©æœŸGitå¼€å‘çš„å¦ä¸€ä¸ªçµæ„Ÿæ¥æºã€‚ åˆ†å¸ƒå¼çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿé€šå¸¸èƒ½èŠ±è´¹å¾ˆå°çš„ä»£ä»·æä¾›å¾ˆå¥½çš„å·¥ä½œæµçš„çµæ´»æ€§ã€‚åˆ†å¸ƒå¼æ¨¡å‹æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š è®©åˆä½œè€…èƒ½å¤Ÿçº¿ä¸‹å·¥ä½œå¹¶ä¸”é€’å¢çš„æäº¤ è®©æŸä¸ªåˆä½œè€…è‡ªå·±å†³å®šä»–ä½•æ—¶åˆ†äº«ä»–çš„å·¥ä½œ è®©åˆä½œè€…èƒ½å¤Ÿåœ¨çº¿ä¸‹è®¿é—®ä»“åº“å†å² å…è®¸è¢«ç®¡ç†çš„å·¥ä½œå‘å¸ƒåˆ°å¤šæ ·çš„ä»“åº“ä¸­å»ï¼Œå‘å¸ƒçš„å·¥ä½œä¸­æ½œåœ¨çš„å«æœ‰åˆ†æ”¯å’Œç»†å°çš„å˜åŒ– åœ¨Gité¡¹ç›®å¼€å§‹çš„æ—¶æœŸï¼Œä¸‰ä¸ªå…¶å®ƒçš„å¼€æºåˆ†å¸ƒå¼VCSï¼ˆdVCSï¼‰ä¹Ÿè¢«å‘èµ·ã€‚ï¼ˆå…¶ä¸­æœ‰ä¸€ä¸ªåœ¨The Architecture of Open Source Applications çš„ç¬¬ä¸€å·ä¸­è¢«è®¨è®ºè¿‡ã€‚ï¼‰æ‰€æœ‰çš„è¿™äº›åˆ†å¸ƒå¼VCSéƒ½ç”¨äº†ç¨å¾®ä¸åŒçš„æ–¹æ³•æ¥æä¾›å…·æœ‰å¾ˆå¤§çš„çµæ´»æ€§å·¥ä½œæµï¼Œè¿™ä¸€ç‚¹å°†å®ƒä»¬ä»å…¶å®ƒVCSä¸­åˆ†ç¦»å‡ºæ¥ã€‚æ³¨æ„ï¼šSubVersionæœ‰ä¸€ä¸ªè¢«ä¸åŒå¼€å‘è€…ç»´æŠ¤ç€çš„å«SVKçš„æ‰©å±•ï¼Œå®ƒç”¨æ¥æ”¯æŒæœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„åŒæ­¥ã€‚ å¦‚ä»Šï¼Œæ¯”è¾ƒæµè¡Œçš„å¹¶ä¸”è¢«ç§¯æç»´æŠ¤ç€çš„dVCSæœ‰ï¼šBazaarï¼ŒDarcsï¼ŒFossilï¼ŒGitï¼ŒMercurialå’ŒVeracityã€‚ 6.3 ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè®¾è®¡ç°åœ¨è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹åœ¨å¼€å‘Gitæ—¶å¯é€‰æ‹©çš„VCSè§£å†³æ–¹æ¡ˆã€‚äº†è§£å®ƒä»¬çš„ä¸åŒä¹‹å¤„ï¼Œæœ‰åˆ©äºæˆ‘ä»¬æ¢ç©¶åœ¨Gitå¼€å‘æ—¶é¢ä¸´çš„æ¶æ„é€‰æ‹©ã€‚ ä¸€ä¸ªç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿé€šå¸¸æœ‰ä¸‰ä¸ªæ ¸å¿ƒéœ€æ±‚ï¼Œåˆ†åˆ«æ˜¯ï¼š å­˜å‚¨å†…å®¹ è¿½è¸ªå†…å®¹å˜åŒ–ï¼ˆå«æœ‰åˆå¹¶ä¿¡æ¯çš„å†å²è®°å½•ï¼‰ åœ¨åˆä½œè€…ä¹‹é—´åˆ†å¸ƒå¼çš„ç®¡ç†å†…å®¹å’Œå†å²è®°å½• æ³¨æ„ï¼šä¸æ˜¯æ‰€æœ‰çš„VCSéƒ½è¦æ±‚ç¬¬ä¸‰ç‚¹ã€‚ å†…å®¹çš„å­˜å‚¨åœ¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿç•Œé‡Œï¼Œä¸ºäº†å®ç°å­˜å‚¨å†…å®¹åŠŸèƒ½ï¼Œæœ€ä¸€èˆ¬çš„é€‰æ‹©æ˜¯åˆ©ç”¨åŸºäºdeltaçš„å˜åŒ–é›†åˆï¼Œæˆ–è€…åˆ©ç”¨æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰çš„å†…å®¹è¡¨ç¤ºã€‚ åŸºäºDeltaçš„å˜åŒ–é›†åˆä¼šå°†ä¸¤ä¸ªç‰ˆæœ¬çš„æ‰å¹³åŒ–å†…å®¹çš„ç›¸å¼‚ç‚¹å°è£…è¿›æ¥ï¼ŒåŒæ—¶é™„åŠ ä¸€äº›å…ƒæ•°æ®ï¼Œè¿™ç§æ–¹å¼åªå…³å¿ƒå…·ä½“çš„å·®å¼‚ã€‚ Gitç”¨æœ‰DAGæ¥è¡¨ç¤ºæ–‡ä»¶ï¼Œå…³å¿ƒçš„æ˜¯æ–‡ä»¶çš„æ•´ä½“å˜åŒ–ï¼Œç”¨å±‚æ¬¡ç»“æ„çš„å¯¹è±¡å…³ç³»æ¥è¡¨ç¤ºæ ‘çŠ¶ç»“æ„çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸åŒçš„æ–‡ä»¶ç±»å‹ç”¨ä¸åŒçš„å¯¹è±¡æ¥è¡¨ç¤ºã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œåªæœ‰å˜åŒ–çš„æ–‡ä»¶æ‰æ–°å»ºç«‹å¿«ç…§å¹¶ä¿å­˜åœ¨ä»“åº“é‡Œï¼Œæ²¡æœ‰ä¿®æ”¹çš„æ–‡ä»¶åˆ™ä¼šåˆ©ç”¨åŸæ¥çš„å¿«ç…§åšä¸€ä¸ªå¼•ç”¨ã€‚ æäº¤ï¼ˆcommitï¼‰ä¸åˆå¹¶ï¼ˆmergeï¼‰å†å²è®°å½•åœ¨å†å²è®°å½•å’Œå‘å‰å˜æ›´è¿½è¸ªæ–¹é¢ï¼Œå¤§éƒ¨åˆ†VCSè½¯ä»¶ä½¿ç”¨äº†ä¸‹åˆ—æ–¹æ³•ä¹‹ä¸€ï¼š çº¿æ€§å†å²è®°å½• ç”¨æœ‰å‘æ— ç¯å›¾è¡¨ç¤ºçš„å†å²è®°å½• Gitå†ä¸€æ¬¡ä½¿ç”¨äº†DAGï¼Œä¸è¿‡è¿™æ¬¡æ˜¯ä½¿ç”¨åœ¨å­˜å‚¨å†å²è®°å½•æ–¹é¢ã€‚æ¯ä¸€ä¸ªcommitéƒ½åŒ…å«äº†å®ƒçš„ç¥–å…ˆçš„å…ƒæ•°æ®ï¼›Gitä¸­ä¸€æ¬¡commitå¯èƒ½æœ‰é›¶ä¸ªæˆ–è€…å¤šä¸ªï¼ˆç†è®ºä¸Šå¯ä»¥æœ‰æ— é™ä¸ªï¼‰çˆ¶èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œåœ¨Gitä»“åº“é‡Œçš„ç¬¬ä¸€æ¬¡commitå°±æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œç„¶è€Œé€šè¿‡ä¸‰è·¯åˆå¹¶è€Œæ¥çš„commitå°±æœ‰ä¸‰ä¸ªçˆ¶èŠ‚ç‚¹ã€‚ Gitå’ŒSubversionï¼ˆä½¿ç”¨çš„æ˜¯çº¿æ€§å†å²ç¥–å…ˆï¼‰å¦ä¸€ä¸ªé‡è¦çš„åŒºåˆ«æ˜¯ï¼ŒGitèƒ½å¤Ÿç›´æ¥åœ°æ”¯æŒåˆ†æ”¯ï¼Œå¹¶ä¸”åˆ†æ”¯èƒ½å¤Ÿè®°å½•å¤§éƒ¨åˆ†çš„å†å²äº‹ä»¶ã€‚ Gité€šè¿‡DAGå­˜å‚¨å†…å®¹å¯ä»¥å……åˆ†çš„å‘æŒ¥åˆ†æ”¯çš„èƒ½åŠ›ã€‚ä¸€ä¸ªæ–‡ä»¶çš„å†å²è®°å½•æ˜¯è¿ç»­ä¸æ–­çš„ã€‚ä»è¯¥æ–‡ä»¶åˆ°æ ¹ç›®å½•éƒ½æ˜¯è¿ç€çš„ï¼Œæ ¹ç›®å½•åˆè¿ç€ä¸€ä¸ªæäº¤èŠ‚ç‚¹ã€‚è¿™ä¸ªæäº¤èŠ‚ç‚¹ï¼Œä¾æ¬¡åˆæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªçˆ¶èŠ‚ç‚¹ã€‚è¿™æ ·ï¼ŒGitå°±æœ‰ä¸¤ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ï¼Œåˆ©ç”¨è¿™ä¸¤ä¸ªç‰¹æ€§æˆ‘ä»¬å°±èƒ½å¤Ÿç¡®åˆ‡åœ°æ¨æ–­å‡ºå†å²è®°å½•å’Œå†…å®¹ï¼Œæ¯”ä»RCSå‘å±•è€Œæ¥çš„ä¸€äº›VCSæ›´ä¸ºå‡†ç¡®ï¼Œå…·ä½“æ˜¯ï¼š å¦‚æœå›¾ä¸­çš„ä¸€ä¸ªå†…å®¹èŠ‚ç‚¹ä¸å…¶å®ƒæäº¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹æœ‰ç›¸åŒçš„å¼•ç”¨IDï¼ˆåœ¨Gitä½¿ç”¨SHAï¼‰ï¼Œåˆ™è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸€å®šå«æœ‰ç›¸åŒçš„å†…å®¹ï¼Œè¿™æ ·Gitå°±æœ‰æ•ˆåœ°ç¼©çŸ­äº†å†…å®¹çš„å·®å¼‚å¯¹æ¯”è¿‡ç¨‹ã€‚ å½“åˆå¹¶ä¸¤ä¸ªåˆ†æ”¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆå¹¶çš„æ˜¯DAGä¸­ä¸¤ä¸ªèŠ‚ç‚¹çš„å†…å®¹ã€‚DAGä½¿å¾—Gitå¯ä»¥â€œé«˜æ•ˆåœ°â€ï¼ˆç›¸å¯¹äºRCSå®¶æ—çš„é‚£äº›VCSï¼‰åˆ¤å®šå‡ºè¿™äº›èŠ‚ç‚¹çš„å…±åŒç¥–å…ˆã€‚ åˆ†å¸ƒVCSç”¨å¦‚ä¸‹ä¸‰ç§æ–¹æ³•ä¸­çš„ä¸€ç§æ¥å¤„ç†ä¸€é¡¹å·¥ä½œåœ¨åˆä½œè€…ä¹‹é—´çš„åˆ†é…ï¼š ä»…æœ¬åœ°ï¼šä½œä¸ºä¸€ä¸ªVCSè§£å†³æ–¹æ³•ï¼Œæ²¡æœ‰æ»¡è¶³ä¸Šé¢æåˆ°çš„ç¬¬ä¸‰ä¸ªéœ€æ±‚ã€‚ ä¸­å¿ƒæœåŠ¡å™¨ï¼šæ‰€æœ‰å¯¹ä»“åº“çš„æ”¹å˜å¿…é¡»ç”±ä¸€ä¸ªç‰¹å®šçš„ä»“åº“æ¥è®°å½•ã€‚ åˆ†å¸ƒå¼æ¨¡å‹ï¼šåœ¨è¯¥æ¨¡å‹ä¸­ï¼Œä¸€èˆ¬åˆä½œè€…ä¼šæœ‰ä¸€ä¸ªå¯è®¿é—®çš„å…¬å…±ä»“åº“æ¥è¿›è¡Œâ€œæ¨é€â€ï¼Œä½†æ˜¯å¯ä»¥åœ¨æœ¬åœ°æäº¤å¹¶ä¸”åœ¨ç¨åæ¨é€ï¼Œå…è®¸ç¦»çº¿å·¥ä½œã€‚ ä¸ºäº†é˜æ˜æ¯ä¸ªå…³é”®çš„è®¾è®¡é€‰æ‹©çš„ä¼˜ç‚¹ä¸å±€é™ï¼Œæˆ‘ä»¬å°†å«æœ‰åŒæ ·å†…å®¹çš„SubVersionä»“åº“å’ŒGitä»“åº“è¿›è¡Œå¯¹æ¯”ï¼ˆä¾‹å¦‚,Gitä»“åº“é»˜è®¤åˆ†æ”¯çš„HEADä¸Šçš„å†…å®¹ä¸Subversionä»“åº“ä¸»å¹²ä¸Šæœ€æ–°ç‰ˆæœ¬çš„å†…å®¹ç›¸åŒï¼‰ã€‚ä¸€ä¸ªå«Alexçš„å¼€å‘è€…ï¼Œç­¾å‡ºï¼ˆcheckoutï¼‰ä¸€ä¸ªSubversionçš„æœ¬åœ°ä»“åº“ï¼ŒåŒæ—¶å…‹éš†ï¼ˆcloneï¼‰äº†ä¸€ä¸ªGitçš„æœ¬åœ°ä»“åº“ã€‚ æˆ‘ä»¬å‡è®¾ï¼Œåœ¨æœ¬åœ°çš„Subversionä»“åº“ä¸­ï¼ŒAlexæ”¹å˜äº†ä¸€ä¸ª1MBå¤§å°çš„æ–‡ä»¶ï¼Œå¹¶ä¸”æäº¤äº†è¿™ä¸ªæ”¹å˜ã€‚åœ¨æœ¬åœ°ï¼Œç­¾å‡ºçš„è¿™ä¸ªæ–‡ä»¶ä¼šåšå‡ºç›¸åº”çš„æ”¹å˜å¹¶ä¸”æœ¬åœ°çš„å…ƒæ•°æ®ä¹Ÿä¼šæ›´æ–°ã€‚åœ¨Alexæäº¤åˆ°ä¸­å¿ƒSubversionä»£ç åº“ä¸­çš„æ—¶å€™ï¼Œä¼šå°†æ—§æ–‡ä»¶çš„å¿«ç…§å’Œæ–°çš„æ”¹å˜è¿›è¡Œå¯¹æ¯”ï¼Œç”Ÿæˆä¸€ä¸ªå¯¹æ¯”æ–‡ä»¶ï¼Œè¯¥å¯¹æ¯”æ–‡ä»¶ä¼šå­˜åœ¨ä»“åº“ä¸­ã€‚ ä¸‹é¢å’ŒGitçš„å·¥ä½œè¿‡ç¨‹å¯¹æ¯”ä¸€ä¸‹ã€‚å½“Alexåœ¨æœ¬åœ°çš„Gitä»“åº“ä¸­å¯¹åŒä¸€ä¸ªæ–‡ä»¶åšäº†ç›¸åŒçš„ä¿®æ”¹åï¼Œä¿®æ”¹é¦–å…ˆä¼šå­˜å‚¨åœ¨æœ¬åœ°ï¼Œç„¶åAlexâ€œæ¨é€â€æœ¬åœ°å¾…å®šçš„æäº¤åˆ°å…¬å…±ä»“åº“é‡Œï¼Œä»¥ä¾¿è¯¥é¡¹ç›®çš„å…¶ä»–åˆä½œè€…èƒ½å¤Ÿåˆ†äº«ã€‚æœ€åè¯¥å†…å®¹å˜åŒ–ä¼šä¸€è‡´çš„å­˜å‚¨åœ¨æ¯ä¸€ä¸ªå«æœ‰è¿™æ¬¡æäº¤çš„Gitä»“åº“é‡Œã€‚åœ¨æœ¬åœ°æäº¤æ—¶ï¼ˆæœ€ç®€å•çš„æƒ…å†µä¸‹ï¼‰ï¼Œæœ¬åœ°çš„Gitä»“åº“ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡è¡¨ç¤ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè€Œæ–°æ–‡ä»¶è¡¨ç¤ºè¿™æ¬¡ä¿®æ”¹åçš„æ–‡ä»¶ï¼ˆæ–°æ–‡ä»¶åŒ…å«äº†æ‰€æœ‰çš„å†…å®¹ï¼‰ã€‚å¯¹è¢«ä¿®æ”¹æ–‡ä»¶ä¸Šé¢çš„æ¯ä¸€å±‚ç›®å½•ï¼ˆåŒ…æ‹¬æ ¹ç›®å½•ï¼‰ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰æ–°IDçš„æ–°å¯¹è±¡ã€‚ä»æ–°çš„æ ¹èŠ‚ç‚¹åˆ°æ–°çš„å¶èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ–°çš„DAGè¢«åˆ›å»ºå‡ºæ¥äº†ï¼ˆå¯¹äºåœ¨æœ¬æ¬¡æäº¤ä¸­æ²¡æœ‰ä¿®æ”¹çš„æ–‡ä»¶ï¼Œå®ƒä»¬çš„å¶èŠ‚ç‚¹å¼•ç”¨ä¼šè¢«å†åˆ©ç”¨ï¼‰ï¼Œæ–°DAGä¼šå¼•ç”¨æ–°å»ºçš„å¶èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯è¢«ä¿®æ”¹æ–‡ä»¶åœ¨åŸæ¥é‚£æ£µæ ‘ä¸­çš„æ—§å¶èŠ‚ç‚¹ã€‚ï¼ˆå¶èŠ‚ç‚¹è¡¨ç¤ºå­˜åœ¨ä»“åº“é‡Œçš„æ–‡ä»¶ã€‚ï¼‰ åœ¨è¿™æ—¶ï¼Œè¿™æ¬¡æäº¤è¿˜åœ¨Alexçš„æœ¬åœ°è®¾å¤‡ä¸­çš„Gitä»“åº“é‡Œã€‚å½“Alexâ€œæ¨é€â€è¿™æ¬¡æäº¤åï¼Œè¿™æ¬¡æäº¤æ‰ç®—è¿›å…¥å…¬å…±Gitä»“åº“é‡Œã€‚åœ¨å…¬å…±ä»“åº“æ ¸å®šè¿™æ¬¡æäº¤é€‚ç”¨äºè¯¥åˆ†æ”¯åï¼Œåœ¨æœ¬åœ°ä»“åº“ä¸­åˆ›å»ºçš„é‚£äº›å¯¹è±¡æ‰è¢«å­˜å‚¨åœ¨å…¬å…±ä»“åº“ä¸­ã€‚ Gitçš„è§£å†³æ–¹æ¡ˆæ›´åŠ çµæ´»ï¼Œå®ƒä»¬æ—¢æ˜¯åº•å±‚çš„ï¼Œåˆæ˜¯ç”¨æˆ·å±‚çš„ã€‚è¿™äº›åŠŸèƒ½è®©ç”¨æˆ·èƒ½å¤Ÿæ˜ç¡®åœ°è¡¨è¾¾å‡ºæ˜¯æƒ³åœ¨è¿œç¨‹ä»“åº“é‡Œåˆ†äº«ä¿®æ”¹è¿˜æ˜¯ä»…ä»…åœ¨æœ¬åœ°æäº¤ã€‚ä½†æ˜¯ï¼Œå¢åŠ è¿™ä¸¤ä¸ªå±‚æ¬¡çš„å¤æ‚æ€§å¯ä»¥ä¸ºå›¢é˜Ÿåœ¨å·¥ä½œæµå’Œå‘å¸ƒèƒ½åŠ›ä¸Šæä¾›æå¤§çš„çµæ´»æ€§ï¼Œå°±åƒåœ¨â€œGitèµ·æºâ€ä¸­æåˆ°çš„ä¸€æ ·ã€‚ åœ¨Subversionçš„è§£å†³æ–¹æ¡ˆä¸­ï¼Œåˆä½œè€…å‡†å¥½åˆ†äº«ä¿®æ”¹æ—¶ï¼Œä»–æ²¡å¿…è¦è®°å¾—æŠŠä¿®æ”¹æ¨é€åˆ°è¿œç¨‹ä»“åº“ä¸­ã€‚å½“å¯¹å¤§æ–‡ä»¶è¿›è¡Œå°çš„ä¿®æ”¹æ—¶ï¼ŒåŸºäºdeltaçš„å­˜å‚¨æ¯”å­˜å‚¨å„ä¸ªç‰ˆæœ¬çš„æ•´ä¸ªæ–‡ä»¶æ›´ä¸ºæœ‰æ•ˆã€‚ä½†æ˜¯ï¼Œå°±å¦‚æˆ‘ä»¬å°†è¦çœ‹åˆ°çš„ï¼ŒGitåœ¨æŸäº›æ–¹é¢åˆ©ç”¨äº†å˜é€šçš„æ–¹æ¡ˆã€‚ 6.4 å·¥å…·åŒ…ï¼ˆToolKitï¼‰å¦‚ä»Šï¼ŒGitç”Ÿæ€ç³»ç»Ÿä¸­ï¼Œæœ‰å¾ˆå¤šå‘½ä»¤è¡Œå’ŒUIå·¥å…·é€‚ç”¨äºå„ç§æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬åŸæ¥å‡ ä¹ä¸æ”¯æŒçš„Windowsç³»ç»Ÿï¼‰ã€‚å…¶ä¸­å¤§éƒ¨åˆ†å·¥å…·éƒ½æ˜¯å»ºç«‹åœ¨Gitå·¥å…·åŒ…ä¹‹ä¸Šçš„ã€‚ å› ä¸ºGitä¸€å¼€å§‹æ˜¯Linuså†™çš„ï¼Œå¹¶ä¸”åœ¨Linuxç¤¾åŒºé‡Œå¯åŠ¨ï¼Œæ‰€ä»¥Gitéµå¾ªçš„æ˜¯Unixä¼ ç»Ÿçš„å‘½ä»¤è¡Œæ¨¡å¼çš„å·¥å…·è®¾è®¡å“²å­¦ã€‚ Gitå·¥å…·åŒ…åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šâ€œé“…ï¼ˆplumbingåº•å±‚å‘½ä»¤ï¼‰â€å’Œâ€œç“·ï¼ˆporcelainé«˜å±‚å‘½ä»¤ï¼‰â€ã€‚plumbingæ˜¯æŒ‡ä¸€äº›åº•å±‚çš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å¯ä»¥æä¾›åŸºæœ¬çš„å†…å®¹è¿½è¸ªå’ŒDAGæ“ä½œåŠŸèƒ½ã€‚porcelainæ˜¯è¾ƒå°çš„gitå‘½ä»¤é›†åˆï¼Œç”¨æˆ·å¯èƒ½ç”¨è¿™äº›å‘½ä»¤æ¥ç»´æŠ¤ä»“åº“å’Œåœ¨å„ä¸ªä»“åº“é—´è¿›è¡Œäº¤æµã€‚ å°½ç®¡å·¥å…·åŒ…å·²ç»ä¸ºè®¸å¤šç¼–ç å™¨æä¾›äº†è¶³å¤Ÿå¤šçš„ç»†å°ç²’åº¦çš„åŠŸèƒ½ï¼Œä½†æ˜¯åº”ç”¨å¼€å‘è€…ä»æ—§æŠ±æ€¨Gitç¼ºå°‘ä¸€ä¸ªå¯ä»¥é“¾æ¥çš„å‡½æ•°åº“ã€‚å› ä¸ºGitçš„å¯æ‰§è¡Œå‡½æ•°ä¸ºdie()ï¼Œå®ƒä¸å¯é‡å…¥å¹¶ä¸”æ²¡æœ‰ç•Œé¢ï¼Œç½‘ç»œæ¥å£å’Œé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡å™¨å¿…é¡»ç”¨fork/execå‘½ä»¤æ¥è°ƒç”¨Gitçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™æ ·åšååˆ†ä½æ•ˆã€‚ ä¸ºåº”ç”¨å¼€å‘è€…æ”¹å˜è¿™ç§çŠ¶å†µçš„å·¥ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼›è¯¦æƒ…è¯·çœ‹â€œç°åœ¨å’Œæœªæ¥çš„åŠ¨ä½œâ€éƒ¨åˆ†ã€‚ 6.5 ä»“åº“ï¼Œç¼“å­˜åŒºå’Œå·¥ä½œåŒºï¼ˆThe Repository, Index and Working Areasï¼‰git initä¼šåˆ›å»ºä¸€ä¸ª.gitå­æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ tree .git/ .git/ |-- HEAD |-- index |-- config |-- description |-- hooks | |-- applypatch-msg.sample | |-- commit-msg.sample | |-- post-commit.sample | |-- post-receive.sample | |-- post-update.sample | |-- pre-applypatch.sample | |-- pre-commit.sample | |-- pre-rebase.sample | |-- prepare-commit-msg.sample | |-- update.sample |-- info | |-- exclude |-- objects | |-- info | |-- pack |-- refs |-- heads |-- tags Configuration:åˆæ­¥é…ç½®æœ¬åœ°ä»“åº“ã€‚ .git/config repositoryformatversion:å¦‚æœéœ€è¦æ”¹å˜ä»“åº“åœ¨ç£ç›˜ä¸Šçš„å½¢å¼ï¼Œå°±å¯ä»¥ä¿®æ”¹è¿™ä¸ªå‚æ•°ã€‚ filemode: ture or falseã€‚æ˜¯å¦æ³¨æ„æ–‡ä»¶çš„æ‰§è¡Œæƒé™ã€‚falseæŒ‡å½“æ–‡ä»¶æƒé™å˜åŒ–æ—¶ï¼Œæ²¡æœ‰ä¿®æ”¹æç¤ºã€‚ bareï¼štureæ˜¯æŒ‡è¯¥ä»“åº“æ²¡æœ‰å·¥ä½œç›®å½•ï¼Œåªæœ‰gitçš„ç›¸å…³æ–‡ä»¶ã€‚ logallrefupdates: è®°å½•æ‰€æœ‰çš„æ›´æ–°æ—¥å¿—ã€‚ ignorecase: æ˜¯å¦å¯¹å¤§å°å†™æ•æ„Ÿã€‚ .git/info/excludeå¦‚æœä½ ä¸æƒ³æäº¤ä¸€äº›åœ¨æœ¬åœ°çš„æ–‡ä»¶ï¼Œ.gitignoreæ–‡ä»¶æ˜¯ä¸€ä¸ªé€‰æ‹©ã€‚ä½†æ˜¯excludeæ–‡ä»¶ä¸ä¼šè¢«åˆ†äº«ç»™å…¶ä»–äººã€‚ Hooks.git/hooksä¸€äº›å¸¸ç”¨çš„ç¤ºä¾‹hooksè¢«æ”¾åœ¨ä»“åº“é‡Œï¼Œå®ƒä»¬åªåœ¨ç‰¹å®šçš„æ—¶åˆ»è§¦å‘ï¼Œå¯ä»¥è¿›è¡Œæ£€æŸ¥å’Œæç¤ºã€‚é»˜è®¤ä¸ç”Ÿæ•ˆï¼Œå°†â€œ.sampleâ€å»æ‰å¯ä½¿å…¶ç”Ÿæ•ˆã€‚ Staging Area.git/indexç¼“å†²åŒºã€‚åœ¨å·¥ä½œç›®å½•ä¸‹çš„ä¿®æ”¹ï¼Œä½¿ç”¨git addå‘½ä»¤åï¼Œå¯ä»¥å°†ä¿®æ”¹æ·»åŠ è¿›ç¼“å†²åŒºï¼Œè¿™æ˜¯å¹¶æ²¡æœ‰æäº¤åˆ°ä»“åº“ï¼Œä½¿ç”¨git commitåæ‰çœŸæ­£çš„æäº¤åˆ°ä»“åº“ä¸­ã€‚è¿™æ ·æ–¹ä¾¿å¤šä¸ªä¿®æ”¹ä¸€æ¬¡æ€§æäº¤ã€‚ 1. è¿è¡Œ â€œgit add READMEâ€. è¿™ä¼šå¯¼è‡´ git: 1. æ‹·è´å†…å®¹ï¼ˆ README ï¼‰åˆ°gitå¯¹è±¡å­˜å‚¨åŒºï¼Œå¹¶å°†å…¶å†…å®¹åŒ…å«ä¸ºä¸€ä¸ªblob. 2. åœ¨git indexä¸­è®°å½•: æ–‡ä»¶å README å’Œå­˜å‚¨äºå¯¹è±¡å­˜å‚¨åŒºçš„ README blobçš„å“ˆå¸Œå€¼. 3. æ ‡è®° (è®°ä½) è¿™ä¸ª README ç°åœ¨åœ¨ç”¨æˆ·çš„å·¥ä½œç›®å½•ä¸­çŠ¶æ€ä¸º â€œè¿½è¸ªâ€. 2. è¿è¡Œ â€œgit commitâ€ ï¼Œä»¥ â€œgit indexâ€ ä¸­æŒ‡ä»£çš„æ–‡ä»¶ä¸ºå‚æ•°ï¼Œåˆ›å»ºcommitå¯¹è±¡ï¼ŒTreeå¯¹è±¡ï¼Œæœ€åå»ºç«‹æ–°çš„æ ‘ï¼ˆæ ‘ä¸­çš„å¯¹è±¡ä¹Ÿæ”¾åœ¨å¯¹è±¡å­˜å‚¨åŒºï¼‰ï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜åˆ°gitä»“åº“é‡Œ. è¯¦æƒ…å‚è€ƒï¼šgit index Object Database.git/objectsä¸€ä¸ªå¯¹è±¡æ•°æ®åº“ï¼ŒåŒ…å«äº†æ‰€æœ‰çš„å†…å®¹å’ŒæŒ‡å‘å†…å®¹çš„æŒ‡é’ˆï¼Œå¯¹è±¡ä¸€æ—¦åˆ›å»ºå°±ä¸å¯å˜äº†ã€‚.gitæ–‡ä»¶æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”ç”¨.gitæ–‡ä»¶å¯ä»¥æ¢å¤å‡ºæ‰€æœ‰çš„å·¥ä½œç›®å½•ã€‚ References.git/refså­˜å‚¨äº†æœ¬åœ°å’Œè¿œç¨‹çš„branchã€tagå’Œcommitã€‚æ˜¯ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆï¼Œä¸€èˆ¬æ˜¯tagæˆ–è€…commitã€‚ git checkout [branch]å°†æœ¬åœ°ä»“åº“çš„HEADå¼•ç”¨å˜æˆbranchçš„å¼•ç”¨ï¼Œç”¨è¯¥branchçš„æ•°æ®å¡«å……ç¼“å†²åŒºï¼Œæ›´æ–°å·¥ä½œç›®å½•ä¸‹çš„æ–‡ä»¶ä¸ºè¯¥branchçš„å†…å®¹ã€‚ git add [files]ä¼šå°†å·¥ä½œç›®å½•ä¸‹çš„æ–‡ä»¶å’Œindexä¸­çš„æ–‡ä»¶çš„æ ¡éªŒå’Œè¿›è¡Œæ¯”è¾ƒï¼Œçœ‹æ˜¯å¦éœ€è¦æ›´æ–°indexä¸­çš„æ–‡ä»¶ï¼Œgitä»“åº“å¹¶æ²¡æœ‰æ”¹å˜ã€‚ 6.6.å¯¹è±¡æ•°æ®åº“ï¼ˆThe Object Databaseï¼‰ æ‰€æœ‰çš„å¯¹è±¡éƒ½å¦‚ä¸‹å‚æ•°ï¼šç±»å‹ï¼Œå¤§å°å’Œå†…å®¹ã€‚ Tree: ä¸€èˆ¬æ˜¯è¡¨ç¤ºä¸€ä¸ªç›®å½•ã€‚Blob: ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå­˜å‚¨åœ¨ä»“åº“é‡Œçš„æ–‡ä»¶ã€‚Commit: æŒ‡å‘ä¸€æ£µæ ‘ï¼ŒæŒ‡å‘çˆ¶commitï¼Œè®°å½•è¯¥æ¬¡æäº¤çš„ä¸€äº›ä¿¡æ¯ã€‚Tag: æ ‡è®°ä¸€ä¸ªcommitï¼Œå¯ä»¥ç»™æŸä¸ªæ—¶é—´ç‚¹è®°å½•åˆ«åå’Œé™„åŠ ä¿¡æ¯ã€‚ å¯¹è±¡ä½¿ç”¨SHAæ¥å¼•ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±40ä¸ªåå…­è¿›åˆ¶çš„æ•°å­—ç»„æˆçš„IDã€‚IDå…·æœ‰å¦‚ä¸‹å±æ€§ï¼š å¦‚æœä¸¤ä¸ªå¯¹è±¡å®Œå…¨ç›¸åŒï¼Œåˆ™å®ƒä»¬æ‹¥æœ‰ç›¸åŒçš„SHAã€‚ ä¸åŒå¯¹è±¡æœ‰ä¸åŒçš„SHAã€‚ å¯¹è±¡çš„ç¼ºå¤±å’Œé”™è¯¯ä¼šé€šè¿‡é‡æ–°è®¡ç®—SHAå‘ç°ã€‚ 6.7. å­˜å‚¨å’Œå‹ç¼©æŠ€æœ¯å°†å¯¹è±¡æ‰“åŒ…ï¼Œç”¨å‹ç¼©åˆ°çš„å½¢å¼å­˜å‚¨ï¼Œç”¨ä¸€ä¸ªç›®å½•æ–‡ä»¶æ¥ç´¢å¼•æŸä¸ªå¯¹è±¡ã€‚git addå‘½ä»¤ä¼šå°†å·¥ä½œç›®å½•ä¸‹çš„ä¿®æ”¹æ–‡ä»¶åˆ›å»ºå¯¹è±¡ï¼Œæ”¾å…¥å¯¹è±¡æ•°æ®åº“ï¼Œæ˜¯æ²¡æœ‰è¢«æ‰“åŒ…çš„ï¼Œæ¾æ•£çš„å¯¹è±¡ã€‚gitä¼šå‘¨æœŸçš„è¿›è¡Œå‹ç¼©ï¼Œæˆ–è€…é€šè¿‡å‘½ä»¤ï¼ˆgit gcï¼‰ç›´æ¥å‹ç¼©ã€‚.git/objects/pack/æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ª.idxæ–‡ä»¶å’Œä¸€ä¸ª.packæ–‡ä»¶,å¦‚å›¾æ‰€ç¤ºã€‚ æ‰“åŒ…æ–‡ä»¶æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œè¯¦ç»†è§£é‡Šã€‚ç‰ˆæœ¬2åŒ…å«äº†æ¯ä¸ªå¯¹è±¡çš„CRCæ ¡éªŒå€¼, å› æ­¤åœ¨é‡æ‰“åŒ…çš„è¿‡ç¨‹ä¸­, å‹ç¼©è¿‡çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›è¡ŒåŒ…é—´æ‹·è´(from pack to pack)è€Œä¸ç”¨æ‹…å¿ƒæ•°æ®æŸå. ç‰ˆæœ¬2çš„æ‰“åŒ…æ–‡ä»¶ç´¢å¼•åŒæ—¶äº¦æ”¯æŒå¤§äº4Gçš„æ‰“åŒ…æ–‡ä»¶ã€‚ åœ¨ç¬¬1ç‰ˆä¸­, offset(åç§»)å’ŒSHAå€¼å­˜åœ¨åœ¨åŒä¸€ä½ç½®. ä½†æ˜¯åœ¨ç¬¬2ç‰ˆä¸­, SHAå€¼, CRCå€¼å’Œoffsetè¢«æ”¾åœ¨ä¸åŒçš„è¡¨ä¸­. ä¸¤ä¸ªç‰ˆæœ¬çš„æ–‡ä»¶æœ€åéƒ½æ˜¯ç´¢å¼•æ–‡ä»¶ä»¥åŠæŒ‡å‘çš„æ‰“åŒ…æ–‡ä»¶çš„CRCæ ¡éªŒå€¼ã€‚ å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œ è¦ä»æ‰“åŒ…æ–‡ä»¶ä¸­æå–(extract)å‡ºä¸€ä¸ªå¯¹è±¡, ç´¢å¼•æ–‡ä»¶ä¸æ˜¯å¿…ä¸å¯å°‘çš„. ç´¢å¼•æ–‡ä»¶çš„ä½œç”¨æ˜¯å¸®åŠ©ç”¨æˆ·å¿«é€Ÿåœ°ä»æ‰“åŒ…æ–‡ä»¶ä¸­æå–å¯¹è±¡ã€‚ é‚£äº›â€ä¸Šä¼ æ‰“åŒ…â€(upload-pack)å’Œâ€å–å›æ‰“åŒ…â€(receive-pack)ç¨‹åº(è¯‘æ³¨: å®ç°pushå’Œfetchåè®®çš„ç¨‹åº)ä½¿ç”¨æ‰“åŒ…æ–‡ä»¶æ ¼å¼(packfile format)å»ä¼ è¾“å¯¹è±¡, ä½†æ˜¯æ²¡æœ‰ä½¿ç”¨ç´¢å¼•â€“ç´¢å¼•å¯ä»¥åœ¨ä¸Šä¼ æˆ–è€…å–å›æ‰“åŒ…æ–‡ä»¶ä¹‹åé€šè¿‡æ‰«ææ‰“åŒ…æ–‡ä»¶é‡æ–°å»ºç«‹ã€‚ 6.8. å†å²è®°å½•åˆå¹¶ï¼ˆMerge Historiesï¼‰Subversionè¿™ä¸€ç±»ç”¨çº¿çŠ¶å†å²çš„VCSï¼Œé«˜ç‰ˆæœ¬çš„ä¼šå–ä»£å®ƒä¹‹å‰æ‰€æœ‰æ—§çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸ç›´æ¥æ”¯æŒåˆ†æ”¯ã€‚åˆ†æ”¯åˆå¹¶åˆ°ä¸»çº¿åï¼Œæ— æ³•çŸ¥æ™“å“ªäº›å˜åŒ–æ¥è‡ªå“ªäº›åˆ†æ”¯ã€‚ Gitä½¿ç”¨åŸºäºDAGçš„å†å²åˆå¹¶ï¼ŒæŸä¸€åˆ†æ”¯çš„æŸæ¬¡åˆå¹¶å¯ä»¥é€šè¿‡å®ƒçˆ¶èŠ‚ç‚¹çš„SHAçŸ¥é“å®ƒç”±å“ªäº›åˆ†æ”¯åˆå¹¶è€Œæ¥ã€‚å¦‚å›¾ã€‚ 6.9. æ¥ä¸‹æ¥è¦åšçš„äº‹ä¸ä»…è¦æ–¹ä¾¿è„šæœ¬ä½¿ç”¨ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥è®¾è®¡æ¥æ–¹ä¾¿åœ°åµŒå…¥å…¶å®ƒåº”ç”¨ï¼Œæ–¹ä¾¿çš„é›†æˆè¿›å¼€å‘ç¯å¢ƒã€‚ç°åœ¨å·²ç»å¼€å‘å‡ºäº†ä¸€äº›å¯ä»¥è¢«å…¶ä»–è¯­è¨€è°ƒç”¨çš„åº“ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€äº›æ”¯æŒGitå­˜å‚¨çš„åç«¯è¢«å¼€å‘å‡ºæ¥ã€‚ 6.10. ç»éªŒå’Œæ•™è®­ In software, every design decision is ultimately a trade-off. æ¯ä¸€ä¸ªè®¾è®¡ç­–ç•¥çš„é€‰æ‹©éƒ½æœ€ç»ˆæ˜¯ä¸€ä¸ªæƒè¡¡çš„è¿‡ç¨‹ã€‚ åŸæ¥çš„Gitå·¥å…·åŒ…çš„è®¾è®¡ä¸ºå…¶å®ƒIDEçš„é›†æˆå¸¦æ¥äº†éº»çƒ¦ã€‚æ—©æœŸï¼Œå‘½ä»¤è¡Œçš„å½¢å¼å¯¼è‡´Gitçš„å¯ç§»æ¤æ€§å¾ˆå·®ï¼Œç‰¹åˆ«æ˜¯å¯¹Windowsè€Œè¨€ï¼Œå¯¼è‡´å—ä¼—èŒƒå›´å¾ˆå°ã€‚ Gitå‘½ä»¤ä¹Ÿéš¾è®°ï¼Œé”™è¯¯ä¿¡æ¯ä¹Ÿéš¾ä»¥ç†è§£ã€‚","tags":[{"name":"è®°å½•","slug":"è®°å½•","permalink":"http://itanch.github.io/tags/è®°å½•/"},{"name":"git","slug":"git","permalink":"http://itanch.github.io/tags/git/"},{"name":"æ¶æ„","slug":"æ¶æ„","permalink":"http://itanch.github.io/tags/æ¶æ„/"}]},{"title":"ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯(3)","date":"2017-04-10T13:21:46.000Z","path":"2017/04/10/ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯-3/","text":"ç”¨React-NativeæŠ€æœ¯å®ç°ä¸€ä¸ªç®€å•çš„å¾®åšå®¢æˆ·ç«¯ã€‚é¡¹ç›®å¼€æºåœ°å€ï¼šgithubã€‚é¡¹ç›®è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ğŸ˜Šã€‚ è¿™ä¸€ç« èŠ‚ä¸»è¦è®²ä¸€ä¸‹åœ¨è®¾è®¡è¯¥appæ—¶é‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚ å¯¼èˆªAndroidåº”ç”¨åœ¨è®¾è®¡çš„æ—¶å€™ï¼ŒActivityä¹‹é—´çš„è·³è½¬å½¢æˆäº†ä¸€ä¸ªtaskï¼Œè¯¥taské€šè¿‡ä¸€ä¸ªæ ˆç»“æ„æ¥ä½“ç°ã€‚å½“ç”¨æˆ·ç‚¹å‡»backé”®ï¼Œå½“å‰çš„activityä¼šè‡ªç„¶çš„é”€æ¯ï¼ŒåŒæ—¶ä½äºæ ˆé¡¶çš„activityä¼šå æ®å±å¹•ã€‚è¿™ç§è®¾è®¡æ–¹å¼å¾ˆç¬¦åˆç”¨æˆ·çš„æ“ä½œä¹ æƒ¯ï¼Œæ‰€ä»¥åœ¨é€šè¿‡react-nativeè®¾è®¡appæ—¶ï¼Œä¹Ÿéœ€è¦æœ‰ç»„ä»¶æ¥å®ç°è¿™ç§åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä½¿ç”¨äº†Navigatorç»„ä»¶ã€‚ åœ¨appä¸­ï¼Œå½“ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªå¾®åšæ—¶ï¼Œç•Œé¢ä¼šè·³è¿›æ‰€ç‚¹å‡»å¾®åšçš„å†…å®¹ï¼Œæ˜¾ç¤ºå¾®åšå†…å®¹è¯¦æƒ…ï¼Œå¹¶ä¸”å¯ä»¥æŸ¥çœ‹å¾®åšè¯„è®ºã€‚å½“ç”¨æˆ·ç‚¹å‡»å‰å·ï¼Œä¼šé€€åˆ°æµè§ˆå¾®åšçš„é¡µé¢ã€‚ å†çœ‹ä¸€ä¸‹å†™åœ¨android/welone/index.android.jsä¸­çš„å¯¼èˆªç»„ä»¶ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142export default class welone extends Component &#123; render() &#123; let mainComponent = MainTab; return ( &lt;Navigator //åˆå§‹åŒ–routeçš„å±æ€§ initialRoute=&#123;&#123; component: mainComponent &#125;&#125; //è®¾ç½®ç•Œé¢åˆ‡æ¢çš„åŠ¨ç”»æ•ˆæœ configureScene=&#123;(route) =&gt; &#123; return Navigator.SceneConfigs.VerticalDownSwipeJump; &#125;&#125; //æ ¹æ®routeå±æ€§ï¼Œæ¸²æŸ“å½“å‰ç•Œé¢ç»„ä»¶ renderScene=&#123;(route, navigator) =&gt; &#123; let Comp = route.component; return &lt;Comp &#123;...route.params&#125; navigator=&#123;navigator&#125; /&gt; &#125;&#125; /&gt; ); &#125;&#125;``` è¿™é‡Œå°†MainTabè®¾ç½®ä¸ºå½“å‰åˆå§‹çš„ä¸»ç•Œé¢ï¼Œå¹¶ä¸”å°†`navigator`ä½œä¸ºå±æ€§ä¼ é€’ç»™MainTabï¼ŒåŒæ—¶è¿˜ä¼ é€’äº†ä¸€ä¸ª`route.params`å±æ€§ï¼Œè¿™é‡Œè¯¥å±æ€§ä¸ºç©ºï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰ä»€ä¹ˆä½œç”¨ï¼Œä»¥åä¼šç”¨åˆ°ã€‚é€šè¿‡propsï¼Œæˆ‘å°†navigatorå¯¹è±¡ä¾æ¬¡ä¼ é€’åˆ°äº†`WeiboCard`ï¼Œä¹Ÿå°±æ˜¯æ˜¾ç¤ºæ¯ä¸€ä¸ªå¾®åšå†…å®¹çš„å¡ç‰‡ã€‚å½“ç‚¹å‡»è¯¥å¡ç‰‡æ—¶ï¼Œå°±ä¼šè§¦å‘ç•Œé¢è·³è½¬çš„åŠŸèƒ½ã€‚```js //start the weibo content startWeiboContent(data) &#123; const &#123; navigator &#125; = this.props; if (navigator) &#123; //å‘å¯¼èˆªæ ˆä¸­æ”¾å…¥éœ€è¦è·³è½¬çš„ç»„ä»¶ navigator.push(&#123; component: WeiboContent, //å°†å¾®åšå†…å®¹ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº†ä¸‹ä¸€ä¸ªç•Œé¢ï¼Œå¯ä»¥å‚è€ƒä¸Šä¸€æ®µä»£ç  params: &#123; data: data &#125; &#125;) &#125; &#125; è¿™é‡Œè°ƒç”¨äº†navigatorçš„pushå‡½æ•°ï¼Œæ”¾å…¥äº†éœ€è¦å æ®å±å¹•çš„ç•Œé¢WeiboContentã€‚è¿™æ—¶ï¼ŒMainTabå°±ä¼šè¢«è¦†ç›–ï¼Œæ˜¾ç¤ºWeiboContentç•Œé¢ã€‚ åœ¨WeiboContentç•Œé¢ï¼Œå¦‚æœéœ€è¦è¿”å›ä¸Šä¸€ä¸ªç•Œé¢MainTabï¼Œç‚¹å‡»å‰å·ï¼Œåˆ™ä¼šè°ƒç”¨å¦‚ä¸‹å‡½æ•°ã€‚ 1234567//navigate to the parentpressBack() &#123; const &#123; navigator &#125; = this.props; if (navigator) &#123; navigator.pop(); &#125;&#125; navigatoråªéœ€è¦popä¸€ä¸‹å°±å¯ä»¥äº†ã€‚ æ•°æ®ä¼ é€’åœ¨Reactä¸­ï¼Œçˆ¶ç»„ä»¶å‘å­ç»„ä»¶ä¼ é€’æ•°æ®ï¼Œä¸»è¦çš„æ–¹å¼å°±æ˜¯é€šè¿‡è®¾ç½®å­ç»„ä»¶çš„propsï¼Œç»„ä»¶å†…éƒ¨çš„çŠ¶æ€é€šè¿‡statesæ¥ä¿å­˜ã€‚propsæ˜¯å¤–éƒ¨ç»™ç»„ä»¶çš„å±æ€§ï¼Œstatesæ—¶ç»„ä»¶è‡ªå·±çš„å±æ€§ã€‚æ•°æ®æµä»çˆ¶èŠ‚ç‚¹æµå‘å­èŠ‚ç‚¹ã€‚è¿™ç§è²Œä¼¼å®Œç¾çš„è®¾è®¡æ–¹å¼ï¼Œåœ¨æœ‰äº›æƒ…å†µä¸‹ä¼šä¸æ–¹ä¾¿ã€‚ æ¯”å¦‚ï¼Œå­èŠ‚ç‚¹éœ€è¦æ›´æ–°çˆ¶èŠ‚ç‚¹çš„çŠ¶æ€ã€æˆ–è€…è°ƒç”¨çˆ¶äº²èŠ‚ç‚¹çš„åŠŸèƒ½ã€‚åˆ™éœ€è¦å°†å‡½æ•°é€šè¿‡propså°†å‡½æ•°ä¼ é€’åˆ°å­èŠ‚ç‚¹ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š åœ¨çˆ¶èŠ‚ç‚¹WeiboContentä¸­ï¼Œå°†å‡½æ•°getCommentsä½œä¸ºå±æ€§ä¼ é€’ç»™äº†å­ç»„ä»¶WeiboCardã€‚1&lt;WeiboCard weiData=&#123;this.props.data&#125; getComments=&#123;this.getComments.bind(this)&#125; /&gt; åœ¨WeiboCardä¸­ï¼Œè°ƒç”¨ä¼ å…¥çš„getCommentsæ¥æ›´æ–°è¯„è®ºå†…å®¹.ä¸Šæ®µä»£ç ä¸­çš„bindæŒ‡æ˜äº†è¯¥å‡½æ•°åœ¨å½“å‰ç»„ä»¶çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚ 12345getComments() &#123; if (this.props.getComments) &#123; this.props.getComments(NEW_COMMENT); &#125;&#125; å¦‚æœçˆ¶ç»„ä»¶æƒ³è¦è°ƒç”¨å­ç»„ä»¶çš„å‡½æ•°å‘¢ï¼Ÿè¿™å°±ç”¨åˆ°refå±æ€§ã€‚ åœ¨çˆ¶èŠ‚ç‚¹MainTabä¸­ï¼Œä¿ç•™äº†å­ç»„ä»¶çš„å¼•ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚12345678910111213 &lt;WeiboList navigator=&#123;this.props.navigator&#125; ref=&#123;(weiboList) =&gt; &#123; this.weiboList = weiboList &#125;&#125; tab=&#123;this.state.activeTab&#125; /&gt;``` å°†WeiboListç»„ä»¶ä¿å­˜åœ¨weibolistå˜é‡ä¸­ï¼Œè¿™æ ·çˆ¶ç»„ä»¶å°±å¯ä»¥è°ƒç”¨å­èŠ‚ç‚¹çš„å‡½æ•°äº†ã€‚å¦‚ä¸‹ï¼š ```js onPressTab(tab) &#123; if (this.weiboList != null) &#123; this.weiboList.getTimeLine(NEW_WEIBO); &#125; &#125; æ˜¾ç„¶è¿™ç§è®¾è®¡æ–¹å¼æ˜¯ä¸ä¼˜ç¾çš„ï¼Œç ´åäº†ç»„ä»¶ä¹‹é—´çš„ç‹¬ç«‹æ€§ã€‚ä»¥åçš„ç« èŠ‚ä¸­ï¼Œæˆ‘å°†ä¼šå¯»æ‰¾æ›´å¥½çš„ä¿å­˜ç»„ä»¶çŠ¶æ€çš„æ–¹æ³•ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"},{"name":"React Native","slug":"React-Native","permalink":"http://itanch.github.io/tags/React-Native/"}]},{"title":"ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯(2)","date":"2017-04-08T08:47:49.000Z","path":"2017/04/08/ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯-2/","text":"ç”¨React-NativeæŠ€æœ¯å®ç°ä¸€ä¸ªç®€å•çš„å¾®åšå®¢æˆ·ç«¯ã€‚é¡¹ç›®å¼€æºåœ°å€ï¼šgithubã€‚é¡¹ç›®è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ğŸ˜Šã€‚ ä¸»ç•Œé¢è®¾è®¡è¿›å…¥åº”ç”¨ï¼Œé¦–å…ˆçœ‹åˆ°çš„å°±æ˜¯ä¸»ç•Œé¢ï¼Œè¿™é‡Œé‡‡ç”¨äº†ç»å…¸çš„åº•éƒ¨3ä¸ªtabçš„ä¸»ç•Œé¢è®¾è®¡é£æ ¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ react-native æ¡†æ¶å·²ç»ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªç®€å•çš„ä¸»ç•Œé¢äºindex.android.jsï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021export default class welone extends Component &#123; render() &#123; return ( &lt;View style=&#123;styles.container&#125;&gt; &lt;Text style=&#123;styles.welcome&#125;&gt; Welcome to React Native! &lt;/Text&gt; &lt;Text style=&#123;styles.instructions&#125;&gt; To get started, edit index.ios.js &lt;/Text&gt; &lt;Text style=&#123;styles.instructions&#125;&gt; Press Cmd+R to reload,&#123;'\\n'&#125; Cmd+D or shake for dev menu &lt;/Text&gt; &lt;/View&gt; ); &#125;&#125;//...AppRegistry.registerComponent('welone', () =&gt; welone); è¿™é‡Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯å°†render()å‡½æ•°ä¸­çš„å†…å®¹æ›¿æ¢æˆæˆ‘ä»¬çš„componetã€‚è¿™é‡Œæˆ‘æ–°å»ºäº†ä¸€ä¸ªMainTabç»„å»ºï¼Œå¹¶ä¸”å°†å®ƒæ”¾ç½®äº./app/comp/MainTab.android.jsä¸­ï¼Œandroidåç¼€è¡¨æ˜ç¼–è¯‘androidåº”ç”¨æ—¶é€‰æ‹©è¯¥jsæ–‡ä»¶ä½œä¸ºç¼–è¯‘å¯¹è±¡ï¼Œè¿™æ ·ä½ ä¹Ÿå¯ä»¥å®ç°MainTab.ios.jsï¼Œä»è€Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç³»ç»Ÿé‡‡ç”¨ä¸åŒçš„è®¾è®¡å†…å®¹ã€‚è¿™é‡Œæˆ‘æ–°å»ºäº†ä¸€ä¸ªappç›®å½•ç”¨æ¥å­˜æ”¾ç»„ä»¶ç›¸å…³çš„ä»£ç å’Œèµ„æºï¼Œæˆ‘çš„æ–‡ä»¶ç»„ç»‡ç›®å½•å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä¿®æ”¹åçš„index.android.jså¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627//...import MainTab from './app/comp/MainTab';export default class welone extends Component &#123; render() &#123; //ä¸»ç•Œé¢çš„MainTabç»„ä»¶ let mainComponent = MainTab; return ( //è¿™é‡Œæ˜¯ç”¨äº†Navigatorç»„ä»¶ï¼Œç›®çš„æ˜¯ä¸ºäº†ä»¥åçš„å¯¼èˆªæ ä½œç”¨ &lt;Navigator initialRoute=&#123;&#123; component: mainComponent &#125;&#125; configureScene=&#123;(route) =&gt; &#123; return Navigator.SceneConfigs.VerticalDownSwipeJump; &#125;&#125; renderScene=&#123;(route, navigator) =&gt; &#123; //è¿™é‡Œçš„ç»„å»ºå°±æ˜¯MainTab let Comp = route.component; //MainTab return &lt;Comp &#123;...route.params&#125; navigator=&#123;navigator&#125; /&gt; &#125;&#125; /&gt; ); &#125;&#125;//... å…ˆå¿½ç•¥Navigatorç»„ä»¶åœ¨è¿™é‡Œçš„ä½œç”¨ï¼Œè¿™é‡Œå¯ä»¥å…ˆç†è§£ä¸ºä»¥MainTabä½œä¸ºå½“å‰çš„è§†å›¾çš„æ ¹viewï¼š 123render() &#123; return &lt;MainTab /&gt;&#125; åœ¨app/comp/MainTab.android.jsé‡Œï¼Œæˆ‘é‡‡ç”¨äº†åŒæ ·ç»å…¸çš„ä¸‰æ®µå¼é…åˆ3ä¸ªtabæ¥ä½¿ç”¨ã€‚ 1234567891011121314151617181920212223242526272829303132333435//...export default class MainTab extends Component &#123; //... render() &#123; return ( &lt;Container theme=&#123;TianTheme&#125;&gt; //å¤´éƒ¨æ ‡é¢˜ä¼šè·Ÿç€tabçš„åˆ‡æ¢å˜åŒ– &lt;Header&gt; //æ ‡é¢˜å†…å®¹ &lt;/Header&gt; //ä¸»ä½“ï¼Œæ˜¾ç¤ºå†…å®¹ &lt;Content style=&#123;&#123; backgroundColor: '#f8f9f9' &#125;&#125;&gt; //... &lt;/Content&gt; //åº•éƒ¨ï¼Œæ˜¾ç¤º3ä¸ªtab &lt;Footer style=&#123;&#123; borderTopWidth: 1, borderTopColor: '#e5e8e8' &#125;&#125;&gt; &lt;FooterTab&gt; &lt;Button onPress=&#123;() =&gt; this.onPressTab(TAB_LOVE)&#125;&gt; &lt;Icon name='ios-heart' /&gt; &lt;/Button&gt; &lt;Button onPress=&#123;() =&gt; this.onPressTab(TAB_ME)&#125;&gt; &lt;Icon name='ios-chatbubbles' /&gt; &lt;/Button&gt; &lt;Button onPress=&#123;() =&gt; this.onPressTab(TAB_SET)&#125;&gt; &lt;Icon name='ios-settings' /&gt; &lt;/Button&gt; &lt;/FooterTab&gt; &lt;/Footer&gt; &lt;/Container&gt; ); &#125;&#125; å…¶ä¸­Containerã€Headerã€Contentã€Footerç­‰ç»„ä»¶çš†æ¥è‡ªäºNative-Baseã€‚æˆ‘çš„å»ºè®®æ˜¯èƒ½ç”¨åŸå§‹çš„react-nativeçš„ç»„å»ºå°±ç”¨åŸå§‹çš„ï¼ŒNative-Baseæä¾›çš„ç»„ä»¶è™½ç„¶ç¾è§‚ï¼Œä½†æ˜¯ç¼ºå°‘äº†å®šåˆ¶çš„çµæ´»æ€§ã€‚ å½“ç‚¹å‡»tabæ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°onPressTab()è§¦å‘viewçš„å˜åŒ–ã€‚æ ¹æ®ä¼ å…¥çš„å‚æ•°ç¡®å®šç”¨æˆ·ç‚¹å‡»çš„å“ªä¸€ä¸ªtabï¼Œç„¶åä¿®æ”¹å½“å‰çš„çŠ¶æ€ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ¶‰åŠä¿®æ”¹å½“å‰ç»„ä»¶çŠ¶æ€çš„æ“ä½œthis.setState({ activeTab: tab })ï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°é‡‡ç”¨&lt;Button onPress={() =&gt; this.onPressTab(TAB_SET)}&gt;ï¼Œè¿™é‡Œæ˜¯ç”¨ç®­å¤´å‡½æ•°æŒ‡æ˜äº†è¯¥å‡½æ•°è¿è¡Œçš„ä¸Šä¸‹æ–‡ä½äºè¯¥ç»„ä»¶ä¸­ã€‚åœ¨ä¸æ¶‰åŠä¿®æ”¹stateæ—¶å¹¶æ— å¤§ç¢ï¼Œå¦‚æœæ¶‰åŠä¿®æ”¹stateï¼Œä¸€å®šè¦é‡‡ç”¨å¼‚æ­¥æ“ä½œã€‚è®°ä½åƒä¸‡ä¸è¦åœ¨renderå‡½æ•°ä¸­ç›´æ¥ä¿®æ”¹stateã€‚ 1234onPressTab(tab) &#123; //... this.setState(&#123; activeTab: tab &#125;)&#125; å†…å®¹æ˜¾ç¤ºåœ¨MainTabç»„ä»¶ä¸­ï¼Œæ˜¾ç¤ºå†…å®¹çš„éƒ¨åˆ†éœ€è¦æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ä¾æ¬¡æ˜¾ç¤ºâ€œå…³æ³¨â€ã€â€œæ¶ˆæ¯â€å’Œâ€œè®¾ç½®â€ä¸‰ä¸ªæ¿å—ï¼Œä¸ºæ­¤æˆ‘è®¾è®¡äº†ä¸€ä¸ªWeiboListç»„ä»¶æ¥æ˜¾ç¤ºå…·ä½“å†…å®¹ï¼Œå¹¶ä¸”ä½œä¸ºContentçš„å­ç»„ä»¶é•¶åµŒè¿›MainTabã€‚ 1234567891011&lt;Content style=&#123;&#123; backgroundColor: '#f8f9f9' &#125;&#125;&gt; &lt;View style=&#123;&#123; marginHorizontal: 7 &#125;&#125;&gt; &lt;WeiboList navigator=&#123;this.props.navigator&#125; //ä¿ç•™weibolistç»„ä»¶çš„å¼•ç”¨ ref=&#123;(weiboList) =&gt; &#123; this.weiboList = weiboList &#125;&#125; //æŒ‡æ˜å½“å‰ç”¨æˆ·é€‰æ‹©çš„å“ªä¸€ä¸ªtab tab=&#123;this.state.activeTab&#125; /&gt; &lt;/View&gt;&lt;/Content&gt; è¿™é‡Œä¸ºWeiboListç»„ä»¶æ·»åŠ äº†å±æ€§tabï¼Œæè¿°å½“å‰ç”¨æˆ·é€‰æ‹©çš„tabç±»å‹ã€‚åŒæ—¶ï¼Œä¸ºMainTabä¿ç•™äº†ä¸€ä¸ªweibolistçš„åº”ç”¨ï¼Œä¸ºçš„æ˜¯ä»MainTabç»„ä»¶ä¸­è°ƒç”¨WeiboListçš„å‡½æ•°ï¼Œå½“ç„¶è¿™ç§è®¾è®¡æ–¹å¼ä¸ç®—ä¼˜ç¾ï¼Œå°†æ¥æˆ‘ä¼šç”¨å…¶å®ƒæ–¹å¼è¿›è¡Œæ”¹è¿›ã€‚ åœ¨WeiboListç»„ä»¶ä¸­ï¼Œå®ç°render()å‡½æ•°å¦‚ä¸‹ï¼š 123456789101112131415161718192021render() &#123; if (this.props.tab === TAB_LOVE) &#123; //å…³æ³¨äººçš„å¾®åšåˆ—è¡¨ return ( &lt;ListView //è®¾ç½®æ•°æ®æº dataSource=&#123;this.state.loveSource&#125; //åˆ—è¡¨ä¸­çš„å­ç»„ä»¶ renderRow=&#123;(rowData) =&gt; &lt;WeiboCard weiData=&#123;rowData&#125; navigator=&#123;this.props.navigator&#125; /&gt;&#125; //åˆ—è¡¨åº•éƒ¨ç»„ä»¶ renderFooter=&#123;() =&gt; this.getEnd(GET_MORE_WEIBO)&#125; /&gt; ); &#125; else if (this.props.tab === TAB_ME) &#123; //ç”¨æˆ·æ¶ˆæ¯ //... &#125; else &#123; //ç”¨æˆ·è®¾ç½® //... &#125; &#125; æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ¿å—ï¼Œè¿”å›ä¸åŒçš„ç»„ä»¶å†…å®¹ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹å¾®åšå†…å®¹åˆ—è¡¨çš„å®ç°ï¼Œå…³äºå¾®åšç™»å½•è®¤è¯çš„æ¨¡å—ï¼Œå¯ä»¥å‚è€ƒæºä»£ç ã€‚ ä¸ºäº†æ˜¾ç¤ºåˆ—è¡¨ç»“æ„çš„å¾®åšå†…å®¹ï¼Œä½¿ç”¨äº†react-nativeè‡ªå¸¦çš„ListViewç»„ä»¶ï¼ŒListViewå¯ä»¥æ»šåŠ¨çš„ç°å®Viewå­ç»„ä»¶åˆ—è¡¨ã€‚å®ƒéœ€è¦è®¾ç½®ä¸¤ä¸ªé‡è¦å±æ€§ï¼ŒdataSourceè¡¨ç¤ºæ•°æ®æ•°ç»„ï¼ŒrenderRowåˆ™ä¼šå°†æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å–å‡ºæ¥ï¼Œæ¸²æŸ“ä¸€ä¸ªå­ç»„ä»¶ã€‚è¿™é‡Œæˆ‘è®¾è®¡äº†WeiboCardæ¥æ˜¾ç¤ºå¾®åšçš„å…·ä½“å†…å®¹ã€‚ dataSoureceçš„æ•°æ®æºæ¥è‡ªthis.state.loveSourceï¼Œè¯¥çŠ¶æ€åœ¨WeiboListä¸­è¿›è¡Œåˆå§‹åŒ–ã€‚ 123456789101112constructor(props) &#123; super(props); //åˆ›å»ºä¸€ä¸ªDataSourceï¼Œå¹¶ä¸”è®¾ç½®åˆ¤æ–­å½“å‰è§†å›¾æ˜¯å¦å‘ç”Ÿæ»šåŠ¨çš„åˆ¤æ–­å‡½æ•°ï¼Œä»¥æ­¤æ¥å‡å°‘ç»˜åˆ¶åˆ—è¡¨çš„æ¶ˆè€—ã€‚ let ds1 = new ListView.DataSource(&#123; rowHasChanged: (r1, r2) =&gt; r1 !== r2 &#125;); this.state = &#123; loveSource: ds1, &#125;; //ç”¨æ¥å­˜å‚¨å½“å‰è·å–çš„å¾®åšå†…å®¹æ•°ç»„ this.loveData = [];&#125; åˆ°æ­¤ä¸ºæ­¢ï¼Œè§†å›¾å·²ç»è®¾è®¡å®Œæ¯•ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ•°æ®ã€‚æ¥ä¸‹æ¥éœ€è¦å®Œæˆè·å–æ•°æ®çš„éƒ¨åˆ†ã€‚ æ•°æ®è·å–è¿™é‡Œé‡‡ç”¨çš„å¾®åšapiçš„Androidç‰ˆæœ¬ï¼Œæ˜¯ä¸€ä¸ªjavaåº“ï¼Œå¹¸è¿çš„æ˜¯react-nativeæä¾›äº†æ¥å£è®©æˆ‘ä»¬å¼€å‘åŸç”Ÿæ¨¡å—åœ¨jsä¸­è°ƒç”¨ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç ”ç©¶ä¸€ä¸‹æ˜¯å¦å¯ä»¥ç›´æ¥è°ƒç”¨å¾®åšçš„jsåº“ã€‚ å…ˆçœ‹ä¸€ä¸‹å¾®åšapiä¸­æä¾›äº†ä»€ä¹ˆæ ·çš„æ¥å£ä¾›å¼€å‘è€…è°ƒç”¨ã€‚åœ¨com/sina/weibo/sdk/openapi/StatusesAPI.javaä¸­ï¼Œæä¾›äº†ä¸€äº›ä¸è·å–å¾®åšå†…å®¹æœ‰å…³çš„å‡½æ•°ï¼Œå¹¶ä¸”æä¾›äº†è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨çš„å°±æ˜¯å¦‚ä¸‹æ¥å£ã€‚ 1234567891011121314151617181920212223/** * è·å–å½“å‰ç™»å½•ç”¨æˆ·åŠå…¶æ‰€å…³æ³¨ç”¨æˆ·çš„æœ€æ–°å¾®åšã€‚ * * @param since_id è‹¥æŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™è¿”å›IDæ¯”since_idå¤§çš„å¾®åšï¼ˆå³æ¯”since_idæ—¶é—´æ™šçš„å¾®åšï¼‰ï¼Œé»˜è®¤ä¸º0 * @param max_id è‹¥æŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™è¿”å›IDå°äºæˆ–ç­‰äºmax_idçš„å¾®åšï¼Œé»˜è®¤ä¸º0ã€‚ * @param count å•é¡µè¿”å›çš„è®°å½•æ¡æ•°ï¼Œé»˜è®¤ä¸º50ã€‚ * @param page è¿”å›ç»“æœçš„é¡µç ï¼Œé»˜è®¤ä¸º1ã€‚ * @param base_app æ˜¯å¦åªè·å–å½“å‰åº”ç”¨çš„æ•°æ®ã€‚falseä¸ºå¦ï¼ˆæ‰€æœ‰æ•°æ®ï¼‰ï¼Œtrueä¸ºæ˜¯ï¼ˆä»…å½“å‰åº”ç”¨ï¼‰ï¼Œé»˜è®¤ä¸ºfalseã€‚ * @param featureType è¿‡æ»¤ç±»å‹IDï¼Œ0ï¼šå…¨éƒ¨ã€1ï¼šåŸåˆ›ã€2ï¼šå›¾ç‰‡ã€3ï¼šè§†é¢‘ã€4ï¼šéŸ³ä¹ï¼Œé»˜è®¤ä¸º0ã€‚ * &lt;li&gt;&#123;@link #FEATURE_ALL&#125; * &lt;li&gt;&#123;@link #FEATURE_ORIGINAL&#125; * &lt;li&gt;&#123;@link #FEATURE_PICTURE&#125; * &lt;li&gt;&#123;@link #FEATURE_VIDEO&#125; * &lt;li&gt;&#123;@link #FEATURE_MUSICE&#125; * @param trim_user è¿”å›å€¼ä¸­userå­—æ®µå¼€å…³ï¼Œfalseï¼šè¿”å›å®Œæ•´userå­—æ®µã€trueï¼šuserå­—æ®µä»…è¿”å›user_idï¼Œé»˜è®¤ä¸ºfalseã€‚ * @param listener å¼‚æ­¥è¯·æ±‚å›è°ƒæ¥å£ */public void friendsTimeline(long since_id, long max_id, int count, int page, boolean base_app, int featureType, boolean trim_user, RequestListener listener) &#123; WeiboParameters params = buildTimeLineParamsBase(since_id, max_id, count, page, base_app, trim_user, featureType); requestAsync(sAPIList.get(READ_API_FRIENDS_TIMELINE), params, HTTPMETHOD_GET, listener);&#125; åœ¨Androidé¡¹ç›®æ–‡ä»¶å¤¹ä¸‹æ·»åŠ äº†å¾®åšæ¨¡å—ï¼šandroid/app/src/main/java/com/welone/weibo/WeiboModule.javaã€‚å®ç°äº†å¦‚ä¸‹å‡½æ•°ï¼š 123456789101112131415161718192021222324252627282930313233343536/** * get the status of your friends * * @param sinceId * @param maxId * @param successCallback * @param errorCallback */ @ReactMethod public void getTimeline(String sinceId, String maxId, Callback successCallback, Callback errorCallback) &#123; //è·å–è®¤è¯token Oauth2AccessToken token = AccessTokenKeeper.getAccessToken(); if (token != null &amp;&amp; token.isSessionValid()) &#123; if (mStatusesAPI == null) &#123; mStatusesAPI = new StatusesAPI(getCurrentActivity(), Constants.APP_KEY, token); &#125; try &#123; long since = Long.parseLong(sinceId); long max = Long.parseLong(maxId); //è°ƒç”¨äº†friendsTimelineçš„åŒæ­¥ç‰ˆæœ¬ï¼Œå› ä¸ºè¯¥å‡½æ•°å·²ç»æ˜¯å¼‚æ­¥è°ƒç”¨, //æ²¡å¿…è¦å†åµŒå¥—ä¸€æ¬¡å¼‚æ­¥è°ƒç”¨ String info = mStatusesAPI.friendsTimelineSync(since, max, 20, 1, false, 0, false); if (info != null &amp;&amp; info.length() &gt; 0) &#123; //è·å–å†…å®¹æˆåŠŸ successCallback.invoke(info); &#125; else &#123; //è·å–å†…å®¹å¤±è´¥ errorCallback.invoke(\"Get weibo error..\"); &#125; &#125; catch (com.sina.weibo.sdk.exception.WeiboException e) &#123; errorCallback.invoke(\"Please open the Internet :)\"); &#125; &#125; else &#123; errorCallback.invoke(\"Get user information: token error..\"); &#125; &#125; å…¶ä¸­@ReactMethodæ ‡ç­¾æŒ‡æ˜è¯¥å‡½æ•°ä¸ºä¸€ä¸ªreact-nativeå‡½æ•°ï¼Œå°†ä¼šæš´éœ²åœ¨jséƒ¨åˆ†ä½¿ç”¨ã€‚è®¾è®¡å¥½å‡½æ•°æ¥å£ï¼Œéœ€è¦è®²æ¨¡å—æ·»åŠ åˆ°åº”ç”¨åŒ…é‡Œé¢ã€‚ åœ¨android/app/src/main/java/com/welone/weibo/WeiboPackage.javaä¸­ï¼Œåˆ›å»ºä¸€ä¸ªReactPackageï¼š 12345678910111213141516171819202122public class WeiboPackage implements ReactPackage &#123; //æ·»åŠ è‡ªå·±å®šåˆ¶çš„åŸç”ŸåŠŸèƒ½æ¨¡å— @Override public List&lt;NativeModule&gt; createNativeModules(ReactApplicationContext reactContext) &#123; List&lt;NativeModule&gt; modules = new ArrayList&lt;&gt;(); //è¿™é‡Œç›®å‰å°±ä¸€ä¸ªweiboæ¨¡å— modules.add(new WeiboModule(reactContext)); return modules; &#125; //å¯ä»¥æ·»åŠ jsæ¨¡å—åœ¨åŸç”Ÿä»£ç ä¸­ä½¿ç”¨ @Override public List&lt;Class&lt;? extends JavaScriptModule&gt;&gt; createJSModules() &#123; return Collections.emptyList(); &#125; //å®šåˆ¶åŸç”Ÿviewæä¾›ç»™jséƒ¨åˆ†ä½¿ç”¨ @Override public List&lt;ViewManager&gt; createViewManagers(ReactApplicationContext reactContext) &#123; return Collections.emptyList(); &#125;&#125; ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œreact-nativeä¸ä»…å¯ä»¥å®šåˆ¶åŠŸèƒ½æ¨¡å—ï¼Œè¿˜å¯ä»¥å®šåˆ¶åŸç”Ÿviewç»™jsä½¿ç”¨ã€‚ åœ¨android/app/src/main/java/com/welone/MainApplication.javaä¸‹æ·»åŠ ReactPackageï¼š 123456789101112131415161718private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) &#123; @Override protected boolean getUseDeveloperSupport() &#123; return BuildConfig.DEBUG; &#125; @Override protected List&lt;ReactPackage&gt; getPackages() &#123; return Arrays.&lt;ReactPackage&gt;asList( //react-nativeè‡ªå·±çš„åŒ… new MainReactPackage(), //å› ä¸ºä½¿ç”¨native-baseå¼•å…¥çš„åŒ… new VectorIconsPackage(), //è‡ªå·±å®šä¹‰çš„å¾®åšåŒ… new WeiboPackage() ); &#125;&#125;; å†™å¥½åŸç”Ÿéƒ¨åˆ†çš„æ¨¡å—ï¼Œæ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•åœ¨jséƒ¨åˆ†è¿›è¡Œä½¿ç”¨ã€‚é¦–å…ˆåˆ›å»ºæ–‡ä»¶app/comp/module/WeiboModule.android.jsï¼Œå°†å®šä¹‰çš„æ¨¡å—å¼•å…¥å¹¶ä¸”æš´éœ²ã€‚ 12345'use strict';import &#123; NativeModules &#125; from 'react-native';export default NativeModules.WeiboModule; åœ¨WeiboListæ¨¡å—è°ƒç”¨getTimelineå‡½æ•°ï¼š 12345678910111213141516171819202122232425262728293031323334//Get the weibo of the user's friendsgetTimeLine(type) &#123; let since = 0; let max = 0; //è°ƒç”¨åŸç”Ÿæ¨¡å—å®ç°çš„å‡½æ•°ï¼Œå‚æ•°è¦ä¸€ä¸€å¯¹åº” WeiboModule.getTimeline( since.toString(), max.toString(), //æˆåŠŸçš„å›è°ƒå‡½æ•° (success) =&gt; &#123; if (success.length &gt; 0) &#123; let tl = JSON.parse(success); let statuses = tl.statuses; if (statuses.length &gt; 0) &#123; //è·å–å†…å®¹æ•°ç»„ this.loveData = statuses; ToastAndroid.showWithGravity(`æœ‰$&#123;statuses.length&#125;æ¡æ–°å¾®åš :)`, ToastAndroid.SHORT, ToastAndroid.CENTER); //æ›´æ–°åˆ—è¡¨ this.setState(&#123; loveSource: this.state.loveSource.cloneWithRows(this.loveData) &#125;); &#125; &#125; &#125;, //å¤±è´¥çš„å›è°ƒå‡½æ•° (err) =&gt; &#123; ToastAndroid.showWithGravity(err, ToastAndroid.SHORT, ToastAndroid.CENTER); this.gettingTimeLine = false; &#125; );&#125; å®ç°getTimeLineå‡½æ•°åå¯ä»¥åœ¨é€‚å½“çš„åœ°æ–¹è°ƒç”¨ï¼Œè·å–å¾®åšå†…å®¹ã€‚ åˆ°æ­¤ä¸ºæ­¢ï¼Œå®ç°äº†åº”ç”¨è·å–å¾®åšå†…å®¹ï¼Œå¹¶ä¸”è¿›è¡Œæ˜¾ç¤ºçš„åŠŸèƒ½ã€‚å…¶å®ƒåŠŸèƒ½ï¼Œæ¯”å¦‚è·å–è¯„è®ºç­‰ï¼Œå®ç°è¿‡ç¨‹ç±»ä¼¼ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"},{"name":"React Native","slug":"React-Native","permalink":"http://itanch.github.io/tags/React-Native/"}]},{"title":"2017ä¹¦å•","date":"2017-04-07T06:56:08.000Z","path":"2017/04/07/2017ä¹¦å•/","text":"ä¹¦ç±æ˜¯äººç±»é€€æ­¥çš„æ»‘æ»‘æ¢¯ 1. æ— å£°å‘Š ğŸŠ ç»“æŸæ—¶é—´ï¼š01-05 æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ æˆä¸ºè‡ªå·±ï¼Œè¿˜æ˜¯æˆä¸ºåˆ«äººæœŸæœ›çš„è‡ªå·±ï¼Ÿ 2. æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº â˜•ï¸ ç»“æŸæ—¶é—´ï¼š01-29 æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ äº†è§£jvmçš„è®¾è®¡åŸç†ã€‚ 3. æ·±å…¥æµ…å‡ºnodejs ğŸš€ ç»“æŸæ—¶é—´ï¼š02-15 æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ äº†è§£nodejsçš„è®¾è®¡åŸç†ã€‚ 4. Androidç¼–ç¨‹æƒå¨æŒ‡å— â›³ ç»“æŸæ—¶é—´ï¼š03-26 æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ ä»å…·ä½“çš„é¡¹ç›®å­¦ä¹ Androidå¼€å‘ä¸­çš„ç»„ä»¶ä½¿ç”¨æŠ€å·§ã€‚ 5. ç¨‹åºå‘˜é¢è¯•é‡‘å…¸ ğŸ€„ï¸ ç»“æŸæ—¶é—´ï¼š04-07 æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ å¾ˆç»å…¸çš„é¢è¯•æŒ‡å—ï¼Œå¯¹ç»å…¸çš„ç®—æ³•è€ƒé¢˜è¿›è¡Œäº†å±‚å±‚æ·±å…¥çš„è§£æã€‚","tags":[{"name":"è®°å½•","slug":"è®°å½•","permalink":"http://itanch.github.io/tags/è®°å½•/"}]},{"title":"ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯(1)","date":"2017-04-06T12:01:14.000Z","path":"2017/04/06/ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯-1/","text":"ç”¨React-NativeæŠ€æœ¯å®ç°ä¸€ä¸ªç®€å•çš„å¾®åšå®¢æˆ·ç«¯ã€‚é¡¹ç›®å¼€æºåœ°å€ï¼šgithubã€‚é¡¹ç›®è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ğŸ˜Šã€‚ å¼€å‘ç¯å¢ƒï¼šmacOS éƒ¨åˆ†æ•ˆæœï¼š å®‰è£…å¦‚ä½•å®‰è£…å®˜ç½‘å¾ˆæ¸…æ¥šï¼Œå¦‚æœç½‘é¡µæ‰“ä¸å¼€å¯ä»¥å‚è€ƒå›½å†…æ–‡æ¡£ã€‚ é¦–å…ˆå®‰è£…nodeå’Œwatchmanã€‚ 12brew install node brew install watchman ç„¶åå®‰è£…react native cliã€‚ 1npm install -g react-native-cli å®‰è£…Androidå¼€å‘ç¯å¢ƒå°±ä¸å†èµ˜è¿°ã€‚ åˆ›å»ºé¡¹ç›®ã€è¿è¡Œé¡¹ç›®ã€‚ 123react-native init AwesomeProject cd AwesomeProject react-native run-android è¿™æ ·å¯ä»¥ç›´æ¥å°†åº”ç”¨åœ¨æ‰‹æœºä¸Šè¿è¡Œèµ·æ¥ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ™ƒåŠ¨æ‰‹æœºï¼ˆğŸ˜“ï¼‰æ¥å”¤å‡ºå‘½ä»¤ç•Œé¢ï¼Œè¿›è¡ŒåŠ¨æ€çš„æ›´æ–°jså®ç°çš„åŠŸèƒ½ã€‚ä½†æ˜¯è¿™æ ·çš„è¿è¡Œçš„åº”ç”¨æ€§èƒ½å¹¶ä¸é«˜ï¼Œä»…ä»…é€‚ç”¨äºè°ƒè¯•ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦æ‰“åŒ…è¿›è¡Œå‘å¸ƒã€‚ æ‰“åŒ…å‘å¸ƒç”Ÿæˆç­¾åå¯†é’¥ã€‚ 12345678910111213keytool -genkey -v -keystore my-release-key.keystore -alias tianchi -keyalg RSA -keysize 2048 -validity 10000``` `-alias`åçš„å‚æ•°ä½ å¯ä»¥èµ·ä¸ªå¥½å¬çš„åå­—ï¼Œæ¯”å¦‚â€œtianchiâ€ã€‚è¿™é‡Œè®¾ç½®äº†10000å¤©çš„æœ‰æ•ˆæœŸã€‚ è®¾ç½®gradleå˜é‡ã€‚å¤šè°¢è¿™äº›æˆç†Ÿçš„æ„å»ºå·¥å…·å’Œæ¡†æ¶ï¼Œreact-nativeåœ¨åˆ›å»ºandroidé¡¹ç›®æ—¶å·²ç»å¸®ä½ ç”Ÿæˆäº†ä¸€ä¸ªå¾ˆå®Œå–„çš„gradleé…ç½®æ–‡ä»¶ï¼Œä¸‹é¢éœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹æ¥æ»¡è¶³è‡ªå·±çš„å®šåˆ¶éœ€æ±‚ã€‚æŠŠç”Ÿæˆçš„`my-release-key.keystore`æ–‡ä»¶æ”¾åˆ°`android/app`ä¸‹é¢ï¼Œç„¶ååœ¨ç”¨æˆ·Homeä¸‹åˆ›å»ºå¹¶ä¸”ç¼–è¾‘`~/.gradle/gradle.properties`æ–‡ä»¶ï¼š```shMYAPP_RELEASE_STORE_FILE=my-release-key.keystoreMYAPP_RELEASE_KEY_ALIAS=tianchiMYAPP_RELEASE_STORE_PASSWORD=******MYAPP_RELEASE_KEY_PASSWORD=****** æ·»åŠ ç­¾åæ–‡ä»¶åˆ°android/app/build.gradleï¼š 12345678910111213141516//Attention!!! You shuld use your own release key!!!signingConfigs &#123; release &#123; storeFile file(MYAPP_RELEASE_STORE_FILE) storePassword MYAPP_RELEASE_STORE_PASSWORD keyAlias MYAPP_RELEASE_KEY_ALIAS keyPassword MYAPP_RELEASE_KEY_PASSWORD &#125;&#125;buildTypes &#123; release &#123; ... signingConfig signingConfigs.release &#125;&#125; æ··æ·†å‹ç¼©apkã€‚åœ¨android/app/build.gradleæ–‡ä»¶ä¸­ï¼Œä¿®æ”¹ï¼š 12//Run Proguard to shrink the Java bytecode in release builds.def enableProguardInReleaseBuilds = true æ‰“åŒ…å’Œå®‰è£…ã€‚12./gradlew assembleRelease./gradlew installRelease å¼•å…¥å¾®åšapiè¿›å…¥å¾®åšå¼€å‘å¹³å°ï¼Œç”³è¯·ä¸€ä¸ªå¼€å‘è€…è´¦å·ï¼Œåˆ›å»ºä¸€ä¸ªç§»åŠ¨åº”ç”¨ï¼Œå…³é”®æ˜¯å¾—åˆ°ä¸€ä¸ªapp keyã€‚ç„¶åç ”ç©¶weiboæä¾›çš„android sdkæ–‡æ¡£ã€‚ è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¦æƒ³æˆåŠŸä½¿ç”¨å¾®åšçš„apiï¼Œä½ é¦–å…ˆè¦åœ¨å¾®åšå¼€å‘å¹³å°&gt;åº”ç”¨ä¿¡æ¯&gt;æµ‹è¯•ä¿¡æ¯ä¸­å¡«å†™ä½ çš„æµ‹è¯•è´¦å·ï¼Œå¦åˆ™æ— æ³•ç™»é™†ã€‚åŒæ—¶ï¼Œå°†ä½ çš„å¼€å‘çš„appå®‰è£…åˆ°æ‰‹æœºä¸Šï¼Œç”¨å¾®åšæä¾›çš„app_signatures.apkè·å¾—è¯¥åº”ç”¨çš„Androidç­¾åï¼Œç„¶åå¡«å†™åˆ°å¾®åšå¼€å‘å¹³å°&gt;åº”ç”¨ä¿¡æ¯&gt;åŸºæœ¬ä¿¡æ¯ä¸­çš„AndroidåŒ…åï¼šcom.weloneå’ŒAndroidç­¾å:xxxxä½ è·å¾—çš„ç­¾åxxxxxxxã€‚å®Œæˆä»¥ä¸Šä¸¤ä¸ªæ­¥éª¤æ‰èƒ½æ­£å¸¸ä½¿ç”¨å¾®åšçš„apiï¼Œå‘µå‘µã€‚ ä¸‹é¢éœ€è¦é€šè¿‡gradleå¼•å…¥å¾®åšçš„apiï¼Œå®˜ç½‘æœ€è¿‘ç‰ˆæœ¬å·²ç»æä¾›äº†gradleçš„å¼•å…¥æ–¹å¼ï¼Œä½†æ˜¯ç§»é™¤äº†open apiçš„åŠŸèƒ½ã€‚å› ä¸ºæˆ‘æ˜¯ç”¨çš„æ˜¯æ—§çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä½¿ç”¨äº†open apiï¼Œæ‰€ä»¥å¼•å…¥äº†ä¸€ä¸ªå…¶ä»–å¼€å‘è€…æä¾›çš„å¾®åšapiä»“åº“ã€‚åœ¨android/app/build.gradleä¸­ä¿®æ”¹å¦‚ä¸‹ï¼š 123456789101112repositories &#123; jcenter() maven &#123; url \"https://jitpack.io\" &#125;&#125;//...dependencies &#123; //... compile 'com.github.8tory:weibo-android-sdk:-SNAPSHOT'&#125; åœ¨æ„å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨çš„ä¸‹è½½è¯¥åº“è¿›è¡Œç¼–è¯‘ã€‚ è®©ä½ çš„UIæ›´å¥½çœ‹ä½¿ç”¨react-nativeæä¾›çš„componentæ¯”è¾ƒæœ´ç´ ï¼Œå½“ç„¶è‡ªå·±å¯ä»¥é€šè¿‡è°ƒåˆ¶åˆ›å»ºå‡ºæ¼‚äº®çš„ç»„å»ºã€‚è¿™é‡Œï¼Œæœ‰NativeBaseå·²ç»å¸®æˆ‘ä»¬åˆ›å»ºå¥½äº†ï¼Œå®˜ç½‘æä¾›äº†å¾ˆè¯¦ç»†çš„å®‰è£…æ•™ç¨‹ï¼Œè¿™é‡Œå…ˆå®‰è£…å¥½ï¼Œæˆ‘ä»¬å°†æ¥è¦ä½¿ç”¨ã€‚å…¶ä¸­react-native-vector-iconsç»„ä»¶éœ€è¦ç‰¹æ®Šçš„é…ç½®ä¸€ä¸‹ã€‚ è¿™é‡Œä¸»è¦ä»‹ç»äº†å¼€å§‹ç¼–å†™ä¸€ä¸ªreact-nativeçš„å¾®åšå®¢æˆ·ç«¯çš„å‡†å¤‡å·¥ä½œï¼Œä¸‹é¢ä¸€ç« å°†ä¼šè¯¦ç»†ä»‹ç»ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"},{"name":"React Native","slug":"React-Native","permalink":"http://itanch.github.io/tags/React-Native/"}]},{"title":"23ä¸ªè®¾è®¡æ¨¡å¼","date":"2017-02-15T06:10:00.000Z","path":"2017/02/15/32ä¸ªè®¾è®¡æ¨¡å¼/","text":"æœ¬ç¯‡æ–‡ç« æ˜¯å¯¹Design Patterns: Elements of Reusable Object-Oriented Softwareçš„æ€»ç»“ã€‚ çœ‹å®ŒDesign Patterns: Elements of Reusable Object-Oriented Softwareå·²ç»æœ‰äº›æ—¶æ—¥äº†ï¼Œç°åœ¨æç¬”å°†å…¶æ¦‚æ‹¬æ€»ç»“ä¸€ä¸‹ï¼Œä»¥å¤‡å°†æ¥çš„å‚è€ƒã€‚æ­¤ä¹¦æ€»ç»“äº†23ä¸­ä¸åŒçš„è®¾è®¡æ¨¡å¼ï¼Œå¹¶ä¸”å°†å®ƒä»¬çš„è®¾è®¡ç›®çš„ã€ç»“æ„ã€ç”¨æ³•ç­‰æ–¹é¢è¿›è¡Œçš„å¾ˆå¥½çš„ä»‹ç»ï¼Œæ˜¯ä¸€æœ¬å€¼å¾—æ”¾åœ¨æ‰‹è¾¹éšæ—¶æŸ¥é˜…çš„å·¥å…·ä¹¦ã€‚ Creational Patterns 1. Abstract Factoryç›®çš„ä¸ºåˆ›å»ºä¸€ç»„ç›¸å…³å¯¹è±¡ï¼ŒAbstract Factoryæä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œå¹¶ä¸”ä¸éœ€è¦æŒ‡å®šå®ƒä»¬å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„ã€‚Abstract Factoryæ˜¯å’ŒConcrete Factoryï¼ˆç®€ç§°Factoryï¼‰ç›¸å¯¹çš„ä¸€ä¸ªæ¨¡å¼ï¼ŒFactoryçš„åŠŸèƒ½æ˜¯åˆ›å»ºç›¸å…³çš„ä¸€ç»„å¯¹è±¡ï¼Œå®ƒæ˜¯å…·ä½“çš„ã€‚è€ŒAbstract Factoryåˆ™æ˜¯ä»…ä»…æä¾›æ¥å£ï¼Œå…·ä½“å¦‚ä½•åˆ›å»ºã€åˆ›å»ºä»€ä¹ˆç±»å‹çš„å¯¹è±¡ç”±å­ç±»Factoryæ¥å…·ä½“å®ç°ã€‚ä¹Ÿå«Kitã€‚ ç»“æ„ AbstractFactory: å£°æ˜äº†åˆ›å»ºå…·ä½“äº§å“å¯¹è±¡çš„æ¥å£ã€‚ConcreteFactory: å®ç°äº†åˆ›å»ºå…·ä½“äº§å“å¯¹è±¡çš„å‡½æ•°ã€‚AbstractProduct: å£°æ˜äº†æŸä¸€ç§äº§å“å¯¹è±¡çš„æ¥å£ã€‚ConcreteProduct: å®šä¹‰äº†å…·ä½“è¢«åˆ›å»ºçš„ä¸€ä¸ªäº§å“å¯¹è±¡ã€‚å®ç°äº†AbstractProductçš„æ¥å£ã€‚Client: ä»…ä»…è°ƒç”¨AbstractFactoryåˆ›å»ºäº§å“ï¼Œå¹¶ä¸”ä½¿ç”¨AbstractProductçš„æ¥å£ã€‚ç”¨æˆ·æ— éœ€å…³å¿ƒå…·ä½“ä½¿ç”¨äº†å“ªä¸€ä¸ªFactoryå’ŒProductã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ä¸ªç³»ç»Ÿéœ€è¦å’Œå®ƒçš„äº§å“çš„åˆ›å»ºã€ç»„æˆã€è¡¨ç¤ºç›¸äº’ç‹¬ç«‹æ—¶ã€‚ ä¸€ä¸ªç³»ç»Ÿéœ€è¦é…ç½®å¤šç§äº§å“å®¶æ—ä¸­çš„ä¸€ä¸ªæ—¶ã€‚å¦‚ç»“æ„å›¾ä¸­æ‰€ç¤ºï¼Œæœ‰1å’Œ2ä¸¤ä¸ªäº§å“å®¶æ—ï¼Œclientåªéœ€è¦é…ç½®å…¶ä¸­çš„ä¸€ä¸ªå³å¯ï¼Œå¦‚æœé…ç½®äº†1ï¼Œåˆ™clientä½¿ç”¨çš„æ‰€æœ‰productéƒ½æ˜¯1ç±»å‹çš„ï¼Œæœ‰ProductA1ã€ProductB1ç­‰ã€‚ ä¸€æ—ç›¸å…³è”çš„äº§å“éœ€è¦ä¸€èµ·è¢«ä½¿ç”¨ï¼Œä¸å¯æ··ç”¨ï¼Œä½ å¯ä»¥é€šè¿‡Abstract Factoryæ¥åŠ å¼ºè¿™ç§é™åˆ¶ã€‚clientå¦‚æœé€‰æ‹©ä½¿ç”¨äº†1ï¼Œåˆ™åº”è¯¥ä¿è¯æ‰€æœ‰çš„äº§å“éƒ½æ˜¯1å®¶æ—çš„äº§å“ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªåº”ç”¨çš„UIæ”¯æŒwindowså’Œmacä¸¤ç§é£æ ¼ï¼Œç”¨æˆ·é€‰æ‹©äº†windowsé£æ ¼çš„UIï¼Œåˆ™åº”è¯¥ä¿è¯æ‰€æœ‰çš„æŒ‰é’®ã€èœå•å’Œè¾¹æ ç­‰éƒ½æ˜¯windowsé£æ ¼ã€‚ ä½ æƒ³æä¾›ä¸€ä¸ªproductçš„åº“ï¼ŒåŒæ—¶ä½ åªæƒ³æš´éœ²å®ƒä»¬çš„æ¥å£ï¼Œè€Œä¸æ˜¯å¦‚ä½•å®ç°çš„ã€‚ 2. Builderç›®çš„å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºå’Œè¡¨ç¤ºç›¸åˆ†ç¦»ï¼Œä»è€Œå¯ä»¥ä½¿å¾—ç›¸åŒçš„æ„å»ºè¿‡ç¨‹åˆ›é€ å‡ºä¸åŒçš„è¡¨ç¤ºã€‚ ç»“æ„ Builder: å£°æ˜äº†ä¸€ä¸ªåˆ›å»ºä¸€ä¸ªäº§å“å¯¹è±¡ä¸€éƒ¨åˆ†çš„æŠ½è±¡æ¥å£ã€‚ConcreteBuilder: å®ç°Builderå®šä¹‰çš„æ¥å£ï¼Œå¯ä»¥åˆ›å»ºå’Œç»„è£…äº§å“çš„ä¸€éƒ¨åˆ†ã€‚å®šä¹‰å¹¶ä¸”ä¿å­˜äº†å®ƒæ‰€åˆ›å»ºäº§å“çš„å½“å‰è¡¨ç¤ºã€‚åŒæ—¶ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ä¸ªå¯ä»¥è·å¾—æ‰€åˆ›å»ºäº§å“çš„æ¥å£ã€‚Director: ä½¿ç”¨Builderçš„æä¾›çš„æ¥å£åˆ›å»ºäº§å“å¯¹è±¡ã€‚Product:è¡¨ç¤ºæ­£åœ¨è¢«åˆ›å»ºçš„ä¸€ä¸ªå¤æ‚å¯¹è±¡ã€‚ConcreteBuilderå»ºé€ äº†å®ƒçš„å†…éƒ¨è¡¨ç¤ºï¼Œå†³å®šäº†å®ƒç»„è£…çš„è¿‡ç¨‹ã€‚å®ƒåŒ…å«äº†å®šä¹‰å®ƒç»„æˆéƒ¨åˆ†çš„ç±»ï¼ŒåŒæ—¶æä¾›äº†æ¥å£è®©å…·ä½“Builderæ¥ç»„è£…è¿™äº›ç»„æˆéƒ¨åˆ†ã€‚ ä½•æ—¶ä½¿ç”¨ åˆ›å»ºä¸€ä¸ªå¤æ‚å¯¹è±¡çš„ç®—æ³•éœ€è¦ç‹¬ç«‹äºå¯¹è±¡çš„ç»„æˆéƒ¨åˆ†çš„å®šä¹‰å’Œç»„è£…æ–¹å¼ã€‚å¦‚Directorä¸­å®ç°äº†ä¸€ä¸ªåˆ›å»ºäº§å“å¯¹è±¡çš„ç®—æ³•ï¼Œè€Œå¯¹è±¡å†…éƒ¨å¦‚ä½•ç»„è£…çš„åˆ™ç”±Builderå†³å®šã€‚ ä¸€ä¸ªåˆ›å»ºè¿‡ç¨‹å¯ä»¥äº§ç”Ÿä¸åŒçš„å¯¹è±¡è¡¨ç¤ºã€‚æ¯”å¦‚ï¼ŒDirectorå¯ä»¥é‡‡ç”¨ä¸åŒçš„ConcreteBuilderæ¥åˆ›å»ºäº§å“å¯¹è±¡ï¼Œåœ¨Directorä¸­åˆ›å»ºçš„è¿‡ç¨‹æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯ç”±äºBuilderçš„ä¸åŒï¼Œå¯¼è‡´æœ€åäº§å“çš„å†…éƒ¨ç»“æ„å¯èƒ½å·®å¼‚å¾ˆå¤§ã€‚ 3. Factory Methodç›®çš„å®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œç”±å­ç±»å»å†³å®šåˆ›å»ºå“ªä¸€ä¸ªå…·ä½“çš„å¯¹è±¡ã€‚Factory Methodå¯ä»¥å°†å®ä¾‹åŒ–å¯¹è±¡çš„è¿‡ç¨‹å§”æ´¾ç»™å­ç±»ã€‚æ³¨æ„ï¼Œè¿™é‡ŒFactory Methodå¼ºè°ƒçš„æ˜¯æ–¹æ³•ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ææœ‰å¯èƒ½ä¼šè¢«å­ç±»è¦†ç›–ã€‚åœ¨Abstract Factoryä¸­å°±ä½¿ç”¨äº†Factory Methodæ¥åˆ›å»ºäº§å“ã€‚ ç»“æ„ Product: å®šä¹‰äº†Factory methodåˆ›å»ºçš„å¯¹è±¡çš„æ¥å£ã€‚ConcreteProduct: å®ç°äº†Productçš„æ¥å£ã€‚Creator:å®šä¹‰äº†Factory Method,factory methodä¼šåˆ›å»ºæŸä¸€ä¸ªç±»å‹çš„äº§å“ã€‚å®ƒæœ‰å¯èƒ½å®šä¹‰ä¸€ä¸ªé»˜è®¤çš„factory methodæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå…·ä½“çš„äº§å“ã€‚ConcreteCreator: é‡å†™factory methodæ¥å®ä¾‹åŒ–ä¸€ä¸ªConcreteProductã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ä¸ªç±»ä¸èƒ½é¢„æ–™å®ƒå¿…é¡»åˆ›å»ºçš„å¯¹è±¡å±äºå“ªä¸€ç±»ã€‚ ä¸€ä¸ªç±»å¸Œæœ›å®ƒçš„å­ç±»æ¥å†³å®šéœ€è¦åˆ›å»ºçš„å¯¹è±¡ã€‚ ä¸€ä¸ªç±»å°†è´£ä»»å§”æ´¾ç»™å®ƒçš„ä¸€ä¸ªå­ç±»ï¼Œä½ å¸Œæœ›å°†å“ªä¸€ä¸ªç±»è¢«å§”æ´¾çš„çŸ¥è¯†æœ¬åœ°åŒ–ã€‚ 4. Prototypeç›®çš„é€šè¿‡ä¸€ä¸ªåŸå‹å®ä¾‹æ¥åˆ›å»ºä¸€ç±»çš„å¯¹è±¡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡çš„è¿‡ç¨‹å°±æ˜¯æ‹·è´åŸå‹å®ä¾‹ã€‚è¿™æ ·åšå¯ä»¥çœå»ä¼ å…¥å‚æ•°æ¥åˆ›å»ºå¯¹è±¡çš„éº»çƒ¦ï¼Œä¿è¯æ¯æ¬¡åˆ›å»ºçš„å¯¹è±¡éƒ½å…·æœ‰ç›¸åŒçš„å±æ€§ã€‚å³ä½¿éœ€è¦ç›¸åŒç±»çš„ä¸åŒå±æ€§çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å…ˆè¿›è¡Œæ‹·è´ï¼Œç„¶åé€šè¿‡ç¨åŠ ä¿®æ”¹ï¼Œå°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å¯¹è±¡ã€‚ åœ¨Nodejsä¸­æœ‰prototypeçš„ä½¿ç”¨ã€‚ ç»“æ„ Prototype: å®šä¹‰äº†ä¸€ä¸ªæ¥æ‹·è´è‡ªå·±çš„æ¥å£ã€‚ConretePrototype: å®ç°äº†å…‹éš†è‡ªå·±çš„æ“ä½œã€‚Client: è®©Prototypeå…‹éš†è‡ªå·±æ¥åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚ ä½•æ—¶ä½¿ç”¨ ç³»ç»Ÿéœ€è¦ç‹¬ç«‹äºå®ƒçš„äº§å“å¦‚ä½•åˆ›å»ºã€ç»„æˆå’Œè¡¨ç¤ºçš„æ—¶å€™ã€‚ å½“éœ€è¦å®ä¾‹åŒ–çš„ç±»åœ¨è¿è¡Œæ‰å†³å®šæ—¶ã€‚ æƒ³è¦é¿å…åˆ›å»ºä¸€ä¸ªå¹³è¡Œäºäº§å“ç±»å±‚æ¬¡ç»“æ„çš„factoryå±‚æ¬¡ç»“æ„ã€‚å› ä¸ºåˆ›å»ºä¸€ä¸ªå¯¹è±¡åªéœ€è¦é€šè¿‡åŸå‹æ‹·è´ï¼Œæ— éœ€ä½¿ç”¨factoryæ¥åˆ›å»ºã€‚ å½“ä¸€ä¸ªç±»çš„å®ä¾‹åªæœ‰ä¸ºæ•°ä¸å¤šçš„å‡ ä¸ªçŠ¶æ€ç»„åˆä¸­çš„ä¸€ä¸ªæ—¶ï¼Œå¯ä»¥å…ˆå®ä¾‹å¥½å‡ ä¸ªä¸åŒçŠ¶æ€çš„å¯¹è±¡ï¼Œæ¯æ¬¡åªéœ€è¦ä»è¿™äº›åŸå‹å¯¹è±¡ä¸­æŒ‰éœ€æ‹·è´å‡ºæ¥æ–°å¯¹è±¡å³å¯ã€‚ 5. Singletonç›®çš„ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªå¯ä»¥è®¿é—®å®ƒçš„å…¨å±€åˆ‡å…¥ç‚¹ã€‚ åœ¨Androidç³»ç»Ÿä¸­çš„ActivityManagerServiceå°±æ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼ã€‚ ç»“æ„ Singleton: å®šä¹‰ä¸€ä¸ªå®ä¾‹åŒ–å‡½æ•°ï¼Œå¯ä»¥è®©ç”¨æˆ·é€šè¿‡è¯¥å‡½æ•°è·å–è¯¥ç‹¬ä¸€æ— äºŒçš„å®ä¾‹ã€‚Instranceæ˜¯ä¸€ä¸ªç±»å‡½æ•°ã€‚æœ‰äº›æ—¶å€™ï¼Œå®ƒè¿˜è¦è´Ÿè´£åˆ›å»ºå®ƒç‹¬ä¸€æ— äºŒçš„å®ä¾‹ã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡æ—¶ï¼Œå¹¶ä¸”éœ€è¦æä¾›ä¸€ä¸ªå…¬å…±æ¥å£ç»™ç”¨æˆ·è®¿é—®è¯¥ç‹¬ä¸€æ— äºŒçš„å®ä¾‹ã€‚ è¿™ä¸ªå­¤ç«‹çš„å®ä¾‹å¯¹è±¡å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥æ‰©å±•ï¼Œå¹¶ä¸”ç”¨æˆ·å¯ä»¥æ— éœ€ä¿®æ”¹åŸæ¥çš„ä»£ç æ¥ä½¿ç”¨è¯¥æ‰©å±•çš„å®ä¾‹ã€‚ Structural Patterns6. Adapterç›®çš„å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬åŒ–ä¸ºç”¨æˆ·æƒ³è¦çš„æ¥å£å½¢å¼ã€‚Adapterå¯ä»¥è®©åŸæ¥æ¥å£ä¸ç›¸åŒ¹é…çš„ç±»è¿›è¡Œåˆä½œã€‚ä¹Ÿå«Wrapperã€‚ ç»“æ„Adapterä½¿ç”¨å¤šç»§æ‰¿æ¥å®ç°æ¥å£çš„é€‚é…ã€‚ Adapteré€šè¿‡ç»„åˆæ¥å®ç°ç»“æ„çš„åŒ¹é…ã€‚ Target: å®šä¹‰äº†ç”¨æˆ·æƒ³è¦ä½¿ç”¨çš„æ¥å£ã€‚Client: è°ƒç”¨ç›®æ ‡æ¥å£æ¥ä½¿ç”¨æŸäº›å¯¹è±¡ã€‚Adaptee: å®ç°äº†clientæƒ³è¦çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ¥å£å¹¶ä¸æ˜¯clientæƒ³è¦çš„ï¼Œæ‰€ä»¥è¦è¿›è¡Œé€‚é…ã€‚Adapter: å°†Adapteeçš„æ¥å£é€‚é…æˆç›®æ ‡æ¥å£ã€‚ ä½•æ—¶ä½¿ç”¨ ä½ æƒ³ä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„ç±»ï¼Œä½†æ˜¯å®ƒçš„æ¥å£å’Œä½ éœ€è¦çš„ä¸å¤ªåŒ¹é…ã€‚ ä½ æƒ³å®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ƒå¯ä»¥å’Œä¸ç›¸å…³ã€ä¸å¯é¢„è§çš„å…¶å®ƒç±»è¿›è¡Œé…åˆä½¿ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ä½ å®šä¹‰çš„ç±»æ²¡å¿…è¦é€‚é…æ‰€æœ‰çš„æƒ…å†µï¼Œæ ¹æ®å…·ä½“æƒ…å†µé…ç½®é€‚å½“çš„adapterå°±å¯ä»¥äº†ã€‚ ä½ éœ€è¦ä½¿ç”¨å¾ˆå¤šç°æˆçš„å­ç±»ï¼Œä½†æ˜¯é€šè¿‡ç»§æ‰¿ç±»ä¿®æ”¹æ¯ä¸€ä¸ªå­ç±»çš„æ¥å£æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œè¿™æ—¶å€™ä½ å¯ä»¥ä»…ä»…åˆ©ç”¨adapteré€‚é…å®ƒä»¬çš„çˆ¶ç±»å³å¯ã€‚ 7. Bridgeç›®çš„å°†ä¸€ä¸ªç±»çš„æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°è¿›è¡Œè§£è€¦ï¼Œä»è€Œå¯ä»¥ä½¿å¾—è¿™ä¸¤ä¸ªéƒ¨åˆ†ç‹¬ç«‹å˜åŒ–ã€‚ä¹Ÿå«åšHandle/Bodyã€‚Bridgeå’ŒAdapteréƒ½æœ‰ç»™ç”¨æˆ·æä¾›é€‚é…çš„æ¥å£çš„ä½œç”¨ï¼Œä½†æ˜¯Adapteræ›´å¼ºè°ƒè®©åŸæ¥ä¸ç›¸å¹²çš„ç±»è¿›è¡Œåˆä½œï¼Œå¾€å¾€ç±»å·²ç»è®¾è®¡å¥½äº†ã€‚è€ŒBridgeåœ¨è®¾è®¡ä¹‹åˆï¼Œå¸Œæœ›è®©æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°è¿›è¡Œåˆ†ç¦»ã€‚ ç»“æ„ Abstraction: å®šä¹‰æŠ½è±¡æ¥å£ã€‚æœ‰ä¸€ä¸ªæŒ‡å‘Implementorå¯¹è±¡çš„å¼•ç”¨ã€‚RefmedAbstraction: æ‰©å±•Abstractionçš„æ¥å£ã€‚Implementor: å®šä¹‰äº†å®ç°ç±»çš„æ¥å£ã€‚è¿™äº›æ¥å£æ²¡å¿…è¦å’ŒAbstractionçš„æ¥å£ä¿æŒä¸€è‡´ï¼Œç”šè‡³å¯ä»¥å®Œå…¨ä¸åŒã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒImplementorçš„æ¥å£æä¾›çš„æ˜¯åŸºæœ¬çš„åŠŸèƒ½ï¼ŒAbstractionåˆ©ç”¨è¿™äº›åŸºæœ¬å‡½æ•°æ¥æ„æˆæ›´é«˜çº§çš„å‡½æ•°åŠŸèƒ½ã€‚ConcreteImplementor: å…·ä½“å®ç°äº†Implementorçš„æ¥å£ï¼Œå®šä¹‰äº†å…·ä½“çš„å®ç°ã€‚ ä½•æ—¶ä½¿ç”¨ ä½ å¸Œæœ›é¿å…å°†æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°è¿›è¡Œæ°¸ä¹…çš„ç»‘å®šåœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç±»æä¾›çš„æŠ½è±¡è¡Œä¸ºæ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œè¿™äº›è¡Œä¸ºçš„å…·ä½“çš„å®ç°å´éœ€è¦è¿›è¡Œå˜åŠ¨ã€‚ æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°åº”è¯¥å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥è¿›è¡Œæ‰©å±•ã€‚Bridgeå¯ä»¥è®©åŠå°†ä¸åŒçš„æŠ½è±¡å’Œå®ç°è¿›è¡Œç»„åˆï¼Œå¹¶ä¸”å¯ä»¥äº’ä¸å½±å“çš„è¿›è¡Œæ‰©å±•ã€‚ å¯¹å…·ä½“å®ç°çš„æ”¹å˜ä¸ä¼šå½±å“ç”¨æˆ·ï¼Œå› ä¸ºæŠ½è±¡è¡Œä¸ºæ²¡æœ‰å˜åŒ–ã€‚ ä½ å¸Œæœ›å¯¹ç”¨æˆ·éšè—æŠ½è±¡è¡Œä¸ºçš„å…·ä½“å®ç°ã€‚ ä½ æƒ³å…±äº«å…·ä½“å®ç°éƒ¨åˆ†ï¼Œå¹¶ä¸”è¿™ç§å…±äº«å¯¹ç”¨æˆ·è€Œè¨€æ˜¯é€æ˜çš„ï¼Œå› ä¸ºç”¨æˆ·åªèƒ½çœ‹åˆ°æŠ½è±¡è¡Œä¸ºã€‚ 8. Compositeç›®çš„å°†å¯¹è±¡ç»„åˆæˆæ ‘çš„ç»“æ„æ¥è¡¨ç°éƒ¨åˆ†-æ•´ä½“çš„å±‚æ¬¡ç»“æ„ã€‚Compositeä½¿å¾—ç”¨æˆ·å¯ä»¥å°†ä¸ªä½“å¯¹è±¡å’Œç»„åˆå¯¹è±¡ç»Ÿä¸€è¿›è¡Œå¤„ç†ã€‚ Androidç³»ç»Ÿä¸­Activityä¸­å­˜æ”¾Viewç»„ä»¶çš„RootViewå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„Compositeã€‚ ç»“æ„ Component: ä¸ºéœ€è¦è¿›è¡Œç»„åˆçš„å¯¹è±¡å®šä¹‰äº†æ¥å£ã€‚é€‚å½“çš„å®ç°æ‰€æœ‰ç±»å…±æœ‰çš„é»˜è®¤è¡Œä¸ºã€‚å®šä¹‰è®¿é—®ã€ç®¡ç†å­ç»„ä»¶çš„æ¥å£ã€‚ä¹Ÿå¯ä»¥å®šä¹‰è®¿é—®çˆ¶èŠ‚ç‚¹çš„æ¥å£ã€‚Leaf: è¡¨ç¤ºå¶å­èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ã€‚å®šä¹‰äº†ç»„åˆä¸­åŸºæœ¬å¯¹è±¡çš„å‡½æ•°ã€‚Composite: å®šä¹‰æœ‰å­èŠ‚ç‚¹çš„ç»„ä»¶çš„è¡Œä¸ºã€‚å­˜å‚¨å­èŠ‚ç‚¹ã€‚å®ç°Componentä¸­å®šä¹‰çš„æœ‰å…³å­èŠ‚ç‚¹æ“ä½œçš„å‡½æ•°ã€‚Client: é€šè¿‡Componentæä¾›çš„æ¥å£æ“ä½œç»„åˆç»“æ„ã€‚ ä½•æ—¶ä½¿ç”¨ ä½ æƒ³è¡¨ç°ä¸€ä¸ªéƒ¨åˆ†-æ•´ä½“çš„å±‚æ¬¡ç»“æ„æ—¶ã€‚ ä½ å¸Œæœ›è®©ç”¨æˆ·æ— æ³•æ„ŸçŸ¥ç»„åˆå¯¹è±¡å’Œå­¤ç«‹å¯¹è±¡çš„åŒºåˆ«ï¼Œç”¨æˆ·å¯ä»¥ç»Ÿä¸€åœ°å¤„ç†compositeç»“æ„ä¸­æ‰€æœ‰çš„å¯¹è±¡ã€‚ 9. Decoratorç›®çš„åŠ¨æ€çš„ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ åŠŸèƒ½ã€‚Decoratorsæä¾›äº†ä¸€ä¸ªçµæ´»çš„é€‰æ‹©æ¥æ‰©å±•åŠŸèƒ½ã€‚ä¹Ÿå«åšWrapperã€‚ ç»“æ„ Component: å®šä¹‰äº†åŸºæœ¬ç»„ä»¶çš„æ¥å£ã€‚ConcreteComponent: å®šä¹‰äº†ä¸€ä¸ªå…·ä½“ç»„ä»¶çš„ç±»ã€‚Decorator: æœ‰ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªCompoentå¯¹è±¡çš„åº”ç”¨ï¼Œå¹¶ä¸”æœ‰ç€å’ŒComponentä¸€æ ·çš„æ¥å£ã€‚è¿™æ ·å¯ä»¥ä¿æŒç»™ç”¨æˆ·æä¾›ä¸€è‡´çš„æ¥å£ï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸çŸ¥ä¸è§‰ä¸­ä½¿ç”¨å·²ç»æ‰©å±•åŠŸèƒ½çš„å¯¹è±¡ã€‚ConcreteDecorator: ç»™ç»„ä»¶æ·»åŠ æ–°çš„åŠŸèƒ½ã€‚å¹¶é€šè¿‡å°†Componentçš„åŸå§‹æ¥å£å’Œæ–°åŠŸèƒ½å°è£…åœ¨é‡å†™çš„å‡½æ•°ä¸­å®ç°è¡Œä¸ºçš„ä¸€è‡´æ€§ã€‚ ä½•æ—¶ä½¿ç”¨ åŠ¨æ€åœ°ã€é€æ˜åœ°ã€ä¸å½±å“å…¶å®ƒå¯¹è±¡åœ°ç»™æŸä¸ªå¯¹è±¡æ·»åŠ æ–°çš„åŠŸèƒ½ã€‚ å¯ä»¥æ’¤é”€å¯¹è±¡çš„æ–°åŠŸèƒ½ã€‚ é€šè¿‡ç»§æ‰¿æ¥å®ç°åŠŸèƒ½çš„æ‰©å±•ä¸åˆ‡å®é™…æ—¶ã€‚æœ‰æ—¶å¤§é‡çš„å¯ä»¥æ‰©å±•çš„ç‹¬ç«‹åŠŸèƒ½ï¼Œä½†æ˜¯ç›´æ¥é€šè¿‡ç»§æ‰¿æ¥å®ç°ä¼šå¯¼è‡´å­ç±»çš„ç»„åˆçˆ†ç‚¸ã€‚ç»§æ‰¿æ˜¯éœ€è¦åœ¨ç¼–ç¨‹æ—¶å†™æ­»çš„ï¼Œè€Œé‡‡ç”¨Decoratoråˆ™å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€çš„ç»„åˆæ–°çš„åŠŸèƒ½ã€‚ 10. Facadeç›®çš„ä¸ºä¸€ä¸ªå­ç³»ç»Ÿçš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªç»Ÿä¸€åœ°æ¥å£ã€‚Facadeå®šä¹‰äº†ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„æ¥å£ï¼Œæ˜¯çš„å­ç³»ç»Ÿæ›´åŠ æ˜“äºä½¿ç”¨ã€‚ ç»“æ„ Facade: çŸ¥é“åœ¨å­ç³»ç»Ÿä¸­å“ªä¸€ä¸ªç±»åº”è¯¥å¯¹ä¸€ä¸ªè¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”å°†é€‚å½“çš„è¯·æ±‚äº¤ç»™ç›¸åº”çš„ç±»ã€‚subsystem classes: å®ç°å­ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œå¤„ç†Facadeäº¤ç»™çš„ä»»åŠ¡ï¼Œä½†æ˜¯å®ƒä»¬å¹¶ä¸çŸ¥é“Facadeå­˜åœ¨ã€‚ ä½•æ—¶ä½¿ç”¨ ä½ å¦‚æœæƒ³ç»™ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿæä¾›ä¸€ä¸ªç®€å•çš„æ¥å£ï¼Œè¯·ç”¨Facadeã€‚å­ç³»ç»Ÿä¼šéšç€å‡çº§è¶Šæ¥è¶Šå¤æ‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´è®¸å¤šç»†ç²’åº¦çš„ç±»å‡ºç°ï¼Œè™½ç„¶è¿™å¢åŠ äº†å­ç³»ç»Ÿçš„å¯å®šåˆ¶æ€§ï¼Œä½†æ˜¯å¯¹ç”¨æˆ·è€Œè¯´å´è¶Šæ¥è¶Šéš¾ä½¿ç”¨ã€‚Facadeå¯ä»¥ç»™è¿™äº›ç”¨æˆ·æä¾›ä¸€ä¸ªç›¸å¯¹ç®€å•çš„è§†å›¾ï¼Œåªæœ‰åœ¨ç”¨æˆ·éœ€è¦å®šåˆ¶å­ç³»ç»Ÿæ—¶ï¼Œæ‰éœ€è¦è¶Šè¿‡Facadeæ¥è§‚å¯Ÿå­ç³»ç»Ÿã€‚ åœ¨ä¼ ç»Ÿçš„ç³»ç»Ÿä¸­ï¼Œå®¢æˆ·ç«¯å’Œå­ç³»ç»Ÿä¹‹é—´ä¼šäº§ç”Ÿå¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œè€ŒFacadeçš„å¼•å…¥å¯ä»¥å¾ˆå¥½çš„å°†ç”¨æˆ·å’Œå­ç³»ç»Ÿè¿›è¡Œè§£è€¦ï¼Œå› æ­¤å¯ä»¥æå‡å­ç³»ç»Ÿçš„ç‹¬ç«‹æ€§å’Œå¯æºå¸¦æ€§ã€‚ å°†å­ç³»ç»Ÿè¿›è¡Œå±‚æ¬¡åŒ–ã€‚ç”¨facadeæ¥å®šä¹‰æ¯ä¸ªå­ç³»ç»Ÿçš„æ¥å£ï¼Œå¦‚æœå­ç³»ç»Ÿä¹‹é—´æœ‰ä¾èµ–å…³ç³»ï¼Œä½ å°±å¯ä»¥è®©è¿™äº›å­ç³»ç»Ÿä¹‹é—´åªé€šè¿‡ä»–ä»¬çš„facadeæ¥å£æ¥è¿›è¡Œäº¤äº’ï¼Œä»è€Œç®€åŒ–ä»–ä»¬ä¹‹é—´çš„ä¾èµ–ã€‚ 11. Flyweightç›®çš„é€šè¿‡åˆ†äº«çš„æ–¹å¼æ¥é«˜æ•ˆçš„æ”¯æŒå¤§é‡çš„ç»†ç²’åº¦çš„å¯¹è±¡ã€‚ ç»“æ„ Flyweight: å£°æ˜äº†ç”¨æ¥æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨çŠ¶æ€çš„æ¥å£ã€‚ConcreteFlyweight: å®ç°äº†Flyweightæ¥å£ï¼Œå¹¶ä¸”æœ‰è‡ªå·±çš„å†…éƒ¨çŠ¶æ€ã€‚ConcreteFlyweightå¿…é¡»æ˜¯å¯ä»¥å…±äº«çš„ã€‚å®ƒå†…éƒ¨å­˜å‚¨çš„çŠ¶æ€å¿…é¡»æ˜¯ä¸ä¸Šä¸‹æ–‡æ— å…³çš„ã€‚UnsharedConcreteFlyweight: ä¸æ˜¯æ‰€æœ‰çš„Flyweightå­ç±»éƒ½éœ€è¦è¢«åˆ†äº«ï¼ŒFlyweightå¹¶ä¸å¼ºåˆ¶éœ€è¦è¢«å…±äº«ã€‚FlyweightFactory: åˆ›å»ºå’Œç®¡ç†flyweightå¯¹è±¡ã€‚ä¿è¯flyweightå¯ä»¥è¢«é€‚å½“çš„å…±äº«ã€‚å½“ç”¨æˆ·éœ€è¦ä¸€ä¸ªflyweightæ—¶ï¼ŒFlyweightFactoryä¼šæ ¹æ®æ˜¯å¦å·²ç»æœ‰è¯¥flyweightè€Œåˆ›å»ºæˆ–è€…ç›´æ¥è¿”å›ä¸€ä¸ªflyweightå¯¹è±¡ã€‚Client: æœ‰æŒ‡å‘flyweightçš„å¼•ç”¨ï¼ŒåŒæ—¶æœ‰flyweightçš„å¤–éƒ¨çŠ¶æ€ã€‚ ä½•æ—¶ä½¿ç”¨å½“æ»¡è¶³ä¸€ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶å¯ä»¥ä½¿ç”¨ï¼š ä¸€ä¸ªåº”ç”¨ä½¿ç”¨äº†å¤§é‡çš„å¯¹è±¡ã€‚ å› ä¸ºå¯¹è±¡çš„æ•°é‡åºå¤§è€Œå¯¼è‡´è€—è´¹å¤§é‡çš„å­˜å‚¨èµ„æºã€‚ å¤§éƒ¨åˆ†çš„å¯¹è±¡çŠ¶æ€å¯ä»¥æå‡ºæ¥ä½œä¸ºå¤–éƒ¨çŠ¶æ€ä¼ å…¥ã€‚ å½“å¤–éƒ¨çŠ¶æ€è¢«æå–å‡ºæ¥ä»¥åï¼Œå¤§é‡çš„çš„å¯¹è±¡å¯ä»¥è¢«å‡ ä¸ªå¯ä»¥å…±äº«çš„å¯¹è±¡æ›¿ä»£ã€‚ åº”ç”¨ä¸ä¾èµ–äºå¯¹è±¡çš„ç‹¬ä¸€æ— äºŒæ€§ï¼Œå› ä¸ºå¯¹ç”¨æˆ·è€Œè¨€ï¼Œå®ƒä»¬è¡¨é¢ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯å®è´¨ä¸Šå®ƒä»¬æ˜¯è¢«å…±äº«çš„ã€‚ 12. Proxyç›®æ ‡ä¸ºä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†æˆ–è€…å ä½ç¬¦æ¥æ§åˆ¶å¯¹å®ƒçš„è®¿é—®ã€‚ä¹Ÿè¢«ç§°ä½œSurrogateã€‚ åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityä¸ActivityManagerServiceè¿›è¡Œè¿›ç¨‹é—´é€šä¿¡æ—¶ï¼ŒActivityæ˜¯ä¸ActivityManagerServiceçš„Proxyè¿›è¡Œç›´æ¥æ‰“äº¤é“çš„ã€‚ ç»“æ„ Proxy: æœ‰ç€ä¸€ä¸ªæŒ‡å‘çœŸæ­£çš„ä¸»ä½“å¼•ç”¨ã€‚å®ƒä¼šæä¾›å’Œä¸»ä½“ä¸€æ ·çš„æ¥å£ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ›¿ä»£ä¸»ä½“ã€‚æ§åˆ¶å¯¹çœŸæ­£ä¸»ä½“çš„è®¿é—®ï¼Œä¹Ÿå¯èƒ½è´Ÿè´£ä¸»ä½“çš„åˆ›å»ºå’Œåˆ é™¤ã€‚ä¸åŒç§ç±»çš„proxy: 1. **remote porxy**: è´Ÿè´£å¯¹è¯·æ±‚å’Œå‚æ•°è¿›è¡Œç¼–ç ï¼Œç„¶åå°†è¯·æ±‚å‘é€ç»™åœ¨å…¶å®ƒåœ°å€ç©ºé—´çš„çœŸæ­£ä¸»ä½“ã€‚ 2. **virtual proxy**: ç¼“å­˜éƒ¨åˆ†çœŸæ­£ä¸»ä½“çš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒå¯ä»¥å»¶ç¼“è®¿é—®ä¸»ä½“ã€‚ 3. **protection proxy**: éªŒè¯è®¿é—®è€…æ˜¯å¦æœ‰æƒé™å‘é€è¯·æ±‚ã€‚ Subject: å®šä¹‰äº†RealSubjectå’ŒProxyçš„ç»Ÿä¸€æ¥å£ï¼Œæ‰€ä»¥Proxyå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ›¿ä»£RealSubjectã€‚RealSubject: å®šä¹‰äº†Proxyéœ€è¦ä»£ç†çš„çœŸæ­£å¯¹è±¡ã€‚ ä½•æ—¶ä½¿ç”¨ remote proxy: ç»™ä¸åœ¨æœ¬åœ°ç©ºé—´çš„å¯¹è±¡æä¾›äº†ä¸€ä¸ªæœ¬åœ°è¡¨ç¤ºã€‚ virtual proxy: åœ¨å¿…è¦æ—¶æ‰éœ€æ±‚åˆ›å»ºæ˜‚è´µçš„å¯¹è±¡ï¼Œèƒ½æ‹–å°±æ‹–ã€‚ protection proxy: æ§åˆ¶è®¿é—®åŸå§‹å¯¹è±¡ã€‚åœ¨ä¸€ä¸ªå¯¹è±¡æœ‰ç€ä¸åŒç­‰çº§çš„è®¿é—®æƒé™æ—¶ï¼ŒProtection proxyååˆ†æœ‰ç”¨ã€‚ smart reference: å¯ä»¥ä»£æ›¿æŒ‡é’ˆï¼Œåœ¨è®¿é—®ä¸»ä½“å¯¹è±¡ä¹‹å‰å¯ä»¥è¿›è¡Œä¸€äº›é™„åŠ æ“ä½œã€‚æ¯”å¦‚ç»Ÿè®¡æœ‰å¤šå°‘ä¸ªå¼•ç”¨æŒ‡å‘è¯¥ä¸»ä½“ï¼Œåœ¨é€‚å½“çš„æ—¶å€™å¯ä»¥é‡Šæ”¾ä¸»ä½“ï¼›åœ¨ç¬¬ä¸€è®¿é—®æ—¶å°†ä¸»ä½“åŠ è½½åˆ°å†…å­˜ï¼›å¯¹ä¸»ä½“è¿›è¡ŒåŠ é”ç­‰ã€‚ Behavioral Patterns13. Chain of Responsibilityç›®çš„è§£è€¦è¯·æ±‚çš„æ¥æ”¶å¯¹è±¡ï¼Œä½¿å¾—ä¸€ä¸ªè¯·æ±‚å¯ä»¥è¢«å¤šä¸ªæ¥æ”¶è€…å¤„ç†ã€‚å°†è¿™äº›æ¥æ”¶å¯¹è±¡ä¸²è”æˆé“¾ï¼Œå¹¶ä¸”å°†è¯·æ±‚ä¾æ¬¡ä¼ é€’è¿‡å»ï¼Œç›´åˆ°æœ‰æ¥æ”¶è€…å¯ä»¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚ åœ¨Nodejsä¸­æœ‰Connectæ¨¡å—è´Ÿè´£åœ¨åŸå§‹çš„httpæ¨¡å—ä¸Šè¿›ä¸€æ­¥å¤„ç†httpè¯·æ±‚ï¼ŒåŠ å…¥äº†sessionã€Cookieã€bodyè§£æç­‰ä¸­é—´ä»¶æ¥ä¾æ¬¡å¤„ç†httpè¯·æ±‚ã€‚Connectçš„è®¾è®¡æ¨¡å¼çš„å°±æ˜¯å…¸å‹çš„Chain of Responsibilityã€‚ ç»“æ„ Handler: å®šä¹‰äº†ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„æ¥å£ã€‚æä¾›äº†åç»§çš„è¿æ¥ã€‚ConcreteHandler: å¤„ç†å®ƒéœ€è¦å¤„ç†çš„è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥å°†è¯·æ±‚ç»§ç»­ä¼ é€’ä¸‹å»ã€‚Client: åˆ›å»ºä¸€ä¸ªè¯·æ±‚ç»™ConcreteHandlerã€‚ ä½•æ—¶ä½¿ç”¨ å½“ä¸æ­¢ä¸€ä¸ªå¯¹è±¡å¯ä»¥å¤„ç†ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå¹¶ä¸”æ¥æ”¶è€…çš„ä¼˜å…ˆçº§ä¸è¢«å‘ŠçŸ¥ï¼Œé‚£å°±éœ€è¦è¿™äº›æ¥æ”¶è€…è‡ªå·±ç¡®å®šä¼˜å…ˆçº§ã€‚ ä½ æƒ³å°†ä¸€ä¸ªè¯·æ±‚å‘é€ç»™å¤šä¸ªå¯¹è±¡ä¸­çš„ä¸€ä¸ªï¼Œä½†æ˜¯ä¸æƒ³æŒ‡æ˜æ¥æ”¶è€…æ—¶ã€‚ é‚£äº›å¯ä»¥å¤„ç†å¯¹è±¡çš„æ¥æ”¶è€…å¯ä»¥åŠ¨æ€çš„è¢«å†³å®šã€‚ 14. Commandç›®çš„å°†è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥è®©ä½ ä½¿ç”¨ä¸åŒçš„è¯·æ±‚å‚æ•°åŒ–å®¢æˆ·ç«¯ã€åˆ—å‡ºè¯·æ±‚åºåˆ—ï¼Œè¿˜èƒ½å¤Ÿæ”¯æŒæ’¤é”€ç­‰è¡Œä¸ºã€‚ä¹Ÿè¢«ç§°ä½œActionã€Transactionã€‚ ç»“æ„ Command: å£°æ˜ä¸€ä¸ªæ¥å£æ¥æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚ConcreteCommand: å®šä¹‰ä¸€ä¸ªReceiverå’Œactionä¹‹é—´çš„ç»‘å®šå…³ç³»ã€‚å®ç°Executeå‡½æ•°æ¥åœ¨Receiverä¸Šæ‰§è¡ŒæŸäº›æ“ä½œã€‚å®è´¨ä¸Šæ˜¯å°†receiverå’Œä½œç”¨å…¶ä¸Šçš„Actionå°è£…æˆäº†ä¸€ä¸ªcommandçš„å¯¹è±¡ï¼Œä»¥ä¾¿è®°å½•å’Œæ’¤é”€ã€‚Client: åˆ›å»ºä¸€ä¸ªConcreteCommandå¹¶ä¸”åˆ¶å®šå®ƒçš„receiverã€‚Invoker: è®©commandæ‰§è¡Œè¯·æ±‚ã€‚Receiver: çŸ¥é“å¦‚ä½•å¯¹è¯·æ±‚è¿›è¡Œå…·ä½“çš„æ“ä½œã€‚ ä½•æ—¶ä½¿ç”¨ é€šè¿‡ä¸€ä¸ªactionæ¥å‚æ•°åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ã€‚ä½ å¯ä»¥åœ¨é¢å‘è¿‡ç¨‹çš„è¯­è¨€ä¸­ä½¿ç”¨å›è°ƒå‡½æ•°æ¥å®ç°è¿™ç§å®šåˆ¶ï¼Œå›è°ƒå‡½æ•°å°±æ˜¯å…ˆåœ¨æŸäº›åœ°æ–¹æ³¨å†Œï¼Œåœ¨ä»¥åæŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œçš„å‡½æ•°ã€‚Commandæ˜¯åœ¨é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ä¸€ç§å›è°ƒå‡½æ•°çš„æ›¿ä»£æ–¹å¼ã€‚ åœ¨ä¸åŒçš„æ—¶åˆ»æŒ‡å®šã€æ”¾å…¥é˜Ÿåˆ—ï¼Œå’Œæ‰§è¡Œè¯·æ±‚ã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚çš„æ¥æ”¶è€…å¯ä»¥åœ¨ä¸åŒçš„åœ°å€ç©ºé—´ä¸­ï¼Œé‚£ä¹ˆä½ å¯ä»¥å°†è¯·æ±‚å°è£…æˆcommandç»™ä¸åŒçš„è¿›ç¨‹ï¼Œå¹¶ä¸”åœ¨è¿™äº›è¿›ç¨‹ä¸­æ‰§è¡Œè¿™ä¸ªcommandã€‚ æ”¯æŒæ’¤é”€åŠ¨ä½œã€‚Commandå¯ä»¥å­˜å‚¨è£…çŠ¶æ€ç”¨æ¥æ’¤é”€è‡ªå·±æ‰§è¡Œçš„åŠ¨ä½œæ‰€äº§ç”Ÿçš„æ•ˆæœã€‚æ‰€æœ‰æ‰§è¡Œè¿‡çš„åŠ¨ä½œåº”è¯¥æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œä½¿ç”¨è¯¥åˆ—è¡¨å¯ä»¥å®ç°æ’¤é”€å’Œé‡åšä¸€ç³»åˆ—åŠ¨ä½œçš„åŠŸèƒ½ã€‚ å¯ä»¥è®°å½•è¡Œä¸ºæ—¥å¿—ï¼Œå¯ä»¥åœ¨crashå‘ç”Ÿæ—¶æ¢å¤ç³»ç»ŸçŠ¶æ€ã€‚ Commandå¯ä»¥è®©ç³»ç»Ÿå»ºç«‹åœ¨ç”±åŸºæœ¬æ“ä½œç»„æˆçš„é«˜çº§æ“ä½œä¹‹ä¸Šã€‚åœ¨ä¿¡æ¯ç³»ç»Ÿä¸­ï¼Œå°†åŸºæœ¬æ“ä½œå°è£…ä¸ºé«˜çº§æ“ä½œâ€“â€œäº‹åŠ¡â€œæ˜¯å¾ˆå¸¸è§çš„ä¸€ç§æ¨¡å¼ã€‚ 15. Interpreterç›®çš„ç»™å®šä¸€ç§è¯­è¨€ï¼Œåœ¨interpreterä¸­å®šä¹‰è¯¥è¯­è¨€çš„è¯­æ³•è¡¨ç¤ºæ¥ç¿»è¯‘è¯¥è¯­è¨€ã€‚ ç»“æ„ AbstractExpression: ç»™æŠ½è±¡è¯­æ³•æ ‘ç§æ‰€æœ‰èŠ‚ç‚¹å£°æ˜æŠ½è±¡çš„å…¬å…±ç¿»è¯‘æ¥å£ã€‚TerminalExpression: å®ç°ä¸€ä¸ªå’Œè¯­æ³•ä¸­ç»ˆç»“ç¬¦å·ç›¸å…³çš„çš„ç¿»è¯‘å‡½æ•°ã€‚æ¯ä¸ªè¯­æ³•ä¸­çš„ç»ˆç»“ç¬¦éƒ½éœ€è¦æœ‰ä¸€ä¸ªå¯¹åº”çš„å®ä¾‹ã€‚NonterminalExpression: éç»ˆç»“ç¬¦è¡¨è¾¾å¼ã€‚æœ‰ç€ä¸€ç»„ç±»å‹ä¸ºAbstractExpressionçš„å˜é‡ï¼Œè¿™äº›å˜é‡æ˜¯è¯¥è¡¨è¾¾å¼çš„å­è¡¨è¾¾å¼ã€‚å®ƒä¼šæä¾›æ¥å£æ¥é€’å½’çš„ç¿»è¯‘æ‰€æœ‰å­è¡¨è¾¾å¼ã€‚Context: ç»™Interpreteræä¾›ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚Client: å»ºé€ ä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘æ¥è¡¨ç°æŸä¸€ç§è¯­æ³•å®šä¹‰çš„è¯­è¨€ã€‚æŠ½è±¡è¯­æ³•æ ‘ç”±NonterminalExpressionå’ŒTerminalExpressionæ„æˆã€‚Clientè´Ÿè´£è°ƒç”¨ç¿»è¯‘å‡½æ•°ã€‚ ä½•æ—¶ä½¿ç”¨åœ¨éœ€è¦ç¿»è¯‘ä¸€ç§è¯­è¨€æ—¶ä½¿ç”¨Interpreteræ¨¡å¼ï¼Œå¹¶ä¸”è¯¥è¯­è¨€ä¸­çš„è¯­å¥å¯ä»¥ä½¿ç”¨æŠ½è±¡è¯­æ³•æ ‘æ¥è¡¨ç¤ºã€‚ä¸‹åˆ—æƒ…å†µä¸‹ä½¿ç”¨æœ€ä½³ï¼š è¯­æ³•æ¯”è¾ƒç®€å•ã€‚å¯¹äºè¾ƒä¸ºå¤æ‚çš„è¯­æ³•ï¼Œç”¨æ¥è¡¨ç°è¯­æ³•çš„ç±»çš„å±‚æ¬¡ç»“æ„å˜å¾—å¾ˆåºå¤§å’Œä¸å¥½ç®¡ç†ã€‚åœ¨è¯­æ³•å¤æ‚çš„æ—¶å€™è§£æç”Ÿæˆå™¨æ›´ä¸ºé€‚åˆã€‚ä»–ä»¬å¯ä»¥ä¸ä½¿ç”¨æŠ½è±¡è¯­æ³•æ ‘æ¥ç¿»è¯‘è¯­å¥ï¼Œå› æ­¤å¯ä»¥èŠ‚çœç©ºé—´å’Œæ—¶é—´ã€‚ æ•ˆç‡ä¸æ˜¯ç‰¹åˆ«çš„é‡è¦çš„æ—¶å€™ã€‚æœ€æœ‰æ•ˆçš„ç¿»è¯‘æ–¹å¼é€šå¸¸ä¸æ˜¯ç›´æ¥ç¿»è¯‘è¯­æ³•æ ‘ï¼Œè€Œæ˜¯é¦–å…ˆå°†å®ƒä»¬è½¬åŒ–ä¸ºå…¶å®ƒçš„å½¢å¼ã€‚ä¾‹å¦‚ï¼Œæ­£åˆ™è¡¨è¾¾å¼ç»å¸¸é¦–å…ˆè¢«è½¬åŒ–æˆä¸€ä¸ªçŠ¶æ€æœºã€‚ 16. Iteratorç›®çš„æä¾›äº†ä¸€ä¸ªå¯ä»¥æŒ‰åºè®¿é—®é›†åˆå¯¹è±¡å…ƒç´ çš„æ–¹å¼ï¼Œå¹¶ä¸”æ— éœ€æš´éœ²é›†åˆçš„å†…éƒ¨å®ç°ã€‚ ç»“æ„ Iterator: å®šä¹‰ä¸€ä¸ªè®¿é—®å’Œéå†å…ƒç´ çš„æ¥å£ã€‚ConcreteIterator: å®ç°Iteratoræ¥å£ï¼Œä¿å­˜å½“å‰éå†åˆ°çš„ä½ç½®ã€‚Aggregate: å®šä¹‰äº†ä¸€ä¸ªåˆ›å»ºIteratorå¯¹è±¡çš„æ¥å£ã€‚ConcreteAggregate: å®ç°äº†ç©¿ä»¶Iteratorçš„æ¥å£æ¥è¿”å›ä¸€ä¸ªåˆé€‚çš„ConcreteIteratorã€‚ ä½•æ—¶ä½¿ç”¨ è®¿é—®ä¸€ä¸ªé›†åˆçš„å†…å®¹ï¼Œå¹¶ä¸”æ— éœ€æš´éœ²é›†åˆçš„å†…éƒ¨è¡¨ç¤ºã€‚ å¯ä»¥æ”¯æŒå¤šç§éå†æ–¹å¼ã€‚ å¯ä»¥æä¾›ç»Ÿä¸€çš„æ¥å£æ¥éå†ä¸åŒçš„æ¥å£ï¼ˆå› æ­¤å¯ä»¥æ”¯æŒå¤šæ€çš„è¿­ä»£ï¼‰ã€‚ 17. Mediatorç›®çš„å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¥å°è£…ä¸€ç»„å¯¹è±¡ä¹‹é—´çš„äº¤äº’ã€‚Mediatorè®©å¯¹è±¡ä¹‹é—´ä¸é€šè¿‡æŒ‡æ˜çš„äº’ç›¸å¼•ç”¨æ¥å‡è½»å®ƒä»¬ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä»è€Œå¯ä»¥è®©ä½ äº’ä¸å½±å“çš„å˜åŒ–å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚ ç»“æ„ Mediator: å®šä¹‰äº†ä¸€ä¸ªå’ŒåŒä¼´äº¤æµçš„æ¥å£ã€‚ConcreteMediator: å®ç°åˆä½œçš„æ¥å£æ¥è®©è¿™äº›ä¼™ä¼´å¯¹è±¡å¯ä»¥ç›¸äº’åä½œã€‚å®ƒçŸ¥é“å¹¶ä¸”ç»´æŠ¤ç€å®ƒçš„åŒä¼´å¯¹è±¡ã€‚Colleague classes: æ¯ä¸ªColleagueç±»éƒ½çŸ¥é“å®ƒçš„Mediatorå¯¹è±¡ã€‚å½“å®ƒæƒ³å’ŒåŒä¼´å¯¹è±¡äº¤æµçš„æ—¶å€™ï¼Œå®ƒä¼šé€šè¿‡å®ƒçš„mediatoræ¥è¿›è¡Œé—´æ¥çš„äº¤æµã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ç»„å¯¹è±¡é€šè¿‡å®šä¹‰è‰¯å¥½ä½†æ–¹å¼å¤æ‚çš„æ–¹å¼æ¥äº¤æµåˆä½œã€‚ç»“æœå°±å¯¼è‡´å®ƒä»¬ä¹‹é—´çš„ä¾èµ–ç»“æ„æ··ä¹±å¹¶ä¸”éš¾ä»¥ç†è§£ã€‚ é‡æ–°ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œå› ä¸ºå®ƒå¼•ç”¨ç€è®¸å¤šå…¶å®ƒå¯¹è±¡ã€‚ ä¸€ä¸ªåˆ†å¸ƒåœ¨å¤šä¸ªç±»ä¹‹é—´çš„è¡Œä¸ºåº”è¯¥å¾ˆå®¹æ˜“è¢«å®šåˆ¶ï¼Œè€Œä¸éœ€è¦æå‡ºæ¥å¾ˆå¤šçš„å­ç±»ã€‚ 18. Mementoç›®çš„ä¸ç”¨ç ´åå¯¹è±¡çš„å°è£…æ€§è´¨ï¼Œè·å–ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ä»¥ä¾¿è¯¥å¯¹è±¡å¯ä»¥æ¢å¤åŸæ¥çš„çŠ¶æ€ã€‚ä¹Ÿå¯ä»¥è¢«ä½œtokenã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityå¯ä»¥é€šè¿‡savedInstanceStateæ¥ä¿å­˜å’Œæ¢å¤ä¸€ä¸ªActivityçš„çŠ¶æ€ã€‚ ç»“æ„ Mementoï¼šå­˜å‚¨Originatorå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ã€‚æœ‰originatorè‡ªå·±å†³å®šéœ€è¦ä¿å­˜å¤šå°‘çš„å†…éƒ¨çŠ¶æ€ã€‚å®ƒåº”è¯¥ä¿æŠ¤å­˜å‚¨çš„çŠ¶æ€åªç”±originatorè‡ªå·±è®¿é—®ã€‚Mementoæœ€å¥½æœ‰ä¸¤ç§æ¥å£ï¼ŒCaretakeråªèƒ½çœ‹åˆ°ä¸€ä¸ªâ€œç‹­çª„â€çš„æ¥å£ï¼Œå®ƒåªèƒ½å°†Mementoä¼ ç»™å…¶ä»–å¯¹è±¡ã€‚ç›¸åçš„ï¼ŒOriginatoråº”è¯¥å¯ä»¥çœ‹åˆ°ä¸€ä¸ªâ€œå®½å¹¿â€çš„æ¥å£ï¼Œä»è€Œå¯ä»¥è®©å®ƒè®¿é—®å­˜å‚¨çš„çŠ¶æ€ï¼Œä»è€Œæ¢å¤åˆ°åŸæ¥çš„çŠ¶æ€ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåªæœ‰äº§ç”Ÿmementoçš„originatoræ‰å¯ä»¥è®¿é—®mementoçš„å†…éƒ¨çŠ¶æ€ã€‚Originatorï¼šåˆ›å»ºä¸€ä¸ªmementoæ¥ä¿å­˜å®ƒçš„å†…éƒ¨çŠ¶æ€å¿«ç…§ã€‚ä½¿ç”¨Mementoæ¥æ¢å¤å®ƒçš„çŠ¶æ€ã€‚Caretaker: å®‰å…¨çš„ä¿å­˜ç€mementoã€‚ä¸ä¼šæ“ä½œå’Œè®¿é—®mementoçš„å†…éƒ¨çŠ¶æ€ã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å¿«ç…§éœ€è¦è¢«ä¿å­˜ä¸‹æ¥ï¼Œä»¥åå¯ä»¥ç”¨æ¥æ¢å¤çŠ¶æ€ã€‚ ç›´æ¥è®¿é—®ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ä¼šå¯¼è‡´ç ´åä¸€ä¸ªå¯¹è±¡çš„å°è£…æ€§ï¼Œæš´éœ²å¯¹è±¡çš„å®ç°ç»†èŠ‚ã€‚ 19. Observerç›®çš„å®šä¹‰ä¸€ä¸ªä¸€å¯¹å¤šçš„å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå› æ­¤å½“ä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡ä¼šæ”¶åˆ°æé†’ï¼Œå¹¶ä¸”è‡ªåŠ¨çš„æ”¹å˜çŠ¶æ€ã€‚å¯ä»¥ç§°ä½œDependentsï¼ŒPublish-Subscribeæ¨¡å¼ã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼Œæœ‰broadcast/broadcast receiveræœºåˆ¶ï¼Œåœ¨nodejsä¸­ï¼ŒåŒæ ·æœ‰event emmiter/listenæœºåˆ¶ã€‚ ç»“æ„ Subject: çŸ¥é“æ‰€æœ‰çš„observerï¼Œobserverçš„æ•°é‡æ—¶ä¸å›ºå®šçš„ã€‚æä¾›æ¥å£æ¥æ·»åŠ æˆ–è€…ç§»é™¤æ‰€æœ‰çš„observerå¯¹è±¡ã€‚Observer: ç»™é‚£äº›éœ€è¦è§‚å¯Ÿsubjectå˜åŒ–çš„å¯¹è±¡æä¾›äº†ä¸€ä¸ªupdateçš„æ¥å£ã€‚ConcreteSubject: å­˜å‚¨äº†ConcreteObserveræ„Ÿå…´è¶£çš„çŠ¶æ€ï¼Œå½“å®ƒçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæé†’å®ƒçš„è§‚å¯Ÿè€…ã€‚ConcreteObserver: æœ‰ä¸€ä¸ªæŒ‡å‘ConcreteSubjectå¯¹è±¡çš„å¼•ç”¨ï¼Œå­˜å‚¨äº†åº”è¯¥å’Œsubjectä¸€è‡´çš„çŠ¶æ€ã€‚å®ç°äº†Observerçš„æ›´æ–°æ¥å£ï¼Œæ¥ä¿æŒä¸subjectçŠ¶æ€çš„ä¸€è‡´ã€‚ ç›®å‰ï¼Œå¾ˆå¤šä½¿ç”¨è¯¥æ¨¡å¼çš„ç³»ç»Ÿä¼šè¿›ä¸€æ­¥è§£è€¦åˆï¼Œä½¿å¾—subjectå’Œobserverç›¸äº’é€æ˜ã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ä¸ªæŠ½è±¡ç»“æ„ä¸­æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªä¾èµ–äºå¦ä¸€ä¸ªã€‚å°†è¿™ä¸¤ä¸ªéƒ¨åˆ†å°è£…æˆç‹¬ç«‹çš„å¯¹è±¡ï¼Œå¯ä»¥è®©ä½ ç‹¬ç«‹çš„ä¿®æ”¹å’Œé‡å¤ä½¿ç”¨å®ƒä»¬ã€‚ å½“ä¸€ä¸ªå¯¹è±¡çš„å˜åŒ–éœ€è¦éœ€è¦å…¶ä»–å¯¹è±¡è·Ÿç€å˜åŒ–ï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“æœ‰å¤šå°‘å¯¹è±¡éœ€è¦è¢«ä¿®æ”¹çš„æ—¶å€™ã€‚ å½“ä½ æƒ³è®©ä¸€ä¸ªå¯¹è±¡é€šçŸ¥å…¶å®ƒå¯¹è±¡ï¼Œè€Œæ— éœ€å…³å¿ƒè¿™äº›è¢«é€šçŸ¥çš„å¯¹è±¡æ˜¯è°æ—¶ã€‚ä¸€å¥è¯ï¼Œä½ ä¸æƒ³è®©è¿™äº›å¯¹è±¡ç´§å¯†è€¦åˆçš„æ—¶å€™ã€‚ 20. Stateç›®çš„è®©ä¸€ä¸ªå¯¹è±¡å¯ä»¥åœ¨å®ƒçš„çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ”¹å˜å®ƒçš„è¡Œä¸ºã€‚ä½¿å¾—å¯¹è±¡çœ‹ä¸Šå»æ”¹å˜äº†è‡ªå·±çš„ç±»ã€‚ä¹Ÿè¢«ç§°ä½œObject for Statesã€‚ ç»“æ„ Context: å®šä¹‰äº†ç”¨æˆ·éœ€è¦çš„æ¥å£ã€‚ä¿å­˜ç€ä¸€ä¸ªå®šä¹‰äº†å½“å‰çŠ¶æ€çš„ConcreteStateå­ç±»å®ä¾‹ã€‚State: å®šä¹‰äº†ä¸€ä¸ªç”¨æ¥å°è£…ä¸ä¹‹å¯¹åº”çš„è¡Œä¸ºçš„æ¥å£ã€‚ConcreteState subclasses: æ¯ä¸ªsubclasså®ç°äº†ä¸çŠ¶æ€å¯¹åº”çš„è¡Œä¸ºã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºä¾èµ–äºå®ƒçš„çŠ¶æ€ï¼Œå®ƒå¿…é¡»åœ¨è¿è¡Œæ—¶åˆ»æ ¹æ®å®ƒçš„çŠ¶æ€æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚ ä¸€ä¸ªå¯¹è±¡çš„æ“ä½œæœ‰ç€å¤§é‡çš„æ¡ä»¶è¯­å¥ä¾èµ–äºå¯¹è±¡çš„çŠ¶æ€ã€‚è¿™äº›çŠ¶æ€é€šå¸¸åªæœ‰å¯æ•°çš„å‡ ç§ç»„åˆã€‚é€šå¸¸ï¼Œå¾ˆå¤šå‡½æ•°å«æœ‰é‡å¤çš„æ¡ä»¶ç»“æ„ã€‚Stateå¯ä»¥å°†è¿™äº›ä¸åŒçš„æ¡ä»¶åˆ†æ”¯æ”¾åˆ°ä¸åŒçš„ç±»ä¸­ã€‚ä»è€Œï¼Œä½ å¯ä»¥å°†å¯¹è±¡çš„çŠ¶æ€çœ‹æˆç‹¬ç«‹çš„å¯¹è±¡ï¼Œè¿™äº›çŠ¶æ€å¯ä»¥ç›¸äº’ç‹¬ç«‹çš„è¿›è¡Œåˆ‡æ¢ã€‚ 21. Strategyç›®çš„å®šä¹‰äº†ä¸€ç»„ç®—æ³•ï¼Œå¹¶ä¸”å¯¹æ¯ä¸ªç®—æ³•è¿›è¡Œäº†å°è£…ï¼Œå¹¶ä¸”ä»–ä»¬ä¹‹é—´æ˜¯å¯ä»¥ç›¸äº’åˆ‡æ¢çš„ã€‚Strategy è®©ç®—æ³•å¯ä»¥ç‹¬ç«‹äºç”¨æˆ·å˜åŒ–ã€‚ä¹Ÿå¯ä»¥ç§°ä½œPolicyã€‚ ç»“æ„ Strategy: å®šä¹‰äº†æ‰€æœ‰æ”¯æŒçš„ç®—æ³•çš„é€šç”¨æ¥å£ã€‚Contextä½¿ç”¨è¯¥æ¥å£æ¥è°ƒç”¨ConcreteStrategyæä¾›çš„ç®—æ³•ã€‚ConcreteStrategy: ä½¿ç”¨Strategyå®šä¹‰çš„æ¥å£å®ç°äº†å…·ä½“çš„ç®—æ³•ã€‚Context: å®ƒä¼šé…ç½®ä¸€ä¸ªConcreteStrategyå¯¹è±¡ã€‚ä¿å­˜ä¸€ä¸ªå¯¹Strategyå¯¹è±¡çš„å¼•ç”¨ã€‚æä¾›äº†å¯ä»¥è®©Strategyè®¿é—®æ•°æ®çš„æ¥å£ã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€äº›ç±»åªæœ‰ä»–ä»¬çš„è¡Œä¸ºä¸åŒï¼Œä½¿ç”¨Strategyå¯ä»¥è®©ä¸€ä¸ªç±»é…ç½®å¤šç§è¡Œä¸ºã€‚ ä½ éœ€è¦ä¸åŒç®—æ³•ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½å®šä¹‰äº†ä¸€äº›æœ‰ç€ä¸åŒçš„æ—¶é—´ï¼ç©ºé—´å¤æ‚åº¦çš„ç®—æ³•ã€‚ ç”¨æˆ·æ— éœ€çŸ¥é“ç®—æ³•å¦‚ä½•ä½¿ç”¨æ•°æ®ã€‚ä½¿ç”¨Strategyå¯ä»¥é¿å…æš´éœ²å¤æ‚çš„ï¼Œç®—æ³•ç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚ ä¸€ä¸ªç±»å®šä¹‰äº†å¤šç§è¡Œä¸ºï¼Œå¯¼è‡´åœ¨å‡½æ•°ä¸­æœ‰å¤šç§æ¡ä»¶è¯­å¥æ¥é€‰æ‹©è¿™äº›è¡Œä¸ºã€‚ä¸ºäº†é¿å…è¿™ç§ç¹æ‚çš„æ¡ä»¶è¯­å¥ï¼Œå°†ç›¸å…³çš„åˆ†æ”¯å°è£…æˆä¸åŒçš„Strategyå¯¹è±¡ã€‚ 22. Template Methodç›®çš„åœ¨å‡½æ•°ä¸­å®šä¹‰äº†ç®—æ³•çš„éª¨æ¶ï¼Œå°†å…·ä½“æŸäº›æ­¥éª¤äº¤ç»™å­ç±»æ¥å®ç°ã€‚Template Methodè®©å­ç±»é‡å®šä¹‰éƒ¨åˆ†æ­¥éª¤ï¼Œè€Œä¸ç”¨æ”¹å˜æ•´ä¸ªç®—æ³•çš„ç»“æ„ã€‚ ç»“æ„ AbstractClass: å®šä¹‰äº†æŠ½è±¡çš„primitiveå‡½æ•°ï¼Œè®©å­ç±»æ¥å…·ä½“å®ç°è¿™å‡ æ­¥ã€‚å®ç°äº†ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ï¼Œå†³å®šäº†ç®—æ³•çš„éª¨æ¶ã€‚template method è°ƒç”¨äº†primitiveæ–¹æ³•ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³•ã€‚ConcreteClass: å®ç°äº†primitiveæ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°å®šåˆ¶ç®—æ³•æŸäº›æ­¥éª¤çš„ç›®çš„ã€‚ ä½•æ—¶ä½¿ç”¨ å®ç°ç®—æ³•ä¸­ä¸å¯å˜çš„éƒ¨åˆ†ï¼Œå°†å¯å˜çš„éƒ¨åˆ†äº¤ç»™å­ç±»å»å®ç°ã€‚ å½“å‡ ä¸ªå­ç±»çš„å‡½æ•°ä¸­æœ‰ç€å…±åŒéƒ¨åˆ†è¡Œä¸ºï¼Œå¯ä»¥å°†è¿™å…±åŒçš„éƒ¨åˆ†åœ¨çˆ¶ç±»ä¸­å®ç°ï¼Œé¿å…ä»£ç çš„é‡å¤ã€‚æœ‰ä¸€ç§é€šè¿‡é‡æ„è¾¾åˆ°ä¸€èˆ¬åŒ–çš„ç›®çš„ã€‚ æ§åˆ¶å­ç±»çš„æ‰©å±•ã€‚ä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªtemplateæ–¹æ³•åœ¨æŒ‡å®šä½ç½®è°ƒç”¨â€œhookâ€æ“ä½œï¼Œä»è€Œé™åˆ¶å­ç±»åªèƒ½åœ¨è¿™äº›hookçš„ä½ç½®è¿›è¡Œæ‰©å±•ã€‚ 23. Visitorç›®çš„è¡¨ç¤ºä¸€ä¸ªå¯ä»¥å¯¹ç»“æ„ä½“ä¸­çš„å…ƒç´ è¿›è¡Œæ“ä½œçš„æ¨¡å¼ã€‚å¯ä»¥å¯¹å…¶ä¸­çš„å…ƒç´ æ·»åŠ æ–°çš„æ“ä½œï¼Œè€Œæ— éœ€ä¿®æ”¹è¯¥å…ƒç´ å¯¹åº”çš„ç±»ã€‚ ç»“æ„ Visitor: ç»™æ¯ä¸ªç»“æ„ä¸­çš„ç±»å®šä¹‰äº†ä¸€ä¸ªè®¿é—®å‡½æ•°ã€‚å‡½æ•°åæŒ‡æ˜äº†å®ƒèƒ½èƒ½å¤Ÿè®¿é—®çš„å¯¹è±¡ã€‚Visitorå†³å®šäº†è‡ªå·±å¯ä»¥è®¿é—®çš„å…ƒç´ ï¼Œé€šè¿‡ç‰¹å®šçš„å‚æ•°ï¼Œvisitorèƒ½å¤Ÿç›´æ¥çš„è®¿é—®è¿™äº›å…ƒç´ ã€‚Concrete Visitor: å®ç°Visitorå£°æ˜çš„æ¯ä¸ªæ“ä½œï¼Œæ¯ä¸ªæ“ä½œä½ç»“æ„ä¸­å¯¹åº”çš„å…ƒç´ å®ç°äº†ç®—æ³•çš„ä¸€ä¸ªç‰‡æ®µï¼ŒConcrete Visitoræä¾›äº†ç®—æ³•çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”å­˜å‚¨äº†æœ¬åœ°çŠ¶æ€ï¼Œå¯ä»¥åŠ é€Ÿéå†ã€‚Element: å®šä¹‰äº†å¯ä»¥æ¥å—Visitorçš„æ¥å£ã€‚ConcreteElement: å®ç°äº†æ¥å—æ¥å£ã€‚ObjectStructure: å¯ä»¥åˆ—ä¸¾è‡ªå·±çš„elementã€‚æä¾›äº†ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„æ¥å£æ¥è®©visitoræ¥è®¿é—®å®ƒçš„å…ƒç´ ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªcompositeç»“æ„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€é›†åˆç­‰ã€‚ ä½•æ—¶ä½¿ç”¨ ä¸€ä¸ªç»“æ„ä½“ä¸­æœ‰ç€å¾ˆå¤šæ¥å£ä¸åŒçš„å…ƒç´ å¯¹è±¡ï¼ŒåŒæ—¶ä½ å¸Œæœ›å¯¹å…¶ä¸­çš„è¿™äº›å…ƒç´ è¿›è¡Œæ“ä½œã€‚ ä½ éœ€è¦å¯¹ä¸€ä¸ªç»“æ„ä½“ä¸­çš„å¯¹è±¡è¿›è¡Œå¾ˆå¤šä¸åŒçš„ï¼Œå¹¶ä¸”ä¸ç›¸å…³çš„æ“ä½œï¼ŒåŒæ—¶ä½ ä¸å¸Œæœ›â€œæ±¡æŸ“â€è¿™äº›åŸæœ‰çš„ç±»ã€‚Visitorå¯ä»¥è®©ä½ å°†è¿™äº›æ— å…³çš„æ“ä½œå®šä¹‰åœ¨ä¸€ä¸ªç±»ä¸­ã€‚ ç»“æ„ä½“ä¸­å¯¹è±¡çš„ç±»å¾ˆå°‘å˜åŒ–ï¼Œä½†æ˜¯ä½ å¸¸å¸¸æƒ³å¯¹ç»“æ„æ·»åŠ æ–°çš„æ“ä½œã€‚ä¿®æ”¹ç»“æ„ä½“ä¸­çš„ç±»çš„æ¥å£ï¼Œä¼šå¯¼è‡´éœ€è¦é‡æ–°å®šä¹‰visitorçš„æ¥å£ï¼Œè¿™äº›ä»£ä»·å¾ˆå¤§ã€‚æ‰€ä»¥å¦‚æœç»“æ„ä½“ä¸­çš„ç±»å¦‚æœå¸¸å¸¸å˜åŒ–ï¼Œé‚£ä¹ˆæœ€å¥½è¿˜æ˜¯å°†æ“ä½œå®šä¹‰åœ¨è¿™äº›ç±»ä¸­ï¼Œè€Œä¸è¦ç”¨visitorã€‚ æ•´ç†å®Œäº†23ä¸ªè®¾è®¡æ¨¡å¼ï¼Œç»å¸¸å›é¡¾ï¼Œå¿…å°†ä¼šå—ç›ŠåŒªæµ…ã€‚ æœ¬æ–‡å¯ä»¥è½¬è½½ï¼Œä½†è¯·æ³¨æ˜æ–‡ç« æ¥è‡ªï¼šhttp://itanch.github.io/","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://itanch.github.io/tags/è®¾è®¡æ¨¡å¼/"}]},{"title":"å†™åœ¨2017çš„å¼€å§‹","date":"2017-02-14T08:02:40.000Z","path":"2017/02/14/å†™åœ¨2017çš„å¼€å§‹/","text":"åšå®¢çš„ä¸€æ¬¡æ¬è¿ åšå®¢æ¬è¿å†å²ä¸€å¹´å‰ï¼Œåœ¨ä¾é githubæ­å»ºäº†ä¸ªäººåšå®¢åï¼Œå†™äº†ä¸€äº›æ–‡ç« ã€‚ä¸€å¹´åliutianchi.comåŸŸåæ²¡æœ‰ç»­è´¹ï¼Œå°±è¢«é˜¿é‡Œäº‘å°æ‰ï¼Œæ‰€ä»¥åœ¨githubä¸Šçš„åšå®¢æš‚æ—¶æ— æ³•è®¿é—®ã€‚æ‰€ä»¥ï¼Œæš‚æ—¶å°†åšå®¢è¿ç§»åˆ°CSDNç»§ç»­æˆ‘çš„åšå®¢ä¹‹æ—…ã€‚ ç°åœ¨ï¼Œæˆ‘æ”¾å¼ƒè´­ä¹°åŸŸåï¼Œé‡‡ç”¨githubé»˜è®¤åŸŸåç»§ç»­åœ¨http://itanch.github.io/è®°å½•æˆ‘çš„å­¦ä¹ ç‚¹æ»´ï¼Œå¹¶ä¸”å°†éƒ¨åˆ†è‡ªå·±è®¤ä¸ºæœ‰ä»·å€¼çš„æ–‡ç« ä»CSDNä¸Šè¿ç§»äº†è¿‡æ¥ã€‚ å¸Œæœ›æ–°çš„ä¸€å¹´æœ‰æ›´å¤šçš„æ”¶è·:)ã€‚æƒ…äººèŠ‚å¿«ä¹ï¼ 2017åšå®¢è®¡åˆ’ é‡æ–°æ•´ç†ä¸€é32ç§è®¾è®¡æ¨¡å¼ é‡æ–°æ•´ç†ä¸€éAndroidå››å¤§ç»„ä»¶çš„è¿è¡Œæ¡†æ¶ å…¶å®ƒ","tags":[{"name":"è®°å½•","slug":"è®°å½•","permalink":"http://itanch.github.io/tags/è®°å½•/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(18):Androidåº”ç”¨çš„æ˜¾ç¤º","date":"2017-02-14T07:04:48.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-18-Androidåº”ç”¨çš„æ˜¾ç¤º/","text":"1. å¯åŠ¨ActivityManagerServiceåœ¨å‰é¢ç¬¬14ç« è®²åˆ°ï¼Œåœ¨Systemè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨ç³»ç»Ÿçš„ä¸€äº›åŸºæœ¬æœåŠ¡ã€‚å¯åŠ¨å°±æœ‰ActivityManagerServiceå’ŒPackageManagerServiceã€‚åœ¨SystemServerä¸­å¦‚ä¸‹å¯åŠ¨ActivityManagerServiceã€‚ frameworks/base/services/java/com/android/server/SystemServer.java :12// Activity manager runs the show.mActivityManagerService = mSystemServiceManager.startService(ActivityManagerService.Lifecycle.class).getService(); startServiceå°±æ˜¯åˆ›å»ºäº†ActivityManagerServiceçš„å®ä¾‹å¯¹è±¡mActivityManagerServiceï¼Œç„¶åå¯åŠ¨äº†ActivityManagerServiceçš„looperçº¿ç¨‹ã€‚åœ¨SystemServerå¯åŠ¨äº†åŸºæœ¬æœåŠ¡åï¼Œå°±ä¼šè°ƒç”¨mActivityManagerServiceçš„systemReadyå‡½æ•°æ¥å¯åŠ¨HomeActivityã€‚ 2. å¯åŠ¨HomeActivityç›®å‰ä»åœ¨SystemServerä¸»çº¿ç¨‹ä¸­è°ƒç”¨çš„systemReadyå‡½æ•°ã€‚è¯¥å‡½æ•°åˆä¼šæ¥ç€è°ƒç”¨startHomeActivityLockedå‡½æ•°æ¥å¯åŠ¨HomeActivityï¼Œå…·ä½“å¦‚ä¸‹ï¼š frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java :123456789101112131415161718192021222324boolean startHomeActivityLocked(int userId, String reason) &#123; //... //å…ˆåˆ›å»ºä¸€ä¸ªå¯åŠ¨Homeçš„Intentï¼ŒIntentçš„categoryä¸ºandroid.intent.category.home Intent intent = getHomeIntent(); ActivityInfo aInfo = resolveActivityInfo(intent, STOCK_PM_FLAGS, userId); if (aInfo != null) &#123; intent.setComponent(new ComponentName( aInfo.applicationInfo.packageName, aInfo.name)); // Don't do this if the home app is currently being // instrumented. aInfo = new ActivityInfo(aInfo); aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId); //å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨homeï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰ç›¸åº”çš„è¿›ç¨‹ï¼Œæ‰€ä»¥appä¸ºnull ProcessRecord app = getProcessRecordLocked(aInfo.processName, aInfo.applicationInfo.uid, true); if (app == null || app.instrumentationClass == null) &#123; intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK); //è¿™é‡Œå¼€å§‹å¯åŠ¨HomeActivity mStackSupervisor.startHomeActivity(intent, aInfo, reason); &#125; &#125; return true; &#125; è¿™é‡Œäº¤ç»™äº†mStackSupervisor.startHomeActivityå‡½æ•°æ¥å¯åŠ¨HomeActivityï¼Œç„¶åå°±ä¼šè°ƒç”¨startActivityLockedå‡½æ•°ã€‚åˆ°è¿™é‡Œï¼Œå°±å¼€å§‹é‡å¤ç¬¬2ç« ä¸­ï¼Œå¯åŠ¨æ™®é€šåº”ç”¨çš„activityçš„è¿‡ç¨‹äº†ï¼Œä¸å†èµ˜è¿°ã€‚å…¶ä¸­ï¼Œåœ¨Launcherçš„Manifestä¸­æŒ‡æ˜äº†å®ƒçš„ç±»å‹ä¸ºandroid.intent.category.homeï¼Œæ‰€ä»¥å¯åŠ¨çš„å°±æ˜¯Laucheråº”ç”¨ã€‚ 3. Launcherå±•ç¤ºåº”ç”¨ä¸‹é¢ä»Launcherçš„onCreateå‡½æ•°å¼€å§‹è®²èµ·ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š packages/apps/Launcher3/src/com/android/launcher3/Launcher.java :12345678910111213141516LauncherAppState app = LauncherAppState.getInstance();//å°†è¯¥launcherè®¾ç½®ä¸ºmModelçš„callbackå‡½æ•°mModel = app.setLauncher(this);if (!mRestoring) &#123; if (DISABLE_SYNCHRONOUS_BINDING_CURRENT_PAGE) &#123; // If the user leaves launcher, then we should just load items asynchronously when // they return. mModel.startLoader(PagedView.INVALID_RESTORE_PAGE); &#125; else &#123; // We only load the page synchronously if the user rotates (or triggers a // configuration change) while launcher is in the foreground //å¼€å§‹åŠ è½½åº”ç”¨ä¿¡æ¯ mModel.startLoader(mWorkspace.getRestorePage()); &#125;&#125; å…¶ä¸­mModelæ˜¯ä¸€ä¸ªLauncherModelå¯¹è±¡ï¼Œå®ƒè´Ÿè´£åŠ è½½åº”ç”¨ä¿¡æ¯ã€‚åœ¨é‡è½½çš„startLoaderå‡½æ•°ä¸­ï¼š 12345678910111213141516171819202122public void startLoader(int synchronousBindPage, int loadFlags) &#123; //... synchronized (mLock) &#123; //... // Don't bother to start the thread if we know it's not going to do anything if (mCallbacks != null &amp;&amp; mCallbacks.get() != null) &#123; //éœ€è¦é‡æ–°åŠ è½½äº†ï¼Œæ‰€ä»¥å…ˆæŠŠåŸæ¥çš„åŠ è½½ä»»åŠ¡åœäº† // If there is already one running, tell it to stop. stopLoaderLocked(); //åˆ›å»ºäº†ä¸€ä¸ªåŠ è½½ä»»åŠ¡ mLoaderTask = new LoaderTask(mApp.getContext(), loadFlags); if (synchronousBindPage != PagedView.INVALID_RESTORE_PAGE //... &#125; else &#123; //äº¤ç»™workThreadæ¥å¤„ç†è¿™ä¸ªä»»åŠ¡ sWorkerThread.setPriority(Thread.NORM_PRIORITY); //sWorkeræ˜¯sWorkerThreadçš„Handler sWorker.post(mLoaderTask); &#125; &#125; &#125; &#125; å› ä¸ºåŠ è½½æ‰€æœ‰å®‰è£…çš„åº”ç”¨ä¿¡æ¯æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åº”è¯¥äº¤ç»™ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ¥å¤„ç†ã€‚è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸€ä¸ªåŠ è½½ä»»åŠ¡mLoaderTaskï¼Œç„¶åå°†å®ƒäº¤ç»™sWorkerThreadæ¥å¤„ç†ã€‚sWorkerThreadæ˜¯ä¸€ä¸ªHandlerThreadï¼Œæˆ‘ä»¬çŸ¥é“HandlerThreadæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå¹¶ä¸”æœ‰ç€è‡ªå·±çš„looperã€‚mLoaderTaskåŠ è½½ä»»åŠ¡æ‰§è¡Œä¸€æ¬¡å°±å¯ä»¥ç»“æŸï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ç”¨ä¸€ä¸ªHandlerThreadåœ¨è¿™é‡Œä¸æ–­ç­‰å¾…ç€å…¶å®ƒä»»åŠ¡å‘¢ï¼Ÿå› ä¸ºæ¡Œé¢ä¸Šåº”ç”¨å¯ä»¥åŠ¨æ€çš„æ·»åŠ å’Œåˆ é™¤ï¼Œæ‰€ä»¥åº”ç”¨çš„åŠ è½½å¯èƒ½æ˜¯é¢‘ç¹çš„ã€‚è¿™é‡Œä½¿ç”¨HandlerThreadå¯ä»¥é¿å…é‡å¤çš„åˆ›å»ºåŠ è½½çº¿ç¨‹ã€‚ ä¸‹é¢æˆ‘ä»¬å°±çœ‹LoaderTask.runå‡½æ•°ä¸­å…·ä½“åšäº†å“ªäº›ä»»åŠ¡ã€‚ packages/apps/Launcher3/src/com/android/launcher3/LauncherModel.java :12345678910111213141516171819202122232425public void run() &#123; synchronized (mLock) &#123; if (mStopped) &#123; return; &#125; mIsLoaderTaskRunning = true; &#125; // Optimize for end-user experience: if the Launcher is up and // running with the // All Apps interface in the foreground, load All Apps first. Otherwise, load the // workspace first (default). keep_running: &#123; if (DEBUG_LOADERS) Log.d(TAG, \"step 1: loading workspace\"); //å¯åŠ¨workspace loadAndBindWorkspace(); if (mStopped) &#123; break keep_running; &#125; waitForIdle(); // second step if (DEBUG_LOADERS) Log.d(TAG, \"step 2: loading all apps\"); //åŠ è½½åº”ç”¨ loadAndBindAllApps(); &#125; //... &#125; WorkSpaceå°±æ˜¯Androidæ¡Œé¢ä¸­çš„åˆ†å±ï¼Œæ¯ä¸ªåˆ†å±æœ‰è‹¥å¹²åº”ç”¨ã€‚å…ˆåŠ è½½å·¥ä½œåŒºï¼Œå†åŠ è½½åº”ç”¨æ›´ç¬¦åˆç”¨æˆ·çš„å¿ƒç†é¢„æœŸï¼Ÿå‡½æ•°loadAndBindAllAppsä¼šåˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡åº”ç”¨ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ä¿¡æ¯ï¼Œåˆ™ç›´æ¥å°†appæ˜¾ç¤ºåœ¨æ¡Œé¢ä¸Šå³å¯ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦å…ˆè°ƒç”¨å‡½æ•°loadAllAppsï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š packages/apps/Launcher3/src/com/android/luancher3/LauncherModel.java :1234567891011121314151617181920212223242526272829303132333435363738394041private void loadAllApps() &#123; final Callbacks oldCallbacks = mCallbacks.get(); // Clear the list of apps mBgAllAppsList.clear(); for (UserHandleCompat user : profiles) &#123; // Query for the set of apps //è·å–æ‰€æœ‰çš„appä¿¡æ¯ï¼Œè¿™é‡Œæœ€ç»ˆè¿˜æ˜¯ä»PackageManagerServiceè·å–çš„åº”ç”¨ä¿¡æ¯ final List&lt;LauncherActivityInfoCompat&gt; apps = mLauncherApps.getActivityList(null, user); // Create the ApplicationInfos for (int i = 0; i &lt; apps.size(); i++) &#123; LauncherActivityInfoCompat app = apps.get(i); //æŠŠæ¯ä¸ªåº”ç”¨ä¿¡æ¯å°è£…æˆAppInfo // This builds the icon bitmaps. mBgAllAppsList.add(new AppInfo(mContext, app, user, mIconCache)); &#125; &#125; //... // Huh? Shouldn't this be inside the Runnable below? final ArrayList&lt;AppInfo&gt; added = mBgAllAppsList.added; mBgAllAppsList.added = new ArrayList&lt;AppInfo&gt;(); //è¿™é‡Œä¸€ç›´è¿è¡Œåœ¨Launcherä¸­åˆ›å»ºçš„ä¸€ä¸ªHandlerThreadå­çº¿ç¨‹ä¸­ //è·å–äº†åº”ç”¨ä¿¡æ¯åï¼Œéœ€è¦é€šçŸ¥ä¸»çº¿ç¨‹è¿›è¡Œuiæ›´æ–°ï¼ŒmHandleræ˜¯ä¸»çº¿ç¨‹çš„Handler // Post callback on main thread mHandler.post(new Runnable() &#123; public void run() &#123; //è¿™ä¸ªcallbackå°±æ˜¯launcher final Callbacks callbacks = tryGetCallbacks(oldCallbacks); if (callbacks != null) &#123; //æ˜¾ç¤ºæ‰€æœ‰åº”ç”¨ callbacks.bindAllApplications(added); //... &#125; else &#123; //... &#125; &#125; &#125;); //... &#125; mLauncherApps.getActivityListè·å–appä¿¡æ¯çš„æ–¹æ³•æ˜¯é€šè¿‡å‘PackageManagerå‘é€è¯·æ±‚çš„æ–¹å¼å®ç°çš„ã€‚ä¸‹é¢å›åˆ°Launcherä¸»çº¿ç¨‹ï¼Œå¼€å§‹æ˜¾ç¤ºåº”ç”¨å›¾æ ‡ã€‚é¦–å…ˆçœ‹ä¸€çœ¼è¿™ä¸ªå›è°ƒå‡½æ•°ï¼š packages/apps/Launcher3/src/com/android/launcher3/Launcher.java :12345678910111213/** * Add the icons for all apps. * * Implementation of the method from LauncherModel.Callbacks. */ public void bindAllApplications(final ArrayList&lt;AppInfo&gt; apps) &#123; //... if (mAppsView != null) &#123; //mAppsViewç®¡ç†ç€æ‰€æœ‰åº”ç”¨çš„view mAppsView.setApps(apps); &#125; //... &#125; mAppsViewæ˜¯ä¸€ä¸ªviewçš„å®¹å™¨ï¼Œç»´æŒäº†ä¸€ä¸ªAlphabeticalAppsListåˆ—è¡¨ï¼Œä¿å­˜åº”ç”¨çš„ä¿¡æ¯ã€‚å½“å‘å…¶ä¸­æ·»åŠ æ–°çš„åº”ç”¨ä¿¡æ¯åï¼Œä¼šå¯¹homeä¸Šçš„åº”ç”¨è¿›è¡Œæ›´æ–°ã€‚å½“homeä¸Šçš„å›¾æ ‡è¢«ç‚¹å‡»åï¼Œä¼šè§¦å‘å¯åŠ¨è¯¥åº”ç”¨ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(17):Androidåº”ç”¨çš„å®‰è£…","date":"2017-02-14T07:00:58.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-17-Androidåº”ç”¨çš„å®‰è£…/","text":"å­¦åˆ°çš„æ‰æ˜¯è‡ªå·±çš„ï¼Œå¹²æ´»éƒ½æ˜¯æ‰¯æ·¡ 1. åº”ç”¨çš„å®‰è£…PackageManagerServiceè´Ÿè´£ç®¡ç†åº”ç”¨çš„å®‰è£…ã€‚åœ¨ç¬¬14ç« ä¸­è®²åˆ°ï¼ŒSystemServiceä¼šå¯åŠ¨PackageManagerServiceï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»SystemServiceå¯åŠ¨PackageManagerServiceå¼€å§‹åˆ†æã€‚ 1.1 PackageManagerService.mainåˆ›å»ºPackageManagerServiceå¯¹è±¡ã€‚ frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java :1234567public static PackageManagerService main(Context context, Installer installer, boolean factoryTest, boolean onlyCore) &#123; //å…ˆåˆ›å»ºä¸€ä¸ªPackageManagerServiceå¯¹è±¡ PackageManagerService m = new PackageManagerService(context, installer, factoryTest, onlyCore); //å°†ä»–æ³¨å†Œåˆ°ServiceManageré‡Œé¢ ServiceManager.addService(\"package\", m); return m; &#125; 1.2 PackageManagerService.PackageManagerServicePackageManagerServiceçš„æ„é€ å‡½æ•°ã€‚ frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186 public PackageManagerService(Context context, Installer installer, boolean factoryTest, boolean onlyCore) &#123; //... mSettings = new Settings(mPackages);//... synchronized (mInstallLock) &#123; // writer synchronized (mPackages) &#123; //ä¸€ä¸ªPackageManagerServiceè‡ªå·±çš„Looper mHandlerThread = new ServiceThread(TAG, Process.THREAD_PRIORITY_BACKGROUND, true /*allowIo*/); //çº¿ç¨‹å¯åŠ¨ï¼Œå¼€å¯è‡ªå·±çš„æ¶ˆæ¯å¾ªç¯é˜Ÿåˆ— mHandlerThread.start(); //å¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªHandlerè¯¥çº¿ç¨‹ mHandler = new PackageHandler(mHandlerThread.getLooper()); //è·å–æ–‡ä»¶è·¯å¾„ File dataDir = Environment.getDataDirectory(); mAppDataDir = new File(dataDir, \"data\"); mAppInstallDir = new File(dataDir, \"app\"); mAppLib32InstallDir = new File(dataDir, \"app-lib\"); mAsecInternalPath = new File(dataDir, \"app-asec\").getPath(); mUserAppDataDir = new File(dataDir, \"user\"); mDrmAppPrivateInstallDir = new File(dataDir, \"app-private\"); sUserManager = new UserManagerService(context, this, mInstallLock, mPackages); // è·å–æƒé™é…ç½®æ–‡ä»¶çš„ä¸­çš„æƒé™ // Propagate permission configuration in to package manager. ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig = systemConfig.getPermissions(); for (int i=0; i&lt;permConfig.size(); i++) &#123; SystemConfig.PermissionEntry perm = permConfig.valueAt(i); BasePermission bp = mSettings.mPermissions.get(perm.name); if (bp == null) &#123; bp = new BasePermission(perm.name, \"android\", BasePermission.TYPE_BUILTIN); mSettings.mPermissions.put(perm.name, bp); &#125; if (perm.gids != null) &#123; bp.setGids(perm.gids, perm.perUser); &#125; &#125; //è·å–å…±äº«åº“ ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries(); for (int i=0; i&lt;libConfig.size(); i++) &#123; mSharedLibraries.put(libConfig.keyAt(i), new SharedLibraryEntry(libConfig.valueAt(i), null)); &#125; //æ¢å¤ä¸Šä¸€æ¬¡åº”ç”¨å®‰è£…ä¿¡æ¯ï¼Œè§1.3 mRestoredSettings = mSettings.readLPw(this, sUserManager.getUsers(false), mSdkVersion, mOnlyCore); /** * Add everything in the in the boot class path to the * list of process files because dexopt will have been run * if necessary during zygote startup. */ final String bootClassPath = System.getenv(\"BOOTCLASSPATH\"); final String systemServerClassPath = System.getenv(\"SYSTEMSERVERCLASSPATH\"); File frameworkDir = new File(Environment.getRootDirectory(), \"framework\"); // Gross hack for now: we know this file doesn't contain any // code, so don't dexopt it to avoid the resulting log spew. alreadyDexOpted.add(frameworkDir.getPath() + \"/framework-res.apk\"); // Gross hack for now: we know this file is only part of // the boot class path for art, so don't dexopt it to // avoid the resulting log spew. alreadyDexOpted.add(frameworkDir.getPath() + \"/core-libart.jar\"); /** * å°†ä¸€äº›åº”ç”¨dexoptè½¬åŒ– * There are a number of commands implemented in Java, which * we currently need to do the dexopt on so that they can be * run from a non-root shell. */ //... //è®¾å¤‡å‚å•†æä¾›çš„åº”ç”¨ // Collect vendor overlay packages. // (Do this before scanning any apps.) // For security and version matching reason, only consider // overlay packages if they reside in VENDOR_OVERLAY_DIR. File vendorOverlayDir = new File(VENDOR_OVERLAY_DIR); scanDirLI(vendorOverlayDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags | SCAN_TRUSTED_OVERLAY, 0); // èµ„æºå‹çš„ç¨‹åº // Find base frameworks (resource packages without code). scanDirLI(frameworkDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR | PackageParser.PARSE_IS_PRIVILEGED, scanFlags | SCAN_NO_DEX, 0); //ç‰¹æƒåº”ç”¨ // Collected privileged system packages. final File privilegedAppDir = new File(Environment.getRootDirectory(), \"priv-app\"); scanDirLI(privilegedAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, 0); // Collect ordinary system packages. final File systemAppDir = new File(Environment.getRootDirectory(), \"app\"); scanDirLI(systemAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0); // Collect all vendor packages. File vendorAppDir = new File(\"/vendor/app\"); try &#123; vendorAppDir = vendorAppDir.getCanonicalFile(); &#125; catch (IOException e) &#123; // failed to look up canonical path, continue with original one &#125; scanDirLI(vendorAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0); // Collect all OEM packages. final File oemAppDir = new File(Environment.getOemDirectory(), \"app\"); scanDirLI(oemAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0); if (DEBUG_UPGRADE) Log.v(TAG, \"Running installd update commands\"); mInstaller.moveFiles(); // Prune any system packages that no longer exist. final List&lt;String&gt; possiblyDeletedUpdatedSystemApps = new ArrayList&lt;String&gt;(); //... //look for any incomplete package installations ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr(); //clean up list for(int i = 0; i &lt; deletePkgsList.size(); i++) &#123; //clean up here cleanupInstallFailedPackage(deletePkgsList.get(i)); &#125; //delete tmp files deleteTempPackageFiles(); // Remove any shared userIDs that have no associated packages mSettings.pruneSharedUsersLPw(); //... // Now that we know all the packages we are keeping, // read and update their last usage times. mPackageUsage.readLP(); // If the platform SDK has changed since the last time we booted, // we need to re-grant app permission to catch any new ones that // appear. This is really a hack, and means that apps can in some // cases get permissions that the user didn't initially explicitly // allow... it would be nice to have some better way to handle // this situation. int updateFlags = UPDATE_PERMISSIONS_ALL; if (ver.sdkVersion != mSdkVersion) &#123; Slog.i(TAG, \"Platform changed from \" + ver.sdkVersion + \" to \" + mSdkVersion + \"; regranting permissions for internal storage\"); updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL; &#125; //ä¸ºç”³è¯·äº†ç‰¹å®šèµ„æºçš„è®¿é—®æƒé™çš„åº”ç”¨åˆ†é…ç”¨æˆ·ç»„id updatePermissionsLPw(null, null, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags); ver.sdkVersion = mSdkVersion; //å°†åº”ç”¨å®‰è£…ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°çš„é…ç½®æ–‡ä»¶ // can downgrade to reader mSettings.writeLPr(); &#125; // synchronized (mPackages) &#125; // synchronized (mInstallLock) // Now after opening every single application zip, make sure they // are all flushed. Not really needed, but keeps things nice and // tidy. Runtime.getRuntime().gc(); // Expose private service for system components to use. LocalServices.addService(PackageManagerInternal.class, new PackageManagerInternalImpl()); &#125; 1.3 Settings.readLPwè¯»å–ä¿å­˜çš„åº”ç”¨ä¿¡æ¯ã€‚frameworks/base/services/core/java/com/android/server/pm/Settings.java :12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061boolean readLPw(PackageManagerService service, List&lt;UserInfo&gt; users, int sdkVersion, boolean onlyCore) &#123; FileInputStream str = null; if (mBackupSettingsFilename.exists()) &#123; try &#123; //è·å–/data/system/packages-backup.xmlæ–‡ä»¶ str = new FileInputStream(mBackupSettingsFilename); //å¦‚æœbackupä¸å­˜åœ¨ï¼Œåˆ™è·å–/data/system/packages.xmlæ–‡ä»¶ //... &#125; catch (java.io.IOException e) &#123; // We'll try for the normal settings file. &#125; &#125; //... try &#123; if (str == null) &#123; //... str = new FileInputStream(mSettingsFilename); &#125; //ç”¨parserè§£æxmlæ–‡ä»¶ XmlPullParser parser = Xml.newPullParser(); parser.setInput(str, StandardCharsets.UTF_8.name()); //... int outerDepth = parser.getDepth(); while ((type = parser.next()) != XmlPullParser.END_DOCUMENT &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123; if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123; continue; &#125; //è·å–åº”ç”¨çš„å„é¡¹å‚æ•° String tagName = parser.getName(); if (tagName.equals(\"package\")) &#123; //è·å–ä¸Šæ¬¡åˆ†é…ç»™ä»–çš„åº”ç”¨ç”¨æˆ·IDï¼Œè§1.4 readPackageLPw(parser); &#125; else if (tagName.equals(\"permissions\")) &#123; readPermissionsLPw(mPermissions, parser); &#125; else if (tagName.equals(\"permission-trees\")) &#123; readPermissionsLPw(mPermissionTrees, parser); &#125; else if (tagName.equals(\"shared-user\")) &#123; //è·å–ä¸Šæ¬¡åˆ†é…çš„å…±äº«ç”¨æˆ·IDï¼Œè§1.6 readSharedUserLPw(parser); &#125; else if &#123; //... &#125; else &#123; Slog.w(PackageManagerService.TAG, \"Unknown element under &lt;packages&gt;: \" + parser.getName()); XmlUtils.skipCurrentTag(parser); &#125; &#125; str.close(); &#125; catch (XmlPullParserException e) &#123; //... &#125; catch (java.io.IOException e) &#123; //.... &#125; //... return true; &#125; 1.4 Settings.readPackageLPwè¯»å–packageä¿¡æ¯ã€‚ frameworks/base/services/core/java/com/android/server/pm/Settings.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051private void readPackageLPw(XmlPullParser parser) throws XmlPullParserException, IOException &#123; String name = null; //... String idStr = null; String sharedIdStr = null;//... try &#123; name = parser.getAttributeValue(null, ATTR_NAME); realName = parser.getAttributeValue(null, \"realName\"); idStr = parser.getAttributeValue(null, \"userId\"); //... //åå­—ä¸èƒ½ä¸ºnull if (name == null) &#123; PackageManagerService.reportSettingsProblem(Log.WARN, \"Error in package manager settings: &lt;package&gt; has no name at \" + parser.getPositionDescription()); &#125; else if (codePathStr == null) &#123; PackageManagerService.reportSettingsProblem(Log.WARN, \"Error in package manager settings: &lt;package&gt; has no codePath at \" + parser.getPositionDescription()); &#125; else if (userId &gt; 0) &#123; //è¯¥åº”ç”¨ä¸Šæ¬¡å·²ç»åˆ†é…è¿‡IDï¼Œæ‰€ä»¥è¿™æ¬¡è¿˜ä½¿ç”¨è¯¥id,è§1.5 packageSetting = addPackageLPw(name.intern(), realName, new File(codePathStr), new File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString, userId, versionCode, pkgFlags, pkgPrivateFlags); //... &#125; else if (sharedIdStr != null) &#123; userId = sharedIdStr != null ? Integer.parseInt(sharedIdStr) : 0; if (userId &gt; 0) &#123; //å¦‚æœä¸Šæ¬¡ä½¿ç”¨çš„æ˜¯å…±äº«idï¼Œåˆ™è¯´æ˜ä¸Šæ¬¡è¯¥appæ²¡æœ‰ç‹¬ç«‹çš„id //æ‰€ä»¥è¿™æ¬¡ä¸èƒ½ç›´æ¥å°†è¯¥idåˆ†é…ç»™ä»–ï¼Œè¦å…ˆå°†å…¶ä¿å­˜èµ·æ¥ä»¥åå¤„ç† packageSetting = new PendingPackage(name.intern(), realName, new File( codePathStr), new File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString, userId, versionCode, pkgFlags, pkgPrivateFlags); //... mPendingPackages.add((PendingPackage) packageSetting); //... &#125; else &#123; //... &#125; &#125; else &#123; //... &#125; &#125; catch (NumberFormatException e) &#123; //... &#125; //... &#125; 1.5 Setttings.addPackageLPwä¸ºè¯¥packageåˆ†é…UIDï¼Œåˆ›å»ºä¿å­˜packageä¿¡æ¯çš„PackageSettingå¯¹è±¡ã€‚ frameworks/base/services/core/java/com/android/server/pm/Settings.java :123456789101112131415161718192021222324252627PackageSetting addPackageLPw(String name, String realName, File codePath, File resourcePath, String legacyNativeLibraryPathString, String primaryCpuAbiString, String secondaryCpuAbiString, String cpuAbiOverrideString, int uid, int vc, int pkgFlags, int pkgPrivateFlags) &#123; //æ¯ä¸€ä¸ªappçš„ä¿¡æ¯éƒ½ä¿å­˜äºä¸€ä¸ªPackageSettingå¯¹è±¡ä¸­ PackageSetting p = mPackages.get(name); if (p != null) &#123; //è¯¥åº”ç”¨å·²ç»æœ‰å¯¹åº”çš„PackageSettingå¯¹è±¡äº†ï¼Œæ— éœ€å†æ¬¡æ·»åŠ  if (p.appId == uid) &#123; return p; &#125; PackageManagerService.reportSettingsProblem(Log.ERROR, \"Adding duplicate package, keeping first: \" + name); return null; &#125; //ä¸ºè¯¥appåˆ›å»ºä¸€ä¸ªPackageSetting p = new PackageSetting(name, realName, codePath, resourcePath, legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString, vc, pkgFlags, pkgPrivateFlags); p.appId = uid; //åœ¨ç³»ç»Ÿä¸­ä¿ç•™å€¼ä¸ºuidçš„Linuxç”¨æˆ·IDï¼Œä¼šåœ¨ä¸‹é¢è¯¦è§£ if (addUserIdLPw(uid, p, name)) &#123; //mPackagesä¿å­˜åˆ›å»ºçš„app PackageSettingå¯¹è±¡ mPackages.put(name, p); return p; &#125; return null;&#125; åœ¨ç³»ç»Ÿä¸­ä¿ç•™æŒ‡å®šçš„UIDã€‚è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œä¸€å…±å¯ä»¥åˆ†é…10000ä¸ªuidç»™åº”ç”¨ç¨‹åºï¼Œå°äº10000çš„uidæ˜¯åˆ†é…ç»™ç‰¹æƒç”¨æˆ·çš„ã€‚è¿™äº›ç‰¹æƒç”¨æˆ·çš„uidå¯ä»¥é€šè¿‡å…±äº«çš„å½¢å¼ç»™å…¶å®ƒåº”ç”¨ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæƒ³ä¿®æ”¹ç³»ç»Ÿæ—¶é—´çš„çš„åº”ç”¨å¯ä»¥å…±äº«â€android.uid.systemâ€çš„ç‰¹æƒç”¨æˆ·çš„uidï¼Œå³åœ¨é…ç½®æ–‡ä»¶ä¸­å°†å®ƒçš„android:sharedUserIdçš„å±æ€§è®¾ç½®ä¸ºâ€œandroid.uid.systemâ€ã€‚uidä¸èƒ½é‡å¤ï¼Œä½†æ˜¯shareduidæ˜¯å¯ä»¥å…±äº«çš„ã€‚ frameworks/base/services/core/java/com/android/server/pm/Settings.java :12345678910111213141516171819202122232425262728293031private boolean addUserIdLPw(int uid, Object obj, Object name) &#123; //åˆ†é…çš„uidä¸èƒ½è¶…è¿‡LAST_APPLICATION_UIDï¼Œ19999 if (uid &gt; Process.LAST_APPLICATION_UID) &#123; return false; &#125; //åˆ†é…çš„uidåº”è¯¥å¤§äºç­‰äºFIRST_APPLICATION_UIDï¼Œ10000 if (uid &gt;= Process.FIRST_APPLICATION_UID) &#123; int N = mUserIds.size(); final int index = uid - Process.FIRST_APPLICATION_UID; while (index &gt;= N) &#123; //å°†ä¸­é—´æ²¡åˆ†é…çš„uidå…ˆç½®ä¸ºç©º mUserIds.add(null); N++; &#125; if (mUserIds.get(index) != null) &#123; //è¯¥uidé‡å¤äº†ï¼Œåˆ†é…å¤±è´¥ return false; &#125; //æ­£å¼åˆ†é…uidï¼Œæ‰€æœ‰çš„uidè¢«mUserIdsç®¡ç† mUserIds.set(index, obj); &#125; else &#123; //è¿™é‡Œæ˜¯ç‰¹æƒç”¨æˆ·çš„uid if (mOtherUserIds.get(uid) != null) &#123; //uidå·²ç»åˆ†é…è¿‡ï¼Œè¿”å›å¤±è´¥ return false; &#125; mOtherUserIds.put(uid, obj); &#125; return true;&#125; åˆ°è¿™é‡Œï¼Œåº”ç”¨çš„uidå·²ç»åˆ†é…å®Œæˆã€‚ä¸‹é¢å›åˆ°1.3ï¼Œçœ‹å¦‚ä½•è¯»å–shareduidã€‚ 1.6 Setttings.readSharedUserLPwè¯»å–å…±äº«uidã€‚ frameworks/base/services/core/java/com/android/server/pm/Settings.java :123456789101112131415161718192021222324252627282930313233private void readSharedUserLPw(XmlPullParser parser) throws XmlPullParserException,IOException &#123; String name = null; String idStr = null; int pkgFlags = 0; int pkgPrivateFlags = 0; SharedUserSetting su = null; try &#123; name = parser.getAttributeValue(null, ATTR_NAME); idStr = parser.getAttributeValue(null, \"userId\"); int userId = idStr != null ? Integer.parseInt(idStr) : 0; //è¯¥å…±äº«idæ˜¯ç³»ç»Ÿåº”ç”¨è¿˜æ˜¯ç”¨æˆ·ç±»å‹çš„åº”ç”¨ if (\"true\".equals(parser.getAttributeValue(null, \"system\"))) &#123; pkgFlags |= ApplicationInfo.FLAG_SYSTEM; &#125; if (name == null) &#123; //... &#125; else if (userId == 0) &#123; //... &#125; else &#123; //åœ¨ç³»ç»Ÿä¸­ä¸ºè¯¥åº”ç”¨ç”³è¯·è¯¥userIdï¼Œè§1.7 if ((su = addSharedUserLPw(name.intern(), userId, pkgFlags, pkgPrivateFlags)) == null) &#123; //... &#125; &#125; &#125; catch (NumberFormatException e) &#123; //... &#125;//.... &#125; else &#123; XmlUtils.skipCurrentTag(parser); &#125;&#125; 1.7 Settings.addSharedUserLPwæ·»åŠ å…±äº«ç”¨æˆ·ã€‚ frameworks/base/services/core/java/com/android/server/pm/Settings.java :1234567891011121314151617181920SharedUserSetting addSharedUserLPw(String name, int uid, int pkgFlags, int pkgPrivateFlags) &#123; SharedUserSetting s = mSharedUsers.get(name); if (s != null) &#123; if (s.userId == uid) &#123; return s; &#125; //æ·»åŠ uidå’Œå·²ç»æ·»åŠ çš„ä¸åŒï¼Œåˆ™å¤±è´¥è¿”å› return null; &#125; //mSharedUsersä¸­æ²¡æœ‰è¯¥å…±äº«ç”¨æˆ·idï¼Œåˆ™åˆ›å»ºä¸€ä¸ªSharedUserSetting s = new SharedUserSetting(name, pkgFlags, pkgPrivateFlags); s.userId = uid; //åœ¨ç³»ç»Ÿä¸­ä¸ºå®ƒåˆ†é…è¯¥uidï¼Œé‡å¤1.6 if (addUserIdLPw(uid, s, name)) &#123; //åˆ†é…æˆåŠŸï¼Œè®°å½•ä¸‹æ¥ mSharedUsers.put(name, s); return s; &#125; return null; &#125; åœ¨1.4ä¸­ï¼ŒmPendingPackagesä¿å­˜äº†ä¸€äº›ä½¿ç”¨å…±äº«ç”¨æˆ·idçš„packageã€‚ç°åœ¨å·²ç»è§£æå®Œæ¯•å…±äº«ç”¨æˆ·çš„ä¿¡æ¯ï¼Œåœ¨1.3 readLPwå‡½æ•°ä¸­å°†ä¼šå¤„ç†è¿™äº›packageäº†ã€‚ frameworks/base/services/core/java/com/android/server/pm/Settings.java :12345678910111213141516171819202122for (int i = 0; i &lt; N; i++) &#123; final PendingPackage pp = mPendingPackages.get(i); Object idObj = getUserIdLPr(pp.sharedId); if (idObj != null &amp;&amp; idObj instanceof SharedUserSetting) &#123; //è·å¾—å…±äº«ç”¨æˆ·ä¿¡æ¯ï¼Œè¯´æ˜è¯¥packageä½¿ç”¨çš„å…±äº«ç”¨æˆ·idæ˜¯æœ‰æ•ˆçš„ï¼Œå°†åœ¨ä¸‹é¢å°èŠ‚åˆ†æ PackageSetting p = getPackageLPw(pp.name, null, pp.realName, (SharedUserSetting) idObj, pp.codePath, pp.resourcePath, pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString, pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags, null, true /* add */, false /* allowInstall */); if (p == null) &#123; //... continue; &#125; p.copyFrom(pp); &#125; else if (idObj != null) &#123; //è¯¥packageä½¿ç”¨äº†ä¸€ä¸ªéå…±äº«çš„id &#125; else &#123; //ä½¿ç”¨çš„å…±äº«idä¸å­˜åœ¨ &#125; &#125; mPendingPackages.clear(); 1.8 PackageManagerService.scanDirLIåˆ°æ­¤ï¼ŒPackageManagerServiceå·²ç»å°†ä¸Šä¸€æ¬¡ä¿å­˜çš„åº”ç”¨ä¿¡æ¯æ¢å¤å®Œæ¯•ï¼Œåœ¨1.2ä¸­æ¥ä¸‹æ¥éœ€è¦è¿›ä¸€æ­¥å®‰è£…å„ä¸ªç›®å½•ä¸‹çš„åº”ç”¨ã€‚ frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java :123456789101112131415161718192021222324252627private void scanDirLI(File dir, int parseFlags, int scanFlags, long currentTime) &#123; final File[] files = dir.listFiles(); //ä¾æ¬¡è®¿é—®æ–‡ä»¶å¤¹ä¸­çš„æ¯ä¸ªapkæ–‡ä»¶ for (File file : files) &#123; final boolean isPackage = (isApkFile(file) || file.isDirectory()) &amp;&amp; !PackageInstallerService.isStageName(file.getName()); if (!isPackage) &#123; // Ignore entries which are not packages continue; &#125; try &#123; scanPackageLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK, scanFlags, currentTime, null); &#125; catch (PackageManagerException e) &#123; //åˆ é™¤æ— æ•ˆçš„æ–‡ä»¶ // Delete invalid userdata apps if ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == 0 &amp;&amp; e.error == PackageManager.INSTALL_FAILED_INVALID_APK) &#123; if (file.isDirectory()) &#123; mInstaller.rmPackageDir(file.getAbsolutePath()); &#125; else &#123; file.delete(); &#125; &#125; &#125; &#125;&#125; 1.9 PackageManagerService.scanPackageLIframeworks/base/services/core/java/com/android/server/pm/PackageManagerService.java :1234567891011121314 private PackageParser.Package scanPackageLI(File scanFile, int parseFlags, int scanFlags, long currentTime, UserHandle user) throws PackageManagerException &#123; //... PackageParser pp = new PackageParser(); //... final PackageParser.Package pkg; try &#123; //è§£æç›®æ ‡æ–‡ä»¶ pkg = pp.parsePackage(scanFile, parseFlags); &#125; catch (PackageParserException e) &#123; //... &#125; //...&#125; 1.10 PackageParser.parsePackageframeworks/base/core/java/android/content/pm/PackageParser.java :123456789public Package parsePackage(File packageFile, int flags) throws PackageParserException &#123; if (packageFile.isDirectory()) &#123; //ä¸€ä¸ªç›®å½•ä¸‹æ˜¯ä¸€ä¸ªåº”ç”¨ return parseClusterPackage(packageFile, flags); &#125; else &#123; //ä¸€ä¸ªæ•´ä½“çš„åº”ç”¨ return parseMonolithicPackage(packageFile, flags); &#125; &#125; 1.11 PackageParser.parseMonolithicPackageframeworks/base/core/java/android/content/pm/PackageParser.java :1234567891011 public Package parseMonolithicPackage(File apkFile, int flags) throws PackageParserException &#123; //... final AssetManager assets = new AssetManager(); try &#123; final Package pkg = parseBaseApk(apkFile, assets, flags); pkg.codePath = apkFile.getAbsolutePath(); return pkg; &#125; finally &#123; IoUtils.closeQuietly(assets); &#125;&#125; 1.12 PackageParser.parseBaseApkframeworks/base/core/java/android/content/pm/PackageParser.java :1234567891011121314151617181920212223242526private Package parseBaseApk(File apkFile, AssetManager assets, int flags) throws PackageParserException &#123; //... final String apkPath = apkFile.getAbsolutePath(); mArchiveSourcePath = apkFile.getAbsolutePath(); final int cookie = loadApkIntoAssetManager(assets, apkPath, flags); Resources res = null; XmlResourceParser parser = null; try &#123; res = new Resources(assets, mMetrics, null); assets.setConfiguration(0, 0, null, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, Build.VERSION.RESOURCES_SDK_INT); //è·å–AndroidManifest.xmlæ–‡ä»¶ parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME); //è§£æAndroidManifest.xmlæ–‡ä»¶ final Package pkg = parseBaseApk(res, parser, flags, outError); //... return pkg; &#125; catch (PackageParserException e) &#123; //... &#125; finally &#123; IoUtils.closeQuietly(parser); &#125;&#125; frameworks/base/core/java/android/content/pm/PackageParser.java :1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071 private Package parseBaseApk(Resources res, XmlResourceParser parser, int flags, String[] outError) throws XmlPullParserException, IOException &#123; final boolean trustedOverlay = (flags &amp; PARSE_TRUSTED_OVERLAY) != 0; AttributeSet attrs = parser; final String pkgName; final String splitName; try &#123; Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, attrs, flags); //è·å–packageåç§° pkgName = packageSplit.first; splitName = packageSplit.second; &#125; catch (PackageParserException e) &#123; //... &#125; //åˆ›å»ºPackageå¯¹è±¡ final Package pkg = new Package(pkgName); boolean foundApp = false; TypedArray sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifest); //åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯ pkg.mVersionCode = pkg.applicationInfo.versionCode = sa.getInteger( com.android.internal.R.styleable.AndroidManifest_versionCode, 0); //... //ç”¨æˆ·å…±äº«id String str = sa.getNonConfigurationString( com.android.internal.R.styleable.AndroidManifest_sharedUserId, 0); if (str != null &amp;&amp; str.length() &gt; 0) &#123; String nameError = validateName(str, true, false); if (nameError != null &amp;&amp; !\"android\".equals(pkgName)) &#123; outError[0] = \"&lt;manifest&gt; specifies bad sharedUserId name \\\"\" + str + \"\\\": \" + nameError; mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_SHARED_USER_ID; return null; &#125; //è®¾ç½®å…±äº«idåè¡¨ç¤ºè¦å’Œå…¶å®ƒåº”ç”¨å…±äº«ä¸€ä¸ªid pkg.mSharedUserId = str.intern(); pkg.mSharedUserLabel = sa.getResourceId( com.android.internal.R.styleable.AndroidManifest_sharedUserLabel, 0); &#125; //... while ((type = parser.next()) != XmlPullParser.END_DOCUMENT &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123; if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123; continue; &#125; String tagName = parser.getName(); if (tagName.equals(\"application\")) &#123; //... //è¿›ä¸€æ­¥è§£æapplicationé¡¹çš„å†…å®¹ if (!parseBaseApplication(pkg, res, parser, attrs, flags, outError)) &#123; return null; &#125; //... &#125; else if (tagName.equals(\"uses-permission\")) &#123; //è·å–ç”³è¯·çš„æƒé™ if (!parseUsesPermission(pkg, res, parser, attrs)) &#123; return null; &#125; &#125; //...&#125; return pkg; &#125; ä¸€ä¸ªåº”ç”¨å¯ä»¥ç”³è¯·å¤šä¸ªæƒé™ï¼Œåº”ç”¨æƒé™æ˜¯å’Œç”¨æˆ·ç»„IDå¯¹åº”çš„ã€‚åº”ç”¨ç”³è¯·æƒé™å°±æ˜¯è·å¾—è¯¥ç”¨æˆ·ç»„idçš„è¿‡ç¨‹ã€‚ 1.13framework/base/core/java/android/content/pm/PackageParser.java1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859private boolean parseBaseApplication(Package owner, Resources res, XmlPullParser parser, AttributeSet attrs, int flags, String[] outError) throws XmlPullParserException, IOException &#123; final int innerDepth = parser.getDepth(); int type; while ((type = parser.next()) != XmlPullParser.END_DOCUMENT &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123; if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123; continue; &#125; String tagName = parser.getName(); //è§£æå‡ºactivity if (tagName.equals(\"activity\")) &#123; Activity a = parseActivity(owner, res, parser, attrs, flags, outError, false, owner.baseHardwareAccelerated); if (a == null) &#123; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; &#125; owner.activities.add(a); &#125; else if (tagName.equals(\"receiver\")) &#123; //è§£æå‡ºreceiver Activity a = parseActivity(owner, res, parser, attrs, flags, outError, true, false); if (a == null) &#123; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; &#125; owner.receivers.add(a); &#125; else if (tagName.equals(\"service\")) &#123; //è§£æservice Service s = parseService(owner, res, parser, attrs, flags, outError); if (s == null) &#123; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; &#125; owner.services.add(s); &#125; else if (tagName.equals(\"provider\")) &#123; //è§£æprovider Provider p = parseProvider(owner, res, parser, attrs, flags, outError); if (p == null) &#123; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; &#125; owner.providers.add(p); &#125; &#125; //... return true; &#125; 1.14 ä¸‹é¢æ­¥éª¤ç¬¼ç»Ÿè®²ä¸€ä¸‹åˆ°è¿™é‡Œï¼ŒPackageManagerServiceå·²ç»è§£æå®Œæˆä¸€ä¸ªapkæ–‡ä»¶ã€‚ä¸‹é¢å›åˆ°1.9 scanPackageLIä¸­ï¼Œç»§ç»­ä¸‹é¢çš„å·¥ä½œã€‚1.9æ­¥ä¸­ä¼šè°ƒç”¨é‡è½½å‡½æ•°scanPackageLIç»§ç»­è§£æè·å¾—çš„packageã€‚é‡è½½å‡½æ•°ä¼šè°ƒç”¨scanPackageDirtyLIæ¥åˆ†æpackageã€‚ è¿™ä¸€æ­¥ä¼šä¸ºpackageåˆ†é…idï¼Œå½“ç„¶è¯¥packageå¯èƒ½ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå…±äº«idã€‚é¦–å…ˆï¼Œæ¯ä¸ªpackageä¿¡æ¯ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªPackageSettingå¯¹è±¡ä¸­ï¼Œç„¶åå°†å…¶æ”¾åˆ°mPackagesè¿™ä¸ªHashMapä¸­ã€‚ å› ä¸ºåœ¨å‰é¢æ­¥éª¤ä¸­å·²ç»ä»ä¸Šä¸€æ¬¡å®‰è£…çš„åº”ç”¨ä¿¡æ¯ä¸­è¯»å–äº†ä¸€äº›packageä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦å…ˆåœ¨HashMapä¸­ç¡®å®šä¸€ä¸‹è¿™ä¸ªæ–°è§£æçš„åº”ç”¨æ˜¯å¦æ˜¯å·²ç»åœ¨mPackagesä¸­ã€‚å¦‚æœå·²ç»å­˜åœ¨ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè€åº”ç”¨ï¼Œå°±ç›´æ¥å°†PackageSetting è¿”å›ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™æ–°å»ºä¸€ä¸ªPackageSettingï¼Œä¸‹é¢å¼€å§‹ä¸ºå®ƒåˆ†é…uidï¼š 1. ä½¿ç”¨å…±äº«idã€‚å°†pkgçš„uidè®¾ç½®ä¸ºæƒ³è¦å…±äº«çš„uidã€‚ 2. ä½¿ç”¨åŸæ¥çš„uidã€‚ç¦ç”¨çš„ç³»ç»Ÿç¨‹åºä½¿ç”¨å®ƒåŸæ¥çš„uidã€‚ 3. ä½¿ç”¨æ–°çš„uidã€‚åˆ›å»ºä¸€ä¸ªæ–°çš„uidç»™pkgã€‚ 4. ä½¿ç”¨first application uidã€‚æ‰€æœ‰åº”ç”¨ä½¿ç”¨åŒä¸€ä¸ªuidã€‚ ä¸‹é¢æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä¸ºæ–°çš„åº”ç”¨åˆ†é…æ–°uidã€‚mUserIdsç®¡ç†äº†æ‰€æœ‰çš„åˆ†é…ç»™ç”¨æˆ·çš„uidï¼Œè¿™é‡Œä¼šåœ¨è§„å®šçš„èŒƒå›´å†…æ‰¾åˆ°ä¸€ä¸ªuidåˆ†é…ã€‚ åˆ°æ­¤ä¸ºæ­¢ï¼Œæ‰€æœ‰çš„å®‰è£…äº†åº”ç”¨éƒ½å­˜åœ¨PackageManagerServiceçš„mPackagesä¸­ï¼Œä¸‹é¢éœ€è¦ä¾æ¬¡ä¸ºè¿™äº›åº”ç”¨åˆ†é…æƒé™ã€‚åœ¨è®¾å¤‡/system/etc/permissions/platform.xmlæ–‡ä»¶ä¸­ï¼Œè¡¨è¿°äº†è¯¥è®¾å¤‡çš„èµ„æºè®¿é—®æƒé™åˆ—è¡¨ã€‚å¦‚ï¼š 123&lt;permission name=\"android.permission.BLUETOOTH\" &gt; &lt;group gid=\"net_bt\" /&gt;&lt;/permission gidæŒ‡æ˜äº†è¯¥èµ„æºæƒé™æ‰€åœ¨çš„ç”¨æˆ·ç»„ï¼Œå½“ç„¶ä¸€ä¸ªæƒé™å¯ä»¥æ‹¥æœ‰å¤šä¸ªç”¨æˆ·ç»„ã€‚åº”ç”¨è·å–æƒé™å°±æ˜¯åŠ å…¥ç›¸åº”çš„ç”¨æˆ·ç»„ã€‚Packageçš„ç”³è¯·çš„æƒé™å·²ç»ä¿å­˜åˆ°å®ƒå¯¹åº”çš„PackageSettingå¯¹è±¡ä¸­ï¼Œå¦‚æœå½“å‰packageä½¿ç”¨çš„æ˜¯å…±äº«uidï¼Œåˆ™å®ƒè·å¾—æƒé™ä¸å®ƒå…±äº«çš„linuxç”¨æˆ·çš„èµ„æºæƒé™ç›¸åŒã€‚å¯¹äºæœ‰è‡ªå·±ç‹¬ç«‹uidçš„åº”ç”¨ï¼Œå®ƒä¼šé¦–å…ˆè·å¾—ä¸€ç»„é»˜è®¤çš„ç”¨æˆ·æƒé™ï¼Œè¿™æ˜¯æ‰€æœ‰åº”ç”¨éƒ½å…·æœ‰çš„åŸºæœ¬æƒé™ã€‚ç„¶åä¼šä¸€ä¸€éªŒè¯åº”ç”¨ç”³è¯·çš„æƒé™æ˜¯å¦åˆæ³•ï¼Œå¦‚æœåˆæ³•ï¼Œåˆ™ä¼šä¸ºå…¶å¢åŠ è¯¥é¡¹æƒé™ã€‚ ç°åœ¨ï¼Œåº”ç”¨å·²ç»è¢«å®‰è£…ã€åˆ†é…uidå’Œåˆ†é…æƒé™ï¼Œæ¥ä¸‹æ¥éœ€è¦å°†è¿™äº›åº”ç”¨çš„ä¿¡æ¯ä¿å­˜ä¸‹æ¥ä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨ã€‚ä¿å­˜çš„ä½ç½®å°±æ˜¯/data/system/packages.xmlã€‚æ³¨æ„ï¼Œåœ¨ä¿å­˜uidæ—¶ï¼ŒuserIdå’ŒsharedUserIdåªèƒ½æœ‰ä¸€ä¸ªã€‚ Androidç³»ç»Ÿå°±æ˜¯é€šè¿‡ç”¨æˆ·idå’Œç”¨æˆ·ç»„idæ¥é™åˆ¶åº”ç”¨çš„èµ„æºè®¿é—®æƒé™ï¼Œé˜²æ­¢ç ´åå…¶å®ƒåº”ç”¨çš„æ•°æ®ã€‚åˆ†é…çš„uidå’Œgidä¼šåœ¨åˆ›å»ºåº”ç”¨è¿›ç¨‹æ—¶ä½¿ç”¨ï¼Œæ˜¯è¯¥è¿›ç¨‹åœ¨ç‰¹å®šçš„ç”¨æˆ·ç»„ä¸‹è¿è¡Œã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(16):Androidåº”ç”¨çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æ¨¡å‹","date":"2017-02-14T06:53:14.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-16-Androidåº”ç”¨çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æ¨¡å‹/","text":"è¯»ä¹¦ä¸å®œæ‹–æ²“ 0. èƒŒæ™¯Androidåº”ç”¨çš„ä¸»çº¿ç¨‹ä¸ºActivityThreadï¼Œåœ¨ç¬¬ï¼ˆ10ï¼‰ç« å·²ç»è®²è¿‡ï¼Œå®ƒä¸»è¦è´Ÿè´£å¤„ç†ç•Œé¢äº‹ä»¶ï¼Œæ‰€ä»¥å¼€å‘è€…åº”è¯¥é¿å…åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†è€—æ—¶çš„ä»»åŠ¡ã€‚ä¸ºäº†å‡è½»ä¸»çº¿ç¨‹çš„è´Ÿæ‹…ï¼Œå¼€å‘è€…åº”è¯¥å¯ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†è€—æ—¶çš„ä»»åŠ¡ã€‚åœ¨Androidä¸­å¯ä»¥åˆ›å»ºå¤šç§çº¿ç¨‹ï¼Œæœ‰çš„çº¿ç¨‹å¯ä»¥æœ‰è‡ªå·±çš„æ¶ˆæ¯å¾ªç¯ï¼Œæœ‰çš„çº¿ç¨‹åˆ™å¯ä»¥å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯æ¥ä½¿å¾—ç•Œé¢å‘ç”Ÿæ”¹å˜ã€‚ ##1. ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯ åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼šActivityManagerServiceçº¿ç¨‹è¯·æ±‚Zygoteè¿›ç¨‹åˆ›å»ºåº”ç”¨è¿›ç¨‹ï¼›Zygoteé€šè¿‡forkæ¥åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹å°†ActivityThreadçš„mainä½œä¸ºå…¥å£è¿›å…¥Looperå¾ªç¯ï¼›Looperä¼šè°ƒç”¨é™æ€æˆå‘˜å‡½æ•°prepareMainLooperåˆ›å»ºä¸€ä¸ªLooperå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨è¯¥åº”ç”¨è¿›ç¨‹ä¸­ï¼Œè¯¥æ–¹æ³•åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ã€‚ 2. å­çº¿ç¨‹HandlerThreadAndroidåº”ç”¨ä¸­ï¼Œåˆ›å»ºå­çº¿ç¨‹å¯ä»¥å’Œjavaæ¡Œé¢åº”ç”¨ä¸€æ ·ï¼Œåˆ›å»ºä¸€ä¸ªThreadå­ç±»ï¼Œå®ç°runå‡½æ•°ï¼Œç„¶åstartå³å¯ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼æ˜¯æ²¡æœ‰æ¶ˆæ¯å¾ªç¯çš„ï¼Œæ˜¯ä¸€ç§æ¯”è¾ƒç®€å•çš„æ–¹æ³•ã€‚ å¦ä¸€ç§åˆ™æ˜¯ä½¿ç”¨Androidå®šåˆ¶ç‰ˆçš„Threadâ€“HandlerThreadã€‚HanlderThre adçš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå®Œå…¨å¯ä»¥æ¨¡ä»¿å®ƒå®ç°ä¸€ä¸ªè‡ªå·±çš„å¸¦æœ‰æ¶ˆæ¯å¾ªç¯çš„Threadï¼Œæˆ–è€…å®ç°ä¸€ä¸ªé›†æˆHandlerThreadçš„å­ç±»ã€‚ frameworks/base/core/java/android/os/HandlerThread.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143/** * Handy class for starting a new thread that has a looper. The looper can then be * used to create handler classes. Note that start() must still be called. */public class HandlerThread extends Thread &#123; int mPriority; int mTid = -1; Looper mLooper; public HandlerThread(String name) &#123; super(name); mPriority = Process.THREAD_PRIORITY_DEFAULT; &#125; /** * Constructs a HandlerThread. * @param name * @param priority The priority to run the thread at. The value supplied must be from * &#123;@link android.os.Process&#125; and not from java.lang.Thread. */ public HandlerThread(String name, int priority) &#123; super(name); mPriority = priority; &#125; /** * Call back method that can be explicitly overridden if needed to execute some * setup before Looper loops. */ protected void onLooperPrepared() &#123; &#125; @Override public void run() &#123; mTid = Process.myTid(); //å‡†å¤‡äº†looper Looper.prepare(); synchronized (this) &#123; //è·å¾—è‡ªå·±çš„looper mLooper = Looper.myLooper(); notifyAll(); &#125; Process.setThreadPriority(mPriority); onLooperPrepared(); //è¿›å…¥æ¶ˆæ¯å¾ªç¯ Looper.loop(); mTid = -1; &#125; /** * This method returns the Looper associated with this thread. If this thread not been started * or for any reason is isAlive() returns false, this method will return null. If this thread * has been started, this method will block until the looper has been initialized. * @return The looper. */ public Looper getLooper() &#123; if (!isAlive()) &#123; return null; &#125; // If the thread has been started, wait until the looper has been created. synchronized (this) &#123; while (isAlive() &amp;&amp; mLooper == null) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; &#125; return mLooper; &#125; /** * Quits the handler thread's looper. * &lt;p&gt; * Causes the handler thread's looper to terminate without processing any * more messages in the message queue. * &lt;/p&gt;&lt;p&gt; * Any attempt to post messages to the queue after the looper is asked to quit will fail. * For example, the &#123;@link Handler#sendMessage(Message)&#125; method will return false. * &lt;/p&gt;&lt;p class=\"note\"&gt; * Using this method may be unsafe because some messages may not be delivered * before the looper terminates. Consider using &#123;@link #quitSafely&#125; instead to ensure * that all pending work is completed in an orderly manner. * &lt;/p&gt; * * @return True if the looper looper has been asked to quit or false if the * thread had not yet started running. * * @see #quitSafely */ public boolean quit() &#123; Looper looper = getLooper(); if (looper != null) &#123; looper.quit(); return true; &#125; return false; &#125; /** * Quits the handler thread's looper safely. * &lt;p&gt; * Causes the handler thread's looper to terminate as soon as all remaining messages * in the message queue that are already due to be delivered have been handled. * Pending delayed messages with due times in the future will not be delivered. * &lt;/p&gt;&lt;p&gt; * Any attempt to post messages to the queue after the looper is asked to quit will fail. * For example, the &#123;@link Handler#sendMessage(Message)&#125; method will return false. * &lt;/p&gt;&lt;p&gt; * If the thread has not been started or has finished (that is if * &#123;@link #getLooper&#125; returns null), then false is returned. * Otherwise the looper is asked to quit and true is returned. * &lt;/p&gt; * * @return True if the looper looper has been asked to quit or false if the * thread had not yet started running. */ public boolean quitSafely() &#123; Looper looper = getLooper(); if (looper != null) &#123; looper.quitSafely(); return true; &#125; return false; &#125; /** * Returns the identifier of this thread. See Process.myTid(). */ public int getThreadId() &#123; return mTid; &#125;&#125;``` ä»HandlerThreadçš„æºç å¯ä»¥çœ‹å‡ºå®ƒæä¾›äº†åŸºæœ¬çš„å¼€å…³åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•æ–¹ä¾¿ã€‚å…·ä½“å¦‚ä½•ä½¿ç”¨å¦‚ä¸‹ï¼šé¦–å…ˆå®ä¾‹åŒ–ä¸€ä¸ªHandlerThreadå¯¹è±¡ï¼Œç„¶åå¯åŠ¨è¿™ä¸ªthreadã€‚```javaHandlerThread handleThread = new HandlerThread(\"Handler Thread\");//ç„¶åå¯åŠ¨å®ƒï¼Œå› ä¸ºHandlerThreadæ˜¯Threadçš„å­ç±»ï¼Œæ‰€ä»¥å¯åŠ¨æ–¹æ³•å¹¶æ— å·®å¼‚handleThread.start(); ç„¶ååˆ›å»ºä¸€ä¸ªå®ç°äº†Runnableæ¥å£çš„ç±»ã€‚ 12345678public class ThreadTask implements Runnable&#123; public ThreadTask()&#123; &#125; //é‡å†™è¯¥æ–¹æ³• public void run()&#123; //ä½ çš„ä»»åŠ¡ &#125;&#125; åˆ›å»ºä¸€ä¸ªRunnableçš„å®ä¾‹å¯¹è±¡ï¼Œç„¶åä¸¢ç»™HandleThreadæ¥å¤„ç†ã€‚ 12345ThreadTask threadTask = new ThreadTask();//ä¸ºHandlerThreadçš„Looperåˆ›å»ºä¸€ä¸ªHandlerHandler handler = new Handler(handlerThread.getLooper);//é€šè¿‡Handlerå°†ä»»åŠ¡ç»™HandlerThreadæ¥æ‰§è¡Œhandler.post(threadTask); åœ¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†åˆ°è¯¥ä»»åŠ¡æ—¶ï¼ŒthreadTaskçš„runå‡½æ•°å°±ä¼šè¢«è°ƒç”¨æ‰§è¡Œã€‚ 3. å¼‚æ­¥ä»»åŠ¡AsyncTaskä¸€ä¸ªAsyncTaskçš„ä¾‹å­ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950private class MyTask extends AsyncTask&lt;String, Integer, String&gt; &#123; //è¿™ä¸€æ­¥æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨çš„ //onPreExecuteæ–¹æ³•ç”¨äºåœ¨æ‰§è¡Œåå°ä»»åŠ¡å‰åšä¸€äº›UIæ“ä½œ @Override protected void onPreExecute() &#123; Log.i(TAG, \"onPreExecute() called\"); textView.setText(\"loading...\"); &#125; //è¿™ä¸€æ­¥æ˜¯å¼‚æ­¥çº¿ç¨‹çš„ä¸»è¦è¿‡ç¨‹ //doInBackgroundæ–¹æ³•å†…éƒ¨æ‰§è¡Œåå°ä»»åŠ¡,ä¸å¯åœ¨æ­¤æ–¹æ³•å†…ä¿®æ”¹UI @Override protected String doInBackground(String... params) &#123; Log.i(TAG, \"doInBackground(Params... params) called\"); //... return new String(baos.toByteArray(), \"gb2312\"); &#125; //è¿™ä¸€æ­¥æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ //onProgressUpdateæ–¹æ³•ç”¨äºæ›´æ–°è¿›åº¦ä¿¡æ¯ @Override protected void onProgressUpdate(Integer... progresses) &#123; Log.i(TAG, \"onProgressUpdate(Progress... progresses) called\"); progressBar.setProgress(progresses[0]); textView.setText(\"loading...\" + progresses[0] + \"%\"); &#125; //ä¸»çº¿ç¨‹è°ƒç”¨ //onPostExecuteæ–¹æ³•ç”¨äºåœ¨æ‰§è¡Œå®Œåå°ä»»åŠ¡åæ›´æ–°UI,æ˜¾ç¤ºç»“æœ @Override protected void onPostExecute(String result) &#123; Log.i(TAG, \"onPostExecute(Result result) called\"); textView.setText(result); execute.setEnabled(true); cancel.setEnabled(false); &#125; //ä¸»çº¿ç¨‹è°ƒç”¨ //onCancelledæ–¹æ³•ç”¨äºåœ¨å–æ¶ˆæ‰§è¡Œä¸­çš„ä»»åŠ¡æ—¶æ›´æ”¹UI @Override protected void onCancelled() &#123; Log.i(TAG, \"onCancelled() called\"); textView.setText(\"cancelled\"); progressBar.setProgress(0); execute.setEnabled(true); cancel.setEnabled(false); &#125; &#125; å­çº¿ç¨‹å¦‚æœæƒ³å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œåˆ™éœ€è¦é€šè¿‡ä¸»çº¿ç¨‹çš„Handlerã€‚è¿™é‡ŒAsyncTaskè¿è¡Œäºå­çº¿ç¨‹ï¼Œä½†æ˜¯æ— éœ€Handlerä¹Ÿå¯ä»¥å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚AsyncTaskç±»çš„å…·ä½“å®ç°å¦‚ä¸‹ã€‚ frameworks/base/core/java/android/os/AsyncTask.java :1234567891011121314151617181920212223242526272829303132333435363738394041424344public abstract class AsyncTask&lt;Params, Progress, Result&gt; &#123; //... //è´Ÿè´£åˆ›å»ºçº¿ç¨‹ï¼Œæ”¾å…¥sPoolWorkQueueä¸­ private static final ThreadFactory sThreadFactory = new ThreadFactory() &#123; private final AtomicInteger mCount = new AtomicInteger(1); public Thread newThread(Runnable r) &#123; return new Thread(r, \"AsyncTask #\" + mCount.getAndIncrement()); &#125; &#125;; //ä»»åŠ¡é˜Ÿåˆ— //å¦‚æœé˜Ÿåˆ—å·²ç©ºï¼Œåˆ™è¯•å›¾è·å–ä»»åŠ¡çš„çº¿ç¨‹åˆ™ä¼šé˜»å¡ //å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¯•å›¾å‘å…¶ä¸­åŠ å…¥ä»»åŠ¡çš„çº¿ç¨‹ä¹Ÿä¼šé˜»å¡ private static final BlockingQueue&lt;Runnable&gt; sPoolWorkQueue = new LinkedBlockingQueue&lt;Runnable&gt;(128); /** * An &#123;@link Executor&#125; that can be used to execute tasks in parallel. * ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç”¨æ¥æ‰§è¡ŒsPoolWorkQueueä¸­çš„ä»»åŠ¡ï¼Œä¸‹é¢çœ‹å…¶å¦‚ä½•æ‰§è¡Œçº¿ç¨‹ * è¿™é‡Œè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ç­‰å‚æ•° */ public static final Executor THREAD_POOL_EXECUTOR = new ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE, TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory); /** * An &#123;@link Executor&#125; that executes tasks one at a time in serial * order. This serialization is global to a particular process. * è¯¥çº¿ç¨‹æ‰§è¡Œå™¨æ˜¯é¡ºåºæ‰§è¡Œ */ public static final Executor SERIAL_EXECUTOR = new SerialExecutor(); private static final int MESSAGE_POST_RESULT = 0x1; private static final int MESSAGE_POST_PROGRESS = 0x2; private static volatile Executor sDefaultExecutor = SERIAL_EXECUTOR; //åˆ›å»ºå½“å‰çº¿ç¨‹çš„ä¸€ä¸ªhandlerï¼Œå¦‚ä¸»çº¿ç¨‹ private static InternalHandler sHandler; private final WorkerRunnable&lt;Params, Result&gt; mWorker; private final FutureTask&lt;Result&gt; mFuture; //...&#125; sThreadFactoryï¼ŒsPoolWorkQueueå’ŒTHREAD_POOL_EXECUTORéƒ½æ˜¯å…¨å±€é™æ€å˜é‡ã€‚åœ¨ä¸€ä¸ªAppè¿›ç¨‹ä¸­ï¼Œå› æ­¤ï¼Œæ‰€æœ‰ä½¿ç”¨AsyncTaskçš„å¼‚æ­¥çº¿ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™æ ·å¯ä»¥é¿å…åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ± å ç”¨èµ„æºã€‚ ThreadPoolExecutoråœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼šæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©æ˜¯å¦åˆ›å»ºçº¿ç¨‹ï¼Œå…·ä½“å¦‚ä¸‹ï¼š çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œæ–°æ·»åŠ çš„ä»»åŠ¡ã€‚ å¦‚æœå¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™ sPoolWorkQueueæœªæ»¡ï¼Œåˆ™å°†æ–°ä»»åŠ¡ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ å¦‚æœå·²æ»¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œæ–°çš„ä»»åŠ¡ å¦‚æœçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°å·²ç»å¤§äº/ç­‰äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦‚æœé˜Ÿåˆ—ä¸æ»¡ï¼Œåˆ™æ”¾å…¥é˜Ÿåˆ—ï¼›å¦‚æœå·²æ»¡ï¼Œåˆ™æ‹’ç»æ–°ä»»åŠ¡ã€‚ InternalHandlerç±»çš„å®ä¾‹å¯¹è±¡sHandleræ˜¯åˆ›å»ºAsyncTaskçš„çº¿ç¨‹çš„Handlerï¼Œè¿™é‡Œå‡è®¾æ˜¯ä¸»çº¿ç¨‹ã€‚ frameworks/base/core/java/android/os/AsyncTask.java :123456789101112131415161718192021222324private static class InternalHandler extends Handler &#123; public InternalHandler() &#123; super(Looper.getMainLooper()); &#125; @SuppressWarnings(&#123;\"unchecked\", \"RawUseOfParameterizedType\"&#125;) @Override public void handleMessage(Message msg) &#123; //è¿™ä¸ªå‡½æ•°æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj; switch (msg.what) &#123; case MESSAGE_POST_RESULT: // There is only one result //å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸåå‘é€ç»“æœï¼Œè¿™é‡Œå¤„ç†è¿™ä¸ªç»“æœ result.mTask.finish(result.mData[0]); break; case MESSAGE_POST_PROGRESS: //å¼‚æ­¥ä»»åŠ¡å®è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨publishProgressæ¥å‘å¸ƒä¸­é—´ç»“æœ //è¿™ä¸€æ­¥å°±æ˜¯ä¸»çº¿ç¨‹å¤„ç†è¯¥ä¸­é—´ç»“æœ result.mTask.onProgressUpdate(result.mData); break; &#125; &#125; &#125; å…¶ä¸­resultæ˜¯ä¸€ä¸ªAsyncTaskResultï¼Œé‡Œé¢ä¿å­˜äº†ç»“æœä¿¡æ¯å’Œå…¶å¯¹åº”çš„AsyncTaskã€‚ frameworks/base/core/java/android/os/AsyncTask.java :12345678910@SuppressWarnings(&#123;\"RawUseOfParameterizedType\"&#125;)private static class AsyncTaskResult&lt;Data&gt; &#123; final AsyncTask mTask; final Data[] mData; AsyncTaskResult(AsyncTask task, Data... data) &#123; mTask = task; mData = data; &#125;&#125; WorkerRunnableç±»çš„å®ä¾‹mWorkerå®ç°å¦‚ä¸‹ï¼Œä¿å­˜äº†å¼‚æ­¥ä»»åŠ¡çš„è¾“å…¥æ•°æ®ï¼š frameworks/base/core/java/android/os/AsyncTask.java :123private static abstract class WorkerRunnable&lt;Params, Result&gt; implements Callable&lt;Result&gt; &#123; Params[] mParams;&#125; äº†è§£äº†AsyncTaskçš„æˆå‘˜å˜é‡åï¼Œä¸‹é¢çœ‹ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åˆ›å»ºçš„å®Œæ•´è¿‡ç¨‹ã€‚ 3.1 AsyncTaskçš„æ„é€ å‡½æ•°frameworks/base/core/java/android/os/AsyncTask.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960 /** * Creates a new asynchronous task. This constructor must be invoked on the UI thread. * çœ‹æ¥AsyncTaskåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºå•Šï¼ */ public AsyncTask() &#123; //è¿™é‡Œå®ç°äº†ä¸€ä¸ªWorkerRunnableçš„åŒ¿åç±»ï¼ŒåŒæ—¶å®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡mWorker //è¿™é‡Œé¢å°è£…äº†æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡ mWorker = new WorkerRunnable&lt;Params, Result&gt;() &#123; //å¼‚æ­¥çº¿ç¨‹é‡Œæ‰§è¡Œçš„ä»»åŠ¡ public Result call() throws Exception &#123; mTaskInvoked.set(true); Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND); //noinspection unchecked //è¿™é‡Œæœ‰ç”¨æˆ·å®šä¹‰çš„æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡ Result result = doInBackground(mParams); Binder.flushPendingCommands(); return postResult(result); &#125; &#125;; //åˆå°†mWorkerå°è£…å¦‚FutureTaskï¼ŒåŒæ ·å°è£…äº†è¦æ‰§è¡Œçš„ä»»åŠ¡ mFuture = new FutureTask&lt;Result&gt;(mWorker) &#123; @Override protected void done() &#123; try &#123; postResultIfNotInvoked(get()); &#125; catch (InterruptedException e) &#123; android.util.Log.w(LOG_TAG, e); &#125; catch (ExecutionException e) &#123; throw new RuntimeException(\"An error occurred while executing doInBackground()\", e.getCause()); &#125; catch (CancellationException e) &#123; postResultIfNotInvoked(null); &#125; &#125; &#125;; &#125;``` ### 3.2 AsyncTaskçš„æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡ŒAsyncTaskæ—¶ï¼Œéœ€è¦è°ƒç”¨executeæ¥æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œè¯¥æ–¹æ³•åˆä¼šè°ƒç”¨å¦‚ä¸‹å‡½æ•°æ¥æ‰§è¡Œä»»åŠ¡ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯executeå‡½æ•°æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œå¼‚æ­¥ä»»åŠ¡è¿˜æ²¡å¼€å§‹ã€‚*frameworks/base/core/java/android/os/AsyncTask.java* :```java @MainThread public final AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec, Params... params) &#123; //... mStatus = Status.RUNNING; //åœ¨ä¸»çº¿ç¨‹é‡Œè¿è¡Œæ‰§è¡Œå‰çš„ä»»åŠ¡ onPreExecute(); mWorker.mParams = params; //execæ˜¯ä¸€ä¸ªSerialExecute exec.execute(mFuture); return this; &#125; SerialExecutoræ‰§è¡Œå™¨çš„æ‰§è¡Œè¿‡ç¨‹ã€‚frameworks/base/core/java/android/os/AsyncTask.java :1234567891011121314151617181920212223242526272829private static class SerialExecutor implements Executor &#123; final ArrayDeque&lt;Runnable&gt; mTasks = new ArrayDeque&lt;Runnable&gt;(); Runnable mActive; public synchronized void execute(final Runnable r) &#123; //æŠŠmFutureå°è£…å…¥Runnableï¼Œç„¶åæ”¾åœ¨é˜Ÿåˆ—mTasksä¸­ mTasks.offer(new Runnable() &#123; public void run() &#123; try &#123; r.run(); &#125; finally &#123; //åœ¨ç»“æŸè¯¥ä»»åŠ¡ä¹‹å‰ï¼ŒæŠŠé˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ªä»»åŠ¡æ”¾å…¥çº¿ç¨‹æ±  scheduleNext(); &#125; &#125; &#125;); if (mActive == null) &#123; //å¼€å§‹æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ scheduleNext(); &#125; &#125; protected synchronized void scheduleNext() &#123; if ((mActive = mTasks.poll()) != null) &#123; //ç¬¬ä¸€ä¸ªä»»åŠ¡æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œ THREAD_POOL_EXECUTOR.execute(mActive); &#125; &#125; &#125; åˆ°è¿™é‡Œå·²ç»å°†ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± æ¥å¯åŠ¨ï¼Œç”¨æˆ·å®šä¹‰çš„doInBackgroundå·²ç»å¼€å§‹è¿è¡Œã€‚ 3.3 å¼‚æ­¥çº¿ç¨‹å‘é€æ¶ˆæ¯å¼‚æ­¥çº¿ç¨‹å¯ä»¥é€šè¿‡publishProgresså‘é€æ¶ˆæ¯ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š12345678@WorkerThread protected final void publishProgress(Progress... values) &#123; if (!isCancelled()) &#123; //è·å¾—ä¸»çº¿ç¨‹çš„handler--sHandlerï¼Œé€šè¿‡å®ƒå‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯ getHandler().obtainMessage(MESSAGE_POST_PROGRESS, new AsyncTaskResult&lt;Progress&gt;(this, values)).sendToTarget(); &#125; &#125; ä¸»çº¿ç¨‹é€šè¿‡sHandlerçš„handleMessageå‡½æ•°æ¥å¤„ç†è¯¥æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨ç”¨æˆ·è‡ªå·±å®ç°çš„onProgressUpdateå‡½æ•°æ¥å®ç°UIçš„æ›´æ–°ã€‚ 3.4 å¼‚æ­¥ä»»åŠ¡ç»“æŸåœ¨å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åï¼Œä¼šè°ƒç”¨FutureTaskçš„doneå‡½æ•°æ¥å¤„ç†ç»“æŸäº‹ä»¶ã€‚è¿™é‡Œä¸»è¦å¤„ç†çš„å°±æ˜¯å¼‚æ­¥ä»»åŠ¡å¤„ç†å®Œæˆåï¼Œæœ€åçš„è¿”å›å€¼ã€‚æœ€åçš„ç»“æœé€šè¿‡å¦‚ä¸‹å‡½æ•°å‘é€ç»™ä¸»çº¿ç¨‹ã€‚ 1234567private Result postResult(Result result) &#123; @SuppressWarnings(\"unchecked\") Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT, new AsyncTaskResult&lt;Result&gt;(this, result)); message.sendToTarget(); return result; &#125; å‰é¢å·²ç»è®²è¿‡ï¼Œä¸»çº¿ç¨‹ä¼šè°ƒç”¨handleré‡Œçš„result.mTask.finish(result.mData[0])æ¥å¤„ç†ç»“æœã€‚finishå‡½æ•°å®ç°å¦‚ä¸‹ï¼š 12345678910private void finish(Result result) &#123; if (isCancelled()) &#123; //è¿™äº›éƒ½æ˜¯ç”¨æˆ·å¯ä»¥é‡å†™çš„ //æ¥å®ç°è‡ªå·±çš„åŠŸèƒ½ onCancelled(result); &#125; else &#123; onPostExecute(result); &#125; mStatus = Status.FINISHED;&#125; 4. æ€»ç»“è¿™é‡Œä¸»è¦ä»‹ç»äº†androidåº”ç”¨é‡Œçš„å‡ ç§çº¿ç¨‹çš„è¿è¡Œæœºåˆ¶ã€‚ æ™®é€šjavaçº¿ç¨‹Threadæ˜¯æœ€ç®€å•çš„ä¸€ç§æ–¹æ³•ï¼Œä½†æ˜¯æ¯”è¾ƒéš¾ç®¡ç†ï¼Œä¸ä¸»çº¿ç¨‹é€šä¿¡ä¸»è¦é handlerã€‚è€Œä¸”ï¼Œè¯¥ä¸­çº¿ç¨‹åªèƒ½å‘ä¸»çº¿ç¨‹å‘æ¶ˆæ¯ï¼Œè€Œä¸»çº¿ç¨‹æ— æ³•å‘å­çº¿ç¨‹å‘æ¶ˆæ¯ã€‚ HandlerThreadåˆ™æ˜¯å¯ä»¥æœ‰è‡ªå·±çš„looperå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°†ä»»åŠ¡å‘é€å…¥æ¶ˆæ¯é˜Ÿåˆ—æ¥å®ç°å¼‚æ­¥ä»»åŠ¡çš„å¤„ç†ï¼ŒåŒæ—¶è¿˜æ–¹ä¾¿ç®¡ç†ã€‚ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹å¯ä»¥é€šè¿‡å¯¹æ–¹çš„Handlerç›¸äº’å‘é€æ¶ˆæ¯ã€‚ AsyncTaskæ˜¯æ¯”è¾ƒé€‚ç”¨äºAndroidåº”ç”¨çš„ä¸€ç§å¼‚æ­¥ä»»åŠ¡å®ç°æ–¹å¼ã€‚è™½ç„¶å½’æ ¹ç»“åº•è¿˜æ˜¯é€šè¿‡handleræ¥å‘ä¸»è¿›ç¨‹å‘æ¶ˆæ¯ï¼Œä½†æ˜¯æ•´ä¸ªå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„åˆ’åˆ†å’Œç®¡ç†æ›´ä¸ºç§‘å­¦ï¼Œå±è”½äº†å†…éƒ¨å®ç°çš„å¤æ‚ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´ä¸ºç®€å•å®ç”¨çš„æ¥å£ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(15):Androidåº”ç”¨è¿›ç¨‹çš„å¯åŠ¨","date":"2017-02-14T06:46:42.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-15-Androidåº”ç”¨è¿›ç¨‹çš„å¯åŠ¨/","text":"è‡ªå·±å¼€å¿ƒå°±å¥½ï¼Œä½•å¿…ç®¡ä»–äººçƒ¦æ¼ 1. åº”ç”¨è¿›ç¨‹åˆ›å»ºActivityManagerServiceè´Ÿè´£ç®¡ç†åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºã€‚è¿™ä¸€èŠ‚ä¼šè®²è¿°å¦‚ä½•ä»ActivityManagerServiceç”³è¯·åˆ›å»ºä¸€ä¸ªappè¿›ç¨‹ï¼Œç„¶åä»zygoteå…‹éš†ä¸€ä¸ªè¿›ç¨‹çš„è¿‡ç¨‹ã€‚ 1.1 ActivityManagerService.startProcessLockedframeworks/base/services/core/java/com/android/server/am/ActivityManagerService.java :12345678910111213141516171819202122232425262728 private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs) &#123;//... try &#123; //... int uid = app.uid; int[] gids = null; int mountExternal = Zygote.MOUNT_EXTERNAL_NONE; //... app.gids = gids; app.requiredAbi = requiredAbi; app.instructionSet = instructionSet; // Start the process. It will either succeed and return a result containing // the PID of the new process, or else throw a RuntimeException. boolean isActivityProcess = (entryPoint == null); //Androidåº”ç”¨çš„è¿›ç¨‹å…¥å£android.app.ActivityThread if (entryPoint == null) entryPoint = \"android.app.ActivityThread\"; //å¯åŠ¨appè¿›ç¨‹ Process.ProcessStartResult startResult = Process.start(entryPoint, app.processName, uid, uid, gids, debugFlags, mountExternal, app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet, app.info.dataDir, entryPointArgs); //... &#125; catch (RuntimeException e) &#123; // XXX do better error recovery. //... &#125; &#125; 1.2 Process.startè¿™ä¸€æ­¥ç›´æ¥äº¤ç»™ä¸‹ä¸€æ­¥æ¥å¤„ç†ã€‚ 1.3 Process.startViaZygoteframeworks/base/core/java/android/os/Process.java :1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586/** * Starts a new process via the zygote mechanism. * * @param processClass Class name whose static main() to run * @param niceName 'nice' process name to appear in ps * @param uid a POSIX uid that the new process should setuid() to * @param gid a POSIX gid that the new process shuold setgid() to * @param gids null-ok; a list of supplementary group IDs that the * new process should setgroup() to. * @param debugFlags Additional flags. * @param targetSdkVersion The target SDK version for the app. * @param seInfo null-ok SELinux information for the new process. * @param abi the ABI the process should use. * @param instructionSet null-ok the instruction set to use. * @param appDataDir null-ok the data directory of the app. * @param extraArgs Additional arguments to supply to the zygote process. * @return An object that describes the result of the attempt to start the process. * @throws ZygoteStartFailedEx if process start failed for any reason */private static ProcessStartResult startViaZygote(final String processClass, final String niceName, final int uid, final int gid, final int[] gids, int debugFlags, int mountExternal, int targetSdkVersion, String seInfo, String abi, String instructionSet, String appDataDir, String[] extraArgs) throws ZygoteStartFailedEx &#123; synchronized(Process.class) &#123; ArrayList&lt;String&gt; argsForZygote = new ArrayList&lt;String&gt;(); //è®¾ç½®ä¸€äº›åŸºæœ¬å‚æ•° // --runtime-args, --setuid=, --setgid=, // and --setgroups= must go first argsForZygote.add(\"--runtime-args\"); argsForZygote.add(\"--setuid=\" + uid); argsForZygote.add(\"--setgid=\" + gid); //... argsForZygote.add(\"--target-sdk-version=\" + targetSdkVersion); // --setgroups is a comma-separated list if (gids != null &amp;&amp; gids.length &gt; 0) &#123; StringBuilder sb = new StringBuilder(); sb.append(\"--setgroups=\"); int sz = gids.length; for (int i = 0; i &lt; sz; i++) &#123; if (i != 0) &#123; sb.append(','); &#125; sb.append(gids[i]); &#125; argsForZygote.add(sb.toString()); &#125; if (niceName != null) &#123; argsForZygote.add(\"--nice-name=\" + niceName); &#125; if (seInfo != null) &#123; argsForZygote.add(\"--seinfo=\" + seInfo); &#125; if (instructionSet != null) &#123; argsForZygote.add(\"--instruction-set=\" + instructionSet); &#125; if (appDataDir != null) &#123; argsForZygote.add(\"--app-data-dir=\" + appDataDir); &#125; argsForZygote.add(processClass); if (extraArgs != null) &#123; for (String arg : extraArgs) &#123; argsForZygote.add(arg); &#125; &#125; //ç»§ç»­äº¤ç»™ä¸‹ä¸€æ­¥å¤„ç†ï¼Œè¿™é‡Œé€šè¿‡å‡½æ•°openZygoteSocketIfNeededå’ŒZygoteå»ºç«‹äº†è¿æ¥ return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote); &#125;&#125; å‡½æ•°openZygoteSocketIfNeededä¼šåœ¨zygoteåœ°å€ä¸Šå»ºç«‹ä¸€ä¸ªsocketè¿æ¥ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªinput streamå’Œoutput streamã€‚ 1.4 Process.zygoteSendArgsAndGetResultframeworks/base/core/java/android/os/Process.java :12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * Sends an argument list to the zygote process, which starts a new child * and returns the child's pid. Please note: the present implementation * replaces newlines in the argument list with spaces. * * @throws ZygoteStartFailedEx if process start failed for any reason */private static ProcessStartResult zygoteSendArgsAndGetResult( ZygoteState zygoteState, ArrayList&lt;String&gt; args) throws ZygoteStartFailedEx &#123; try &#123; /** * See com.android.internal.os.ZygoteInit.readArgumentList() * Presently the wire format to the zygote process is: * a) a count of arguments (argc, in essence) * b) a number of newline-separated argument strings equal to count * * After the zygote process reads these it will write the pid of * the child or -1 on failure, followed by boolean to * indicate whether a wrapper process was used. */ final BufferedWriter writer = zygoteState.writer; final DataInputStream inputStream = zygoteState.inputStream; //ç›´æ¥ç”¨å·²ç»å»ºç«‹å¥½çš„input stream writer.write(Integer.toString(args.size())); writer.newLine(); //ä¾æ¬¡å†™å…¥æ¯ä¸ªå‚æ•° int sz = args.size(); for (int i = 0; i &lt; sz; i++) &#123; String arg = args.get(i); if (arg.indexOf('\\n') &gt;= 0) &#123; throw new ZygoteStartFailedEx( \"embedded newlines not allowed\"); &#125; writer.write(arg); writer.newLine(); &#125; writer.flush(); //è·å–åˆ›å»ºè¿›ç¨‹çš„ç»“æœï¼Œå¦‚æœè¿›ç¨‹pidå°äº0ï¼Œåˆ™è¯´æ˜æ²¡æœ‰åˆ›å»ºæˆåŠŸ // Should there be a timeout on this? ProcessStartResult result = new ProcessStartResult(); result.pid = inputStream.readInt(); if (result.pid &lt; 0) &#123; throw new ZygoteStartFailedEx(\"fork() failed\"); &#125; result.usingWrapper = inputStream.readBoolean(); return result; &#125; catch (IOException ex) &#123; zygoteState.close(); throw new ZygoteStartFailedEx(ex); &#125;&#125; ###1.5 ZygoteInit.runSelectLoopActivityManagerServiceé€šè¿‡socketå°†å‚æ•°ä¼ é€’ç»™zygoteè¿›ç¨‹åï¼Œåˆ›å»ºappè¿›ç¨‹çš„ä»»åŠ¡å°±äº¤ç»™zygoteç»§ç»­å®ç°äº†ã€‚è®©æˆ‘ä»¬å†æ¬¡å›åˆ°zygoteçš„å¾ªç¯ä¸­ã€‚ frameworks/base/core/java/com/android/internal/os/ZygoteInit.java ï¼š123456789101112131415161718192021222324252627282930313233343536373839private static void runSelectLoop(String abiList) throws MethodAndArgsCaller &#123; ArrayList&lt;FileDescriptor&gt; fds = new ArrayList&lt;FileDescriptor&gt;(); ArrayList&lt;ZygoteConnection&gt; peers = new ArrayList&lt;ZygoteConnection&gt;(); fds.add(sServerSocket.getFileDescriptor()); peers.add(null); while (true) &#123; StructPollfd[] pollFds = new StructPollfd[fds.size()]; for (int i = 0; i &lt; pollFds.length; ++i) &#123; pollFds[i] = new StructPollfd(); pollFds[i].fd = fds.get(i); pollFds[i].events = (short) POLLIN; &#125; try &#123; Os.poll(pollFds, -1); &#125; catch (ErrnoException ex) &#123; throw new RuntimeException(\"poll failed\", ex); &#125; for (int i = pollFds.length - 1; i &gt;= 0; --i) &#123; if ((pollFds[i].revents &amp; POLLIN) == 0) &#123; continue; &#125; if (i == 0) &#123; //ActivityManagerServiceå’Œæˆ‘å»ºç«‹è¿æ¥ ZygoteConnection newPeer = acceptCommandPeer(abiList); peers.add(newPeer); fds.add(newPeer.getFileDesciptor()); &#125; else &#123; //å¤„ç†ActivityManagerServiceå‘é€çš„è¯·æ±‚ boolean done = peers.get(i).runOnce(); if (done) &#123; peers.remove(i); fds.remove(i); &#125; &#125; &#125; &#125;&#125; 1.6 ZygoteConnection.runOnceframeworks/base/core/java/com/android/internal/os/ZygoteConnection.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778/** * Reads one start command from the command socket. If successful, * a child is forked and a &#123;@link ZygoteInit.MethodAndArgsCaller&#125; * exception is thrown in that child while in the parent process, * the method returns normally. On failure, the child is not * spawned and messages are printed to the log and stderr. Returns * a boolean status value indicating whether an end-of-file on the command * socket has been encountered. * * @return false if command socket should continue to be read from, or * true if an end-of-file has been encountered. * @throws ZygoteInit.MethodAndArgsCaller trampoline to invoke main() * method in child process */boolean runOnce() throws ZygoteInit.MethodAndArgsCaller &#123; String args[]; Arguments parsedArgs = null; FileDescriptor[] descriptors; try &#123; //è¯»å–ä¼ å…¥çš„å‚æ•° args = readArgumentList(); descriptors = mSocket.getAncillaryFileDescriptors(); &#125; catch (IOException ex) &#123; //... &#125; if (args == null) &#123; // EOF reached. closeSocket(); return true; &#125; /** the stderr of the most recent request, if avail */ PrintStream newStderr = null; if (descriptors != null &amp;&amp; descriptors.length &gt;= 3) &#123; newStderr = new PrintStream( new FileOutputStream(descriptors[2])); &#125; int pid = -1; FileDescriptor childPipeFd = null; FileDescriptor serverPipeFd = null; try &#123; //... //forkä¸€ä¸ªè¿›ç¨‹ pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids, parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo, parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet, parsedArgs.appDataDir); &#125; catch (ErrnoException ex) &#123; //... &#125; try &#123; if (pid == 0) &#123; // in child IoUtils.closeQuietly(serverPipeFd); serverPipeFd = null; //åœ¨å­è¿›ç¨‹ä¸­è¿›ä¸€æ­¥å¤„ç† handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr); // should never get here, the child is expected to either // throw ZygoteInit.MethodAndArgsCaller or exec(). return true; &#125; else &#123; // in parent...pid of &lt; 0 means failure IoUtils.closeQuietly(childPipeFd); childPipeFd = null; return handleParentProc(pid, descriptors, serverPipeFd, parsedArgs); &#125; &#125; finally &#123; IoUtils.closeQuietly(childPipeFd); IoUtils.closeQuietly(serverPipeFd); &#125;&#125; 1.7 ZygoteConnection.handleChildProcframeworks/base/core/java/com/android/internal/os/ZygoteConnection.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * Handles post-fork setup of child proc, closing sockets as appropriate, * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller * if successful or returning if failed. * * @param parsedArgs non-null; zygote args * @param descriptors null-ok; new file descriptors for stdio if available. * @param pipeFd null-ok; pipe for communication back to Zygote. * @param newStderr null-ok; stream to use for stderr until stdio * is reopened. * * @throws ZygoteInit.MethodAndArgsCaller on success to * trampoline to code that invokes static main. */ private void handleChildProc(Arguments parsedArgs, FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr) throws ZygoteInit.MethodAndArgsCaller &#123; /** * By the time we get here, the native code has closed the two actual Zygote * socket connections, and substituted /dev/null in their place. The LocalSocket * objects still need to be closed properly. */ closeSocket(); ZygoteInit.closeServerSocket(); if (parsedArgs.niceName != null) &#123; Process.setArgV0(parsedArgs.niceName); &#125; // End of the postFork event.//... if (parsedArgs.invokeWith != null) &#123; WrapperInit.execApplication(parsedArgs.invokeWith, parsedArgs.niceName, parsedArgs.targetSdkVersion, VMRuntime.getCurrentInstructionSet(), pipeFd, parsedArgs.remainingArgs); &#125; else &#123; //ç»§ç»­åˆå§‹åŒ–è¿›ç¨‹ RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, null /* classLoader */); &#125; &#125; 1.8 RuntimeInit.zygoteInitè¿™é‡Œå¼€å§‹è°ƒç”¨android.app.ActivityThreadçš„mainå‡½æ•°ã€‚ frameworks/base/core/java/com/android/internal/os/RuntimeInit.java :12345678910111213public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader) throws ZygoteInit.MethodAndArgsCaller &#123; if (DEBUG) Slog.d(TAG, \"RuntimeInit: Starting application from zygote\"); Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"RuntimeInit\"); redirectLogStreams(); commonInit(); //å¯åŠ¨Binderçº¿ç¨‹æ± ï¼Œå°†åœ¨ä¸‹é¢è¯¦ç»†åˆ†ænativeéƒ¨åˆ† nativeZygoteInit(); //è¿™é‡Œè°ƒç”¨çš„ä¸å†æ˜¯systemçš„mainå‡½æ•°äº†ï¼Œè€Œæ˜¯ActivityThreadçš„mainå‡½æ•°ï¼Œå°†åœ¨ä¸‹é¢ç« èŠ‚åˆ†æ applicationInit(targetSdkVersion, argv, classLoader);&#125; åˆ°è¿™é‡Œä¸€ä¸ªAndroid appçš„è¿›ç¨‹å°±å·²ç»åˆ›å»ºå¥½äº†ã€‚ 2. Binderçº¿ç¨‹æ± çš„å¯åŠ¨Appè¿›ç¨‹åˆ›å»ºè¿‡ç¨‹ä¸­ä¼šå»ºç«‹ä¸€ä¸ªBinderçº¿ç¨‹æ± ï¼Œç”¨æ¥å¤„ç†è¿›ç¨‹é—´çš„Binderé€šä¿¡ã€‚ 2.1 RuntimeInit.nativeZygoteInitframeworks/base/core/jni/AndroidRuntime.cpp : è¿™é‡Œç›´æ¥è°ƒç”¨äº†ä¸€ä¸ªAndroidRuntimeå…¨å±€å¯¹è±¡gCurRuntimeçš„onZygoteInitå‡½æ•°ã€‚è¿™ä¸ªå…¨å±€å¯¹è±¡æ˜¯åœ¨zygoteè¿›ç¨‹ä¸­åˆ›å»ºäº†ï¼Œè¿™é‡Œæ˜¯é€šè¿‡å¤åˆ¶zygoteçš„è¿›ç¨‹è·å¾—çš„è¯¥å¯¹è±¡ã€‚ 2.2 AppRuntime.onZygoteInitframeworks/base/cmds/app_main.cpp :123456virtual void onZygoteInit() &#123; sp&lt;ProcessState&gt; proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-&gt;startThreadPool(); &#125; 2.3 ProcessState.startThreadPoolå¯åŠ¨Binderçº¿ç¨‹æ± çº¿ç¨‹ï¼Œ appè¿›ç¨‹ä»è€Œå…·æœ‰è¿›ç¨‹é—´binderé€šä¿¡çš„èƒ½åŠ›ã€‚frameworks/native/libs/binder/PorcessState.cpp :123456789void ProcessState::startThreadPool()&#123; AutoMutex _l(mLock); if (!mThreadPoolStarted) &#123; mThreadPoolStarted = true; //å¯åŠ¨ä¸€ä¸ªBinderçº¿ç¨‹æ± çš„çº¿ç¨‹ï¼Œä»è€Œå¯ä»¥æ”¯æŒBinderè¿›ç¨‹é—´é€šä¿¡äº† spawnPooledThread(true); &#125;&#125; 3. Appè¿›ç¨‹æ¶ˆæ¯å¾ªç¯çš„åˆ›å»ºåœ¨1.8ä¸­ï¼ŒRuntimeInitè°ƒç”¨å‡½æ•°applicationInitæ¥å¯åŠ¨ActivityThreadçš„mainå‡½æ•°ã€‚ 3.1 RuntimeInit.applicationInitè®¾ç½®äº†heapçš„ç›®æ ‡ä½¿ç”¨ç‡ï¼Œç„¶åè°ƒç”¨äº†ä¸‹ä¸€æ­¥çš„é™æ€å‡½æ•°ã€‚ 3.2 RuntimeInit.invokeStaticMainè¿™ä¸€æ­¥ç»ˆäºå¼€å§‹ä»è¿™ä¸ªåˆ›å»ºçš„æ–°è¿›ç¨‹ä¸­è°ƒç”¨ActivityThreadçš„mainå‡½æ•°äº†ã€‚ä¸è¿‡è°ƒç”¨çš„æ–¹å¼æœ‰ç‚¹å¥‡æ€ªï¼Œè¿™é‡Œæ˜¯é€šè¿‡æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸çš„å½¢å¼ï¼Œæ¥æ¸…ç©ºå½“å‰æ ˆä¸­çš„ç§¯å‹çš„å‡½æ•°ï¼Œç›´åˆ°å›é€€åˆ°ZygoteInit.mainå‡½æ•°ä¸­ã€‚å› ä¸ºè¯¥appè¿›ç¨‹æ˜¯ä»zygoteè¿›ç¨‹ä¸­forkå‡ºæ¥çš„ï¼Œæ‰€ä»¥æ ˆçš„å†…å®¹ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å¯ä»¥ä¼šé€€åˆ°ZygoteInit.mainå‡½æ•°ã€‚ frameworks/base/core/java/com/android/internal/os/RuntimeInit.java :12345678910111213141516171819202122232425262728293031323334353637/** * Invokes a static \"main(argv[]) method on class \"className\". * Converts various failing exceptions into RuntimeExceptions, with * the assumption that they will then cause the VM instance to exit. * * @param className Fully-qualified class name * @param argv Argument vector for main() * @param classLoader the classLoader to load &#123;@className&#125; with */ private static void invokeStaticMain(String className, String[] argv, ClassLoader classLoader) throws ZygoteInit.MethodAndArgsCaller &#123; Class&lt;?&gt; cl; try &#123; //é€šè¿‡ç±»ååŠ è½½è¯¥ç±»ï¼Œè¿™é‡Œå°±æ˜¯ActivityThreadç±» cl = Class.forName(className, true, classLoader); &#125; catch (ClassNotFoundException ex) &#123; //... &#125; Method m; try &#123; //è·å¾—ActivityThreadçš„mainæ–¹æ³• m = cl.getMethod(\"main\", new Class[] &#123; String[].class &#125;); &#125; catch (NoSuchMethodException ex) &#123; //... &#125;//... /* * This throw gets caught in ZygoteInit.main(), which responds * by invoking the exception's run() method. This arrangement * clears up all the stack frames that were required in setting * up the process. * è¿™é‡Œé€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥å›åˆ°stackä¸­çš„æŸä¸€ä¸ªå‡½æ•°çš„åšæ³•è¿˜çœŸæ˜¯å¤´ä¸€æ¬¡è§ */ throw new ZygoteInit.MethodAndArgsCaller(m, argv); &#125; 3.3 ZygoteInit.mainåœ¨Zygoteè¿›ç¨‹é‡Œï¼Œä¼šè¿›å…¥æ— é™çš„å¾ªç¯ã€‚ä½†æ˜¯ï¼Œåœ¨appè¿›ç¨‹é‡Œï¼Œè¿›å…¥è¿™ä¸ªå¾ªç¯æ˜¯æ²¡æœ‰ä½œç”¨ï¼Œæ‰€ä»¥éœ€è¦è·³å‡ºå¾ªç¯ï¼Œç»§ç»­å‰è¿›ã€‚123456789101112131415161718public static void main(String argv[]) &#123; try &#123; //... Log.i(TAG, \"Accepting command socket connections\"); //Zygoteè¿›ç¨‹ä¼šä¸€ç›´åœ¨å¾ªç¯ä¸­ //è™½ç„¶appè¿›ç¨‹åœ¨è¿™ä¸ªå¾ªç¯é‡Œåˆ›å»ºï¼Œä½†æ˜¯å®ƒéœ€è¦è·³å‡ºè¿™ä¸ªå¾ªç¯ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ runSelectLoop(abiList); closeServerSocket(); &#125; catch (MethodAndArgsCaller caller) &#123; //æ‰€ä»¥appè¿›ç¨‹å°±è·³åˆ°äº†è¿™é‡Œ caller.run(); &#125; catch (RuntimeException ex) &#123; Log.e(TAG, \"Zygote died with exception\", ex); closeServerSocket(); throw ex; &#125;&#125; 3.4 MethodAndArgsCaller.runè¿™é‡Œå°±æ˜¯å›åˆ°ZygoteInit.mainé‡Œè°ƒç”¨ActivityThreadçš„mainå‡½æ•°ï¼Œç›®çš„å°±æ˜¯æ¸…ç†å‡†å¤‡appè¿›ç¨‹ä¸­å½¢æˆçš„è°ƒç”¨å †æ ˆã€‚ 12345678public void run() &#123; try &#123; //å°±æ˜¯è°ƒç”¨äº†ActivityThreadçš„mainå‡½æ•° mMethod.invoke(null, new Object[] &#123; mArgs &#125;); &#125; catch (IllegalAccessException ex) &#123; //... &#125;&#125; ActivityThread.mainè¿™é‡Œå°±æ˜¯å›åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„å‰§æƒ…äº†ï¼Œä¸å†èµ˜è¿°ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(14):Zygoteå’ŒSystemè¿›ç¨‹çš„å¯åŠ¨","date":"2017-02-14T06:33:16.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-14-Zygoteå’ŒSystemè¿›ç¨‹çš„å¯åŠ¨/","text":"å†ä¸å­¦ä¹ æˆ‘ä»¬å°±è€äº† 0. Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼ŸZygoteæ˜¯è¿›ç¨‹å­µåŒ–å™¨ï¼ŒAndroidç³»ç»Ÿä¸­å…¶ä»–æœåŠ¡è¿›ç¨‹éƒ½æ˜¯æ‹·è´äºå®ƒã€‚Zygoteåœ¨è®¾è®¡æ¨¡å¼ä¸­å¯¹åº”äºprototypeï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥é€šè¿‡æ‹·è´Zygoteæ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚ 1. Zygoteè„šæœ¬å¯åŠ¨åœ¨å¼€æœºæ—¶ï¼Œinitè¿›ç¨‹ä¼šè°ƒç”¨å¦‚ä¸‹è„šæœ¬å¯åŠ¨è¿›ç¨‹ã€‚ system/core/rootdir/init.zygote32_64.rc :12345678service zygote /system/bin/app_process32 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote class main socket zygote stream 660 root system onrestart write /sys/android_power/request_state wake onrestart write /sys/power/state on onrestart restart media onrestart restart netd writepid /dev/cpuset/foreground/tasks serviceè¡¨æ˜è¯¥è¿›ç¨‹æ˜¯ä½œä¸ºä¸€ä¸ªæœåŠ¡æ¥å¯åŠ¨çš„ï¼Œ--start-system-serveræŒ‡æ˜äº†è¯¥è¿›ç¨‹å¯åŠ¨åï¼Œéœ€è¦å¯åŠ¨systemæœåŠ¡ã€‚è¯¥è¿›ç¨‹å¯¹åº”çš„ç«¯å£æƒé™660ï¼Œåå­—ä¸ºzygoteï¼Œå…¶å®ƒè¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥ç«¯å£å’Œå®ƒè¿›è¡Œé€šä¿¡ã€‚ 1.1 initè¿›ç¨‹åˆ›å»ºæ–°çš„app_processåœ¨initè¿›ç¨‹ä¸­ï¼Œå¯åŠ¨serviceè¿›ç¨‹çš„è¿‡ç¨‹å¦‚ä¸‹ã€‚ system/core/init/init.cpp :1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556void service_start(struct service *svc, const char *dynamic_args) //... NOTICE(\"Starting service '%s'...\\n\", svc-&gt;name); //åˆ›å»ºæ–°è¿›ç¨‹ pid_t pid = fork(); //åœ¨æ–°å»ºçš„è¿›ç¨‹ä¸­ if (pid == 0) &#123; struct socketinfo *si; struct svcenvinfo *ei; char tmp[32]; int fd, sz; //ä¾æ¬¡åˆ›å»ºserviceä¸­çš„socket for (si = svc-&gt;sockets; si; si = si-&gt;next) &#123; int socket_type = ( !strcmp(si-&gt;type, \"stream\") ? SOCK_STREAM : (!strcmp(si-&gt;type, \"dgram\") ? SOCK_DGRAM : SOCK_SEQPACKET)); //åˆ›å»ºsocket int s = create_socket(si-&gt;name, socket_type, si-&gt;perm, si-&gt;uid, si-&gt;gid, si-&gt;socketcon ?: scon); if (s &gt;= 0) &#123; //å‘å¸ƒsocket publish_socket(si-&gt;name, s); &#125; &#125; //... //å°†å‚æ•°æ‹·è´è¿›svcç»“æ„ä½“ä¸­ if (!dynamic_args) &#123; //æ²¡æœ‰å‚æ•°çš„æƒ…å†µ //svc-&gt;args[0]å¯¹åº”äº/system/bin/app_process32 //ä¸‹ä¸€æ­¥ä¼šåŠ è½½è¯¥ç¨‹åºï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•° if (execve(svc-&gt;args[0], (char**) svc-&gt;args, (char**) ENV) &lt; 0) &#123; ERROR(\"cannot execve('%s'): %s\\n\", svc-&gt;args[0], strerror(errno)); &#125; &#125; else &#123; char *arg_ptrs[INIT_PARSER_MAXARGS+1]; int arg_idx = svc-&gt;nargs; char *tmp = strdup(dynamic_args); char *next = tmp; char *bword; /* Copy the static arguments */ memcpy(arg_ptrs, svc-&gt;args, (svc-&gt;nargs * sizeof(char *))); while((bword = strsep(&amp;next, \" \"))) &#123; arg_ptrs[arg_idx++] = bword; if (arg_idx == INIT_PARSER_MAXARGS) break; &#125; arg_ptrs[arg_idx] = NULL; execve(svc-&gt;args[0], (char**) arg_ptrs, (char**) ENV); &#125; _exit(127); &#125; //...&#125; 1.2 socketåˆ›å»ºå’Œå‘å¸ƒä¸‹é¢ä¸»è¦åˆ†æä¸€ä¸‹create_socketå’Œpublish_socketä¸¤ä¸ªå‡½æ•°ï¼Œæ¥è¯´æ˜zygoteçš„socketå¦‚ä½•åˆ›å»ºçš„ã€‚ åˆ›å»ºsocketã€‚system/core/init/util.cpp :1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071/* * create_socket - creates a Unix domain socket in ANDROID_SOCKET_DIR * (\"/dev/socket\") as dictated in init.rc. This socket is inherited by the * daemon. We communicate the file descriptor's value via the environment * variable ANDROID_SOCKET_ENV_PREFIX&lt;name&gt; (\"ANDROID_SOCKET_foo\"). */int create_socket(const char *name, int type, mode_t perm, uid_t uid, gid_t gid, const char *socketcon)&#123; struct sockaddr_un addr; int fd, ret; char *filecon; if (socketcon) setsockcreatecon(socketcon); //åˆ›å»ºä¸€ä¸ªsocket fd = socket(PF_UNIX, type, 0); if (fd &lt; 0) &#123; ERROR(\"Failed to open socket '%s': %s\\n\", name, strerror(errno)); return -1; &#125; if (socketcon) setsockcreatecon(NULL); //åˆ›å»ºä¸€ä¸ªsocketåœ°å€addr memset(&amp;addr, 0 , sizeof(addr)); addr.sun_family = AF_UNIX; //è®¾ç½®åœ°å€çš„æ–‡ä»¶ä½ç½®ï¼Œè¿™é‡Œå°±æ˜¯/dev/socket/zygote snprintf(addr.sun_path, sizeof(addr.sun_path), ANDROID_SOCKET_DIR\"/%s\", name); ret = unlink(addr.sun_path); if (ret != 0 &amp;&amp; errno != ENOENT) &#123; ERROR(\"Failed to unlink old socket '%s': %s\\n\", name, strerror(errno)); goto out_close; &#125; filecon = NULL; if (sehandle) &#123; ret = selabel_lookup(sehandle, &amp;filecon, addr.sun_path, S_IFSOCK); if (ret == 0) setfscreatecon(filecon); &#125; //å°†æƒ³è¦å­˜å‚¨socketçš„æ–‡ä»¶åœ°å€addrå’Œsocketæ–‡ä»¶æè¿°ç¬¦fdç»‘å®šèµ·æ¥ ret = bind(fd, (struct sockaddr *) &amp;addr, sizeof (addr)); if (ret) &#123; ERROR(\"Failed to bind socket '%s': %s\\n\", name, strerror(errno)); goto out_unlink; &#125; setfscreatecon(NULL); freecon(filecon); //è®¾ç½®ç”¨æˆ·ç»„root system chown(addr.sun_path, uid, gid); //è®¾ç½®æƒé™660 chmod(addr.sun_path, perm); INFO(\"Created socket '%s' with mode '%o', user '%d', group '%d'\\n\", addr.sun_path, perm, uid, gid); return fd;out_unlink: unlink(addr.sun_path);out_close: close(fd); return -1;&#125; å‘å¸ƒsocketã€‚1234567891011121314151617static void publish_socket(const char *name, int fd)&#123; //å‰ç¼€ä¸ºANDROID_SOCKET_ char key[64] = ANDROID_SOCKET_ENV_PREFIX; char val[64]; //æ‹¼æ¥å‡ºkey strlcpy(key + sizeof(ANDROID_SOCKET_ENV_PREFIX) - 1, name, sizeof(key) - sizeof(ANDROID_SOCKET_ENV_PREFIX)); //å°†fdå†™å…¥val snprintf(val, sizeof(val), \"%d\", fd); //å°†keyï¼Œvalueå†™å…¥ç¯å¢ƒå˜é‡ä¸­ï¼Œä»¥ä¾¿å…¶ä»–è¿›ç¨‹è®¿é—® add_environment(key, val); /* make sure we don't close-on-exec */ fcntl(fd, F_SETFD, 0);&#125; 2. Zygoteè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹Zygote è¿›ç¨‹çš„å¯åŠ¨ä»app_processçš„mainå‡½æ•°å¼€å§‹ã€‚ 2.1 app_process.mainåˆ¤æ–­éœ€è¦å¯åŠ¨çš„è¿›ç¨‹çš„ç§ç±»ã€‚ frameworks/base/cmds/app_process/app_main.cpp :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126int main(int argc, char* const argv[])&#123; //é’ˆå¯¹æ—§å†…æ ¸åšçš„å¤„ç†... //åˆ›å»ºAppRuntimeå¯¹è±¡ AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv)); // Process command line arguments // ignore argv[0] argc--; argv++; // Everything up to '--' or first non '-' arg goes to the vm. // // The first argument after the VM args is the \"parent dir\", which // is currently unused. // // After the parent dir, we expect one or more the following internal // arguments : // ä¸åŒçš„è¿›ç¨‹ç±»å‹ // --zygote : Start in zygote mode // --start-system-server : Start the system server. // --application : Start in application (stand alone, non zygote) mode. // --nice-name : The nice name for this process. // // For non zygote starts, these arguments will be followed by // the main class name. All remaining arguments are passed to // the main method of this class. // // For zygote starts, all remaining arguments are passed to the zygote. // main function. // // Note that we must copy argument string values since we will rewrite the // entire argument block when we apply the nice name to argv0. int i; for (i = 0; i &lt; argc; i++) &#123; if (argv[i][0] != '-') &#123; break; &#125; if (argv[i][1] == '-' &amp;&amp; argv[i][2] == 0) &#123; ++i; // Skip --. break; &#125; runtime.addOption(strdup(argv[i])); &#125; // Parse runtime arguments. Stop at first unrecognized option. bool zygote = false; bool startSystemServer = false; bool application = false; String8 niceName; String8 className; //åˆ¤æ–­éœ€è¦åˆ›å»ºä½•ç§ç±»å‹çš„è¿›ç¨‹ ++i; // Skip unused \"parent dir\" argument. while (i &lt; argc) &#123; const char* arg = argv[i++]; if (strcmp(arg, \"--zygote\") == 0) &#123; //è¿™é‡Œæ˜¯Zygoteè¿›ç¨‹ zygote = true; niceName = ZYGOTE_NICE_NAME; &#125; else if (strcmp(arg, \"--start-system-server\") == 0) &#123; //åŒæ—¶éœ€è¦å¼€å¯SystemServer startSystemServer = true; &#125; else if (strcmp(arg, \"--application\") == 0) &#123; application = true; &#125; else if (strncmp(arg, \"--nice-name=\", 12) == 0) &#123; niceName.setTo(arg + 12); &#125; else if (strncmp(arg, \"--\", 2) != 0) &#123; className.setTo(arg); break; &#125; else &#123; --i; break; &#125; &#125; Vector&lt;String8&gt; args; if (!className.isEmpty()) &#123; // We're not in zygote mode, the only argument we need to pass // to RuntimeInit is the application argument. // // The Remainder of args get passed to startup class main(). Make // copies of them before we overwrite them with the process name. args.add(application ? String8(\"application\") : String8(\"tool\")); runtime.setClassNameAndArgs(className, argc - i, argv + i); &#125; else &#123; // We're in zygote mode. maybeCreateDalvikCache(); if (startSystemServer) &#123; //ä½œä¸ºå‚æ•°ä¼ é€’ç»™Zygoteè¿›ç¨‹ args.add(String8(\"start-system-server\")); &#125; //... String8 abiFlag(\"--abi-list=\"); abiFlag.append(prop); args.add(abiFlag); // In zygote mode, pass all remaining arguments to the zygote // main() method. for (; i &lt; argc; ++i) &#123; args.add(String8(argv[i])); &#125; &#125; if (!niceName.isEmpty()) &#123; //è¿™é‡Œè¿›ç¨‹åå­—å°±æ˜¯zygote runtime.setArgv0(niceName.string()); set_process_name(niceName.string()); &#125; if (zygote) &#123; //å¯åŠ¨Zygoteï¼Œæ¥ä¸‹æ¥ä¼šä¸»è¦åˆ†æstartå‡½æ•° runtime.start(\"com.android.internal.os.ZygoteInit\", args, zygote); &#125; else if (className) &#123; runtime.start(\"com.android.internal.os.RuntimeInit\", args, zygote); &#125; else &#123; fprintf(stderr, \"Error: no class name or --zygote supplied.\\n\"); app_usage(); LOG_ALWAYS_FATAL(\"app_process: no class name or --zygote supplied.\"); return 10; &#125;&#125; 2.2 AndroidRuntime.startåˆ›å»ºè™šæ‹Ÿæœºï¼Œè¿è¡Œjavaå‡½æ•°ã€‚ frameworks/base/core/jni/AndroidRuntime.cpp :12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788/* * Start the Android runtime. This involves starting the virtual machine * and calling the \"static void main(String[] args)\" method in the class * named by \"className\". * * Passes the main function two arguments, the class name and the specified * options string. */void AndroidRuntime::start(const char* className, const Vector&lt;String8&gt;&amp; options, bool zygote)&#123; //åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºå®ä¾‹ /* start the virtual machine */ JniInvocation jni_invocation; jni_invocation.Init(NULL); JNIEnv* env; if (startVm(&amp;mJavaVM, &amp;env, zygote) != 0) &#123; return; &#125; onVmCreated(env); /* * Register android functions. */ //æ³¨å†ŒJNIæ–¹æ³• if (startReg(env) &lt; 0) &#123; ALOGE(\"Unable to register all android natives\\n\"); return; &#125; /* * å°†å‚æ•°è½¬åŒ–ä¸ºjavaå¯¹è±¡ * We want to call main() with a String array with arguments in it. * At present we have two arguments, the class name and an option string. * Create an array to hold them. */ jclass stringClass; jobjectArray strArray; jstring classNameStr; stringClass = env-&gt;FindClass(\"java/lang/String\"); assert(stringClass != NULL); strArray = env-&gt;NewObjectArray(options.size() + 1, stringClass, NULL); assert(strArray != NULL); classNameStr = env-&gt;NewStringUTF(className); assert(classNameStr != NULL); env-&gt;SetObjectArrayElement(strArray, 0, classNameStr); for (size_t i = 0; i &lt; options.size(); ++i) &#123; jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).string()); assert(optionsStr != NULL); env-&gt;SetObjectArrayElement(strArray, i + 1, optionsStr); &#125; /* * Start VM. This thread becomes the main thread of the VM, and will * not return until the VM exits. */ char* slashClassName = toSlashClassName(className); jclass startClass = env-&gt;FindClass(slashClassName); if (startClass == NULL) &#123; ALOGE(\"JavaVM unable to locate class '%s'\\n\", slashClassName); /* keep going */ &#125; else &#123; //æ‰¾åˆ°mainå‡½æ•° jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, \"main\", \"([Ljava/lang/String;)V\"); if (startMeth == NULL) &#123; ALOGE(\"JavaVM unable to find main() in '%s'\\n\", className); /* keep going */ &#125; else &#123; //è°ƒç”¨com.android.internal.os.ZygoteInitç±»çš„mainå‡½æ•° //å‚æ•°æ”¾åœ¨strArrayé‡Œ env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);#if 0 if (env-&gt;ExceptionCheck()) threadExitUncaughtException(env);#endif &#125; &#125; free(slashClassName); ALOGD(\"Shutting down VM\\n\"); if (mJavaVM-&gt;DetachCurrentThread() != JNI_OK) ALOGW(\"Warning: unable to detach main thread\\n\"); if (mJavaVM-&gt;DestroyJavaVM() != 0) ALOGW(\"Warning: VM did not shut down cleanly\\n\");&#125; 2.3 ZygoteInit.mainframeworks/base/core/java/com/android/internal/os/Zygoteinit.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public static void main(String argv[]) &#123; try &#123; //è§£æå‚æ•° RuntimeInit.enableDdms(); // Start profiling the zygote initialization. SamplingProfilerIntegration.start(); boolean startSystemServer = false; String socketName = \"zygote\"; String abiList = null; for (int i = 1; i &lt; argv.length; i++) &#123; if (\"start-system-server\".equals(argv[i])) &#123; startSystemServer = true; &#125; else if (argv[i].startsWith(ABI_LIST_ARG)) &#123; abiList = argv[i].substring(ABI_LIST_ARG.length()); &#125; else if (argv[i].startsWith(SOCKET_NAME_ARG)) &#123; socketName = argv[i].substring(SOCKET_NAME_ARG.length()); &#125; else &#123; throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); &#125; &#125; if (abiList == null) &#123; throw new RuntimeException(\"No ABI list supplied.\"); &#125; //æ³¨å†ŒSocketï¼Œåˆ›å»ºä¸€ä¸ªsocketæœåŠ¡ç«¯ registerZygoteSocket(socketName); //... // Do an initial gc to clean up after startup gcAndFinalize(); // Disable tracing so that forked processes do not inherit stale tracing tags from // Zygote. Trace.setTracingEnabled(false); if (startSystemServer) &#123; //å¯åŠ¨ç³»ç»ŸæœåŠ¡ startSystemServer(abiList, socketName); &#125; Log.i(TAG, \"Accepting command socket connections\"); //å¾ªç¯ç­‰å¾…å…¶ä»–æœåŠ¡å‘zygote socketå‘é€è¯·æ±‚ runSelectLoop(abiList); closeServerSocket(); &#125; catch (MethodAndArgsCaller caller) &#123; caller.run(); &#125; catch (RuntimeException ex) &#123; Log.e(TAG, \"Zygote died with exception\", ex); closeServerSocket(); throw ex; &#125; &#125; 2.4 ZygoteInit.registerZygoteSocketåˆ›å»ºäº†zygote socketçš„serverç«¯ã€‚ 123456789101112131415161718192021222324252627282930/** * Registers a server socket for zygote command connections * * @throws RuntimeException when open fails */ private static void registerZygoteSocket(String socketName) &#123; if (sServerSocket == null) &#123; int fileDesc; //æ‹¼æ¥å‡ºsocketåç§°ANDROID_SOCKET_zygote final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName; try &#123; //ç¯å¢ƒå˜é‡ä¸­åœ¨ä¸Šé¢å­˜å‚¨äº†è¯¥keyä¸‹å¯¹åº”çš„value String env = System.getenv(fullSocketName); //è·å–socketçš„æ–‡ä»¶æè¿°ç¬¦ fileDesc = Integer.parseInt(env); &#125; catch (RuntimeException ex) &#123; throw new RuntimeException(fullSocketName + \" unset or invalid\", ex); &#125; try &#123; FileDescriptor fd = new FileDescriptor(); fd.setInt$(fileDesc); //åˆ›å»ºsocket serverï¼Œå¹¶ä¸”ä¿ç•™åœ¨ä¸€ä¸ªé™æ€å˜é‡sServerSocketä¸­ sServerSocket = new LocalServerSocket(fd); &#125; catch (IOException ex) &#123; throw new RuntimeException( \"Error binding to local socket '\" + fileDesc + \"'\", ex); &#125; &#125; &#125; 2.5 ZygoteInit.startSystemServerä»zygoteä¸­forkä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å•ç‹¬å¤„ç†system serverã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748 /** * Prepare the arguments and fork for the system server process. */ private static boolean startSystemServer(String abiList, String socketName) throws MethodAndArgsCaller, RuntimeException &#123;//... /* Hardcoded command line to start the system server */ String args[] = &#123; \"--setuid=1000\", \"--setgid=1000\", \"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007\", \"--capabilities=\" + capabilities + \",\" + capabilities, \"--nice-name=system_server\", \"--runtime-args\", \"com.android.server.SystemServer\", //è¿™å°±æ˜¯System serverçš„ç±»å &#125;; ZygoteConnection.Arguments parsedArgs = null; int pid; try &#123; parsedArgs = new ZygoteConnection.Arguments(args); ZygoteConnection.applyDebuggerSystemProperty(parsedArgs); ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs); //ä»zygoteä¸­forkå‡ºä¸€ä¸ªè¿›ç¨‹ /* Request to fork the system server process */ pid = Zygote.forkSystemServer( parsedArgs.uid, parsedArgs.gid, parsedArgs.gids, parsedArgs.debugFlags, null, parsedArgs.permittedCapabilities, parsedArgs.effectiveCapabilities); &#125; catch (IllegalArgumentException ex) &#123; throw new RuntimeException(ex); &#125; /* For child process */ if (pid == 0) &#123; if (hasSecondZygote(abiList)) &#123; waitForSecondaryZygote(socketName); &#125; //åœ¨å­è¿›ç¨‹ä¸­å¯åŠ¨System server,åœ¨ç¬¬3èŠ‚ä¸­è¯¦ç»†åˆ†æ handleSystemServerProcess(parsedArgs); &#125;//çˆ¶è¿›ç¨‹è¿”å› return true; &#125; 2.6 ZygoteInit.runSelectLoopZygoteå¯åŠ¨æ— é™å¾ªç¯ï¼Œç­‰å¾…è¯·æ±‚ã€‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253 /** * Runs the zygote process's select loop. Accepts new connections as * they happen, and reads commands from connections one spawn-request's * worth at a time. * * @throws MethodAndArgsCaller in a child process when a main() should * be executed. */ private static void runSelectLoop(String abiList) throws MethodAndArgsCaller &#123; ArrayList&lt;FileDescriptor&gt; fds = new ArrayList&lt;FileDescriptor&gt;(); ArrayList&lt;ZygoteConnection&gt; peers = new ArrayList&lt;ZygoteConnection&gt;();//ä¸€ä¸ªzygote socketæ–‡ä»¶æè¿°ç¬¦ fds.add(sServerSocket.getFileDescriptor()); peers.add(null); while (true) &#123; //å°†ç°æœ‰çš„fdå…ˆå­˜å…¥pollFds StructPollfd[] pollFds = new StructPollfd[fds.size()]; for (int i = 0; i &lt; pollFds.length; ++i) &#123; pollFds[i] = new StructPollfd(); pollFds[i].fd = fds.get(i); pollFds[i].events = (short) POLLIN; &#125; try &#123; Os.poll(pollFds, -1); &#125; catch (ErrnoException ex) &#123; throw new RuntimeException(\"poll failed\", ex); &#125; //ä¸€æ¬¡å¾ªç¯æœ€å¤šè®©ä¸€ä¸ªpeeræ¥å…¥ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¤„ç†å¤šä¸ªpeerçš„è¯·æ±‚ for (int i = pollFds.length - 1; i &gt;= 0; --i) &#123; if ((pollFds[i].revents &amp; POLLIN) == 0) &#123; //æ˜¯å¦æœ‰è¯·æ±‚å†™å…¥ï¼Œæ²¡æœ‰å°±ç»§ç»­ continue; &#125; if (i == 0) &#123; //æœ‰äººåœ¨zygoteä¸Šå†™å…¥è¯·æ±‚ï¼Œè·å¾—è¯¥peer //è¿™ä¸€æ­¥åªæ˜¯peerå’Œzygoteå»ºç«‹è¿æ¥ï¼Œpeerè¿˜æœªå‘é€å…·ä½“è¯·æ±‚ ZygoteConnection newPeer = acceptCommandPeer(abiList); peers.add(newPeer); //å°†å…¶åŠ å…¥æ–‡ä»¶æè¿°ç¬¦fdsä¸­ï¼Œè¯¥peerä¼šå‘å…¶å¯¹åº”çš„fdå†™å…¥è¯·æ±‚ //è¿™ä¸€æ­¥ä¸ä¼šå¤„ç†ï¼Œå› ä¸ºè¯¥peeræ²¡æœ‰åœ¨pollFdsä¸­ fds.add(newPeer.getFileDesciptor()); &#125; else &#123; //æœ‰peerå‘å…¶fdå†™å…¥è¯·æ±‚,è¿™é‡Œå¼€å§‹å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå¤„ç†å®Œæ¯•ååˆ é™¤ boolean done = peers.get(i).runOnce(); if (done) &#123; peers.remove(i); fds.remove(i); &#125; &#125; &#125; &#125; &#125; 3. Systemè¿›ç¨‹çš„å¯åŠ¨æ¥ç€2.5ï¼ŒZygote forkå‡ºä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å¯åŠ¨System serverã€‚æ¥ä¸‹æ¥çœ‹åœ¨è¿™ä¸ªæ–°è¿›ç¨‹ä¸­å¦‚ä½•å¯åŠ¨çš„System serverã€‚ 3.1 ZygoteInit.handleSystemServerProcessframeworks/base/core/java/com/android/internal/os/ZygoteInit.java :12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455 /** * Finish remaining work for the newly forked system server process. */ private static void handleSystemServerProcess( ZygoteConnection.Arguments parsedArgs) throws ZygoteInit.MethodAndArgsCaller &#123; //å› ä¸ºforkäº†Zygoteçš„è¿›ç¨‹ï¼Œæ‰€ä»¥ä¼šå¤åˆ¶å®ƒçš„socket //SystemServerç”¨ä¸ç€è¿™ä¸ªsocketï¼Œå…ˆå…³äº†å†è¯´ closeServerSocket(); // set umask to 0077 so new files and directories will default to owner-only permissions. Os.umask(S_IRWXG | S_IRWXO);//è®¾ç½®è¿›ç¨‹å if (parsedArgs.niceName != null) &#123; Process.setArgV0(parsedArgs.niceName); &#125;//è·å–system serverç±»çš„è·¯å¾„ final String systemServerClasspath = Os.getenv(\"SYSTEMSERVERCLASSPATH\"); if (systemServerClasspath != null) &#123; performSystemServerDexOpt(systemServerClasspath); &#125; if (parsedArgs.invokeWith != null) &#123; String[] args = parsedArgs.remainingArgs; // If we have a non-null system server class path, we'll have to duplicate the // existing arguments and append the classpath to it. ART will handle the classpath // correctly when we exec a new process. if (systemServerClasspath != null) &#123; String[] amendedArgs = new String[args.length + 2]; amendedArgs[0] = \"-cp\"; amendedArgs[1] = systemServerClasspath; System.arraycopy(parsedArgs.remainingArgs, 0, amendedArgs, 2, parsedArgs.remainingArgs.length); &#125; WrapperInit.execApplication(parsedArgs.invokeWith, parsedArgs.niceName, parsedArgs.targetSdkVersion, VMRuntime.getCurrentInstructionSet(), null, args); &#125; else &#123; ClassLoader cl = null; if (systemServerClasspath != null) &#123; cl = new PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader()); Thread.currentThread().setContextClassLoader(cl); &#125; /* * è¿›ä¸€æ­¥å¯åŠ¨System server * Pass the remaining arguments to SystemServer. */ RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl); &#125; /* should never reach here */ &#125; 3.2 RuntimeInit.zygoteInitframeworks/base/core/java/com/android/internal/os/RuntimeInit.java :123456789101112131415161718192021222324252627/** * The main function called when started through the zygote process. This * could be unified with main(), if the native code in nativeFinishInit() * were rationalized with Zygote startup.&lt;p&gt; * * Current recognized args: * &lt;ul&gt; * &lt;li&gt; &lt;code&gt; [--] &amp;lt;start class name&amp;gt; &amp;lt;args&amp;gt; * &lt;/ul&gt; * * @param targetSdkVersion target SDK version * @param argv arg strings */public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader) throws ZygoteInit.MethodAndArgsCaller &#123; if (DEBUG) Slog.d(TAG, \"RuntimeInit: Starting application from zygote\"); Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"RuntimeInit\"); redirectLogStreams(); //åšä¸€äº›åŸºæœ¬çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚æ—¶é—´ã€logç­‰ commonInit(); //è¿›å…¥nativeéƒ¨åˆ†ï¼Œå°†æ¥ç« èŠ‚å†è®² nativeZygoteInit(); //è¿›ä¸€æ­¥å¯åŠ¨system applicationInit(targetSdkVersion, argv, classLoader);&#125; 3.3 RuntimeInit.applicationInitè¿™ä¸€æ­¥å¼€å§‹è°ƒç”¨SystemServerçš„mainå‡½æ•°ã€‚ frameworks/base/core/java/com/android/internal/os/RuntimeInit.java :123456789101112131415161718192021222324252627282930 private static void applicationInit(int targetSdkVersion, String[] argv, ClassLoader classLoader) throws ZygoteInit.MethodAndArgsCaller &#123; // If the application calls System.exit(), terminate the process // immediately without running any shutdown hooks. It is not possible to // shutdown an Android application gracefully. Among other things, the // Android runtime shutdown hooks close the Binder driver, which can cause // leftover running threads to crash before the process actually exits. nativeSetExitWithoutCleanup(true); // We want to be fairly aggressive about heap utilization, to avoid // holding on to a lot of memory that isn't needed. VMRuntime.getRuntime().setTargetHeapUtilization(0.75f); VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion); final Arguments args; try &#123; args = new Arguments(argv); &#125; catch (IllegalArgumentException ex) &#123; Slog.e(TAG, ex.getMessage()); // let the process exit return; &#125; // The end of of the RuntimeInit event (see #zygoteInit). Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);//å¯åŠ¨éœ€è¦å¯åŠ¨çš„ç±»çš„mainå‡½æ•°ï¼Œè¿™é‡Œå°±æ˜¯com.android.server.SystemServer // Remaining arguments are passed to the start class's static main invokeStaticMain(args.startClass, args.startArgs, classLoader); &#125; 3.4 SystemServer.mainè¿™é‡Œç›´æ¥newäº†ä¸€ä¸ªSystemServerï¼Œç„¶åè°ƒç”¨å®ƒçš„runå‡½æ•°ã€‚ 3.5 SystemService.runè¿™ä¸€æ­¥å¼€å§‹ä¾æ¬¡å¯åŠ¨å„ç§serviceã€‚ frameworks/base/services/java/com/android/server/SystemServer.java :1234567891011121314151617181920212223242526272829303132333435363738394041 private void run() &#123; //... //è®¾ç½®ç³»ç»Ÿæ—¶é—´ã€è¯­è¨€ç­‰ if (!SystemProperties.get(\"persist.sys.language\").isEmpty()) &#123; final String languageTag = Locale.getDefault().toLanguageTag(); SystemProperties.set(\"persist.sys.locale\", languageTag); SystemProperties.set(\"persist.sys.language\", \"\"); SystemProperties.set(\"persist.sys.country\", \"\"); SystemProperties.set(\"persist.sys.localevar\", \"\"); &#125;//... //ä¸€äº›è™šæ‹Ÿæœºå†…å­˜ï¼Œå †æ ˆçš„è®¾ç½® //è¯¥çº¿ç¨‹å°±æ˜¯ä¸»çº¿ç¨‹ // Prepare the main looper thread (this thread). android.os.Process.setThreadPriority( android.os.Process.THREAD_PRIORITY_FOREGROUND); android.os.Process.setCanSelfBackground(false); Looper.prepareMainLooper();//...//åˆ›å»ºSystemServiceManager // Create the system service manager. mSystemServiceManager = new SystemServiceManager(mSystemContext); LocalServices.addService(SystemServiceManager.class, mSystemServiceManager); // Start services. try &#123; //å¼€å§‹ä¾æ¬¡å¯åŠ¨å„ç§æœåŠ¡ï¼Œä¸‹ä¸€èŠ‚è¯¦ç»†è§£é‡Š startBootstrapServices(); startCoreServices(); startOtherServices(); &#125; catch (Throwable ex) &#123; //... &#125; //æ°¸è¿œçš„å¾ªç¯.. // Loop forever. Looper.loop(); &#125; 3.6 å„ç§serviceå¯åŠ¨startBootstrapServicesè¿™é‡Œé¢å¯åŠ¨çš„æœåŠ¡æœ‰ï¼šInstallerï¼ŒActivityManagerServiceï¼ŒPowerManagerServiceï¼ŒLightsServiceï¼ŒDisplayManagerServiceï¼ŒPackageManagerServiceï¼ŒSensorServiceï¼ˆéå…·ä½“ï¼‰ã€‚ è¿™äº›serviceæœ‰çš„ä¼šåˆ›å»ºè‡ªå·±ç‹¬ç«‹çš„ServiceThreadï¼Œæ˜¯HandlerThreadçš„å­ç±»ï¼Œå®ƒä»¬æœ‰ç€è‡ªå·±çš„looperå¾ªç¯ã€‚startServiceå‡½æ•°å°†æ‰€æœ‰çš„serviceçš„å¯åŠ¨è¿‡ç¨‹ç»Ÿä¸€ç®¡ç†ï¼ŒæŠ½è±¡ä¸ºæ³¨å†Œã€å¯åŠ¨ä¸¤æ­¥éª¤ã€‚ frameworks/base/services/java/com/android/server/SystemServer.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869/** * Starts the small tangle of critical services that are needed to get * the system off the ground. These services have complex mutual dependencies * which is why we initialize them all in one place here. Unless your service * is also entwined in these dependencies, it should be initialized in one of * the other functions. */ private void startBootstrapServices() &#123; // Wait for installd to finish starting up so that it has a chance to // create critical directories such as /data/user with the appropriate // permissions. We need this to complete before we initialize other services. Installer installer = mSystemServiceManager.startService(Installer.class); // Activity manager runs the show. mActivityManagerService = mSystemServiceManager.startService( ActivityManagerService.Lifecycle.class).getService(); mActivityManagerService.setSystemServiceManager(mSystemServiceManager); mActivityManagerService.setInstaller(installer); // Power manager needs to be started early because other services need it. // Native daemons may be watching for it to be registered so it must be ready // to handle incoming binder calls immediately (including being able to verify // the permissions for those calls). mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class); // Now that the power manager has been started, let the activity manager // initialize power management features. mActivityManagerService.initPowerManagement(); // Manages LEDs and display backlight so we need it to bring up the display. mSystemServiceManager.startService(LightsService.class); // Display manager is needed to provide display metrics before package manager // starts up. mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class); // We need the default display before we can initialize the package manager. mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY); // Only run \"core\" apps if we're encrypting the device. String cryptState = SystemProperties.get(\"vold.decrypt\"); if (ENCRYPTING_STATE.equals(cryptState)) &#123; Slog.w(TAG, \"Detected encryption in progress - only parsing core apps\"); mOnlyCore = true; &#125; else if (ENCRYPTED_STATE.equals(cryptState)) &#123; Slog.w(TAG, \"Device encrypted - only parsing core apps\"); mOnlyCore = true; &#125; // Start the package manager. Slog.i(TAG, \"Package Manager\"); mPackageManagerService = PackageManagerService.main(mSystemContext, installer, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore); mFirstBoot = mPackageManagerService.isFirstBoot(); mPackageManager = mSystemContext.getPackageManager(); Slog.i(TAG, \"User Service\"); ServiceManager.addService(Context.USER_SERVICE, UserManagerService.getInstance()); // Initialize attribute cache used to cache resources from packages. AttributeCache.init(mSystemContext); // Set up the Application instance for the system process and get started. mActivityManagerService.setSystemProcess(); // The sensor service needs access to package manager service, app ops // service, and permissions service, therefore we start it after them. startSensorService(); &#125; startCoreServicesè¿™ä¸€æ­¥å¯åŠ¨çš„serivceæœ‰ï¼šBatteryServiceï¼ŒUsageStatsServiceï¼ŒWebViewUpdateServiceã€‚1234567891011121314151617/** * Starts some essential services that are not tangled up in the bootstrap process. */private void startCoreServices() &#123; // Tracks the battery level. Requires LightService. mSystemServiceManager.startService(BatteryService.class); // Tracks application usage stats. mSystemServiceManager.startService(UsageStatsService.class); mActivityManagerService.setUsageStatsManager( LocalServices.getService(UsageStatsManagerInternal.class)); // Update after UsageStatsService is available, needed before performBootDexOpt. mPackageManagerService.getUsageStatsIfNoPackageUsageInfo(); // Tracks whether the updatable WebView is in a ready state and watches for update installs. mSystemServiceManager.startService(WebViewUpdateService.class);&#125; startOtherServiceè¿™ä¸€æ­¥å¯åŠ¨serviceåˆå¤šåˆæ‚ï¼Œä¸»è¦æœ‰å¦‚ä¸‹è¿™äº›ï¼Œå…¶å®ƒè¿˜æœ‰ä¸å†ä¸€ä¸€åˆ—ä¸¾ã€‚ 1234567891011121314151617181920212223AccountManagerService accountManager = null; ContentService contentService = null; VibratorService vibrator = null; IAlarmManager alarm = null; IMountService mountService = null; NetworkManagementService networkManagement = null; NetworkStatsService networkStats = null; NetworkPolicyManagerService networkPolicy = null; ConnectivityService connectivity = null; NetworkScoreService networkScore = null; NsdService serviceDiscovery= null; WindowManagerService wm = null; UsbService usb = null; SerialService serial = null; NetworkTimeUpdateService networkTimeUpdater = null; CommonTimeManagementService commonTimeMgmtService = null; InputManagerService inputManager = null; TelephonyRegistry telephonyRegistry = null; ConsumerIrService consumerIr = null; AudioService audioService = null; MmsServiceBroker mmsService = null; EntropyMixer entropyMixer = null; CameraService cameraService = null; 4. æ€»ç»“å†™åˆ°è¿™é‡Œï¼Œæœ‰ç‚¹å‡Œä¹±ï¼Œå¤ªå¤šçš„è¿›ç¨‹å’Œçº¿ç¨‹åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­è¢«åˆ›å»ºã€‚æˆ‘ç”¨ä¸‹å›¾æ¥æ¢³ç†è¿™éƒ¨åˆ†è¿›ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œå¸Œæœ›è®©ä½ ä¸€ç›®äº†ç„¶å§ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(13):Inputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹","date":"2017-02-14T06:29:02.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-13-Inputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹/","text":"Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹ è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚å­¦æ ¡ç”µè„‘å¥½æ¸£ï¼Œçœ‹æºç æ—¶å¡åŠå¤© å…ˆå›é¡¾ä¸€ä¸‹å‰ä¸¤ç¯‡æ–‡ç« ã€‚åœ¨è®¾å¤‡æ²¡æœ‰äº‹ä»¶è¾“å…¥çš„æ—¶å€™ï¼ŒInputReaderå’ŒInputDispatcheréƒ½å¤„äºç¡çœ çŠ¶æ€ã€‚å½“è¾“å…¥äº‹ä»¶å‘ç”Ÿï¼ŒInputReaderé¦–å…ˆè¢«æ¿€æ´»ï¼Œç„¶åå‘é€è¯»å–æ¶ˆæ¯ï¼Œæ¿€æ´»Dispatcherã€‚Dispatcherè¢«æ¿€æ´»ä»¥åï¼Œå°†æ¶ˆæ¯å‘é€ç»™å½“å‰æ¿€æ´»çª—å£çš„ä¸»çº¿ç¨‹ï¼Œç„¶åç¡çœ ç­‰å¾…ä¸»çº¿ç¨‹å¤„ç†å®Œè¿™ä¸ªäº‹ä»¶ã€‚ä¸»çº¿ç¨‹è¢«æ¿€æ´»åï¼Œä¼šå¤„ç†ç›¸åº”çš„æ¶ˆæ¯ï¼Œå¤„ç†å®Œæ¯•ååé¦ˆç»™Dispatcherï¼Œä»è€ŒDispatcherå¯ä»¥ç»§ç»­å‘é€æ¶ˆæ¯ã€‚ 1. InputReaderè·å–äº‹ä»¶å›é¡¾ä¸€ä¸‹ç¬¬11ç« 4.2ä¸­ï¼ŒInputReaderçº¿ç¨‹åœ¨è·å–äº‹ä»¶ä»¥åï¼Œä¼šè°ƒç”¨processEventsLocked(mEventBuffer, count);å¤„ç†äº‹ä»¶ã€‚ 1.1è¿™é‡Œå…ˆæ ¹æ®eventçš„ç§ç±»è¿›è¡Œåˆ†é—¨åˆ«ç±»çš„å¤„ç†ã€‚ frameworks/native/services/inputflinger/InputReader.cpp :123456789101112131415161718192021222324252627282930313233343536373839void InputReader::processEventsLocked(const RawEvent* rawEvents, size_t count) &#123; for (const RawEvent* rawEvent = rawEvents; count;) &#123; int32_t type = rawEvent-&gt;type; size_t batchSize = 1; if (type &lt; EventHubInterface::FIRST_SYNTHETIC_EVENT) &#123; //å¦‚æœè¿™é‡Œè·å¾—æ˜¯åˆæˆäº‹ä»¶ //è¿™é‡Œä¸€æ¬¡è¦å°†è¯¥è¾“å…¥è®¾å¤‡ä¸­çš„ä¸€ç»„äº‹ä»¶éƒ½è·å–å‡ºæ¥ int32_t deviceId = rawEvent-&gt;deviceId; while (batchSize &lt; count) &#123; if (rawEvent[batchSize].type &gt;= EventHubInterface::FIRST_SYNTHETIC_EVENT || rawEvent[batchSize].deviceId != deviceId) &#123; break; &#125; batchSize += 1; &#125; //å¤„ç†è¿™äº›äº‹ä»¶ processEventsForDeviceLocked(deviceId, rawEvent, batchSize); &#125; else &#123; //è¿™äº›æ˜¯ä¸€äº›è®¾å¤‡çŠ¶å†µçš„äº‹ä»¶ï¼Œæ²¡å¿…è¦å°†è¿™äº›æ¶ˆæ¯å‘é€å‡ºå»ï¼Œç•™ç»™è‡ªå·±å¤„ç†å°±å¯ä»¥äº† switch (rawEvent-&gt;type) &#123; case EventHubInterface::DEVICE_ADDED: addDeviceLocked(rawEvent-&gt;when, rawEvent-&gt;deviceId); break; case EventHubInterface::DEVICE_REMOVED: removeDeviceLocked(rawEvent-&gt;when, rawEvent-&gt;deviceId); break; case EventHubInterface::FINISHED_DEVICE_SCAN: handleConfigurationChangedLocked(rawEvent-&gt;when); break; default: ALOG_ASSERT(false); // can't happen break; &#125; &#125; count -= batchSize; rawEvent += batchSize; &#125;&#125; 1.2å‡†å¤‡å°†äº‹ä»¶äº¤ç»™è®¾å¤‡è¿›è¡Œå¤„ç†ã€‚ frameworks/native/services/inputflinger/InputReader.cpp :1234567891011121314151617void InputReader::processEventsForDeviceLocked(int32_t deviceId, const RawEvent* rawEvents, size_t count) &#123; //åˆ¤æ–­è®¾å¤‡æ˜¯å¦æ˜¯å·²çŸ¥çš„ ssize_t deviceIndex = mDevices.indexOfKey(deviceId); if (deviceIndex &lt; 0) &#123; ALOGW(\"Discarding event for unknown deviceId %d.\", deviceId); return; &#125; //è·å¾—è®¾å¤‡ InputDevice* device = mDevices.valueAt(deviceIndex); if (device-&gt;isIgnored()) &#123; //ALOGD(\"Discarding event for ignored deviceId %d.\", deviceId); return; &#125; //äº¤ç»™è®¾å¤‡è¿›è¡Œå¤„ç† device-&gt;process(rawEvents, count);&#125; 1.3ç”¨deviceä¸­çš„mapperå»æ˜ å°„ä¼ å…¥çš„äº‹ä»¶ï¼Œç„¶åå†å¤„ç†ã€‚ frameworks/native/services/inputflinger/InputReader.cpp :12345678910111213141516171819202122232425262728293031void InputDevice::process(const RawEvent* rawEvents, size_t count) &#123; // Process all of the events in order for each mapper. // We cannot simply ask each mapper to process them in bulk because mappers may // have side-effects that must be interleaved. For example, joystick movement events and // gamepad button presses are handled by different mappers but they should be dispatched // in the order received. //ä¸€ä¸ªè®¾å¤‡å¯èƒ½æœ‰å¤šç§ç±»å‹çš„eventï¼Œæ‰€æœ‰æœ‰å¤šä¸ªmapperï¼Œä½†æ˜¯éœ€è¦ä¿æŒeventçš„é¡ºåºæ€§ //æ‰€ä»¥è¿™é‡Œé‡‡ç”¨å…ˆå¾ªç¯eventï¼Œå†å¾ªç¯mapperçš„æ–¹å¼ size_t numMappers = mMappers.size(); for (const RawEvent* rawEvent = rawEvents; count--; rawEvent++) &#123; if (mDropUntilNextSync) &#123; if (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_REPORT) &#123; mDropUntilNextSync = false; //.. &#125; else &#123; //.. &#125; &#125; else if (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_DROPPED) &#123; //.. mDropUntilNextSync = true; reset(rawEvent-&gt;when); &#125; else &#123; for (size_t i = 0; i &lt; numMappers; i++) &#123; InputMapper* mapper = mMappers[i]; //ç”¨æ¯ä¸€ç§mapperå°è¯•å¤„ç†event mapper-&gt;process(rawEvent); &#125; &#125; &#125;&#125; 1.4è¿™é‡ŒInputMapperç§ç±»å¾ˆå¤šï¼Œæ¯ä¸ªäº‹ä»¶å¤„ç†æ–¹æ³•å„ä¸ç›¸åŒï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸å†è¯¦è¿°ã€‚å…¶ä¸­æœ‰å¦‚ä¸‹çš„InputMapperï¼š SwitchInputMapper, VibratorInputMapper, KeyboardInputMapper, CursorInputMapper, TouchInputMapper, SingleTouchInputMapper, MultiTouchInputMapper, JoystickInputMapper è¿™äº›æ–¹æ³•å¤„ç†åˆ°æœ€åï¼Œä¼šè°ƒç”¨getListener()-&gt;notifyXXX(&amp;args)ï¼Œè®©Dispatcherè¿›è¡Œåˆ†å‘ï¼ŒXXXæ ¹æ®ä¸åŒçš„Mapperæœ‰ç›¸åº”çš„åå­—ã€‚åœ¨åˆ›å»ºInputReaderæ—¶ï¼Œå°†InputDispatcherä½œä¸ºå‚æ•°ä¼ å…¥ï¼ŒåŒæ—¶å»ºç«‹äº†QueuedInputListeneræ¥å­˜æ”¾è¿™ä¸ªInputDispatcherï¼Œä¼°è®¡æ˜¯å‡†å¤‡å°†æ¥å¤„ç†å¤šä¸ªInputDispatcherã€‚æ‰€ä»¥è¿™é‡ŒgetListenerè·å–çš„å°±æ˜¯å½“åˆå»ºç«‹çš„InputDispatcherå¯¹è±¡ã€‚ 1.5è¿™é‡Œè™½ç„¶å·²ç»å¼€å§‹è°ƒç”¨InputDispatcherçš„å‡½æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨InputReaderçº¿ç¨‹ä¸­ã€‚è¿™é‡Œå¼€å§‹å‘InputDispatcherçš„é˜Ÿåˆ—ä¸­æ’å…¥äº‹ä»¶ï¼Œå¹¶ä¸”æŠŠInputDispatcherå”¤é†’äº†ã€‚å› ä¸ºnotifyXXXå‡½æ•°åŒæ ·æ˜¯é’ˆå¯¹ä¸åŒçš„è¾“å…¥æœ‰ç€ä¸åŒçš„å¤„ç†ï¼Œæ‰€ä»¥ä¸å†è¯¦è¿°ï¼Œæˆªå–ä¸€æ®µMotionEventçš„ä»£ç ç‰‡æ®µã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :1234567891011121314151617 //é’ˆå¯¹æ¯ç§eventï¼Œéƒ½ä¼šæƒ³å°†å…¶å°è£…æˆä¸€ä¸ªEventEntry // Just enqueue a new motion event. MotionEntry* newEntry = new MotionEntry(args-&gt;eventTime, args-&gt;deviceId, args-&gt;source, policyFlags, args-&gt;action, args-&gt;actionButton, args-&gt;flags, args-&gt;metaState, args-&gt;buttonState, args-&gt;edgeFlags, args-&gt;xPrecision, args-&gt;yPrecision, args-&gt;downTime, args-&gt;displayId, args-&gt;pointerCount, args-&gt;pointerProperties, args-&gt;pointerCoords, 0, 0);//ç„¶ååŠ å…¥é˜Ÿåˆ—needWake = enqueueInboundEventLocked(newEntry);//...//å”¤é†’Looperçº¿ç¨‹if (needWake) &#123; mLooper-&gt;wake(); &#125; å°†ä¸€ä¸ªäº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ä¹‹åï¼Œä¼šæ ¹æ®needWakeå‚æ•°å†³å®šæ˜¯å¦è¦å”¤é†’çº¿ç¨‹ã€‚å¦‚æœè¦å”¤é†’ï¼Œåˆ™è°ƒç”¨Looperçš„wakeå‡½æ•°å°±å¯ä»¥äº†ï¼Œå’ŒåŸæ¥é“ç†ä¸€æ ·ã€‚åœ¨æœ‰äº›æ—¶å€™ï¼Œæœ‰äº‹ä»¶æ·»åŠ è¿›å»ï¼Œä¸ä¸€å®šè¦å”¤é†’çº¿ç¨‹ï¼Œæ¯”å¦‚çº¿ç¨‹æ­£åœ¨ç­‰å¾…åº”ç”¨åé¦ˆäº‹ä»¶å¤„ç†å®Œæ¯•çš„æ¶ˆæ¯ã€‚ 1.6å®å®åœ¨åœ¨çš„å°†è¿™ä¸ªEventEntryæ”¾å…¥é˜Ÿåˆ—mInboundQueueä¸­äº†ã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364bool InputDispatcher::enqueueInboundEventLocked(EventEntry* entry) &#123; //å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œéœ€è¦å”¤é†’ bool needWake = mInboundQueue.isEmpty(); //å°†äº‹ä»¶åŠ å…¥é˜Ÿåˆ— mInboundQueue.enqueueAtTail(entry); traceInboundQueueLengthLocked(); switch (entry-&gt;type) &#123; //è¿™é‡Œä¼šä¼˜åŒ–Appåˆ‡æ¢çš„äº‹ä»¶ï¼Œå¦‚æœä¸Šä¸€ä¸ªAppè¿˜æœ‰äº‹ä»¶æ²¡å¤„ç†å®Œï¼Œä¹Ÿæ²¡åé¦ˆäº‹ä»¶å¤„ç†å®Œæ¯•æ¶ˆæ¯ //åˆ™æ¸…ç©ºä¹‹å‰çš„äº‹ä»¶ï¼Œåˆ‡æ¢ä¸‹ä¸€ä¸ªåº”ç”¨ case EventEntry::TYPE_KEY: &#123; // Optimize app switch latency. // If the application takes too long to catch up then we drop all events preceding // the app switch key. KeyEntry* keyEntry = static_cast&lt;KeyEntry*&gt;(entry); if (isAppSwitchKeyEventLocked(keyEntry)) &#123; if (keyEntry-&gt;action == AKEY_EVENT_ACTION_DOWN) &#123; mAppSwitchSawKeyDown = true; &#125; else if (keyEntry-&gt;action == AKEY_EVENT_ACTION_UP) &#123; if (mAppSwitchSawKeyDown) &#123;#if DEBUG_APP_SWITCH ALOGD(\"App switch is pending!\");#endif mAppSwitchDueTime = keyEntry-&gt;eventTime + APP_SWITCH_TIMEOUT; mAppSwitchSawKeyDown = false; needWake = true; &#125; &#125; &#125; break; &#125; //å½“ä¸€ä¸ªéå½“å‰æ¿€æ´»appçš„ç‚¹å‡»äº‹ä»¶å‘ç”Ÿï¼Œä¼šæ¸…ç©ºä¹‹å‰çš„äº‹ä»¶ //ä»è¿™ä¸ªæ–°çš„ç‚¹å‡»äº‹ä»¶å¼€å§‹ case EventEntry::TYPE_MOTION: &#123; // Optimize case where the current application is unresponsive and the user // decides to touch a window in a different application. // If the application takes too long to catch up then we drop all events preceding // the touch into the other window. MotionEntry* motionEntry = static_cast&lt;MotionEntry*&gt;(entry); if (motionEntry-&gt;action == AMOTION_EVENT_ACTION_DOWN &amp;&amp; (motionEntry-&gt;source &amp; AINPUT_SOURCE_CLASS_POINTER) &amp;&amp; mInputTargetWaitCause == INPUT_TARGET_WAIT_CAUSE_APPLICATION_NOT_READY &amp;&amp; mInputTargetWaitApplicationHandle != NULL) &#123; int32_t displayId = motionEntry-&gt;displayId; int32_t x = int32_t(motionEntry-&gt;pointerCoords[0]. getAxisValue(AMOTION_EVENT_AXIS_X)); int32_t y = int32_t(motionEntry-&gt;pointerCoords[0]. getAxisValue(AMOTION_EVENT_AXIS_Y)); sp&lt;InputWindowHandle&gt; touchedWindowHandle = findTouchedWindowAtLocked(displayId, x, y); if (touchedWindowHandle != NULL &amp;&amp; touchedWindowHandle-&gt;inputApplicationHandle != mInputTargetWaitApplicationHandle) &#123; // User touched a different application than the one we are waiting on. // Flag the event, and start pruning the input queue. mNextUnblockedEvent = motionEntry; needWake = true; &#125; &#125; break; &#125; &#125; return needWake;&#125; è¿™é‡Œåšäº†ä¸¤ç§ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯åœ¨å½“å‰Appçª—å£å¤„ç†äº‹ä»¶è¿‡æ…¢ï¼ŒåŒæ—¶ä½ åˆè§¦å‘å…¶ä»–Appçš„äº‹ä»¶æ—¶ï¼ŒDispatcherå°±ä¼šä¸¢å¼ƒå…ˆå‰çš„äº‹ä»¶ï¼Œä»è¿™ä¸ªå¼€å§‹å”¤é†’Dispatcherã€‚è¿™æ ·åšå¾ˆåˆæƒ…åˆç†ï¼Œç”¨æˆ·åœ¨ä½¿ç”¨æ—¶ï¼Œä¼šé‡åˆ°Appç”±äºå¼€å‘è€…æ°´å¹³æœ‰é™å¯¼è‡´å¤„ç†äº‹ä»¶è¿‡æ…¢æƒ…å†µï¼Œè¿™æ—¶ç”¨æˆ·ç­‰çš„ä¸è€çƒ¦ï¼Œåˆ™åº”è¯¥è®©ç”¨æˆ·è½»æ¾çš„åˆ‡æ¢åˆ°å…¶å®ƒAppï¼Œè€Œä¸æ˜¯é˜»å¡åœ¨é‚£ã€‚æ‰€ä»¥ï¼Œäº‹ä»¶æ— æ³•å“åº”åªä¼šå‘ç”Ÿåœ¨Appå†…éƒ¨ï¼Œè€Œä¸ä¼šå½±å“åº”ç”¨çš„åˆ‡æ¢ï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒã€‚Appçš„è´¨é‡é—®é¢˜ä¸ä¼šå½±å“ç³»ç»Ÿçš„è¿è½¬ï¼ŒAndroidåœ¨è¿™ç‚¹ä¸Šåšçš„å¾ˆäººæ€§ã€‚ 2. InputDispatcheråˆ†å‘äº‹ä»¶åœ¨ç¬¬11ç« ä¸­3.2ä¸­ï¼ŒDispatcherè°ƒç”¨å‡½æ•°dispatchOnceInnerLocked(&amp;nextWakeupTime);æ¥åˆ†é…é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ã€‚ 2.1ä»é˜Ÿåˆ—ä¸­è·å–eventï¼Œç„¶åå‡†å¤‡å¤„ç†ã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162void InputDispatcher::dispatchOnceInnerLocked(nsecs_t* nextWakeupTime) &#123; nsecs_t currentTime = now(); // Reset the key repeat timer whenever normal dispatch is suspended while the // device is in a non-interactive state. This is to ensure that we abort a key // repeat if the device is just coming out of sleep. if (!mDispatchEnabled) &#123; resetKeyRepeatLocked(); &#125; // If dispatching is frozen, do not process timeouts or try to deliver any new events. if (mDispatchFrozen) &#123; return; &#125; //å¯¹Appåˆ‡æ¢çš„æƒ…å†µçš„ä¼˜åŒ– // Optimize latency of app switches. // Essentially we start a short timeout when an app switch key (HOME / ENDCALL) has // been pressed. When it expires, we preempt dispatch and drop all other pending events. bool isAppSwitchDue = mAppSwitchDueTime &lt;= currentTime; if (mAppSwitchDueTime &lt; *nextWakeupTime) &#123; //å¦‚æœæœ‰åˆ‡æ¢Appçš„eventï¼Œä¸”æ—¶é—´å°äºè®¾å®šçš„æ—¶é—´ //åˆ™å°†ç­‰å¾…äº‹ä»¶è®¾ä¸ºå°è€… *nextWakeupTime = mAppSwitchDueTime; &#125; // Ready to start a new event. // If we don't already have a pending event, go grab one. if (! mPendingEvent) &#123; if (mInboundQueue.isEmpty()) &#123; //é˜Ÿåˆ—æ˜¯ç©ºçš„æƒ…å†µ if (isAppSwitchDue) &#123; // The inbound queue is empty so the app switch key we were waiting // for will never arrive. Stop waiting for it. resetPendingAppSwitchLocked(false); isAppSwitchDue = false; &#125; // Synthesize a key repeat if appropriate. //å¦‚æœæœ‰è¿ç»­é‡å¤äº‹ä»¶å‘ç”Ÿï¼Œåˆ™åˆ¶é€ é‡å¤äº‹ä»¶ if (mKeyRepeatState.lastKeyEntry) &#123; if (currentTime &gt;= mKeyRepeatState.nextRepeatTime) &#123; mPendingEvent = synthesizeKeyRepeatLocked(currentTime); &#125; else &#123; if (mKeyRepeatState.nextRepeatTime &lt; *nextWakeupTime) &#123; *nextWakeupTime = mKeyRepeatState.nextRepeatTime; &#125; &#125; &#125; // Nothing to do if there is no pending event. //å¦‚æœçœŸæ— äº‹å¯åšï¼Œä¸‹æ¬¡ç¡çœ å¯èƒ½æ¯”è¾ƒä¹… if (!mPendingEvent) &#123; return; &#125; &#125; else &#123; // Inbound queue has at least one entry. //ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªEvent mPendingEvent = mInboundQueue.dequeueAtHead(); traceInboundQueueLengthLocked(); &#125; // Poke user activity for this event. if (mPendingEvent-&gt;policyFlags &amp; POLICY_FLAG_PASS_TO_USER) &#123; pokeUserActivityLocked(mPendingEvent); &#125; //é‡ç½®ANRT // Get ready to dispatch the event. resetANRTimeoutsLocked(); &#125; // Now we have an event to dispatch. // All events are eventually dequeued and processed this way, even if we intend to drop them. bool done = false; DropReason dropReason = DROP_REASON_NOT_DROPPED; if (!(mPendingEvent-&gt;policyFlags &amp; POLICY_FLAG_PASS_TO_USER)) &#123; dropReason = DROP_REASON_POLICY; &#125; else if (!mDispatchEnabled) &#123; dropReason = DROP_REASON_DISABLED; &#125; if (mNextUnblockedEvent == mPendingEvent) &#123; mNextUnblockedEvent = NULL; &#125; //åˆ†ç±»å¤„ç†Event switch (mPendingEvent-&gt;type) &#123; case EventEntry::TYPE_CONFIGURATION_CHANGED: &#123; ConfigurationChangedEntry* typedEntry = static_cast&lt;ConfigurationChangedEntry*&gt;(mPendingEvent); done = dispatchConfigurationChangedLocked(currentTime, typedEntry); dropReason = DROP_REASON_NOT_DROPPED; // configuration changes are never dropped break; &#125; case EventEntry::TYPE_DEVICE_RESET: &#123; DeviceResetEntry* typedEntry = static_cast&lt;DeviceResetEntry*&gt;(mPendingEvent); done = dispatchDeviceResetLocked(currentTime, typedEntry); dropReason = DROP_REASON_NOT_DROPPED; // device resets are never dropped break; &#125; case EventEntry::TYPE_KEY: &#123; KeyEntry* typedEntry = static_cast&lt;KeyEntry*&gt;(mPendingEvent); if (isAppSwitchDue) &#123; if (isAppSwitchKeyEventLocked(typedEntry)) &#123; //è¿™ä¸ªEventå°±æ˜¯SwitchEventï¼Œæˆ‘å·²ç»å¤„ç† //é‡ç½®Appåˆ‡æ¢çš„çŠ¶æ€ä¸ºfalse resetPendingAppSwitchLocked(true); isAppSwitchDue = false; &#125; else if (dropReason == DROP_REASON_NOT_DROPPED) &#123; //å¦‚æœæ˜¯å…¶ä»–äº‹ä»¶ï¼Œåˆ™ä¸¢å¼ƒï¼Œå› ä¸ºæ­£åœ¨switch dropReason = DROP_REASON_APP_SWITCH; &#125; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; isStaleEventLocked(currentTime, typedEntry)) &#123; dropReason = DROP_REASON_STALE; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; mNextUnblockedEvent) &#123; dropReason = DROP_REASON_BLOCKED; &#125; //åˆ†å‘KeyEvent done = dispatchKeyLocked(currentTime, typedEntry, &amp;dropReason, nextWakeupTime); break; &#125; case EventEntry::TYPE_MOTION: &#123; MotionEntry* typedEntry = static_cast&lt;MotionEntry*&gt;(mPendingEvent); if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; isAppSwitchDue) &#123; dropReason = DROP_REASON_APP_SWITCH; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; isStaleEventLocked(currentTime, typedEntry)) &#123; dropReason = DROP_REASON_STALE; &#125; if (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; mNextUnblockedEvent) &#123; dropReason = DROP_REASON_BLOCKED; &#125; //åˆ†å‘Motion Event done = dispatchMotionLocked(currentTime, typedEntry, &amp;dropReason, nextWakeupTime); break; &#125; default: ALOG_ASSERT(false); break; &#125; if (done) &#123; if (dropReason != DROP_REASON_NOT_DROPPED) &#123; dropInboundEventLocked(mPendingEvent, dropReason); &#125; mLastDropReason = dropReason; //å°†mPendingEventç½®ä¸ºnull releasePendingEventLocked(); //æˆ‘å·²ç»å¤„ç†çš„eventï¼Œæ‰€ä»¥éœ€è¦å°†ç¡çœ è®¾ç½®æ—¶é—´å°ä¸€ç‚¹ *nextWakeupTime = LONG_LONG_MIN; // force next poll to wake up immediately &#125;&#125; 2.2è¿™ä¸€æ­¥æ ¹æ®Eventçš„ç§ç±»ï¼Œç•¥æœ‰ä¸åŒã€‚æœ‰dispatchMotionLockedå’ŒdispatchKeyLockedç­‰ã€‚ä¸»è¦è¿‡ç¨‹ç±»ä¼¼ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦ä¸¢å¼ƒè¯¥eventï¼Œç„¶åè·å¾—ç›®æ ‡Windowï¼Œå†å‘ç›®æ ‡windowå‘é€eventã€‚ä»£ç ç‰‡å¦‚ä¸‹ï¼š frameworks/native/services/inputflinger/InputDispatcher.cpp :1234567//..// Identify targets.Vector&lt;InputTarget&gt; inputTargets;//..injectionResult = findTouchedWindowTargetsLocked(currentTime, entry, inputTargets, nextWakeupTime, &amp;conflictingPointerActions);//..dispatchEventLocked(currentTime, entry, inputTargets); è¿™é‡Œè°ƒç”¨findTouchedWindowTargetsLocked()æ¥è·å–ç›®æ ‡Windowã€‚åœ¨å‰é¢12ç« 3.6ä¸­ï¼Œå°†mFocusedWindowHandleå‚æ•°è®¾ç½®ä¸ºäº†å½“å‰æ¿€æ´»çš„Windowï¼Œæ‰€ä»¥ç›®å‰è¿”å›çš„inputTargetså°±æ˜¯å°†mFocusedWindowHandleå°è£…åçš„ç»“æœã€‚ 2.3å‘æ¯ä¸€ä¸ªç›®æ ‡å‘é€eventã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :1234567891011121314151617void InputDispatcher::dispatchEventLocked(nsecs_t currentTime, EventEntry* eventEntry, const Vector&lt;InputTarget&gt;&amp; inputTargets) &#123; pokeUserActivityLocked(eventEntry); //å‘æ¯ä¸€ä¸ªç›®æ ‡å‘é€event for (size_t i = 0; i &lt; inputTargets.size(); i++) &#123; const InputTarget&amp; inputTarget = inputTargets.itemAt(i); //è·å–ç›®æ ‡çš„connection ssize_t connectionIndex = getConnectionIndexLocked(inputTarget.inputChannel); if (connectionIndex &gt;= 0) &#123; sp&lt;Connection&gt; connection = mConnectionsByFd.valueAt(connectionIndex); prepareDispatchCycleLocked(currentTime, connection, eventEntry, &amp;inputTarget); &#125; else &#123; //.. &#125; &#125;&#125; 2.4frameworks/native/services/inputflinger/InputDispatcher.cpp :123456789101112131415161718192021222324252627282930void InputDispatcher::prepareDispatchCycleLocked(nsecs_t currentTime, const sp&lt;Connection&gt;&amp; connection, EventEntry* eventEntry, const InputTarget* inputTarget) &#123; // Skip this event if the connection status is not normal. // We don't want to enqueue additional outbound events if the connection is broken. if (connection-&gt;status != Connection::STATUS_NORMAL) &#123; return; &#125; // Split a motion event if needed. if (inputTarget-&gt;flags &amp; InputTarget::FLAG_SPLIT) &#123; //Motion eventä¸€èˆ¬ä¸ºè¿ç»­çš„åŸºæœ¬eventç»„åˆè€Œæˆ //æ‰€ä»¥å¯ä»¥åˆ†å‰² MotionEntry* originalMotionEntry = static_cast&lt;MotionEntry*&gt;(eventEntry); if (inputTarget-&gt;pointerIds.count() != originalMotionEntry-&gt;pointerCount) &#123; MotionEntry* splitMotionEntry = splitMotionEvent( originalMotionEntry, inputTarget-&gt;pointerIds); if (!splitMotionEntry) &#123; return; // split event was dropped &#125; enqueueDispatchEntriesLocked(currentTime, connection, splitMotionEntry, inputTarget); splitMotionEntry-&gt;release(); return; &#125; &#125; // Not splitting. Enqueue dispatch entries for the event as is. enqueueDispatchEntriesLocked(currentTime, connection, eventEntry, inputTarget);&#125; 2.5è¿™ä¸€æ­¥å…ˆåˆ¤æ–­ç›®æ ‡Connectionæ˜¯å¦ç©ºï¼Œç„¶åå‘å…¶é˜Ÿåˆ—åŠ å…¥eventã€‚å¦‚æœåŸæ¥é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯´æ˜å¯ä»¥è¿›ä¸€æ­¥åˆ†å‘eventï¼›å¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜æ—§eventè¿˜æ²¡æœ‰å¤„ç†å®Œæ¯•ï¼Œåˆ™ä¸è¿›ä¸€æ­¥åˆ†å‘ã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :123456789bool wasEmpty = connection-&gt;outboundQueue.isEmpty();// Enqueue dispatch entries for the requested modes.//å°†eventæ”¾å…¥outboundQueueä¸­ï¼Œçœç•¥..// If the outbound queue was previously empty, start the dispatch cycle going.if (wasEmpty &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123; startDispatchCycleLocked(currentTime, connection);&#125; 2.6å¾ªç¯çš„å–å‡ºé˜Ÿåˆ—ä¸­çš„eventï¼Œç„¶åäº¤ç»™connectionå‘é€ã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162void InputDispatcher::startDispatchCycleLocked(nsecs_t currentTime, const sp&lt;Connection&gt;&amp; connection) &#123; //å°†outboundQueueä¸­çš„entryä¸€ä¸€è¿›è¡Œå¤„ç† while (connection-&gt;status == Connection::STATUS_NORMAL &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123; //è·å–é¦–éƒ¨çš„entry DispatchEntry* dispatchEntry = connection-&gt;outboundQueue.head; dispatchEntry-&gt;deliveryTime = currentTime; // Publish the event. status_t status; EventEntry* eventEntry = dispatchEntry-&gt;eventEntry; switch (eventEntry-&gt;type) &#123; case EventEntry::TYPE_KEY: &#123; KeyEntry* keyEntry = static_cast&lt;KeyEntry*&gt;(eventEntry); //.. // Publish the key event. status = connection-&gt;inputPublisher.publishKeyEvent(dispatchEntry-&gt;seq, keyEntry-&gt;deviceId, keyEntry-&gt;source, dispatchEntry-&gt;resolvedAction, dispatchEntry-&gt;resolvedFlags, keyEntry-&gt;keyCode, keyEntry-&gt;scanCode, keyEntry-&gt;metaState, keyEntry-&gt;repeatCount, keyEntry-&gt;downTime, keyEntry-&gt;eventTime); break; &#125; case EventEntry::TYPE_MOTION: &#123; MotionEntry* motionEntry = static_cast&lt;MotionEntry*&gt;(eventEntry); // Set the X and Y offset depending on the input source. //.. // Publish the motion event. status = connection-&gt;inputPublisher.publishMotionEvent(dispatchEntry-&gt;seq, motionEntry-&gt;deviceId, motionEntry-&gt;source, dispatchEntry-&gt;resolvedAction, motionEntry-&gt;actionButton, dispatchEntry-&gt;resolvedFlags, motionEntry-&gt;edgeFlags, motionEntry-&gt;metaState, motionEntry-&gt;buttonState, xOffset, yOffset, motionEntry-&gt;xPrecision, motionEntry-&gt;yPrecision, motionEntry-&gt;downTime, motionEntry-&gt;eventTime, motionEntry-&gt;pointerCount, motionEntry-&gt;pointerProperties, usingCoords); break; &#125; default: return; &#125; // Check the result. // Re-enqueue the event on the wait queue. //ä»outboundQueueä¸­ç§»é™¤ connection-&gt;outboundQueue.dequeue(dispatchEntry); traceOutboundQueueLengthLocked(connection); //åŠ å…¥waitQueue connection-&gt;waitQueue.enqueueAtTail(dispatchEntry); traceWaitQueueLengthLocked(connection); &#125;&#125; 2.7è¿™ä¸€æ­¥åŒæ ·æœ‰å¤šç§æƒ…å†µï¼Œæœ‰publishMotionEventå’ŒpublishKeyEventã€‚åŸºæœ¬æ€è·¯ç›¸è¿‘ã€‚å…ˆå°è£…æˆmessageï¼Œæœ€åéƒ½è°ƒç”¨äº†mChannel-&gt;sendMessage(&amp;msg)ã€‚frameworks/native/libs/input/InputTransport.cpp :1234567891011121314151617181920212223InputMessage msg;msg.header.type = InputMessage::TYPE_MOTION;msg.body.motion.seq = seq;msg.body.motion.deviceId = deviceId;msg.body.motion.source = source;msg.body.motion.action = action;msg.body.motion.actionButton = actionButton;msg.body.motion.flags = flags;msg.body.motion.edgeFlags = edgeFlags;msg.body.motion.metaState = metaState;msg.body.motion.buttonState = buttonState;msg.body.motion.xOffset = xOffset;msg.body.motion.yOffset = yOffset;msg.body.motion.xPrecision = xPrecision;msg.body.motion.yPrecision = yPrecision;msg.body.motion.downTime = downTime;msg.body.motion.eventTime = eventTime;msg.body.motion.pointerCount = pointerCount;for (uint32_t i = 0; i &lt; pointerCount; i++) &#123; msg.body.motion.pointers[i].properties.copyFrom(pointerProperties[i]); msg.body.motion.pointers[i].coords.copyFrom(pointerCoords[i]);&#125;return mChannel-&gt;sendMessage(&amp;msg); 2.8è¿™ä¸€æ­¥å°±è¦åƒä¿å­˜çš„æ–‡ä»¶æè¿°ç¬¦mFdä¸­å†™å…¥æ•°æ®äº†ã€‚ frameworks/native/libs/input/InputTransport.cpp :12345size_t msgLength = msg-&gt;size();ssize_t nWrite;do &#123; nWrite = ::send(mFd, msg, msgLength, MSG_DONTWAIT | MSG_NOSIGNAL);&#125; while (nWrite == -1 &amp;&amp; errno == EINTR); åˆ°è¿™é‡Œï¼ŒDispatcherç»ˆäºæŠŠeventé€šè¿‡å½“åˆå»ºç«‹çš„Channel pairå‘é€ç»™äº†åº”ç”¨windowã€‚è¿™é‡Œå’Œæ—§ç‰ˆæœ¬å¾ˆä¸åŒï¼Œå½“åˆéœ€è¦å…ˆå°†eventæ”¾å…¥å…±äº«å†…å­˜ï¼Œç„¶åå‘é€ä¸€ä¸ªä¿¡å·è¿›è¡Œé€šçŸ¥ã€‚ 3. å½“å‰æ¿€æ´»Windowè·å¾—æ¶ˆæ¯è¿™ä¸€èŠ‚æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å›å¿†å¤§é‡çš„å‰é¢å‡ ç« çš„ç»†èŠ‚å’Œä¸€å®šçš„é€»è¾‘æ¨ç†ï¼ˆè¿è’™å¸¦çŒœï¼‰èƒ½åŠ›ã€‚ å…ˆæ¥å›å¿†ä¸€ä¸‹ç¬¬12ç« 4.5èŠ‚ï¼Œåœ¨InputChannelæ³¨å†Œåˆ°Clientæ—¶ï¼Œæœ€åä¸€æ­¥åšäº†ä»€ä¹ˆã€‚ frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š1mMessageQueue-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); è¿™é‡Œç»™ä¸»çº¿ç¨‹çš„Looperæ·»åŠ çš„ä¸€ä¸ªéœ€è¦ç›‘å¬fdï¼Œè¿™ä¸ªfdæ˜¯Clientç«¯çš„InputChannelçš„æ–‡ä»¶æè¿°ç¬¦ã€‚addFdå‡½æ•°çš„ç¬¬4ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™é‡ŒthisæŒ‡NativeInputEventReceiverå¯¹è±¡ï¼Œå®ƒæ˜¯LooperCallbackçš„å­ç±»ã€‚addFdå‡½æ•°æ–°å»ºäº†ä¸€ä¸ªRequestå¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š system/core/libutils/Looper.cpp :1234567891011Request request;request.fd = fd;request.ident = ident;request.events = events;request.seq = mNextRequestSeq++;//å›è°ƒå‡½æ•°æŒ‡æ˜æ˜¯ä¸Šä¸€æ­¥ä¼ å…¥çš„NativeInputEventReceiverå¯¹è±¡request.callback = callback;request.data = data;//..//å°†requestä»¥fdä¸ºå…³é”®å­—åŠ å…¥mRequestsmRequests.add(fd, request); å†æ¬¡å›å¿†ç¬¬10ç« 1.6ï¼Œä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹è¢«é˜»å¡çš„åœ°æ–¹ã€‚ä»£ç å¦‚ä¸‹ï¼šsystem/core/libutils/Looper.cpp :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172int Looper::pollInner(int timeoutMillis) &#123; // Adjust the timeout based on when the next message is due. //.. //æ¸…ç©ºmResponsesæ•°ç»„ // Poll. int result = POLL_WAKE; mResponses.clear(); mResponseIndex = 0; // We are about to idle. mPolling = true; //ç­‰å¾…epollç›‘æµ‹åˆ°IOäº‹ä»¶ struct epoll_event eventItems[EPOLL_MAX_EVENTS]; int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); //.. // Handle all events. for (int i = 0; i &lt; eventCount; i++) &#123; int fd = eventItems[i].data.fd; uint32_t epollEvents = eventItems[i].events; if (fd == mWakeEventFd) &#123; if (epollEvents &amp; EPOLLIN) &#123; //è¿™é‡Œå¤„ç†çš„å”¤é†’äº‹ä»¶ awoken(); &#125; else &#123; ALOGW(\"Ignoring unexpected epoll events 0x%x on wake event fd.\", epollEvents); &#125; &#125; else &#123; //è¿™é‡Œå¤„ç†çš„æ˜¯inputäº‹ä»¶ ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &gt;= 0) &#123; int events = 0; if (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT; if (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT; if (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR; if (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP; //å°†eventåŠ å…¥mResponses pushResponse(events, mRequests.valueAt(requestIndex)); &#125; else &#123; //.. &#125; &#125; &#125;Done: ; //éå†æ¯ä¸€ä¸ªå­˜åœ¨mResponsesçš„event // Invoke all response callbacks. for (size_t i = 0; i &lt; mResponses.size(); i++) &#123; Response&amp; response = mResponses.editItemAt(i); if (response.request.ident == POLL_CALLBACK) &#123; int fd = response.request.fd; int events = response.events; void* data = response.request.data; // Invoke the callback. Note that the file descriptor may be closed by // the callback (and potentially even reused) before the function returns so // we need to be a little careful when removing the file descriptor afterwards. //è¿™ä¸€æ­¥å¼€å§‹è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè¯´æ˜è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸‹æœ‰äººè¾“å…¥çš„event int callbackResult = response.request.callback-&gt;handleEvent(fd, events, data); if (callbackResult == 0) &#123; removeFd(fd, response.request.seq); &#125; // Clear the callback reference in the response structure promptly because we // will not clear the response vector itself until the next poll. response.request.callback.clear(); result = POLL_CALLBACK; &#125; &#125; return result;&#125; è¿™ä¸€æ­¥å¤„ç†wakeäº‹ä»¶å·²ç»åœ¨ç¬¬10ç« ç¬¬1èŠ‚è®²è¿°è¿‡äº†ï¼Œè¿™é‡Œéœ€è¦å¤„ç†çš„å¦ä¸€ç§äº‹ä»¶input eventã€‚å¯¹input eventï¼Œå…ˆå°†å…¶æ”¾å…¥mResponsesæ•°ç»„ï¼Œç„¶åä¾æ¬¡è°ƒç”¨ä»–ä»¬çš„å›è°ƒå‡½æ•°ã€‚è¿™é‡Œå°±æ˜¯NativeInputEventReceiverçš„handleEventå‡½æ•°äº†ã€‚ 3.1Eventåˆ†ä¸ºInputå’ŒOutputï¼Œè¿™é‡Œæ˜¯äº‹ä»¶è¾“å…¥ï¼Œæ‰€ä»¥å…ˆçœ‹Inputåˆ†æ”¯ã€‚ frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š1234567891011121314int NativeInputEventReceiver::handleEvent(int receiveFd, int events, void* data) &#123; if (events &amp; ALOOPER_EVENT_INPUT) &#123; JNIEnv* env = AndroidRuntime::getJNIEnv(); status_t status = consumeEvents(env, false /*consumeBatches*/, -1, NULL); mMessageQueue-&gt;raiseAndClearException(env, \"handleReceiveCallback\"); return status == OK || status == NO_MEMORY ? 1 : 0; &#125; if (events &amp; ALOOPER_EVENT_OUTPUT) &#123; //.. &#125; return 1;&#125; 3.2å¼€å§‹ä»ç›®æ ‡Channelä¸­è¯»å‡ºeventï¼Œç„¶ååŒ…è£…æˆjavaå±‚çš„å¯¹è±¡ï¼Œå¼€å§‹è°ƒç”¨javaå‡½æ•°è¿›è¡Œå¤„ç†ã€‚ frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667status_t NativeInputEventReceiver::consumeEvents(JNIEnv* env, bool consumeBatches, nsecs_t frameTime, bool* outConsumedBatch) &#123; ScopedLocalRef&lt;jobject&gt; receiverObj(env, NULL); bool skipCallbacks = false; //å¾ªç¯ä»Channelä¸­è¯»å‡ºevent for (;;) &#123; uint32_t seq; InputEvent* inputEvent; //è¿™ä¸€æ­¥å¼€å§‹ä»Channelä¸­è¯»å–eventï¼Œå­˜å…¥inputEventä¸­ status_t status = mInputConsumer.consume(&amp;mInputEventFactory, consumeBatches, frameTime, &amp;seq, &amp;inputEvent); if (status) &#123; if (status == WOULD_BLOCK) &#123; if (!skipCallbacks &amp;&amp; !mBatchedInputEventPending &amp;&amp; mInputConsumer.hasPendingBatch()) &#123; // There is a pending batch. Come back later. //.. return OK; &#125; &#125; return status; &#125; if (!skipCallbacks) &#123; if (!receiverObj.get()) &#123; //è¿™é‡Œçš„mReceiverWeakGlobalæ˜¯javaå±‚çš„InputEventReceiver receiverObj.reset(jniGetReferent(env, mReceiverWeakGlobal)); //.. &#125; //æ ¹æ®ä¸åŒçš„InputEventç§ç±»ï¼Œå°†å…¶è½¬åŒ–ä¸ºjavaå±‚çš„inputEventObj jobject inputEventObj; switch (inputEvent-&gt;getType()) &#123; case AINPUT_EVENT_TYPE_KEY: inputEventObj = android_view_KeyEvent_fromNative(env, static_cast&lt;KeyEvent*&gt;(inputEvent)); break; case AINPUT_EVENT_TYPE_MOTION: &#123; MotionEvent* motionEvent = static_cast&lt;MotionEvent*&gt;(inputEvent); if ((motionEvent-&gt;getAction() &amp; AMOTION_EVENT_ACTION_MOVE) &amp;&amp; outConsumedBatch) &#123; *outConsumedBatch = true; &#125; inputEventObj = android_view_MotionEvent_obtainAsCopy(env, motionEvent); break; &#125; default: assert(false); // InputConsumer should prevent this from ever happening inputEventObj = NULL; &#125; if (inputEventObj) &#123; //å¼€å§‹è°ƒç”¨javaå±‚çš„dispatchInputEventå‡½æ•° env-&gt;CallVoidMethod(receiverObj.get(), gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj); env-&gt;DeleteLocalRef(inputEventObj); &#125; else &#123; //.. &#125; &#125; if (skipCallbacks) &#123; //ä¸éœ€è¦è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œåˆ™å¯ä»¥ç›´æ¥åé¦ˆå®Œæˆä¿¡å· mInputConsumer.sendFinishedSignal(seq, false); &#125; &#125;&#125; æˆ‘ä»¬å…ˆçœ‹å¦‚ä½•ä»Channelä¸­è·å–eventçš„ï¼Œ3.3ã€‚ç„¶åè®²è§£javaå±‚çš„åˆ†å‘è¿‡ç¨‹ï¼Œ3.4ã€‚ 3.3ä»Chuannelä¸­è¯»å–ä¸€ä¸ªï¼ˆä¸€ç»„ï¼‰eventã€‚ frameworks/native/libs/input/InputTransport.cpp :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051status_t InputConsumer::consume(InputEventFactoryInterface* factory, bool consumeBatches, nsecs_t frameTime, uint32_t* outSeq, InputEvent** outEvent) &#123; *outSeq = 0; *outEvent = NULL; // Fetch the next input message. // Loop until an event can be returned or no additional events are received. while (!*outEvent) &#123; if (mMsgDeferred) &#123; // mMsg contains a valid input message from the previous call to consume // that has not yet been processed. mMsgDeferred = false; &#125; else &#123; // Receive a fresh message. //ä»Channelä¸­è¯»å–ä¸€ä¸ªMessage status_t result = mChannel-&gt;receiveMessage(&amp;mMsg); if (result) &#123; // Consume the next batched event unless batches are being held for later. //.. &#125; &#125; //æ ¹æ®messageç§ç±»æ„é€ event switch (mMsg.header.type) &#123; case InputMessage::TYPE_KEY: &#123; KeyEvent* keyEvent = factory-&gt;createKeyEvent(); if (!keyEvent) return NO_MEMORY; initializeKeyEvent(keyEvent, &amp;mMsg); *outSeq = mMsg.body.key.seq; *outEvent = keyEvent; break; &#125; case AINPUT_EVENT_TYPE_MOTION: &#123; //å¯¹Motion eventï¼Œéœ€è¦å¤„ç†æˆæ‰¹çš„eventäº‹ä»¶ //.. MotionEvent* motionEvent = factory-&gt;createMotionEvent(); if (! motionEvent) return NO_MEMORY; updateTouchState(&amp;mMsg); initializeMotionEvent(motionEvent, &amp;mMsg); *outSeq = mMsg.body.motion.seq; *outEvent = motionEvent; break; &#125; default: return UNKNOWN_ERROR; &#125; &#125; return OK;&#125; mChannel-&gt;receiveMessage(&amp;mMsg)å‡½æ•°åœ¨InputChannelä¸­ä¸»è¦å¦‚ä¸‹å®ç°ï¼Œè°ƒç”¨socketå‡½æ•°recvä»mFdä¸­è¯»å‡ºæ•°æ®ã€‚ frameworks/native/libs/input/InputTransport.cpp :1nRead = ::recv(mFd, msg, sizeof(InputMessage), MSG_DONTWAIT); 3.4å›åˆ°javaå±‚ï¼Œåœ¨è·å¾—eventåï¼Œå°±éœ€è¦è¿›è¡Œåˆ†å‘äº†ã€‚receiverObjæŒ‡å‘çš„æ˜¯ä¸€ä¸ªInputEventReceiverå¯¹è±¡ï¼Œè¿™é‡Œå…¶å®æ˜¯å®ƒçš„å­ç±»WindowInputEventReceiverå¯¹è±¡ï¼Œè§ç¬¬12ç« ç¬¬4èŠ‚ã€‚dispatchInputEventå‡½æ•°è¿˜æ˜¯ç»§æ‰¿çš„çˆ¶ç±»çš„ï¼Œæ²¡æœ‰é‡å†™ã€‚ 3.5è¿™ä¸€æ­¥ç›´æ¥è°ƒç”¨äº†ä¸‹ä¸€æ­¥ã€‚ 3.6å°†eventæ’å…¥ç­‰å¾…äº‹ä»¶é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç„¶åå¼€å§‹è°ƒåº¦è¿™äº›æ¶ˆæ¯ã€‚ frameworks/base/core/java/android/view/ViewRootImpl.java :123456789101112131415161718192021222324252627282930void enqueueInputEvent(InputEvent event, InputEventReceiver receiver, int flags, boolean processImmediately) &#123; adjustInputEventForCompatibility(event); //å°†eventå’Œreceiverå°è£…åœ¨ä¸€èµ· QueuedInputEvent q = obtainQueuedInputEvent(event, receiver, flags); // Always enqueue the input event in order, regardless of its time stamp. // We do this because the application or the IME may inject key events // in response to touch events and we want to ensure that the injected keys // are processed in the order they were received and we cannot trust that // the time stamp of injected events are monotonic. //æ‰¾åˆ°å°¾éƒ¨æ’å…¥ QueuedInputEvent last = mPendingInputEventTail; if (last == null) &#123; mPendingInputEventHead = q; mPendingInputEventTail = q; &#125; else &#123; last.mNext = q; mPendingInputEventTail = q; &#125; mPendingInputEventCount += 1; if (processImmediately) &#123; //ç«‹å³å¤„ç†æ‰€æœ‰çš„InputEvent doProcessInputEvents(); &#125; else &#123; //å‘é€ä¸€ä¸ªæé†’æ¶ˆæ¯ scheduleProcessInputEvents(); &#125; &#125; è¿™é‡Œä¼šæœ‰ä¸¤ç§ä¸åŒçš„å¤„ç†eventçš„æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯ç«‹å³å¤„ç†ï¼›å¦ä¸€ç§æ˜¯å‘ä¸»çº¿ç¨‹Looperå‘é€MSG_PROCESS_INPUT_EVENTSæ¶ˆæ¯ã€‚è¿™é‡Œé€‰æ‹©ç«‹å³å¤„ç†ã€‚ 3.7è¿™é‡Œä¼šæŠŠç­‰å¾…åœ¨é˜Ÿåˆ—ä¸­çš„eventï¼Œä¸€å£æ°”å…¨å¤„ç†äº†ã€‚è¿™ä¸€æ­¥ä¼šå¾ªç¯æ‹¿å‡ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªeventï¼Œç„¶åè°ƒç”¨ä¸‹ä¸€æ­¥è¿›è¡Œå¤„ç†ã€‚ 3.8å‡†å¤‡äº¤ç»™stageå¤„ç†ã€‚ frameworks/base/core/java/android/view/ViewRootImpl.java :12345678910111213141516 private void deliverInputEvent(QueuedInputEvent q) &#123;//...//ä¸‹é¢å¼€å§‹ä»æŸä¸ªstageå¼€å§‹//å¯»æ‰¾é€‚åˆçš„stageè¿›è¡Œå¤„ç† InputStage stage; if (q.shouldSendToSynthesizer()) &#123; stage = mSyntheticInputStage; &#125; else &#123; stage = q.shouldSkipIme() ? mFirstPostImeInputStage : mFirstInputStage; &#125; if (stage != null) &#123; stage.deliver(q); &#125; else &#123; finishInputEvent(q); &#125; &#125; 3.9ä¸‹é¢å°±è®²è§£ä¸€ä¸‹stageæ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚stageå¯ä»¥è¯´æ˜¯å¤„ç†eventçš„ä¸åŒé˜¶æ®µï¼Œå¦‚æœä¸Šä¸€ä¸ªstageå¤„ç†ä¸äº†ï¼Œå°±äº¤ç»™ä¸‹ä¸€ä¸ªstageå¤„ç†ï¼Œæ€»æœ‰ä¸€ä¸ªstageå¯ä»¥å°†eventå¤„ç†æ‰ã€‚è¿™é‡Œstageçš„å¤„ç†é¡ºåºå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š NativePrelmeInputStage: Delivers pre-ime input events to a native activity. Does not support pointer events. å…¶å®æˆ‘ä¹Ÿä¸æ¸…æ¥šåˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæ²¡æœ‰æƒ³åˆ°å…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚ ViewPreImeInputStage: Delivers pre-ime input events to the view hierarchy. Does not support pointer events. è¿™ä¸€æ­¥åªå¤„ç†KeyEventï¼Œåœ¨InputMethodå¤„ç†è¿™ä¸ªKeyEventä¹‹å‰ï¼Œå¯ä»¥æˆªè·è¿™ä¸ªeventã€‚å…¸å‹çš„ä¾‹å­æ˜¯å¤„ç†BACK keyã€‚ ImeInputStage: Delivers input events to the ime. Does not support pointer events. å°†eventäº¤ç»™IputMethodManagerå¤„ç†ã€‚ EarlyPostImeInputStage: Performs early processing of post-ime input events. åœ¨äº¤ç»™ä¸‹ä¸€é˜¶æ®µä¹‹å‰ï¼Œå…ˆå¤„ç†ç­›é€‰ä¸€äº›eventã€‚ NativePostImeInputStage: Delivers post-ime input events to a native activity. å°è¯•è®©InputQueueå‘é€eventç»™native activityã€‚ ViewPostImeInputStage: Delivers post-ime input events to the view hierarchy. å°†eventå‘é€ç»™viewçš„å±‚æ¬¡ç»“æ„ä¸­ã€‚ SyntheticInputStage: Performs synthesis of new input events from unhandled input events. æœ€åä¸€ä¸ªé˜¶æ®µï¼Œå¤„ç†ç»¼åˆäº‹ä»¶ï¼Œæ¯”å¦‚trackball, joystickç­‰ã€‚ è¿™é‡Œæˆ‘ä»¬æš‚ä¸”ç ”ç©¶ç¬¬6ç§stageï¼Œè¿™ä¸ªstageå’ŒViewæœ‰ç›´æ¥å…³ç³»ã€‚ 3.10è¿™é‡Œæ ¹æ®eventçš„ç±»å‹åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬å…ˆå…³æ³¨ä¸€ä¸‹PointerEventå¦‚ä½•å¤„ç†çš„ã€‚ 3.11å°†eventäº¤ç»™mViewæ¥å¤„ç†ï¼Œè¿™é‡ŒmViewå°±æ˜¯ä¸€ä¸ªDecorViewå¯¹è±¡ã€‚ 3.12è¿™ä¸€æ­¥æ˜¯DecorViewç»§æ‰¿è‡ªViewçš„æ–¹æ³•ï¼Œå°†eventåˆ†ä¸ºTouchEventå’ŒGenericMotionEventæ¥å¤„ç†ã€‚å…ˆçœ‹TouchEventå¦‚ä½•å¤„ç†ã€‚ 3.13DecorViewé‡å†™äº†è¯¥å‡½æ•°ã€‚è¿™é‡Œè°ƒç”¨getCallbackå‡½æ•°æ¥è·å–ä¸€ä¸ªå›è°ƒå¯¹è±¡ã€‚è¯¥å‡½æ•°æ˜¯PhoneWindowç»§æ‰¿è‡ªWindowç±»çš„æ–¹æ³•ï¼Œè·å¾—æ˜¯mCallbackã€‚é‚£ä¹ˆè¿™ä¸ªmCallbackåˆ°åº•æ˜¯è°å‘¢ï¼Ÿ å›é¡¾ä¸€ä¸‹Activityçš„åˆ›å»ºè¿‡ç¨‹ï¼Œåœ¨Activityåˆ›å»ºä»¥åä¼šè°ƒç”¨attachå‡½æ•°å¯¹Activityè¿›è¡Œä¸€å®šçš„åˆå§‹åŒ–ï¼Œå…¶ä¸­å°±åˆ›å»ºäº†PhoneWindowï¼ŒåŒæ—¶è®¾ç½®äº†callbackä¸ºActivityå®ƒè‡ªå·±ã€‚æ‰€ä»¥è¿™ä¸€æ­¥è·å¾—æ˜¯ä¸€ä¸ªActivityå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„å‡½æ•°ç»§ç»­åˆ†å‘eventã€‚ 3.14Eventäº¤åˆ°Activityæ‰‹ä¸­è¿›è¡Œå¤„ç†ã€‚ä¸ºä»€ä¹ˆä¼šå…ˆäº¤ç»™Activityå¤„ç†ï¼Ÿç›®çš„æ˜¯è®©å¼€å‘è€…å¯ä»¥é‡å†™è¿™ä¸ªå‡½æ•°ï¼Œä»è€Œå¯ä»¥åœ¨åˆ†å‘è¿™ä¸ªäº‹ä»¶ä¹‹å‰è¿›è¡Œæˆªè·ã€‚ 12345678910111213141516171819202122/** * Called to process touch screen events. You can override this to * intercept all touch screen events before they are dispatched to the * window. Be sure to call this implementation for touch screen events * that should be handled normally. * * @param ev The touch screen event. * * @return boolean Return true if this event was consumed. */public boolean dispatchTouchEvent(MotionEvent ev) &#123; if (ev.getAction() == MotionEvent.ACTION_DOWN) &#123; onUserInteraction(); &#125; //ç»•ä¸€åœˆæœ‰äº¤ç»™PhoneWindowå¤„ç† if (getWindow().superDispatchTouchEvent(ev)) &#123; return true; &#125; //æ²¡æœ‰viewå¯ä»¥å¤„ç†ï¼Œé‚£ä¹ˆactivityè‡ªå·±å¤„ç† //é»˜è®¤å°±æ˜¯æ”¾å¼ƒï¼Œä¹Ÿå¯ä»¥é‡å†™å®ç°ç‰¹å®šåŠŸèƒ½ return onTouchEvent(ev);&#125; 3.15ä»€ä¹ˆä¹Ÿæ²¡åšï¼Œå°†eventä¼ å›DecorViewï¼Œè®©å®ƒå¤„ç†ã€‚ ###3.16è¿™é‡ŒDecorViewåˆäº¤ç»™dispatchTouchEventå¤„ç†ã€‚è¿™é‡Œçš„dispatchTouchEventæ˜¯æºè‡ªçˆ¶ç±»ViewGroupçš„å‡½æ•°ï¼Œè€Œä¸æ˜¯è‡ªå·±é‡å†™çš„å‡½æ•°ã€‚ ###3.17ViewGroupæ˜¯Viewçš„å­ç±»ã€‚å®ƒç®¡ç†äº†ä¸€ç»„Viewåœ¨mChildrenæ•°ç»„ä¸­ï¼ŒæŒ‰ç…§è®¾è®¡æ¨¡å¼çš„è¯´æ³•å«Compositeæ¨¡å¼ã€‚ è¿™ä¸€æ­¥ä¼šä¾æ¬¡è®¿é—®æ¯ä¸ªå­viewï¼Œåˆ¤æ–­ä»–ä»¬æ˜¯å¦å¯ä»¥å¤„ç†è¯¥eventï¼Œå¦‚æœèƒ½å°±äº¤ç»™å®ƒå¤„ç†ï¼›æ²¡äººèƒ½å¤„ç†å°±è‡ªå·±å¤„ç†ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œéƒ½ä¼šè°ƒç”¨ä¸‹ä¸€æ­¥dispatchTransformedTouchEventå‡½æ•°ã€‚ frameworks/base/core/java/android/view/ViewGroup.java :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110public boolean dispatchTouchEvent(MotionEvent ev) &#123; //.. // If the event targets the accessibility focused view and this is it, start // normal event dispatch. Maybe a descendant is what will handle the click. if (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123; ev.setTargetAccessibilityFocus(false); &#125; boolean handled = false; //å¦‚æœWindowæ²¡æœ‰è¢«é®ä½ï¼Œæ‰è¿›è¡Œä»¥ä¸‹è¿‡ç¨‹ if (onFilterTouchEventForSecurity(ev)) &#123; //.. TouchTarget newTouchTarget = null; boolean alreadyDispatchedToNewTouchTarget = false; if (!canceled &amp;&amp; !intercepted) &#123; //.. final int childrenCount = mChildrenCount; if (newTouchTarget == null &amp;&amp; childrenCount != 0) &#123; final float x = ev.getX(actionIndex); final float y = ev.getY(actionIndex); // Find a child that can receive the event. // Scan children from front to back. //æ ¹æ®zåæ ‡è¿›è¡Œæ’åºï¼Œä»å°åˆ°å¤§çš„é¡ºåº final ArrayList&lt;View&gt; preorderedList = buildOrderedChildList(); //ä¹Ÿå¯ä»¥è‡ªå·±å®šåˆ¶é¡ºåº final boolean customOrder = preorderedList == null &amp;&amp; isChildrenDrawingOrderEnabled(); //æ‰€æœ‰å­Viewå­˜æ”¾åœ¨mChildrenä¸­ final View[] children = mChildren; //æŒ‰zçš„å€¼ï¼Œä»å¤§åˆ°å°å¼€å§‹éå† for (int i = childrenCount - 1; i &gt;= 0; i--) &#123; final int childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i; final View child = (preorderedList == null) ? children[childIndex] : preorderedList.get(childIndex); // If there is a view that has accessibility focus we want it // to get the event first and if not handled we will perform a // normal dispatch. We may do a double iteration but this is // safer given the timeframe. //å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªviewå»è·å¾—è¿™ä¸ªeventï¼Œä¸€ç›´å¾ªç¯åˆ°é‚£ä¸ªviewä¸ºæ­¢ if (childWithAccessibilityFocus != null) &#123; if (childWithAccessibilityFocus != child) &#123; continue; &#125; childWithAccessibilityFocus = null; i = childrenCount - 1; &#125; //åˆ¤æ–­è¯¥viewæ˜¯å¦å¯ä»¥æ¥å—è¿™ä¸ªeventï¼Œæ˜¯å¦åœ¨è¿™ä¸ªviewèŒƒå›´å†… if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) &#123; ev.setTargetAccessibilityFocus(false); continue; &#125; //å¦‚æœè¯¥childæ­£åœ¨å¤„ç†ä¸Šä¸€ä¸ªevent newTouchTarget = getTouchTarget(child); if (newTouchTarget != null) &#123; // Child is already receiving touch within its bounds. // Give it the new pointer in addition to the ones it is handling. newTouchTarget.pointerIdBits |= idBitsToAssign; break; &#125; //å°è¯•å»å‘è¯¥childå‘é€event if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) &#123; // Child wants to receive touch within its bounds. //.. //å°†childåŠ å…¥mFirstTouchTargetä¸ºé¦–çš„é˜Ÿåˆ—å¤´éƒ¨ newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; break; &#125; //.. &#125; &#125; &#125; &#125; // Dispatch to touch targets. if (mFirstTouchTarget == null) &#123; //æ²¡æœ‰childå¯ä»¥å¤„ç†ï¼Œé‚£ä¹ˆå°±è‡ªå·±å¤„ç† // No touch targets so treat this as an ordinary view. handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS); &#125; else &#123; // Dispatch to touch targets, excluding the new touch target if we already // dispatched to it. Cancel touch targets if necessary. TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) &#123; final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123; handled = true; &#125; else &#123; //.. if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) &#123; handled = true; &#125; //.. &#125; predecessor = target; target = next; &#125; &#125; //.. &#125; return handled;&#125; 3.18ViewGroupä¼šå†³å®šè‡ªå·±å¤„ç†è¿˜æ˜¯äº¤ç»™childå¤„ç†ã€‚åœ¨ViewGroupè‡ªå·±å¤„ç†ï¼Œæˆ–è€…childä¸ºä¸å†æ˜¯ä¸€ä¸ªViewGroupæ—¶ï¼Œåˆ™å¼€å§‹è°ƒç”¨Viewçš„dispatchTouchEventå‡½æ•°ã€‚ frameworks/base/core/java/android/view/ViewGroup.java :123456789//çœç•¥äº†è®¡ç®—åæ ‡ä¾¿å®œçš„è¿‡ç¨‹if (child == null) &#123; //ViewGroupå†³å®šè‡ªå·±å¤„ç† handled = super.dispatchTouchEvent(event);&#125; else &#123; //äº¤ç»™childå¤„ç†ï¼Œchildå¯èƒ½æ˜¯ä¸ªview //ä¹Ÿå¯èƒ½è¿˜æ˜¯ä¸ªViewGroupï¼Œè¿™å°±é‡å¤3.17æ­¥éª¤ handled = child.dispatchTouchEvent(event);&#125; 3.19è¿™ä¸€æ­¥å°±ä¼šè°ƒç”¨ç”¨æˆ·è‡ªå·±å®ç°çš„Listenerï¼›å¦‚æœæ²¡æœ‰Listenerï¼Œåˆ™ä¼šè°ƒç”¨viewé»˜è®¤çš„å¤„ç†å‡½æ•°ã€‚ frameworks/base/core/java/android/view/View.java :12345678910111213141516171819202122232425262728293031public boolean dispatchTouchEvent(MotionEvent event) &#123; // If the event should be handled by accessibility focus first. if (event.isTargetAccessibilityFocus()) &#123; // We don't have focus or no virtual descendant has it, do not handle the event. if (!isAccessibilityFocusedViewOrHost()) &#123; //è¯¥Viewä¸å¯è®¿é—®çš„çŠ¶æ€ï¼Œè¿”å› return false; &#125; &#125; boolean result = false; //.. //å…ˆåˆ¤æ–­è¯¥Viewæ˜¯å¦è¢«é®æŒ¡ï¼Œæ²¡è¢«é®æŒ¡æ‰è¿›è¡Œå¤„ç† if (onFilterTouchEventForSecurity(event)) &#123; //noinspection SimplifiableIfStatement //è·å¾—æ³¨å†Œçš„Listenerï¼Œçœ‹æ˜¯å¦æœ‰æ³¨å†ŒOnTouchListener ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123; //è°ƒç”¨Listenerçš„å›è°ƒå‡½æ•°ï¼Œå¤„ç†event result = true; &#125; //Viewä¹Ÿå¯ä»¥é‡‡ç”¨é»˜è®¤çš„å¤„ç†onTouchEvent if (!result &amp;&amp; onTouchEvent(event)) &#123; result = true; &#125; &#125; //.. return result; &#125; é»˜è®¤å¤„ç†å‡½æ•°onTouchEventä¼šå¤„ç†ä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œæ¯”å¦‚buttonçš„æŒ‰ä¸‹æ¾å¼€çš„æ•ˆæœï¼Œæ»šåŠ¨å®¹å™¨äº§ç”Ÿæ»šåŠ¨çš„æ•ˆæœç­‰ã€‚ 3.20åœ¨InputStageå®Œæˆå¤„ç†eventçš„ä»»åŠ¡åï¼Œä¼šå¼€å§‹è¿”å›å®Œæˆçš„æ¶ˆæ¯ã€‚ 3.21å¼€å§‹è°ƒç”¨c++å‡½æ•°ã€‚ 3.22å°†æŒ‡é’ˆè½¬åŒ–ä¸ºNativeInputEventReceiveræŒ‡é’ˆï¼Œäº¤ç»™å®ƒæ¥å¤„ç†ã€‚ frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š123sp&lt;NativeInputEventReceiver&gt; receiver = reinterpret_cast&lt;NativeInputEventReceiver*&gt;(receiverPtr);status_t status = receiver-&gt;finishInputEvent(seq, handled); 3.23InputConsumerä¾æ¬¡å¤„ç†æ¯ä¸ªsequenceï¼Œå‘é€å®Œæˆä¿¡å·ã€‚ 3.24å‘channelå‘é€å®Œæˆæ¶ˆæ¯ã€‚ 1234567status_t InputConsumer::sendUnchainedFinishedSignal(uint32_t seq, bool handled) &#123; InputMessage msg; msg.header.type = InputMessage::TYPE_FINISHED; msg.body.finished.seq = seq; msg.body.finished.handled = handled; return mChannel-&gt;sendMessage(&amp;msg);&#125; å‘Channelå†™å…¥äº‹ä»¶åï¼Œå¤„äºç¡çœ çš„InputDispatcherè¢«å”¤é†’ï¼Œå¼€å§‹åˆ†å‘ä¸‹ä¸€ä¸ªeventã€‚ æœ€åè¯´ä¸¤å¥åˆ°è¿™é‡Œï¼ŒInput eventçš„å¤„ç†æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œå¿ƒå¥½ç´¯ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(12):InputChannelçš„æ³¨å†Œè¿‡ç¨‹","date":"2017-02-14T06:24:58.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-12-InputChannelçš„æ³¨å†Œè¿‡ç¨‹/","text":"è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ InputManagerå¯ä»¥è·å¾—è¾“å…¥äº‹ä»¶å¹¶åˆ†å‘ï¼ŒActivityéœ€è¦å¤„ç†è¿™äº›è¾“å…¥äº‹ä»¶ã€‚é‚£ä¹ˆï¼Œè¿™ä¸¤è€…ä¹‹é—´å¦‚ä½•å»ºç«‹çš„è¿æ¥å‘¢ï¼Ÿè¿™å°±éœ€è¦InputChannelä½œä¸ºæ¡¥æ¢å»ºç«‹ä¸¤è€…ä¹‹é—´çš„é€šé“ã€‚ 1. ViewRootImplåˆ›å»ºInputChannelè¿™é‡ŒViewRootç±»å·²ç»æ¶ˆå¤±äº†ï¼Œç”±ViewRootImplæ›¿ä»£ã€‚Activityåœ¨åˆ›å»ºæ—¶ä¼šå°†è‡ªå·±çš„DecorViewè®¾ç½®ç»™å¯¹åº”çš„ViewRootImplã€‚ 1.1è¿™ä¸€æ­¥ä¼šåˆ›å»ºclientçš„InputChannelï¼Œå¹¶ä¸”å°†å½“å‰å¯åŠ¨çš„Activityçš„çª—å£ä¼ é€’ç»™WindowManagerServiceã€‚ frameworks/base/core/java/android/view/ViewRootImpl.java123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354/** * We have one child */public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) &#123; synchronized (this) &#123; if (mView == null) &#123; //å°†viewè®¾ç½®ä¸ºä¼ å…¥çš„DecorView mView = view; //.. mAdded = true; int res; /* = WindowManagerImpl.ADD_OKAY; */ //æ–°å»ºInputChannel if ((mWindowAttributes.inputFeatures &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == 0) &#123; mInputChannel = new InputChannel(); &#125; try &#123; mOrigWindowType = mWindowAttributes.type; mAttachInfo.mRecomputeGlobalAttributes = true; collectViewAttributes(); //mWindowSessionæ˜¯ä¸€ä¸ªBinderä»£ç†å¯¹è±¡ //å®ƒå¼•ç”¨äº†è¿è¡Œåœ¨WindowManagerServiceä¸­çš„ä¸€ä¸ªç±»å‹ä¸ºSessionçš„Binderæœ¬åœ°å¯¹è±¡ //å‘WindowManagerServiceæ·»åŠ æ­£åœ¨å¯åŠ¨çš„Activityçš„çª—å£ //è¿™é‡Œè¿˜ä¼šå°†InputChannelä¼ é€’è¿‡å» res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), mAttachInfo.mContentInsets, mAttachInfo.mStableInsets, mAttachInfo.mOutsets, mInputChannel); &#125; catch (RemoteException e) &#123; //.. &#125; finally &#123; //.. &#125; //.. if (view instanceof RootViewSurfaceTaker) &#123; mInputQueueCallback = ((RootViewSurfaceTaker)view).willYouTakeTheInputQueue(); &#125; if (mInputChannel != null) &#123; if (mInputQueueCallback != null) &#123; mInputQueue = new InputQueue(); mInputQueueCallback.onInputQueueCreated(mInputQueue); &#125; //å°†InputChannelå’Œä¸»çº¿ç¨‹å…³è”èµ·æ¥ï¼Œåœ¨ä¸‹é¢ä¼šè¯¦ç»†è®²è§£ mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper()); &#125; view.assignParent(this); &#125; &#125;&#125; 1.2è¿™ä¸€æ­¥æ˜¯è¿›ç¨‹é—´çš„è¯·æ±‚ï¼Œä»åº”ç”¨è¿›ç¨‹è½¬åˆ°WindowManagerServiceè¿›ç¨‹ï¼Œå¯¹åº”äº1.1ä¸­çš„å‡½æ•°addToDisplayã€‚è¿™é‡Œä¼šè¡¥è¶³ä¸€äº›å‚æ•°ï¼Œå¼€å§‹è°ƒç”¨ä¸‹ä¸€æ­¥å‡½æ•°ã€‚ 1.3è¿™ä¸€æ­¥ä¹Ÿæ˜¯è°ƒæ•´ä¸€äº›å‚æ•°ï¼Œç„¶åäº¤ç»™WindowManagerServiceæ¥å¤„ç†ã€‚ 1.4è¿™é‡Œä¼šå°†ä¼ å…¥çš„Windowå­˜å…¥Mapæ¥è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼ŒåŒæ—¶åˆ›å»ºäº†ä¸€å¯¹server/clientç«¯çš„InputChannelã€‚ frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java :1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public int addWindow(Session session, IWindow client, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) &#123; //å…ˆå¯¹æ·»åŠ çš„windowåšä¸€äº›æ£€æŸ¥ï¼Œçœç•¥.. //åˆ›å»ºäº†ä¸€ä¸ªWindowSateteå¯¹è±¡ WindowState win = new WindowState(this, session, client, token, attachedWindow, appOp[0], seq, attrs, viewVisibility, displayContent); //.. if (outInputChannel != null &amp;&amp; (attrs.inputFeatures &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == 0) &#123; String name = win.makeInputChannelName(); //åˆ›å»ºäº†ä¸€ä¸ªInputChannelå¯¹ï¼Œåœ¨1.5ä¸­è¯¦ç»†è®²è§£ InputChannel[] inputChannels = InputChannel.openInputChannelPair(name); //ä¸€ä¸ªæ”¾åœ¨WindowStateé‡Œä½œä¸ºserverç«¯çš„InputChannel win.setInputChannel(inputChannels[0]); //ä¸€ä¸ªè½¬åŒ–ä¸ºclientä¼ é€’è¿‡æ¥çš„outInputChannel inputChannels[1].transferTo(outInputChannel); //ä»ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„1.1å¯çŸ¥ï¼ŒInputManagerä½œä¸ºå‚æ•°ä¼ å…¥ //WindowManagerServiceçš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å­˜æ”¾åœ¨mInputManagerä¸­ //ä¸‹é¢ç« èŠ‚ä¼šè¯¦ç»†è®²è¿°å¦‚ä½•æ³¨å†Œserverç«¯çš„InputChannel mInputManager.registerInputChannel(win.mInputChannel, win.mInputWindowHandle); &#125; // From now on, no exceptions or errors allowed! //å°†winæ”¾å…¥mWindowMapï¼Œä»¥clientçš„binderä¸ºå…³é”®å­— mWindowMap.put(client.asBinder(), win); //å°†winåŠ å…¥ç›¸åº”çš„listï¼Œçœç•¥.. mInputMonitor.setUpdateInputWindowsNeededLw(); boolean focusChanged = false; if (win.canReceiveKeys()) &#123; focusChanged = updateFocusedWindowLocked(UPDATE_FOCUS_WILL_ASSIGN_LAYERS, false /*updateInputWindows*/); if (focusChanged) &#123; imMayMove = false; &#125; &#125; if (imMayMove) &#123; moveInputMethodWindowsIfNeededLocked(false); &#125; assignLayersLocked(displayContent.getWindowList()); // Don't do layout here, the window must call // relayout to be displayed, so we'll do it there. if (focusChanged) &#123; mInputMonitor.setInputFocusLw(mCurrentFocus, false /*updateInputWindows*/); &#125; mInputMonitor.updateInputWindowsLw(false /*force*/); &#125; return res; &#125; 1.5è¿™ä¸€æ­¥ä¼šå°†ä»»åŠ¡äº¤ç»™c++å±‚æ¥å¤„ç†ã€‚ 1.6è¿™ä¸€æ­¥å¯¹åº”çš„c++çš„å‡½æ•°ä¸ºandroid_view_InputChannel_nativeOpenInputChannelPairï¼Œå®ƒä¼šåˆ›å»ºä¸¤ä¸ªInputChannelï¼Œå¹¶è¿”å›ã€‚ frameworks/base/core/jni/android_view_InputChannel.cpp :12345678910111213141516171819202122232425static jobjectArray android_view_InputChannel_nativeOpenInputChannelPair(JNIEnv* env, jclass clazz, jstring nameObj) &#123; //å°†java Stringå˜ä¸ºchar* const char* nameChars = env-&gt;GetStringUTFChars(nameObj, NULL); String8 name(nameChars); env-&gt;ReleaseStringUTFChars(nameObj, nameChars); sp&lt;InputChannel&gt; serverChannel; sp&lt;InputChannel&gt; clientChannel; //åˆ›å»ºc++å±‚çš„ä¸¤ä¸ªChannelï¼Œå°†åœ¨ä¸‹ä¸€æ­¥è¯¦ç»†è®²è§£ status_t result = InputChannel::openInputChannelPair(name, serverChannel, clientChannel); jobjectArray channelPair = env-&gt;NewObjectArray(2, gInputChannelClassInfo.clazz, NULL); //åˆ›å»ºjavaçš„server channel jobject serverChannelObj = android_view_InputChannel_createInputChannel(env, new NativeInputChannel(serverChannel)); //åˆ›å»ºjavaçš„client channel jobject clientChannelObj = android_view_InputChannel_createInputChannel(env, new NativeInputChannel(clientChannel)); //å­˜å…¥javaæ•°ç»„ env-&gt;SetObjectArrayElement(channelPair, 0, serverChannelObj); env-&gt;SetObjectArrayElement(channelPair, 1, clientChannelObj); return channelPair;&#125; 1.7æ³¨æ„ï¼Œè¿™ä¸€æ­¥çœŸçš„è¦åˆ›å»ºChannelPairäº†ã€‚ frameworks/native/libs/input/InputTransport.cpp :123456789101112131415161718192021222324252627282930status_t InputChannel::openInputChannelPair(const String8&amp; name, sp&lt;InputChannel&gt;&amp; outServerChannel, sp&lt;InputChannel&gt;&amp; outClientChannel) &#123; int sockets[2]; //è¿™ä¸ªsocketpairå»ºç«‹çš„æ˜¯ä¸€ä¸ªå¯ä»¥åŒå‘é€šä¿¡çš„ç®¡é“ï¼Œåˆ›å»ºä¸€å¯¹å¥—æ¥å­—æè¿°ç¬¦ if (socketpair(AF_UNIX, SOCK_SEQPACKET, 0, sockets)) &#123; status_t result = -errno; ALOGE(\"channel '%s' ~ Could not create socket pair. errno=%d\", name.string(), errno); outServerChannel.clear(); outClientChannel.clear(); return result; &#125; //è®¾ç½®ç®¡é“ç¼“å­˜çš„å¤§å° int bufferSize = SOCKET_BUFFER_SIZE; setsockopt(sockets[0], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, sizeof(bufferSize)); setsockopt(sockets[0], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, sizeof(bufferSize)); setsockopt(sockets[1], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, sizeof(bufferSize)); setsockopt(sockets[1], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, sizeof(bufferSize)); //å¼€å§‹new ä¸¤ä¸ªInputChannel String8 serverChannelName = name; serverChannelName.append(\" (server)\"); outServerChannel = new InputChannel(serverChannelName, sockets[0]); String8 clientChannelName = name; clientChannelName.append(\" (client)\"); outClientChannel = new InputChannel(clientChannelName, sockets[1]); return OK;&#125; socketpairåˆ›å»ºäº†ä¸€å¯¹æ— åçš„å¥—æ¥å­—æè¿°ç¬¦ï¼ˆåªèƒ½åœ¨AF_UNIXåŸŸä¸­ä½¿ç”¨ï¼‰ï¼Œæè¿°ç¬¦å­˜å‚¨äºä¸€ä¸ªäºŒå…ƒæ•°ç»„s[2] .è¿™å¯¹å¥—æ¥å­—å¯ä»¥è¿›è¡ŒåŒå·¥é€šä¿¡ï¼Œæ¯ä¸€ä¸ªæè¿°ç¬¦æ—¢å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ã€‚è¿™ä¸ªåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ä¹Ÿå¯ä»¥è¿›è¡Œé€šä¿¡ï¼Œå‘s[0]ä¸­å†™å…¥ï¼Œå°±å¯ä»¥ä»s[1]ä¸­è¯»å–ï¼ˆåªèƒ½ä»s[1]ä¸­è¯»å–ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨s[1]ä¸­å†™å…¥ï¼Œç„¶åä»s[0]ä¸­è¯»å–ï¼›ä½†æ˜¯ï¼Œè‹¥æ²¡æœ‰åœ¨0ç«¯å†™å…¥ï¼Œè€Œä»1ç«¯è¯»å–ï¼Œåˆ™1ç«¯çš„è¯»å–æ“ä½œä¼šé˜»å¡ï¼Œå³ä½¿åœ¨1ç«¯å†™å…¥ï¼Œä¹Ÿä¸èƒ½ä»1è¯»å–ï¼Œä»ç„¶é˜»å¡ï¼›åä¹‹äº¦ç„¶ã€‚è¯¥æ®µè§£é‡Šæ¥è‡ªã€‚ è¿™é‡Œnewäº†ä¸¤ä¸ªInputChannelï¼Œè¯¥ç±»çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š frameworks/native/libs/input/InputTransport.cpp :123456InputChannel::InputChannel(const String8&amp; name, int fd) : mName(name), mFd(fd) &#123; //.. int result = fcntl(mFd, F_SETFL, O_NONBLOCK); //..&#125; è¿™é‡Œå°†æè¿°ç¬¦mFdè®¾ç½®ä¸ºnonblockã€‚ æ˜¾ç„¶ï¼Œè¿™é‡Œå’ŒAndroid 2.3ç‰ˆæœ¬æœ‰ç€å¾ˆå¤§åŒºåˆ«ã€‚åœ¨æ—§ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„æ˜¯åŒ¿åå…±äº«å†…å­˜å’Œä¸¤ä¸ªpipeæ¥å®ç°åŒå‘çš„é€šä¿¡ã€‚æ˜¾ç„¶ï¼Œæ–°ç‰ˆæœ¬åˆ©ç”¨çš„linuxç³»ç»Ÿçš„æ–°æœºåˆ¶ï¼Œæ›´ä¸ºç®€æ´é«˜æ•ˆã€‚ ä»¥ä¸Šæ­¥éª¤å®åœ¨æ–°Activityå»ºç«‹ï¼Œçª—å£å¼€å§‹åˆ›å»ºæ—¶æ‰§è¡Œçš„ã€‚è¿™é‡Œä¸»è¦å°±è®©WindowManagerServiceå»ºç«‹ä¸€å¯¹InputChannelï¼Œå°†Activityçš„Windowå’ŒInputDispatcherå»ºç«‹èµ·è¿æ¥ï¼Œä»è€Œä¼ è¾“è¾“å…¥äº‹ä»¶ã€‚ 2. Serverç«¯æ³¨å†ŒInputChannelåœ¨1.4ä¸­ï¼Œåˆ›å»ºäº†ä¸€å¯¹InputChannelï¼Œå…¶ä¸­Serverç«¯çš„InputChannelä¼šæ³¨å†Œè¿›InputManagerServiceã€‚ 1mInputManager.registerInputChannel(win.mInputChannel, win.mInputWindowHandle); 2.1è¿™ä¸€æ­¥å°±æ£€éªŒäº†ä¸€ä¸‹ä¼ å…¥çš„InputChannelæ˜¯å¦ä¸ºç©ºã€‚ä¸‹é¢ä¸€è¨€ä¸åˆå°±å¼€å§‹è°ƒç”¨nativeå‡½æ•°ã€‚ 2.2frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :123456789101112//å°†æŒ‡é’ˆè½¬åŒ–ä¸ºNativeInputManagerNativeInputManager* im = reinterpret_cast&lt;NativeInputManager*&gt;(ptr);//å°†javaçš„InputChannelå¯¹è±¡è½¬åŒ–ä¸ºä¸€ä¸ªc++å±‚çš„InputChannelå¯¹è±¡sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env, inputChannelObj);//å°†InputWindowHandleè½¬åŒ–ä¸ºc++å±‚çš„InputWindowHandlersp&lt;InputWindowHandle&gt; inputWindowHandle = android_server_InputWindowHandle_getHandle(env, inputWindowHandleObj);//å°†æ³¨å†Œä»»åŠ¡äº¤ç»™NativeInputManagerstatus_t status = im-&gt;registerInputChannel(env, inputChannel, inputWindowHandle, monitor);//.. 2.3è¿™ä¸€æ­¥é€šè¿‡NativeInputManagerä¸­çš„InputManagerï¼ŒInputManageré€šè¿‡InputDispatcheræ¥æ³¨å†ŒInputChannelã€‚frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :12mInputManager-&gt;getDispatcher()-&gt;registerInputChannel( inputChannel, inputWindowHandle, monitor); 2.4ç»ˆäºï¼Œå°†Serverç«¯çš„InputChanneläº¤ç»™äº†InputDispatcherã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :12345678910111213141516171819AutoMutex _l(mLock);//åˆ¤æ–­æ˜¯å¦è¯¥InputChannelå·²ç»æ·»åŠ è¿‡if (getConnectionIndexLocked(inputChannel) &gt;= 0) &#123; ALOGW(\"Attempted to register already registered input channel '%s'\", inputChannel-&gt;getName().string()); return BAD_VALUE;&#125;//åˆ›å»ºä¸€ä¸ªConnectionsp&lt;Connection&gt; connection = new Connection(inputChannel, inputWindowHandle, monitor);//è·å¾—InputChannelçš„æ–‡ä»¶æè¿°ç¬¦int fd = inputChannel-&gt;getFd();//å°†Connection ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºå…³é”®å­—ï¼Œæ·»åŠ å…¥mmConnectionsByFd.add(fd, connection);//..//å°†æ–‡ä»¶æè¿°ç¬¦æ·»åŠ Looperï¼Œè®©Looperç›‘æ§InputChannelçš„IOäº‹ä»¶//å½“IOäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šè°ƒç”¨å›è°ƒå‡½æ•°handleReceiveCallbackmLooper-&gt;addFd(fd, 0, ALOOPER_EVENT_INPUT, handleReceiveCallback, this); åˆ°è¿™ä¸€æ­¥ï¼ŒInputDispatcherå·²ç»å°†InputChannelçš„Serverç«¯ç®¡ç†èµ·æ¥äº†ã€‚å½“Dispatcherå°†ä¸€ä¸ªäº‹ä»¶é€šè¿‡Channelå‘é€ç»™åº”ç”¨ç¨‹åºçª—å£ä»¥åï¼Œä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°åº”ç”¨çª—å£å†æ¬¡é€šè¿‡è¿™ä¸ªChannelè¿”å›ä¸€ä¸ªæ¶ˆæ¯å°†å…¶æ¿€æ´»ï¼ŒDispatcheræ‰å‡†å¤‡å‘é€ä¸‹ä¸€ä¸ªæ¶ˆæ¯ã€‚ è¿™é‡Œåˆ›å»ºçš„Connectionï¼ŒConnectionä¸­åˆåˆ›å»ºäº†InputPublisherã€‚InputPublisherå¯ä»¥ç›´æ¥å°†æ¶ˆæ¯é€šè¿‡è¿™ä¸ªInputChannelå‘é€å‡ºå»ã€‚ 3. å‘InputManagerServiceæ³¨å†Œå½“å‰æ¿€æ´»çš„åº”ç”¨ç¨‹åºçª—å£å†æ¬¡å›é¡¾ä¸€ä¸‹1.4çš„ï¼Œåœ¨1.4ä¸­WindowManagerServiceåœ¨ç„¦ç‚¹å‘ç”Ÿæ”¹å˜æ—¶ï¼Œéœ€è¦æ”¹å˜Focused Windowã€‚è¿™é‡Œä¼šåœ¨InputMonitorä¸­æ³¨å†Œå½“å‰æ¿€æ´»çš„çª—å£ã€‚ 3.1åœ¨InputMonitorä¸­ï¼Œæœ‰mInputFocusä¿å­˜ç€å½“å‰æ¿€æ´»çš„çª—å£ï¼Œè¿™é‡Œä¼šå°†mInputFocusè®¾ç½®ä¸ºä¼ å…¥çš„newWindowã€‚ç„¶åè°ƒç”¨updateInputWindowLWç»§ç»­æ›´æ–°æ¿€æ´»çš„çª—å£ã€‚ 3.2åœ¨1.4ä¸­ï¼Œæ¯ä¸ªwindowä¼šè¢«åŠ å…¥ä¸€ä¸ªWindow Listã€‚è¿™é‡Œä¼šéå†è¿™äº›Listä¸­çš„Windowsï¼Œç„¶åå°†è¿™äº›windowsè¿›ä¸€æ­¥äº¤ç»™InputManagerServiceå¤„ç†ã€‚ rameworks/base/services/core/java/com/android/server/wm/InputMonitor.java :123456789101112131415161718192021222324252627282930313233343536373839404142// Populate the input window list with information about all of the windows that// could potentially receive input.// As an optimization, we could try to prune the list of windows but this turns// out to be difficult because only the native code knows for sure which window// currently has touch focus.//..// Add all windows on the default display.//mServiceæŒ‡WindowManagerServicefinal int numDisplays = mService.mDisplayContents.size();for (int displayNdx = 0; displayNdx &lt; numDisplays; ++displayNdx) &#123; WindowList windows = mService.mDisplayContents.valueAt(displayNdx).getWindowList(); for (int winNdx = windows.size() - 1; winNdx &gt;= 0; --winNdx) &#123; final WindowState child = windows.get(winNdx); final InputChannel inputChannel = child.mInputChannel; final InputWindowHandle inputWindowHandle = child.mInputWindowHandle; if (inputChannel == null || inputWindowHandle == null || child.mRemoved) &#123; // Skip this window because it cannot possibly receive input. continue; &#125; //.. final int flags = child.mAttrs.flags; final int privateFlags = child.mAttrs.privateFlags; final int type = child.mAttrs.type; //åªæœ‰ä¸€ä¸ªwindowå¯ä»¥è·å¾—Focus final boolean hasFocus = (child == mInputFocus); final boolean isVisible = child.isVisibleLw(); //.. addInputWindowHandleLw(inputWindowHandle, child, flags, type, isVisible, hasFocus, hasWallpaper); &#125;&#125;// Send windows to native code.//å°†è¿™äº›windowsäº¤ç»™InputManagerç»§ç»­è¿›è¡Œæ³¨å†ŒmService.mInputManager.setInputWindows(mInputWindowHandles);// Clear the list in preparation for the next round.clearInputWindowHandlesLw(); 3.3è¿™ä¸€æ­¥InputManagerServiceå°†ä»»åŠ¡äº¤ç»™äº†c++å±‚ã€‚ 3.4è¿›å…¥c++å±‚ï¼Œå°†è¿™äº›windowHandlesäº¤ç»™NativeInputManagerã€‚ frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :1234567static void nativeSetInputWindows(JNIEnv* env, jclass /* clazz */, jlong ptr, jobjectArray windowHandleObjArray) &#123; //å°†ptrè½¬åŒ–ä¸ºæŒ‡é’ˆ NativeInputManager* im = reinterpret_cast&lt;NativeInputManager*&gt;(ptr); //windowHandleObjArrayæ˜¯ä¼ å…¥çš„windowHandles im-&gt;setInputWindows(env, windowHandleObjArray);&#125; 3.5è¿™ä¸€æ­¥å…ˆå°†javaçš„windowHandleå˜ä¸ºc++å¯¹è±¡ï¼Œç„¶åè¿™äº›windowHandleè¢«äº¤ç»™InputDispatcherå¤„ç†ã€‚ frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :1234567891011121314151617181920if (windowHandleObjArray) &#123; jsize length = env-&gt;GetArrayLength(windowHandleObjArray); //å°†javaå¯¹è±¡è½¬åŒ–ä¸ºc++å¯¹è±¡ for (jsize i = 0; i &lt; length; i++) &#123; jobject windowHandleObj = env-&gt;GetObjectArrayElement(windowHandleObjArray, i); if (! windowHandleObj) &#123; break; // found null element indicating end of used portion of the array &#125; sp&lt;InputWindowHandle&gt; windowHandle = android_server_InputWindowHandle_getHandle(env, windowHandleObj); if (windowHandle != NULL) &#123; windowHandles.push(windowHandle); &#125; env-&gt;DeleteLocalRef(windowHandleObj); &#125; &#125; //å°†è¿™äº›windowHandlesäº¤ç»™Dispatcherå¤„ç† mInputManager-&gt;getDispatcher()-&gt;setInputWindows(windowHandles); 3.6InputDispatcherè·Ÿæ–°WindowHandleï¼Œå¹¶ä¸”æ›´æ–°Focused windowã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp ï¼š1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556&#123; // acquire lock AutoMutex _l(mLock); //æ¸…ç†æ—§çš„WindowHandle Vector&lt;sp&lt;InputWindowHandle&gt; &gt; oldWindowHandles = mWindowHandles; mWindowHandles = inputWindowHandles; sp&lt;InputWindowHandle&gt; newFocusedWindowHandle; bool foundHoveredWindow = false; //æ‰¾åˆ°æ–°çš„Focused WindowHandle for (size_t i = 0; i &lt; mWindowHandles.size(); i++) &#123; const sp&lt;InputWindowHandle&gt;&amp; windowHandle = mWindowHandles.itemAt(i); if (!windowHandle-&gt;updateInfo() || windowHandle-&gt;getInputChannel() == NULL) &#123; mWindowHandles.removeAt(i--); continue; &#125; if (windowHandle-&gt;getInfo()-&gt;hasFocus) &#123; newFocusedWindowHandle = windowHandle; &#125; if (windowHandle == mLastHoverWindowHandle) &#123; foundHoveredWindow = true; &#125; &#125; if (!foundHoveredWindow) &#123; mLastHoverWindowHandle = NULL; &#125; if (mFocusedWindowHandle != newFocusedWindowHandle) &#123; //æ—§çš„FocusedWindowå’Œæ–°çš„ä¸åŒï¼Œåˆ™éœ€è¦åœæ­¢å‘æ—§çš„Channelä¸­å‘é€æ¶ˆæ¯ if (mFocusedWindowHandle != NULL) &#123; sp&lt;InputChannel&gt; focusedInputChannel = mFocusedWindowHandle-&gt;getInputChannel(); if (focusedInputChannel != NULL) &#123; synthesizeCancelationEventsForInputChannelLocked( focusedInputChannel, options); &#125; &#125; //è®¾ç½®æ–°çš„Focused Window mFocusedWindowHandle = newFocusedWindowHandle; &#125; // Release information for windows that are no longer present. // This ensures that unused input channels are released promptly. // Otherwise, they might stick around until the window handle is destroyed // which might not happen until the next GC. for (size_t i = 0; i &lt; oldWindowHandles.size(); i++) &#123; const sp&lt;InputWindowHandle&gt;&amp; oldWindowHandle = oldWindowHandles.itemAt(i); if (!hasWindowHandleLocked(oldWindowHandle)) &#123; //é‡Šæ”¾å·²ç»ä¸å­˜åœ¨çš„æ—§Window oldWindowHandle-&gt;releaseInfo(); &#125; &#125;&#125; // release lock// Wake up poll loop since it may need to make new input dispatching choices.mLooper-&gt;wake(); åˆ°è¿™é‡Œï¼ŒInputDispatcherè·å–äº†å’Œæ¿€æ´»çš„Windowçš„åŒå‘é€šä¿¡é€šé“ï¼ŒåŒæ—¶Dispatcherä¹ŸçŸ¥é“äº†æ˜¯å“ªä¸ªWindowå¤„äºFocusedçŠ¶æ€ã€‚åªè¦Clientç«¯å°†é€šä¿¡é€šé“å»ºç«‹å®Œæ¯•ï¼Œåˆ™Dispatcherå¯ä»¥å‘Activityçš„Windowå‘é€æ¶ˆæ¯äº†ã€‚ 4. Clientç«¯æ³¨å†ŒInputChannel1mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper()); åœ¨1.1ä¸­ï¼Œé€šè¿‡WindowSessionæ·»åŠ Windowå’ŒInputChannelåï¼ŒmInputChannelå¯¹è±¡å·²ç»è½¬åŒ–ä¸ºåŒå‘é€šé“ä¸­çš„clientç«¯é€šé“äº†ï¼Œä»1.4å¯ä»¥çŸ¥é“ã€‚ç„¶åï¼Œè¯¥æ­¥éª¤åˆåˆ›å»ºäº†ä¸€ä¸ªWindowInputEventReceiverç±»çš„å¯¹è±¡mInputEventReceiverï¼Œå®ƒå°†mInputChannelå’Œä¸»çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚ ä¸‹é¢å°±çœ‹ä¸€ä¸‹WindowInputEventReceiverçš„æ„é€ è¿‡ç¨‹ã€‚ 4.1WindowInputEventReceiveræ˜¯InputEventReceiverçš„å­ç±»ï¼Œå…·ä½“æ„é€ è¿‡ç¨‹åœ¨InputEventReceiverä¸­ã€‚ 4.2è¿™ä¸€æ­¥åˆå¼€å§‹è°ƒç”¨nativeå‡½æ•°ã€‚ frameworks/base/core/java/android/view/InputEventReceiver.java:123mInputChannel = inputChannel;mMessageQueue = looper.getQueue();mReceiverPtr = nativeInit(new WeakReference&lt;InputEventReceiver&gt;(this), inputChannel, mMessageQueue); 4.3åˆ›å»ºc++å±‚çš„NativeInputEventReceiverã€‚ frameworks/base/core/jni/android_view_InputEventReceiver.cpp :1234567891011121314151617181920static jlong nativeInit(JNIEnv* env, jclass clazz, jobject receiverWeak, jobject inputChannelObj, jobject messageQueueObj) &#123; //å°†javaå¯¹è±¡è½¬åŒ–ä¸ºc++å¯¹è±¡ sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env, inputChannelObj); //ä¼ å…¥çš„java MessageQueueè½¬åŒ–ä¸ºc++çš„MessageQueue sp&lt;MessageQueue&gt; messageQueue = android_os_MessageQueue_getMessageQueue(env, messageQueueObj); //.. //åˆ›å»ºäº†ä¸€ä¸ªNativeInputEventReceiverï¼Œæ„é€ å‡½æ•°åœ¨ä¸‹é¢ sp&lt;NativeInputEventReceiver&gt; receiver = new NativeInputEventReceiver(env, receiverWeak, inputChannel, messageQueue); //å¯¹å…¶è¿›è¡Œåˆå§‹åŒ– status_t status = receiver-&gt;initialize(); //è¿”å›ä¸€ä¸ªNativeInputEventReceiverçš„æŒ‡é’ˆ receiver-&gt;incStrong(gInputEventReceiverClassInfo.clazz); // retain a reference for the object return reinterpret_cast&lt;jlong&gt;(receiver.get());&#125; NativeInputEventReceiverçš„æ„é€ å‡½æ•°ã€‚ frameworks/base/core/jni/android_view_InputEventReceiver.cpp :12345678910NativeInputEventReceiver::NativeInputEventReceiver(JNIEnv* env, jobject receiverWeak, const sp&lt;InputChannel&gt;&amp; inputChannel, const sp&lt;MessageQueue&gt;&amp; messageQueue) : mReceiverWeakGlobal(env-&gt;NewGlobalRef(receiverWeak)), mInputConsumer(inputChannel), mMessageQueue(messageQueue), mBatchedInputEventPending(false), mFdEvents(0) &#123; if (kDebugDispatchCycle) &#123; ALOGD(\"channel '%s' ~ Initializing input event receiver.\", getInputChannelName()); &#125;&#125; 4.4è¿™ä¸€æ­¥è°ƒç”¨å‡½æ•°setFdEventsï¼Œå‚æ•°ä¸ºALOOPER_EVENT_INPUTã€‚ 4.5å°†ä¼ å…¥çš„Channelè®©ä¸»çº¿ç¨‹ç›‘å¬èµ·æ¥ï¼Œä»¥ä¾¿å¤„ç†ä¼ å…¥çš„æ¶ˆæ¯ã€‚ frameworks/base/core/jni/android_view_InputEventReceiver.cpp123456789101112131415void NativeInputEventReceiver::setFdEvents(int events) &#123;' if (mFdEvents != events) &#123; mFdEvents = events; //è·å–Channelçš„æ–‡ä»¶æè¿°ç¬¦ int fd = mInputConsumer.getChannel()-&gt;getFd(); if (events) &#123; //è·å–Looperï¼Œç»™å…¶æ·»åŠ ç›‘å¬fdçš„IOäº‹ä»¶çš„è¯·æ±‚ //MessageQueueçš„Looperä¸ºä¸»çº¿ç¨‹Looperï¼Œå¦‚æœLooperè¿›å…¥ç¡çœ  //åˆ™ä¼šè¢«Channelä¸Šå†™å…¥çš„äº‹ä»¶å”¤é†’ï¼Œä»è€Œå¯ä»¥å¤„ç†æ–°æ¥çš„æ¶ˆæ¯ mMessageQueue-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); &#125; else &#123; mMessageQueue-&gt;getLooper()-&gt;removeFd(fd); &#125; &#125;&#125; è¿™é‡Œç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”ŸIOäº‹ä»¶æ—¶ï¼Œè°ƒç”¨çš„å›è°ƒå‡½æ•°å°±æ˜¯NativeInputEventReceiverè‡ªå·±ï¼Œå› ä¸ºå®ƒä¸ºLooperCallbackå­ç±»ã€‚ åŒæ—¶æ³¨æ„è¿™é‡Œçš„Looperå°±æ˜¯åº”ç”¨ä¸»çº¿ç¨‹çš„Looperï¼Œè¿™é‡Œå‘å…¶epollå¤šæ·»åŠ äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿›è¡Œç›‘å¬ï¼Œå› ä¸ºepollå¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªepollçš„IOäº‹ä»¶ã€‚åŒæ—¶è®¾å®šäº†ç›‘å¬çš„ç±»å‹ä¸ºALOOPER_EVENT_INPUTã€‚ å›å¿†ä¸‹ç¬¬10ç« çš„1.6æ­¥éª¤ä¸­epoll_waitè¿›å…¥çš„ç¡çœ åï¼Œä¼šç›‘å¬mWakeEventFdæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ã€‚ä¸ä»…å¦‚æ­¤ï¼Œè¿™ä¸€æ­¥è¿˜ä¼šç›‘å¬æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ï¼Œè¿™é‡Œå°±åŒ…æ‹¬å»ºç«‹çš„InputChannelçš„æ–‡ä»¶æè¿°ç¬¦ã€‚æ‰€ä»¥åœ¨ä¸»çº¿ç¨‹é€šè¿‡è°ƒç”¨pollInnerè¿›å…¥ç¡çœ ä»¥åï¼Œè¢«å”¤é†’åä¼šåˆ¤æ–­å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å“ªä¸€ä¸ªã€‚ system/core/libutils/Looper.cpp :1234567891011121314151617181920if (fd == mWakeEventFd) &#123; if (epollEvents &amp; EPOLLIN) &#123; awoken(); &#125; else &#123; ALOGW(\"Ignoring unexpected epoll events 0x%x on wake event fd.\", epollEvents); &#125; &#125; else &#123; ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &gt;= 0) &#123; int events = 0; if (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT; if (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT; if (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR; if (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP; pushResponse(events, mRequests.valueAt(requestIndex)); &#125; else &#123; ALOGW(\"Ignoring unexpected epoll events 0x%x on fd %d that is \" \"no longer registered.\", epollEvents, fd); &#125; &#125; åˆ°è¿™é‡Œï¼ŒInputChannelåœ¨Clientç«¯ä¹Ÿè¿›è¡Œäº†ç›‘å¬ï¼Œæ•´ä¸ªå®Œæ•´çš„windowæ‰€åœ¨çš„åº”ç”¨ä¸»çº¿ç¨‹å’ŒInputDispatcherçº¿ç¨‹ä¹‹é—´çš„åŒå‘Channelå·²ç»å»ºç«‹å®Œæ¯•ï¼ŒåŒæ—¶InputDispatcherçŸ¥é“å“ªä¸€ä¸ªwindowå¤„äºæ¿€æ´»çŠ¶æ€ï¼Œå› ä¸ºå®ƒçŸ¥é“å‘å“ªä¸€ä¸ªwindowå‘é€æ¶ˆæ¯ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(11):Androidçš„InputManagerServiceçš„å·¥ä½œè¿‡ç¨‹","date":"2017-02-14T06:11:12.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-11-Androidçš„InputManagerServiceçš„å·¥ä½œè¿‡ç¨‹/","text":"è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ 1. åˆ›å»ºInputManagerè¿™é‡Œå’Œè€ç½—å½“å¹´çš„ç‰ˆæœ¬æœ‰å¾ˆå¤§ä¸åŒäº†ï¼Œæœ‰äº†InputManagerServiceç®¡ç†InputManagerã€‚ 1.1æƒ³è¦æ¢ç´¢å¦‚ä½•å¯åŠ¨çš„ç›¸å…³serverï¼Œéœ€è¦ä»SystemServerå¼€å§‹æ¢å¯»ã€‚ä»SystemServerçš„è¿›ç¨‹å¼€å§‹è¿è¡Œå¼€å§‹ï¼Œå®ƒå°±ä¼šåˆ›å»ºä¸€äº›ç³»ç»Ÿserverï¼Œè¿™é‡Œå°±ä¼šå¯åŠ¨other servicesã€‚ å…¶ä¸­ï¼Œä¼šåˆ›å»ºInput Managerå’ŒWindow Managerä¸¤ä¸ªæœåŠ¡ã€‚ frameworks/base/services/java/com/android/server/SystemServer.java :1234567891011Slog.i(TAG, \"Input Manager\");inputManager = new InputManagerService(context);Slog.i(TAG, \"Window Manager\");wm = WindowManagerService.main(context, inputManager, mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL, !mFirstBoot, mOnlyCore);ServiceManager.addService(Context.WINDOW_SERVICE, wm);ServiceManager.addService(Context.INPUT_SERVICE, inputManager);//..inputManager.start(); 1.2å…ˆæ¥ä»”ç»†ç«¯è¯¦ä¸€ä¸‹InputManagerServiceçš„æ„é€ å‡½æ•°ã€‚è¿™é‡Œä¼šè°ƒç”¨c++å±‚çš„åˆå§‹åŒ–å‡½æ•°ã€‚frameworks/base/services/core/java/com/android/server/input/InputManagerService.java :123this.mHandler = new InputManagerHandler(DisplayThread.get().getLooper);//..mPtr = nativeInit(this, mContext, mHandler.getLooper().getQueue()); æ³¨æ„è¿™é‡Œå°†DisplayThreadçš„Looperä¼ é€’è¿‡å»ï¼ŒDisplayThreadæ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼çš„ç±»ï¼Œå®ƒä¼šå¯åŠ¨å”¯ä¸€çš„çº¿ç¨‹ã€‚åŒæ—¶DisplayThreadæ˜¯ä¸€ä¸ªHandlerThreadçš„å­ç±»ï¼Œå®ç°äº†Looperå¾ªç¯æœºåˆ¶ã€‚DisplayThreadæ˜¯ç”¨æ¥æ‰§è¡Œå’Œæ˜¾ç¤ºæœ‰å…³çš„æ“ä½œï¼Œæ˜¾ç¤ºæ“ä½œä¸€èˆ¬éœ€è¦æ¯”è¾ƒå°çš„å»¶è¿Ÿã€‚DisplayThreadåªèƒ½è¢«WindowManagerã€DisplayManagerï¼ŒInputManagerç”¨æ¥æ‰§è¡Œä¸€äº›å¿«é€Ÿåœ°å®æ—¶æ“ä½œã€‚ 1.3è¿™ä¸€æ­¥é¦–å…ˆå°†javaå±‚çš„MessageQueueå˜ä¸ºäº†c++çš„MessageQueueã€‚ç„¶åæ„é€ äº†ä¸€ä¸ªNativeInputManagerå¯¹è±¡ï¼Œæœ€åå°†æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆimè¿”å›ç»™javaå±‚ã€‚ frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :1NativeInputManager* im = new NativeInputManager(contextObj, serviceObj, messageQueue-&gt;getLooper()); 1.4åœ¨æ„é€ NativeInputManageræ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªInputManagerå¯¹è±¡mInputManagerã€‚ frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :12sp&lt;EventHub&gt; eventHub = new EventHub();mInputManager = new InputManager(eventHub, this, this); 1.5è¿™ä¸€æ­¥ä¼šåˆ›å»ºä¸€ä¸ªdispatcherè´Ÿè´£åˆ†å‘è¾“å…¥äº‹ä»¶ï¼Œä¸€ä¸ªreaderè´Ÿè´£è·å–äº‹ä»¶ã€‚frameworks/native/services/inputflinger/InputManager.cpp :123mDispatcher = new InputDispatcher(dispatcherPolicy);mReader = new InputReader(eventHub, readerPolicy, mDispatcher);initialize(); 1.6è¿™é‡Œä¼šåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œåœ¨ä»¥åçš„æ­¥éª¤ä¸­ä¼šç”¨æ¥è¿è¡Œå‰é¢åˆ›å»ºçš„dispathcerå’Œreaderã€‚ frameworks/native/services/inputflinger/InputManager.cpp :12mReaderThread = new InputReaderThread(mReader);mDispatcherThread = new InputDispatcherThread(mDispatcher); 2. å¯åŠ¨InputManagerå°†è§†çº¿å†æ¬¡å›åˆ°SystemServerä¸­ï¼Œåœ¨åˆ›å»ºå®ŒInputManagerServiceåï¼Œéœ€è¦å°†è¿™ä¸ªServiceå¯åŠ¨ï¼ŒåŒæ ·æ˜¯åœ¨1.1çš„startOtherServiceså‡½æ•°é‡Œï¼Œè°ƒç”¨äº†InputManagerServiceçš„æˆå‘˜å‡½æ•°startã€‚ 2.1è¿™é‡Œé¦–å…ˆè°ƒç”¨äº†c++å±‚çš„nativeStartï¼Œç„¶åInputManagerServiceå°†è‡ªå·±äº¤ç»™Watchdogç›‘è§†ã€‚ç„¶åæ³¨å†Œäº†PointerSpeedSettingå’ŒShowTouchesSettingä¸¤ä¸ªObserverã€‚ frameworks/base/services/core/java/com/android/server/input/InputManagerService.java :1234567nativeStart(mPtr);// Add ourself to the Watchdog monitors.Watchdog.getInstance().addMonitor(this);registerPointerSpeedSettingObserver();registerShowTouchesSettingObserver(); è¿™ä¸¤ä¸ªObserveræš‚æ—¶è¿˜æ²¡ææ¸…æ¥šæ˜¯å¹²ä»€ä¹ˆçš„ã€‚ 2.2è¿™ä¸€æ­¥å°†ä¼ æ¥çš„ptrå‚æ•°è½¬åŒ–ä¸ºä¸€ä¸ªNativeInputManageræŒ‡é’ˆï¼ŒåŒæ—¶å¼€å§‹å¯åŠ¨NativeInputManagerä¸­çš„InputManagerã€‚ frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :12NativeInputManager* im = reinterpret_cast&lt;NativeInputManager*&gt;(ptr);status_t result = im-&gt;getInputManager()-&gt;start(); 2.3è¿™é‡Œä¼šå¯åŠ¨åœ¨1.6ä¸­åˆ›å»ºçš„ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«ç”¨æ¥åˆ†å‘å’Œç›‘å¬Inputäº‹ä»¶ã€‚ frameworks/native/services/inputflinger/InputManager.cpp ï¼š12status_t result = mDispatcherThread-&gt;run(\"InputDispatcher\", PRIORITY_URGENT_DISPLAY);result = mReaderThread-&gt;run(\"InputReader\", PRIORITY_URGENT_DISPLAY);) 3. å¯åŠ¨InputDispatcheråœ¨2.3ä¸­è¿è¡Œçš„çº¿ç¨‹ä»¥threadLoopä¸ºå…¥å£ï¼Œå¼€å§‹è¿›å…¥å¾ªç¯ã€‚ 3.1è¿™ä¸€æ­¥ç›´æ¥å°†ä»»åŠ¡äº¤ç»™InputDispatcherçš„dispatchOnceå‡½æ•°ã€‚ frameworks/native/services/inputflinger/InputDispatcher.cpp :1234bool InputDispatcherThread::threadLoop() &#123; mDispatcher-&gt;dispatchOnce(); return true;&#125; 3.2æ•´ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š frameworks/native/services/inputflinger/InputDispatcher.cpp :12345678910111213141516171819202122232425void InputDispatcher::dispatchOnce() &#123; nsecs_t nextWakeupTime = LONG_LONG_MAX; &#123; // acquire lock AutoMutex _l(mLock); mDispatcherIsAliveCondition.broadcast(); // Run a dispatch loop if there are no pending commands. // The dispatch loop might enqueue commands to run afterwards. if (!haveCommandsLocked()) &#123; dispatchOnceInnerLocked(&amp;nextWakeupTime); &#125; // Run all pending commands if there are any. // If any commands were run then force the next poll to wake up immediately. if (runCommandsLockedInterruptible()) &#123; nextWakeupTime = LONG_LONG_MIN; &#125; &#125; // release lock nsecs_t currentTime = now(); int timeoutMillis = toMillisecondTimeoutDelay(currentTime, nextWakeupTime); mLooper-&gt;pollOnce(timeoutMillis);&#125; åœ¨è¿™ä¸€æ­¥éª¤ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰Commandè¿˜æœªè¢«æ‰§è¡Œï¼Œå¦‚æœæœ‰å»æ‰§è¡ŒCommandã€‚å¦åˆ™ï¼Œè°ƒç”¨dispatchOnceInnerLockedå‡½æ•°å»è·å–äº‹ä»¶ï¼Œè¿™é‡Œä¼šå°†nextWakeupTimeä¼ é€’è¿‡å»ï¼Œè®©å…¶è®¾ç½®åˆé€‚çš„è‹é†’æ—¶é—´ï¼Œå…·ä½“å†…å®¹åœ¨ä»¥åè®²è§£ã€‚ç„¶årunCommandsLockedInterruptibleå‡½æ•°ä¼šæ‰§è¡Œç¼“å­˜çš„Commandï¼Œå¦‚æœæœ‰Commandåœ¨è¿™ä¸€æ­¥ä¸­è¢«æ‰§è¡Œï¼Œåˆ™éœ€è¦å°†è‹é†’äº‹ä»¶è®¾ç½®ä¸ºLONG_LONG_MINï¼Œå› ä¸ºæ‰§è¡Œè¿™äº›å‘½ä»¤éœ€è¦è€—è´¹äº‹ä»¶ï¼Œåœ¨è¿™æœŸé—´å¯èƒ½å·²ç»æœ‰è¾“å…¥äº‹ä»¶å‘ç”Ÿäº†ï¼Œæ‰€æœ‰ä¸‹æ¬¡å¾ªç¯ä¸éœ€è¦ç­‰å¾…ã€‚ æœ€åï¼Œæ ¹æ®ç­‰å¾…æ—¶é—´å’Œå½“å‰æ—¶é—´ï¼Œè®¡ç®—å‡ºéœ€è¦ç¡çœ çš„æ—¶é—´ï¼Œé€šè¿‡pollOnceè¿›å…¥ç¡çœ ï¼Œç­‰å¾…å”¤é†’ï¼Œæˆ–è€…è¶…æ—¶ã€‚ 3.3è¿™é‡Œå’Œä¸Šä¸€ä¸ªç« èŠ‚ä¸­çš„pollOnceé“ç†ç›¸åŒã€‚ 3.4è¿™é‡Œä¼šè°ƒç”¨epoll_waitå‡½æ•°ï¼Œä½¿å…¶åœ¨mEpollFdæ‰€æè¿°çš„epollä¸Šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè¿™ä¸ªepollç›‘å¬ç€æ–‡ä»¶æè¿°ç¬¦çš„è¯»å†™äº‹ä»¶ã€‚å¦‚æœæœ‰äººåœ¨pipä¸­å†™å…¥ï¼Œåˆ™ä¼šè¿”å›ï¼Œå¦åˆ™ç­‰å¾…æŒ‡å®šæ—¶é—´åè¿”å›ã€‚ system/core/libutils/Looper.cpp1int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); 4. å¯åŠ¨InputReaderåœ¨2.3ä¸­è¿è¡Œçš„çº¿ç¨‹ä»¥threadLoopä¸ºå…¥å£ï¼Œå¼€å§‹è¿›å…¥å¾ªç¯ã€‚ 4.1è¿™ä¸€æ­¥ä¸3.1ä¸€æ ·ï¼Œå°†ä»»åŠ¡ä¸¢ç»™InputReaderå¤„ç†ã€‚ 4.2è¿™ä¸€æ­¥ä¼šå°è¯•ä»mEventHubä¸­è·å–äº‹ä»¶ï¼Œå¦‚æœè·å–ä¸€äº›äº‹ä»¶ï¼Œåˆ™è¿›è¡Œå¤„ç†ã€‚frameworks/native/services/inputflinger/InputReader.cpp :1234567//ä»EventHubä¸­è·å–eventï¼Œè¿™é‡Œå…ˆè¯¦ç»†è®²è§£è¿™ä¸€æ­¥size_t count = mEventHub-&gt;getEvents(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE);//çœç•¥..if (count) &#123; //äº‹ä»¶å¤„ç†ï¼Œå°†åœ¨åé¢åšå®¢ä¸­è®²è§£ processEventsLocked(mEventBuffer, count);&#125; è¿™é‡Œæˆ‘ä»¬å…ˆè€ƒè™‘å¦‚ä½•ä»EventHubä¸­è·å–äº‹ä»¶çš„ã€‚ 4.3é¦–å…ˆè¿™ä¸€ä¸ªå‡½æ•°ä¸æ˜¯å°±è·å¾—ä¸€ä¸ªeventè¿™ä¹ˆç®€å•ï¼Œå®ƒæ˜¯æƒ³è·å¾—ä¸€ç»„eventï¼Œè¿™é‡Œå’Œæ—§ç‰ˆæœ¬æœ‰æ‰€ä¸åŒï¼Œå¯è§å·¥ç¨‹å¸ˆå¯¹ç³»ç»Ÿåšäº†ä¼˜åŒ–ã€‚è¿™ä¸€æ­¥å†…å®¹æ¯”è¾ƒåˆ°ï¼Œè®©æˆ‘ä»¬é€šè¿‡æ³¨é‡Šæ¥è®²è§£ã€‚ frameworks/native/services/inputflinger/EventHub.cpp :123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208size_t EventHub::getEvents(int timeoutMillis, RawEvent* buffer, size_t bufferSize) &#123; ALOG_ASSERT(bufferSize &gt;= 1); AutoMutex _l(mLock); struct input_event readBuffer[bufferSize]; //event æŒ‡å‘äº†å­˜å‚¨äº‹ä»¶çš„ä½ç½® RawEvent* event = buffer; size_t capacity = bufferSize; bool awoken = false; //å¼€å§‹å¾ªç¯è·å–äº‹ä»¶,ç›®çš„æ˜¯å¡«å……buffer for (;;) &#123; nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); // Reopen input devices if needed. //å¦‚æœéœ€è¦é‡æ–°æ‰“å¼€è¾“å…¥è®¾å¤‡ï¼Œåˆ™é¦–å…ˆè¦å…³é—­æ‰€æœ‰çš„è®¾å¤‡ if (mNeedToReopenDevices) &#123; mNeedToReopenDevices = false; ALOGI(\"Reopening all input devices due to a configuration change.\"); closeAllDevicesLocked(); mNeedToScanDevices = true; break; // return to the caller before we actually rescan &#125; // Report any devices that had last been added/removed. //è¿™é‡Œä¼šç§»é™¤æ‰€æœ‰å…³é—­çš„è®¾å¤‡ while (mClosingDevices) &#123; Device* device = mClosingDevices; ALOGV(\"Reporting device closed: id=%d, name=%s\\n\", device-&gt;id, device-&gt;path.string()); mClosingDevices = device-&gt;next; //åˆ›å»ºäº†ä¸€ä¸ªè®¾å¤‡removedçš„event event-&gt;when = now; event-&gt;deviceId = device-&gt;id == mBuiltInKeyboardId ? BUILT_IN_KEYBOARD_ID : device-&gt;id; event-&gt;type = DEVICE_REMOVED; event += 1; delete device; mNeedToSendFinishedDeviceScan = true; if (--capacity == 0) &#123; break; &#125; &#125; //å¦‚æœä¸Šé¢æ­¥éª¤å…³é—­äº†è®¾å¤‡ï¼Œè¿™é‡Œéœ€è¦é‡æ–°æ‰«ææ‰€æœ‰çš„è®¾å¤‡ if (mNeedToScanDevices) &#123; mNeedToScanDevices = false; //ä¸‹é¢ä¼šè¯¦ç»†è®²è§£è¿™é‡Œå¦‚ä½•è·å–è¾“å…¥è®¾å¤‡çš„ scanDevicesLocked(); mNeedToSendFinishedDeviceScan = true; &#125; //è¿™é‡Œä¼šæ·»åŠ æ­£åœ¨å¼€å¯çš„è®¾å¤‡ while (mOpeningDevices != NULL) &#123; Device* device = mOpeningDevices; ALOGV(\"Reporting device opened: id=%d, name=%s\\n\", device-&gt;id, device-&gt;path.string()); mOpeningDevices = device-&gt;next; //åŒæ ·è¿™é‡Œä¼šåˆ›å»ºè®¾å¤‡æ·»åŠ çš„event event-&gt;when = now; event-&gt;deviceId = device-&gt;id == mBuiltInKeyboardId ? 0 : device-&gt;id; event-&gt;type = DEVICE_ADDED; event += 1; mNeedToSendFinishedDeviceScan = true; if (--capacity == 0) &#123; break; &#125; &#125; if (mNeedToSendFinishedDeviceScan) &#123; mNeedToSendFinishedDeviceScan = false; event-&gt;when = now; event-&gt;type = FINISHED_DEVICE_SCAN; event += 1; if (--capacity == 0) &#123; break; &#125; &#125; //ä»¥ä¸Šæ­¥éª¤ä¸»è¦æ˜¯è´Ÿè´£é‡æ–°è·å–æ¥å…¥çš„è®¾å¤‡ï¼Œä¸‹é¢å°†ä¼šè´Ÿè´£è·å¾—è®¾å¤‡ä¸­çš„event // Grab the next input event. bool deviceChanged = false; //å¼€å§‹å¾ªç¯è·å–pendingçš„event //å½“å‰å¤„ç†çš„Eventåºå·æ˜¯å¦å°äºæ­£åœ¨ç­‰å¾…çš„äº‹ä»¶æ•°ç›®ï¼Œè¿™é‡Œä¼šå¾ªç¯è¯»å‡ºæ‰€æœ‰ç­‰å¾…çš„äº‹ä»¶ while (mPendingEventIndex &lt; mPendingEventCount) &#123; //è·å–ä¸€ä¸ªeventé¡¹ const struct epoll_event&amp; eventItem = mPendingEventItems[mPendingEventIndex++]; //å¦‚æœè¿™æ˜¯ä¸ªINotifyäº‹ä»¶ if (eventItem.data.u32 == EPOLL_ID_INOTIFY) &#123; if (eventItem.events &amp; EPOLLIN) &#123; mPendingINotify = true; &#125; else &#123; ALOGW(\"Received unexpected epoll event 0x%08x for INotify.\", eventItem.events); &#125; continue; &#125; //å¦‚æœè¿™æ˜¯ä¸€ä¸ªId wakeäº‹ä»¶ï¼Œåˆ™è¯»å‡ºmWakeReadPipeFdçš„æ•°æ®ï¼Œè®©ç­‰å¾…åœ¨è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„çº¿ç¨‹å¾—åˆ°å”¤é†’ if (eventItem.data.u32 == EPOLL_ID_WAKE) &#123; if (eventItem.events &amp; EPOLLIN) &#123; ALOGV(\"awoken after wake()\"); awoken = true; char buffer[16]; ssize_t nRead; do &#123; nRead = read(mWakeReadPipeFd, buffer, sizeof(buffer)); &#125; while ((nRead == -1 &amp;&amp; errno == EINTR) || nRead == sizeof(buffer)); &#125; else &#123; ALOGW(\"Received unexpected epoll event 0x%08x for wake read pipe.\", eventItem.events); &#125; continue; &#125; //è¿™é‡Œå¼€å§‹å¤„ç†å…¶å®ƒéç‰¹æ®Šçš„event //è·å–eventé¡¹å¯¹åº”çš„è®¾å¤‡çš„ç¼–å· ssize_t deviceIndex = mDevices.indexOfKey(eventItem.data.u32); if (deviceIndex &lt; 0) &#123; ALOGW(\"Received unexpected epoll event 0x%08x for unknown device id %d.\", eventItem.events, eventItem.data.u32); continue; &#125; //è·å–è®¾å¤‡ï¼Œæ‰€æœ‰å·²çŸ¥çš„è®¾å¤‡éƒ½æ”¾åœ¨äº†mDevicesä¸­ Device* device = mDevices.valueAt(deviceIndex); if (eventItem.events &amp; EPOLLIN) &#123; //ä»è¿™ä¸ªè®¾å¤‡ä¸­è¯»å‡ºæ•°æ®æµï¼Œå¹¶ä¸”å­˜å…¥readBufferä¸‹ int32_t readSize = read(device-&gt;fd, readBuffer, sizeof(struct input_event) * capacity); if (readSize == 0 || (readSize &lt; 0 &amp;&amp; errno == ENODEV)) &#123; // Device was removed before INotify noticed. //å…ˆå¤„ç†ä¸€äº›å¼‚å¸¸æƒ…å†µï¼Œå…ˆçœç•¥ //... &#125; else &#123; //é”®ç›˜äº‹ä»¶çš„idéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä¸€ç›´è®¾ç½®ä¸º0 int32_t deviceId = device-&gt;id == mBuiltInKeyboardId ? 0 : device-&gt;id; size_t count = size_t(readSize) / sizeof(struct input_event); //å¼€å§‹å¾ªç¯ï¼Œä»è®¾å¤‡ä¸­è¯»å‡ºæ¯ä¸€ä¸ªevent for (size_t i = 0; i &lt; count; i++) &#123; struct input_event&amp; iev = readBuffer[i]; //è¿™é‡Œåšäº†è®¸å¤šå¤„ç†äº‹ä»¶å¼‚å¸¸æ—¶é—´çš„å·¥ä½œï¼Œå…ˆç•¥è¿‡ //... //å°†è·å–çš„äº‹ä»¶å­˜å…¥event event-&gt;deviceId = deviceId; event-&gt;type = iev.type; event-&gt;code = iev.code; event-&gt;value = iev.value; //eventæŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå®¹é‡ä¹Ÿéšä¹‹å‡å°‘ä¸€ä¸ª event += 1; capacity -= 1; &#125; if (capacity == 0) &#123; // The result buffer is full. Reset the pending event index // so we will try to read the device again on the next iteration. //bufferå·²ç»å¡«æ»¡ï¼Œé€€å‡ºå¤„ç†pending eventçš„å¾ªç¯ï¼Œå°†indexå›åˆ°ä¸Šä¸€ä¸ªä½ç½®ï¼Œå› ä¸ºè¯¥è®¾å¤‡eventè¿˜æ²¡è¯»å®Œï¼Œä¸‹æ¬¡å†æ¥ç€è¯» mPendingEventIndex -= 1; break; &#125; &#125; &#125; else if (eventItem.events &amp; EPOLLHUP) &#123; //å¤„ç†ä¸€äº›å…¶å®ƒæƒ…å†µï¼Œçœç•¥ //... &#125; &#125; //åœ¨è¯»å‡ºæ‰€æœ‰eventåï¼Œæ‰èƒ½å…³é—­è®¾å¤‡ï¼Œè¿™é‡Œçœç•¥äº†å¯¹æ­¤çš„å¤„ç†è¿‡ç¨‹ //... //åˆ°è¿™é‡Œè¯´æ˜pending eventå·²ç»å¤„ç†å®Œï¼Œæˆ–è€…bufferå·²ç»å¡æ»¡ã€‚bufferå¡æ»¡æˆ–è€…å­˜äº†ä¸€äº›äº‹ä»¶ï¼Œåˆ™é€€å‡ºæœ€å¤–å±‚å¡«å……bufferçš„å¾ªç¯ // Return now if we have collected any events or if we were explicitly awoken. if (event != buffer || awoken) &#123; break; &#125; //è¿™é‡Œå¤„ç†äº†ä¸€äº›wake lockçš„äº‹æƒ…ï¼Œçœç•¥ //... //åˆ°è¿™ä¸€æ­¥è¯´æ˜bufferé‡Œæ²¡æœ‰å¡«ä»»ä½•äº‹ä»¶ï¼ŒåŒæ—¶ä¹Ÿæ²¡æœ‰pending event //æ‰€ä»¥éœ€è¦ç­‰å¾…æœ‰äººå‘deviceæ–‡ä»¶æè¿°ç¬¦é‡Œå†™å…¥ä¸€äº›äº‹ä»¶ int pollResult = epoll_wait(mEpollFd, mPendingEventItems, EPOLL_MAX_EVENTS, timeoutMillis); //æ—¶é—´å·²åˆ°ï¼Œè¿˜æ˜¯æ²¡æœ‰äº‹ä»¶ï¼Œé‚£å’±å°±ç»“æŸå§ if (pollResult == 0) &#123; // Timed out. mPendingEventCount = 0; break; &#125; //å‡ºé”™äº†ï¼Œè®©æˆ‘ç¡ä¸€ä¼šï¼Œä¸‹æ¬¡å†å°è¯• if (pollResult &lt; 0) &#123; // An error occurred. mPendingEventCount = 0; // Sleep after errors to avoid locking up the system. // Hopefully the error is transient. if (errno != EINTR) &#123; ALOGW(\"poll failed (errno=%d)\\n\", errno); usleep(100000); &#125; &#125; else &#123; // Some events occurred. mPendingEventCount = size_t(pollResult); //è·å–äº†ä¸€äº›eventï¼Œé‚£ä¹ˆç»§ç»­å¾ªç¯ï¼Œå¡«å……bufferï¼ &#125; &#125; // All done, return the number of events we read. return event - buffer;&#125; 4.4ä»è¿™é‡Œå¼€å§‹æ‰«æè®¾å¤‡ã€‚åœ¨ç ”ç©¶è¿™ä¸ªå‡½æ•°å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹DEVICE_PATHçš„æ¥å¤´ï¼š frameworks/native/services/inputflinger/EventHub.cpp :12345//è¿™ä¸€æ®µä»£ç ä½äºEventHubçš„æ„é€ å‡½æ•°ä¸­ï¼Œè¿™é‡Œä½¿ç”¨äº†linuxçš„inotifyæœºåˆ¶//inotifyæœºåˆ¶å¯ä»¥ç›‘æ§æ–‡ä»¶çš„å˜åŒ–//å› æ­¤ç³»ç»Ÿå¯ä»¥å®æ—¶ç›‘æ§è®¾å¤‡çš„æ·»åŠ å’Œç§»é™¤mINotifyFd = inotify_init();int result = inotify_add_watch(mINotifyFd, DEVICE_PATH, IN_DELETE | IN_CREATE); frameworks/native/services/inputflinger/EventHub.cpp :1234567891011void EventHub::scanDevicesLocked() &#123; //æ‰«æç›®å½•ï¼š/dev/input status_t res = scanDirLocked(DEVICE_PATH); if(res &lt; 0) &#123; ALOGE(\"scan dir failed for %s\\n\", DEVICE_PATH); &#125; if (mDevices.indexOfKey(VIRTUAL_KEYBOARD_ID) &lt; 0) &#123; //åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿé”®ç›˜ createVirtualKeyboardLocked(); &#125;&#125; 4.5è¿™é‡Œå¼€å§‹æ‰«æ/dev/input/ç›®å½•ä¸‹çš„æ‰€æœ‰è®¾å¤‡ã€‚ frameworks/native/services/inputflinger/EventHub.cpp :1234567891011121314151617181920212223242526status_t EventHub::scanDirLocked(const char *dirname)&#123; char devname[PATH_MAX]; char *filename; DIR *dir; struct dirent *de; dir = opendir(dirname); if(dir == NULL) return -1; strcpy(devname, dirname); filename = devname + strlen(devname); //filenameæŒ‡å‘äº†devnameç›®å½•çš„å°¾ç«¯ï¼Œæ–¹ä¾¿åœ¨å…¶åé¢æ·»åŠ è®¾å¤‡æ–‡ä»¶ *filename++ = '/'; //è¯»å–è¯¥ç›®å½•ä¸‹çš„æ¯ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ while((de = readdir(dir))) &#123; if(de-&gt;d_name[0] == '.' &amp;&amp; (de-&gt;d_name[1] == '\\0' || (de-&gt;d_name[1] == '.' &amp;&amp; de-&gt;d_name[2] == '\\0'))) continue; strcpy(filename, de-&gt;d_name); //æ‰“å¼€è®¾å¤‡ï¼Œdevnameé‡Œæ˜¯è®¾å¤‡çš„ç»å¯¹è·¯å¾„ openDeviceLocked(devname); &#125; closedir(dir); return 0;&#125; 4.6frameworks/native/services/inputflinger/EventHub.cpp :1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859status_t EventHub::openDeviceLocked(const char *devicePath) &#123; char buffer[80]; //æ‰“å¼€æ–‡ä»¶ int fd = open(devicePath, O_RDWR | O_CLOEXEC); if(fd &lt; 0) &#123; ALOGE(\"could not open %s, %s\\n\", devicePath, strerror(errno)); return -1; &#125; InputDeviceIdentifier identifier; // Get device name. if(ioctl(fd, EVIOCGNAME(sizeof(buffer) - 1), &amp;buffer) &lt; 1) &#123; //fprintf(stderr, \"could not get device name for %s, %s\\n\", devicePath, strerror(errno)); &#125; else &#123; buffer[sizeof(buffer) - 1] = '\\0'; identifier.name.setTo(buffer); &#125; // Check to see if the device is on our excluded list //åˆ é™¤æ’é™¤çš„è®¾å¤‡ //ä¸€ä¸‹æ­¥éª¤ä»æ–‡ä»¶ä¸­è·å–deviceçš„åŸºæœ¬ä¿¡æ¯ //... // Get device driver version. // Get device identifier. // Get device physical location. // Get device unique id. // Fill in the descriptor. // Make file descriptor non-blocking for use with poll(). //åˆ›å»ºdeviceå¯¹è±¡ // Allocate device. (The device object takes ownership of the fd at this point.) int32_t deviceId = mNextDeviceId++; Device* device = new Device(fd, deviceId, String8(devicePath), identifier); //æ ¹æ®deviceçš„ç‰¹å¾ï¼Œè®¾ç½®deviceçš„classå‚æ•° //... // Register with epoll. struct epoll_event eventItem; memset(&amp;eventItem, 0, sizeof(eventItem)); eventItem.events = EPOLLIN; if (mUsingEpollWakeup) &#123; eventItem.events |= EPOLLWAKEUP; &#125; eventItem.data.u32 = deviceId; //å°†è¯¥deviceçš„æ–‡ä»¶fdäº¤ç»™epollç›‘è§†ï¼Œä»¥åŠæ—¶è·å¾—å®ƒçš„å˜åŒ– if (epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp;eventItem)) &#123; ALOGE(\"Could not add device fd to epoll instance. errno=%d\", errno); delete device; return -1; &#125; //å¤„ç†æ—¶é’Ÿé—®é¢˜.. //æ·»åŠ device addDeviceLocked(device); return 0; 4.7è¿™ä¸€æ­¥æ¯”è¾ƒè½»æ¾ï¼Œå°†åˆ›å»ºå¥½çš„deviceå¯¹è±¡æ”¾å…¥mDeviceså³å¯ã€‚12345void EventHub::addDeviceLocked(Device* device) &#123; mDevices.add(device-&gt;id, device); device-&gt;next = mOpeningDevices; mOpeningDevices = device;&#125;","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Android Monkey æºä»£ç é˜…è¯»","date":"2017-02-14T06:09:32.000Z","path":"2017/02/14/Android-Monkey-æºä»£ç é˜…è¯»/","text":"0. MonkeyåŸºæœ¬ä¿¡æ¯ç›®å‰è¯¥å·¥å…·ä½äºæºä»£ç çš„ä½ç½®ï¼šdevelopment/cmds/monkeyã€‚ ç”Ÿæˆçš„jaråŒ…ä½äºï¼šout/traget/product/generic/system/framework/monkey.jarã€‚ åœ¨è®¾å¤‡ä¸­ï¼Œå¯åŠ¨monkeyçš„è„šæœ¬ä½äº/system/bin/monkey:1234567# Script to start &quot;monkey&quot; on the device, which has a very rudimentary# shell.#base=/systemexport CLASSPATH=$base/framework/monkey.jartrap &quot;&quot; HUPexec app_process $base/bin com.android.commands.monkey.Monkey $* 1. Monkeyå¼€å§‹å¯åŠ¨ mainå‡½æ•°åªæ˜¯è®¾ç½®äº†è¿›ç¨‹çš„åç§°ï¼Œä¸»è¦è¿‡ç¨‹åœ¨runå‡½æ•°ä¸­æ‰§è¡Œã€‚ è·å–å‚æ•°ï¼Œåˆå§‹åŒ–å‚æ•°å’Œéšæœºæ•°ã€‚ç„¶åå®ƒä¼šè·å–ç³»ç»Ÿçš„ä¸€äº›æœåŠ¡ï¼Œè§1.3ã€‚è·å–éœ€è¦å¯åŠ¨çš„main activityï¼Œè§1.4ã€‚åˆ›å»ºä¸€ä¸ªMonkeySourceRoandomå¯¹è±¡mEventSourceï¼Œç”±ä»–ç®¡ç†éšæœºäº‹ä»¶çš„ç”Ÿæˆï¼Œè¿™é‡Œé¦–å…ˆè®©å®ƒç”Ÿæˆäº†ä¸€ä¸ªå¯åŠ¨main activityçš„äº‹ä»¶æ”¾å…¥äº†é˜Ÿåˆ—ã€‚monkeyè¿˜æ”¯æŒé€šè¿‡è„šæœ¬ã€ç½‘ç»œè·å–äº‹ä»¶ï¼Œè¿™é‡Œåªè¯´é»˜è®¤çš„éšæœºæƒ…å†µã€‚ä¸‹é¢ï¼Œå®ƒå¯åŠ¨Network Monitorã€‚æ¥ç€ï¼Œå¯åŠ¨Monkeyçš„å¾ªç¯è¿‡ç¨‹ï¼Œè§1.5ã€‚ç­‰å¾…æµ‹è¯•ç»“æŸåï¼Œåˆ™è¾“å‡ºæµ‹è¯•æŠ¥å‘Šã€‚ è·å–ä¸€äº›ç³»ç»ŸæœåŠ¡ï¼Œæœ‰ActivityManagerã€WindowManagerã€PackageManagerã€‚ç»™ActivityManagerè®¾ç½®äº†ä¸€ä¸ªActivityControllerå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æä¾›äº†Activityå¯åŠ¨ã€crashè·å–ã€åº”ç”¨æ— å“åº”ç­‰åŠŸèƒ½ã€‚æœ€åï¼Œè¿˜æ³¨å†Œäº†ä¸€ä¸ªç½‘ç»œçŠ¶æ€çš„ç›‘å¬å™¨ã€‚ ä»PackageManagerä¸­è·å–ç¬¦åˆæ¡ä»¶çš„main activityï¼Œç„¶åæ·»åŠ å…¥mMainAppsä¸­ã€‚ è¿™ä¸€æ­¥å°±ä¼šå¾ªç¯çš„ç”Ÿæˆæµ‹è¯•äº‹ä»¶è§1.6ã€è§¦å‘äº‹ä»¶1.10ã€‚ ä»é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªäº‹ä»¶è¿”å›ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªæ”¾å…¥é˜Ÿåˆ—ï¼Œè§1.7ã€‚ è¿™é‡Œå…ˆç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œæ ¹æ®éšæœºæ•°èŒƒå›´ï¼Œå†³å®šå…·ä½“ç”Ÿæˆå“ªä¸€ä¸ªäº‹ä»¶ã€‚è¿™é‡Œæœ‰ç‚¹å‡»ã€æ‹–åŠ¨ã€ç¼©æ”¾ï¼ˆå‰ä¸‰ä¸ªï¼Œè§1.8ï¼‰ã€è½¨è¿¹çƒï¼ˆå·²ç»ä¸å¸¸ç”¨äº†ï¼Œå¯ä»¥å¿½ç•¥ï¼‰ã€æ—‹è½¬ã€æƒé™ï¼ˆè§1.9ï¼‰å’Œé”®ç›˜äº‹ä»¶ã€‚ è¿™é‡Œä¼šé¦–å…ˆåˆ©ç”¨DisplayManagerè·å¾—å±å¹•çš„å®é™…å¤§å°ï¼Œç„¶åéšæœºçš„ç”Ÿæˆç”Ÿæˆç‚¹åæ ‡ã€‚Touchåªéœ€è¦ä¸€ç‚¹å°±å¤Ÿäº†ï¼Œè€ŒDragåˆ™éœ€è¦ç”Ÿæˆä¸€ç³»åˆ—çš„ç‚¹ï¼Œè¿™é‡Œåˆ©ç”¨äº†randomWalkå‡½æ•°æ¥éšæœºçš„ç§»åŠ¨æ¥ç”Ÿæˆä¸‹ä¸€ä¸ªç‚¹åæ ‡ï¼Œç„¶åå°†è¿™ä¸€ç³»åˆ—ç‚¹åæ ‡å°è£…æˆäº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ã€‚ä¸¤æŒ‡ç¼©æ”¾åŒæ ·ä½¿ç”¨äº†å’ŒDragç±»ä¼¼çš„æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯å°†ä¸€ä¸ªç‚¹å˜ä¸ºä¸¤ä¸ªç‚¹ã€‚ ä»ç›®æ ‡packageä¸­çš„æƒé™åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªï¼Œç„¶åç”Ÿæˆä¸€ä¸ªMonkeyPersissionEventã€‚ MonkeyEventæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…·ä½“çš„å®ç°åœ¨å…¶å­ç±»ä¸­ã€‚MotionEventé€šè¿‡InputManageræ³¨å…¥äº‹ä»¶ã€‚æ—‹è½¬MonkeyRotationEventé€šè¿‡WindowManagerè¿›è¡Œæ—‹è½¬ã€‚MonkeyPermissionEventåˆ©ç”¨PackageManageræˆäºˆã€æ’¤é”€åº”ç”¨çš„ä¸€äº›æƒé™ã€‚MonkeyKeyEventåŒæ ·æ˜¯ä½¿ç”¨InputManagerè¿›è¡Œæ³¨å…¥ã€‚ è¿™é‡Œè¿˜æœ‰ä¸€äº›å…¶å®ƒäº‹ä»¶ã€‚MonkeyActivityEventçš„äº‹ä»¶æ˜¯ç”±ActivityManagerå¯åŠ¨çš„ã€‚MonkeyCommandEventåˆ™å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰§è¡Œå‘½ä»¤å³å¯ã€‚MonkeyFlipEventï¼Œå”¤èµ·é”®ç›˜çš„æ“ä½œï¼Œè¿™é‡Œæ˜¯å‘/dev/input/event0å†™å…¥äº†ä¸€ç»„å­—èŠ‚ã€‚MonkeyGetAppFrameRateEventå’ŒMonkeyGetFrameRateEventï¼Œè·å–åº”ç”¨å¸§é¢‘ï¼Œé€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œæ¥å®ç°ã€‚MonkeyInstrumentationEvent, åˆ©ç”¨ActivityManagerå¯åŠ¨Instrumentationç»„ä»¶ã€‚MonkeyNoopEventï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼Œå‘µå‘µã€‚MonkeyPowerEventï¼Œä»logä¿¡æ¯ä¸­è·å–ç”µé‡ä¿¡æ¯ã€‚MonkeyThrottleEventå’ŒMonkeyWaitEventï¼ŒThread.sleepä¼‘çœ ä¸€æ®µæ—¶é—´ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(10):Androidåº”ç”¨ç¨‹åºçš„æ¶ˆæ¯å¤„ç†æœºåˆ¶","date":"2017-02-14T06:07:55.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-10-Androidåº”ç”¨ç¨‹åºçš„æ¶ˆæ¯å¤„ç†æœºåˆ¶/","text":"åŸºç¡€çŸ¥è¯† åŸæ¥å†™å¥½çš„åšå®¢è¢«CSDNç»™å‘äº†ï¼Œæ³•å…‹ï¼Œåªèƒ½é å›å¿†é‡å†™ã€‚ Androidåº”ç”¨ç¨‹åºçš„å››ç§ç»„ä»¶çš†è¿è¡ŒäºActivityThreadä¹‹ä¸­ã€‚ActivityThreadåŒ…å«æœ‰ç¨‹åºå…¥å£mainï¼ŒåŒæ—¶å®ƒä¼šå¯åŠ¨ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯ä¼šè½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥å¤„ç†å‘é€ç»™å®ƒçš„æ¶ˆæ¯ã€‚è€Œå››ç§ç»„ä»¶åˆ™è¢«è¿™ä¸ªçº¿ç¨‹ç»Ÿä¸€ç®¡ç†ã€‚æ‰€ä»¥ï¼ŒActivityThreadè¿™ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹ï¼Œåƒä¸€ä¸ªæ— ä¼‘æ­¢çš„è½¬åŠ¨çš„æ³•æ¡ï¼Œè€Œå››ä¸ªç»„ä»¶åˆ™åƒæ˜¯è¢«é©±åŠ¨å››ä¸ªé½¿è½®ï¼Œéœ€è¦å®ƒä»¬è½¬åŠ¨æ—¶æ‰ä¼šåœ¨æ³•æ¡çš„å¸¦åŠ¨ä¸‹è¿›è¡Œè½¬åŠ¨ã€‚ ä¸»çº¿ç¨‹ä¸­æœ‰ä¸€ä¸ªLooperï¼ŒLooperæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå…¶ä¸­åˆæœ‰ä¸€ä¸ªMessageQueueæ¥ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ã€‚MessageQueueåˆæœ‰ä¸€ä¸ªmPtrå˜é‡ï¼Œè®°å½•äº†c++å±‚å¯¹åº”çš„NativeMessageQueueçš„ä½ç½®ã€‚NativeMessageQueueä¹Ÿæœ‰ä¸€ä¸ªc++å±‚çš„Looperï¼Œå®ƒè´Ÿè´£ç®¡ç†pipï¼Œè€Œpipåˆ™æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„é€šé“ã€‚ 1. çº¿ç¨‹æ¶ˆæ¯å¾ªç¯ ActivityThreadä¼šç”±æ­¤è¿›å…¥å¾ªç¯ã€‚é€šè¿‡ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œä»MessageQueueé‡Œè·å–Messageï¼Œè¿™é‡Œå¯èƒ½ä¼šè¢«é˜»å¡ï¼Œè§1.2ã€‚è·å–æ¶ˆæ¯åï¼Œåˆ†å‘æ¶ˆæ¯åˆ°å“åº”çš„çš„ç»„ä»¶ã€‚ è°ƒç”¨nativePollOnceå‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯ï¼Œè§1.3ã€‚å¦‚æœæœ‰æ–°æ¶ˆæ¯ï¼Œåˆ™åˆ¤æ–­æ—¶æœºæ˜¯å¦å·²åˆ°ï¼Œæ—¶æœºåˆ°äº†åˆ™å°†Messageè¿”å›ã€‚å¦‚æœæ—¶æœºæœªåˆ°ï¼Œæˆ–è€…è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œåˆ™å…ˆæ‰§è¡Œä¸€äº›IdleHandlerã€‚ è¿™ä¸€æ­¥å°†ptrç¿»è¯‘æˆä¸€ä¸ªNativeMessageQueueçš„å¯¹è±¡æŒ‡é’ˆï¼Œç„¶åå°†ä»»åŠ¡äº¤ç»™å®ƒæ¥å¤„ç†ã€‚ç›®å‰è¯¥c++æ–‡ä»¶ä½äºframeworks/base/core/jniç›®å½•ä¸‹ã€‚ NativeMessageåˆå°†ä»»åŠ¡äº¤ç»™c++å±‚çš„Looperæ¥å¤„ç†ã€‚ Looper.cppæ–‡ä»¶ä½äºsystem/core/libutilsã€‚è¿™é‡ŒåŒæ ·ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­è°ƒç”¨pollInneræ¥åˆ¤æ–­æ—¶å€™æœ‰æ–°æ¶ˆæ¯ã€‚ Looperä¸­æœ‰ä¸€ä¸ªepollå®ä¾‹ï¼Œepollæ˜¯ç”¨æ¥ç›‘å¬IOè¯»å†™çš„ä¸€ç§æœºåˆ¶ï¼Œè¿™é‡Œæ¥ç›‘å¬pipæ˜¯å¦æœ‰è¯»å†™äº‹ä»¶ã€‚è¿™é‡Œä½¿ç”¨epoll_waitæ¥ç­‰å¾…epollä¸­çš„è¯»å†™äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šæ ¹æ®è®¾å®šç¡çœ ä¸€æ®µæ—¶é—´ã€‚å¦‚æœæœ‰äº‹ä»¶ï¼Œåˆ™å¯¹æ¯”è¯¥äº‹ä»¶æè¿°ç¬¦æ˜¯å¦ä¸ºmWakeEventFdæ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨awokenã€‚ å°è¯•ä»mWakeEventFdæ–‡ä»¶æè¿°ç¬¦ä¸­è¯»å‡ºæ•°æ®ï¼Œé‡Œé¢çš„æ•°æ®å¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ã€‚ 2. çº¿ç¨‹æ¶ˆæ¯å‘é€è¿‡ç¨‹Handlerç”¨æ¥å‘ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚å®ƒå†…éƒ¨æœ‰mLooperå’ŒmQueueï¼Œåœ¨æ„é€ Handleræ—¶ï¼Œä¼šå°†å®ƒæ‰€åœ¨çº¿ç¨‹ä¸­çš„Looperè·å–ï¼Œæ”¾å…¥mLooperã€‚ å‘é€ä¸€ä¸ªæ¶ˆæ¯ã€‚ åŠ å…¥å»¶è¿Ÿçš„å‘é€æ¶ˆæ¯ã€‚ åœ¨æŸä¸ªæ—¶é—´ç‚¹å‘é€æ¶ˆæ¯ï¼Œè¿™é‡Œä¼šå°†è¿™ä¸ªæ¶ˆæ¯å’Œå‘é€æ—¶åˆ»æ”¾å…¥é˜Ÿåˆ—ã€‚ å°†messageçš„targetè®¾ä¸ºè¯¥Handlerï¼Œç„¶åå°†messageæ”¾å…¥mQueueã€‚ æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ ¹æ®æ—¶é—´è¿›è¡Œæ’åºï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ä¼šæ ¹æ®è¯¥æ¶ˆæ¯çš„æ—¶é—´ï¼Œå°†æ¶ˆæ¯æ’å…¥åˆ°é€‚åˆçš„ä½ç½®ã€‚å¦‚æœé˜Ÿåˆ—å¤´å‘ç”Ÿå˜åŒ–ï¼Œå°±è¦è¿›å…¥nativeä¸–ç•Œï¼Œå”¤é†’ç­‰å¾…çš„äººã€‚ è¿™ä¸€å‡½æ•°å¯¹åº”c++ä¸­çš„android_os_MessageQueue_nativeWakeã€‚è¿™é‡Œä¼šå°†ä¼ å…¥çš„ptrè½¬åŒ–ä¸ºä¸€ä¸ªNativeMessageQueueçš„æŒ‡é’ˆã€‚ è°ƒç”¨mLooperçš„wakeå‡½æ•°ã€‚ è¿™ä¸€æ­¥ä¼šå‘mWakeEventFdæè¿°å†™å…¥ä¸€ä¸ªæ•°æ®â€1â€ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œå°±æ˜¯æƒ³è§¦å‘ä¸€ä¸ªIOäº‹ä»¶ï¼Œç„¶åè®©ç­‰å¾…è¿™ä¸ªIOäº‹ä»¶çš„epoll_waitè§¦å‘ã€‚ 3. çº¿ç¨‹æ¶ˆæ¯å¤„ç† å†æ¬¡å›åˆ°looperå‡½æ•°ï¼Œåœ¨ç¬¬1èŠ‚ä¸­ï¼Œçº¿ç¨‹ä¼šé˜»å¡åœ¨è¯¥å‡½æ•°ä¸­ï¼Œç›´åˆ°è·å–äº†ä¸€ä¸ªæ¶ˆæ¯ã€‚å¦‚æœè·å¾—çš„æ¶ˆæ¯ä¸ºnullï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚å¦åˆ™ï¼Œè·å–æ¶ˆæ¯çš„targetï¼Œä»2.4å¯çŸ¥targetä¸ºä¸€ä¸ªHandlerï¼Œä¸‹é¢çœ‹è¿™ä¸ªHandlerå¦‚ä½•æ´¾å‘æ¶ˆæ¯ã€‚ è¿™é‡Œè¦å¤„ç†ä¸‰ç§æƒ…å†µï¼šç¬¬ä¸€ç§ï¼Œmessageæä¾›äº†è‡ªå·±çš„å›è°ƒå‡½æ•°ï¼Œè§3.3ï¼›ç¬¬äºŒç§ï¼Œä½¿ç”¨Handleræä¾›å›è°ƒå‡½æ•°mCallbackï¼Œè§3.4ï¼›ç¬¬ä¸‰ç§ï¼Œç”±Handlerç»§ç»­å¤„ç†è§3.5ã€‚ è¿™é‡Œmessageçš„callbackå‚æ•°æŒ‡å‘çš„æ˜¯ä¸€ä¸ªRunnableçš„å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ç›´æ¥å¯åŠ¨è¿™ä¸ªå¯¹è±¡çš„runå‡½æ•°å³å¯ã€‚ CallBackæ¥å£ä¸­åªæœ‰handleMessageå‡½æ•°ï¼Œè¿™é‡Œéœ€è¦åœ¨å®šä¹‰Handleræ—¶ï¼Œè®¾å®šä¸€ä¸ªå®ç°CallBackæ¥å£çš„å¯¹è±¡ã€‚ åŒæ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦å­ç±»æ¥å…·ä½“å®ç°çš„å‡½æ•°ã€‚ä¸€èˆ¬æˆ‘ä»¬åœ¨å®šä¹‰ä¸€ä¸ªHandleræ—¶ï¼Œå®šä¹‰çš„æ˜¯ä¸€ä¸ªHandlerå­ç±»ï¼Œåœ¨handleMessageå‡½æ•°ä¸­å®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚ 4. æ¥ç€è¯´ä¸¤å¥åœ¨1.2ä¸­æ¶‰åŠåˆ°çš„IdleHandlerï¼Œåœ¨æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†æ—¶ï¼Œä¼šè°ƒè¿”å›è¿™ä¸ªç©ºé—²Handlerã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªHandlerå¦‚ä½•å·¥ä½œçš„ã€‚ åœ¨MessageQueueä¸­ï¼Œæœ‰mIdleHandlersæ¥å­˜æ”¾IdleHandlerã€‚åœ¨nextå‡½æ•°ä¸­ï¼Œå¦‚æœæ²¡æœ‰è·å¾—ä¸€ä¸ªæ¶ˆæ¯ï¼Œåˆ™ä¼šå¼€å§‹å¤„ç†idlerã€‚è¿™é‡Œä¼šåˆ¤æ–­æ˜¯å¦æœ‰idleråœ¨mIdleHandlersä¸­ï¼Œæ²¡æœ‰æˆ–è€…åŸæ¥å·²ç»å‘é€è¿‡ä¸€ä¸ªäº†ï¼Œåˆ™æ— éœ€å‘é€ï¼Œæ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹çš„ä¸€æ¬¡nextè°ƒç”¨ï¼Œæœ€å¤šåªä¼šå‘é€ä¸€æ¬¡idlerã€‚ å¦‚æœæœ‰idlerï¼Œä¸”ä¸ºç¬¬ä¸€æ¬¡å‘é€ï¼Œåˆ™å¼€å§‹å¤„ç†è¿™äº›idlerã€‚è¿™é‡Œä¼šè°ƒç”¨IdleHandlerçš„queueIdlerå‡½æ•°ã€‚åŒæ ·ï¼Œè¿™é‡Œéœ€è¦è‡ªå·±å®ç°IdlerHandleræ¥å£ï¼Œæ¥å¤„ç†ä¸€äº›ä¸ç´§æ€¥çš„äº‹æƒ…ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(9):ContentProvideræ•°æ®æ›´æ–°é€šçŸ¥","date":"2017-02-14T06:05:43.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-9-ContentProvideræ•°æ®æ›´æ–°é€šçŸ¥/","text":"1. ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€… ç”¨æˆ·ï¼ˆæ¯”å¦‚ä¸€ä¸ªActivityï¼‰æƒ³è¦å®æ—¶è·å¾—æŸé¡¹å†…å®¹çš„å˜åŒ–ï¼Œéœ€è¦æ³¨å†Œç›¸åº”çš„è§‚å¯Ÿè€…ã€‚è¿™ä¸ªè§‚å¯Ÿè€…å¯ä»¥è‡ªå®šï¼Œä½†æ˜¯éœ€è¦ç»§æ‰¿ContentObserverç±»ï¼Œè¿™ä¸ªç±»çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ªHandleå‚æ•°ï¼Œè¿™ä¸ªHandleå°±æ˜¯ç”¨æ¥å‘ç”¨æˆ·å‘é€æ•°æ®å˜åŒ–æ¶ˆæ¯çš„ã€‚ç„¶åå°†observerä½œä¸ºå‚æ•°ï¼Œåˆ©ç”¨ContentResolverçš„è¿™ä¸ªå‡½æ•°è¿›è¡Œæ³¨å†Œã€‚ åœ¨1.1ä¸­æƒ³è¦æ³¨å†Œobserverï¼Œé¦–å…ˆè¦åˆ©ç”¨è¯¥æ­¥éª¤è·å–ContentServiceã€‚ContentServiceæ˜¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œç”±ServiceManagerç®¡ç†ã€‚è¿™ä¸€æ­¥è·å–çš„å®é™…ä¸Šå¸‚ContentServiceçš„Binderä»£ç†å¯¹è±¡ã€‚ åœ¨1.1ä¸­æ³¨å†Œçš„observerå®é™…ä¼ é€’çš„æ˜¯observerçš„Transportç±»å‹çš„Binderä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥è¦ä»observerä¸­è·å¾—è¿™ä¸ªtransportã€‚ è¿™ä¸€æ­¥ä¸ºè¿›ç¨‹é—´å‡½æ•°è°ƒç”¨ã€‚è¿™ä¸€æ­¥ä¼šå°†observeråŠ å…¥åˆ°mRootNodeä¸­ï¼Œå› ä¸ºContentServiceç”¨ä¸€æ£µæ ‘æ¥ç»´æŠ¤æ‰€æœ‰æ³¨å†Œåˆ°è¿™é‡Œçš„è§‚æµ‹è€…ã€‚ç”¨æ ‘ç»“æ„æ˜¯å› ä¸ºURIå¤©ç„¶çš„æ ‘çŠ¶ç»“æ„ã€‚ è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªåœ¨æ ‘ä¸Šå¯»æ‰¾å’Œæ·»åŠ èŠ‚ç‚¹çš„é€’å½’å‡½æ•°ã€‚åœ¨æŒ‰ç…§URIçš„å±‚æ¬¡ç»“æ„å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹æ—¶ï¼Œå¯èƒ½ä¼šåˆ›é€ æ–°çš„èŠ‚ç‚¹ã€‚ç›´åˆ°åŒ¹é…äº†æœ€åçš„èŠ‚ç‚¹ï¼Œå°†observerå°è£…åœ¨ObserverEntryä¸­ï¼Œæ·»åŠ è¿›è¯¥èŠ‚ç‚¹ã€‚ 2. Content Providerå‘é€æ›´æ–°æ¶ˆæ¯ Content Providerå¦‚æœæƒ³è¦å‘é€æ›´æ–°é€šçŸ¥ï¼Œéœ€è¦è°ƒç”¨ontifyChangeå‡½æ•°ã€‚è¿™ä¸€æ­¥ä»¥æ–°çš„URIã€å’ŒObserverä¸ºå‚æ•°ï¼Œè¿™é‡Œå°†Observerè®¾ç½®ä¸ºnullã€‚è¿™ä¸€æ­¥ä¼šåšä¸€äº›æ£€æµ‹URIã€observeræ˜¯å¦ä¸ºç©ºçš„å·¥ä½œã€‚æœ€åï¼Œä»ç„¶æ˜¯è·å–ä¸€ä¸ªContentServiceçš„è¿›ç¨‹é—´é€šè®¯ä»£ç†ï¼Œç„¶åè°ƒç”¨ContentServiceçš„notifyChangeå‡½æ•°ã€‚ åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œä¼šä»æ ¹èŠ‚ç‚¹mRootNodeä¸­æ”¶é›†æ‰€æœ‰çš„Observerï¼Œè§2.3ã€‚ç„¶åä¾æ¬¡è°ƒç”¨è¿™äº›Observerçš„onChangeå‡½æ•°ï¼Œè§2.4ã€‚ è¿™ä¸€æ­¥ä¼šæ ¹æ®URIæŒ‡ç¤ºçš„è·¯å¾„ï¼Œä¾æ¬¡éå†æ ‘ä¸Šçš„èŠ‚ç‚¹ã€‚å¯¹äºç»è¿‡çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦å°†è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰å¯¹è¿™ä¸ªæ¶ˆæ¯æ„Ÿå…´è¶£çš„observeréƒ½å°è£…æˆObserverCallæ·»åŠ è¿›å…¥ã€‚ è¿™ä¸€æ­¥ä¹Ÿæ˜¯è¿›ç¨‹é—´çš„å‡½æ•°è°ƒç”¨ã€‚è¿™é‡ŒTransportåˆå°†æ¶ˆæ¯æŠ›ç»™ContentObserverå¤„ç†ã€‚ ContentObserverå°†æ¶ˆæ¯å°è£…è¿›ä¸€ä¸ªNotificationRunnableå‡½æ•°ï¼Œç„¶ååˆ©ç”¨mHandler å°†å…¶postç»™åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹å¤„ç†ã€‚ è¿™ä¸ªå‡½æ•°æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œã€‚è¿™å°†è¦è°ƒç”¨å®ƒçˆ¶ç±»çš„onChangeå‡½æ•°ã€‚ è¿è¡Œè‡ªå·±é‡å†™çš„ContentObserverçš„onChangeå‡½æ•°ï¼Œæ¶ˆæ¯å‘é€å®Œæ¯•ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(8):ContentProvideræ•°æ®ä¼ è¾“è¿‡ç¨‹","date":"2017-02-14T06:03:37.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-8-ContentProvideræ•°æ®ä¼ è¾“è¿‡ç¨‹/","text":"è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ 1. ç”¨æˆ·å¼€å§‹æŸ¥è¯¢ ç”¨æˆ·è°ƒç”¨queryå‡½æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚é¦–å…ˆå°è¯•è·å¾—providerï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤ç§ï¼Œå…ˆæ˜¯unstableï¼Œåæ˜¯stableï¼Œæš‚æ—¶æ²¡æœ‰åˆ†æ¸…è¿™ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ã€‚åœ¨å°è¯•è·å–Providerçš„è¿‡ç¨‹ä¸­ï¼Œå°†ä¼šç±»ä¼¼äºç¬¬7ç¯‡æ–‡ç« ä¸­çš„è¿‡ç¨‹ã€‚è¿™é‡Œå‡è®¾è¯¥ç”¨æˆ·å·²ç»æœ‰è¯¥providerçš„è®°å½•ï¼Œè·å–è¿‡ç¨‹è§1.2ã€‚åœ¨å–å¾—provideråï¼Œè§1.5ã€‚ ç»§ç»­è·å–Providerã€‚ ç»§ç»­è·å–Providerã€‚ ActivityThreadå°†æ‰€æœ‰å·²ç»è·å¾—çš„Provideræ”¾åœ¨mProviderMapä¸­ã€‚è¿™é‡Œå‡è®¾éœ€è¦è·å–çš„Providerå­˜åœ¨ï¼Œè¿”å›ä¸€ä¸ªIContentProviderç±»å‹çš„providerï¼Œè¿™ä¸ªæ¥å£æŒ‡å‘äº†Content Providerçš„ä¸€ä¸ªTransportä»£ç†å¯¹è±¡ï¼Œå³ContentProviderProxyå¯¹è±¡ã€‚ ä½¿ç”¨providerçš„ä»£ç†è¿›è¡ŒæŸ¥è¯¢ã€‚è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªBulkCursorToCursorAdaptorå¯¹è±¡ã€‚è¯¥ç‰ˆæœ¬æ²¡æœ‰åˆ›å»ºCursorWindowå¯¹è±¡ï¼Œå³æ²¡æœ‰åˆ›å»ºåŒ¿åå†…å­˜ï¼Œå’Œæ—§ç‰ˆæœ¬æœ‰äº›åŒºåˆ«ã€‚é‚£ä¹ˆï¼Œæ–°ç‰ˆæœ¬ä¸­åœ¨å“ªé‡Œåˆ›å»ºå…±äº«çš„å†…å­˜åŒºå‘¢ï¼Ÿæœ€åï¼Œå‡†å¤‡é€šè¿‡è¿›ç¨‹é—´é€šä¿¡å‘é€æ¶ˆæ¯ï¼Œç­‰å¾…è¿”å›çš„BulkCursorDescriptorï¼Œç„¶åå¯ä»¥è·å¾—å¯¹åº”çš„BulkCursorToCursorAdaptorï¼Œå³ä¸€ä¸ªAbstractWindowedCursorã€‚ 2. Content Providerå¤„ç†äº‹åŠ¡ è¯¥å‡½æ•°è´Ÿè´£å¤„ç†QUERY_TRANSACTIONäº‹åŠ¡ã€‚é¦–å…ˆå°†ä¼ å…¥çš„æ•°æ®è§£æå‡ºæ¥ï¼Œç„¶ååˆ©ç”¨å…¶å­ç±»Transportè¿›è¡ŒæŸ¥è¯¢ï¼Œä»2.2~2.6ï¼Œè·å¾—ä¸€ä¸ªSQLiteCursorå¯¹è±¡ã€‚ç„¶åç”¨SQLiteCursorå°è£…æˆCursorToBulkCursorAdapterå¯¹è±¡ã€‚ç„¶ååˆ›å»ºBulkCursorDescriptorï¼Œä»2.7~2.11ï¼Œç›®çš„å°±æ˜¯åˆ›å»ºwindowï¼Œå°†æ•°æ®æ”¾å…¥windowã€‚ç„¶åå°†BulkCursorDescriptorå­˜å…¥replyï¼Œé‡Œé¢åŒ…å«äº†SQLiteCursorçš„binderæœ¬åœ°å¯¹è±¡ï¼Œå› ä¸ºSQLiteCursoré‡Œåˆå«æœ‰windowï¼Œæœ€åè¿”å›ç»™ç”¨æˆ·åï¼Œç”¨æˆ·å¯ä»¥è·å¾—windowé‡Œå­˜å‚¨çš„å†…å®¹ã€‚ è¿™é‡Œä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥æ•°æ®ï¼Œå¦‚æœæœ‰æƒé™ï¼Œåˆ™è°ƒç”¨è‡ªå·±å®ç°çš„ContentProviderå­ç±»çš„queryå‡½æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚ è¯¥å‡½æ•°éœ€è¦åœ¨å­ç±»ä¸­é‡è½½ï¼Œå®ç°è‡ªå·±çš„æŸ¥è¯¢è¿‡ç¨‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾ä½¿ç”¨äº†æ•°æ®åº“æŸ¥è¯¢ã€‚ è¿™é‡Œä¼šé¦–å…ˆæ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ›å»ºä¸€æ¡SQLæŸ¥è¯¢è¯­å¥ï¼Œç„¶ååœ¨æ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚ è¿™ä¸€æ­¥ä¼šåˆ›å»ºä¸€ä¸ªæ•°æ®æŸ¥è¯¢driverï¼Œç”¨æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚ åˆ›å»ºä¸€ä¸ªSQLiteCursorå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº†databaseã€driverã€queryã€‚ä¸‹é¢å°±æ˜¯å°†SQLiteCursorè¿”å›ï¼Œä¸€ç›´è¿”å›åˆ°2.1ä¸­ã€‚ è¯¥æ­¥éª¤ä¼šå¯¹åˆ›å»ºçš„BulkCursorDescriptorè¿›è¡Œä¸€å®šçš„åˆå§‹åŒ–ã€‚ è·å¾—ç”¨æˆ·éœ€è¦çš„æ•°æ®æ¡æ•°ã€‚å¼€å§‹æ—¶ä¸º-1ï¼Œè¯´æ˜å°šæœªæ‰§è¡ŒæŸ¥è¯¢è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸‹é¢è¦æ‰§è¡ŒæŸ¥è¯¢æ•°æ®ï¼ŒåŒæ—¶å°†æ•°æ®æ”¾å…¥å†…å­˜å…±äº«åŒºwindowã€‚ å› ä¸ºwindowè¿˜æ²¡åˆ›å»ºï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹æ˜¯å…ˆåˆ›å»ºå…±äº«å†…å­˜åŒºwindowï¼Œè§2.10ã€‚ç„¶åå¡«å……windowï¼Œè§2.11ã€‚ è¿™ä¸€æ­¥ä¼šåˆ›å»ºæ–°çš„windowæˆ–è€…æ¸…ç©ºæ—§çš„windowä»¥é‡å¤åˆ©ç”¨ã€‚è¿™é‡Œçš„windowä»¥æ•°æ®åº“çš„è·¯å¾„ä¸ºåç§°ã€‚åˆ›å»ºCursorWindowçš„è¿‡ç¨‹ä¼šè°ƒç”¨nativeå‡½æ•°ï¼Œè§3.1~3.3ï¼Œæ‰€ä»¥ï¼Œæ–°çš„Androidç‰ˆæœ¬æ”¾å¼ƒäº†åŸæ¥åœ¨ç”¨æˆ·ä¸­åˆ›å»ºwindowçš„æ¨¡å¼ï¼Œè€Œæ˜¯åœ¨Content Providerä¸­ç»Ÿä¸€åˆ›å»ºã€ç®¡ç†windowã€‚ å¡«å……windowï¼Œè¿™é‡ŒåŒæ ·ä¼šä½¿ç”¨sqlçš„ä¸€äº›æ–¹æ³•ï¼Œæœ€åè½è„šäºè°ƒç”¨nativeå‡½æ•°ï¼Œè§4.1~4.3ã€‚æ‰§è¡Œåˆ°è¿™é‡Œï¼Œéœ€è¦æŸ¥è¯¢çš„æ•°æ®å·²ç»è¢«å­˜å‚¨äºwindowä¸­ã€‚ 3. Provideråˆ›å»ºwindowçš„nativeè¿‡ç¨‹ åœ¨2.10ä¸­ï¼Œä¼šåˆ›å»ºCursorWindowå¯¹è±¡ï¼Œæ‰€ä»¥ï¼ŒSQLiteCursorè°ƒç”¨äº†CursorWindowçš„æ„é€ å‡½æ•°ã€‚åœ¨è¯¥æ­¥éª¤ä¸­ï¼Œä¼šè®¾ç½®windowçš„å¤§å°ï¼Œè¯¥å¤§å°ä¼šåœ¨èµ„æºæ–‡ä»¶xmlä¸­è®¾ç½®ã€‚ç„¶ååˆ›å»ºwindowçš„è¿‡ç¨‹å°±äº¤ç»™c++ä»£ç å®Œæˆã€‚ android_database_CursorWindow.cppä½äºframeworks/base/core/jni/ç›®å½•ä¸‹ã€‚è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªCursorWindowå¯¹è±¡windowï¼Œè§3.3ã€‚ç„¶åç”¨reinterpret_castå‡½æ•°å°†windowæŒ‡é’ˆç±»å‹å˜ä¸ºjlongè¿”å›ã€‚ è¿™é‡Œå°±ä¼šåˆ›å»ºåŒ¿åå†…å­˜å—ã€‚è¿™é‡Œä½¿ç”¨äº†åŒ¿åå†…å­˜åˆ†é…çš„æœºåˆ¶ï¼Œæš‚ä¸æ·±ç©¶ã€‚ 4. Providerå¡«å……windowçš„nativeè¿‡ç¨‹ åœ¨2.11ä¸­ï¼Œä¼šå¯¹æ­¥éª¤3ä¸­åˆ›å»ºçš„windowè¿›è¡Œå¡«å……ã€‚è¿™ä¸€æ­¥ä¼šè·å¾—ä¸€ä¸ªSQLiteConnectionå¯¹è±¡ï¼Œç„¶åé€šè¿‡è¿™ä¸ªconnectionè¿›è¡Œæ•°æ®åº“æ“ä½œã€‚ è¿™é‡Œå¼€å§‹è°ƒç”¨native codeæ‰§è¡Œæ•°æ®æŸ¥è¯¢ï¼ŒåŒæ—¶å¡«å……windowã€‚ è¿™é‡Œä¼šé€šè¿‡sqlite3ä¸€è¡Œä¸€è¡Œçš„å°†æ•°æ®copyå…¥windowï¼Œè¿™é‡Œæš‚ä¸æ·±ç©¶sqlite3å¦‚ä½•åœ¨c++ä¸­çš„ä½¿ç”¨è¿‡ç¨‹ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(7):Content Providerçš„å¯åŠ¨","date":"2017-02-14T06:01:17.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-7-ContentProviderçš„å¯åŠ¨/","text":"è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ åŸºæœ¬çŸ¥è¯† Content Providerè¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œå®ƒæœ¬äº‹å°±æ˜¯ä¸€ä¸ªAndroidåº”ç”¨ç¨‹åºã€‚ Binderè¿›ç¨‹é—´é€šä¿¡åªé€‚åˆä¼ é€’ä½“ç§¯è¾ƒå°çš„æ•°æ®ç»“æ„ï¼Œä¸é€‚åˆå¤§é‡æ•°æ®çš„ä¼ è¾“ã€‚æ‰€ä»¥éœ€è¦é‡‡ç”¨åŒ¿åå…±äº«å†…å­˜æ¥ä¼ è¾“ä½“ç§¯è¾ƒå¤§çš„æ•°æ®ã€‚ Cursorå¯¹è±¡é€šè¿‡åŒ¿åå…±äº«å†…å­˜æ¥ä¼ è¾“æ•°æ®ï¼Œè€ŒBundleæ˜¯é€šè¿‡Binderä¼ é€’æ•°æ®ã€‚ 1. ç”¨æˆ·å¼€å§‹è°ƒç”¨Provideré¦–å…ˆï¼ŒActivityé›†æˆçš„ContextWrapperä¸­æœ‰æˆå‘˜å‡½æ•°getContentResolverï¼Œç”¨è¯¥å‡½æ•°å¯ä»¥è·å¾—ä¸€ä¸ªContentResolverå¯¹è±¡ã€‚è¯¥ContentResolverå¯¹è±¡æ˜¯åœ¨ContextImplå¯¹è±¡å»ºç«‹æ—¶åˆ›å»ºçš„ä¸€ä¸ªApplicationContentResolverå¯¹è±¡ã€‚ ä¸‹é¢ä»ContentResolver.acquireProviderå¼€å§‹ã€‚ æ­¥éª¤1çš„ä¸»è¦ç›®çš„æ˜¯éªŒè¯URIæ˜¯å¦æ­£ç¡®ï¼Œç„¶åå°±ä¼šå°†acquireProviderçš„ä»»åŠ¡äº¤ç»™å­ç±»æ¥å®ç°ï¼Œè¿™é‡Œå®ƒå°†ä»»åŠ¡ä¼ é€’ç»™ApplicationContentResolverã€‚ æ­¥éª¤2ç›´æ¥å°†ä»»åŠ¡ç»™ä¸»çº¿ç¨‹å¤„ç†ã€‚ æ­¥éª¤3å°†ä¼šå°è¯•ä»å·²æœ‰çš„Providerä¸­è·å–ç›®æ ‡Providerï¼ŒActivityThreadå°†å·²ç»è®¿é—®è¿‡çš„Provideræ”¾å…¥mProviderMapä¸­ï¼Œå¦‚æœå…¶ä¸­å«æœ‰éœ€è¦è·å–çš„Providerï¼Œåªéœ€è¦å¢åŠ å¯¹å…¶çš„å¼•ç”¨æ•°ç›®å³å¯ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦è¯·æ±‚ActivityManageræ¥è·å–Providerï¼ˆè§1.4ï¼‰ï¼ŒActivityManageræœ€åä¼šè¿”å›ä¸€ä¸ªContentProviderHolderï¼ˆè§2.2ï¼Œè§6.1ï¼‰ã€‚æœ€åï¼Œéœ€è¦å°†è·å¾—çš„ContentProviderHolderè¿›è¡Œinstall(è§1.5)ã€‚ è¿™é‡Œå‡è®¾æ²¡æœ‰ç°æˆçš„Providerï¼Œåˆ™éœ€è¦äº¤ç»™ActivityManagerè¿›è¡Œå¤„ç†ã€‚ è¿™ä¸€æ­¥å’Œ5.7æ˜¯ä¸€æ ·çš„å‡½æ•°ï¼ŒåŒºåˆ«åœ¨äºè¿™é‡Œçš„holderä¸ä¸ºnullï¼Œæ‰€ä»¥ä¸éœ€è¦è‡ªå·±é€šè¿‡ç±»åŠ è½½åˆ›å»ºProviderï¼Œåªéœ€è¦å°†è¿™ä¸ªProvideræ”¾å…¥mProviderRefCountMapä¸­ï¼Œå¯¹å…¶å¼•ç”¨åŠ 1ã€‚ 2. ActivityManagerå¤„ç†è¯·æ±‚ è¿™ä¸€æ­¥æ£€éªŒè°ƒç”¨è€…calleræ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¯´æ˜æ²¡æœ‰åº”ç”¨åœ¨è¯·æ±‚Providerï¼Œåˆ™æ— éœ€ç»§ç»­è¿›è¡Œã€‚ è¿™ä¸€æ­¥æ‰€åšçš„å¤„ç†æ¯”è¾ƒå¤šã€‚é¦–å…ˆï¼ŒManageré¦–å…ˆæ ¹æ®nameåœ¨mProviderMapä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ ¹æ®Classæ¥æŸ¥æ‰¾æ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœä»ç„¶æ²¡æœ‰ï¼Œåˆ™æ„å»ºContentProviderRecordï¼Œé‡Œé¢åŒ…å«äº†ProviderInfo,ApplicationInfoç­‰é‡è¦ä¿¡æ¯ã€‚ç„¶åï¼Œå¦‚æœæ˜¯multiprocesså±æ€§ä¸ºtrueï¼Œåˆ™å°†è¯¥ContentProviderRecordç›´æ¥è¿”å›ç»™è°ƒç”¨è€…ï¼Œè®©å…¶å®ä¾‹åŒ–ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾è¯¥å±æ€§ä¸ºfalseï¼Œéœ€è¦åˆ›å»ºæ–°çš„è¿›ç¨‹æ¥å¯åŠ¨è¯¥Providerã€‚ä¸‹é¢å°±è¦å¼€å§‹å¯åŠ¨æ–°çš„è¿›ç¨‹ï¼Œä¼šåœ¨2.3ä¸­è¯¦ç»†è®²è¿°ï¼Œç„¶åå°†Recordæ”¾å…¥mProviderã€‚æœ€åï¼ŒActivityManagerè¿›å…¥å¾ªç¯ç­‰å¾…providerå¯åŠ¨ï¼Œåœ¨å‘ç°providerå¯åŠ¨åï¼ˆè§6.1ï¼‰ï¼Œåˆ™é€€å‡ºå¾ªç¯ï¼Œå°†ContentProviderHolderè¿”å›ç»™ç”¨æˆ·ï¼ˆè§1.3ï¼‰ã€‚ è¿™ä¸€æ­¥å°±æ˜¯è¿›å…¥å¯åŠ¨æ–°è¿›ç¨‹çš„å‡†å¤‡å·¥ä½œã€‚ 3. æ–°è¿›ç¨‹çš„å¯åŠ¨è¿™é‡Œçš„å¯åŠ¨è¿‡ç¨‹å’ŒåŸæ¥ä¸€æ ·ã€‚ 4. ActivityManagerå¤„ç†æ–°çš„è¿›ç¨‹ è·å–æ–°è¿›ç¨‹pidã€‚ è¿™ä¸€æ­¥å…ˆæ ¹æ®pidè·å¾—å¯¹åº”çš„ProcessRecordï¼Œç„¶åå¡«å……ProcessRecordçš„ä¿¡æ¯ã€‚ç„¶åï¼Œè·å–éœ€è¦åœ¨è¯¥è¿›ç¨‹ä¸­å¯åŠ¨çš„Providerçš„åˆ—è¡¨ï¼Œå°†åœ¨4.3ä¸­è¯¦è§£ã€‚æ¥ä¸‹æ¥ä¾æ¬¡å¯åŠ¨è¯¥è¿›ç¨‹ä¸­çš„Content Providerï¼ˆåœ¨4.4ä¸­è¯¦è§£ï¼‰ã€Activityã€Serviceå’ŒBroadcast Receiverã€‚ è¿™ä¸€æ­¥é€šè¿‡PackageManagerè·å¾—æ‰€æœ‰çš„è¯¥åº”ç”¨è¿›ç¨‹ä¸‹éœ€è¦å¯åŠ¨çš„Providerï¼Œç„¶åä¸ºå…¶åˆ›å»ºContentProviderRecordï¼Œæ”¾å…¥mProviderMapã€‚ å‡†å¤‡å‘æ–°è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚ 5. Content Provideråœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨ å°†æ”¶åˆ°çš„æ•°æ®å°è£…æˆä¸€ä¸ªAppBindDataï¼Œå‡†å¤‡å‘é€åˆ°ä¸»çº¿ç¨‹ä¸­ã€‚ å‘é€æ¶ˆæ¯ã€‚ å‘é€æ¶ˆæ¯ã€‚ å¤„ç†å¼‚æ­¥æ¶ˆæ¯ã€‚ å‡†å¤‡å¯åŠ¨æ‰€æœ‰çš„Providerã€‚ è¿™ä¸€æ­¥å°†ä¼ é€’è¿‡æ¥çš„æ¯ä¸€ä¸ªProviderInfoé€šè¿‡installProviderå‡½æ•°ï¼ˆè§5.7ï¼‰å°è£…æˆäº†ContentProviderHolderã€‚ç„¶åå°†æ‰€æœ‰ç”Ÿæˆçš„ContentProviderHolderå‘ŠçŸ¥ç»™ActivityManagerï¼ˆè§5.11ï¼‰ã€‚ è¿™ä¸€æ­¥æ ¹æ®Providerçš„ç±»åï¼Œä½¿ç”¨ClassLoaderå®ä¾‹åŒ–ä¸€ä¸ªContentProviderå¯¹è±¡ï¼Œå¹¶å¯¹å…¶è¿›è¡Œä¸€å®šçš„åˆå§‹åŒ–ï¼ˆè§5.8ã€5.9ï¼‰å·¥ä½œã€‚ç„¶åï¼Œåˆ›å»ºå¯¹åº”çš„ProviderClientRecordï¼Œå°†å…¶æ”¾å…¥mLocalProviderså’ŒmLocalProvidersByNameã€‚ è·å–è¯¥Providerçš„ç±»å‹ä¸ºTransportçš„Binderæœ¬åœ°å¯¹è±¡ã€‚è¿™ä¸ªBinderå°†ä¼šå‘ŠçŸ¥ç»™ActivityManagerServiceï¼Œç„¶åæœ‰å®ƒå†å‘ŠçŸ¥ç»™éœ€è¦ä½¿ç”¨è¯¥Providerçš„å…¶å®ƒç»„ä»¶ã€‚ç„¶åå…¶å®ƒè¿›ç¨‹ç»„ä»¶å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªBinderæ¥ä½¿ç”¨è¿™ä¸ªprovideräº†ã€‚ è¿™é‡Œä¼šè®¾ç½®è¯¥providerçš„contextï¼ŒåŒæ—¶è®¾ç½®è¯»å†™æƒé™ã€‚æœ€åä¼šè°ƒç”¨é‡å†™çš„onCreateå‡½æ•°ã€‚ è°ƒç”¨è‡ªå·±å®ç°çš„onCreateå‡½æ•°ã€‚ å°†è‡ªå·±çš„Providerå‘ŠçŸ¥ç»™ActivityManagerã€‚ 6. ActivityManagerå‘å¸ƒProvider è¿™ä¸€æ­¥ä¼šå°†ActivityManageråˆ©ç”¨è·å¾—çš„ContentProviderHolderå¯¹è®°å½•çš„ContentProviderRecordçš„providerè¿›è¡Œå¡«å……ï¼ŒåŒæ—¶å°†è¯¥ContentProviderRecordæ”¾å…¥mProviderMapã€‚æœ€åå°†è¯¥Recordç§»é™¤mLaunchingProvidersã€‚åœ¨2.2ä¸­ç­‰å¾…çš„ActivityManagerServiceçº¿ç¨‹å¾ªç¯ç­‰å¾…å‘ç°providerä¸ä¸ºnullï¼Œé€€å‡ºå¾ªç¯ï¼Œè¿”å›ContentProviderHolderç»™ç”¨æˆ·ï¼ˆè§1.3ï¼‰ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(6)å¹¿æ’­æœºåˆ¶","date":"2017-02-14T05:57:56.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-6-å¹¿æ’­æœºåˆ¶/","text":"Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶ è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨Step1. Activityå¼€å§‹æ³¨å†Œ Step2. ActivityManagerServiceå¤„ç†æ³¨å†Œ å‘é€å¹¿æ’­Step1. Activityå‘é€å¹¿æ’­ Step2. ActivityManagerServiceå¤„ç†å¹¿æ’­æ¶ˆæ¯ Step3. Activityæ¥æ”¶å¹¿æ’­","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(5):Serviceåœ¨è¿›ç¨‹å†…ç»‘å®š","date":"2017-02-14T05:56:11.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-5-Serviceåœ¨è¿›ç¨‹å†…ç»‘å®š/","text":"Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ Step1. Activityå¼€å§‹å¯åŠ¨Service Step2. ActivityManagerServiceä¸­å‡†å¤‡ è¿™é‡Œéœ€è¦æ³¨æ„æœ‰ä¸¤æ¬¡è¿›ç¨‹é—´é€šä¿¡ï¼Œå…ˆè®²ç¬¬7æ­¥ (Step3)ï¼Œå†è®²ç¬¬9æ­¥(Step4)ã€‚ Step3. Serviceåˆ›å»º Step4. Serviceå…¬å¸ƒIBinder Step5. ActivityManagerServiceå…¬å¸ƒService Step6. Activityå»ºç«‹Connection","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(4):Serviceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹","date":"2017-02-14T05:54:43.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-4-Serviceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹/","text":"Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹ è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ Step1. Activityå¼€å§‹å¯åŠ¨Service Step2. ActivityManagerServiceå‡†å¤‡ Step3. ActivityThreadæ–°è¿›ç¨‹å¯åŠ¨ Step4. ActivityManagerServiceå¯åŠ¨ç­‰å¾…çš„Service Step5. Serveråˆ›å»º","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(3):å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹","date":"2017-02-14T05:51:41.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-3-å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹/","text":"è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹Step1. Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivityè¿™é‡Œå’Œä»Launcherå¯åŠ¨è¿‡ç¨‹å‡ ä¹æ²¡åˆ†åˆ«ï¼Œä½†æ˜¯å¯åŠ¨æœ‰äº›å‚æ•°çš„è®¾ç½®è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚ Step2. ActivityManagerServiceå‡†å¤‡åŒæ ·è¿™äº›ä¼šå…ˆåœæ­¢æ­£åœ¨æœ€å‰ç«¯çš„Activityã€‚ Step3. æ—§Activityåœæ­¢åŒæ ·è¿™é‡Œéœ€è¦åœ¨å®Œæˆåœæ­¢è¿‡ç¨‹åå‘ŠçŸ¥ActivityManagerServiceã€‚ Step4. ActivityManagerServiceç»§ç»­å‡†å¤‡ä¸‡äº‹ä¿±å¤‡ï¼Œåªå¾…çœŸçš„å¯åŠ¨Activityã€‚ Step5. æ–°Activityåˆ›å»ºåˆ°è¿™é‡Œå¯åŠ¨å®Œæ¯•ã€‚ Task, Process and Activityè¿™å‡ ä¸ªæ¦‚å¿µçœŸçš„å¾ˆè®©äººæ··æ·†ï¼Œæœ€åŸºæœ¬çš„ä¸€å¥è¯æ˜¯å®ƒä»¬å‡ ä¸ªæ˜¯å®Œå…¨ä¸åŒçš„æŠ½è±¡æ¦‚å¿µã€‚ å…ˆè¯´Processå’ŒActivityã€‚ä¸€ä¸ªApplicationå¯ä»¥å¤šä¸ªActivityå’Œå¤šä¸ªProcessã€‚ä¸¤ä¸ªActivityå¯ä»¥è¿è¡Œåœ¨ç›¸åŒçš„Processé‡Œï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„Processé‡Œï¼Œè¿™é‡Œå¯ä»¥åœ¨AndroidManifest.xmlä¸­è®¾ç½®android:processï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯è¿è¡Œåœ¨åŒä¸€ä¸ªProcessé‡Œçš„ã€‚å¹¶ä¸”è¯¥è¿›ç¨‹ä¸­çš„Activityã€Serviceéƒ½æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥Serviceä¹Ÿä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¦‚å¿µï¼Œä¸å¯ä»¥ç›´æ¥åœ¨Serviceä¸­è¿è¡Œè€—æ—¶çš„ä»»åŠ¡ã€‚ TaskåŒæ ·å’ŒProcessæ²¡æœ‰ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚Taskæ˜¯æè¿°Activityè·³è½¬çŠ¶æ€çš„æ ˆï¼Œåˆ©ç”¨åé€€æ“ä½œæ˜¯åœ¨åŒä¸€ä¸ªæ ˆä¸­è¿›è¡ŒActivityçš„å›é€€ï¼›åŒæ ·ï¼ŒæŸä¸€ä¸ªActivityå¯åŠ¨äº†å…¶å®ƒApplicationçš„Activityï¼ˆæ¯”å¦‚ä½ çš„appè°ƒç”¨äº†ç³»ç»Ÿè‡ªå¸¦çš„ç›¸å†Œappï¼‰ï¼Œè¿™ä¸¤ä¸ªActivityåŒæ ·ä¼šæ”¾ç½®äºåŒä¸€ä¸ªæ ˆä¸­ï¼Œè™½ç„¶è¿™ä¸¤ä¸ªacitivityæ˜æ˜¾ä¸åœ¨åŒä¸€ä¸ªApplicationä¸­ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸åœ¨åŒä¸€ä¸ªProcessä¸­ã€‚Taskåœ¨ç”¨æˆ·é€šè¿‡ä»»åŠ¡ç®¡ç†å™¨æ¥åˆ‡æ¢æ—¶ï¼Œåˆ™ä¼šå‘ç”Ÿäº¤æ¢ã€‚å°†å‰å°çš„Taskæ”¾åˆ°åé¢ï¼Œä½ é€‰æ‹©çš„Taskåˆ™ä¼šç½®äºæœ€å‰ç«¯ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(2):æ ¹Activityç»„ä»¶çš„å¯åŠ¨è¿‡ç¨‹","date":"2017-02-14T05:34:58.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-2-æ ¹Activityç»„ä»¶çš„å¯åŠ¨è¿‡ç¨‹/","text":"è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ ä»£ç æ‘˜æŠ„ä¸¤ä¸ªç‰ˆæœ¬çš„Launcherç›®å‰ç‰ˆæœ¬å·²ç»ä»Launcher2ï¼ˆpackages/apps/Launcher2/src/com/android/launcher2ï¼‰è¿›åŒ–ä¸ºLauncher3ï¼ˆpackages/apps/Launcher3/src/com/android/launcher3ï¼‰ã€‚ä¸¤ä¸ªç‰ˆæœ¬çš„Launcheræœ‰ç€ä¸€å®šçš„å·®å¼‚ï¼Œè€ç½—ä¹¦ä¸­ä»¥Launcher2ä¸ºå‡ºå‘ç‚¹ã€‚ packages/apps/Launcher2/src/com/android/launcher2/Launcher.java:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051boolean startActivity(View v, Intent intent, Object tag) &#123; intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); try &#123; // Only launch using the new animation if the shortcut has not opted out (this is a // private contract between launcher and may be ignored in the future). boolean useLaunchAnimation = (v != null) &amp;&amp; !intent.hasExtra(INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION); UserHandle user = (UserHandle) intent.getParcelableExtra(ApplicationInfo.EXTRA_PROFILE); LauncherApps launcherApps = (LauncherApps) this.getSystemService(Context.LAUNCHER_APPS_SERVICE); if (useLaunchAnimation) &#123; ActivityOptions opts = ActivityOptions.makeScaleUpAnimation(v, 0, 0, v.getMeasuredWidth(), v.getMeasuredHeight()); if (user == null || user.equals(android.os.Process.myUserHandle())) &#123; // Could be launching some bookkeeping activity startActivity(intent, opts.toBundle()); &#125; else &#123; launcherApps.startMainActivity(intent.getComponent(), user, intent.getSourceBounds(), opts.toBundle()); &#125; &#125; else &#123; if (user == null || user.equals(android.os.Process.myUserHandle())) &#123; startActivity(intent); &#125; else &#123; launcherApps.startMainActivity(intent.getComponent(), user, intent.getSourceBounds(), null); &#125; &#125; return true; &#125; catch (SecurityException e) &#123; Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show(); Log.e(TAG, \"Launcher does not have the permission to launch \" + intent + \". Make sure to create a MAIN intent-filter for the corresponding activity \" + \"or use the exported attribute for this activity. \" + \"tag=\"+ tag + \" intent=\" + intent, e); &#125; return false;&#125;boolean startActivitySafely(View v, Intent intent, Object tag) &#123; boolean success = false; try &#123; success = startActivity(v, intent, tag); &#125; catch (ActivityNotFoundException e) &#123; Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show(); Log.e(TAG, \"Unable to launch. tag=\" + tag + \" intent=\" + intent, e); &#125; return success;&#125; packages/apps/Launcher3/src/com/android/launcher3/Launcher.java:123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081private boolean startActivity(View v, Intent intent, Object tag) &#123; intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); try &#123; // Only launch using the new animation if the shortcut has not opted out (this is a // private contract between launcher and may be ignored in the future). boolean useLaunchAnimation = (v != null) &amp;&amp; !intent.hasExtra(INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION); LauncherAppsCompat launcherApps = LauncherAppsCompat.getInstance(this); UserManagerCompat userManager = UserManagerCompat.getInstance(this); UserHandleCompat user = null; if (intent.hasExtra(AppInfo.EXTRA_PROFILE)) &#123; long serialNumber = intent.getLongExtra(AppInfo.EXTRA_PROFILE, -1); user = userManager.getUserForSerialNumber(serialNumber); &#125; Bundle optsBundle = null; if (useLaunchAnimation) &#123; ActivityOptions opts = null; if (Utilities.ATLEAST_MARSHMALLOW) &#123; int left = 0, top = 0; int width = v.getMeasuredWidth(), height = v.getMeasuredHeight(); if (v instanceof TextView) &#123; // Launch from center of icon, not entire view Drawable icon = Workspace.getTextViewIcon((TextView) v); if (icon != null) &#123; Rect bounds = icon.getBounds(); left = (width - bounds.width()) / 2; top = v.getPaddingTop(); width = bounds.width(); height = bounds.height(); &#125; &#125; opts = ActivityOptions.makeClipRevealAnimation(v, left, top, width, height); &#125; else if (!Utilities.ATLEAST_LOLLIPOP) &#123; // Below L, we use a scale up animation opts = ActivityOptions.makeScaleUpAnimation(v, 0, 0, v.getMeasuredWidth(), v.getMeasuredHeight()); &#125; else if (Utilities.ATLEAST_LOLLIPOP_MR1) &#123; // On L devices, we use the device default slide-up transition. // On L MR1 devices, we a custom version of the slide-up transition which // doesn't have the delay present in the device default. opts = ActivityOptions.makeCustomAnimation(this, R.anim.task_open_enter, R.anim.no_anim); &#125; optsBundle = opts != null ? opts.toBundle() : null; &#125; if (user == null || user.equals(UserHandleCompat.myUserHandle())) &#123; // Could be launching some bookkeeping activity startActivity(intent, optsBundle); &#125; else &#123; // TODO Component can be null when shortcuts are supported for secondary user launcherApps.startActivityForProfile(intent.getComponent(), user, intent.getSourceBounds(), optsBundle); &#125; return true; &#125; catch (SecurityException e) &#123; Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show(); Log.e(TAG, \"Launcher does not have the permission to launch \" + intent + \". Make sure to create a MAIN intent-filter for the corresponding activity \" + \"or use the exported attribute for this activity. \" + \"tag=\"+ tag + \" intent=\" + intent, e); &#125; return false;&#125;public boolean startActivitySafely(View v, Intent intent, Object tag) &#123; boolean success = false; if (mIsSafeModeEnabled &amp;&amp; !Utilities.isSystemApp(this, intent)) &#123; Toast.makeText(this, R.string.safemode_shortcut_error, Toast.LENGTH_SHORT).show(); return false; &#125; try &#123; success = startActivity(v, intent, tag); &#125; catch (ActivityNotFoundException e) &#123; Toast.makeText(this, R.string.activity_not_found, Toast.LENGTH_SHORT).show(); Log.e(TAG, \"Unable to launch. tag=\" + tag + \" intent=\" + intent, e); &#125; return success;&#125; Androidçš„Singletonæ¨¡å¼çš„å®ç°åœ¨frameworks/base/core/java/android/app/ActivityManagerNative.javaä¸­IActivityManageræ˜¯ä¸€ä¸ªå•åˆ©æ¨¡å¼ï¼Œæ‰€ä»¥Androidå®ç°äº†ä¸€ä¸ªå¾ˆæ ‡å‡†çš„Singletonã€‚åœ¨è€ç½—ç‰ˆæœ¬é‡Œï¼Œæ²¡æœ‰ä½¿ç”¨è¿™ä¸ªç±»ã€‚ framework/base/core/java/android/util/Singleton.java:123456789101112131415161718192021/** * Singleton helper class for lazily initialization. * * Modeled after frameworks/base/include/utils/Singleton.h * * @hide */public abstract class Singleton&lt;T&gt; &#123; private T mInstance; protected abstract T create(); public final T get() &#123; synchronized (this) &#123; if (mInstance == null) &#123; mInstance = create(); &#125; return mInstance; &#125; &#125;&#125; ActivityManagerServiceæ˜¾ç„¶ï¼ŒAcitivityManagerServiceçš„ä½ç½®ç”±frameworks/base/services/java/com/android/service/am/ActivityManagerService.javaè½¬ç§»è‡³frameworks/base/services/core/java/com/android/service/am/ActivityManagerService.javaã€‚åŒæ—¶startActivityå‡½æ•°ä¹Ÿæœ‰æ‰€æ”¹å˜ï¼š frameworks/base/services/core/java/com/android/service/am/ActivityManagerService.java:123456789101112131415161718192021@Overridepublic final int startActivity(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle options) &#123; return startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, options, UserHandle.getCallingUserId());&#125;@Overridepublic final int startActivityAsUser(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle options, int userId) &#123; enforceNotIsolatedCaller(\"startActivity\"); userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId, false, ALLOW_FULL_ONLY, \"startActivity\", null); // TODO: Switch to user app stacks here. return mStackSupervisor.startActivityMayWait(caller, -1, callingPackage, intent, resolvedType, null, null, resultTo, resultWho, requestCode, startFlags, profilerInfo, null, null, options, false, userId, null, null);&#125; ä¸»è¦çš„å˜åŒ–æ˜¯æ·»åŠ äº†ç”¨æˆ·çš„æ¦‚å¿µï¼ŒåŒæ—¶åŠ å…¥äº†mStackSupervisorï¼ˆActivityStackSuperVisorï¼‰æ¥ç®¡ç†ActivityStackã€‚ æ ¹Activityå¯åŠ¨è¿‡ç¨‹ä¸‹é¢å°†ç”¨é¡ºåºå›¾æ¥å±•ç¤ºæ ¹Activityæ˜¯å¦‚ä½•ä»æ¡Œé¢å¯åŠ¨çš„ã€‚ Step1. Launcherå¯åŠ¨ä¸€ä¸ªAPPå½“ç”¨æˆ·ç‚¹å‡»æŸä¸€ä¸ªåº”ç”¨å›¾æ ‡ï¼Œæ„å‘³ç€éœ€è¦å¯åŠ¨ä¸€ä¸ªåº”ç”¨çš„æ ¹Activityã€‚Launcherä¹Ÿæ˜¯ä¸€ä¸ªåº”ç”¨ï¼Œå’Œæ™®é€šåº”ç”¨å¯åŠ¨Activityè¿‡ç¨‹ç±»ä¼¼ã€‚è¿™é‡Œå±•ç¤ºäº†åœ¨Launcherä¸­çš„è¿›è¡Œçš„æ­¥éª¤ï¼Œæœ€åé€šè¿‡Binderä¸ActivityMangerServiceè¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œå‘ŠçŸ¥å®ƒæ¥å¯åŠ¨Activityã€‚ Step2. ActivityMangerServiceè¿›è¡Œå‡†å¤‡å·¥ä½œè¿™é‡Œä¸»è¦å·¥ä½œå°±è¡Œå°†éœ€è¦å¯åŠ¨çš„Activityæ”¾ç½®äºæ ˆé¡¶ï¼Œç­‰å¾…å¯åŠ¨ã€‚åœ¨å¯åŠ¨æ–°Activityå‰ï¼Œéœ€è¦å°†æ—§çš„Activityå…ˆåœæ­¢ä¸‹æ¥ã€‚ Step3. æ—§Activityåœæ­¢åœ¨è¿™é‡Œï¼Œéœ€è¦åœæ­¢çš„Activityå°±æ˜¯Launcherçš„Activityã€‚åœ¨å®Œæˆåœæ­¢çš„è¿‡ç¨‹åï¼Œéœ€è¦å‘ŠçŸ¥ActivityMangerServiceã€‚ Step4. ActivityMangerServiceç»§ç»­å‡†å¤‡è¿™é‡Œä¼šå‘ç°è¯¥Activityè¿˜æ²¡æœ‰è¿›ç¨‹å¯ä»¥è¿è¡Œï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯åŠ¨ä¸€ä¸ªæ–°çš„ActvityThreadè¿›ç¨‹ã€‚ Step5. ActivityThreadè¿›ç¨‹å¯åŠ¨ç­‰è¿›ç¨‹å¯åŠ¨å®Œæ¯•åï¼ŒåŒæ ·éœ€è¦ActivityMangerServiceï¼Œä»¥ä¾¿å®ƒå°†ç­‰å¾…è¯¥è¿›ç¨‹çš„Activityå¯åŠ¨èµ·æ¥ã€‚ Step6. ActivityMangerServiceç»§ç»­å¯åŠ¨è¿™é‡Œä¼šå°†ç­‰å¾…è¯¥è¿›ç¨‹çš„Activityå’ŒServiceå¯åŠ¨èµ·æ¥ã€‚ Step7. æ–°Activityå¯åŠ¨åˆ°è¿™é‡Œï¼Œå¯åŠ¨è¿‡ç¨‹ç»“æŸ","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Androidç³»ç»Ÿæºç é˜…è¯»(1):ç¼–è¯‘","date":"2017-02-14T05:31:31.000Z","path":"2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-1-ç¼–è¯‘/","text":"1. ç¼–è¯‘è¿‡ç¨‹å‚è€ƒå®˜æ–¹ï¼Œæ³¨æ„ç»†èŠ‚ã€‚ ç¼–è¯‘ç‰ˆæœ¬6.0.1_r50ã€‚ 1.1 ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶å¦‚æœæƒ³è¦å°†ç¼–è¯‘å¥½çš„imgåˆ·å…¥ç‰©ç†è®¾å¤‡ï¼Œè€Œä¸æ˜¯è™šæ‹Ÿæœºï¼Œä¸€å®šè¦å…ˆä¸‹è½½å¥½è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¾åœ¨AOSPçš„æ ¹ç›®å½•ä¸‹ã€‚ äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½ã€‚ä¸‹è½½å®Œæ¯•åå¹¶è§£å‹åï¼Œä¼šæœ‰shæ–‡ä»¶ç”Ÿæˆï¼›è¿è¡Œshæ–‡ä»¶ï¼Œä¼šåœ¨AOSPç›®å½•ä¸‹ç”Ÿæˆvendor/æ–‡ä»¶å¤¹ï¼Œå¿…è¦çš„æ–‡ä»¶ä¼šæ”¾åœ¨é‡Œé¢ã€‚ç„¶åå†æ‰§è¡Œç¼–è¯‘ã€‚ 1.2 ç¼–è¯‘å…ˆæ¸…ç†ä¸€ä¸‹æ—§çš„ç”Ÿæˆæ–‡ä»¶ï¼Œä¸ªäººè®¤ä¸ºå¾ˆæœ‰å¿…è¦ã€‚12345678make clobber``` ç„¶åè®¾ç½®ç¯å¢ƒå˜é‡: ```sh$ source build/envsetup.sh# æˆ–è€…$ . build/envsetup.sh è®¾ç½®java ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œæ ¹æ®ä½ çš„AOSPé€‰æ‹©javaç‰ˆæœ¬ï¼Œè®¾ç½®é€‚å½“çš„javaè·¯å¾„:12$ export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64$ export PATH=$JAVA_HOME/bin:$PATH è®¾ç½®ç¼“å­˜åŒºåŸŸï¼Œæ ¹æ®è‡ªå·±æƒ…å†µè®¾ç½®ï¼š123export USE_CCACHE=1export CCACHE_DIR=/home/tianchi/Project/.ccache prebuilts/misc/linux-x86/ccache/ccache -M 50G é€‰æ‹©éœ€è¦ç¼–è¯‘çš„ç›®æ ‡ï¼š12$ launch#é€‰æ‹©ä½ æƒ³è¦ç¼–è¯‘çš„ç‰ˆæœ¬ å¼€å§‹ç¼–è¯‘ï¼Œè®¾ç½®ç¼–è¯‘æ—¶ç”¨åˆ°çš„å†…æ ¸æ•°ç›®ï¼Œè¿™é‡Œå†™ï¼”ï¼š1$ make -j4 ç¨ç­‰å‡ ä¸ªå°æ—¶ï¼Œå‘µå‘µï¼Œå¥‡è¿¹å°±ä¼šå‘ç”Ÿã€‚ç”Ÿæˆçš„ç»“æœä½äºout/target/product/flo/ï¼Œfloæ˜¯æˆ‘Nexus 7çš„å‹å·ï¼Œå’Œlaunchæ—¶é€‰æ‹©çš„ç‰ˆæœ¬ç›¸åŒã€‚ 2. åˆ·å…¥çœŸæœºå°†ç¼–è¯‘å¥½çš„imgæ–‡ä»¶åˆ·å…¥è®¾å¤‡æ¯”è¾ƒå®¹æ˜“ï¼Œå…³é”®ç‚¹åœ¨äºå‰é¢æ­¥éª¤ï¼šä¸‹è½½äº†ç¬¬ä¸‰æ–¹åŒ…ï¼Œé€‰æ‹©äº†æ­£ç¡®çš„ç¼–è¯‘ç‰ˆæœ¬ã€‚ é‡å¯è®¾å¤‡è¿›å…¥fastbootæ¨¡å¼ï¼Œä½¿ç”¨å‘½ä»¤ï¼Œè¿™é‡Œåˆ·å…¥çš„Nexus7ï¼š1$ fastboot -p flo flashall 3. å¯åŠ¨emulatoré—®é¢˜æƒ³è¦åœ¨è™šæ‹Ÿæœºé‡Œè·‘èµ·æ¥ï¼Œéœ€è¦åœ¨launchæ­¥éª¤ä¸­é€‰æ‹©æ­£ç¡®çš„è™šæ‹Ÿæœºç‰ˆæœ¬ï¼Œé»˜è®¤ç¬¬ä¸€ä¸ªã€‚ ç›¸å…³å·¥å…·emulatorå’Œkernel-qemué»˜è®¤æ”¾ç½®ç›®å½•å·²ç»ä¸åœ¨out/host/linux-xxx/binï¼Œå·²ç»è¿ç§»åˆ°prebuilts/android-emulator/linux-x86_64/emulatorå’Œ/prebuilts/qemu-kernel/x86_64/kernel-qemuç­‰ç›¸å¯¹åº”çš„ä½ç½®ã€‚ å¸¸ç”¨çš„å¯åŠ¨å‘½ä»¤ï¼š123prebuilts/android-emulator/linux-x86_64/emulator -kernel ./prebuilts/qemu-k ernel/x86_64/kernel-qemu -sysdir out/target/product/generic/ -system system.img -data userdata.img -ramdisk ramdisk.img``` è¯¥å‘½ä»¤å¯åŠ¨ä¼šå‡ºç°å„ç§å„æ ·çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š qemu: could not load initrd â€˜ramdisk.imgâ€™1234567891011121314151617181920212223242526272829303132333435è™½ç„¶æœ‰äººå·²ç»ç»™å‡ºäº†ç›¸å…³è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚å»æ‰`-ramdisk ramdisk.img`ï¼Œæˆ–è€…ä¿®æ”¹`chmod -R 777 out/target/product/generic/`æ¥å¢åŠ æƒé™ï¼Œæˆ–è€…ä¿®æ”¹`/prebuilts/qemu-k ernel/x86_64/kernel-qemu`ä¸ºåˆé€‚çš„ç³»ç»Ÿç‰ˆæœ¬ã€‚è¿™äº›è§£å†³æ–¹æ³•æœ‰çš„ä¸å¤ªæœ‰æ•ˆï¼Œæ€»ä¹‹ä¸æ˜¯å¾ˆä¼˜ç¾ï¼Œå…¶å®å®˜æ–¹å·²ç»æä¾›äº†ä¸€ä¸ªå¯åŠ¨emulatorçš„çœå¿ƒæ–¹æ³•ï¼š ```sh# é¦–å…ˆåŠ å…¥åŸºæœ¬çš„ç¯å¢ƒå˜é‡$ source build/envsetup.sh# é€‰æ‹©éœ€è¦å¯åŠ¨çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå› ä¸ºæˆ‘ç¼–è¯‘çš„1ï¼Œæ‰€ä»¥ä¸€å®šè¦é€‰æ‹©1.$ lunchYou&apos;re building on LinuxLunch menu... pick a combo: 1. aosp_arm-eng 2. aosp_arm64-eng 3. aosp_mips-eng 4. aosp_mips64-eng 5. aosp_x86-eng 6. aosp_x86_64-eng 7. aosp_deb-userdebug 8. aosp_flo-userdebug 9. full_fugu-userdebug 10. aosp_fugu-userdebug 11. mini_emulator_arm64-userdebug 12. m_e_arm-userdebug 13. mini_emulator_mips-userdebug 14. mini_emulator_x86_64-userdebug 15. mini_emulator_x86-userdebug 16. aosp_flounder-userdebug 17. aosp_angler-userdebug 18. aosp_bullhead-userdebug 19. aosp_hammerhead-userdebug 20. aosp_hammerhead_fp-userdebug 21. aosp_shamu-userdebug # å¯åŠ¨emulator$ emulator 4. åœ¨Android Studioä¸­é˜…è¯»æºç Androidå·¥ç¨‹å¸ˆå¾ˆåœ°é“ï¼Œè€ƒè™‘åˆ°äº†å¦‚ä½•æ–¹ä¾¿çš„å°†é¡¹ç›®å¯¼å…¥AndroidStudioã€‚åœ¨ç¼–è¯‘å®Œæˆï¼Œç¯å¢ƒå˜é‡é…ç½®å¥½çš„å‰æä¸‹ï¼Œè¿›è¡Œä¸‹é¢æ­¥éª¤ã€‚ 4.1 ç”Ÿæˆidegenç¼–è¯‘idegen:1$ mmm development/tools/idegen è¿è¡Œidegen:1$ development/tools/idegen/idegen.sh ç„¶åï¼Œä½ å°±å›åœ¨AOSPç›®å½•ä¸‹å‘ç°ï½€android.iprï½€ç­‰æ–‡ä»¶ã€‚ 4.2 å¯¼å…¥æ‰“å¼€AndroidStudioï¼Œé€‰æ‹©å¯¼å…¥å·²æœ‰çš„é¡¹ç›®ï¼Œé€‰æ‹©android.iprã€‚è¿™é‡Œéœ€è¦å¯¼å…¥ä¸€æ®µæ—¶é—´ã€‚ å¯¼å…¥åä¼šå‘ç°é”™è¯¯ç™¾å‡ºã€‚é¦–å…ˆæ‰“å¼€Project Structureï¼Œé€‰æ‹©ï½€SDKsï½€æ·»åŠ ä¸€ä¸ªSDKï¼Œæˆ‘è¿™é‡Œéœ€è¦1.7ï¼šæ¸…ç†ClassPathä¸‹çš„æ‰€æœ‰jaråŒ…ï¼Œç„¶åä¿å­˜ã€‚ é€‰æ‹©Projectï¼Œé€‰æ‹©Project SDKä¸ºæ–°å»ºçš„SDKï¼ŒProject language levelä¹Ÿè®¾ç½®ä¸ºå¯¹åº”çš„ç­‰çº§ã€‚ é€‰æ‹©Modulesï¼Œåœ¨Dependenciesæ ‡ç­¾ä¸‹ï¼Œåˆ é™¤jar ä¾èµ–ï¼Œæœ€åå¦‚ä¸‹ï¼š ç„¶ååœ¨Modulesä¸‹ï¼ŒSourcesæ ‡ç­¾ä¸‹ï¼Œé€‰æ‹©out/target/common/Ræ–‡ä»¶ï¼Œé€‰æ‹©å³é”®Sourceã€‚è¿™é‡Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¼šå› ä¸ºRæ–‡ä»¶è¿‡å¤§ï¼Œå¯¼è‡´ä¾ç„¶æŠ¥é”™ã€‚è¿™æ—¶éœ€è¦ä¿®æ”¹AndroidStudioåº”ç”¨ç›®å½•ä¸‹Android_Studio/bin/idea.propertiesæ–‡ä»¶ï¼Œæ‰¾åˆ°filesizeï¼Œå°†å‚æ•°ä¿®æ”¹å¤§ä¸€äº›ã€‚1idea.max.intellisense.filesize=5000 Android stackè¿™ä¸ªå›¾åº”è¯¥æ—¶æ—¶å›é¡¾ä¸€ä¸‹ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Nexus7ææœºæ•™ç¨‹","date":"2017-02-14T05:28:37.000Z","path":"2017/02/14/Nexus7ææœºæ•™ç¨‹/","text":"ç³»ç»Ÿå‡†å¤‡è¿™é‡Œï¼Œæˆ‘å‡†å¤‡äº†Nexus 7ï¼ˆwifiç¬¬äºŒç‰ˆï¼‰ä½œä¸ºæµ‹è¯•æœºå‹ï¼ŒAndroidç‰ˆæœ¬4.4.2ã€‚ç”±äºè¯¥æœºå™¨æ˜¯ä¸€ä¸ªæ–°æœºå™¨ï¼Œè¿˜æ²¡æ¿€æ´»ï¼Œéœ€è¦åœ¨WLANç•Œé¢è”ç½‘æ¿€æ´»ï¼Œå¦åˆ™æ— æ³•è¿›å…¥ç³»ç»Ÿã€‚æˆ‘å·²ç»å°è¯•è¿‡ä½¿ç”¨ä»£ç†IPï¼Œæˆ–è€…ä½¿ç”¨ç¿»å¢™çš„å…¶å®ƒæ‰‹æœºä½œä¸ºçƒ­ç‚¹ï¼Œéƒ½ä»¥å¤±è´¥å‘Šç»ˆã€‚æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œæˆ‘è¦ä»‹ç»ä¸€ç§ç»•è¿‡Nexus 7æ¿€æ´»çš„æ–¹æ³•ã€‚ åˆ·å…¥recoveryè¯¥è¿‡ç¨‹ç”¨äºNexus 7ç»•è¿‡æ¿€æ´»å’Œè®¾å¤‡rootï¼Œæœ‰ä¸ªå¥½ä½¿çš„recoveryä¹Ÿå¾ˆå¿…è¦ã€‚ é¦–å…ˆä¿è¯ç”µè„‘å·²ç»å®‰è£…ADBç¯å¢ƒï¼Œè¿™é‡Œä¸å†èµ˜è¿°å®‰è£…è¿‡ç¨‹ã€‚ç¡®ä¿fastbootå‘½ä»¤å¯ä»¥åœ¨ç»ˆç«¯æ‰§è¡Œå³å¯ã€‚ æˆ‘åœ¨è¿™é‡Œæ¨èTWRP recoveryï¼Œç”¨èµ·æ¥å¾ˆé¡ºæ‰‹ã€‚åœ¨ TeamWin - TWRP æ‰¾åˆ°è‡ªå·±éœ€è¦çš„recoveryï¼Œæˆ‘åœ¨è¿™é‡Œé€‰æ‹©Asus Nexus 7 2013 Wi-Fi (flo)ï¼Œè¿™ä¸ªä¸€å®šè¦å’Œè‡ªå·±ç§»åŠ¨è®¾å¤‡åŒ¹é…ã€‚ ä¸‹è½½å¥½twrp-xxxx.imgæ–‡ä»¶ï¼Œå…³æœºåï¼ŒæŒ‰Power+Volumn downæ¥é‡å¯æ‰‹æœºï¼Œè¿›å…¥fastbootæ¨¡å¼ã€‚è¿™æ—¶ï¼Œä¿è¯è®¾å¤‡å’Œç”µè„‘é€šè¿‡USBè¿æ¥ï¼ŒåŒæ—¶ä½¿ç”¨å‘½ä»¤ï¼Œå¯ä»¥åœ¨ç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡åç§°ï¼š1$ adb devices å¦‚æœæ‰‹æœºåˆå§‹çŠ¶æ€ä¸ºåŠ é”çŠ¶æ€ï¼Œæ‰€ä»¥é¦–å…ˆè¦è§£é”ï¼š1$ fastboot oem unlock è§£é”æˆåŠŸåï¼Œç„¶ååˆ·å…¥recoveryï¼š1$ fastboot flash recovery twrp.img åˆ·å…¥recoveryï¼ŒæˆåŠŸä¼šæ˜¾ç¤ºä¸€äº›Okeyå­—æ ·ã€‚æˆåŠŸåˆ·å…¥ä»¥åï¼Œå…³é—­è®¾å¤‡ï¼Œä½¿ç”¨Power+Volumn upè¿›å…¥recoveryæ¨¡å¼ï¼Œç­‰å¾…ä¸€å°ä¼šï¼Œå¦‚æœé•¿æ—¶é—´åœç•™åœ¨twrpåˆå§‹ç•Œé¢ï¼Œå¯ä»¥ç‚¹å‡»éŸ³é‡ä¸Šæˆ–ä¸‹é”®æ¥è§‚å¯Ÿæ˜¯å¦å·²ç»è¿›å…¥ã€‚å¦‚æœrecoveryæ— æ³•è¿›å…¥ï¼Œæœ‰å¯èƒ½æ˜¯åˆ·å…¥çš„recoveryå’Œè®¾å¤‡ç‰ˆæœ¬ä¸ä¸€è‡´ã€‚ Recoveryä¸ä»…ä»…ç”¨äºNexus 7ç»•è¿‡æ¿€æ´»ï¼Œä¸€ä¼šrootæ‰‹æœºæ—¶ï¼Œä¹Ÿéœ€è¦ç”¨åˆ°ã€‚ æ¿€æ´»Nexus 7Twrp recoveryæä¾›äº†å¾ˆäººæ€§åŒ–çš„ç•Œé¢ï¼Œå¯ä»¥ä½¿ç”¨ç‚¹å‡»æ“ä½œã€‚ä½ éœ€è¦é¦–å…ˆåˆ©ç”¨recoveryçš„æŒ‚åœ¨åŠŸèƒ½(mount)ï¼Œå°†/systemåˆ†åŒºæŒ‚åœ¨ä¸Šï¼Œç„¶ååœ¨è®¡ç®—æœºç»ˆç«¯è¿›å…¥è®¾å¤‡ç³»ç»Ÿæ–‡ä»¶ï¼š12$ adb shell$ cd /system è¿™æ—¶å¯ä»¥çœ‹åˆ°æ–‡ä»¶build.propï¼Œå¯ä»¥ç§catæˆ–è€…viæ¥çœ‹é‡Œé¢å†…å®¹ï¼Œå…¶ä¸­é‡è¦è¯­å¥ro.setupwizard.network_required=trueï¼Œè¿™ä¸ªå°±æ˜¯è¦æ±‚ç½‘ç»œéªŒè¯çš„é…ç½®ã€‚è¿™é‡Œï¼Œæ— è®ºä½ ç”¨ä½•ç§æ–¹æ³•ï¼ŒæŠŠtrueæ”¹ä¸ºfalseï¼Œä¿å­˜å³å¯ã€‚ é‡å¯æ‰‹æœºï¼Œå¦‚æœå¡åœ¨ç­‰å¾…ç•Œé¢ï¼Œåˆ™æŒ‰éŸ³é‡é”®ï¼Œçœ‹æ—¶å€™å¯ä»¥è¿›å…¥ï¼ˆå…¶å®æˆ‘ä¹Ÿä¸çŸ¥å…¶ä¸­åŸå§”ï¼Œåªæ˜¯è¿™æ ·è¯•äº†ä¸€ä¸‹ï¼Œå°½é‡è€å¿ƒç­‰å¾…ä¸€æ®µæ—¶é—´ï¼‰ã€‚è¿›å…¥åä¼šå‘ç°è¿›å…¥äº†æ­£å¸¸çš„åˆå§‹åŒ–æ­¥éª¤ï¼Œåˆ°è¾¾WLANè¿æ¥æ¿€æ´»æ—¶ï¼Œå‘ç°ä¸‹é¢ç¥å¥‡çš„å¤šäº†ä¸€ä¸ªæŒ‰é’®â€œè·³è¿‡â€ï¼è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°ä¸€äº›ç½‘ç»œé”™è¯¯ä»€ä¹ˆçš„ï¼Œä¸å¿…å…³å¿ƒï¼Œåªè¦ä¸€æ­¥æ­¥åˆå§‹åŒ–ï¼Œå°±å¯ä»¥æœ€ç»ˆè¿›å…¥ç³»ç»Ÿã€‚ Rootæ‰‹æœºå·²ç»rootè¯·è·³è¿‡æ­¤æ­¥éª¤ã€‚ å¯ä»¥ä½¿ç”¨å›½å†…çš„rootå¤§å¸ˆã€ç²¾çµä¹‹æµçš„rootè½¯ä»¶è¿›è¡Œrootï¼Œä½†æ˜¯å¹¶ä¸æ¨èï¼Œå› ä¸ºå®ƒä»¬ä¼šé™„åŠ å®‰è£…ä¸€äº›åº”ç”¨ã€‚è¿™é‡Œæˆ‘æ¨èä½¿ç”¨SuperSUç»“åˆrecoveryè¿›è¡Œrootã€‚ é¦–å…ˆä¸‹è½½SuperSU zipæ–‡ä»¶ï¼Œä¸‹è½½å®Œæ¯•åï¼Œå°†å…¶ä¼ å…¥æ‰‹æœºæŸä¸ªä½ç½®ï¼Œç„¶åé‡å¯è¿›å…¥recoveryæ¨¡å¼ã€‚ åœ¨recoveryé€‰æ‹©install è¿™ä¸ªzipæ–‡ä»¶å³å¯ã€‚é‡å¯åå¯ä»¥å‘ç°åº”ç”¨SuperSUï¼Œå¯ä»¥åˆ©ç”¨å®ƒç®¡ç†æ‰‹æœºæƒé™ã€‚ åˆ·å…¥Androidå…¶å®ƒç‰ˆæœ¬Androidå®˜æ–¹æä¾›äº†å¾ˆæ–¹ä¾¿çš„imageèµ„æºï¼Œå…¶ä¸­ Nexus factory imageåˆ—å‡ºäº†å¯ç”¨çš„æ‰€æœ‰Nexusé•œåƒï¼Œå¯»æ‰¾åˆ°é€‚åˆçš„é•œåƒè¿›è¡Œä¸‹è½½ï¼Œå»ºè®®éªŒè¯ä¸€ä¸‹MD5æ ¡éªŒç ã€‚ä¸‹è½½å®Œæ¯•åï¼Œå¯ä»¥æŒ‰ç…§å®˜ç½‘ä¸Šçš„æ•™ç¨‹åˆ·å…¥ç³»ç»Ÿï¼Œè¿‡ç¨‹æ¯”è¾ƒç®€å•ã€‚ æˆ‘åœ¨è¿™é‡Œåˆ·å…¥äº†Android 4.3 (JSS15Q)ç‰ˆæœ¬ï¼Œé™ä½äº†Nexusç³»ç»Ÿçš„ç‰ˆæœ¬ã€‚åˆ·æœºå®Œæ¯•åï¼Œå¯ä»¥é‡å¤ä¸Šé¢æ­¥éª¤ï¼Œåˆ·å…¥éœ€è¦çš„çš„å·¥å…·ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ç»•è¿‡æ¿€æ´»æ—¶ï¼Œ4.3ç‰ˆæœ¬å’Œ4.4ç‰ˆæœ¬ç•¥æœ‰ä¸åŒã€‚åœ¨4.3ç‰ˆæœ¬ä¸­ï¼Œå‰é¢æ­¥éª¤ç›¸åŒï¼Œæœ€åä¿®æ”¹build.propæ—¶ï¼Œåªè¦åŠ å…¥ro.setupwizard.mode=DISABLEDè¯¥é…ç½®å³å¯ç»•è¿‡æ¿€æ´»ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Android","slug":"Android","permalink":"http://itanch.github.io/tags/Android/"}]},{"title":"Ubuntu PPTPD é…ç½®","date":"2017-02-14T05:12:48.000Z","path":"2017/02/14/UbuntuPPTPDé…ç½®/","text":"Serveré…ç½®å®‰è£…pptpdé¦–å…ˆéœ€è¦å®‰è£…pptpdï¼Œubuntu é»˜è®¤å®‰è£…è¯¥å·¥å…·ã€‚ é…ç½®ç½‘ç»œç¼–è¾‘ /etc/pptpd.confï¼Œå–æ¶ˆä»¥ä¸‹ä¸¤è¡Œæ³¨é‡Šã€‚å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±è®¾å®šipåœ°å€èŒƒå›´ï¼Œè¿™é‡Œä½¿ç”¨é»˜è®¤çš„å°±å¯ä»¥ã€‚12localip 192.168.0.1remoteip 192.168.0.234-238,192.168.0.245 æ·»åŠ ç”¨æˆ·ç¼–è¾‘/etc/ppp/chap-secretsæ–‡ä»¶ï¼Œç”¨æˆ·åæ·»åŠ å¦‚ä¸‹ï¼š12345678 # Secrets for authentication using CHAP # client server secret IP addresses [client name] * &quot;[password]&quot; *``` å…¶ä¸­clientçš„åå­—å’Œå¯†ç è‡ªå·±è®¾å®šå³å¯ï¼Œå…¶å®ƒä¸¤é¡¹é»˜è®¤&quot;*&quot;å°±å¯ä»¥ã€‚### è®¾ç½®DNSç¼–è¾‘`/etc/ppp/pptpd-options`ï¼Œæ‰¾åˆ°`ms-dns`éƒ¨åˆ†ï¼Œå–æ¶ˆæ³¨é‡Šï¼š ms-dns 223.5.5.5 ms-dns 223.6.6.61234é»˜è®¤çš„æ˜¯googleçš„DNSæœåŠ¡ï¼Œ`8.8.8.8`ã€‚å› ä¸ºå›½å†…ä½¿ç”¨ä¸ä¾¿ï¼Œè¿™é‡Œæˆ‘ä¿®æ”¹æˆé˜¿é‡Œçš„DNSæœåŠ¡ã€‚### å¼€å¯IPè½¬å‘ç¼–è¾‘`/etc/sysctl.conf`æ–‡ä»¶ï¼Œå–æ¶ˆæ³¨é‡Šï¼š net.ipv4.ip_forward=11è¿è¡Œå‘½ä»¤ï¼Œä½¿é…ç½®ç”Ÿæ•ˆï¼š sysctl -p123### iptableså®‰è£…å®‰è£…iptables: apt-get install iptablesiptables -t nat -I POSTROUTING -j MASQUERADE #æ¯æ¬¡è¿è¡Œå‰éœ€è¦è¿è¡Œè¯¥å‘½ä»¤12### é‡å¯pptpd /etc/init.d/pptpd restart123456##Clienté…ç½®åœ¨ä½ éœ€è¦ä½¿ç”¨ä»£ç†çš„ubuntuè®¾å¤‡ä¸Šæ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶å®ƒå®¢æˆ·ç«¯ã€‚### å®‰è£…pptpä¸€èˆ¬ç³»ç»Ÿå·²ç»é»˜è®¤å®‰è£…ã€‚ sudo apt-get install pptp-linux12### åˆ›å»ºä¸€ä¸ªè¿æ¥ sudo pptpsetup â€“create [server name] â€“server [server ip] â€“username [client name] â€“password [password] â€“encrypt â€“start1æ‰§è¡Œå®Œä¸Šè¿°å‘½ä»¤åï¼Œä¼šåœ¨`/etc/ppp/chap-secrets`è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„ç”¨æˆ·ï¼š added by pptpsetup for pptpd[client name] [server name] â€œpasswordâ€ *1åœ¨`/etc/ppp/peers/pptpd`ä¸­ä¹Ÿä¼šæœ‰ç”Ÿæˆçš„ç›¸åº”ä¿¡æ¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œé»˜è®¤çš„æ˜¯ä¸ç”¨server çš„DNSé…ç½®çš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°ping ipåœ°å€å¯ä»¥æˆåŠŸï¼Œpingç½‘å€å´å¤±è´¥çš„DNSè§£æé”™è¯¯ï¼Œæ‰€ä»¥è¦åŠ ä¸Šå¦‚ä¸‹ä¸€è¡Œ: usepeerdns12345åœ¨ä¸Šè¿°å‘½ä»¤æˆåŠŸåï¼Œ`ifconfig`å‘½ä»¤ä¸‹å›å‡ºç°ppp0ç«¯å£ã€‚### è·¯ç”±è®¾ç½®å°†ppp0è®¾ç½®ä¸ºé»˜è®¤è·¯ç”±ç«¯å£ï¼š ip route del defaultip route add default dev ppp0123456è¿™æ ·é…ç½®åŸºæœ¬ç®—æˆåŠŸäº†ã€‚### æœåŠ¡å¼€å…³æˆ‘è‡ªå·±å†™äº†å¦‚ä¸‹å‘½ä»¤æ–¹ä¾¿å¼€å…³å’Œè·¯ç”±è®¾ç½®ï¼šæ‰“å¼€æœåŠ¡(éœ€è¦sudo): #!/bin/bashpon [server name]sleep 4ip route del defaultip route add default dev ppp01å…³é—­æœåŠ¡(sudo): #!/bin/bashpoff pptpdsleep 4ip route del defaultip route add default via [your old route ip] dev eno1```è¿™é‡Œéœ€è¦è®°ä½åŸæ¥è®¾å¤‡çš„è·¯ç”±ipï¼Œä»¥ä¾¿åˆ é™¤åå†å›å¤ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"ubuntu","slug":"ubuntu","permalink":"http://itanch.github.io/tags/ubuntu/"}]},{"title":"Cocos2d-x å®‰è£…","date":"2017-02-14T05:02:41.000Z","path":"2017/02/14/cocos2d-xå®‰è£…/","text":"hello cocos2d ç¯å¢ƒå®‰è£…ç¯å¢ƒï¼šMac OS Xè¿è¡Œç›®æ ‡ï¼šAndroidCocos2dç‰ˆæœ¬ï¼šcocos2d-x-3.13.1ï¼ŒCocos Console 2.1 Cocos2d-x å®‰è£…1. åŸºæœ¬å·¥å…·å®‰è£…Cocos2d-xï¼Œæœ€åŸºç¡€çš„æ˜¯å®‰è£…å‘½ä»¤è¡Œå·¥å…·ã€‚åœ¨å®‰è£…Cocosä¹‹å‰ï¼Œéœ€è¦ä¸€äº›å…¶å®ƒåŸºæœ¬å·¥å…·ï¼š JAVA SDK Android SDK Android NDK Apache Ant Python 2.7.5 è¿™äº›åŸºæœ¬å·¥å…·æœ€å¥½å·²ç»é…ç½®åœ¨ç¯å¢ƒå˜é‡ä¸­ã€‚ 2. Cocos2d-xä¸‹è½½æœ€æ–°çš„Cocos2d-xï¼Œç„¶åè§£å‹ã€‚æ‰¾åˆ°setup.pyï¼Œç„¶åè¿è¡Œ 1python setup.py ç„¶åå®ƒä¼šæé†’ä½ è¡¥è¶³ä¸€äº›ç¯å¢ƒå˜é‡çš„ç»å¯¹åœ°å€ï¼Œæœ€ååœ¨ä½ åŸæœ‰çš„Homeç›®å½•ä¸‹çš„.bash_profileåŸºç¡€ä¸Šå¢åŠ ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå¾ˆè´´å¿ƒã€‚ åœ¨æˆ‘çš„macä¸Šï¼Œè¡¥è¶³çš„ç¯å¢ƒå˜é‡å¦‚ä¸‹ï¼š123456789101112131415161718192021222324# Add environment variable COCOS_CONSOLE_ROOT for cocos2d-xexport COCOS_CONSOLE_ROOT=/Users/Tianchi/Tool/cocos2d-x-3.13.1/tools/cocos2d-console/binexport PATH=$COCOS_CONSOLE_ROOT:$PATH# Add environment variable COCOS_X_ROOT for cocos2d-xexport COCOS_X_ROOT=/Users/Tianchi/Toolexport PATH=$COCOS_X_ROOT:$PATH# Add environment variable COCOS_TEMPLATES_ROOT for cocos2d-xexport COCOS_TEMPLATES_ROOT=/Users/Tianchi/Tool/cocos2d-x-3.13.1/templatesexport PATH=$COCOS_TEMPLATES_ROOT:$PATH# Add environment variable NDK_ROOT for cocos2d-xexport NDK_ROOT=/Users/Tianchi/Tool/ndkexport PATH=$NDK_ROOT:$PATH# Add environment variable ANDROID_SDK_ROOT for cocos2d-xexport ANDROID_SDK_ROOT=/Users/Tianchi/Tool/sdkexport PATH=$ANDROID_SDK_ROOT:$PATHexport PATH=$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/platform-tools:$PATH# Add environment variable ANT_ROOT for cocos2d-xexport ANT_ROOT=/usr/local/apache-ant-1.9.4/binexport PATH=$ANT_ROOT:$PATH æ˜¯å¦å®‰è£…æˆåŠŸï¼š123$ cocos -vcocos2d-x-3.13.1Cocos Console 2.1 3. New Projectåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼š 1cocos new &lt;game name&gt; -p &lt;package identifier&gt; -l &lt;language&gt; -d &lt;location&gt; æ ·ä¾‹ï¼š12345cocos new MyGame -p com.MyCompany.MyGame -l cpp -d ~/MyCompanycocos new MyGame -p com.MyCompany.MyGame -l lua -d ~/MyCompanycocos new MyGame -p com.MyCompany.MyGame -l js -d ~/MyCompany ç¼–è¯‘é¡¹ç›®ï¼š 1cocos compile -s &lt;path to your project&gt; -p &lt;platform&gt; -m &lt;mode&gt; -o &lt;output directory&gt; æ ·ä¾‹ï¼š 12345cocos compile -s ~/MyCompany/MyGame -p ios -m release -o ~/MyCompany/MyGame/bincocos compile -s ~/MyCompany/MyGame -p android -m release -o ~/MyCompany/MyGame/bincocos compile -s c:\\MyCompany\\MyGame -p win32 -m release -o c:\\MyCompany\\MyGame\\bin ç¼–è¯‘Androidåº”ç”¨ï¼Œéœ€è¦æŒ‡å®šç›®æ ‡ç‰ˆæœ¬1cocos compile -p android --ap android-22 ç¼–è¯‘æˆåŠŸåï¼Œå°±ä¼šåœ¨é¡¹ç›®ç›®å½•ä¸‹çš„proj.android/binä¸‹å‘ç°apkæ–‡ä»¶ï¼Œå¯ä»¥è¿›è¡Œå®‰è£…ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"Cocos2d-x","slug":"Cocos2d-x","permalink":"http://itanch.github.io/tags/Cocos2d-x/"}]},{"title":"AngularJS--SB Admin","date":"2016-01-15T02:56:03.000Z","path":"2016/01/15/AngularJSå­¦ä¹ /","text":"ä»SB Adminå¼€å§‹å­¦ä¹ AngularJS! SB Admin v2.0 rewritten in AngularJSæ˜¯ä¸€ä¸ªSB Adminçš„AngularJSçš„å®ç°ï¼Œæºä»£ç ã€å®‰è£…å’Œè¿è¡Œå¯ä»¥å‚è€ƒä»¥ä¸Šé“¾æ¥ã€‚ ä¸€äº›å·¥å…·Nodejså‡çº§ï¼š1234$ sudo npm cache clean -f$ sudo npm install -g n$ sudo n stable$ sudo ln -sf /usr/local/n/versions/node/&lt;VERSION&gt;/bin/node /usr/bin/node npmå‡çº§ï¼š123456789101112131415$ sudo npm install --global npm@latest``` [Bower](http://bower.io/)æ˜¯ä¸€ä¸ªå¯¹webå¼€å‘è¿›è¡ŒåŒ…ç®¡ç†çš„å·¥å…·ã€‚ [GRUNT](http://www.gruntjs.net/)çš„ç›®çš„å°±æ˜¯è‡ªåŠ¨åŒ–ã€‚å¯¹äºéœ€è¦åå¤é‡å¤çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å‹ç¼©ï¼ˆminificationï¼‰ã€ç¼–è¯‘ã€å•å…ƒæµ‹è¯•ã€lintingç­‰ï¼Œè‡ªåŠ¨åŒ–å·¥å…·å¯ä»¥å‡è½»ä½ çš„åŠ³åŠ¨ï¼Œç®€åŒ–ä½ çš„å·¥ä½œã€‚å½“ä½ åœ¨ Gruntfile æ–‡ä»¶æ­£ç¡®é…ç½®å¥½äº†ä»»åŠ¡ï¼Œä»»åŠ¡è¿è¡Œå™¨å°±ä¼šè‡ªåŠ¨å¸®ä½ æˆ–ä½ çš„å°ç»„å®Œæˆå¤§éƒ¨åˆ†æ— èŠçš„å·¥ä½œã€‚ [Yeoman](http://yeoman.io/)ç”Ÿæˆwebåº”ç”¨çš„åŸºæœ¬æ¶æ„ã€‚&lt;!--more--&gt;## Yeomanå…¥é—¨![yeoman](http://7xky03.com1.z0.glb.clouddn.com/yeoman.png) ### 1. å®‰è£…Bowerã€GRUNTå’ŒYeomanï¼š ```sh$ sudo npm install --global yo bower grunt-cli 2. å®‰è£…generator123456$ sudo npm install --global generator-karma generator-angular``` ### 3. è¿è¡Œgenerator```sh$ yo angular 4. Yeomanæ€»ç»“Yeomanç¡®å®æ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„webåº”ç”¨æ¶æ„å·¥å…·ï¼Œä»–å¯ä»¥å¸®ä½ å®Œæˆå¤§éƒ¨åˆ†ç¹ççš„å·¥ä½œï¼Œä»è€Œä½ å¯ä»¥æ›´ä¸“å¿ƒçš„å®ç°ä½ çš„åŠŸèƒ½ã€‚ æºä»£ç åˆ†æ1. index.htmlä½äºapp/ç›®å½•ä¸‹çš„index.htmlæ˜¯æ•´ä¸ªç½‘é¡µçš„ä¸»è¦å…¥å£ã€‚123&lt;div ng-app=\"sbAdminApp\"&gt; &lt;div ui-view&gt;&lt;/div&gt;&lt;/div&gt; 2. app.jsä½äºapp/scripts/ç›®å½•ä¸‹ï¼Œåº”ç”¨çš„ä¸»è¦moduleã€‚ moduleé¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°sbAdminAppä½¿ç”¨äº†å¦‚ä¸‹moduleï¼š oc.lazyLoadï¼šè‡ªåŠ¨çš„åŠ è½½ä¸€äº›moduleã€‚ ui.routerï¼šAngularUI Routeræ˜¯ä¸€ä¸ªè·¯ç”±æ¡†æ¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒå°†åº”ç”¨æ¥å£ç»„ç»‡æˆä¸ºä¸€ä¸ªæœ‰ç©·çŠ¶æ€æœºï¼Œä¸åŒäºAngularè‡ªå¸¦çš„$routeï¼ˆæ ¹æ®URLè¿›è¡Œè·¯ç”±ï¼‰ï¼ŒUI-Routeråˆ™æ˜¯æ ¹æ®çŠ¶æ€è¿›è¡Œè·¯ç”±ã€‚ ui.bootstrapï¼šç”¨AngularJSå¼€å‘çš„Bootstrapç»„ä»¶ã€‚ configstateProviderï¼šç”±ui.routeræä¾›ï¼ŒåŠŸèƒ½ç±»ä¼¼äºAngular v1çš„routerï¼Œä½†æ˜¯å®ƒåªä¸“æ³¨äºstateã€‚stateå°±æ˜¯åº”ç”¨ä¸­çš„æŸä¸€ä¸ªçŠ¶æ€ï¼Œåˆ°è¾¾æŸä¸€ä¸ªçŠ¶æ€æ—¶ï¼Œä¼šå°†templateæ’å…¥åˆ°ç›¸åº”ä½ç½®ã€‚è¯¥éƒ¨åˆ†çš„ä¸»è¦å·¥ä½œæ˜¯å°†stateã€htmlå’Œcontrollerå¯¹åº”èµ·æ¥ã€‚ resolveå¯ä»¥æä¾›ç»™controllerä¸€äº›å®šåˆ¶çš„å†…å®¹ï¼Œé‡‡ç”¨key:valueçš„æ ¼å¼ã€‚åœ¨è¿™é‡Œï¼Œä½¿ç”¨ocLazyLoadåŠ è½½äº†ä¸€äº›æ¨¡å—ã€‚ é¦–å…ˆåŠ è½½çš„æ˜¯sbAdminAppæ¨¡å—ä¸­çš„headeréƒ¨åˆ†ï¼Œç„¶åä¾æ¬¡ä¸ºheader-notificationã€sidebarå’Œsidebar-searchã€‚è¿™äº›éƒ¨åˆ†åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨äº†module.directiveå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥å¯¹æŒ‡å®šçš„å…ƒç´ é™„åŠ ä¸€äº›è¡Œä¸ºï¼Œå¦‚ï¼š angular.module('sbAdminApp') .directive('header',function(){ return { templateUrl:'scripts/directives/header/header.html', restrict: 'E', replace: true, } }); è¿™é‡Œå°±æ˜¯åœ¨main.htmlçš„&lt;header&gt;&lt;/header&gt;å…ƒç´ æ›¿æ¢ä¸ºheader.htmlçš„å†…å®¹ã€‚ ä»æºä»£ç ä¸­ä¸éš¾å‘ç°ï¼Œheaderã€header-notificationã€sidebarå’Œsidebar-searchæ–‡ä»¶çš„åŠ è½½æ˜¯æŒ‰ç…§ä¸€å®šçš„é¡ºåºçš„ï¼Œå› ä¸ºå‰åé¡ºåºåœ¨Viewä¸­è¡¨ç°ä¸ºåµŒå¥—çš„çˆ¶å­å…³ç³»ã€‚ ç„¶åï¼ŒåŠ è½½äº†toggle-switchï¼Œä¸€ä¸ªå¼€å…³æ¨¡å—ï¼›ngAnimateï¼ŒåŠ¨ç”»æ•ˆæœï¼›ngCookiesï¼Œè¯»å†™æµè§ˆå™¨cookiesï¼›ngResourceï¼ŒåŠ è½½èµ„æºå¯¹è±¡ï¼›ngSanitizeï¼Œå¯ä»¥å¯¹HTMLè¿›è¡Œæ¸…æ´ï¼›ngTouchï¼Œå¯¹å¯è§¦æ‘¸è®¾å¤‡æä¾›æœåŠ¡ã€‚ å…¶å®ƒstateç±»ä¼¼ã€‚ ocLazyLoadProviderï¼šæ¥è‡ªäºoc.lazyLoadï¼Œevents:trueå¯ä»¥ä½¿å¾—åŠ è½½moduleæ—¶å¯ä»¥å‘é€å¹¿æ’­ã€‚ urlRouterProviderï¼šç”±ui.routeræä¾›ï¼Œåœ¨è¿™é‡Œåªæ˜¯ç”¨å®ƒæ¥å¤„ç†å…¶å®ƒçŠ¶æ€ä¸‹çš„æƒ…å†µï¼Œç»Ÿä¸€é‡å®šå‘è‡³/dashboard/homeã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"AngularJS","slug":"AngularJS","permalink":"http://itanch.github.io/tags/AngularJS/"},{"name":"Yeoman","slug":"Yeoman","permalink":"http://itanch.github.io/tags/Yeoman/"},{"name":"JavaScript","slug":"JavaScript","permalink":"http://itanch.github.io/tags/JavaScript/"}]},{"title":"MESOS and MARATHONå®‰è£…","date":"2015-11-16T01:40:40.000Z","path":"2015/11/16/MESOSå®‰è£…/","text":"åŸºæœ¬ç¯å¢ƒç³»ç»Ÿç¯å¢ƒï¼šubuntu14.04mesos: 0.25.0 ä»æºä»£ç å®‰è£…æ ¹æ®å®˜ç½‘Getting Startedä»‹ç»ï¼Œå°è¯•ä»æºä»£ç ç¼–è¯‘å®‰è£…ï¼Œä½†æœªæˆåŠŸã€‚åœ¨make checkå‘½ä»¤æ‰§è¡Œæ—¶å‡ºç°ä¸€ä¸ªé”™è¯¯ï¼Œç»è¿‡åˆ†æç»ˆäºå‘ç°åŸå› åœ¨äºæµ‹è¯•ä¸­ä¼šé€šè¿‡å­—ç¬¦ä¸²æ¯”è¾ƒéªŒè¯ç»“æœï¼Œç”±äºæˆ‘çš„ç³»ç»Ÿæ˜¯ä¸­æ–‡ç³»ç»Ÿï¼Œæµ‹è¯•ä¸­é¢„æƒ³çš„ç»“æœæ˜¯è‹±æ–‡çš„ï¼Œæ‰€ä»¥å°±å¯¼è‡´é”™è¯¯ã€‚æœ€åï¼Œéœ€è¦èƒ½å¤Ÿè®¿é—®code.google.comæ‰èƒ½è¿›è¡Œmake installã€‚ ä»æºä»£ç å®‰è£…æ—¶ä¼šå®‰è£…ä¸€äº›ä¾èµ–åº“ï¼ŒåŒæ—¶ä¼šå®‰è£…openjdkã€‚ apt-getæ ¹æ®mesosphereä»‹ç»ï¼Œå¯ä»¥å®‰è£…ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå®‰è£…ï¼š æ·»åŠ åº“ 123456$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E56151BF$ DISTRO=$(lsb_release -is | tr '[:upper:]' '[:lower:]')$ CODENAME=$(lsb_release -cs)$ echo \"deb http://repos.mesosphere.com/$&#123;DISTRO&#125; $&#123;CODENAME&#125; main\" | \\ sudo tee /etc/apt/sources.list.d/mesosphere.list$ sudo apt-get -y update å®‰è£… 1$ sudo apt-get -y install mesos å¯åŠ¨master 1$ sudo mesos-master --ip=127.0.0.1 --work_dir=/var/lib/mesos å¯åŠ¨slave 1$ mesos-slave --master=127.0.0.1:5050 ä»æµè§ˆå™¨è§‚å¯Ÿç»“æœhttp://127.0.0.1:5050ã€‚ MARATHONå®‰è£…MARATHONä¾èµ–äºJava 8ã€‚å‚è€ƒ(mesosphere)[https://mesosphere.com/downloads/]çš„å†…å®¹ï¼Œå®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š æ·»åŠ å¿…è¦çš„åº“ 123456$ sudo apt-get update -y$ sudo DEBIAN_FRONTEND=noninteractive apt-get install -y python-software-properties software-properties-common$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E56151BF$ DISTRO=$(lsb_release -is | tr '[:upper:]' '[:lower:]')$ CODENAME=$(lsb_release -cs)$ sudo echo \"deb http://repos.mesosphere.io/$&#123;DISTRO&#125; $&#123;CODENAME&#125; main\" | tee /etc/apt/sources.list.d/mesosphere.list å®‰è£…Java 8 1234$ sudo add-apt-repository ppa:webupd8team/java$ sudo apt-get update -y$ sudo apt-get install -y oracle-java8-installer oracle-java8-set-default$ sudo apt-get -y install marathon è¿è¡ŒMARATHON 1$ marathon --master zk://127.0.0.1:2181,127.0.0.1:2181/mesos --zk zk://127.0.0.1:2181,127.0.0.1:2181/marathon ä»æµè§ˆå™¨è§‚å¯Ÿç»“æœhttp://127.0.0.1:8080 MESOSçš„ä¸€äº›å‘½ä»¤To (start | stop | restart) mesos-master:123456sudo service mesos-master (start | stop | restart)``` To (start | stop | restart) mesos-slave:```shsudo service mesos-slave (start | stop | restart) If you want to disable these service from launching automatically on a reboot:123echo manual &gt; /etc/init/mesos-master.overrideecho manual &gt; /etc/init/mesos-slave.overrideecho manual &gt; /etc/init/zookeeper.override","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"MESOS","slug":"MESOS","permalink":"http://itanch.github.io/tags/MESOS/"},{"name":"ubuntu","slug":"ubuntu","permalink":"http://itanch.github.io/tags/ubuntu/"}]},{"title":"MooseFSå®‰è£…","date":"2015-09-22T08:21:51.000Z","path":"2015/09/22/MooseFSå®‰è£…/","text":"MooseFS is a Fault tolerant, Highly available, Highly performing, Scaling-out, Network distributed file system. It spreads data over several physical commodity servers, which are visible to the user as one resource. For standard file operations MooseFS acts like any other Unix-like file system: 1.A hierarchical structure (directory tree) 2.Stores POSIX file attributes (permissions, last access and modification times) 3.Supports special files (block and character devices, pipes and sockets) 4.Symbolic links (file names pointing to target files, not necessarily on MooseFS) and hard links (different names of files which refer to the same data on MooseFS) 5.Access to the file system can be limited based on IP address and/or password åŸºæœ¬ä¿¡æ¯å®éªŒç¯å¢ƒï¼šä¸¤ä¸ªUbuntu14.04è®¡ç®—æœºã€‚MooseFSç‰ˆæœ¬ï¼š2.0.76ã€‚ MooseFSå®˜ç½‘1ï¼Œå®˜ç½‘2ã€‚æ®è§‚å¯Ÿï¼Œå®˜ç½‘2å†…å®¹è¾ƒæ–°ã€‚ å‚è€ƒ1ï¼Œå‚è€ƒ2ã€‚ å®‰è£…master(åœ¨é€‰å®šçš„masterèŠ‚ç‚¹ä¸Šæ“ä½œ)æ·»åŠ key:123456$ wget -O - http://ppa.moosefs.com/moosefs.key | sudo apt-key add -``` åœ¨æ–‡ä»¶`/etc/apt/sources.list.d/moosefs.list`ä¸­æ·»åŠ å¦‚ä¸‹è½¯ä»¶æºï¼š ```shdeb http://ppa.moosefs.com/stable/apt/ubuntu/trusty trusty main æ›´æ–°è½¯ä»¶æºï¼Œå®‰è£…masterï¼š12$ sudo apt-get update$ sudo apt-get install moosefs-master æ‹·è´/etc/mfsä¸‹çš„å¦‚ä¸‹æ–‡ä»¶ï¼Œå¯ä»¥æŒ‰éœ€ä¿®æ”¹å…¶ä¸­çš„å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤å€¼ï¼š12$ cp mfsmaster.cfg.dist mfsmaster.cfg$ cp mfsexports.cfg.dist mfsexports.cfg å¯åŠ¨ï¼š1234567891011121314$ sudo mfsmaster start``` å¯ä»¥ä¿®æ”¹`/etc/default/moosefs-ce-master`ä¸­çš„`MFSMASTER_ENABLE`ä¸º`true`ï¼Œä½¿å¾—è¯¥æœåŠ¡å¼€æœºå¯åŠ¨ã€‚### å®‰è£…å…¶å®ƒå·¥å…· ```sh$ sudo apt-get install moosefs-cgi$ sudo apt-get install moosefs-cgiserv$ sudo apt-get install moosefs-cli``` å¯åŠ¨mfscgiservï¼Œå¯ä»¥åœ¨æµè§ˆå™¨è§‚å¯Ÿmfsè¿è¡Œæƒ…å†µã€‚å¦‚æœæœ¬æœºä¸ºmasterï¼Œå¯ä»¥è®¿é—®[http://127.0.0.1:9425](http://127.0.0.1:9425)ã€‚```sh$ sudo mfscgiserv start å®‰è£…chunkserver(åœ¨é€‰å®šçš„chunkèŠ‚ç‚¹ä¸Šæ“ä½œ)é¦–å…ˆåƒå®‰è£…masterä¸€æ ·æ·»åŠ è½¯ä»¶æºï¼Œç„¶åå®‰è£…ï¼š1234567$ sudo apt-get install moosefs-chunkserver``` åŒæ ·ï¼Œä¿®æ”¹`/etc/mfs`æ–‡ä»¶ä¸‹çš„å¦‚ä¸‹æ–‡ä»¶ï¼š ```sh$ sudo cp mfschunkserver.cfg.dist mfschunkserver.cfg$ sudo cp mfshdd.cfg.dist mfshdd.cfg å…¶ä¸­ï¼Œmfschunkserver.cfgæ–‡ä»¶çš„å‚æ•°MASTER_HOST = mfsmasterå¯ä»¥æŒ‡å®šmasterçš„hostnameï¼Œè¿™é‡Œéœ€è¦åœ¨/etc/hostsä¸­å†™æ˜ï¼Œå¹¶ä¸”å¦‚æœmasterä¹Ÿä½œä¸ºchunkserveræ—¶ï¼Œhostsä¸­mfsmasterçš„ipä¸èƒ½ä½¿ç”¨127.0.0.1ã€‚ å»ºç«‹æ–‡ä»¶,æ–‡ä»¶åå­—å¯ä»¥å†™è‡ªå·±å–œæ¬¢çš„ï¼Œè¿™é‡Œå–åmfschunkï¼š12$ mkdir -p /mnt/mfschunk$ chown -R mfs:mfs /mnt/mfschunk åœ¨mfshdd.cfgæ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œ/mnt/mfschunkã€‚å¯åŠ¨mfschunkserver:1$ sudo mfschunkserver start å®‰è£…å®¢æˆ·ç«¯å®‰è£…å®¢æˆ·ç«¯ï¼Œæ·»åŠ æŒ‚è½½ç‚¹ï¼Œè¿›è¡ŒæŒ‚è½½ã€‚mfsmasteråœ¨è¿™é‡Œä¸ºmasterçš„hostnameã€‚123$ sudo apt-get install moosefs-client$ sudo mkdir -p /mnt/mfs$ sudo mfsmount mfs -H mfsmaster æŸ¥çœ‹ï¼š12$ df -hmfsmaster:9421 1.3T 70G 1.2T 6% /mnt/mfs","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"ubuntu","slug":"ubuntu","permalink":"http://itanch.github.io/tags/ubuntu/"},{"name":"MooseFS","slug":"MooseFS","permalink":"http://itanch.github.io/tags/MooseFS/"}]},{"title":"slurmå®‰è£…","date":"2015-09-10T09:17:44.000Z","path":"2015/09/10/slurmå®‰è£…/","text":"è¯´æ˜ Slurm is an open-source workload manager designed for Linux clusters of all sizes. It provides three key functions. First it allocates exclusive and/or non-exclusive access to resources (computer nodes) to users for some duration of time so they can perform work. Second, it provides a framework for starting, executing, and monitoring work (typically a parallel job) on a set of allocated nodes. Finally, it arbitrates contention for resources by managing a queue of pending work. ç³»ç»Ÿï¼šubuntu 14.04ã€‚slurmç‰ˆæœ¬2.6.5ã€‚èŠ‚ç‚¹ï¼š2ä¸ªç‹¬ç«‹çš„ubuntu14.04è®¡ç®—æœºã€‚ å®‰è£…åœ¨ubuntuä¸­ï¼Œæœ€ç®€å•çš„å®‰è£…æ–¹æ³•æ˜¯ä½¿ç”¨apt-getï¼Œç›®å‰è‡ªåŠ¨å®‰è£…çš„slurmç‰ˆæœ¬ä¸º2.6.5ï¼Œå¹¶ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚1$ sudo apt-get install slurm-llnl å®‰è£…slurmçš„åŒæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè›‹ç–¼çš„slurmç”¨æˆ·ï¼Œä½†æ˜¯è¿™ä¸ªç”¨æˆ·æ²¡æœ‰homeæ–‡ä»¶ï¼Œæ‰€ä»¥æ— æ³•åˆ‡æ¢åˆ°è¯¥ç”¨æˆ·ä¸‹è¿›è¡Œå·¥ä½œã€‚æˆ‘çš„å»ºè®®æ˜¯åˆ é™¤æ—§çš„slurmç”¨æˆ·ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†mungeçš„æ­£ç¡®è¿è¡Œåšå‡†å¤‡ã€‚1$ sudo deluser slurm ä½¿ç”¨slurmï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹å¿…é¡»åœ¨ç›¸åŒçš„ç”¨æˆ·ä¸‹å·¥ä½œï¼Œå»ºè®®æ–°å»ºä¸€ä¸ªslurmç”¨æˆ·ï¼Œå¿…é¡»æŒ‡å®šUIDï¼Œä¿è¯æ‰€æœ‰èŠ‚ç‚¹slurmç”¨æˆ·çš„UIDä¹Ÿç›¸åŒï¼š1$ sudo adduser --uid &lt;ID&gt; &lt;new name&gt; Mungeåœ¨å®‰è£…slurmçš„åŒæ—¶ï¼Œä¹Ÿä¼šå®‰è£…mungeã€‚ MUNGE (MUNGE Uid â€˜Nâ€™ Gid Emporium) is an authentication service for creating and validating credentials. It is designed to be highly scalable for use in an HPC cluster environment. It allows a process to authenticate the UID and GID of another local or remote process within a group of hosts having common users and groups. These hosts form a security realm that is defined by a shared cryptographic key. Clients within this security realm can create and validate credentials without the use of root privileges, reserved ports, or platform-specific methods. 1.ç”Ÿæˆkeyé¦–å…ˆç”Ÿæˆkeyï¼Œè‡ªåŠ¨ç”Ÿæˆè‡³/ete/munge/munge.keyï¼š1$ create-munge-key 2.éƒ¨ç½²å°†keyæ‹·è´è‡³æ‰€æœ‰èŠ‚ç‚¹ã€‚æ‹·è´/etc/munge/munge.keyåˆ°æ‰€æœ‰èŠ‚ç‚¹çš„/etc/munge/ç›®å½•ä¸‹ã€‚ 3.å¯åŠ¨å¯åŠ¨mungeã€‚1$ sudo /etc/init.d/munge start å‡ºç°é”™è¯¯ï¼š12* Starting MUNGE munged [fail]munged: Error: Logfile is insecure: group-writable permissions set on \"/var/log\" å‡ºç°ä¸Šè¿°é”™è¯¯éœ€è¦ä¿®æ”¹logæ–‡ä»¶æƒé™ï¼š1$ sudo chmod g-w /var/log å‡ºç°é”™è¯¯ï¼š12* Starting MUNGE munged [fail]munged: Error: Logfile is insecure: invalid ownership of \"/var/log/munge\" é¦–å…ˆå°è¯•ä½¿ç”¨sudoå¯åŠ¨ï¼Œè‹¥ä¸æˆåŠŸï¼Œåˆ™å‚è€ƒå¦‚ä¸‹ã€‚mungeå®‰è£…çš„æ‰€æœ‰æ–‡ä»¶ï¼Œé»˜è®¤ç”¨æˆ·ä¸ºmunge:mungeï¼Œå½“å‰ç”¨æˆ·å¦‚æœä¸æ˜¯mungeï¼Œå¯åŠ¨å‡ºç°é”™è¯¯ï¼šéœ€è¦ä¿®æ”¹å¦‚ä¸‹æ–‡ä»¶çš„ç”¨æˆ·ï¼š/etc/munge//var/lib/munge//var/log/munge//var/run/munge/ä¿®æ”¹æ–‡ä»¶ç”¨æˆ·çš„å‘½ä»¤ï¼š1$ sudo chown -R &lt;user&gt;:&lt;group&gt; &lt;dir&gt; ä¿®æ”¹/ete/init.d/mungeï¼Œå°†USERå˜é‡ä¿®æ”¹ä¸ºä½ çš„ç”¨æˆ·åã€‚ 4.éªŒè¯åœ¨slurmç”¨æˆ·ä¸‹éªŒè¯æœ¬æœºï¼š123456789101112$ munge -n | unmungeSTATUS: Success (0)ENCODE_HOST: localhost (127.0.0.1)ENCODE_TIME: 2015-09-14 16:39:58 +0800 (1442219998)DECODE_TIME: 2015-09-14 16:39:58 +0800 (1442219998)TTL: 300CIPHER: aes128 (4)MAC: sha1 (3)ZIP: none (0)UID: slurm (1023)GID: slurm (1023)LENGTH: 0 éªŒè¯å…¶å®ƒèŠ‚ç‚¹ï¼š123456789101112$ munge -n | ssh node01 unmungeSTATUS: Success (0)ENCODE_HOST: localhost (127.0.0.1)ENCODE_TIME: 2015-09-14 16:40:09 +0800 (1442220009)DECODE_TIME: 2015-09-14 16:39:49 +0800 (1442219989)TTL: 300CIPHER: aes128 (4)MAC: sha1 (3)ZIP: none (0)UID: slurm (1023)GID: slurm (1023)LENGTH: 0 æ³¨æ„ï¼mungeè‡ªåŠ¨è®¤è¯çš„æ˜¯ç›¸åŒçš„ç”¨æˆ·ï¼Œå³UIDå’ŒGIDç›¸åŒï¼Œå¹¶ä¸æ˜¯æŒ‰ç…§ç”¨æˆ·åç§°æ¥åŒ¹é…ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºslurmç”¨æˆ·æ—¶å¿…é¡»æŒ‡å®šç›¸åŒçš„UIDå’ŒGIDã€‚ slurmé…ç½®æ–‡ä»¶åœ¨å®‰è£…æ–‡ä»¶ä¸­æœ‰é…ç½®å·¥å…·ï¼šslurm-xxx/doc/html/configurator.html.inå¦‚æœä½¿ç”¨apt-getå®‰è£…ï¼Œåˆ™éœ€è¦æ ¹æ®è‡ªå·±slurmçš„ç‰ˆæœ¬ä¿¡æ¯ä¸‹è½½ç›¸åº”çš„taræ–‡ä»¶ï¼Œè§£å‹åä½¿ç”¨ï¼Œslurmæ‰€æœ‰ç‰ˆæœ¬ã€‚ é…ç½®æ–‡ä»¶æ ·ä¾‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162# slurm.conf file generated by configurator.html.# Put this file on all nodes of your cluster.# See the slurm.conf man page for more information.#ControlMachine=node00#ControlAddr=#BackupController=#BackupAddr=#AuthType=auth/mungeCacheGroups=0#CheckpointType=checkpoint/noneCryptoType=crypto/munge#DisableRootJobs=NO#EnforcePartLimits=NO#Epilog=#EpilogSlurmctld=#FirstJobId=1#MaxJobId=999999#GresTypes=#GroupUpdateForce=0#GroupUpdateTime=600#JobCheckpointDir=/var/slurm/checkpoint#JobCredentialPrivateKey=#JobCredentialPublicCertificate=#JobFileAppend=0#JobRequeue=1#JobSubmitPlugins=1#KillOnBadExit=0#LaunchType=launch/slurm#Licenses=foo*4,bar#MailProg=/bin/mail#MaxJobCount=5000#MaxStepCount=40000#MaxTasksPerNode=128MpiDefault=none#MpiParams=ports=#-##PluginDir=#PlugStackConfig=#PrivateData=jobsProctrackType=proctrack/pgid#Prolog=#PrologSlurmctld=#PropagatePrioProcess=0#PropagateResourceLimits=#PropagateResourceLimitsExcept=#RebootProgram=ReturnToService=1#SallocDefaultCommand=SlurmctldPidFile=/var/run/slurmctld.pidSlurmctldPort=6817SlurmdPidFile=/var/run/slurmd.pidSlurmdPort=6818SlurmdSpoolDir=/home/slurm/SlurmSlurmUser=slurm#SlurmdUser=root#SrunEpilog=#SrunProlog=StateSaveLocation=/home/slurm/Slurm/outSwitchType=switch/none#TaskEpilog=TaskPlugin=task/none#TaskPluginParam=#TaskProlog=#TopologyPlugin=topology/tree#TmpFS=/tmp#TrackWCKey=no#TreeWidth=#UnkillableStepProgram=#UsePAM=0### TIMERS#BatchStartTimeout=10#CompleteWait=0#EpilogMsgTime=2000#GetEnvTimeout=2#HealthCheckInterval=0#HealthCheckProgram=InactiveLimit=30KillWait=30#MessageTimeout=10#ResvOverRun=0MinJobAge=300#OverTimeLimit=0SlurmctldTimeout=120SlurmdTimeout=300#UnkillableStepTimeout=60#VSizeFactor=0Waittime=300### SCHEDULING#DefMemPerCPU=0FastSchedule=1#MaxMemPerCPU=0#SchedulerRootFilter=1#SchedulerTimeSlice=30SchedulerType=sched/backfillSchedulerPort=7321SelectType=select/linear#SelectTypeParameters=### JOB PRIORITY#PriorityFlags=#PriorityType=priority/basic#PriorityDecayHalfLife=#PriorityCalcPeriod=#PriorityFavorSmall=#PriorityMaxAge=#PriorityUsageResetPeriod=#PriorityWeightAge=#PriorityWeightFairshare=#PriorityWeightJobSize=#PriorityWeightPartition=#PriorityWeightQOS=### LOGGING AND ACCOUNTING#AccountingStorageEnforce=0#AccountingStorageHost=#AccountingStorageLoc=#AccountingStoragePass=#AccountingStoragePort=AccountingStorageType=accounting_storage/none#AccountingStorageUser=AccountingStoreJobComment=YESClusterName=cluster#DebugFlags=#JobCompHost=#JobCompLoc=#JobCompPass=#JobCompPort=JobCompType=jobcomp/none#JobCompUser=JobAcctGatherFrequency=30JobAcctGatherType=jobacct_gather/noneSlurmctldDebug=3#SlurmctldLogFile=SlurmdDebug=3#SlurmdLogFile=#SlurmSchedLogFile=#SlurmSchedLogLevel=### POWER SAVE SUPPORT FOR IDLE NODES (optional)#SuspendProgram=#ResumeProgram=#SuspendTimeout=#ResumeTimeout=#ResumeRate=#SuspendExcNodes=#SuspendExcParts=#SuspendRate=#SuspendTime=### COMPUTE NODESNodeName=node01 CPUs=1 State=UNKNOWNNodeName=node00 CPUs=1 State=UNKNOWNPartitionName=debug Nodes=node00,node01 Default=YES MaxTime=INFINITE State=UP å°†è¯¥é…ç½®æ–‡ä»¶æ‹·è´è‡³æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ”¾ç½®äº/etc/slurm-llnl/slurm.confä¸­ã€‚ å¯åŠ¨å’Œæµ‹è¯•slurmåˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸­å¯åŠ¨ï¼š1$ sudo /ete/init.d/slurm-llnl start æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼š1$ sinfo æµ‹è¯•è„šæœ¬testï¼š12345678910#!/bin/bash#SBATCH -A &lt;account&gt;#SBATCH -D /home/slurm/Slurm#SBATCH -I#SBATCH --time=00:30:00#SBATCH --error=job.%J.err#SBATCH --output=job.%J.outecho \"hello world!\"./hello.sh è¿è¡Œæµ‹è¯•è„šæœ¬:1$ sbatch test å½“æŸä¸€ä¸ªjobå› ä¸ºæŸäº›I/OåŸå› é˜»å¡ä»¥åï¼Œä¼šå¯¼è‡´æŸä¸ªèŠ‚ç‚¹ä¸€ç›´å¤„äºcompçŠ¶æ€ï¼Œé‡å¯è¯¥èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š12$ scontrol update NodeName=OptiPlex State=DOWN Reason=hung_completing$ scontrol update NodeName=OptiPlex State=RESUME","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"ubuntu","slug":"ubuntu","permalink":"http://itanch.github.io/tags/ubuntu/"},{"name":"slurm","slug":"slurm","permalink":"http://itanch.github.io/tags/slurm/"}]},{"title":"è±†ç“£ç”µå½±Top250è·å–","date":"2015-08-29T12:53:09.000Z","path":"2015/08/29/è±†ç“£ç”µå½±Top250è·å–/","text":"è±†ç“£APIè¯´æ˜è±†ç“£ä¸ºå¼€å‘è€…æä¾›äº†ç”¨äºåº”ç”¨å¼€å‘çš„Apiæ¥å£ï¼Œé€šè¿‡è¿™äº›Apiæ¥å£å¯ä»¥è·å¾—è±†ç“£çš„éƒ¨åˆ†å†…å®¹ã€‚ è±†ç“£Api V2è®¤è¯ä½¿ç”¨äº†OAuth2ï¼Œä½¿å¾—ç”¨æˆ·çš„æˆæƒè¿‡ç¨‹æ›´ä¸ºå®‰å…¨ï¼Œè¿”å›æ•°æ®çš„æ ¼å¼ä¸ºjsonï¼Œä¾¿äºåº”ç”¨å¼€å‘è€…è§£æè·å¾—çš„æ•°æ®ã€‚è±†ç“£æ²¡æœ‰æä¾›å®˜æ–¹çš„SDKï¼Œä½†æ˜¯æä¾›äº†å…¶ä»–éå®˜æ–¹çš„åŸºäºå¤šç§è¯­è¨€çš„SDKï¼Œæˆ‘ä»¬é‡‡ç”¨äº†Javaè¯­è¨€çš„SDKã€‚ç”±äºè¯¥ç‰ˆæœ¬çš„Java SDKåŸºäºè¾ƒæ—©çš„è±†ç“£APIçš„v1ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œéƒ¨åˆ†ä¿®æ”¹é€‚åº”æ–°çš„v2ç‰ˆæœ¬ï¼Œå…¶ä¸­æˆ‘ä»¬ä¿®æ”¹äº†ç”µå½±ç›¸å…³çš„ä»£ç (æ–°çš„æºä»£ç )ã€‚ Java SDKä¸ºMavenå·¥ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨Mavenç¼–è¯‘æ‰“åŒ…ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273mvn package -Dmaven.test.skip=true``` ä¸ºäº†å°†æ‰€æœ‰ä¾èµ–ä¸€èµ·æ‰“åŒ…è¿›å»ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†fatjarå·¥å…·è¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆå¯ä»¥è°ƒç”¨çš„å‡½æ•°åº“([jar](https://github.com/ITanCh/Douban-Java-SDK-OAuth2/raw/origin/Douban-Java-SDK-OAuth2-origin_fat.jar))ã€‚&lt;!--more--&gt;### APIä½¿ç”¨#### ç›¸å…³åº“```javaimport com.dongxuexidu.douban4j.model.app.AccessToken;import com.dongxuexidu.douban4j.model.app.DoubanException;import com.dongxuexidu.douban4j.model.app.RequestGrantScope;import com.dongxuexidu.douban4j.model.v2.DoubanCastObject;import com.dongxuexidu.douban4j.model.v2.DoubanDirectorObj;import com.dongxuexidu.douban4j.model.v2.DoubanSubjectListObj;import com.dongxuexidu.douban4j.model.v2.DoubanSubjectObj;import com.dongxuexidu.douban4j.playground.BrowserLauncher;import com.dongxuexidu.douban4j.playground.PlayGround;import com.dongxuexidu.douban4j.provider.OAuthDoubanProvider;import com.dongxuexidu.douban4j.service.DoubanBookMovieMusicService;``` #### AccessTokenè·å– é€šè¿‡è±†ç“£APIè·å–ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯æ—¶éœ€è¦è·å–AccessTokenï¼Œåœ¨Javaä¸­å¯ä»¥å®ç°å¦‚ä¸‹ï¼š```javapublic static String testAccessToken() &#123; try &#123; OAuthDoubanProvider oauth = new OAuthDoubanProvider(); oauth.setApiKey(&quot;your api key&quot;).setSecretKey( &quot;your secret key&quot;); oauth.addScope(RequestGrantScope.BASIC_COMMON_SCOPE) .addScope(RequestGrantScope.SHUO_READ_SCOPE) .addScope(RequestGrantScope.SHUO_WRITE_SCOPE) .addScope(RequestGrantScope.BASIC_NOTE_SCOPE) .addScope(RequestGrantScope.BOOK_READ_SCOPE) .addScope(RequestGrantScope.EVENT_READ_SCOPE) .addScope(RequestGrantScope.EVENT_WRITE_SCOPE) .addScope(RequestGrantScope.MAIL_READ_SCOPE) .addScope(RequestGrantScope.MAIL_WRITE_SCOPE) .addScope(RequestGrantScope.MOVIE_READ_SCOPE) .addScope(RequestGrantScope.MUSIC_READ_SCOPE); oauth.setRedirectUrl(&quot;http://www.liutianchi.com&quot;); BrowserLauncher.openURL(oauth.getGetCodeRedirectUrl()); System.out.println(oauth.getGetCodeRedirectUrl()); System.out.print(&quot;Put the code you got here.[Enter]:&quot;); BufferedReader br = new BufferedReader(new InputStreamReader( System.in)); String code = br.readLine(); System.out.println(&quot;code : &quot; + code); AccessToken at = oauth.tradeAccessTokenWithCode(code); System.out.println(&quot;at : &quot; + at.getAccessToken()); System.out.println(&quot;uid : &quot; + at.getDoubanUserId()); return at.getAccessToken(); &#125; catch (DoubanException ex) &#123; Logger.getLogger(PlayGround.class.getName()).log(Level.SEVERE, null, ex); return null; &#125; catch (IOException ex) &#123; Logger.getLogger(PlayGround.class.getName()).log(Level.SEVERE, null, ex); return null; &#125; &#125;``` è·å–ç”µå½±Top250çš„åŸºæœ¬ä¿¡æ¯ä¸æ¶‰åŠç”¨æˆ·å†…å®¹ï¼Œæ‰€ä»¥ä¸å¿…è·å–AccessTokenã€‚ #### è·å–Top250ç”µå½±ID è™½ç„¶è±†ç“£æä¾›äº†è·å–Top250çš„APIï¼š /v2/movie/top25012ä½†æ˜¯ï¼Œé€šè¿‡ä¸Šè¿°æ–¹æ³•è·å–çš„ç”µå½±ä¿¡æ¯ä¸ºç®€å•å†…å®¹ï¼Œå…¶ä¸­æ¼”å‘˜æ•°ä¸º3ï¼Œæ— ç”µå½±çš„å›½å®¶ä¿¡æ¯ï¼Œæ— ç”µå½±å†…å®¹ç®€ä»‹ã€‚è¿™äº›å†…å®¹æ— æ³•è¾¾åˆ°æˆ‘ä»¬æ•°æ®åˆ†æçš„ç›®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆç»Ÿè®¡å‡ºTop250çš„IDï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹APIè·å–æ¯ä¸€éƒ¨ç”µå½±çš„è¯¦ç»†ä¿¡æ¯: /v2/movie/subject/:id123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204è±†ç“£é™åˆ¶äº†ä¸€æ¬¡è·å–Top250çš„ç”µå½±æ•°ç›®æœ€å¤§ä¸º100ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œ3æ¬¡è¯·æ±‚ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š ```javapublic static void getTop250ID() &#123; DoubanBookMovieMusicService instance = new DoubanBookMovieMusicService(); DoubanSubjectListObj results = null; try &#123; File dirFile = new File(FILEPATH); dirFile.mkdirs(); File idFile = new File(dirFile, &quot;movie_id&quot;); if (!idFile.exists()) idFile.createNewFile(); BufferedWriter out = new BufferedWriter(new FileWriter(idFile, false)); int start = 0; while (start &lt; 300) &#123; boolean flag = true; while (flag) &#123; try &#123; results = instance.getMoviesTop250(start, 100); flag = false; &#125; catch (NoHttpResponseException e) &#123; System.out.println(&quot;NoHttpResponseException&quot;); Thread.sleep(1000); &#125; &#125; List&lt;DoubanSubjectObj&gt; movieList = results.getSubjects(); for (DoubanSubjectObj result : movieList) &#123; out.write(result.getId()); out.newLine(); &#125; start += 100; Thread.sleep(1000); &#125; out.write(&quot;#&quot;); out.flush(); out.close(); &#125; catch (DoubanException | IOException | InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;``` å¦‚ä¸‹æ‰€ç¤ºä¸ºTop250çš„éƒ¨åˆ†ID: 1292052 1295644 1292720 1291546 1292063 1292001 1295124 1291561#### è·å–æ¯ä¸€éƒ¨ç”µå½±çš„ä¿¡æ¯ ä»£ç å®ç°å¦‚ä¸‹ï¼š```javapublic static void getTop250Info() &#123; File dirFile = new File(FILEPATH); File idFile = new File(dirFile, &quot;movie_id&quot;); if (!idFile.exists()) &#123; System.err.println(&quot;movie id file not exist!&quot;); return; &#125; LinkedHashSet&lt;String&gt; castSet = new LinkedHashSet&lt;&gt;(); LinkedHashSet&lt;String&gt; dirSet = new LinkedHashSet&lt;&gt;(); BufferedWriter writer; BufferedReader reader; try &#123; File mvFile = new File(dirFile, &quot;movie_info&quot;); if (!mvFile.exists()) mvFile.createNewFile(); writer = new BufferedWriter(new FileWriter(mvFile, false)); reader = new BufferedReader(new FileReader(idFile)); DoubanBookMovieMusicService instance = new DoubanBookMovieMusicService(); DoubanSubjectObj result = null; String id = &quot;&quot;; int count = 0; while (true) &#123; id = reader.readLine(); if (id == null || id.equals(&quot;#&quot;)) break; count++; System.out.println(count + &quot;: &quot; + id); long l = Long.parseLong(id); boolean flag = true; while (flag) &#123; try &#123; result = instance.getV2MovieInfoById(l); flag = false; &#125; catch (NoHttpResponseException | SocketTimeoutException e) &#123; System.out.println(&quot;NoHttpResponseException&quot;); Thread.sleep(2000); &#125; &#125; writer.write(result.getId() + &quot; &quot;); writer.write(result.getTitle() + &quot; &quot;); writer.write(result.getRating().getAverage() + &quot; &quot;); List&lt;DoubanCastObject&gt; castList = result.getCasts(); boolean first = true; for (DoubanCastObject cast : castList) &#123; if (!first) writer.write(&quot;#&quot;); writer.write(cast.getId()); castSet.add(cast.getId()); first = false; &#125; writer.write(&quot; &quot;); List&lt;DoubanDirectorObj&gt; dirList = result.getDirectors(); first = true; for (DoubanDirectorObj dir : dirList) &#123; if (!first) writer.write(&quot;#&quot;); writer.write(dir.getId()); dirSet.add(dir.getId()); first = false; &#125; writer.write(&quot; &quot;); List&lt;String&gt; strList = result.getCountries(); first = true; for (String str : strList) &#123; if (!first) writer.write(&quot;#&quot;); writer.write(str); first = false; &#125; writer.write(&quot; &quot;); strList = result.getGenres(); first = true; for (String str : strList) &#123; if (!first) writer.write(&quot;#&quot;); writer.write(str); first = false; &#125; writer.write(&quot; &quot; + result.getYear()); writer.newLine(); writer.flush(); Thread.sleep(3000); &#125; reader.close(); writer.close(); System.out.println(&quot;Get movie !&quot;); File castIdFile = new File(dirFile, &quot;cast_id&quot;); if (!castIdFile.exists()) castIdFile.createNewFile(); BufferedWriter castIdWriter = new BufferedWriter(new FileWriter( castIdFile, true)); Iterator&lt;String&gt; it = castSet.iterator(); while (it.hasNext()) &#123; castIdWriter.write(it.next()); castIdWriter.newLine(); &#125; castIdWriter.write(&quot;#&quot;); castIdWriter.flush(); castIdWriter.close(); File dirIdFile = new File(dirFile, &quot;dir_id&quot;); if (!dirIdFile.exists()) dirIdFile.createNewFile(); BufferedWriter dirIdWriter = new BufferedWriter(new FileWriter( dirIdFile, true)); it = dirSet.iterator(); while (it.hasNext()) &#123; dirIdWriter.write(it.next()); dirIdWriter.newLine(); &#125; dirIdWriter.write(&quot;#&quot;); dirIdWriter.flush(); dirIdWriter.close(); &#125; catch (IOException | DoubanException | InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; åœ¨è·å–ç”µå½±ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬åŒæ—¶åˆ©ç”¨å“ˆå¸Œé›†ç»Ÿè®¡äº†æ¼”å‘˜çš„IDå’Œå¯¼æ¼”çš„IDï¼Œç›®çš„æ˜¯ä¸ºäº†è¿›ä¸€æ­¥ç»Ÿè®¡å½±äººçš„å…·ä½“ä¿¡æ¯ã€‚ åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè±†ç“£ä¸ºäº†é˜²æ­¢æ¶æ„è®¿é—®ï¼Œå¯¹æ¯åˆ†é’Ÿè¯·æ±‚çš„æ¬¡æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œå®˜æ–¹æ–‡æ¡£è¯´ä¸º40æ¬¡/åˆ†é’Ÿï¼Œç»è¿‡å®éªŒå‘ç°ï¼Œè¿™ä¸ªæ—¶é—´å¹¶ä¸å‡†ç¡®ï¼Œæœ€åæˆ‘ä»¬é‡‡ç”¨3sä¸€æ¬¡çš„è¯·æ±‚è¿›è¡Œäº†è¿ç»­çš„è®¿é—®ã€‚å¦‚æœè¯·æ±‚æ¬¡æ•°è¿‡åº¦é¢‘ç¹ï¼Œåˆ™ä¼šå‡ºç°è­¦å‘Šé¡µé¢ï¼ŒåŒæ—¶å¯¼è‡´åœ¨è¯¥IPä¸‹è‹¥å¹²å°æ—¶å†…æ— æ³•ç»§ç»­è®¿é—®ã€‚ æœ€åè·å–çš„ç”µå½±ä¿¡æ¯éƒ¨åˆ†ç»“æœå¦‚ä¸‹æ‰€ç¤º(idï¼Œåç§°ï¼Œå¹³åˆ†ï¼Œæ¼”å‘˜idé›†åˆï¼Œå¯¼æ¼”idé›†åˆï¼Œå›½å®¶ï¼Œæ ‡ç­¾é›†åˆï¼Œå‘è¡Œå¹´ä»½)ï¼š 1292052 è‚–ç”³å…‹çš„æ•‘èµ 9.6 1054521#1054534#1041179#1000095 1047973 ç¾å›½ çŠ¯ç½ª#å‰§æƒ… 1994 1295644 è¿™ä¸ªæ€æ‰‹ä¸å¤ªå†· 9.4 1025182#1054454#1010507#1019050 1031876 æ³•å›½ å‰§æƒ…#åŠ¨ä½œ#çŠ¯ç½ª 1994 1292720 é˜¿ç”˜æ­£ä¼  9.4 1054450#1002676#1031848#1031912 1053564 ç¾å›½ å‰§æƒ…#çˆ±æƒ… 1994 1291546 éœ¸ç‹åˆ«å§¬ 9.4 1003494#1050265#1035641#1000905 1023040 ä¸­å›½å¤§é™†#é¦™æ¸¯ å‰§æƒ…#çˆ±æƒ…#åŒæ€§ 1993 1292063 ç¾ä¸½äººç”Ÿ 9.4 1041004#1000375#1000368#1082051 1041004 æ„å¤§åˆ© å‰§æƒ…#æˆ˜äº‰ 1997 1292001 æµ·ä¸Šé’¢ç´å¸ˆ 9.2 1025176#1010659#1027407#1009391 1018983 æ„å¤§åˆ© å‰§æƒ…#éŸ³ä¹ 1998 1295124 è¾›å¾·å‹’çš„åå• 9.4 1031220#1054393#1006956#1041165 1054440 ç¾å›½ å‰§æƒ…#å†å²#æˆ˜äº‰ 1993 1291561 åƒä¸åƒå¯» 9.2 1023337#1005438#1045797#1025558 1054439 æ—¥æœ¬ å‰§æƒ…#åŠ¨ç”»#å¥‡å¹» 2001 2131459 æœºå™¨äººæ€»åŠ¨å‘˜ 9.3 1009535#1000389#1018022#1049585 1036450 ç¾å›½ å–œå‰§#çˆ±æƒ…#ç§‘å¹» 2008 1292722 æ³°å¦å°¼å…‹å· 9.1 1041029#1054446#1031864#1010555 1022571 ç¾å›½ å‰§æƒ…#çˆ±æƒ…#ç¾éš¾ 1997 3541415 ç›—æ¢¦ç©ºé—´ 9.2 1041029#1101703#1012520#1027181 1054524 ç¾å›½#è‹±å›½ å‰§æƒ…#åŠ¨ä½œ#ç§‘å¹» 2010 3793023 ä¸‰å‚»å¤§é—¹å®è±å 9.1 1031931#1049635#1018290#1032430 1286677 å°åº¦ å‰§æƒ…#å–œå‰§#çˆ±æƒ… 2009 å…¶ä¸­æ‰€æœ‰çš„æ¼”å‘˜å’Œå¯¼æ¼”çš„ä¿¡æ¯ç”¨è±†ç“£èµ‹äºˆçš„IDè¡¨ç¤ºï¼ŒIDæ˜¯è±†ç“£é‡‡ç”¨çš„å”¯ä¸€æ ‡ç¤ºå½±äººçš„åºå·ã€‚ç”±äºè±†ç“£æä¾›çš„ç”µå½±ä¿¡æ¯å†…å®¹ä¸å®Œå…¨è§„èŒƒï¼ŒåŒä¸€ä¸ªå½±äººå¯èƒ½åœ¨ä¸åŒç”µå½±ä¸­ä½¿ç”¨äº†ä¸åŒçš„åå­—ï¼Œä¾‹å¦‚åå­—æ‹¼å†™ã€ç¿»è¯‘ä¸åŒï¼Œæ‰€ä»¥é‡‡ç”¨IDè€Œä¸æ˜¯å½±äººçš„åå­—æ¥è¿›è¡Œæ•°æ®åˆ†æã€‚ è·å–å½±äººä¿¡æ¯å› ä¸ºéœ€è¦å¯¹ç”·å¥³æ¼”å‘˜è¿›è¡Œåˆ†åˆ«ç»Ÿè®¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹å½±äººçš„è¯¦ç»†ä¿¡æ¯åˆè¿›è¡Œäº†è·å–ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public static void getCastInfo() &#123; File dirFile = new File(FILEPATH); File idFile = new File(dirFile, \"dir_id\"); if (!idFile.exists()) &#123; System.err.println(\"cast id file not exist!\"); return; &#125; BufferedWriter writer; BufferedReader reader; try &#123; File infoFile = new File(dirFile, \"dir_info\"); if (!infoFile.exists()) infoFile.createNewFile(); writer = new BufferedWriter(new FileWriter(infoFile, false)); reader = new BufferedReader(new FileReader(idFile)); DoubanBookMovieMusicService instance = new DoubanBookMovieMusicService(); DoubanCastObject result = null; String id = \"\"; int count = 0; while (true) &#123; id = reader.readLine(); if (id == null || id.equals(\"#\")) break; count++; System.out.println(count + \": \" + id); boolean flag = true; while (flag) &#123; try &#123; result = instance.getMoviesCast(id); flag = false; &#125; catch (NoHttpResponseException | SocketTimeoutException e) &#123; System.out.println(\"NoHttpResponseException\"); Thread.sleep(2000); &#125; &#125; writer.write(result.getId() + \" \"); writer.write(result.getName() + \" \"); writer.write(result.getGender()); writer.newLine(); writer.flush(); Thread.sleep(4000); &#125; reader.close(); writer.close(); System.out.println(\"Get movie !\"); &#125; catch (IOException | DoubanException | InterruptedException e) &#123; e.printStackTrace(); &#125; &#125; è·å–çš„éƒ¨åˆ†æ¼”å‘˜ä¿¡æ¯å¦‚ä¸‹(idï¼Œåå­—ï¼Œæ€§åˆ«)ï¼š 1054521 è’‚å§†Â·ç½—å®¾æ–¯ ç”· 1054534 æ‘©æ ¹Â·å¼—é‡Œæ›¼ ç”· 1041179 é²å‹ƒÂ·å†ˆé¡¿ ç”· 1000095 å¨å»‰å§†Â·èµ›å¾·å‹’ ç”· 1025182 è®©Â·é›·è¯º ç”· 1054454 å¨œå¡”è‰Â·æ³¢ç‰¹æ›¼ å¥³ 1010507 åŠ é‡ŒÂ·å¥¥å¾·æ›¼ ç”· 1019050 ä¸¹å°¼Â·çˆ±ç½— ç”· 1054450 æ±¤å§†Â·æ±‰å…‹æ–¯ ç”· 1002676 ç½—å®¾Â·æ€€ç‰¹ å¥³ 1031848 åŠ é‡ŒÂ·è¥¿å°¼æ–¯ ç”· 1031912 éº¦å‡¯å°”æ³°Â·å¨å»‰é€Š ç”· 1003494 å¼ å›½è£ ç”· 1050265 å¼ ä¸°æ¯… ç”· 1035641 å·©ä¿ å¥³ è·å–çš„å¯¼æ¼”ä¿¡æ¯å¦‚ä¸‹ï¼š 1047973 å¼—å…°å…‹Â·å¾·æ‹‰é‚¦ç‰¹ ç”· 1031876 å•å…‹Â·è´æ¾ ç”· 1053564 ç½—ä¼¯ç‰¹Â·æ³½ç±³å‰æ–¯ ç”· 1023040 é™ˆå‡¯æ­Œ ç”· 1041004 ç½—ä¼¯æ‰˜Â·è´å°¼å°¼ ç”· 1018983 æœ±å¡ä½©Â·æ‰˜çº³å¤šé›· ç”· 1054440 å²è’‚æ–‡Â·æ–¯çš®å°”ä¼¯æ ¼ ç”· 1054439 å®«å´éª ç”· æ•°æ®å®Œå–„éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè·å–çš„æºæ•°æ®å½¢å¼å¹¶ä¸è§„èŒƒï¼Œå½±äººçš„åå­—æ ¼å¼å¤šæ ·ï¼Œæœ‰çš„å½±äººæ²¡æœ‰æ€§åˆ«ä¿¡æ¯ï¼Œæ‰€ä»¥å¯¹æºæ•°æ®è¿›è¡Œè¿‡æ»¤ä¿®æ­£ã€‚","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"è±†ç“£","slug":"è±†ç“£","permalink":"http://itanch.github.io/tags/è±†ç“£/"},{"name":"ç”µå½±","slug":"ç”µå½±","permalink":"http://itanch.github.io/tags/ç”µå½±/"}]},{"title":"ubuntu14.04åŸºæœ¬é…ç½®","date":"2015-08-06T03:59:57.000Z","path":"2015/08/06/ubuntu14-04åŸºæœ¬é…ç½®/","text":"æ›´æ–°ï¼š12$ sudo apt-get update $ sudo apt-get upgrade å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š123$ sudo add-apt-repository ppa:fcitx-team/nightly #æ·»åŠ fcitxæº$ sudo apt-get install fcitx #ä¸‹è½½æœç‹—è¾“å…¥æ³•åŒå‡»å®‰è£… å®‰è£…JDKï¼š123456789101112#ä¸‹è½½æœ€è¿‘çš„jdkåŒ… $ sudo mv jdk.tar.gz /usr/lib/jvm/ $ cd /usr/lib/jvm/ $ sudo tar -zxvf jdk.tar.gz $ sudo rm jdk.tar.gz $ sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/jdk/bin/java 300 $ sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/jdk/bin/javac 300#é€‰æ‹©é»˜è®¤javaåº“$ sudo update-alternatives --config java $ java -version #æµ‹è¯• å®‰è£…Eclispe123456789101112131415161718192021#ä¸‹è½½æœ€æ–°çš„elipseåŒ… $ sudo mv eclipse.tar.gz /opt/$ cd /opt/$ sudo tar -zxvf eclipse.tar.gz$ sudo rm eclipse.tar.gz#è‹¥æƒ³ä»å‘½ä»¤è¡Œå¯åŠ¨ $ sudo ln -sf /opt/eclipse/eclipse /usr/bin#åˆ›å»ºæ¡Œé¢å›¾æ ‡ $ sudo vi /usr/share/applications/eclipse.desktop#æ·»åŠ å¦‚ä¸‹å†…å®¹ [Desktop Entry]Type=ApplicationName=EclipseComment=Eclipse Integrated Development EnvironmentIcon=/opt/eclipse/icon.xpmExec=eclipseTerminal=falseCategories=Development;IDE;Java; é…ç½®Android SDK:1234567891011121314151617181920#ä»å®˜ç½‘ä¸‹è½½æœ€æ–°çš„SDK#å°†æ–‡ä»¶è§£å‹åˆ°ç›®æ ‡æ–‡ä»¶å¤¹/opt/$ cd /opt/android-sdk/tools$ sudo ./android #è¿è¡ŒAndroid SDK Manager,ä¸‹è½½platfor-toolså’Œbulid-tools$ sudo chmod 777 android-sdk #ä¿®æ”¹æ‰€æœ‰æ–‡ä»¶çš„æƒé™,ä½¿ä¹‹å¯ä»¥è¿è¡Œ#64ä½çš„ubuntu 13.10åŠä»¥ä¸Šç‰ˆæœ¬éœ€è¦å®‰è£…32ä½ç›¸å…³çš„åº“$ sudo dpkg --add-architecture i386$ sudo apt-get update$ sudo apt-get install libncurses5:i386 libstdc++6:i386 zlib1g:i386$ sudo vi /ect/profile #æ·»åŠ å¦‚ä¸‹å†…å®¹export PATH=/opt/android-sdk-linux/platform-tools:$PATH export PATH=/opt/android-sdk-linux/tools:$PATH$ source /ect/profile Firefox Flashæ’ä»¶123456#ä¸‹è½½æœ€æ–°çš„Flash Player$ tar -zxvf flash.tar.gz#è·å–flashplayer.so$ sudo cp libflashplayer.so /usr/lib/mozilla/plugins å¸¸ç”¨å‘½ä»¤ å–æ¶ˆæŸä¸ªè½¯ä»¶(tomcat)å¼€æœºè‡ªå¯åŠ¨ã€‚ 1sudo update-rc.d tomcat disable","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"ubuntu","slug":"ubuntu","permalink":"http://itanch.github.io/tags/ubuntu/"}]},{"title":"Torqueå®‰è£…ç¬”è®°(å¤šubuntuèŠ‚ç‚¹)","date":"2015-08-06T03:59:57.000Z","path":"2015/08/06/Torqueå­¦ä¹ ç¬”è®°/","text":"1.å®éªŒç³»ç»Ÿubuntu14.04ã€‚æ›´æ–°ç³»ç»Ÿè½¯ä»¶ï¼Œé˜²æ­¢ç›¸å…³è½¯ä»¶ç‰ˆæœ¬è¿‡ä½ 12sudo apt-get update sudo apt-get upgrade 2.ä»å®˜ç½‘ä¸‹è½½Torqueï¼Œåœ¨è¿™é‡Œä¸ºTorque 5.1.1ã€‚ 3.è§£å‹æ–‡ä»¶ 1tar -xzvf torque.tar.gz 4.è¿è¡Œconfigureï¼Œå¯åŠ prefixæŒ‡å®šTorqueå‘½ä»¤å®‰è£…ä½ç½®ï¼Œä¹Ÿå¯ä¸åŠ ï¼Œä¸åŠ å‚æ•°å‘½ä»¤é»˜è®¤è£…åœ¨/usr/local/binå’Œ/usr/local/sbinä¸‹ã€‚åˆ©ç”¨configureå¯ä»¥æ£€æµ‹ä¾èµ–è½¯ä»¶ï¼ŒæŒ‰ç…§æç¤ºå®‰è£…è¿™äº›è½¯ä»¶ã€‚ 1./configure --prefix=/usr/local/torque 5.ç¼–è¯‘å®‰è£… 12make make install 6.ç”Ÿæˆå­èŠ‚ç‚¹å®‰è£…åŒ…ï¼Œmomå’Œclientsä¸ºéœ€è¦æ‹·è´çš„æ–‡ä»¶ã€‚éœ€è¦å®‰è£…sshï¼Œubuntué»˜è®¤å®‰è£…openssh-clientï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å†å®‰è£…openssh-serverï¼Œè®©å…¶ä»–è®¡ç®—æœºç™»é™†ã€‚ 1234make packagesscp tpackages name@ip:dir #éå¿…è¦scp torque-package-mom-linux-x86_64.sh name@ip:dir scp torque-package-clients-linux-x86_64.sh name@ip:dir 7.åœ¨å­èŠ‚ç‚¹ä¸Šå®‰è£…ï¼Œmomå’Œclientsã€‚ 12sudo ./torque-package-mom-linux-x86_64.sh --installsudo ./torque-package-clients-linux-x86_64.sh --install 8.é…ç½®ä¸»èŠ‚ å°†/usr/local/torque/binå’Œ/usr/local/torque/sbinæ·»åŠ è¿›ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œæˆ‘å°†å…¶æ·»åŠ å…¥.bashrcæ–‡ä»¶ã€‚ 12345678export PATH=$PATH:/usr/local/torque/bin:/usr/local/torque/sbin ``` + æ·»åŠ å…±äº«åº“åˆ°Torqueçš„é…ç½®æ–‡ä»¶ä¸­ï¼ˆå¦‚æœå‡ºç°æœ‰ä»€ä¹ˆåº“æ‰¾ä¸åˆ°ï¼Œåˆ™å¿…é¡»åŠ ä¸Šï¼‰ ```shecho '/usr/local/lib' &gt; /etc/ld.so.conf.d/torque.confldconfig æ·»åŠ ä¸»èŠ‚ç‚¹åå­—ï¼š 1234567echo ä¸»èŠ‚ç‚¹åå­— &gt; /var/spool/torque/server_name ``` + åˆå§‹åŒ–serverdbæ–‡ä»¶ï¼Œåœ¨ä½¿ç”¨pbs_severä¹‹å‰å¿…é¡»å®Œæˆè¯¥æ­¥éª¤ï¼š```sh./torque.setup ç”¨æˆ·å æ·»åŠ å­èŠ‚ç‚¹ï¼Œnpä¸ºèŠ‚ç‚¹cpuæ ¸ä¸ªæ•° vi /var/spool/torque/server_priv/nodeså­èŠ‚ç‚¹çš„åå­—ä¸ºè®¡ç®—æœºåï¼Œè€Œéç”¨æˆ·åã€‚æ¯æ¬¡æ·»åŠ èŠ‚ç‚¹éœ€è¦é‡å¯pbs_severã€‚æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼ˆä¹Ÿå¯ä»¥å…ˆåœ¨å­èŠ‚ç‚¹å¯åŠ¨momï¼Œåœ¨ä¸»èŠ‚ç‚¹å¯åŠ¨serverï¼Œç„¶åç”¨å‘½ä»¤qmgr -c &#39;create node ubuntu np=4&#39;è¿›è¡Œæ·»åŠ èŠ‚ç‚¹ï¼‰ï¼š12å­èŠ‚ç‚¹1åå­— np=4 å­èŠ‚ç‚¹2åå­— np=4 å¯åŠ¨ 123pbs_serverpbs_sched pbs_mom 9.é…ç½®å­èŠ‚ç‚¹ï¼ŒåŒæ ·éœ€è¦æ·»åŠ ç¯å¢ƒå˜é‡ã€‚ ä¿®æ”¹configä½¿ç”¨make packages å‘½ä»¤ç”Ÿæˆmomå®‰è£…äºå­èŠ‚ç‚¹çš„ï¼Œæ— éœ€è¿›è¡Œè¿™ä¸€æ­¥ã€‚ 1234 vi /var/spool/torque/mom_priv/config æ·»åŠ ï¼š pbsserver ä¸»èŠ‚ç‚¹åç§° logevent 255 å¯åŠ¨ï¼š 1pbs_mom 10.æ³¨æ„ï¼å› ä¸ºé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨äº†ä¸»èŠ‚ç‚¹åç§°å’Œå­èŠ‚ç‚¹åç§°ï¼Œæ‰€ä»¥ä¸»ã€ä»èŠ‚ç‚¹éƒ½éœ€è¦ä¿®æ”¹ 12/etc/hosts æ·»åŠ è¿™äº›åç§°å’Œå¯¹åº”çš„ip 11.æ£€æŸ¥è¿è¡Œæƒ…å†µä¿è¯åœ¨serverä¸Šè¿è¡Œtrqauthdã€pbs_serverã€pbs_schedè¿™ä¸‰ä¸ªç¨‹åºã€‚ä¿è¯åœ¨å­èŠ‚ç‚¹ä¸Šè¿è¡Œpbs_momã€‚ 12.å¸¸ç”¨å‘½ä»¤pbsnodes: å­èŠ‚ç‚¹ä¿¡æ¯ã€‚qterm: ç»“æŸpbs_serverã€‚qsub: æäº¤jobã€‚qstat: jobè¿è¡Œä¿¡æ¯ã€‚ 13.æµ‹è¯•ï¼šæ³¨æ„ï¼åœ¨æäº¤Jobæ—¶ï¼Œéœ€è¦ä¸»èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹ä¸ºç›¸åŒçš„ç”¨æˆ·åï¼ŒåŒæ—¶ä¿è¯æ“ä½œçš„æ–‡ä»¶ç›®å½•ä¹Ÿç›¸åŒã€‚12echo \"sleep 300\" | qsub qstat","tags":[{"name":"æŠ€æœ¯","slug":"æŠ€æœ¯","permalink":"http://itanch.github.io/tags/æŠ€æœ¯/"},{"name":"ubuntu","slug":"ubuntu","permalink":"http://itanch.github.io/tags/ubuntu/"},{"name":"Torque","slug":"Torque","permalink":"http://itanch.github.io/tags/Torque/"}]},{"title":"Hello World","date":"2015-07-31T23:33:44.000Z","path":"2015/08/01/hello/","text":"Tianchiâ€™s Blogä»Šå¤©è¯ç”Ÿäº†ï¼ å¤«å›å­ä¹‹è¡Œï¼Œé™ä»¥ä¿®èº«ï¼Œä¿­ä»¥å…»å¾·ã€‚éæ¾¹æ³Šæ— ä»¥æ˜å¿—ï¼Œéå®é™æ— ä»¥è‡´è¿œã€‚å¤«å­¦é¡»é™ä¹Ÿï¼Œæ‰é¡»å­¦ä¹Ÿï¼Œéå­¦æ— ä»¥å¹¿æ‰ï¼Œéå¿—æ— ä»¥æˆå­¦ã€‚æ·«æ…¢åˆ™ä¸èƒ½åŠ±ç²¾ï¼Œé™©èºåˆ™ä¸èƒ½å†¶æ€§ã€‚å¹´ä¸æ—¶é©°ï¼Œæ„ä¸æ—¥å»ï¼Œé‚æˆæ¯è½ï¼Œå¤šä¸æ¥ä¸–ï¼Œæ‚²å®ˆç©·åºï¼Œå°†å¤ä½•åŠï¼","tags":[{"name":"è®°å½•","slug":"è®°å½•","permalink":"http://itanch.github.io/tags/è®°å½•/"}]}]