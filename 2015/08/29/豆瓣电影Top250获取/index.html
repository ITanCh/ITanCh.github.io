<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 豆瓣电影Top250获取 · Tianchi's Blog</title><meta name="description" content="豆瓣电影Top250获取 - Tian chi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/long_round.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://itanch.github.io/atom.xml" title="Tianchi's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/long_round.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/ITanCh" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">豆瓣电影Top250获取</h1><div class="post-info">Aug 29, 2015</div><div class="post-content"><h3 id="豆瓣API说明"><a href="#豆瓣API说明" class="headerlink" title="豆瓣API说明"></a>豆瓣API说明</h3><p>豆瓣为开发者提供了用于应用开发的<a href="http://developers.douban.com/wiki/?title=api_v2" target="_blank" rel="external">Api接口</a>，通过这些Api接口可以获得豆瓣的部分内容。  </p>
<p>豆瓣Api V2认证使用了OAuth2，使得用户的授权过程更为安全，返回数据的格式为json，便于应用开发者解析获得的数据。豆瓣没有提供官方的SDK，但是提供了其他非官方的基于多种语言的SDK，我们采用了Java语言的<a href="https://github.com/UglyTroLL/Douban-Java-SDK-OAuth2" target="_blank" rel="external">SDK</a>。由于该版本的Java SDK基于较早的豆瓣API的v1版本，所以需要进行部分修改适应新的v2版本，其中我们修改了电影相关的代码(<a href="https://github.com/ITanCh/Douban-Java-SDK-OAuth2" target="_blank" rel="external">新的源代码</a>)。  </p>
<p>Java SDK为Maven工程，可以使用Maven编译打包：  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn package -Dmaven<span class="selector-class">.test</span><span class="selector-class">.skip</span>=true</div></pre></td></tr></table></figure>  
<p>为了将所有依赖一起打包进去，我们使用了fatjar工具进行打包，生成可以调用的函数库(<a href="https://github.com/ITanCh/Douban-Java-SDK-OAuth2/raw/origin/Douban-Java-SDK-OAuth2-origin_fat.jar" target="_blank" rel="external">jar</a>)。<br><a id="more"></a></p>
<h3 id="API使用"><a href="#API使用" class="headerlink" title="API使用"></a>API使用</h3><h4 id="相关库"><a href="#相关库" class="headerlink" title="相关库"></a>相关库</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.app.AccessToken;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.app.DoubanException;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.app.RequestGrantScope;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanCastObject;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanDirectorObj;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanSubjectListObj;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanSubjectObj;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.playground.BrowserLauncher;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.playground.PlayGround;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.provider.OAuthDoubanProvider;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.service.DoubanBookMovieMusicService;</div></pre></td></tr></table></figure>  
<h4 id="AccessToken获取"><a href="#AccessToken获取" class="headerlink" title="AccessToken获取"></a>AccessToken获取</h4><p>通过豆瓣API获取用户相关的信息时需要获取AccessToken，在Java中可以实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">testAccessToken</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			OAuthDoubanProvider oauth = <span class="keyword">new</span> OAuthDoubanProvider();</div><div class="line">			oauth.setApiKey(<span class="string">"your api key"</span>).setSecretKey(</div><div class="line">					<span class="string">"your secret key"</span>);</div><div class="line">			oauth.addScope(RequestGrantScope.BASIC_COMMON_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.SHUO_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.SHUO_WRITE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.BASIC_NOTE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.BOOK_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.EVENT_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.EVENT_WRITE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MAIL_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MAIL_WRITE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MOVIE_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MUSIC_READ_SCOPE);</div><div class="line">			oauth.setRedirectUrl(<span class="string">"http://www.liutianchi.com"</span>);</div><div class="line">			BrowserLauncher.openURL(oauth.getGetCodeRedirectUrl());</div><div class="line">			System.out.println(oauth.getGetCodeRedirectUrl());</div><div class="line">			System.out.print(<span class="string">"Put the code you got here.[Enter]:"</span>);</div><div class="line">			BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(</div><div class="line">					System.in));</div><div class="line">			String code = br.readLine();</div><div class="line">			System.out.println(<span class="string">"code : "</span> + code);</div><div class="line">			AccessToken at = oauth.tradeAccessTokenWithCode(code);</div><div class="line">			System.out.println(<span class="string">"at : "</span> + at.getAccessToken());</div><div class="line">			System.out.println(<span class="string">"uid : "</span> + at.getDoubanUserId());</div><div class="line">			<span class="keyword">return</span> at.getAccessToken();</div><div class="line">		&#125; <span class="keyword">catch</span> (DoubanException ex) &#123;</div><div class="line">			Logger.getLogger(PlayGround.class.getName()).log(Level.SEVERE,</div><div class="line">					<span class="keyword">null</span>, ex);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			Logger.getLogger(PlayGround.class.getName()).log(Level.SEVERE,</div><div class="line">					<span class="keyword">null</span>, ex);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>  </p>
<p>获取电影Top250的基本信息不涉及用户内容，所以不必获取AccessToken。  </p>
<h4 id="获取Top250电影ID"><a href="#获取Top250电影ID" class="headerlink" title="获取Top250电影ID"></a>获取Top250电影ID</h4><p>虽然豆瓣提供了获取Top250的API：  </p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/v2/movie/top250</div></pre></td></tr></table></figure>
<p>但是，通过上述方法获取的电影信息为简单内容，其中演员数为3，无电影的国家信息，无电影内容简介。这些内容无法达到我们数据分析的目的，所以我们首先统计出Top250的ID，然后使用如下API获取每一部电影的详细信息:  </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/v2/m</span>ovie<span class="regexp">/subject/</span>:id</div></pre></td></tr></table></figure>  
<p>豆瓣限制了一次获取Top250的电影数目最大为100，所以需要进行3次请求。代码实现如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getTop250ID</span><span class="params">()</span> </span>&#123;</div><div class="line">		DoubanBookMovieMusicService instance = <span class="keyword">new</span> DoubanBookMovieMusicService();</div><div class="line">		DoubanSubjectListObj results = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File dirFile = <span class="keyword">new</span> File(FILEPATH);</div><div class="line">			dirFile.mkdirs();</div><div class="line"></div><div class="line">			File idFile = <span class="keyword">new</span> File(dirFile, <span class="string">"movie_id"</span>);</div><div class="line">			<span class="keyword">if</span> (!idFile.exists())</div><div class="line">				idFile.createNewFile();</div><div class="line">			BufferedWriter out = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(idFile,</div><div class="line">					<span class="keyword">false</span>));</div><div class="line"></div><div class="line">			<span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (start &lt; <span class="number">300</span>) &#123;</div><div class="line"></div><div class="line">				<span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">while</span> (flag) &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						results = instance.getMoviesTop250(start, <span class="number">100</span>);</div><div class="line">						flag = <span class="keyword">false</span>;</div><div class="line">					&#125; <span class="keyword">catch</span> (NoHttpResponseException e) &#123;</div><div class="line">						System.out.println(<span class="string">"NoHttpResponseException"</span>);</div><div class="line">						Thread.sleep(<span class="number">1000</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				List&lt;DoubanSubjectObj&gt; movieList = results.getSubjects();</div><div class="line"></div><div class="line">				<span class="keyword">for</span> (DoubanSubjectObj result : movieList) &#123;</div><div class="line">					out.write(result.getId());</div><div class="line">					out.newLine();</div><div class="line">				&#125;</div><div class="line">				start += <span class="number">100</span>;</div><div class="line">				Thread.sleep(<span class="number">1000</span>);</div><div class="line">			&#125;</div><div class="line">			out.write(<span class="string">"#"</span>);</div><div class="line">			out.flush();</div><div class="line">			out.close();</div><div class="line">		&#125; <span class="keyword">catch</span> (DoubanException | IOException | InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>  
<p>如下所示为Top250的部分ID:  </p>
<pre><code>1292052
1295644
1292720
1291546
1292063
1292001
1295124
1291561
</code></pre><h4 id="获取每一部电影的信息"><a href="#获取每一部电影的信息" class="headerlink" title="获取每一部电影的信息"></a>获取每一部电影的信息</h4><p>代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getTop250Info</span><span class="params">()</span> </span>&#123;</div><div class="line">		File dirFile = <span class="keyword">new</span> File(FILEPATH);</div><div class="line">		File idFile = <span class="keyword">new</span> File(dirFile, <span class="string">"movie_id"</span>);</div><div class="line">		<span class="keyword">if</span> (!idFile.exists()) &#123;</div><div class="line">			System.err.println(<span class="string">"movie id file not exist!"</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		LinkedHashSet&lt;String&gt; castSet = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">		LinkedHashSet&lt;String&gt; dirSet = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">		BufferedWriter writer;</div><div class="line">		BufferedReader reader;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File mvFile = <span class="keyword">new</span> File(dirFile, <span class="string">"movie_info"</span>);</div><div class="line">			<span class="keyword">if</span> (!mvFile.exists())</div><div class="line">				mvFile.createNewFile();</div><div class="line">			writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(mvFile, <span class="keyword">false</span>));</div><div class="line"></div><div class="line">			reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(idFile));</div><div class="line"></div><div class="line">			DoubanBookMovieMusicService instance = <span class="keyword">new</span> DoubanBookMovieMusicService();</div><div class="line">			DoubanSubjectObj result = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">			String id = <span class="string">""</span>;</div><div class="line">			<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				id = reader.readLine();</div><div class="line">				<span class="keyword">if</span> (id == <span class="keyword">null</span> || id.equals(<span class="string">"#"</span>))</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				count++;</div><div class="line">				System.out.println(count + <span class="string">": "</span> + id);</div><div class="line"></div><div class="line">				<span class="keyword">long</span> l = Long.parseLong(id);</div><div class="line"></div><div class="line">				<span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">while</span> (flag) &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						result = instance.getV2MovieInfoById(l);</div><div class="line">						flag = <span class="keyword">false</span>;</div><div class="line">					&#125; <span class="keyword">catch</span> (NoHttpResponseException | SocketTimeoutException e) &#123;</div><div class="line">						System.out.println(<span class="string">"NoHttpResponseException"</span>);</div><div class="line">						Thread.sleep(<span class="number">2000</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(result.getId() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getTitle() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getRating().getAverage() + <span class="string">" "</span>);</div><div class="line"></div><div class="line">				List&lt;DoubanCastObject&gt; castList = result.getCasts();</div><div class="line">				<span class="keyword">boolean</span> first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (DoubanCastObject cast : castList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(cast.getId());</div><div class="line">					castSet.add(cast.getId());</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span>);</div><div class="line"></div><div class="line">				List&lt;DoubanDirectorObj&gt; dirList = result.getDirectors();</div><div class="line">				first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (DoubanDirectorObj dir : dirList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(dir.getId());</div><div class="line">					dirSet.add(dir.getId());</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span>);</div><div class="line"></div><div class="line">				List&lt;String&gt; strList = result.getCountries();</div><div class="line">				first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (String str : strList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(str);</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span>);</div><div class="line"></div><div class="line">				strList = result.getGenres();</div><div class="line">				first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (String str : strList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(str);</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span> + result.getYear());</div><div class="line">				writer.newLine();</div><div class="line">				writer.flush();</div><div class="line">				Thread.sleep(<span class="number">3000</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			reader.close();</div><div class="line">			writer.close();</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"Get movie !"</span>);</div><div class="line"></div><div class="line">			File castIdFile = <span class="keyword">new</span> File(dirFile, <span class="string">"cast_id"</span>);</div><div class="line">			<span class="keyword">if</span> (!castIdFile.exists())</div><div class="line">				castIdFile.createNewFile();</div><div class="line">			BufferedWriter castIdWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(</div><div class="line">					castIdFile, <span class="keyword">true</span>));</div><div class="line">			Iterator&lt;String&gt; it = castSet.iterator();</div><div class="line">			<span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">				castIdWriter.write(it.next());</div><div class="line">				castIdWriter.newLine();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			castIdWriter.write(<span class="string">"#"</span>);</div><div class="line">			castIdWriter.flush();</div><div class="line">			castIdWriter.close();</div><div class="line"></div><div class="line">			File dirIdFile = <span class="keyword">new</span> File(dirFile, <span class="string">"dir_id"</span>);</div><div class="line">			<span class="keyword">if</span> (!dirIdFile.exists())</div><div class="line">				dirIdFile.createNewFile();</div><div class="line">			BufferedWriter dirIdWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(</div><div class="line">					dirIdFile, <span class="keyword">true</span>));</div><div class="line">			it = dirSet.iterator();</div><div class="line">			<span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">				dirIdWriter.write(it.next());</div><div class="line">				dirIdWriter.newLine();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			dirIdWriter.write(<span class="string">"#"</span>);</div><div class="line">			dirIdWriter.flush();</div><div class="line">			dirIdWriter.close();</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException | DoubanException | InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>在获取电影信息时，我们同时利用哈希集统计了演员的ID和导演的ID，目的是为了进一步统计影人的具体信息。  </p>
<p>在这里需要注意的是，豆瓣为了防止恶意访问，对每分钟请求的次数进行了限制，官方文档说为40次/分钟，经过实验发现，这个时间并不准确，最后我们采用3s一次的请求进行了连续的访问。如果请求次数过度频繁，则会出现警告页面，同时导致在该IP下若干小时内无法继续访问。</p>
<p>最后获取的电影信息部分结果如下所示(id，名称，平分，演员id集合，导演id集合，国家，标签集合，发行年份)：  </p>
<pre><code>1292052 肖申克的救赎 9.6 1054521#1054534#1041179#1000095 1047973 美国 犯罪#剧情 1994
1295644 这个杀手不太冷 9.4 1025182#1054454#1010507#1019050 1031876 法国 剧情#动作#犯罪 1994
1292720 阿甘正传 9.4 1054450#1002676#1031848#1031912 1053564 美国 剧情#爱情 1994
1291546 霸王别姬 9.4 1003494#1050265#1035641#1000905 1023040 中国大陆#香港 剧情#爱情#同性 1993
1292063 美丽人生 9.4 1041004#1000375#1000368#1082051 1041004 意大利 剧情#战争 1997
1292001 海上钢琴师 9.2 1025176#1010659#1027407#1009391 1018983 意大利 剧情#音乐 1998
1295124 辛德勒的名单 9.4 1031220#1054393#1006956#1041165 1054440 美国 剧情#历史#战争 1993
1291561 千与千寻 9.2 1023337#1005438#1045797#1025558 1054439 日本 剧情#动画#奇幻 2001
2131459 机器人总动员 9.3 1009535#1000389#1018022#1049585 1036450 美国 喜剧#爱情#科幻 2008
1292722 泰坦尼克号 9.1 1041029#1054446#1031864#1010555 1022571 美国 剧情#爱情#灾难 1997
3541415 盗梦空间 9.2 1041029#1101703#1012520#1027181 1054524 美国#英国 剧情#动作#科幻 2010
3793023 三傻大闹宝莱坞 9.1 1031931#1049635#1018290#1032430 1286677 印度 剧情#喜剧#爱情 2009  
</code></pre><p>其中所有的演员和导演的信息用豆瓣赋予的ID表示，ID是豆瓣采用的唯一标示影人的序号。由于豆瓣提供的电影信息内容不完全规范，同一个影人可能在不同电影中使用了不同的名字，例如名字拼写、翻译不同，所以采用ID而不是影人的名字来进行数据分析。  </p>
<h4 id="获取影人信息"><a href="#获取影人信息" class="headerlink" title="获取影人信息"></a>获取影人信息</h4><p>因为需要对男女演员进行分别统计，所以我们对影人的详细信息又进行了获取，代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getCastInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">		File dirFile = <span class="keyword">new</span> File(FILEPATH);</div><div class="line">		File idFile = <span class="keyword">new</span> File(dirFile, <span class="string">"dir_id"</span>);</div><div class="line">		<span class="keyword">if</span> (!idFile.exists()) &#123;</div><div class="line">			System.err.println(<span class="string">"cast id file not exist!"</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		BufferedWriter writer;</div><div class="line">		BufferedReader reader;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File infoFile = <span class="keyword">new</span> File(dirFile, <span class="string">"dir_info"</span>);</div><div class="line">			<span class="keyword">if</span> (!infoFile.exists())</div><div class="line">				infoFile.createNewFile();</div><div class="line">			writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(infoFile, <span class="keyword">false</span>));</div><div class="line"></div><div class="line">			reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(idFile));</div><div class="line"></div><div class="line">			DoubanBookMovieMusicService instance = <span class="keyword">new</span> DoubanBookMovieMusicService();</div><div class="line">			DoubanCastObject result = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">			String id = <span class="string">""</span>;</div><div class="line">			<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				id = reader.readLine();</div><div class="line">				<span class="keyword">if</span> (id == <span class="keyword">null</span> || id.equals(<span class="string">"#"</span>))</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				count++;</div><div class="line">				System.out.println(count + <span class="string">": "</span> + id);</div><div class="line"></div><div class="line">				<span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">while</span> (flag) &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						result = instance.getMoviesCast(id);</div><div class="line">						flag = <span class="keyword">false</span>;</div><div class="line">					&#125; <span class="keyword">catch</span> (NoHttpResponseException | SocketTimeoutException e) &#123;</div><div class="line">						System.out.println(<span class="string">"NoHttpResponseException"</span>);</div><div class="line">						Thread.sleep(<span class="number">2000</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(result.getId() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getName() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getGender());</div><div class="line">				writer.newLine();</div><div class="line">				writer.flush();</div><div class="line">				Thread.sleep(<span class="number">4000</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			reader.close();</div><div class="line">			writer.close();</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"Get movie !"</span>);</div><div class="line"></div><div class="line">		&#125; <span class="keyword">catch</span> (IOException | DoubanException | InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>获取的部分演员信息如下(id，名字，性别)：</p>
<pre><code>1054521 蒂姆·罗宾斯 男
1054534 摩根·弗里曼 男
1041179 鲍勃·冈顿 男
1000095 威廉姆·赛德勒 男
1025182 让·雷诺 男
1054454 娜塔莉·波特曼 女
1010507 加里·奥德曼 男
1019050 丹尼·爱罗 男
1054450 汤姆·汉克斯 男
1002676 罗宾·怀特 女
1031848 加里·西尼斯 男
1031912 麦凯尔泰·威廉逊 男
1003494 张国荣 男
1050265 张丰毅 男
1035641 巩俐 女
</code></pre><p>获取的导演信息如下：  </p>
<pre><code>1047973 弗兰克·德拉邦特 男
1031876 吕克·贝松 男
1053564 罗伯特·泽米吉斯 男
1023040 陈凯歌 男
1041004 罗伯托·贝尼尼 男
1018983 朱塞佩·托纳多雷 男
1054440 史蒂文·斯皮尔伯格 男
1054439 宫崎骏 男  
</code></pre><h4 id="数据完善"><a href="#数据完善" class="headerlink" title="数据完善"></a>数据完善</h4><p>需要注意的是，获取的源数据形式并不规范，影人的名字格式多样，有的影人没有性别信息，所以对源数据进行过滤修正。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/09/10/slurm安装/" class="prev">PREV</a><a href="/2015/08/06/ubuntu14-04基本配置/" class="next">NEXT</a></div><div data-thread-key="2015/08/29/豆瓣电影Top250获取/" data-title="豆瓣电影Top250获取" data-url="http://itanch.github.io/2015/08/29/豆瓣电影Top250获取/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"tianchi"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2017 <a href="http://itanch.github.io">Tian chi</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>