<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Tianchi&#39;s Blog</title>
  <subtitle>é˜…è¯» æ€è€ƒ å®è·µ</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://itanch.github.io/"/>
  <updated>2017-04-09T07:51:30.000Z</updated>
  <id>http://itanch.github.io/</id>
  
  <author>
    <name>Tian chi</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯(2)</title>
    <link href="http://itanch.github.io/2017/04/08/%E7%94%A8React-Native%E5%86%99%E4%B8%80%E4%B8%AA%E5%BE%AE%E5%8D%9A%E5%AE%A2%E6%88%B7%E7%AB%AF-2/"/>
    <id>http://itanch.github.io/2017/04/08/ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯-2/</id>
    <published>2017-04-08T08:47:49.000Z</published>
    <updated>2017-04-09T07:51:30.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç”¨React-NativeæŠ€æœ¯å®ç°ä¸€ä¸ªç®€å•çš„å¾®åšå®¢æˆ·ç«¯ã€‚é¡¹ç›®å¼€æºåœ°å€ï¼š<a href="https://github.com/ITanCh/Welone" target="_blank" rel="external">github</a>ã€‚é¡¹ç›®è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ğŸ˜Šã€‚ </p>
</blockquote>
<h2 id="ä¸»ç•Œé¢è®¾è®¡"><a href="#ä¸»ç•Œé¢è®¾è®¡" class="headerlink" title="ä¸»ç•Œé¢è®¾è®¡"></a>ä¸»ç•Œé¢è®¾è®¡</h2><p>è¿›å…¥åº”ç”¨ï¼Œé¦–å…ˆçœ‹åˆ°çš„å°±æ˜¯ä¸»ç•Œé¢ï¼Œè¿™é‡Œé‡‡ç”¨äº†ç»å…¸çš„åº•éƒ¨3ä¸ªtabçš„ä¸»ç•Œé¢è®¾è®¡é£æ ¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<a id="more"></a>
<p><img src="http://7xky03.com1.z0.glb.clouddn.com/welone_3tab.gif?imageView2/0/h/300" alt="3tab"></p>
<p>react-native æ¡†æ¶å·²ç»ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªç®€å•çš„ä¸»ç•Œé¢äº<code>index.android.js</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">welone</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.welcome&#125;</span>&gt;</span></div><div class="line">          Welcome to React Native!</div><div class="line">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></div><div class="line">          To get started, edit index.ios.js</div><div class="line">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></div><div class="line">          Press Cmd+R to reload,&#123;'\n'&#125;</div><div class="line">          Cmd+D or shake for dev menu</div><div class="line">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">AppRegistry.registerComponent(<span class="string">'welone'</span>, () =&gt; welone);</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯å°†render()å‡½æ•°ä¸­çš„å†…å®¹æ›¿æ¢æˆæˆ‘ä»¬çš„componetã€‚è¿™é‡Œæˆ‘æ–°å»ºäº†ä¸€ä¸ªMainTabç»„å»ºï¼Œå¹¶ä¸”å°†å®ƒæ”¾ç½®äº<code>./app/comp/MainTab.android.js</code>ä¸­ï¼Œandroidåç¼€è¡¨æ˜ç¼–è¯‘androidåº”ç”¨æ—¶é€‰æ‹©è¯¥jsæ–‡ä»¶ä½œä¸ºç¼–è¯‘å¯¹è±¡ï¼Œè¿™æ ·ä½ ä¹Ÿå¯ä»¥å®ç°MainTab.ios.jsï¼Œä»è€Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç³»ç»Ÿé‡‡ç”¨ä¸åŒçš„è®¾è®¡å†…å®¹ã€‚è¿™é‡Œæˆ‘æ–°å»ºäº†ä¸€ä¸ªappç›®å½•ç”¨æ¥å­˜æ”¾ç»„ä»¶ç›¸å…³çš„ä»£ç å’Œèµ„æºï¼Œæˆ‘çš„æ–‡ä»¶ç»„ç»‡ç›®å½•å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://7xky03.com1.z0.glb.clouddn.com/welone_file.png?imageView2/0/h/200" alt="æ–‡ä»¶ç»“æ„"></p>
<p>ä¿®æ”¹åçš„<code>index.android.js</code>å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> MainTab <span class="keyword">from</span> <span class="string">'./app/comp/MainTab'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">welone</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="comment">//ä¸»ç•Œé¢çš„MainTabç»„ä»¶</span></div><div class="line">    <span class="keyword">let</span> mainComponent = MainTab;</div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      <span class="comment">//è¿™é‡Œæ˜¯ç”¨äº†Navigatorç»„ä»¶ï¼Œç›®çš„æ˜¯ä¸ºäº†ä»¥åçš„å¯¼èˆªæ ä½œç”¨</span></div><div class="line">      &lt;Navigator</div><div class="line">        initialRoute=&#123;&#123; <span class="attr">component</span>: mainComponent &#125;&#125;</div><div class="line">        configureScene=&#123;(route) =&gt; &#123;</div><div class="line">          <span class="keyword">return</span> Navigator.SceneConfigs.VerticalDownSwipeJump;</div><div class="line">        &#125;&#125;</div><div class="line">        renderScene=&#123;(route, navigator) =&gt; &#123;</div><div class="line">          <span class="comment">//è¿™é‡Œçš„ç»„å»ºå°±æ˜¯MainTab</span></div><div class="line">          <span class="keyword">let</span> Comp = route.component;</div><div class="line">          <span class="comment">//MainTab</span></div><div class="line">          <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Comp</span> &#123;<span class="attr">...route.params</span>&#125; <span class="attr">navigator</span>=<span class="string">&#123;navigator&#125;</span> /&gt;</span></span></div><div class="line">        &#125;&#125;</div><div class="line">      /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//...</div></pre></td></tr></table></figure>
<p>å…ˆå¿½ç•¥Navigatorç»„ä»¶åœ¨è¿™é‡Œçš„ä½œç”¨ï¼Œè¿™é‡Œå¯ä»¥å…ˆç†è§£ä¸ºä»¥MainTabä½œä¸ºå½“å‰çš„è§†å›¾çš„æ ¹viewï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">render() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">MainTab</span> /&gt;</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨<code>app/comp/MainTab.android.js</code>é‡Œï¼Œæˆ‘é‡‡ç”¨äº†åŒæ ·ç»å…¸çš„ä¸‰æ®µå¼é…åˆ3ä¸ªtabæ¥ä½¿ç”¨ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTab</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> (</div><div class="line">            &lt;Container theme=&#123;TianTheme&#125;&gt;</div><div class="line">                //å¤´éƒ¨æ ‡é¢˜ä¼šè·Ÿç€tabçš„åˆ‡æ¢å˜åŒ–</div><div class="line">                &lt;Header&gt;</div><div class="line">                 //æ ‡é¢˜å†…å®¹</div><div class="line">                &lt;/Header&gt;</div><div class="line"></div><div class="line">                //ä¸»ä½“ï¼Œæ˜¾ç¤ºå†…å®¹</div><div class="line">                &lt;Content style=&#123;&#123; backgroundColor: '#f8f9f9' &#125;&#125;&gt;</div><div class="line">                   //...</div><div class="line">                &lt;/Content&gt;</div><div class="line">                </div><div class="line">                //åº•éƒ¨ï¼Œæ˜¾ç¤º3ä¸ªtab</div><div class="line">                &lt;Footer style=&#123;&#123; borderTopWidth: 1, borderTopColor: '#e5e8e8' &#125;&#125;&gt;</div><div class="line">                    &lt;FooterTab&gt;</div><div class="line">                        &lt;Button onPress=&#123;() =&gt; this.onPressTab(TAB_LOVE)&#125;&gt;</div><div class="line">                            &lt;Icon name='ios-heart' /&gt;</div><div class="line">                        &lt;/Button&gt;</div><div class="line">                        &lt;Button onPress=&#123;() =&gt; this.onPressTab(TAB_ME)&#125;&gt;</div><div class="line">                            &lt;Icon name='ios-chatbubbles' /&gt;</div><div class="line">                        &lt;/Button&gt;</div><div class="line">                        &lt;Button onPress=&#123;() =&gt; this.onPressTab(TAB_SET)&#125;&gt;</div><div class="line">                            &lt;Icon name='ios-settings' /&gt;</div><div class="line">                        &lt;/Button&gt;</div><div class="line">                    &lt;/FooterTab&gt;</div><div class="line">                &lt;/Footer&gt;</div><div class="line">            &lt;/Container&gt;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­Containerã€Headerã€Contentã€Footerç­‰ç»„ä»¶çš†æ¥è‡ªäºNative-Baseã€‚æˆ‘çš„å»ºè®®æ˜¯èƒ½ç”¨åŸå§‹çš„react-nativeçš„ç»„å»ºå°±ç”¨åŸå§‹çš„ï¼ŒNative-Baseæä¾›çš„ç»„ä»¶è™½ç„¶ç¾è§‚ï¼Œä½†æ˜¯ç¼ºå°‘äº†å®šåˆ¶çš„çµæ´»æ€§ã€‚</p>
<p>å½“ç‚¹å‡»tabæ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°<code>onPressTab()</code>è§¦å‘viewçš„å˜åŒ–ã€‚æ ¹æ®ä¼ å…¥çš„å‚æ•°ç¡®å®šç”¨æˆ·ç‚¹å‡»çš„å“ªä¸€ä¸ªtabï¼Œç„¶åä¿®æ”¹å½“å‰çš„çŠ¶æ€ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ¶‰åŠä¿®æ”¹å½“å‰ç»„ä»¶çŠ¶æ€çš„æ“ä½œ<code>this.setState({ activeTab: tab })</code>ï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°é‡‡ç”¨<code>&lt;Button onPress={() =&gt; this.onPressTab(TAB_SET)}&gt;</code>è¿™ç§æ–¹å¼ä¸buttonç»‘å®šï¼Œè€Œä¸æ˜¯<code>&lt;Button onPress={this.onPressTab(TAB_SET)}&gt;</code>ã€‚åè€…åœ¨ä¸æ¶‰åŠä¿®æ”¹stateæ—¶å¹¶æ— å¤§ç¢ï¼Œå¦‚æœæ¶‰åŠä¿®æ”¹stateï¼Œä¸€å®šè¦é‡‡ç”¨å¼‚æ­¥æ“ä½œã€‚è®°ä½åƒä¸‡ä¸è¦åœ¨<code>render</code>å‡½æ•°ä¸­ç›´æ¥ä¿®æ”¹stateã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">onPressTab(tab) &#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">activeTab</span>: tab &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å†…å®¹æ˜¾ç¤º"><a href="#å†…å®¹æ˜¾ç¤º" class="headerlink" title="å†…å®¹æ˜¾ç¤º"></a>å†…å®¹æ˜¾ç¤º</h2><p>åœ¨MainTabç»„ä»¶ä¸­ï¼Œæ˜¾ç¤ºå†…å®¹çš„éƒ¨åˆ†éœ€è¦æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ä¾æ¬¡æ˜¾ç¤ºâ€œå…³æ³¨â€ã€â€œæ¶ˆæ¯â€å’Œâ€œè®¾ç½®â€ä¸‰ä¸ªæ¿å—ï¼Œä¸ºæ­¤æˆ‘è®¾è®¡äº†ä¸€ä¸ª<code>WeiboList</code>ç»„ä»¶æ¥æ˜¾ç¤ºå…·ä½“å†…å®¹ï¼Œå¹¶ä¸”ä½œä¸ºContentçš„å­ç»„ä»¶é•¶åµŒè¿›MainTabã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;Content style=&#123;&#123; <span class="attr">backgroundColor</span>: <span class="string">'#f8f9f9'</span> &#125;&#125;&gt;</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginHorizontal:</span> <span class="attr">7</span> &#125;&#125;&gt;</span></span></div><div class="line">        <span class="tag">&lt;<span class="name">WeiboList</span></span></div><div class="line">            <span class="attr">navigator</span>=<span class="string">&#123;this.props.navigator&#125;</span></div><div class="line">            //ä¿ç•™<span class="attr">weibolist</span>ç»„ä»¶çš„å¼•ç”¨</div><div class="line">            <span class="attr">ref</span>=<span class="string">&#123;(weiboList)</span> =&gt; &#123; this.weiboList = weiboList &#125;&#125;</div><div class="line">            //æŒ‡æ˜å½“å‰ç”¨æˆ·é€‰æ‹©çš„å“ªä¸€ä¸ªtab</div><div class="line">            tab=&#123;this.state.activeTab&#125;</div><div class="line">        /&gt;</div><div class="line">    <span class="tag">&lt;/<span class="name">View</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Content</span>&gt;</span></div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸ºWeiboListç»„ä»¶æ·»åŠ äº†å±æ€§<code>tab</code>ï¼Œæè¿°å½“å‰ç”¨æˆ·é€‰æ‹©çš„tabç±»å‹ã€‚åŒæ—¶ï¼Œä¸ºMainTabä¿ç•™äº†ä¸€ä¸ªweibolistçš„åº”ç”¨ï¼Œä¸ºçš„æ˜¯ä»MainTabç»„ä»¶ä¸­è°ƒç”¨WeiboListçš„å‡½æ•°ï¼Œå½“ç„¶è¿™ç§è®¾è®¡æ–¹å¼ä¸ç®—ä¼˜ç¾ï¼Œå°†æ¥æˆ‘ä¼šç”¨å…¶å®ƒæ–¹å¼è¿›è¡Œæ”¹è¿›ã€‚</p>
<p>åœ¨WeiboListç»„ä»¶ä¸­ï¼Œå®ç°render()å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">render() &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.props.tab === TAB_LOVE) &#123;</div><div class="line">           <span class="comment">//å…³æ³¨äººçš„å¾®åšåˆ—è¡¨</span></div><div class="line">           <span class="keyword">return</span> (</div><div class="line">               &lt;ListView</div><div class="line">                   //è®¾ç½®æ•°æ®æº</div><div class="line">                   dataSource=&#123;this.state.loveSource&#125;</div><div class="line">                   //åˆ—è¡¨ä¸­çš„å­ç»„ä»¶</div><div class="line">                   renderRow=&#123;(rowData) =&gt; &lt;WeiboCard weiData=&#123;rowData&#125; navigator=&#123;this.props.navigator&#125; /&gt;&#125;</div><div class="line">                   //åˆ—è¡¨åº•éƒ¨ç»„ä»¶</div><div class="line">                   renderFooter=&#123;() =&gt; this.getEnd(GET_MORE_WEIBO)&#125;</div><div class="line">               /&gt;</div><div class="line">           );</div><div class="line">       &#125; else if (this.props.tab === TAB_ME) &#123;</div><div class="line">           //ç”¨æˆ·æ¶ˆæ¯</div><div class="line">           //...</div><div class="line">       &#125; else &#123;</div><div class="line">           //ç”¨æˆ·è®¾ç½®</div><div class="line">           //...</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ¿å—ï¼Œè¿”å›ä¸åŒçš„ç»„ä»¶å†…å®¹ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸€ä¸‹å¾®åšå†…å®¹åˆ—è¡¨çš„å®ç°ï¼Œå…³äºå¾®åšç™»å½•è®¤è¯çš„æ¨¡å—ï¼Œå¯ä»¥å‚è€ƒæºä»£ç ã€‚</p>
<p>ä¸ºäº†æ˜¾ç¤ºåˆ—è¡¨ç»“æ„çš„å¾®åšå†…å®¹ï¼Œä½¿ç”¨äº†react-nativeè‡ªå¸¦çš„<code>ListView</code>ç»„ä»¶ï¼ŒListViewå¯ä»¥æ»šåŠ¨çš„ç°å®Viewå­ç»„ä»¶åˆ—è¡¨ã€‚å®ƒéœ€è¦è®¾ç½®ä¸¤ä¸ªé‡è¦å±æ€§ï¼Œ<code>dataSource</code>è¡¨ç¤ºæ•°æ®æ•°ç»„ï¼Œ<code>renderRow</code>åˆ™ä¼šå°†æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å–å‡ºæ¥ï¼Œæ¸²æŸ“ä¸€ä¸ªå­ç»„ä»¶ã€‚è¿™é‡Œæˆ‘è®¾è®¡äº†<code>WeiboCard</code>æ¥æ˜¾ç¤ºå¾®åšçš„å…·ä½“å†…å®¹ã€‚</p>
<p>dataSoureceçš„æ•°æ®æºæ¥è‡ª<code>this.state.loveSource</code>ï¼Œè¯¥çŠ¶æ€åœ¨WeiboListä¸­è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªDataSourceï¼Œå¹¶ä¸”è®¾ç½®åˆ¤æ–­å½“å‰è§†å›¾æ˜¯å¦å‘ç”Ÿæ»šåŠ¨çš„åˆ¤æ–­å‡½æ•°ï¼Œä»¥æ­¤æ¥å‡å°‘ç»˜åˆ¶åˆ—è¡¨çš„æ¶ˆè€—ã€‚</span></div><div class="line">    <span class="keyword">let</span> ds1 = <span class="keyword">new</span> ListView.DataSource(&#123; <span class="attr">rowHasChanged</span>: <span class="function">(<span class="params">r1, r2</span>) =&gt;</span> r1 !== r2 &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.state = &#123;</div><div class="line">        <span class="attr">loveSource</span>: ds1,</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">//ç”¨æ¥å­˜å‚¨å½“å‰è·å–çš„å¾®åšå†…å®¹æ•°ç»„</span></div><div class="line">    <span class="keyword">this</span>.loveData = [];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œè§†å›¾å·²ç»è®¾è®¡å®Œæ¯•ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ•°æ®ã€‚æ¥ä¸‹æ¥éœ€è¦å®Œæˆè·å–æ•°æ®çš„éƒ¨åˆ†ã€‚</p>
<p>##æ•°æ®è·å–</p>
<p>è¿™é‡Œé‡‡ç”¨çš„å¾®åšapiçš„Androidç‰ˆæœ¬ï¼Œæ˜¯ä¸€ä¸ªjavaåº“ï¼Œå¹¸è¿çš„æ˜¯react-nativeæä¾›äº†æ¥å£è®©æˆ‘ä»¬å¼€å‘åŸç”Ÿæ¨¡å—åœ¨jsä¸­è°ƒç”¨ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç ”ç©¶ä¸€ä¸‹æ˜¯å¦å¯ä»¥ç›´æ¥è°ƒç”¨å¾®åšçš„jsåº“ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸‹å¾®åšapiä¸­æä¾›äº†ä»€ä¹ˆæ ·çš„æ¥å£ä¾›å¼€å‘è€…è°ƒç”¨ã€‚åœ¨<code>com/sina/weibo/sdk/openapi/StatusesAPI.java</code>ä¸­ï¼Œæä¾›äº†ä¸€äº›ä¸è·å–å¾®åšå†…å®¹æœ‰å…³çš„å‡½æ•°ï¼Œå¹¶ä¸”æä¾›äº†è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨çš„å°±æ˜¯å¦‚ä¸‹æ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * è·å–å½“å‰ç™»å½•ç”¨æˆ·åŠå…¶æ‰€å…³æ³¨ç”¨æˆ·çš„æœ€æ–°å¾®åšã€‚</div><div class="line"> * </div><div class="line"> * <span class="doctag">@param</span> since_id    è‹¥æŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™è¿”å›IDæ¯”since_idå¤§çš„å¾®åšï¼ˆå³æ¯”since_idæ—¶é—´æ™šçš„å¾®åšï¼‰ï¼Œé»˜è®¤ä¸º0</div><div class="line"> * <span class="doctag">@param</span> max_id      è‹¥æŒ‡å®šæ­¤å‚æ•°ï¼Œåˆ™è¿”å›IDå°äºæˆ–ç­‰äºmax_idçš„å¾®åšï¼Œé»˜è®¤ä¸º0ã€‚</div><div class="line"> * <span class="doctag">@param</span> count       å•é¡µè¿”å›çš„è®°å½•æ¡æ•°ï¼Œé»˜è®¤ä¸º50ã€‚</div><div class="line"> * <span class="doctag">@param</span> page        è¿”å›ç»“æœçš„é¡µç ï¼Œé»˜è®¤ä¸º1ã€‚</div><div class="line"> * <span class="doctag">@param</span> base_app    æ˜¯å¦åªè·å–å½“å‰åº”ç”¨çš„æ•°æ®ã€‚falseä¸ºå¦ï¼ˆæ‰€æœ‰æ•°æ®ï¼‰ï¼Œtrueä¸ºæ˜¯ï¼ˆä»…å½“å‰åº”ç”¨ï¼‰ï¼Œé»˜è®¤ä¸ºfalseã€‚</div><div class="line"> * <span class="doctag">@param</span> featureType è¿‡æ»¤ç±»å‹IDï¼Œ0ï¼šå…¨éƒ¨ã€1ï¼šåŸåˆ›ã€2ï¼šå›¾ç‰‡ã€3ï¼šè§†é¢‘ã€4ï¼šéŸ³ä¹ï¼Œé»˜è®¤ä¸º0ã€‚</div><div class="line"> *                    &lt;li&gt;&#123;<span class="doctag">@link</span> #FEATURE_ALL&#125;</div><div class="line"> *                    &lt;li&gt;&#123;<span class="doctag">@link</span> #FEATURE_ORIGINAL&#125;</div><div class="line"> *                    &lt;li&gt;&#123;<span class="doctag">@link</span> #FEATURE_PICTURE&#125;</div><div class="line"> *                    &lt;li&gt;&#123;<span class="doctag">@link</span> #FEATURE_VIDEO&#125;</div><div class="line"> *                    &lt;li&gt;&#123;<span class="doctag">@link</span> #FEATURE_MUSICE&#125;</div><div class="line"> * <span class="doctag">@param</span> trim_user   è¿”å›å€¼ä¸­userå­—æ®µå¼€å…³ï¼Œfalseï¼šè¿”å›å®Œæ•´userå­—æ®µã€trueï¼šuserå­—æ®µä»…è¿”å›user_idï¼Œé»˜è®¤ä¸ºfalseã€‚</div><div class="line"> * <span class="doctag">@param</span> listener    å¼‚æ­¥è¯·æ±‚å›è°ƒæ¥å£</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">friendsTimeline</span><span class="params">(<span class="keyword">long</span> since_id, <span class="keyword">long</span> max_id, <span class="keyword">int</span> count, <span class="keyword">int</span> page, <span class="keyword">boolean</span> base_app,</span></span></div><div class="line">        <span class="keyword">int</span> featureType, <span class="keyword">boolean</span> trim_user, RequestListener listener) &#123;</div><div class="line">    WeiboParameters params = </div><div class="line">            buildTimeLineParamsBase(since_id, max_id, count, page, base_app, trim_user, featureType);</div><div class="line">    requestAsync(sAPIList.get(READ_API_FRIENDS_TIMELINE), params, HTTPMETHOD_GET, listener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨Androidé¡¹ç›®æ–‡ä»¶å¤¹ä¸‹æ·»åŠ äº†å¾®åšæ¨¡å—ï¼š<code>android/app/src/main/java/com/welone/weibo/WeiboModule.java</code>ã€‚å®ç°äº†å¦‚ä¸‹å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * get the status of your friends</div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> sinceId</div><div class="line">  * <span class="doctag">@param</span> maxId</div><div class="line">  * <span class="doctag">@param</span> successCallback</div><div class="line">  * <span class="doctag">@param</span> errorCallback</div><div class="line">  */</div><div class="line"> <span class="meta">@ReactMethod</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTimeline</span><span class="params">(String sinceId, String maxId, Callback successCallback, Callback errorCallback)</span> </span>&#123;</div><div class="line">     <span class="comment">//è·å–è®¤è¯token</span></div><div class="line">     Oauth2AccessToken token = AccessTokenKeeper.getAccessToken();</div><div class="line">     <span class="keyword">if</span> (token != <span class="keyword">null</span> &amp;&amp; token.isSessionValid()) &#123;</div><div class="line">         <span class="keyword">if</span> (mStatusesAPI == <span class="keyword">null</span>) &#123;</div><div class="line">             mStatusesAPI = <span class="keyword">new</span> StatusesAPI(getCurrentActivity(), Constants.APP_KEY, token);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             <span class="keyword">long</span> since = Long.parseLong(sinceId);</div><div class="line">             <span class="keyword">long</span> max = Long.parseLong(maxId);</div><div class="line">             <span class="comment">//è°ƒç”¨äº†friendsTimelineçš„åŒæ­¥ç‰ˆæœ¬ï¼Œå› ä¸ºè¯¥å‡½æ•°å·²ç»æ˜¯å¼‚æ­¥è°ƒç”¨,</span></div><div class="line">             <span class="comment">//æ²¡å¿…è¦å†åµŒå¥—ä¸€æ¬¡å¼‚æ­¥è°ƒç”¨</span></div><div class="line">             String info = mStatusesAPI.friendsTimelineSync(since, max, <span class="number">20</span>, <span class="number">1</span>, <span class="keyword">false</span>, <span class="number">0</span>, <span class="keyword">false</span>);</div><div class="line">             <span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp; info.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                 <span class="comment">//è·å–å†…å®¹æˆåŠŸ</span></div><div class="line">                 successCallback.invoke(info);</div><div class="line">             &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 <span class="comment">//è·å–å†…å®¹å¤±è´¥</span></div><div class="line">                 errorCallback.invoke(<span class="string">"Get weibo error.."</span>);</div><div class="line">             &#125;</div><div class="line">         &#125; <span class="keyword">catch</span> (com.sina.weibo.sdk.exception.WeiboException e) &#123;</div><div class="line">             errorCallback.invoke(<span class="string">"Please open the Internet :)"</span>);</div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         errorCallback.invoke(<span class="string">"Get user information: token error.."</span>);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>@ReactMethod</code>æ ‡ç­¾æŒ‡æ˜è¯¥å‡½æ•°ä¸ºä¸€ä¸ªreact-nativeå‡½æ•°ï¼Œå°†ä¼šæš´éœ²åœ¨jséƒ¨åˆ†ä½¿ç”¨ã€‚è®¾è®¡å¥½å‡½æ•°æ¥å£ï¼Œéœ€è¦è®²æ¨¡å—æ·»åŠ åˆ°åº”ç”¨åŒ…é‡Œé¢ã€‚</p>
<p>åœ¨android/app/src/main/java/com/welone/weibo/WeiboPackage.javaä¸­ï¼Œ<br>åˆ›å»ºä¸€ä¸ªReactPackageï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeiboPackage</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</div><div class="line">    <span class="comment">//æ·»åŠ è‡ªå·±å®šåˆ¶çš„åŸç”ŸåŠŸèƒ½æ¨¡å—</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;NativeModule&gt; <span class="title">createNativeModules</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</div><div class="line">        List&lt;NativeModule&gt; modules = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        <span class="comment">//è¿™é‡Œç›®å‰å°±ä¸€ä¸ªweiboæ¨¡å—</span></div><div class="line">        modules.add(<span class="keyword">new</span> WeiboModule(reactContext));</div><div class="line">        <span class="keyword">return</span> modules;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å¯ä»¥æ·»åŠ jsæ¨¡å—åœ¨åŸç”Ÿä»£ç ä¸­ä½¿ç”¨</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends JavaScriptModule&gt;&gt; createJSModules() &#123;</div><div class="line">        <span class="keyword">return</span> Collections.emptyList();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å®šåˆ¶åŸç”Ÿviewæä¾›ç»™jséƒ¨åˆ†ä½¿ç”¨</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;ViewManager&gt; <span class="title">createViewManagers</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Collections.emptyList();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œreact-nativeä¸ä»…å¯ä»¥å®šåˆ¶åŠŸèƒ½æ¨¡å—ï¼Œè¿˜å¯ä»¥å®šåˆ¶åŸç”Ÿviewç»™jsä½¿ç”¨ã€‚</p>
<p>åœ¨android/app/src/main/java/com/welone/MainApplication.javaä¸‹æ·»åŠ ReactPackageï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReactNativeHost mReactNativeHost = <span class="keyword">new</span> ReactNativeHost(<span class="keyword">this</span>) &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">getUseDeveloperSupport</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> BuildConfig.DEBUG;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> List&lt;ReactPackage&gt; <span class="title">getPackages</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Arrays.&lt;ReactPackage&gt;asList(</div><div class="line">                <span class="comment">//react-nativeè‡ªå·±çš„åŒ…</span></div><div class="line">                <span class="keyword">new</span> MainReactPackage(),</div><div class="line">                <span class="comment">//å› ä¸ºä½¿ç”¨native-baseå¼•å…¥çš„åŒ…</span></div><div class="line">                <span class="keyword">new</span> VectorIconsPackage(),</div><div class="line">                <span class="comment">//è‡ªå·±å®šä¹‰çš„å¾®åšåŒ…</span></div><div class="line">                <span class="keyword">new</span> WeiboPackage()</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å†™å¥½åŸç”Ÿéƒ¨åˆ†çš„æ¨¡å—ï¼Œæ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•åœ¨jséƒ¨åˆ†è¿›è¡Œä½¿ç”¨ã€‚é¦–å…ˆåˆ›å»ºæ–‡ä»¶app/comp/module/WeiboModule.android.jsï¼Œå°†å®šä¹‰çš„æ¨¡å—å¼•å…¥å¹¶ä¸”æš´éœ²ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; NativeModules &#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> NativeModules.WeiboModule;</div></pre></td></tr></table></figure>
<p>åœ¨WeiboListæ¨¡å—è°ƒç”¨getTimelineå‡½æ•°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Get the weibo of the user's friends</span></div><div class="line">getTimeLine(type) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">let</span> since = <span class="number">0</span>;</div><div class="line">    <span class="keyword">let</span> max = <span class="number">0</span>;</div><div class="line">    <span class="comment">//è°ƒç”¨åŸç”Ÿæ¨¡å—å®ç°çš„å‡½æ•°ï¼Œå‚æ•°è¦ä¸€ä¸€å¯¹åº”</span></div><div class="line">    WeiboModule.getTimeline(</div><div class="line">        since.toString(),</div><div class="line">        max.toString(),</div><div class="line">        <span class="comment">//æˆåŠŸçš„å›è°ƒå‡½æ•°</span></div><div class="line">        (success) =&gt; &#123;</div><div class="line">            <span class="keyword">if</span> (success.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">let</span> tl = <span class="built_in">JSON</span>.parse(success);</div><div class="line">                <span class="keyword">let</span> statuses = tl.statuses;</div><div class="line">                <span class="keyword">if</span> (statuses.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                   </div><div class="line">                    <span class="comment">//è·å–å†…å®¹æ•°ç»„</span></div><div class="line">                    <span class="keyword">this</span>.loveData = statuses;</div><div class="line">                    ToastAndroid.showWithGravity(<span class="string">`æœ‰<span class="subst">$&#123;statuses.length&#125;</span>æ¡æ–°å¾®åš :)`</span>, ToastAndroid.SHORT, ToastAndroid.CENTER);</div><div class="line"> </div><div class="line">                    <span class="comment">//æ›´æ–°åˆ—è¡¨</span></div><div class="line">                    <span class="keyword">this</span>.setState(&#123;</div><div class="line">                        <span class="attr">loveSource</span>: <span class="keyword">this</span>.state.loveSource.cloneWithRows(<span class="keyword">this</span>.loveData)</div><div class="line">                    &#125;);</div><div class="line">                &#125; </div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">//å¤±è´¥çš„å›è°ƒå‡½æ•°</span></div><div class="line">        (err) =&gt; &#123;</div><div class="line">            ToastAndroid.showWithGravity(err, ToastAndroid.SHORT, ToastAndroid.CENTER);</div><div class="line">            <span class="keyword">this</span>.gettingTimeLine = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å®ç°getTimeLineå‡½æ•°åå¯ä»¥åœ¨é€‚å½“çš„åœ°æ–¹è°ƒç”¨ï¼Œè·å–å¾®åšå†…å®¹ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå®ç°äº†åº”ç”¨è·å–å¾®åšå†…å®¹ï¼Œå¹¶ä¸”è¿›è¡Œæ˜¾ç¤ºçš„åŠŸèƒ½ã€‚å…¶å®ƒåŠŸèƒ½ï¼Œæ¯”å¦‚è·å–è¯„è®ºç­‰ï¼Œå®ç°è¿‡ç¨‹ç±»ä¼¼ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç”¨React-NativeæŠ€æœ¯å®ç°ä¸€ä¸ªç®€å•çš„å¾®åšå®¢æˆ·ç«¯ã€‚é¡¹ç›®å¼€æºåœ°å€ï¼š&lt;a href=&quot;https://github.com/ITanCh/Welone&quot;&gt;github&lt;/a&gt;ã€‚é¡¹ç›®è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ğŸ˜Šã€‚ &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ä¸»ç•Œé¢è®¾è®¡&quot;&gt;&lt;a href=&quot;#ä¸»ç•Œé¢è®¾è®¡&quot; class=&quot;headerlink&quot; title=&quot;ä¸»ç•Œé¢è®¾è®¡&quot;&gt;&lt;/a&gt;ä¸»ç•Œé¢è®¾è®¡&lt;/h2&gt;&lt;p&gt;è¿›å…¥åº”ç”¨ï¼Œé¦–å…ˆçœ‹åˆ°çš„å°±æ˜¯ä¸»ç•Œé¢ï¼Œè¿™é‡Œé‡‡ç”¨äº†ç»å…¸çš„åº•éƒ¨3ä¸ªtabçš„ä¸»ç•Œé¢è®¾è®¡é£æ ¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
      <category term="React Native" scheme="http://itanch.github.io/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>2017ä¹¦å•</title>
    <link href="http://itanch.github.io/2017/04/07/2017%E4%B9%A6%E5%8D%95/"/>
    <id>http://itanch.github.io/2017/04/07/2017ä¹¦å•/</id>
    <published>2017-04-07T06:56:08.000Z</published>
    <updated>2017-04-07T12:52:40.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ä¹¦ç±æ˜¯äººç±»é€€æ­¥çš„æ»‘æ»‘æ¢¯</p>
</blockquote>
<a id="more"></a>
<h2 id="1-æ— å£°å‘Š-ğŸŠ"><a href="#1-æ— å£°å‘Š-ğŸŠ" class="headerlink" title="1. æ— å£°å‘Š ğŸŠ"></a>1. æ— å£°å‘Š ğŸŠ</h2><p><img src="https://images-cn.ssl-images-amazon.com/images/I/51IhLqZfCML._SY346_.jpg" alt=""></p>
<p>ç»“æŸæ—¶é—´ï¼š01-05</p>
<p>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</p>
<p>æˆä¸ºè‡ªå·±ï¼Œè¿˜æ˜¯æˆä¸ºåˆ«äººæœŸæœ›çš„è‡ªå·±ï¼Ÿ</p>
<h2 id="2-æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-â˜•ï¸"><a href="#2-æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-â˜•ï¸" class="headerlink" title="2. æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº â˜•ï¸"></a>2. æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº â˜•ï¸</h2><p><img src="https://images-cn.ssl-images-amazon.com/images/I/5187D1yRGYL._SY346_.jpg" alt=""></p>
<p>ç»“æŸæ—¶é—´ï¼š01-29 </p>
<p>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</p>
<p>äº†è§£jvmçš„è®¾è®¡åŸç†ã€‚</p>
<h2 id="3-æ·±å…¥æµ…å‡ºnodejs-ğŸš€"><a href="#3-æ·±å…¥æµ…å‡ºnodejs-ğŸš€" class="headerlink" title="3. æ·±å…¥æµ…å‡ºnodejs ğŸš€"></a>3. æ·±å…¥æµ…å‡ºnodejs ğŸš€</h2><p><img src="https://images-cn.ssl-images-amazon.com/images/I/410MzJTNnQL.jpg" alt=""></p>
<p>ç»“æŸæ—¶é—´ï¼š02-15</p>
<p>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</p>
<p>äº†è§£nodejsçš„è®¾è®¡åŸç†ã€‚</p>
<h2 id="4-Androidç¼–ç¨‹æƒå¨æŒ‡å—-â›³"><a href="#4-Androidç¼–ç¨‹æƒå¨æŒ‡å—-â›³" class="headerlink" title="4. Androidç¼–ç¨‹æƒå¨æŒ‡å— â›³"></a>4. Androidç¼–ç¨‹æƒå¨æŒ‡å— â›³</h2><p><img src="https://images-cn.ssl-images-amazon.com/images/I/51qRgj3a3HL._SX260_.jpg" alt=""></p>
<p>ç»“æŸæ—¶é—´ï¼š03-26</p>
<p>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</p>
<p>ä»å…·ä½“çš„é¡¹ç›®å­¦ä¹ Androidå¼€å‘ä¸­çš„ç»„ä»¶ä½¿ç”¨æŠ€å·§ã€‚</p>
<h2 id="5-ç¨‹åºå‘˜é¢è¯•é‡‘å…¸-ğŸ€„ï¸"><a href="#5-ç¨‹åºå‘˜é¢è¯•é‡‘å…¸-ğŸ€„ï¸" class="headerlink" title="5. ç¨‹åºå‘˜é¢è¯•é‡‘å…¸ ğŸ€„ï¸"></a>5. ç¨‹åºå‘˜é¢è¯•é‡‘å…¸ ğŸ€„ï¸</h2><p><img src="https://images-cn.ssl-images-amazon.com/images/I/51JAeNnnosL.jpg" alt=""></p>
<p>ç»“æŸæ—¶é—´ï¼š04-07</p>
<p>æ¨èæŒ‡æ•°ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</p>
<p>å¾ˆç»å…¸çš„é¢è¯•æŒ‡å—ï¼Œå¯¹ç»å…¸çš„ç®—æ³•è€ƒé¢˜è¿›è¡Œäº†å±‚å±‚æ·±å…¥çš„è§£æã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä¹¦ç±æ˜¯äººç±»é€€æ­¥çš„æ»‘æ»‘æ¢¯&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="è®°å½•" scheme="http://itanch.github.io/tags/%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯(1)</title>
    <link href="http://itanch.github.io/2017/04/06/%E7%94%A8React-Native%E5%86%99%E4%B8%80%E4%B8%AA%E5%BE%AE%E5%8D%9A%E5%AE%A2%E6%88%B7%E7%AB%AF-1/"/>
    <id>http://itanch.github.io/2017/04/06/ç”¨React-Nativeå†™ä¸€ä¸ªå¾®åšå®¢æˆ·ç«¯-1/</id>
    <published>2017-04-06T12:01:14.000Z</published>
    <updated>2017-04-06T15:18:06.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç”¨React-NativeæŠ€æœ¯å®ç°ä¸€ä¸ªç®€å•çš„å¾®åšå®¢æˆ·ç«¯ã€‚é¡¹ç›®å¼€æºåœ°å€ï¼š<a href="https://github.com/ITanCh/Welone" target="_blank" rel="external">github</a>ã€‚é¡¹ç›®è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ğŸ˜Šã€‚   </p>
</blockquote>
<p>å¼€å‘ç¯å¢ƒï¼šmacOS</p>
<a id="more"></a>
<p>éƒ¨åˆ†æ•ˆæœï¼š  </p>
<p><img src="http://7xky03.com1.z0.glb.clouddn.com/welone_gif_2.gif?imageView2/0/h/300" alt=""></p>
<p><img src="http://7xky03.com1.z0.glb.clouddn.com/welone_gif_1.gif?imageView2/0/h/300" alt=""> </p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>å¦‚ä½•å®‰è£…<a href="https://facebook.github.io/react-native/docs/getting-started.html" target="_blank" rel="external">å®˜ç½‘</a>å¾ˆæ¸…æ¥šï¼Œå¦‚æœç½‘é¡µæ‰“ä¸å¼€å¯ä»¥å‚è€ƒ<a href="http://reactnative.cn/docs/0.40/getting-started.html#content" target="_blank" rel="external">å›½å†…æ–‡æ¡£</a>ã€‚</p>
<p>é¦–å…ˆå®‰è£…nodeå’Œwatchmanã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">brew install node </div><div class="line">brew install watchman</div></pre></td></tr></table></figure>
<p>ç„¶åå®‰è£…react native cliã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g react-native-cli</div></pre></td></tr></table></figure>
<p>å®‰è£…Androidå¼€å‘ç¯å¢ƒå°±ä¸å†èµ˜è¿°ã€‚ </p>
<p>åˆ›å»ºé¡¹ç›®ã€è¿è¡Œé¡¹ç›®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">react-native init AwesomeProject </div><div class="line">cd AwesomeProject </div><div class="line">react-native run-android</div></pre></td></tr></table></figure>
<p>è¿™æ ·å¯ä»¥ç›´æ¥å°†åº”ç”¨åœ¨æ‰‹æœºä¸Šè¿è¡Œèµ·æ¥ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ™ƒåŠ¨æ‰‹æœºï¼ˆğŸ˜“ï¼‰æ¥å”¤å‡ºå‘½ä»¤ç•Œé¢ï¼Œè¿›è¡ŒåŠ¨æ€çš„æ›´æ–°jså®ç°çš„åŠŸèƒ½ã€‚ä½†æ˜¯è¿™æ ·çš„è¿è¡Œçš„åº”ç”¨æ€§èƒ½å¹¶ä¸é«˜ï¼Œä»…ä»…é€‚ç”¨äºè°ƒè¯•ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦æ‰“åŒ…è¿›è¡Œå‘å¸ƒã€‚</p>
<h2 id="æ‰“åŒ…å‘å¸ƒ"><a href="#æ‰“åŒ…å‘å¸ƒ" class="headerlink" title="æ‰“åŒ…å‘å¸ƒ"></a>æ‰“åŒ…å‘å¸ƒ</h2><p>ç”Ÿæˆç­¾åå¯†é’¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">keytool -genkey -v -keystore my-release-key.keystore -alias tianchi -keyalg RSA -keysize 2048 -validity 10000</div></pre></td></tr></table></figure>  
<p><code>-alias</code>åçš„å‚æ•°ä½ å¯ä»¥èµ·ä¸ªå¥½å¬çš„åå­—ï¼Œæ¯”å¦‚â€œtianchiâ€ã€‚è¿™é‡Œè®¾ç½®äº†10000å¤©çš„æœ‰æ•ˆæœŸã€‚   </p>
<p>è®¾ç½®gradleå˜é‡ã€‚å¤šè°¢è¿™äº›æˆç†Ÿçš„æ„å»ºå·¥å…·å’Œæ¡†æ¶ï¼Œreact-nativeåœ¨åˆ›å»ºandroidé¡¹ç›®æ—¶å·²ç»å¸®ä½ ç”Ÿæˆäº†ä¸€ä¸ªå¾ˆå®Œå–„çš„gradleé…ç½®æ–‡ä»¶ï¼Œä¸‹é¢éœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹æ¥æ»¡è¶³è‡ªå·±çš„å®šåˆ¶éœ€æ±‚ã€‚</p>
<p>æŠŠç”Ÿæˆçš„my-release-key.keystoreæ–‡ä»¶æ”¾åˆ°android/appä¸‹é¢ï¼Œç„¶ååœ¨ç”¨æˆ·Homeä¸‹åˆ›å»ºå¹¶ä¸”ç¼–è¾‘<code>~/.gradle/gradle.properties</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">MYAPP_RELEASE_STORE_FILE=my-release-key.keystore</div><div class="line">MYAPP_RELEASE_KEY_ALIAS=tianchi</div><div class="line">MYAPP_RELEASE_STORE_PASSWORD=******</div><div class="line">MYAPP_RELEASE_KEY_PASSWORD=******</div></pre></td></tr></table></figure>
<p>æ·»åŠ ç­¾åæ–‡ä»¶åˆ°<code>android/app/build.gradle</code>ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Attention!!! You shuld use your own release key!!!</span></div><div class="line">signingConfigs &#123;</div><div class="line">    release &#123;</div><div class="line">        storeFile file(MYAPP_RELEASE_STORE_FILE)</div><div class="line">        storePassword MYAPP_RELEASE_STORE_PASSWORD</div><div class="line">        keyAlias MYAPP_RELEASE_KEY_ALIAS</div><div class="line">        keyPassword MYAPP_RELEASE_KEY_PASSWORD</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ··æ·†å‹ç¼©apkã€‚åœ¨<code>android/app/build.gradle</code>æ–‡ä»¶ä¸­ï¼Œä¿®æ”¹ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Run Proguard to shrink the Java bytecode in release builds.</span></div><div class="line"><span class="keyword">def</span> enableProguardInReleaseBuilds = <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>æ‰“åŒ…å’Œå®‰è£…ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./gradlew assembleRelease</div><div class="line">./gradlew installRelease</div></pre></td></tr></table></figure></p>
<h2 id="å¼•å…¥å¾®åšapi"><a href="#å¼•å…¥å¾®åšapi" class="headerlink" title="å¼•å…¥å¾®åšapi"></a>å¼•å…¥å¾®åšapi</h2><p>è¿›å…¥å¾®<a href="http://open.weibo.com/apps" target="_blank" rel="external">åšå¼€å‘å¹³å°</a>ï¼Œç”³è¯·ä¸€ä¸ªå¼€å‘è€…è´¦å·ï¼Œåˆ›å»ºä¸€ä¸ªç§»åŠ¨åº”ç”¨ï¼Œå…³é”®æ˜¯å¾—åˆ°ä¸€ä¸ªapp keyã€‚ç„¶åç ”ç©¶weiboæä¾›çš„android sdk<a href="https://github.com/sinaweibosdk/weibo_android_sdk" target="_blank" rel="external">æ–‡æ¡£</a>ã€‚</p>
<p>è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¦æƒ³æˆåŠŸä½¿ç”¨å¾®åšçš„apiï¼Œä½ é¦–å…ˆè¦åœ¨å¾®åšå¼€å‘å¹³å°&gt;åº”ç”¨ä¿¡æ¯&gt;æµ‹è¯•ä¿¡æ¯ä¸­å¡«å†™ä½ çš„æµ‹è¯•è´¦å·ï¼Œå¦åˆ™æ— æ³•ç™»é™†ã€‚åŒæ—¶ï¼Œå°†ä½ çš„å¼€å‘çš„appå®‰è£…åˆ°æ‰‹æœºä¸Šï¼Œç”¨å¾®åšæä¾›çš„<code>app_signatures.apk</code>è·å¾—è¯¥åº”ç”¨çš„Androidç­¾åï¼Œç„¶åå¡«å†™åˆ°å¾®åšå¼€å‘å¹³å°&gt;åº”ç”¨ä¿¡æ¯&gt;åŸºæœ¬ä¿¡æ¯ä¸­çš„<code>AndroidåŒ…åï¼šcom.welone</code>å’Œ<code>Androidç­¾å:xxxxä½ è·å¾—çš„ç­¾åxxxxxxx</code>ã€‚å®Œæˆä»¥ä¸Šä¸¤ä¸ªæ­¥éª¤æ‰èƒ½æ­£å¸¸ä½¿ç”¨å¾®åšçš„apiï¼Œå‘µå‘µã€‚  </p>
<p>ä¸‹é¢éœ€è¦é€šè¿‡gradleå¼•å…¥å¾®åšçš„apiï¼Œå®˜ç½‘æœ€è¿‘ç‰ˆæœ¬å·²ç»æä¾›äº†gradleçš„å¼•å…¥æ–¹å¼ï¼Œä½†æ˜¯ç§»é™¤äº†open apiçš„åŠŸèƒ½ã€‚å› ä¸ºæˆ‘æ˜¯ç”¨çš„æ˜¯æ—§çš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä½¿ç”¨äº†open apiï¼Œæ‰€ä»¥å¼•å…¥äº†ä¸€ä¸ªå…¶ä»–å¼€å‘è€…æä¾›çš„å¾®åšapiä»“åº“ã€‚åœ¨<code>android/app/build.gradle</code>ä¸­ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">repositories &#123;</div><div class="line">    jcenter()</div><div class="line">    maven &#123; url <span class="string">"https://jitpack.io"</span> &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    compile <span class="string">'com.github.8tory:weibo-android-sdk:-SNAPSHOT'</span></div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>åœ¨æ„å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨çš„ä¸‹è½½è¯¥åº“è¿›è¡Œç¼–è¯‘ã€‚</p>
<h2 id="è®©ä½ çš„UIæ›´å¥½çœ‹"><a href="#è®©ä½ çš„UIæ›´å¥½çœ‹" class="headerlink" title="è®©ä½ çš„UIæ›´å¥½çœ‹"></a>è®©ä½ çš„UIæ›´å¥½çœ‹</h2><p>ä½¿ç”¨react-nativeæä¾›çš„componentæ¯”è¾ƒæœ´ç´ ï¼Œå½“ç„¶è‡ªå·±å¯ä»¥é€šè¿‡è°ƒåˆ¶åˆ›å»ºå‡ºæ¼‚äº®çš„ç»„å»ºã€‚è¿™é‡Œï¼Œæœ‰<a href="http://nativebase.io/docs/v0.5.13/getting-started#" target="_blank" rel="external">NativeBase</a>å·²ç»å¸®æˆ‘ä»¬åˆ›å»ºå¥½äº†ï¼Œå®˜ç½‘æä¾›äº†å¾ˆè¯¦ç»†çš„å®‰è£…æ•™ç¨‹ï¼Œè¿™é‡Œå…ˆå®‰è£…å¥½ï¼Œæˆ‘ä»¬å°†æ¥è¦ä½¿ç”¨ã€‚å…¶ä¸­<code>react-native-vector-icons</code>ç»„ä»¶éœ€è¦ç‰¹æ®Šçš„é…ç½®ä¸€ä¸‹ã€‚</p>
<blockquote>
<p>è¿™é‡Œä¸»è¦ä»‹ç»äº†å¼€å§‹ç¼–å†™ä¸€ä¸ªreact-nativeçš„å¾®åšå®¢æˆ·ç«¯çš„å‡†å¤‡å·¥ä½œï¼Œä¸‹é¢ä¸€ç« å°†ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç”¨React-NativeæŠ€æœ¯å®ç°ä¸€ä¸ªç®€å•çš„å¾®åšå®¢æˆ·ç«¯ã€‚é¡¹ç›®å¼€æºåœ°å€ï¼š&lt;a href=&quot;https://github.com/ITanCh/Welone&quot;&gt;github&lt;/a&gt;ã€‚é¡¹ç›®è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ğŸ˜Šã€‚   &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¼€å‘ç¯å¢ƒï¼šmacOS&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
      <category term="React Native" scheme="http://itanch.github.io/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>Java çŸ¥è¯†ç‚¹</title>
    <link href="http://itanch.github.io/2017/03/26/Java%E6%8D%A1%E6%BC%8F/"/>
    <id>http://itanch.github.io/2017/03/26/Javaæ¡æ¼/</id>
    <published>2017-03-26T09:01:59.000Z</published>
    <updated>2017-04-06T12:02:19.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>åœ¨æœ¬ç§‘æ—¶æ²¡æœ‰å¥½å¥½å¬è€å¸ˆè®²è¯¾ï¼Œç°åœ¨åªèƒ½é‡æ–°å†å­¦å­¦Javaï¼ŒğŸ˜­ã€‚</p>
</blockquote>
<h2 id="æˆ‘çš„javaç¯å¢ƒ"><a href="#æˆ‘çš„javaç¯å¢ƒ" class="headerlink" title="æˆ‘çš„javaç¯å¢ƒ"></a>æˆ‘çš„javaç¯å¢ƒ</h2><blockquote>
<p>java version â€œ1.8.0_121â€<br>Java(TM) SE Runtime Environment (build 1.8.0_121-b13)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)</p>
</blockquote>
<h2 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h2><p><strong>bootstrap classloader</strong>: åŠ è½½javaçš„æ ¸å¿ƒåº“çš„ç±»ã€‚<br><strong>ExtClassLoader</strong>: åŠ è½½æ‰©å±•çš„javaåº“ä¸­çš„ç±»ã€‚<br><strong>AppClassLoader</strong>: åŠ è½½åº”ç”¨ä¸­çš„ç±»ã€‚</p>
<a id="more"></a>
<h2 id="i"><a href="#i" class="headerlink" title="i++"></a>i++</h2><h3 id="1-å‰-å’Œå"><a href="#1-å‰-å’Œå" class="headerlink" title="1. å‰++å’Œå++"></a>1. å‰++å’Œå++</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		<span class="comment">//å±€éƒ¨å˜é‡ï¼Œä¸å½±å“ä¸‹é¢çš„x</span></div><div class="line">		<span class="keyword">int</span> x = <span class="number">5</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//jvmä¼šåˆå§‹åŒ–å…¨å±€å˜é‡xï¼Œyä¸º0ã€‚å±€éƒ¨å˜é‡åˆ™æ— åˆå§‹å€¼ã€‚</span></div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> x, y;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">//xå˜ä¸º-1</span></div><div class="line">		x--;</div><div class="line">		</div><div class="line">		myMethod();</div><div class="line">		</div><div class="line">		<span class="comment">//1. æ­¤æ—¶x=1,y=0</span></div><div class="line">		<span class="comment">//2. y++çš„++å…ˆä¸æ‰§è¡Œï¼Œè€Œæ˜¯yå…ˆå‚ä¸è¿ç®—ï¼Œç»“æœä¸º2</span></div><div class="line">		System.out.println(x + y++ + x); <span class="comment">//2</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">myMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">//1. x++çš„++å…ˆä¸è¿ç®—ï¼Œè¿˜æ˜¯åŸå§‹çš„xä½œä¸ºå‚æ•°ï¼Œæ‰€ä»¥æ­¤åˆ»ç›¸å½“äºx + ++x</span></div><div class="line">		<span class="comment">//2. ++xçš„++ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥xæ­¤æ—¶å˜ä¸º0</span></div><div class="line">		<span class="comment">//3. æ­¤æ—¶xä¸º0ï¼Œy = 0+0=0</span></div><div class="line">		<span class="comment">//4. x++åœ¨è¿ç®—ç»“æŸåå¼€å§‹æ‰§è¡Œï¼Œæ‰€ä»¥xä¸º1</span></div><div class="line">		y = x++ + ++x;</div><div class="line">		</div><div class="line">		System.out.println(x+<span class="string">" "</span>+y); <span class="comment">// x=1,y=0</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<h3 id="2-çš„ç¼“å­˜æœºåˆ¶"><a href="#2-çš„ç¼“å­˜æœºåˆ¶" class="headerlink" title="2. ++çš„ç¼“å­˜æœºåˆ¶"></a>2. ++çš„ç¼“å­˜æœºåˆ¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">			<span class="comment">//æ‰§è¡Œé¡ºåºæ‹†è§£ä¸ºå¦‚ä¸‹</span></div><div class="line">			<span class="comment">//temp=j</span></div><div class="line">			<span class="comment">//j++</span></div><div class="line">			<span class="comment">//j=temp</span></div><div class="line">			j = j++;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		System.out.println(j); <span class="comment">//0</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<h3 id="3-å„ç§"><a href="#3-å„ç§" class="headerlink" title="3. å„ç§++"></a>3. å„ç§++</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">		<span class="comment">//1. å…ˆæ‰§è¡Œi + ++iï¼Œ++iä¸º1ï¼Œæ‰€ä»¥temp = 1 +1 =2</span></div><div class="line">		<span class="comment">//2. i++æ‰§è¡Œï¼Œå˜ä¸º2ï¼Œä½†æ˜¯æ²¡ä»€ä¹ˆä½œç”¨  </span></div><div class="line">		<span class="comment">//3. i=tempï¼Œç»“æœæ˜¯2</span></div><div class="line">		i = i++ + ++i;</div><div class="line">		</div><div class="line">		<span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">		<span class="comment">//1. ++j ä½¿å¾—jä¸º1ï¼Œ1å·j++çš„++å…ˆä¸æ‰§è¡Œï¼Œæ‰€ä»¥temp= j + j= 1+1</span></div><div class="line">		<span class="comment">//2. åŠ æ³•å‡½æ•°æ‰§è¡Œå®Œäº†ï¼Œæ‰€ä»¥1å·j++æ‰§è¡Œï¼Œj=2</span></div><div class="line">		<span class="comment">//3. temp = temp + j++ï¼Œ2å·j++åŒæ ·å…ˆä¸æ‰§è¡Œï¼Œæ‰€ä»¥temp= 1+1+2</span></div><div class="line">		<span class="comment">//4. 2å·j++æ‰§è¡Œï¼Œj=3</span></div><div class="line">		<span class="comment">//5. temp =temp +j++ï¼Œ3å·j++åŒç†ï¼Œtemp=1+1+2+3</span></div><div class="line">		<span class="comment">//6. 3å·j++æ‰§è¡Œï¼Œå¾—åˆ°j=4</span></div><div class="line">		<span class="comment">//7. j=tempï¼Œjæœ€åå˜ä¸º7</span></div><div class="line">		j = ++j + j++ + j++ + j++;</div><div class="line">		</div><div class="line">		</div><div class="line">		<span class="keyword">int</span> k = <span class="number">0</span>;</div><div class="line">		<span class="comment">//1. 1å·k++å…ˆä¸æ‰§è¡Œï¼Œkä¸º0ï¼Œtemp=0ã€‚</span></div><div class="line">		<span class="comment">//2. 1å·k++æ‰§è¡Œï¼Œk=1</span></div><div class="line">		<span class="comment">//3. åˆ°2å·k++ï¼Œè¯¥++ä¸æ‰§è¡Œï¼Œæ‰€ä»¥temp=0+1</span></div><div class="line">		<span class="comment">//4. 2å·k++æ‰§è¡Œï¼Œk=2</span></div><div class="line">		<span class="comment">//5. åˆ°3å·k++ï¼Œtemp=0+1+2</span></div><div class="line">		<span class="comment">//6. 3å·k++æ‰§è¡Œï¼Œk=3ï¼Œ</span></div><div class="line">		<span class="comment">//7. ++kåï¼Œk=4</span></div><div class="line">		<span class="comment">//8. temp=0+1+2+4</span></div><div class="line">		<span class="comment">//9. k=temp=7</span></div><div class="line">		k = k++ + k++ + k++ + ++k;</div><div class="line">		</div><div class="line">		<span class="keyword">int</span> h = <span class="number">0</span>;</div><div class="line">		</div><div class="line">		<span class="comment">//1. ç¬¬ä¸€ä¸ª++hæ‰§è¡Œåï¼Œtemp=1</span></div><div class="line">		<span class="comment">//2. 2å·++hæ‰§è¡Œåtemp=1+2=3</span></div><div class="line">		<span class="comment">//3. h=temp=3</span></div><div class="line">		h = ++h + ++h;</div><div class="line">		</div><div class="line">		<span class="keyword">int</span> p1 = <span class="number">0</span>, p2 = <span class="number">0</span>;</div><div class="line">		<span class="keyword">int</span> q1 = <span class="number">0</span>, q2 = <span class="number">0</span>;</div><div class="line">		<span class="comment">//++p1åp1=1ï¼Œq1=p1=1</span></div><div class="line">		q1 = ++p1;</div><div class="line">		<span class="comment">//temp=p2=0ï¼Œp2++åp2=1</span></div><div class="line">		<span class="comment">//q2=temp=0</span></div><div class="line">		q2 = p2++;</div><div class="line">		System.out.println(<span class="string">" i "</span> + i); <span class="comment">//2</span></div><div class="line">		System.out.println(<span class="string">" j "</span> + j); <span class="comment">//7</span></div><div class="line">		System.out.println(<span class="string">" k "</span> + k); <span class="comment">//7</span></div><div class="line">		System.out.println(<span class="string">" h "</span> + h); <span class="comment">//3</span></div><div class="line">		System.out.println(<span class="string">" p1 "</span> + p1); <span class="comment">//1</span></div><div class="line">		System.out.println(<span class="string">" p2 "</span> + p2); <span class="comment">//1</span></div><div class="line">		System.out.println(<span class="string">" q1 "</span> + q1); <span class="comment">//1</span></div><div class="line">		System.out.println(<span class="string">" q2 "</span> + q2); <span class="comment">//0</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<h2 id="æ•°æ®ç±»å‹è½¬æ¢"><a href="#æ•°æ®ç±»å‹è½¬æ¢" class="headerlink" title="æ•°æ®ç±»å‹è½¬æ¢"></a>æ•°æ®ç±»å‹è½¬æ¢</h2><h3 id="1-åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢"><a href="#1-åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢" class="headerlink" title="1. åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢"></a>1. åŸºæœ¬æ•°æ®ç±»å‹çš„è½¬æ¢</h3><p>ä½çº§åˆ°é«˜çº§ï¼šåˆ†åˆ«ä¸ºï¼ˆbyteï¼Œshortï¼Œcharï¼‰&lt; int &lt; long &lt; float &lt; doubleã€‚</p>
<p>ä¸‹é¢çš„ç¨‹åºæ˜¯åˆæ³•çš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">byte</span> a = <span class="number">1</span>;</div><div class="line">		<span class="keyword">char</span> c = <span class="string">'c'</span>;</div><div class="line"></div><div class="line">		<span class="keyword">short</span> s = a;</div><div class="line">		<span class="comment">// ä¸åˆæ³• s=c, c=s;</span></div><div class="line">		<span class="keyword">int</span> i = s;</div><div class="line">		i = c;</div><div class="line">		<span class="keyword">long</span> l = i;</div><div class="line">		l = c;</div><div class="line">		<span class="keyword">float</span> f = l;</div><div class="line">		f = c;</div><div class="line">		<span class="keyword">double</span> d = f;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸‹é¢ç¨‹åºä¸­ï¼Œæœ‰ä¸€ä¸ªé”™è¯¯ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">short</span> s=<span class="number">1</span>;</div><div class="line">s+=<span class="number">1</span>;</div><div class="line">s=s+<span class="number">1</span>; <span class="comment">//ä¸åˆæ³•ï¼Œs+1ä¸ºintå‹</span></div><div class="line"></div></pre></td></tr></table></figure></p>
<h2 id="ä½ç§»æ“ä½œ"><a href="#ä½ç§»æ“ä½œ" class="headerlink" title="ä½ç§»æ“ä½œ"></a>ä½ç§»æ“ä½œ</h2><p>intä¸º32ä½ï¼Œæ‰€ä»¥ä½ç§»æ“ä½œä¼šå…ˆæ¨¡è¿ç®—32ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> i = <span class="number">32</span>;</div><div class="line"><span class="keyword">long</span> l = <span class="number">32</span>;</div><div class="line">System.out.println(i &gt;&gt; <span class="number">32</span>); <span class="comment">//32</span></div><div class="line">System.out.println(l &gt;&gt; <span class="number">32</span>); <span class="comment">//0</span></div></pre></td></tr></table></figure>
<h2 id="åå°„æœºåˆ¶"><a href="#åå°„æœºåˆ¶" class="headerlink" title="åå°„æœºåˆ¶"></a>åå°„æœºåˆ¶</h2><blockquote>
<p>åå°„ä¸»è¦æ˜¯æŒ‡ç¨‹åºå¯ä»¥è®¿é—®ã€æ£€æµ‹å’Œä¿®æ”¹å®ƒæœ¬èº«çš„çŠ¶æ€æˆ–è¡Œä¸ºçš„ä¸€ç§èƒ½åŠ›ã€‚  </p>
</blockquote>
<p>åœ¨javaä¸­å…·ä½“ä½“ç°ä¸ºä¸€ä¸ªç±»å¯ä»¥åå°„å‡ºä¸€ä¸ªclasså¯¹è±¡ï¼Œé€šè¿‡classå¯¹è±¡å¯ä»¥è®¿é—®è¯¥ç±»å†…éƒ¨çš„æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>
<h2 id="Objectç±»ä¸­çš„æ–¹æ³•"><a href="#Objectç±»ä¸­çš„æ–¹æ³•" class="headerlink" title="Objectç±»ä¸­çš„æ–¹æ³•"></a>Objectç±»ä¸­çš„æ–¹æ³•</h2><table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>åç§°</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>protected Object</td>
<td>clone()</td>
<td>Creates and returns a copy of this object.</td>
</tr>
<tr>
<td>boolean</td>
<td>equals(Object obj)</td>
<td>Indicates whether some other object is â€œequal toâ€ this one.</td>
</tr>
<tr>
<td>protected void</td>
<td>finalize()</td>
<td>Called by the garbage collector on an object when garbage collection determines that there are no more references to the object.</td>
</tr>
<tr>
<td>Class&lt;?&gt;</td>
<td>getClass()</td>
<td>Returns the runtime class of this Object.</td>
</tr>
<tr>
<td>int</td>
<td>hashCode()</td>
<td>Returns a hash code value for the object.</td>
</tr>
<tr>
<td>void</td>
<td>notify()</td>
<td>Wakes up a single thread that is waiting on this objectâ€™s monitor.</td>
</tr>
<tr>
<td>void</td>
<td>notifyAll()</td>
<td>Wakes up all threads that are waiting on this objectâ€™s monitor.</td>
</tr>
<tr>
<td>String</td>
<td>toString()</td>
<td>Returns a string representation of the object.</td>
</tr>
<tr>
<td>void</td>
<td>wait()</td>
<td>Causes the current thread to wait until another thread invokes the notify() method or the notifyAll() method for this object.</td>
</tr>
<tr>
<td>void</td>
<td>wait(long timeout)</td>
<td>Causes the current thread to wait until either another thread invokes the notify() method or the notifyAll() method for this object, or a specified amount of time has elapsed.</td>
</tr>
<tr>
<td>void</td>
<td>wait(long timeout, int nanos)</td>
<td>Causes the current thread to wait until another thread invokes the notify() method or the notifyAll() method for this object, or some other thread interrupts the current thread, or a certain amount of real time has elapsed.</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åœ¨æœ¬ç§‘æ—¶æ²¡æœ‰å¥½å¥½å¬è€å¸ˆè®²è¯¾ï¼Œç°åœ¨åªèƒ½é‡æ–°å†å­¦å­¦Javaï¼ŒğŸ˜­ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;æˆ‘çš„javaç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#æˆ‘çš„javaç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;æˆ‘çš„javaç¯å¢ƒ&quot;&gt;&lt;/a&gt;æˆ‘çš„javaç¯å¢ƒ&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;java version â€œ1.8.0_121â€&lt;br&gt;Java(TM) SE Runtime Environment (build 1.8.0_121-b13)&lt;br&gt;Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ClassLoader&quot;&gt;&lt;a href=&quot;#ClassLoader&quot; class=&quot;headerlink&quot; title=&quot;ClassLoader&quot;&gt;&lt;/a&gt;ClassLoader&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;bootstrap classloader&lt;/strong&gt;: åŠ è½½javaçš„æ ¸å¿ƒåº“çš„ç±»ã€‚&lt;br&gt;&lt;strong&gt;ExtClassLoader&lt;/strong&gt;: åŠ è½½æ‰©å±•çš„javaåº“ä¸­çš„ç±»ã€‚&lt;br&gt;&lt;strong&gt;AppClassLoader&lt;/strong&gt;: åŠ è½½åº”ç”¨ä¸­çš„ç±»ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Java" scheme="http://itanch.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>23ä¸ªè®¾è®¡æ¨¡å¼</title>
    <link href="http://itanch.github.io/2017/02/15/32%E4%B8%AA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    <id>http://itanch.github.io/2017/02/15/32ä¸ªè®¾è®¡æ¨¡å¼/</id>
    <published>2017-02-15T06:10:00.000Z</published>
    <updated>2017-04-06T12:02:17.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>æœ¬ç¯‡æ–‡ç« æ˜¯å¯¹<em>Design Patterns: Elements of Reusable Object-Oriented Software</em>çš„æ€»ç»“ã€‚</p>
</blockquote>
<p>çœ‹å®Œ<em>Design Patterns: Elements of Reusable Object-Oriented Software</em>å·²ç»æœ‰äº›æ—¶æ—¥äº†ï¼Œç°åœ¨æç¬”å°†å…¶æ¦‚æ‹¬æ€»ç»“ä¸€ä¸‹ï¼Œä»¥å¤‡å°†æ¥çš„å‚è€ƒã€‚æ­¤ä¹¦æ€»ç»“äº†23ä¸­ä¸åŒçš„è®¾è®¡æ¨¡å¼ï¼Œå¹¶ä¸”å°†å®ƒä»¬çš„è®¾è®¡ç›®çš„ã€ç»“æ„ã€ç”¨æ³•ç­‰æ–¹é¢è¿›è¡Œçš„å¾ˆå¥½çš„ä»‹ç»ï¼Œæ˜¯ä¸€æœ¬å€¼å¾—æ”¾åœ¨æ‰‹è¾¹éšæ—¶æŸ¥é˜…çš„å·¥å…·ä¹¦ã€‚<br><a id="more"></a></p>
<h2 id="Creational-Patterns"><a href="#Creational-Patterns" class="headerlink" title="Creational Patterns"></a>Creational Patterns</h2><hr>
<h3 id="1-Abstract-Factory"><a href="#1-Abstract-Factory" class="headerlink" title="1. Abstract Factory"></a>1. Abstract Factory</h3><h4 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>ä¸ºåˆ›å»ºä¸€ç»„ç›¸å…³å¯¹è±¡ï¼ŒAbstract Factoryæä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œå¹¶ä¸”ä¸éœ€è¦æŒ‡å®šå®ƒä»¬å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„ã€‚Abstract Factoryæ˜¯å’ŒConcrete Factoryï¼ˆç®€ç§°Factoryï¼‰ç›¸å¯¹çš„ä¸€ä¸ªæ¨¡å¼ï¼ŒFactoryçš„åŠŸèƒ½æ˜¯åˆ›å»ºç›¸å…³çš„ä¸€ç»„å¯¹è±¡ï¼Œå®ƒæ˜¯å…·ä½“çš„ã€‚è€ŒAbstract Factoryåˆ™æ˜¯ä»…ä»…æä¾›æ¥å£ï¼Œå…·ä½“å¦‚ä½•åˆ›å»ºã€åˆ›å»ºä»€ä¹ˆç±»å‹çš„å¯¹è±¡ç”±å­ç±»Factoryæ¥å…·ä½“å®ç°ã€‚ä¹Ÿå«Kitã€‚</p>
<h4 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_af.png" alt="image"></p>
<p><strong>AbstractFactory</strong>: å£°æ˜äº†åˆ›å»ºå…·ä½“äº§å“å¯¹è±¡çš„æ¥å£ã€‚<br><strong>ConcreteFactory</strong>: å®ç°äº†åˆ›å»ºå…·ä½“äº§å“å¯¹è±¡çš„å‡½æ•°ã€‚<br><strong>AbstractProduct</strong>: å£°æ˜äº†æŸä¸€ç§äº§å“å¯¹è±¡çš„æ¥å£ã€‚<br><strong>ConcreteProduct</strong>: å®šä¹‰äº†å…·ä½“è¢«åˆ›å»ºçš„ä¸€ä¸ªäº§å“å¯¹è±¡ã€‚å®ç°äº†AbstractProductçš„æ¥å£ã€‚<br><strong>Client</strong>: ä»…ä»…è°ƒç”¨AbstractFactoryåˆ›å»ºäº§å“ï¼Œå¹¶ä¸”ä½¿ç”¨AbstractProductçš„æ¥å£ã€‚ç”¨æˆ·æ— éœ€å…³å¿ƒå…·ä½“ä½¿ç”¨äº†å“ªä¸€ä¸ªFactoryå’ŒProductã€‚</p>
<h4 id="ä½•æ—¶ä½¿ç”¨"><a href="#ä½•æ—¶ä½¿ç”¨" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ä¸ªç³»ç»Ÿéœ€è¦å’Œå®ƒçš„äº§å“çš„åˆ›å»ºã€ç»„æˆã€è¡¨ç¤ºç›¸äº’ç‹¬ç«‹æ—¶ã€‚</li>
<li>ä¸€ä¸ªç³»ç»Ÿéœ€è¦é…ç½®å¤šç§äº§å“å®¶æ—ä¸­çš„ä¸€ä¸ªæ—¶ã€‚å¦‚ç»“æ„å›¾ä¸­æ‰€ç¤ºï¼Œæœ‰1å’Œ2ä¸¤ä¸ªäº§å“å®¶æ—ï¼Œclientåªéœ€è¦é…ç½®å…¶ä¸­çš„ä¸€ä¸ªå³å¯ï¼Œå¦‚æœé…ç½®äº†1ï¼Œåˆ™clientä½¿ç”¨çš„æ‰€æœ‰productéƒ½æ˜¯1ç±»å‹çš„ï¼Œæœ‰ProductA1ã€ProductB1ç­‰ã€‚</li>
<li>ä¸€æ—ç›¸å…³è”çš„äº§å“éœ€è¦ä¸€èµ·è¢«ä½¿ç”¨ï¼Œä¸å¯æ··ç”¨ï¼Œä½ å¯ä»¥é€šè¿‡Abstract Factoryæ¥åŠ å¼ºè¿™ç§é™åˆ¶ã€‚clientå¦‚æœé€‰æ‹©ä½¿ç”¨äº†1ï¼Œåˆ™åº”è¯¥ä¿è¯æ‰€æœ‰çš„äº§å“éƒ½æ˜¯1å®¶æ—çš„äº§å“ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªåº”ç”¨çš„UIæ”¯æŒwindowså’Œmacä¸¤ç§é£æ ¼ï¼Œç”¨æˆ·é€‰æ‹©äº†windowsé£æ ¼çš„UIï¼Œåˆ™åº”è¯¥ä¿è¯æ‰€æœ‰çš„æŒ‰é’®ã€èœå•å’Œè¾¹æ ç­‰éƒ½æ˜¯windowsé£æ ¼ã€‚</li>
<li>ä½ æƒ³æä¾›ä¸€ä¸ªproductçš„åº“ï¼ŒåŒæ—¶ä½ åªæƒ³æš´éœ²å®ƒä»¬çš„æ¥å£ï¼Œè€Œä¸æ˜¯å¦‚ä½•å®ç°çš„ã€‚</li>
</ol>
<hr>
<h3 id="2-Builder"><a href="#2-Builder" class="headerlink" title="2. Builder"></a>2. Builder</h3><h4 id="ç›®çš„-1"><a href="#ç›®çš„-1" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºå’Œè¡¨ç¤ºç›¸åˆ†ç¦»ï¼Œä»è€Œå¯ä»¥ä½¿å¾—ç›¸åŒçš„æ„å»ºè¿‡ç¨‹åˆ›é€ å‡ºä¸åŒçš„è¡¨ç¤ºã€‚</p>
<h4 id="ç»“æ„-1"><a href="#ç»“æ„-1" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_bd.png" alt="image"></p>
<p><strong>Builder</strong>: å£°æ˜äº†ä¸€ä¸ªåˆ›å»ºä¸€ä¸ªäº§å“å¯¹è±¡ä¸€éƒ¨åˆ†çš„æŠ½è±¡æ¥å£ã€‚<br><strong>ConcreteBuilder</strong>: å®ç°Builderå®šä¹‰çš„æ¥å£ï¼Œå¯ä»¥åˆ›å»ºå’Œç»„è£…äº§å“çš„ä¸€éƒ¨åˆ†ã€‚å®šä¹‰å¹¶ä¸”ä¿å­˜äº†å®ƒæ‰€åˆ›å»ºäº§å“çš„å½“å‰è¡¨ç¤ºã€‚åŒæ—¶ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ä¸ªå¯ä»¥è·å¾—æ‰€åˆ›å»ºäº§å“çš„æ¥å£ã€‚<br><strong>Director</strong>: ä½¿ç”¨Builderçš„æä¾›çš„æ¥å£åˆ›å»ºäº§å“å¯¹è±¡ã€‚<br><strong>Product</strong>:è¡¨ç¤ºæ­£åœ¨è¢«åˆ›å»ºçš„ä¸€ä¸ªå¤æ‚å¯¹è±¡ã€‚ConcreteBuilderå»ºé€ äº†å®ƒçš„å†…éƒ¨è¡¨ç¤ºï¼Œå†³å®šäº†å®ƒç»„è£…çš„è¿‡ç¨‹ã€‚å®ƒåŒ…å«äº†å®šä¹‰å®ƒç»„æˆéƒ¨åˆ†çš„ç±»ï¼ŒåŒæ—¶æä¾›äº†æ¥å£è®©å…·ä½“Builderæ¥ç»„è£…è¿™äº›ç»„æˆéƒ¨åˆ†ã€‚ </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-1"><a href="#ä½•æ—¶ä½¿ç”¨-1" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>åˆ›å»ºä¸€ä¸ªå¤æ‚å¯¹è±¡çš„ç®—æ³•éœ€è¦ç‹¬ç«‹äºå¯¹è±¡çš„ç»„æˆéƒ¨åˆ†çš„å®šä¹‰å’Œç»„è£…æ–¹å¼ã€‚å¦‚Directorä¸­å®ç°äº†ä¸€ä¸ªåˆ›å»ºäº§å“å¯¹è±¡çš„ç®—æ³•ï¼Œè€Œå¯¹è±¡å†…éƒ¨å¦‚ä½•ç»„è£…çš„åˆ™ç”±Builderå†³å®šã€‚</li>
<li>ä¸€ä¸ªåˆ›å»ºè¿‡ç¨‹å¯ä»¥äº§ç”Ÿä¸åŒçš„å¯¹è±¡è¡¨ç¤ºã€‚æ¯”å¦‚ï¼ŒDirectorå¯ä»¥é‡‡ç”¨ä¸åŒçš„ConcreteBuilderæ¥åˆ›å»ºäº§å“å¯¹è±¡ï¼Œåœ¨Directorä¸­åˆ›å»ºçš„è¿‡ç¨‹æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯ç”±äºBuilderçš„ä¸åŒï¼Œå¯¼è‡´æœ€åäº§å“çš„å†…éƒ¨ç»“æ„å¯èƒ½å·®å¼‚å¾ˆå¤§ã€‚ </li>
</ol>
<hr>
<h3 id="3-Factory-Method"><a href="#3-Factory-Method" class="headerlink" title="3. Factory Method"></a>3. Factory Method</h3><h4 id="ç›®çš„-2"><a href="#ç›®çš„-2" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œç”±å­ç±»å»å†³å®šåˆ›å»ºå“ªä¸€ä¸ªå…·ä½“çš„å¯¹è±¡ã€‚Factory Methodå¯ä»¥å°†å®ä¾‹åŒ–å¯¹è±¡çš„è¿‡ç¨‹å§”æ´¾ç»™å­ç±»ã€‚æ³¨æ„ï¼Œè¿™é‡ŒFactory Methodå¼ºè°ƒçš„æ˜¯æ–¹æ³•ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ææœ‰å¯èƒ½ä¼šè¢«å­ç±»è¦†ç›–ã€‚åœ¨Abstract Factoryä¸­å°±ä½¿ç”¨äº†Factory Methodæ¥åˆ›å»ºäº§å“ã€‚</p>
<h4 id="ç»“æ„-2"><a href="#ç»“æ„-2" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_fm.png" alt="image">  </p>
<p><strong>Product</strong>: å®šä¹‰äº†Factory methodåˆ›å»ºçš„å¯¹è±¡çš„æ¥å£ã€‚<br><strong>ConcreteProduct</strong>: å®ç°äº†Productçš„æ¥å£ã€‚<br><strong>Creator</strong>:å®šä¹‰äº†Factory Method,factory methodä¼šåˆ›å»ºæŸä¸€ä¸ªç±»å‹çš„äº§å“ã€‚å®ƒæœ‰å¯èƒ½å®šä¹‰ä¸€ä¸ªé»˜è®¤çš„factory methodæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªå…·ä½“çš„äº§å“ã€‚<br><strong>ConcreteCreator</strong>: é‡å†™factory methodæ¥å®ä¾‹åŒ–ä¸€ä¸ªConcreteProductã€‚  </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-2"><a href="#ä½•æ—¶ä½¿ç”¨-2" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ä¸ªç±»ä¸èƒ½é¢„æ–™å®ƒå¿…é¡»åˆ›å»ºçš„å¯¹è±¡å±äºå“ªä¸€ç±»ã€‚</li>
<li>ä¸€ä¸ªç±»å¸Œæœ›å®ƒçš„å­ç±»æ¥å†³å®šéœ€è¦åˆ›å»ºçš„å¯¹è±¡ã€‚</li>
<li>ä¸€ä¸ªç±»å°†è´£ä»»å§”æ´¾ç»™å®ƒçš„ä¸€ä¸ªå­ç±»ï¼Œä½ å¸Œæœ›å°†å“ªä¸€ä¸ªç±»è¢«å§”æ´¾çš„çŸ¥è¯†æœ¬åœ°åŒ–ã€‚</li>
</ol>
<hr>
<h3 id="4-Prototype"><a href="#4-Prototype" class="headerlink" title="4. Prototype"></a>4. Prototype</h3><h4 id="ç›®çš„-3"><a href="#ç›®çš„-3" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>é€šè¿‡ä¸€ä¸ªåŸå‹å®ä¾‹æ¥åˆ›å»ºä¸€ç±»çš„å¯¹è±¡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡çš„è¿‡ç¨‹å°±æ˜¯æ‹·è´åŸå‹å®ä¾‹ã€‚è¿™æ ·åšå¯ä»¥çœå»ä¼ å…¥å‚æ•°æ¥åˆ›å»ºå¯¹è±¡çš„éº»çƒ¦ï¼Œä¿è¯æ¯æ¬¡åˆ›å»ºçš„å¯¹è±¡éƒ½å…·æœ‰ç›¸åŒçš„å±æ€§ã€‚å³ä½¿éœ€è¦ç›¸åŒç±»çš„ä¸åŒå±æ€§çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥å…ˆè¿›è¡Œæ‹·è´ï¼Œç„¶åé€šè¿‡ç¨åŠ ä¿®æ”¹ï¼Œå°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„å¯¹è±¡ã€‚</p>
<p>åœ¨Nodejsä¸­æœ‰prototypeçš„ä½¿ç”¨ã€‚</p>
<h4 id="ç»“æ„-3"><a href="#ç»“æ„-3" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_ptt.png" alt="image"> </p>
<p><strong>Prototype</strong>: å®šä¹‰äº†ä¸€ä¸ªæ¥æ‹·è´è‡ªå·±çš„æ¥å£ã€‚<br><strong>ConretePrototype</strong>: å®ç°äº†å…‹éš†è‡ªå·±çš„æ“ä½œã€‚<br><strong>Client</strong>: è®©Prototypeå…‹éš†è‡ªå·±æ¥åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-3"><a href="#ä½•æ—¶ä½¿ç”¨-3" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ç³»ç»Ÿéœ€è¦ç‹¬ç«‹äºå®ƒçš„äº§å“å¦‚ä½•åˆ›å»ºã€ç»„æˆå’Œè¡¨ç¤ºçš„æ—¶å€™ã€‚</li>
<li>å½“éœ€è¦å®ä¾‹åŒ–çš„ç±»åœ¨è¿è¡Œæ‰å†³å®šæ—¶ã€‚</li>
<li>æƒ³è¦é¿å…åˆ›å»ºä¸€ä¸ªå¹³è¡Œäºäº§å“ç±»å±‚æ¬¡ç»“æ„çš„factoryå±‚æ¬¡ç»“æ„ã€‚å› ä¸ºåˆ›å»ºä¸€ä¸ªå¯¹è±¡åªéœ€è¦é€šè¿‡åŸå‹æ‹·è´ï¼Œæ— éœ€ä½¿ç”¨factoryæ¥åˆ›å»ºã€‚</li>
<li>å½“ä¸€ä¸ªç±»çš„å®ä¾‹åªæœ‰ä¸ºæ•°ä¸å¤šçš„å‡ ä¸ªçŠ¶æ€ç»„åˆä¸­çš„ä¸€ä¸ªæ—¶ï¼Œå¯ä»¥å…ˆå®ä¾‹å¥½å‡ ä¸ªä¸åŒçŠ¶æ€çš„å¯¹è±¡ï¼Œæ¯æ¬¡åªéœ€è¦ä»è¿™äº›åŸå‹å¯¹è±¡ä¸­æŒ‰éœ€æ‹·è´å‡ºæ¥æ–°å¯¹è±¡å³å¯ã€‚</li>
</ol>
<hr>
<h3 id="5-Singleton"><a href="#5-Singleton" class="headerlink" title="5. Singleton"></a>5. Singleton</h3><h4 id="ç›®çš„-4"><a href="#ç›®çš„-4" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªå¯ä»¥è®¿é—®å®ƒçš„å…¨å±€åˆ‡å…¥ç‚¹ã€‚</p>
<p>åœ¨Androidç³»ç»Ÿä¸­çš„ActivityManagerServiceå°±æ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼ã€‚</p>
<h4 id="ç»“æ„-4"><a href="#ç»“æ„-4" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_sg.png" alt="image"></p>
<p><strong>Singleton</strong>: å®šä¹‰ä¸€ä¸ªå®ä¾‹åŒ–å‡½æ•°ï¼Œå¯ä»¥è®©ç”¨æˆ·é€šè¿‡è¯¥å‡½æ•°è·å–è¯¥ç‹¬ä¸€æ— äºŒçš„å®ä¾‹ã€‚Instranceæ˜¯ä¸€ä¸ªç±»å‡½æ•°ã€‚æœ‰äº›æ—¶å€™ï¼Œå®ƒè¿˜è¦è´Ÿè´£åˆ›å»ºå®ƒç‹¬ä¸€æ— äºŒçš„å®ä¾‹ã€‚</p>
<h4 id="ä½•æ—¶ä½¿ç”¨-4"><a href="#ä½•æ—¶ä½¿ç”¨-4" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡æ—¶ï¼Œå¹¶ä¸”éœ€è¦æä¾›ä¸€ä¸ªå…¬å…±æ¥å£ç»™ç”¨æˆ·è®¿é—®è¯¥ç‹¬ä¸€æ— äºŒçš„å®ä¾‹ã€‚</li>
<li>è¿™ä¸ªå­¤ç«‹çš„å®ä¾‹å¯¹è±¡å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥æ‰©å±•ï¼Œå¹¶ä¸”ç”¨æˆ·å¯ä»¥æ— éœ€ä¿®æ”¹åŸæ¥çš„ä»£ç æ¥ä½¿ç”¨è¯¥æ‰©å±•çš„å®ä¾‹ã€‚</li>
</ol>
<hr>
<h2 id="Structural-Patterns"><a href="#Structural-Patterns" class="headerlink" title="Structural Patterns"></a>Structural Patterns</h2><h3 id="6-Adapter"><a href="#6-Adapter" class="headerlink" title="6. Adapter"></a>6. Adapter</h3><h4 id="ç›®çš„-5"><a href="#ç›®çš„-5" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬åŒ–ä¸ºç”¨æˆ·æƒ³è¦çš„æ¥å£å½¢å¼ã€‚Adapterå¯ä»¥è®©åŸæ¥æ¥å£ä¸ç›¸åŒ¹é…çš„ç±»è¿›è¡Œåˆä½œã€‚ä¹Ÿå«Wrapperã€‚</p>
<h4 id="ç»“æ„-5"><a href="#ç»“æ„-5" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p>Adapterä½¿ç”¨å¤šç»§æ‰¿æ¥å®ç°æ¥å£çš„é€‚é…ã€‚<br><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_adt_1.png" alt="image"></p>
<p>Adapteré€šè¿‡ç»„åˆæ¥å®ç°ç»“æ„çš„åŒ¹é…ã€‚<br><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_adt_2.png" alt="image"></p>
<p><strong>Target</strong>: å®šä¹‰äº†ç”¨æˆ·æƒ³è¦ä½¿ç”¨çš„æ¥å£ã€‚<br><strong>Client</strong>: è°ƒç”¨ç›®æ ‡æ¥å£æ¥ä½¿ç”¨æŸäº›å¯¹è±¡ã€‚<br><strong>Adaptee</strong>: å®ç°äº†clientæƒ³è¦çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ¥å£å¹¶ä¸æ˜¯clientæƒ³è¦çš„ï¼Œæ‰€ä»¥è¦è¿›è¡Œé€‚é…ã€‚<br><strong>Adapter</strong>: å°†Adapteeçš„æ¥å£é€‚é…æˆç›®æ ‡æ¥å£ã€‚  </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-5"><a href="#ä½•æ—¶ä½¿ç”¨-5" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä½ æƒ³ä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„ç±»ï¼Œä½†æ˜¯å®ƒçš„æ¥å£å’Œä½ éœ€è¦çš„ä¸å¤ªåŒ¹é…ã€‚</li>
<li>ä½ æƒ³å®šä¹‰ä¸€ä¸ªç±»ï¼Œå®ƒå¯ä»¥å’Œä¸ç›¸å…³ã€ä¸å¯é¢„è§çš„å…¶å®ƒç±»è¿›è¡Œé…åˆä½¿ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ä½ å®šä¹‰çš„ç±»æ²¡å¿…è¦é€‚é…æ‰€æœ‰çš„æƒ…å†µï¼Œæ ¹æ®å…·ä½“æƒ…å†µé…ç½®é€‚å½“çš„adapterå°±å¯ä»¥äº†ã€‚</li>
<li>ä½ éœ€è¦ä½¿ç”¨å¾ˆå¤šç°æˆçš„å­ç±»ï¼Œä½†æ˜¯é€šè¿‡ç»§æ‰¿ç±»ä¿®æ”¹æ¯ä¸€ä¸ªå­ç±»çš„æ¥å£æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œè¿™æ—¶å€™ä½ å¯ä»¥ä»…ä»…åˆ©ç”¨adapteré€‚é…å®ƒä»¬çš„çˆ¶ç±»å³å¯ã€‚</li>
</ol>
<hr>
<h3 id="7-Bridge"><a href="#7-Bridge" class="headerlink" title="7. Bridge"></a>7. Bridge</h3><h4 id="ç›®çš„-6"><a href="#ç›®çš„-6" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å°†ä¸€ä¸ªç±»çš„æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°è¿›è¡Œè§£è€¦ï¼Œä»è€Œå¯ä»¥ä½¿å¾—è¿™ä¸¤ä¸ªéƒ¨åˆ†ç‹¬ç«‹å˜åŒ–ã€‚ä¹Ÿå«åšHandle/Bodyã€‚Bridgeå’ŒAdapteréƒ½æœ‰ç»™ç”¨æˆ·æä¾›é€‚é…çš„æ¥å£çš„ä½œç”¨ï¼Œä½†æ˜¯Adapteræ›´å¼ºè°ƒè®©åŸæ¥ä¸ç›¸å¹²çš„ç±»è¿›è¡Œåˆä½œï¼Œå¾€å¾€ç±»å·²ç»è®¾è®¡å¥½äº†ã€‚è€ŒBridgeåœ¨è®¾è®¡ä¹‹åˆï¼Œå¸Œæœ›è®©æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°è¿›è¡Œåˆ†ç¦»ã€‚</p>
<h4 id="ç»“æ„-6"><a href="#ç»“æ„-6" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_bdg.png" alt="image"></p>
<p><strong>Abstraction</strong>: å®šä¹‰æŠ½è±¡æ¥å£ã€‚æœ‰ä¸€ä¸ªæŒ‡å‘Implementorå¯¹è±¡çš„å¼•ç”¨ã€‚<br><strong>RefmedAbstraction</strong>: æ‰©å±•Abstractionçš„æ¥å£ã€‚<br><strong>Implementor</strong>: å®šä¹‰äº†å®ç°ç±»çš„æ¥å£ã€‚è¿™äº›æ¥å£æ²¡å¿…è¦å’ŒAbstractionçš„æ¥å£ä¿æŒä¸€è‡´ï¼Œç”šè‡³å¯ä»¥å®Œå…¨ä¸åŒã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒImplementorçš„æ¥å£æä¾›çš„æ˜¯åŸºæœ¬çš„åŠŸèƒ½ï¼ŒAbstractionåˆ©ç”¨è¿™äº›åŸºæœ¬å‡½æ•°æ¥æ„æˆæ›´é«˜çº§çš„å‡½æ•°åŠŸèƒ½ã€‚<br><strong>ConcreteImplementor</strong>: å…·ä½“å®ç°äº†Implementorçš„æ¥å£ï¼Œå®šä¹‰äº†å…·ä½“çš„å®ç°ã€‚</p>
<h4 id="ä½•æ—¶ä½¿ç”¨-6"><a href="#ä½•æ—¶ä½¿ç”¨-6" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä½ å¸Œæœ›é¿å…å°†æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°è¿›è¡Œæ°¸ä¹…çš„ç»‘å®šåœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç±»æä¾›çš„æŠ½è±¡è¡Œä¸ºæ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œè¿™äº›è¡Œä¸ºçš„å…·ä½“çš„å®ç°å´éœ€è¦è¿›è¡Œå˜åŠ¨ã€‚</li>
<li>æŠ½è±¡è¡Œä¸ºå’Œå…·ä½“å®ç°åº”è¯¥å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥è¿›è¡Œæ‰©å±•ã€‚Bridgeå¯ä»¥è®©åŠå°†ä¸åŒçš„æŠ½è±¡å’Œå®ç°è¿›è¡Œç»„åˆï¼Œå¹¶ä¸”å¯ä»¥äº’ä¸å½±å“çš„è¿›è¡Œæ‰©å±•ã€‚</li>
<li>å¯¹å…·ä½“å®ç°çš„æ”¹å˜ä¸ä¼šå½±å“ç”¨æˆ·ï¼Œå› ä¸ºæŠ½è±¡è¡Œä¸ºæ²¡æœ‰å˜åŒ–ã€‚</li>
<li>ä½ å¸Œæœ›å¯¹ç”¨æˆ·éšè—æŠ½è±¡è¡Œä¸ºçš„å…·ä½“å®ç°ã€‚</li>
<li>ä½ æƒ³å…±äº«å…·ä½“å®ç°éƒ¨åˆ†ï¼Œå¹¶ä¸”è¿™ç§å…±äº«å¯¹ç”¨æˆ·è€Œè¨€æ˜¯é€æ˜çš„ï¼Œå› ä¸ºç”¨æˆ·åªèƒ½çœ‹åˆ°æŠ½è±¡è¡Œä¸ºã€‚</li>
</ol>
<hr>
<h3 id="8-Composite"><a href="#8-Composite" class="headerlink" title="8. Composite"></a>8. Composite</h3><h4 id="ç›®çš„-7"><a href="#ç›®çš„-7" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å°†å¯¹è±¡ç»„åˆæˆæ ‘çš„ç»“æ„æ¥è¡¨ç°éƒ¨åˆ†-æ•´ä½“çš„å±‚æ¬¡ç»“æ„ã€‚Compositeä½¿å¾—ç”¨æˆ·å¯ä»¥å°†ä¸ªä½“å¯¹è±¡å’Œç»„åˆå¯¹è±¡ç»Ÿä¸€è¿›è¡Œå¤„ç†ã€‚</p>
<p>Androidç³»ç»Ÿä¸­Activityä¸­å­˜æ”¾Viewç»„ä»¶çš„RootViewå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„Compositeã€‚</p>
<h4 id="ç»“æ„-7"><a href="#ç»“æ„-7" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_cp.png" alt="image"></p>
<p><strong>Component</strong>: ä¸ºéœ€è¦è¿›è¡Œç»„åˆçš„å¯¹è±¡å®šä¹‰äº†æ¥å£ã€‚é€‚å½“çš„å®ç°æ‰€æœ‰ç±»å…±æœ‰çš„é»˜è®¤è¡Œä¸ºã€‚å®šä¹‰è®¿é—®ã€ç®¡ç†å­ç»„ä»¶çš„æ¥å£ã€‚ä¹Ÿå¯ä»¥å®šä¹‰è®¿é—®çˆ¶èŠ‚ç‚¹çš„æ¥å£ã€‚<br><strong>Leaf</strong>: è¡¨ç¤ºå¶å­èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ã€‚å®šä¹‰äº†ç»„åˆä¸­åŸºæœ¬å¯¹è±¡çš„å‡½æ•°ã€‚<br><strong>Composite</strong>: å®šä¹‰æœ‰å­èŠ‚ç‚¹çš„ç»„ä»¶çš„è¡Œä¸ºã€‚å­˜å‚¨å­èŠ‚ç‚¹ã€‚å®ç°Componentä¸­å®šä¹‰çš„æœ‰å…³å­èŠ‚ç‚¹æ“ä½œçš„å‡½æ•°ã€‚<br><strong>Client</strong>: é€šè¿‡Componentæä¾›çš„æ¥å£æ“ä½œç»„åˆç»“æ„ã€‚</p>
<h4 id="ä½•æ—¶ä½¿ç”¨-7"><a href="#ä½•æ—¶ä½¿ç”¨-7" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä½ æƒ³è¡¨ç°ä¸€ä¸ªéƒ¨åˆ†-æ•´ä½“çš„å±‚æ¬¡ç»“æ„æ—¶ã€‚  </li>
<li>ä½ å¸Œæœ›è®©ç”¨æˆ·æ— æ³•æ„ŸçŸ¥ç»„åˆå¯¹è±¡å’Œå­¤ç«‹å¯¹è±¡çš„åŒºåˆ«ï¼Œç”¨æˆ·å¯ä»¥ç»Ÿä¸€åœ°å¤„ç†compositeç»“æ„ä¸­æ‰€æœ‰çš„å¯¹è±¡ã€‚   </li>
</ol>
<hr>
<h3 id="9-Decorator"><a href="#9-Decorator" class="headerlink" title="9. Decorator"></a>9. Decorator</h3><h4 id="ç›®çš„-8"><a href="#ç›®çš„-8" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>åŠ¨æ€çš„ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ åŠŸèƒ½ã€‚Decoratorsæä¾›äº†ä¸€ä¸ªçµæ´»çš„é€‰æ‹©æ¥æ‰©å±•åŠŸèƒ½ã€‚ä¹Ÿå«åšWrapperã€‚</p>
<h4 id="ç»“æ„-8"><a href="#ç»“æ„-8" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_dc.png" alt="image"></p>
<p><strong>Component</strong>: å®šä¹‰äº†åŸºæœ¬ç»„ä»¶çš„æ¥å£ã€‚<br><strong>ConcreteComponent</strong>: å®šä¹‰äº†ä¸€ä¸ªå…·ä½“ç»„ä»¶çš„ç±»ã€‚<br><strong>Decorator</strong>: æœ‰ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªCompoentå¯¹è±¡çš„åº”ç”¨ï¼Œå¹¶ä¸”æœ‰ç€å’ŒComponentä¸€æ ·çš„æ¥å£ã€‚è¿™æ ·å¯ä»¥ä¿æŒç»™ç”¨æˆ·æä¾›ä¸€è‡´çš„æ¥å£ï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸çŸ¥ä¸è§‰ä¸­ä½¿ç”¨å·²ç»æ‰©å±•åŠŸèƒ½çš„å¯¹è±¡ã€‚<br><strong>ConcreteDecorator</strong>: ç»™ç»„ä»¶æ·»åŠ æ–°çš„åŠŸèƒ½ã€‚å¹¶é€šè¿‡å°†Componentçš„åŸå§‹æ¥å£å’Œæ–°åŠŸèƒ½å°è£…åœ¨é‡å†™çš„å‡½æ•°ä¸­å®ç°è¡Œä¸ºçš„ä¸€è‡´æ€§ã€‚</p>
<h4 id="ä½•æ—¶ä½¿ç”¨-8"><a href="#ä½•æ—¶ä½¿ç”¨-8" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>åŠ¨æ€åœ°ã€é€æ˜åœ°ã€ä¸å½±å“å…¶å®ƒå¯¹è±¡åœ°ç»™æŸä¸ªå¯¹è±¡æ·»åŠ æ–°çš„åŠŸèƒ½ã€‚</li>
<li>å¯ä»¥æ’¤é”€å¯¹è±¡çš„æ–°åŠŸèƒ½ã€‚</li>
<li>é€šè¿‡ç»§æ‰¿æ¥å®ç°åŠŸèƒ½çš„æ‰©å±•ä¸åˆ‡å®é™…æ—¶ã€‚æœ‰æ—¶å¤§é‡çš„å¯ä»¥æ‰©å±•çš„ç‹¬ç«‹åŠŸèƒ½ï¼Œä½†æ˜¯ç›´æ¥é€šè¿‡ç»§æ‰¿æ¥å®ç°ä¼šå¯¼è‡´å­ç±»çš„ç»„åˆçˆ†ç‚¸ã€‚ç»§æ‰¿æ˜¯éœ€è¦åœ¨ç¼–ç¨‹æ—¶å†™æ­»çš„ï¼Œè€Œé‡‡ç”¨Decoratoråˆ™å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€çš„ç»„åˆæ–°çš„åŠŸèƒ½ã€‚</li>
</ol>
<hr>
<h3 id="10-Facade"><a href="#10-Facade" class="headerlink" title="10. Facade"></a>10. Facade</h3><h4 id="ç›®çš„-9"><a href="#ç›®çš„-9" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>ä¸ºä¸€ä¸ªå­ç³»ç»Ÿçš„ä¸€ç»„æ¥å£æä¾›ä¸€ä¸ªç»Ÿä¸€åœ°æ¥å£ã€‚Facadeå®šä¹‰äº†ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„æ¥å£ï¼Œæ˜¯çš„å­ç³»ç»Ÿæ›´åŠ æ˜“äºä½¿ç”¨ã€‚</p>
<h4 id="ç»“æ„-9"><a href="#ç»“æ„-9" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_fcd.png" alt="image"></p>
<p><strong>Facade</strong>: çŸ¥é“åœ¨å­ç³»ç»Ÿä¸­å“ªä¸€ä¸ªç±»åº”è¯¥å¯¹ä¸€ä¸ªè¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”å°†é€‚å½“çš„è¯·æ±‚äº¤ç»™ç›¸åº”çš„ç±»ã€‚<br><strong>subsystem classes</strong>: å®ç°å­ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œå¤„ç†Facadeäº¤ç»™çš„ä»»åŠ¡ï¼Œä½†æ˜¯å®ƒä»¬å¹¶ä¸çŸ¥é“Facadeå­˜åœ¨ã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-9"><a href="#ä½•æ—¶ä½¿ç”¨-9" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä½ å¦‚æœæƒ³ç»™ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿæä¾›ä¸€ä¸ªç®€å•çš„æ¥å£ï¼Œè¯·ç”¨Facadeã€‚å­ç³»ç»Ÿä¼šéšç€å‡çº§è¶Šæ¥è¶Šå¤æ‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´è®¸å¤šç»†ç²’åº¦çš„ç±»å‡ºç°ï¼Œè™½ç„¶è¿™å¢åŠ äº†å­ç³»ç»Ÿçš„å¯å®šåˆ¶æ€§ï¼Œä½†æ˜¯å¯¹ç”¨æˆ·è€Œè¯´å´è¶Šæ¥è¶Šéš¾ä½¿ç”¨ã€‚Facadeå¯ä»¥ç»™è¿™äº›ç”¨æˆ·æä¾›ä¸€ä¸ªç›¸å¯¹ç®€å•çš„è§†å›¾ï¼Œåªæœ‰åœ¨ç”¨æˆ·éœ€è¦å®šåˆ¶å­ç³»ç»Ÿæ—¶ï¼Œæ‰éœ€è¦è¶Šè¿‡Facadeæ¥è§‚å¯Ÿå­ç³»ç»Ÿã€‚  </li>
<li>åœ¨ä¼ ç»Ÿçš„ç³»ç»Ÿä¸­ï¼Œå®¢æˆ·ç«¯å’Œå­ç³»ç»Ÿä¹‹é—´ä¼šäº§ç”Ÿå¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œè€ŒFacadeçš„å¼•å…¥å¯ä»¥å¾ˆå¥½çš„å°†ç”¨æˆ·å’Œå­ç³»ç»Ÿè¿›è¡Œè§£è€¦ï¼Œå› æ­¤å¯ä»¥æå‡å­ç³»ç»Ÿçš„ç‹¬ç«‹æ€§å’Œå¯æºå¸¦æ€§ã€‚</li>
<li>å°†å­ç³»ç»Ÿè¿›è¡Œå±‚æ¬¡åŒ–ã€‚ç”¨facadeæ¥å®šä¹‰æ¯ä¸ªå­ç³»ç»Ÿçš„æ¥å£ï¼Œå¦‚æœå­ç³»ç»Ÿä¹‹é—´æœ‰ä¾èµ–å…³ç³»ï¼Œä½ å°±å¯ä»¥è®©è¿™äº›å­ç³»ç»Ÿä¹‹é—´åªé€šè¿‡ä»–ä»¬çš„facadeæ¥å£æ¥è¿›è¡Œäº¤äº’ï¼Œä»è€Œç®€åŒ–ä»–ä»¬ä¹‹é—´çš„ä¾èµ–ã€‚</li>
</ol>
<hr>
<h3 id="11-Flyweight"><a href="#11-Flyweight" class="headerlink" title="11. Flyweight"></a>11. Flyweight</h3><h4 id="ç›®çš„-10"><a href="#ç›®çš„-10" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>é€šè¿‡åˆ†äº«çš„æ–¹å¼æ¥é«˜æ•ˆçš„æ”¯æŒå¤§é‡çš„ç»†ç²’åº¦çš„å¯¹è±¡ã€‚   </p>
<h4 id="ç»“æ„-10"><a href="#ç»“æ„-10" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_fly.png" alt="image">  </p>
<p><strong>Flyweight</strong>: å£°æ˜äº†ç”¨æ¥æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨çŠ¶æ€çš„æ¥å£ã€‚<br><strong>ConcreteFlyweight</strong>: å®ç°äº†Flyweightæ¥å£ï¼Œå¹¶ä¸”æœ‰è‡ªå·±çš„å†…éƒ¨çŠ¶æ€ã€‚ConcreteFlyweightå¿…é¡»æ˜¯å¯ä»¥å…±äº«çš„ã€‚å®ƒå†…éƒ¨å­˜å‚¨çš„çŠ¶æ€å¿…é¡»æ˜¯ä¸ä¸Šä¸‹æ–‡æ— å…³çš„ã€‚<br><strong>UnsharedConcreteFlyweight</strong>: ä¸æ˜¯æ‰€æœ‰çš„Flyweightå­ç±»éƒ½éœ€è¦è¢«åˆ†äº«ï¼ŒFlyweightå¹¶ä¸å¼ºåˆ¶éœ€è¦è¢«å…±äº«ã€‚<br><strong>FlyweightFactory</strong>: åˆ›å»ºå’Œç®¡ç†flyweightå¯¹è±¡ã€‚ä¿è¯flyweightå¯ä»¥è¢«é€‚å½“çš„å…±äº«ã€‚å½“ç”¨æˆ·éœ€è¦ä¸€ä¸ªflyweightæ—¶ï¼ŒFlyweightFactoryä¼šæ ¹æ®æ˜¯å¦å·²ç»æœ‰è¯¥flyweightè€Œåˆ›å»ºæˆ–è€…ç›´æ¥è¿”å›ä¸€ä¸ªflyweightå¯¹è±¡ã€‚<br><strong>Client</strong>: æœ‰æŒ‡å‘flyweightçš„å¼•ç”¨ï¼ŒåŒæ—¶æœ‰flyweightçš„å¤–éƒ¨çŠ¶æ€ã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-10"><a href="#ä½•æ—¶ä½¿ç”¨-10" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><p>å½“æ»¡è¶³ä¸€ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶å¯ä»¥ä½¿ç”¨ï¼š   </p>
<ol>
<li>ä¸€ä¸ªåº”ç”¨ä½¿ç”¨äº†å¤§é‡çš„å¯¹è±¡ã€‚  </li>
<li>å› ä¸ºå¯¹è±¡çš„æ•°é‡åºå¤§è€Œå¯¼è‡´è€—è´¹å¤§é‡çš„å­˜å‚¨èµ„æºã€‚   </li>
<li>å¤§éƒ¨åˆ†çš„å¯¹è±¡çŠ¶æ€å¯ä»¥æå‡ºæ¥ä½œä¸ºå¤–éƒ¨çŠ¶æ€ä¼ å…¥ã€‚</li>
<li>å½“å¤–éƒ¨çŠ¶æ€è¢«æå–å‡ºæ¥ä»¥åï¼Œå¤§é‡çš„çš„å¯¹è±¡å¯ä»¥è¢«å‡ ä¸ªå¯ä»¥å…±äº«çš„å¯¹è±¡æ›¿ä»£ã€‚</li>
<li>åº”ç”¨ä¸ä¾èµ–äºå¯¹è±¡çš„ç‹¬ä¸€æ— äºŒæ€§ï¼Œå› ä¸ºå¯¹ç”¨æˆ·è€Œè¨€ï¼Œå®ƒä»¬è¡¨é¢ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯å®è´¨ä¸Šå®ƒä»¬æ˜¯è¢«å…±äº«çš„ã€‚   </li>
</ol>
<hr>
<h3 id="12-Proxy"><a href="#12-Proxy" class="headerlink" title="12. Proxy"></a>12. Proxy</h3><h4 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h4><p>ä¸ºä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†æˆ–è€…å ä½ç¬¦æ¥æ§åˆ¶å¯¹å®ƒçš„è®¿é—®ã€‚ä¹Ÿè¢«ç§°ä½œSurrogateã€‚</p>
<p>åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityä¸ActivityManagerServiceè¿›è¡Œè¿›ç¨‹é—´é€šä¿¡æ—¶ï¼ŒActivityæ˜¯ä¸ActivityManagerServiceçš„Proxyè¿›è¡Œç›´æ¥æ‰“äº¤é“çš„ã€‚</p>
<h4 id="ç»“æ„-11"><a href="#ç»“æ„-11" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_pxy.png" alt="image"></p>
<p><strong>Proxy</strong>: æœ‰ç€ä¸€ä¸ªæŒ‡å‘çœŸæ­£çš„ä¸»ä½“å¼•ç”¨ã€‚å®ƒä¼šæä¾›å’Œä¸»ä½“ä¸€æ ·çš„æ¥å£ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ›¿ä»£ä¸»ä½“ã€‚æ§åˆ¶å¯¹çœŸæ­£ä¸»ä½“çš„è®¿é—®ï¼Œä¹Ÿå¯èƒ½è´Ÿè´£ä¸»ä½“çš„åˆ›å»ºå’Œåˆ é™¤ã€‚ä¸åŒç§ç±»çš„proxy:   </p>
<pre><code>1. **remote porxy**: è´Ÿè´£å¯¹è¯·æ±‚å’Œå‚æ•°è¿›è¡Œç¼–ç ï¼Œç„¶åå°†è¯·æ±‚å‘é€ç»™åœ¨å…¶å®ƒåœ°å€ç©ºé—´çš„çœŸæ­£ä¸»ä½“ã€‚    
2. **virtual proxy**: ç¼“å­˜éƒ¨åˆ†çœŸæ­£ä¸»ä½“çš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒå¯ä»¥å»¶ç¼“è®¿é—®ä¸»ä½“ã€‚   
3. **protection proxy**: éªŒè¯è®¿é—®è€…æ˜¯å¦æœ‰æƒé™å‘é€è¯·æ±‚ã€‚   
</code></pre><p><strong>Subject</strong>: å®šä¹‰äº†RealSubjectå’ŒProxyçš„ç»Ÿä¸€æ¥å£ï¼Œæ‰€ä»¥Proxyå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ›¿ä»£RealSubjectã€‚<br><strong>RealSubject</strong>: å®šä¹‰äº†Proxyéœ€è¦ä»£ç†çš„çœŸæ­£å¯¹è±¡ã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-11"><a href="#ä½•æ—¶ä½¿ç”¨-11" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li><strong>remote proxy</strong>: ç»™ä¸åœ¨æœ¬åœ°ç©ºé—´çš„å¯¹è±¡æä¾›äº†ä¸€ä¸ªæœ¬åœ°è¡¨ç¤ºã€‚  </li>
<li><strong>virtual proxy</strong>: åœ¨å¿…è¦æ—¶æ‰éœ€æ±‚åˆ›å»ºæ˜‚è´µçš„å¯¹è±¡ï¼Œèƒ½æ‹–å°±æ‹–ã€‚   </li>
<li><strong>protection proxy</strong>: æ§åˆ¶è®¿é—®åŸå§‹å¯¹è±¡ã€‚åœ¨ä¸€ä¸ªå¯¹è±¡æœ‰ç€ä¸åŒç­‰çº§çš„è®¿é—®æƒé™æ—¶ï¼ŒProtection proxyååˆ†æœ‰ç”¨ã€‚   </li>
<li><strong>smart reference</strong>: å¯ä»¥ä»£æ›¿æŒ‡é’ˆï¼Œåœ¨è®¿é—®ä¸»ä½“å¯¹è±¡ä¹‹å‰å¯ä»¥è¿›è¡Œä¸€äº›é™„åŠ æ“ä½œã€‚æ¯”å¦‚ç»Ÿè®¡æœ‰å¤šå°‘ä¸ªå¼•ç”¨æŒ‡å‘è¯¥ä¸»ä½“ï¼Œåœ¨é€‚å½“çš„æ—¶å€™å¯ä»¥é‡Šæ”¾ä¸»ä½“ï¼›åœ¨ç¬¬ä¸€è®¿é—®æ—¶å°†ä¸»ä½“åŠ è½½åˆ°å†…å­˜ï¼›å¯¹ä¸»ä½“è¿›è¡ŒåŠ é”ç­‰ã€‚</li>
</ol>
<hr>
<h2 id="Behavioral-Patterns"><a href="#Behavioral-Patterns" class="headerlink" title="Behavioral Patterns"></a>Behavioral Patterns</h2><h3 id="13-Chain-of-Responsibility"><a href="#13-Chain-of-Responsibility" class="headerlink" title="13. Chain of Responsibility"></a>13. Chain of Responsibility</h3><h4 id="ç›®çš„-11"><a href="#ç›®çš„-11" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>è§£è€¦è¯·æ±‚çš„æ¥æ”¶å¯¹è±¡ï¼Œä½¿å¾—ä¸€ä¸ªè¯·æ±‚å¯ä»¥è¢«å¤šä¸ªæ¥æ”¶è€…å¤„ç†ã€‚å°†è¿™äº›æ¥æ”¶å¯¹è±¡ä¸²è”æˆé“¾ï¼Œå¹¶ä¸”å°†è¯·æ±‚ä¾æ¬¡ä¼ é€’è¿‡å»ï¼Œç›´åˆ°æœ‰æ¥æ”¶è€…å¯ä»¥å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</p>
<p>åœ¨Nodejsä¸­æœ‰Connectæ¨¡å—è´Ÿè´£åœ¨åŸå§‹çš„httpæ¨¡å—ä¸Šè¿›ä¸€æ­¥å¤„ç†httpè¯·æ±‚ï¼ŒåŠ å…¥äº†sessionã€Cookieã€bodyè§£æç­‰ä¸­é—´ä»¶æ¥ä¾æ¬¡å¤„ç†httpè¯·æ±‚ã€‚Connectçš„è®¾è®¡æ¨¡å¼çš„å°±æ˜¯å…¸å‹çš„Chain of Responsibilityã€‚</p>
<h4 id="ç»“æ„-12"><a href="#ç»“æ„-12" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_dpc.png" alt="image"></p>
<p><strong>Handler</strong>: å®šä¹‰äº†ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„æ¥å£ã€‚æä¾›äº†åç»§çš„è¿æ¥ã€‚<br><strong>ConcreteHandler</strong>: å¤„ç†å®ƒéœ€è¦å¤„ç†çš„è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥å°†è¯·æ±‚ç»§ç»­ä¼ é€’ä¸‹å»ã€‚<br><strong>Client</strong>: åˆ›å»ºä¸€ä¸ªè¯·æ±‚ç»™ConcreteHandlerã€‚  </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-12"><a href="#ä½•æ—¶ä½¿ç”¨-12" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>å½“ä¸æ­¢ä¸€ä¸ªå¯¹è±¡å¯ä»¥å¤„ç†ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå¹¶ä¸”æ¥æ”¶è€…çš„ä¼˜å…ˆçº§ä¸è¢«å‘ŠçŸ¥ï¼Œé‚£å°±éœ€è¦è¿™äº›æ¥æ”¶è€…è‡ªå·±ç¡®å®šä¼˜å…ˆçº§ã€‚</li>
<li>ä½ æƒ³å°†ä¸€ä¸ªè¯·æ±‚å‘é€ç»™å¤šä¸ªå¯¹è±¡ä¸­çš„ä¸€ä¸ªï¼Œä½†æ˜¯ä¸æƒ³æŒ‡æ˜æ¥æ”¶è€…æ—¶ã€‚</li>
<li>é‚£äº›å¯ä»¥å¤„ç†å¯¹è±¡çš„æ¥æ”¶è€…å¯ä»¥åŠ¨æ€çš„è¢«å†³å®šã€‚  </li>
</ol>
<hr>
<h3 id="14-Command"><a href="#14-Command" class="headerlink" title="14. Command"></a>14. Command</h3><h4 id="ç›®çš„-12"><a href="#ç›®çš„-12" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å°†è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥è®©ä½ ä½¿ç”¨ä¸åŒçš„è¯·æ±‚å‚æ•°åŒ–å®¢æˆ·ç«¯ã€åˆ—å‡ºè¯·æ±‚åºåˆ—ï¼Œè¿˜èƒ½å¤Ÿæ”¯æŒæ’¤é”€ç­‰è¡Œä¸ºã€‚ä¹Ÿè¢«ç§°ä½œActionã€Transactionã€‚</p>
<h4 id="ç»“æ„-13"><a href="#ç»“æ„-13" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_cmmd.png" alt="image"></p>
<p><strong>Command</strong>: å£°æ˜ä¸€ä¸ªæ¥å£æ¥æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚<br><strong>ConcreteCommand</strong>: å®šä¹‰ä¸€ä¸ªReceiverå’Œactionä¹‹é—´çš„ç»‘å®šå…³ç³»ã€‚å®ç°Executeå‡½æ•°æ¥åœ¨Receiverä¸Šæ‰§è¡ŒæŸäº›æ“ä½œã€‚å®è´¨ä¸Šæ˜¯å°†receiverå’Œä½œç”¨å…¶ä¸Šçš„Actionå°è£…æˆäº†ä¸€ä¸ªcommandçš„å¯¹è±¡ï¼Œä»¥ä¾¿è®°å½•å’Œæ’¤é”€ã€‚<br><strong>Client</strong>: åˆ›å»ºä¸€ä¸ªConcreteCommandå¹¶ä¸”åˆ¶å®šå®ƒçš„receiverã€‚<br><strong>Invoker</strong>: è®©commandæ‰§è¡Œè¯·æ±‚ã€‚<br><strong>Receiver</strong>: çŸ¥é“å¦‚ä½•å¯¹è¯·æ±‚è¿›è¡Œå…·ä½“çš„æ“ä½œã€‚  </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-13"><a href="#ä½•æ—¶ä½¿ç”¨-13" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>é€šè¿‡ä¸€ä¸ªactionæ¥å‚æ•°åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ã€‚ä½ å¯ä»¥åœ¨é¢å‘è¿‡ç¨‹çš„è¯­è¨€ä¸­ä½¿ç”¨å›è°ƒå‡½æ•°æ¥å®ç°è¿™ç§å®šåˆ¶ï¼Œå›è°ƒå‡½æ•°å°±æ˜¯å…ˆåœ¨æŸäº›åœ°æ–¹æ³¨å†Œï¼Œåœ¨ä»¥åæŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œçš„å‡½æ•°ã€‚Commandæ˜¯åœ¨é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ä¸€ç§å›è°ƒå‡½æ•°çš„æ›¿ä»£æ–¹å¼ã€‚  </li>
<li>åœ¨ä¸åŒçš„æ—¶åˆ»æŒ‡å®šã€æ”¾å…¥é˜Ÿåˆ—ï¼Œå’Œæ‰§è¡Œè¯·æ±‚ã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚çš„æ¥æ”¶è€…å¯ä»¥åœ¨ä¸åŒçš„åœ°å€ç©ºé—´ä¸­ï¼Œé‚£ä¹ˆä½ å¯ä»¥å°†è¯·æ±‚å°è£…æˆcommandç»™ä¸åŒçš„è¿›ç¨‹ï¼Œå¹¶ä¸”åœ¨è¿™äº›è¿›ç¨‹ä¸­æ‰§è¡Œè¿™ä¸ªcommandã€‚  </li>
<li>æ”¯æŒæ’¤é”€åŠ¨ä½œã€‚Commandå¯ä»¥å­˜å‚¨è£…çŠ¶æ€ç”¨æ¥æ’¤é”€è‡ªå·±æ‰§è¡Œçš„åŠ¨ä½œæ‰€äº§ç”Ÿçš„æ•ˆæœã€‚æ‰€æœ‰æ‰§è¡Œè¿‡çš„åŠ¨ä½œåº”è¯¥æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œä½¿ç”¨è¯¥åˆ—è¡¨å¯ä»¥å®ç°æ’¤é”€å’Œé‡åšä¸€ç³»åˆ—åŠ¨ä½œçš„åŠŸèƒ½ã€‚  </li>
<li>å¯ä»¥è®°å½•è¡Œä¸ºæ—¥å¿—ï¼Œå¯ä»¥åœ¨crashå‘ç”Ÿæ—¶æ¢å¤ç³»ç»ŸçŠ¶æ€ã€‚  </li>
<li>Commandå¯ä»¥è®©ç³»ç»Ÿå»ºç«‹åœ¨ç”±åŸºæœ¬æ“ä½œç»„æˆçš„é«˜çº§æ“ä½œä¹‹ä¸Šã€‚åœ¨ä¿¡æ¯ç³»ç»Ÿä¸­ï¼Œå°†åŸºæœ¬æ“ä½œå°è£…ä¸ºé«˜çº§æ“ä½œâ€“â€œäº‹åŠ¡â€œæ˜¯å¾ˆå¸¸è§çš„ä¸€ç§æ¨¡å¼ã€‚   </li>
</ol>
<hr>
<h3 id="15-Interpreter"><a href="#15-Interpreter" class="headerlink" title="15. Interpreter"></a>15. Interpreter</h3><h4 id="ç›®çš„-13"><a href="#ç›®çš„-13" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>ç»™å®šä¸€ç§è¯­è¨€ï¼Œåœ¨interpreterä¸­å®šä¹‰è¯¥è¯­è¨€çš„è¯­æ³•è¡¨ç¤ºæ¥ç¿»è¯‘è¯¥è¯­è¨€ã€‚  </p>
<h4 id="ç»“æ„-14"><a href="#ç»“æ„-14" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_itpr.png" alt="image">   </p>
<p><strong>AbstractExpression</strong>: ç»™æŠ½è±¡è¯­æ³•æ ‘ç§æ‰€æœ‰èŠ‚ç‚¹å£°æ˜æŠ½è±¡çš„å…¬å…±ç¿»è¯‘æ¥å£ã€‚<br><strong>TerminalExpression</strong>: å®ç°ä¸€ä¸ªå’Œè¯­æ³•ä¸­ç»ˆç»“ç¬¦å·ç›¸å…³çš„çš„ç¿»è¯‘å‡½æ•°ã€‚æ¯ä¸ªè¯­æ³•ä¸­çš„ç»ˆç»“ç¬¦éƒ½éœ€è¦æœ‰ä¸€ä¸ªå¯¹åº”çš„å®ä¾‹ã€‚<br><strong>NonterminalExpression</strong>: éç»ˆç»“ç¬¦è¡¨è¾¾å¼ã€‚æœ‰ç€ä¸€ç»„ç±»å‹ä¸ºAbstractExpressionçš„å˜é‡ï¼Œè¿™äº›å˜é‡æ˜¯è¯¥è¡¨è¾¾å¼çš„å­è¡¨è¾¾å¼ã€‚å®ƒä¼šæä¾›æ¥å£æ¥é€’å½’çš„ç¿»è¯‘æ‰€æœ‰å­è¡¨è¾¾å¼ã€‚<br><strong>Context</strong>: ç»™Interpreteræä¾›ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚<br><strong>Client</strong>: å»ºé€ ä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘æ¥è¡¨ç°æŸä¸€ç§è¯­æ³•å®šä¹‰çš„è¯­è¨€ã€‚æŠ½è±¡è¯­æ³•æ ‘ç”±NonterminalExpressionå’ŒTerminalExpressionæ„æˆã€‚Clientè´Ÿè´£è°ƒç”¨ç¿»è¯‘å‡½æ•°ã€‚  </p>
<h5 id="ä½•æ—¶ä½¿ç”¨-14"><a href="#ä½•æ—¶ä½¿ç”¨-14" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h5><p>åœ¨éœ€è¦ç¿»è¯‘ä¸€ç§è¯­è¨€æ—¶ä½¿ç”¨Interpreteræ¨¡å¼ï¼Œå¹¶ä¸”è¯¥è¯­è¨€ä¸­çš„è¯­å¥å¯ä»¥ä½¿ç”¨æŠ½è±¡è¯­æ³•æ ‘æ¥è¡¨ç¤ºã€‚ä¸‹åˆ—æƒ…å†µä¸‹ä½¿ç”¨æœ€ä½³ï¼š    </p>
<ol>
<li>è¯­æ³•æ¯”è¾ƒç®€å•ã€‚å¯¹äºè¾ƒä¸ºå¤æ‚çš„è¯­æ³•ï¼Œç”¨æ¥è¡¨ç°è¯­æ³•çš„ç±»çš„å±‚æ¬¡ç»“æ„å˜å¾—å¾ˆåºå¤§å’Œä¸å¥½ç®¡ç†ã€‚åœ¨è¯­æ³•å¤æ‚çš„æ—¶å€™è§£æç”Ÿæˆå™¨æ›´ä¸ºé€‚åˆã€‚ä»–ä»¬å¯ä»¥ä¸ä½¿ç”¨æŠ½è±¡è¯­æ³•æ ‘æ¥ç¿»è¯‘è¯­å¥ï¼Œå› æ­¤å¯ä»¥èŠ‚çœç©ºé—´å’Œæ—¶é—´ã€‚   </li>
<li>æ•ˆç‡ä¸æ˜¯ç‰¹åˆ«çš„é‡è¦çš„æ—¶å€™ã€‚æœ€æœ‰æ•ˆçš„ç¿»è¯‘æ–¹å¼é€šå¸¸ä¸æ˜¯ç›´æ¥ç¿»è¯‘è¯­æ³•æ ‘ï¼Œè€Œæ˜¯é¦–å…ˆå°†å®ƒä»¬è½¬åŒ–ä¸ºå…¶å®ƒçš„å½¢å¼ã€‚ä¾‹å¦‚ï¼Œæ­£åˆ™è¡¨è¾¾å¼ç»å¸¸é¦–å…ˆè¢«è½¬åŒ–æˆä¸€ä¸ªçŠ¶æ€æœºã€‚</li>
</ol>
<hr>
<h3 id="16-Iterator"><a href="#16-Iterator" class="headerlink" title="16. Iterator"></a>16. Iterator</h3><h4 id="ç›®çš„-14"><a href="#ç›®çš„-14" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>æä¾›äº†ä¸€ä¸ªå¯ä»¥æŒ‰åºè®¿é—®é›†åˆå¯¹è±¡å…ƒç´ çš„æ–¹å¼ï¼Œå¹¶ä¸”æ— éœ€æš´éœ²é›†åˆçš„å†…éƒ¨å®ç°ã€‚   </p>
<h4 id="ç»“æ„-15"><a href="#ç»“æ„-15" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_itr.png" alt="image">  </p>
<p><strong>Iterator</strong>: å®šä¹‰ä¸€ä¸ªè®¿é—®å’Œéå†å…ƒç´ çš„æ¥å£ã€‚<br><strong>ConcreteIterator</strong>: å®ç°Iteratoræ¥å£ï¼Œä¿å­˜å½“å‰éå†åˆ°çš„ä½ç½®ã€‚<br><strong>Aggregate</strong>: å®šä¹‰äº†ä¸€ä¸ªåˆ›å»ºIteratorå¯¹è±¡çš„æ¥å£ã€‚<br><strong>ConcreteAggregate</strong>: å®ç°äº†ç©¿ä»¶Iteratorçš„æ¥å£æ¥è¿”å›ä¸€ä¸ªåˆé€‚çš„ConcreteIteratorã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-15"><a href="#ä½•æ—¶ä½¿ç”¨-15" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>è®¿é—®ä¸€ä¸ªé›†åˆçš„å†…å®¹ï¼Œå¹¶ä¸”æ— éœ€æš´éœ²é›†åˆçš„å†…éƒ¨è¡¨ç¤ºã€‚  </li>
<li>å¯ä»¥æ”¯æŒå¤šç§éå†æ–¹å¼ã€‚</li>
<li>å¯ä»¥æä¾›ç»Ÿä¸€çš„æ¥å£æ¥éå†ä¸åŒçš„æ¥å£ï¼ˆå› æ­¤å¯ä»¥æ”¯æŒå¤šæ€çš„è¿­ä»£ï¼‰ã€‚</li>
</ol>
<hr>
<h3 id="17-Mediator"><a href="#17-Mediator" class="headerlink" title="17. Mediator"></a>17. Mediator</h3><h4 id="ç›®çš„-15"><a href="#ç›®çš„-15" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¥å°è£…ä¸€ç»„å¯¹è±¡ä¹‹é—´çš„äº¤äº’ã€‚Mediatorè®©å¯¹è±¡ä¹‹é—´ä¸é€šè¿‡æŒ‡æ˜çš„äº’ç›¸å¼•ç”¨æ¥å‡è½»å®ƒä»¬ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä»è€Œå¯ä»¥è®©ä½ äº’ä¸å½±å“çš„å˜åŒ–å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚   </p>
<h4 id="ç»“æ„-16"><a href="#ç»“æ„-16" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/2dp_media.png" alt="mediator">  </p>
<p><strong>Mediator</strong>: å®šä¹‰äº†ä¸€ä¸ªå’ŒåŒä¼´äº¤æµçš„æ¥å£ã€‚<br><strong>ConcreteMediator</strong>: å®ç°åˆä½œçš„æ¥å£æ¥è®©è¿™äº›ä¼™ä¼´å¯¹è±¡å¯ä»¥ç›¸äº’åä½œã€‚å®ƒçŸ¥é“å¹¶ä¸”ç»´æŠ¤ç€å®ƒçš„åŒä¼´å¯¹è±¡ã€‚<br><strong>Colleague classes</strong>: æ¯ä¸ªColleagueç±»éƒ½çŸ¥é“å®ƒçš„Mediatorå¯¹è±¡ã€‚å½“å®ƒæƒ³å’ŒåŒä¼´å¯¹è±¡äº¤æµçš„æ—¶å€™ï¼Œå®ƒä¼šé€šè¿‡å®ƒçš„mediatoræ¥è¿›è¡Œé—´æ¥çš„äº¤æµã€‚  </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-16"><a href="#ä½•æ—¶ä½¿ç”¨-16" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ç»„å¯¹è±¡é€šè¿‡å®šä¹‰è‰¯å¥½ä½†æ–¹å¼å¤æ‚çš„æ–¹å¼æ¥äº¤æµåˆä½œã€‚ç»“æœå°±å¯¼è‡´å®ƒä»¬ä¹‹é—´çš„ä¾èµ–ç»“æ„æ··ä¹±å¹¶ä¸”éš¾ä»¥ç†è§£ã€‚  </li>
<li>é‡æ–°ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œå› ä¸ºå®ƒå¼•ç”¨ç€è®¸å¤šå…¶å®ƒå¯¹è±¡ã€‚   </li>
<li>ä¸€ä¸ªåˆ†å¸ƒåœ¨å¤šä¸ªç±»ä¹‹é—´çš„è¡Œä¸ºåº”è¯¥å¾ˆå®¹æ˜“è¢«å®šåˆ¶ï¼Œè€Œä¸éœ€è¦æå‡ºæ¥å¾ˆå¤šçš„å­ç±»ã€‚</li>
</ol>
<hr>
<h3 id="18-Memento"><a href="#18-Memento" class="headerlink" title="18. Memento"></a>18. Memento</h3><h4 id="ç›®çš„-16"><a href="#ç›®çš„-16" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>ä¸ç”¨ç ´åå¯¹è±¡çš„å°è£…æ€§è´¨ï¼Œè·å–ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ä»¥ä¾¿è¯¥å¯¹è±¡å¯ä»¥æ¢å¤åŸæ¥çš„çŠ¶æ€ã€‚ä¹Ÿå¯ä»¥è¢«ä½œtokenã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒActivityå¯ä»¥é€šè¿‡savedInstanceStateæ¥ä¿å­˜å’Œæ¢å¤ä¸€ä¸ªActivityçš„çŠ¶æ€ã€‚    </p>
<h4 id="ç»“æ„-17"><a href="#ç»“æ„-17" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_memto.png" alt="image">  </p>
<p><strong>Memento</strong>ï¼šå­˜å‚¨Originatorå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ã€‚æœ‰originatorè‡ªå·±å†³å®šéœ€è¦ä¿å­˜å¤šå°‘çš„å†…éƒ¨çŠ¶æ€ã€‚å®ƒåº”è¯¥ä¿æŠ¤å­˜å‚¨çš„çŠ¶æ€åªç”±originatorè‡ªå·±è®¿é—®ã€‚Mementoæœ€å¥½æœ‰ä¸¤ç§æ¥å£ï¼ŒCaretakeråªèƒ½çœ‹åˆ°ä¸€ä¸ªâ€œç‹­çª„â€çš„æ¥å£ï¼Œå®ƒåªèƒ½å°†Mementoä¼ ç»™å…¶ä»–å¯¹è±¡ã€‚ç›¸åçš„ï¼ŒOriginatoråº”è¯¥å¯ä»¥çœ‹åˆ°ä¸€ä¸ªâ€œå®½å¹¿â€çš„æ¥å£ï¼Œä»è€Œå¯ä»¥è®©å®ƒè®¿é—®å­˜å‚¨çš„çŠ¶æ€ï¼Œä»è€Œæ¢å¤åˆ°åŸæ¥çš„çŠ¶æ€ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåªæœ‰äº§ç”Ÿmementoçš„originatoræ‰å¯ä»¥è®¿é—®mementoçš„å†…éƒ¨çŠ¶æ€ã€‚<br><strong>Originator</strong>ï¼šåˆ›å»ºä¸€ä¸ªmementoæ¥ä¿å­˜å®ƒçš„å†…éƒ¨çŠ¶æ€å¿«ç…§ã€‚ä½¿ç”¨Mementoæ¥æ¢å¤å®ƒçš„çŠ¶æ€ã€‚<br><strong>Caretaker</strong>: å®‰å…¨çš„ä¿å­˜ç€mementoã€‚ä¸ä¼šæ“ä½œå’Œè®¿é—®mementoçš„å†…éƒ¨çŠ¶æ€ã€‚</p>
<h4 id="ä½•æ—¶ä½¿ç”¨-17"><a href="#ä½•æ—¶ä½¿ç”¨-17" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å¿«ç…§éœ€è¦è¢«ä¿å­˜ä¸‹æ¥ï¼Œä»¥åå¯ä»¥ç”¨æ¥æ¢å¤çŠ¶æ€ã€‚   </li>
<li>ç›´æ¥è®¿é—®ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ä¼šå¯¼è‡´ç ´åä¸€ä¸ªå¯¹è±¡çš„å°è£…æ€§ï¼Œæš´éœ²å¯¹è±¡çš„å®ç°ç»†èŠ‚ã€‚</li>
</ol>
<hr>
<h3 id="19-Observer"><a href="#19-Observer" class="headerlink" title="19. Observer"></a>19. Observer</h3><h4 id="ç›®çš„-17"><a href="#ç›®çš„-17" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å®šä¹‰ä¸€ä¸ªä¸€å¯¹å¤šçš„å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå› æ­¤å½“ä¸€ä¸ªå¯¹è±¡å‘ç”Ÿæ”¹å˜ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡ä¼šæ”¶åˆ°æé†’ï¼Œå¹¶ä¸”è‡ªåŠ¨çš„æ”¹å˜çŠ¶æ€ã€‚å¯ä»¥ç§°ä½œDependentsï¼ŒPublish-Subscribeæ¨¡å¼ã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼Œæœ‰broadcast/broadcast receiveræœºåˆ¶ï¼Œåœ¨nodejsä¸­ï¼ŒåŒæ ·æœ‰event emmiter/listenæœºåˆ¶ã€‚</p>
<h4 id="ç»“æ„-18"><a href="#ç»“æ„-18" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_observer.png" alt="image">   </p>
<p><strong>Subject</strong>: çŸ¥é“æ‰€æœ‰çš„observerï¼Œobserverçš„æ•°é‡æ—¶ä¸å›ºå®šçš„ã€‚æä¾›æ¥å£æ¥æ·»åŠ æˆ–è€…ç§»é™¤æ‰€æœ‰çš„observerå¯¹è±¡ã€‚<br><strong>Observer</strong>: ç»™é‚£äº›éœ€è¦è§‚å¯Ÿsubjectå˜åŒ–çš„å¯¹è±¡æä¾›äº†ä¸€ä¸ªupdateçš„æ¥å£ã€‚<br><strong>ConcreteSubject</strong>: å­˜å‚¨äº†ConcreteObserveræ„Ÿå…´è¶£çš„çŠ¶æ€ï¼Œå½“å®ƒçš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæé†’å®ƒçš„è§‚å¯Ÿè€…ã€‚<br><strong>ConcreteObserver</strong>: æœ‰ä¸€ä¸ªæŒ‡å‘ConcreteSubjectå¯¹è±¡çš„å¼•ç”¨ï¼Œå­˜å‚¨äº†åº”è¯¥å’Œsubjectä¸€è‡´çš„çŠ¶æ€ã€‚å®ç°äº†Observerçš„æ›´æ–°æ¥å£ï¼Œæ¥ä¿æŒä¸subjectçŠ¶æ€çš„ä¸€è‡´ã€‚   </p>
<p>ç›®å‰ï¼Œå¾ˆå¤šä½¿ç”¨è¯¥æ¨¡å¼çš„ç³»ç»Ÿä¼šè¿›ä¸€æ­¥è§£è€¦åˆï¼Œä½¿å¾—subjectå’Œobserverç›¸äº’é€æ˜ã€‚</p>
<h4 id="ä½•æ—¶ä½¿ç”¨-18"><a href="#ä½•æ—¶ä½¿ç”¨-18" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ä¸ªæŠ½è±¡ç»“æ„ä¸­æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªä¾èµ–äºå¦ä¸€ä¸ªã€‚å°†è¿™ä¸¤ä¸ªéƒ¨åˆ†å°è£…æˆç‹¬ç«‹çš„å¯¹è±¡ï¼Œå¯ä»¥è®©ä½ ç‹¬ç«‹çš„ä¿®æ”¹å’Œé‡å¤ä½¿ç”¨å®ƒä»¬ã€‚   </li>
<li>å½“ä¸€ä¸ªå¯¹è±¡çš„å˜åŒ–éœ€è¦éœ€è¦å…¶ä»–å¯¹è±¡è·Ÿç€å˜åŒ–ï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“æœ‰å¤šå°‘å¯¹è±¡éœ€è¦è¢«ä¿®æ”¹çš„æ—¶å€™ã€‚  </li>
<li>å½“ä½ æƒ³è®©ä¸€ä¸ªå¯¹è±¡é€šçŸ¥å…¶å®ƒå¯¹è±¡ï¼Œè€Œæ— éœ€å…³å¿ƒè¿™äº›è¢«é€šçŸ¥çš„å¯¹è±¡æ˜¯è°æ—¶ã€‚ä¸€å¥è¯ï¼Œä½ ä¸æƒ³è®©è¿™äº›å¯¹è±¡ç´§å¯†è€¦åˆçš„æ—¶å€™ã€‚   </li>
</ol>
<hr>
<h3 id="20-State"><a href="#20-State" class="headerlink" title="20. State"></a>20. State</h3><h4 id="ç›®çš„-18"><a href="#ç›®çš„-18" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>è®©ä¸€ä¸ªå¯¹è±¡å¯ä»¥åœ¨å®ƒçš„çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ”¹å˜å®ƒçš„è¡Œä¸ºã€‚ä½¿å¾—å¯¹è±¡çœ‹ä¸Šå»æ”¹å˜äº†è‡ªå·±çš„ç±»ã€‚ä¹Ÿè¢«ç§°ä½œObject for Statesã€‚  </p>
<h4 id="ç»“æ„-19"><a href="#ç»“æ„-19" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_state.png" alt="state">   </p>
<p><strong>Context</strong>: å®šä¹‰äº†ç”¨æˆ·éœ€è¦çš„æ¥å£ã€‚ä¿å­˜ç€ä¸€ä¸ªå®šä¹‰äº†å½“å‰çŠ¶æ€çš„ConcreteStateå­ç±»å®ä¾‹ã€‚<br><strong>State</strong>: å®šä¹‰äº†ä¸€ä¸ªç”¨æ¥å°è£…ä¸ä¹‹å¯¹åº”çš„è¡Œä¸ºçš„æ¥å£ã€‚<br><strong>ConcreteState subclasses</strong>: æ¯ä¸ªsubclasså®ç°äº†ä¸çŠ¶æ€å¯¹åº”çš„è¡Œä¸ºã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-19"><a href="#ä½•æ—¶ä½¿ç”¨-19" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºä¾èµ–äºå®ƒçš„çŠ¶æ€ï¼Œå®ƒå¿…é¡»åœ¨è¿è¡Œæ—¶åˆ»æ ¹æ®å®ƒçš„çŠ¶æ€æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚   </li>
<li>ä¸€ä¸ªå¯¹è±¡çš„æ“ä½œæœ‰ç€å¤§é‡çš„æ¡ä»¶è¯­å¥ä¾èµ–äºå¯¹è±¡çš„çŠ¶æ€ã€‚è¿™äº›çŠ¶æ€é€šå¸¸åªæœ‰å¯æ•°çš„å‡ ç§ç»„åˆã€‚é€šå¸¸ï¼Œå¾ˆå¤šå‡½æ•°å«æœ‰é‡å¤çš„æ¡ä»¶ç»“æ„ã€‚Stateå¯ä»¥å°†è¿™äº›ä¸åŒçš„æ¡ä»¶åˆ†æ”¯æ”¾åˆ°ä¸åŒçš„ç±»ä¸­ã€‚ä»è€Œï¼Œä½ å¯ä»¥å°†å¯¹è±¡çš„çŠ¶æ€çœ‹æˆç‹¬ç«‹çš„å¯¹è±¡ï¼Œè¿™äº›çŠ¶æ€å¯ä»¥ç›¸äº’ç‹¬ç«‹çš„è¿›è¡Œåˆ‡æ¢ã€‚</li>
</ol>
<hr>
<h3 id="21-Strategy"><a href="#21-Strategy" class="headerlink" title="21. Strategy"></a>21. Strategy</h3><h4 id="ç›®çš„-19"><a href="#ç›®çš„-19" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>å®šä¹‰äº†ä¸€ç»„ç®—æ³•ï¼Œå¹¶ä¸”å¯¹æ¯ä¸ªç®—æ³•è¿›è¡Œäº†å°è£…ï¼Œå¹¶ä¸”ä»–ä»¬ä¹‹é—´æ˜¯å¯ä»¥ç›¸äº’åˆ‡æ¢çš„ã€‚Strategy è®©ç®—æ³•å¯ä»¥ç‹¬ç«‹äºç”¨æˆ·å˜åŒ–ã€‚ä¹Ÿå¯ä»¥ç§°ä½œPolicyã€‚   </p>
<h4 id="ç»“æ„-20"><a href="#ç»“æ„-20" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_strategy.png" alt="strategy">  </p>
<p><strong>Strategy</strong>: å®šä¹‰äº†æ‰€æœ‰æ”¯æŒçš„ç®—æ³•çš„é€šç”¨æ¥å£ã€‚Contextä½¿ç”¨è¯¥æ¥å£æ¥è°ƒç”¨ConcreteStrategyæä¾›çš„ç®—æ³•ã€‚<br><strong>ConcreteStrategy</strong>: ä½¿ç”¨Strategyå®šä¹‰çš„æ¥å£å®ç°äº†å…·ä½“çš„ç®—æ³•ã€‚<br><strong>Context</strong>: å®ƒä¼šé…ç½®ä¸€ä¸ªConcreteStrategyå¯¹è±¡ã€‚ä¿å­˜ä¸€ä¸ªå¯¹Strategyå¯¹è±¡çš„å¼•ç”¨ã€‚æä¾›äº†å¯ä»¥è®©Strategyè®¿é—®æ•°æ®çš„æ¥å£ã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-20"><a href="#ä½•æ—¶ä½¿ç”¨-20" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€äº›ç±»åªæœ‰ä»–ä»¬çš„è¡Œä¸ºä¸åŒï¼Œä½¿ç”¨Strategyå¯ä»¥è®©ä¸€ä¸ªç±»é…ç½®å¤šç§è¡Œä¸ºã€‚  </li>
<li>ä½ éœ€è¦ä¸åŒç®—æ³•ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½å®šä¹‰äº†ä¸€äº›æœ‰ç€ä¸åŒçš„æ—¶é—´ï¼ç©ºé—´å¤æ‚åº¦çš„ç®—æ³•ã€‚</li>
<li>ç”¨æˆ·æ— éœ€çŸ¥é“ç®—æ³•å¦‚ä½•ä½¿ç”¨æ•°æ®ã€‚ä½¿ç”¨Strategyå¯ä»¥é¿å…æš´éœ²å¤æ‚çš„ï¼Œç®—æ³•ç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚   </li>
<li>ä¸€ä¸ªç±»å®šä¹‰äº†å¤šç§è¡Œä¸ºï¼Œå¯¼è‡´åœ¨å‡½æ•°ä¸­æœ‰å¤šç§æ¡ä»¶è¯­å¥æ¥é€‰æ‹©è¿™äº›è¡Œä¸ºã€‚ä¸ºäº†é¿å…è¿™ç§ç¹æ‚çš„æ¡ä»¶è¯­å¥ï¼Œå°†ç›¸å…³çš„åˆ†æ”¯å°è£…æˆä¸åŒçš„Strategyå¯¹è±¡ã€‚  </li>
</ol>
<hr>
<h3 id="22-Template-Method"><a href="#22-Template-Method" class="headerlink" title="22. Template Method"></a>22. Template Method</h3><h4 id="ç›®çš„-20"><a href="#ç›®çš„-20" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>åœ¨å‡½æ•°ä¸­å®šä¹‰äº†ç®—æ³•çš„éª¨æ¶ï¼Œå°†å…·ä½“æŸäº›æ­¥éª¤äº¤ç»™å­ç±»æ¥å®ç°ã€‚Template Methodè®©å­ç±»é‡å®šä¹‰éƒ¨åˆ†æ­¥éª¤ï¼Œè€Œä¸ç”¨æ”¹å˜æ•´ä¸ªç®—æ³•çš„ç»“æ„ã€‚   </p>
<h4 id="ç»“æ„-21"><a href="#ç»“æ„-21" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_template.png" alt="template method">  </p>
<p><strong>AbstractClass</strong>: å®šä¹‰äº†æŠ½è±¡çš„primitiveå‡½æ•°ï¼Œè®©å­ç±»æ¥å…·ä½“å®ç°è¿™å‡ æ­¥ã€‚å®ç°äº†ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ï¼Œå†³å®šäº†ç®—æ³•çš„éª¨æ¶ã€‚template method è°ƒç”¨äº†primitiveæ–¹æ³•ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³•ã€‚<br><strong>ConcreteClass</strong>: å®ç°äº†primitiveæ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°å®šåˆ¶ç®—æ³•æŸäº›æ­¥éª¤çš„ç›®çš„ã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-21"><a href="#ä½•æ—¶ä½¿ç”¨-21" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>å®ç°ç®—æ³•ä¸­ä¸å¯å˜çš„éƒ¨åˆ†ï¼Œå°†å¯å˜çš„éƒ¨åˆ†äº¤ç»™å­ç±»å»å®ç°ã€‚  </li>
<li>å½“å‡ ä¸ªå­ç±»çš„å‡½æ•°ä¸­æœ‰ç€å…±åŒéƒ¨åˆ†è¡Œä¸ºï¼Œå¯ä»¥å°†è¿™å…±åŒçš„éƒ¨åˆ†åœ¨çˆ¶ç±»ä¸­å®ç°ï¼Œé¿å…ä»£ç çš„é‡å¤ã€‚æœ‰ä¸€ç§é€šè¿‡é‡æ„è¾¾åˆ°ä¸€èˆ¬åŒ–çš„ç›®çš„ã€‚  </li>
<li>æ§åˆ¶å­ç±»çš„æ‰©å±•ã€‚ä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªtemplateæ–¹æ³•åœ¨æŒ‡å®šä½ç½®è°ƒç”¨â€œhookâ€æ“ä½œï¼Œä»è€Œé™åˆ¶å­ç±»åªèƒ½åœ¨è¿™äº›hookçš„ä½ç½®è¿›è¡Œæ‰©å±•ã€‚   </li>
</ol>
<hr>
<h3 id="23-Visitor"><a href="#23-Visitor" class="headerlink" title="23. Visitor"></a>23. Visitor</h3><h4 id="ç›®çš„-21"><a href="#ç›®çš„-21" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>è¡¨ç¤ºä¸€ä¸ªå¯ä»¥å¯¹ç»“æ„ä½“ä¸­çš„å…ƒç´ è¿›è¡Œæ“ä½œçš„æ¨¡å¼ã€‚å¯ä»¥å¯¹å…¶ä¸­çš„å…ƒç´ æ·»åŠ æ–°çš„æ“ä½œï¼Œè€Œæ— éœ€ä¿®æ”¹è¯¥å…ƒç´ å¯¹åº”çš„ç±»ã€‚   </p>
<h4 id="ç»“æ„-22"><a href="#ç»“æ„-22" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p><img src="http://7xky03.com1.z0.glb.clouddn.com/23dp_visitor.png" alt="visitor">  </p>
<p><strong>Visitor</strong>: ç»™æ¯ä¸ªç»“æ„ä¸­çš„ç±»å®šä¹‰äº†ä¸€ä¸ªè®¿é—®å‡½æ•°ã€‚å‡½æ•°åæŒ‡æ˜äº†å®ƒèƒ½èƒ½å¤Ÿè®¿é—®çš„å¯¹è±¡ã€‚Visitorå†³å®šäº†è‡ªå·±å¯ä»¥è®¿é—®çš„å…ƒç´ ï¼Œé€šè¿‡ç‰¹å®šçš„å‚æ•°ï¼Œvisitorèƒ½å¤Ÿç›´æ¥çš„è®¿é—®è¿™äº›å…ƒç´ ã€‚<br><strong>Concrete Visitor</strong>: å®ç°Visitorå£°æ˜çš„æ¯ä¸ªæ“ä½œï¼Œæ¯ä¸ªæ“ä½œä½ç»“æ„ä¸­å¯¹åº”çš„å…ƒç´ å®ç°äº†ç®—æ³•çš„ä¸€ä¸ªç‰‡æ®µï¼ŒConcrete Visitoræä¾›äº†ç®—æ³•çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”å­˜å‚¨äº†æœ¬åœ°çŠ¶æ€ï¼Œå¯ä»¥åŠ é€Ÿéå†ã€‚<br><strong>Element</strong>: å®šä¹‰äº†å¯ä»¥æ¥å—Visitorçš„æ¥å£ã€‚<br><strong>ConcreteElement</strong>: å®ç°äº†æ¥å—æ¥å£ã€‚<br><strong>ObjectStructure</strong>: å¯ä»¥åˆ—ä¸¾è‡ªå·±çš„elementã€‚æä¾›äº†ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„æ¥å£æ¥è®©visitoræ¥è®¿é—®å®ƒçš„å…ƒç´ ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªcompositeç»“æ„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€é›†åˆç­‰ã€‚   </p>
<h4 id="ä½•æ—¶ä½¿ç”¨-22"><a href="#ä½•æ—¶ä½¿ç”¨-22" class="headerlink" title="ä½•æ—¶ä½¿ç”¨"></a>ä½•æ—¶ä½¿ç”¨</h4><ol>
<li>ä¸€ä¸ªç»“æ„ä½“ä¸­æœ‰ç€å¾ˆå¤šæ¥å£ä¸åŒçš„å…ƒç´ å¯¹è±¡ï¼ŒåŒæ—¶ä½ å¸Œæœ›å¯¹å…¶ä¸­çš„è¿™äº›å…ƒç´ è¿›è¡Œæ“ä½œã€‚   </li>
<li>ä½ éœ€è¦å¯¹ä¸€ä¸ªç»“æ„ä½“ä¸­çš„å¯¹è±¡è¿›è¡Œå¾ˆå¤šä¸åŒçš„ï¼Œå¹¶ä¸”ä¸ç›¸å…³çš„æ“ä½œï¼ŒåŒæ—¶ä½ ä¸å¸Œæœ›â€œæ±¡æŸ“â€è¿™äº›åŸæœ‰çš„ç±»ã€‚Visitorå¯ä»¥è®©ä½ å°†è¿™äº›æ— å…³çš„æ“ä½œå®šä¹‰åœ¨ä¸€ä¸ªç±»ä¸­ã€‚</li>
<li>ç»“æ„ä½“ä¸­å¯¹è±¡çš„ç±»å¾ˆå°‘å˜åŒ–ï¼Œä½†æ˜¯ä½ å¸¸å¸¸æƒ³å¯¹ç»“æ„æ·»åŠ æ–°çš„æ“ä½œã€‚ä¿®æ”¹ç»“æ„ä½“ä¸­çš„ç±»çš„æ¥å£ï¼Œä¼šå¯¼è‡´éœ€è¦é‡æ–°å®šä¹‰visitorçš„æ¥å£ï¼Œè¿™äº›ä»£ä»·å¾ˆå¤§ã€‚æ‰€ä»¥å¦‚æœç»“æ„ä½“ä¸­çš„ç±»å¦‚æœå¸¸å¸¸å˜åŒ–ï¼Œé‚£ä¹ˆæœ€å¥½è¿˜æ˜¯å°†æ“ä½œå®šä¹‰åœ¨è¿™äº›ç±»ä¸­ï¼Œè€Œä¸è¦ç”¨visitorã€‚   </li>
</ol>
<hr>
<blockquote>
<p>æ•´ç†å®Œäº†23ä¸ªè®¾è®¡æ¨¡å¼ï¼Œç»å¸¸å›é¡¾ï¼Œå¿…å°†ä¼šå—ç›ŠåŒªæµ…ã€‚</p>
</blockquote>
<div class="tip"><br>    æœ¬æ–‡å¯ä»¥è½¬è½½ï¼Œä½†è¯·æ³¨æ˜æ–‡ç« æ¥è‡ªï¼š<a href="http://itanch.github.io/">http://itanch.github.io/</a><br></div>






]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;æœ¬ç¯‡æ–‡ç« æ˜¯å¯¹&lt;em&gt;Design Patterns: Elements of Reusable Object-Oriented Software&lt;/em&gt;çš„æ€»ç»“ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;çœ‹å®Œ&lt;em&gt;Design Patterns: Elements of Reusable Object-Oriented Software&lt;/em&gt;å·²ç»æœ‰äº›æ—¶æ—¥äº†ï¼Œç°åœ¨æç¬”å°†å…¶æ¦‚æ‹¬æ€»ç»“ä¸€ä¸‹ï¼Œä»¥å¤‡å°†æ¥çš„å‚è€ƒã€‚æ­¤ä¹¦æ€»ç»“äº†23ä¸­ä¸åŒçš„è®¾è®¡æ¨¡å¼ï¼Œå¹¶ä¸”å°†å®ƒä»¬çš„è®¾è®¡ç›®çš„ã€ç»“æ„ã€ç”¨æ³•ç­‰æ–¹é¢è¿›è¡Œçš„å¾ˆå¥½çš„ä»‹ç»ï¼Œæ˜¯ä¸€æœ¬å€¼å¾—æ”¾åœ¨æ‰‹è¾¹éšæ—¶æŸ¥é˜…çš„å·¥å…·ä¹¦ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="http://itanch.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>å†™åœ¨2017çš„å¼€å§‹</title>
    <link href="http://itanch.github.io/2017/02/14/%E5%86%99%E5%9C%A82017%E7%9A%84%E5%BC%80%E5%A7%8B/"/>
    <id>http://itanch.github.io/2017/02/14/å†™åœ¨2017çš„å¼€å§‹/</id>
    <published>2017-02-14T08:02:40.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>åšå®¢çš„ä¸€æ¬¡æ¬è¿</p>
</blockquote>
<h2 id="åšå®¢æ¬è¿å†å²"><a href="#åšå®¢æ¬è¿å†å²" class="headerlink" title="åšå®¢æ¬è¿å†å²"></a>åšå®¢æ¬è¿å†å²</h2><p>ä¸€å¹´å‰ï¼Œåœ¨ä¾é githubæ­å»ºäº†ä¸ªäººåšå®¢åï¼Œå†™äº†ä¸€äº›æ–‡ç« ã€‚ä¸€å¹´å<code>liutianchi.com</code>åŸŸåæ²¡æœ‰ç»­è´¹ï¼Œå°±è¢«é˜¿é‡Œäº‘å°æ‰ï¼Œæ‰€ä»¥åœ¨githubä¸Šçš„åšå®¢æš‚æ—¶æ— æ³•è®¿é—®ã€‚æ‰€ä»¥ï¼Œæš‚æ—¶å°†åšå®¢è¿ç§»åˆ°<a href="http://blog.csdn.net/tianchi92" target="_blank" rel="external">CSDN</a>ç»§ç»­æˆ‘çš„åšå®¢ä¹‹æ—…ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘æ”¾å¼ƒè´­ä¹°åŸŸåï¼Œé‡‡ç”¨githubé»˜è®¤åŸŸåç»§ç»­åœ¨<code>http://itanch.github.io/</code>è®°å½•æˆ‘çš„å­¦ä¹ ç‚¹æ»´ï¼Œå¹¶ä¸”å°†éƒ¨åˆ†è‡ªå·±è®¤ä¸ºæœ‰ä»·å€¼çš„æ–‡ç« ä»CSDNä¸Šè¿ç§»äº†è¿‡æ¥ã€‚</p>
<p>å¸Œæœ›æ–°çš„ä¸€å¹´æœ‰æ›´å¤šçš„æ”¶è·:)ã€‚æƒ…äººèŠ‚å¿«ä¹ï¼</p>
<a id="more"></a>
<p><img src="http://7xky03.com1.z0.glb.clouddn.com/lalaland.jpg" alt="lalaland"></p>
<h2 id="2017åšå®¢è®¡åˆ’"><a href="#2017åšå®¢è®¡åˆ’" class="headerlink" title="2017åšå®¢è®¡åˆ’"></a>2017åšå®¢è®¡åˆ’</h2><ol>
<li>é‡æ–°æ•´ç†ä¸€é32ç§è®¾è®¡æ¨¡å¼</li>
<li>é‡æ–°æ•´ç†ä¸€éAndroidå››å¤§ç»„ä»¶çš„è¿è¡Œæ¡†æ¶</li>
<li>å…¶å®ƒ</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åšå®¢çš„ä¸€æ¬¡æ¬è¿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;åšå®¢æ¬è¿å†å²&quot;&gt;&lt;a href=&quot;#åšå®¢æ¬è¿å†å²&quot; class=&quot;headerlink&quot; title=&quot;åšå®¢æ¬è¿å†å²&quot;&gt;&lt;/a&gt;åšå®¢æ¬è¿å†å²&lt;/h2&gt;&lt;p&gt;ä¸€å¹´å‰ï¼Œåœ¨ä¾é githubæ­å»ºäº†ä¸ªäººåšå®¢åï¼Œå†™äº†ä¸€äº›æ–‡ç« ã€‚ä¸€å¹´å&lt;code&gt;liutianchi.com&lt;/code&gt;åŸŸåæ²¡æœ‰ç»­è´¹ï¼Œå°±è¢«é˜¿é‡Œäº‘å°æ‰ï¼Œæ‰€ä»¥åœ¨githubä¸Šçš„åšå®¢æš‚æ—¶æ— æ³•è®¿é—®ã€‚æ‰€ä»¥ï¼Œæš‚æ—¶å°†åšå®¢è¿ç§»åˆ°&lt;a href=&quot;http://blog.csdn.net/tianchi92&quot;&gt;CSDN&lt;/a&gt;ç»§ç»­æˆ‘çš„åšå®¢ä¹‹æ—…ã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨ï¼Œæˆ‘æ”¾å¼ƒè´­ä¹°åŸŸåï¼Œé‡‡ç”¨githubé»˜è®¤åŸŸåç»§ç»­åœ¨&lt;code&gt;http://itanch.github.io/&lt;/code&gt;è®°å½•æˆ‘çš„å­¦ä¹ ç‚¹æ»´ï¼Œå¹¶ä¸”å°†éƒ¨åˆ†è‡ªå·±è®¤ä¸ºæœ‰ä»·å€¼çš„æ–‡ç« ä»CSDNä¸Šè¿ç§»äº†è¿‡æ¥ã€‚&lt;/p&gt;
&lt;p&gt;å¸Œæœ›æ–°çš„ä¸€å¹´æœ‰æ›´å¤šçš„æ”¶è·:)ã€‚æƒ…äººèŠ‚å¿«ä¹ï¼&lt;/p&gt;
    
    </summary>
    
    
      <category term="è®°å½•" scheme="http://itanch.github.io/tags/%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(18):Androidåº”ç”¨çš„æ˜¾ç¤º</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-18-Android%E5%BA%94%E7%94%A8%E7%9A%84%E6%98%BE%E7%A4%BA/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-18-Androidåº”ç”¨çš„æ˜¾ç¤º/</id>
    <published>2017-02-14T07:04:48.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-å¯åŠ¨ActivityManagerService"><a href="#1-å¯åŠ¨ActivityManagerService" class="headerlink" title="1. å¯åŠ¨ActivityManagerService"></a>1. å¯åŠ¨ActivityManagerService</h2><p>åœ¨å‰é¢ç¬¬14ç« è®²åˆ°ï¼Œåœ¨Systemè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨ç³»ç»Ÿçš„ä¸€äº›åŸºæœ¬æœåŠ¡ã€‚å¯åŠ¨å°±æœ‰ActivityManagerServiceå’ŒPackageManagerServiceã€‚åœ¨SystemServerä¸­å¦‚ä¸‹å¯åŠ¨ActivityManagerServiceã€‚</p>
<p><em>frameworks/base/services/java/com/android/server/SystemServer.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Activity manager runs the show.</span></div><div class="line">mActivityManagerService = mSystemServiceManager.startService(ActivityManagerService.Lifecycle.class).getService();</div></pre></td></tr></table></figure>   </p>
<p>startServiceå°±æ˜¯åˆ›å»ºäº†ActivityManagerServiceçš„å®ä¾‹å¯¹è±¡mActivityManagerServiceï¼Œç„¶åå¯åŠ¨äº†ActivityManagerServiceçš„looperçº¿ç¨‹ã€‚åœ¨SystemServerå¯åŠ¨äº†åŸºæœ¬æœåŠ¡åï¼Œå°±ä¼šè°ƒç”¨mActivityManagerServiceçš„systemReadyå‡½æ•°æ¥å¯åŠ¨HomeActivityã€‚<br><a id="more"></a></p>
<h2 id="2-å¯åŠ¨HomeActivity"><a href="#2-å¯åŠ¨HomeActivity" class="headerlink" title="2. å¯åŠ¨HomeActivity"></a>2. å¯åŠ¨HomeActivity</h2><p>ç›®å‰ä»åœ¨SystemServerä¸»çº¿ç¨‹ä¸­è°ƒç”¨çš„systemReadyå‡½æ•°ã€‚è¯¥å‡½æ•°åˆä¼šæ¥ç€è°ƒç”¨startHomeActivityLockedå‡½æ•°æ¥å¯åŠ¨HomeActivityï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<p><em>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</div><div class="line">      <span class="comment">//...</span></div><div class="line">      <span class="comment">//å…ˆåˆ›å»ºä¸€ä¸ªå¯åŠ¨Homeçš„Intentï¼ŒIntentçš„categoryä¸ºandroid.intent.category.home</span></div><div class="line">      Intent intent = getHomeIntent();</div><div class="line">      ActivityInfo aInfo =</div><div class="line">          resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);</div><div class="line">      <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</div><div class="line">          intent.setComponent(<span class="keyword">new</span> ComponentName(</div><div class="line">                  aInfo.applicationInfo.packageName, aInfo.name));</div><div class="line">          <span class="comment">// Don't do this if the home app is currently being</span></div><div class="line">          <span class="comment">// instrumented.</span></div><div class="line">          aInfo = <span class="keyword">new</span> ActivityInfo(aInfo);</div><div class="line">          aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</div><div class="line">          <span class="comment">//å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨homeï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰ç›¸åº”çš„è¿›ç¨‹ï¼Œæ‰€ä»¥appä¸ºnull</span></div><div class="line">          ProcessRecord app = getProcessRecordLocked(aInfo.processName,</div><div class="line">                  aInfo.applicationInfo.uid, <span class="keyword">true</span>);</div><div class="line">          <span class="keyword">if</span> (app == <span class="keyword">null</span> || app.instrumentationClass == <span class="keyword">null</span>) &#123;</div><div class="line">              intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">              <span class="comment">//è¿™é‡Œå¼€å§‹å¯åŠ¨HomeActivity</span></div><div class="line">              mStackSupervisor.startHomeActivity(intent, aInfo, reason);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>   </p>
<p>è¿™é‡Œäº¤ç»™äº†mStackSupervisor.startHomeActivityå‡½æ•°æ¥å¯åŠ¨HomeActivityï¼Œç„¶åå°±ä¼šè°ƒç”¨startActivityLockedå‡½æ•°ã€‚åˆ°è¿™é‡Œï¼Œå°±å¼€å§‹é‡å¤ç¬¬2ç« ä¸­ï¼Œå¯åŠ¨æ™®é€šåº”ç”¨çš„activityçš„è¿‡ç¨‹äº†ï¼Œä¸å†èµ˜è¿°ã€‚å…¶ä¸­ï¼Œåœ¨Launcherçš„Manifestä¸­æŒ‡æ˜äº†å®ƒçš„ç±»å‹ä¸ºandroid.intent.category.homeï¼Œæ‰€ä»¥å¯åŠ¨çš„å°±æ˜¯Laucheråº”ç”¨ã€‚</p>
<h2 id="3-Launcherå±•ç¤ºåº”ç”¨"><a href="#3-Launcherå±•ç¤ºåº”ç”¨" class="headerlink" title="3. Launcherå±•ç¤ºåº”ç”¨"></a>3. Launcherå±•ç¤ºåº”ç”¨</h2><p>ä¸‹é¢ä»Launcherçš„onCreateå‡½æ•°å¼€å§‹è®²èµ·ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<p><em>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">LauncherAppState app = LauncherAppState.getInstance();</div><div class="line"><span class="comment">//å°†è¯¥launcherè®¾ç½®ä¸ºmModelçš„callbackå‡½æ•°</span></div><div class="line">mModel = app.setLauncher(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!mRestoring) &#123;</div><div class="line">    <span class="keyword">if</span> (DISABLE_SYNCHRONOUS_BINDING_CURRENT_PAGE) &#123;</div><div class="line">        <span class="comment">// If the user leaves launcher, then we should just load items asynchronously when</span></div><div class="line">        <span class="comment">// they return.</span></div><div class="line">        mModel.startLoader(PagedView.INVALID_RESTORE_PAGE);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// We only load the page synchronously if the user rotates (or triggers a</span></div><div class="line">        <span class="comment">// configuration change) while launcher is in the foreground</span></div><div class="line">        <span class="comment">//å¼€å§‹åŠ è½½åº”ç”¨ä¿¡æ¯</span></div><div class="line">        mModel.startLoader(mWorkspace.getRestorePage());</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>å…¶ä¸­mModelæ˜¯ä¸€ä¸ªLauncherModelå¯¹è±¡ï¼Œå®ƒè´Ÿè´£åŠ è½½åº”ç”¨ä¿¡æ¯ã€‚åœ¨é‡è½½çš„startLoaderå‡½æ•°ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startLoader</span><span class="params">(<span class="keyword">int</span> synchronousBindPage, <span class="keyword">int</span> loadFlags)</span> </span>&#123;</div><div class="line">       <span class="comment">//...</span></div><div class="line">       <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">           <span class="comment">//...</span></div><div class="line">           <span class="comment">// Don't bother to start the thread if we know it's not going to do anything</span></div><div class="line">           <span class="keyword">if</span> (mCallbacks != <span class="keyword">null</span> &amp;&amp; mCallbacks.get() != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">//éœ€è¦é‡æ–°åŠ è½½äº†ï¼Œæ‰€ä»¥å…ˆæŠŠåŸæ¥çš„åŠ è½½ä»»åŠ¡åœäº†</span></div><div class="line">               <span class="comment">// If there is already one running, tell it to stop.</span></div><div class="line">               stopLoaderLocked();</div><div class="line">               <span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªåŠ è½½ä»»åŠ¡</span></div><div class="line">               mLoaderTask = <span class="keyword">new</span> LoaderTask(mApp.getContext(), loadFlags);</div><div class="line">               <span class="keyword">if</span> (synchronousBindPage != PagedView.INVALID_RESTORE_PAGE</div><div class="line">                   <span class="comment">//...</span></div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">//äº¤ç»™workThreadæ¥å¤„ç†è¿™ä¸ªä»»åŠ¡</span></div><div class="line">                   sWorkerThread.setPriority(Thread.NORM_PRIORITY);</div><div class="line">                   <span class="comment">//sWorkeræ˜¯sWorkerThreadçš„Handler</span></div><div class="line">                   sWorker.post(mLoaderTask);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>   
<p>å› ä¸ºåŠ è½½æ‰€æœ‰å®‰è£…çš„åº”ç”¨ä¿¡æ¯æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åº”è¯¥äº¤ç»™ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ¥å¤„ç†ã€‚è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸€ä¸ªåŠ è½½ä»»åŠ¡mLoaderTaskï¼Œç„¶åå°†å®ƒäº¤ç»™sWorkerThreadæ¥å¤„ç†ã€‚sWorkerThreadæ˜¯ä¸€ä¸ªHandlerThreadï¼Œæˆ‘ä»¬çŸ¥é“HandlerThreadæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå¹¶ä¸”æœ‰ç€è‡ªå·±çš„looperã€‚mLoaderTaskåŠ è½½ä»»åŠ¡æ‰§è¡Œä¸€æ¬¡å°±å¯ä»¥ç»“æŸï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ç”¨ä¸€ä¸ªHandlerThreadåœ¨è¿™é‡Œä¸æ–­ç­‰å¾…ç€å…¶å®ƒä»»åŠ¡å‘¢ï¼Ÿå› ä¸ºæ¡Œé¢ä¸Šåº”ç”¨å¯ä»¥åŠ¨æ€çš„æ·»åŠ å’Œåˆ é™¤ï¼Œæ‰€ä»¥åº”ç”¨çš„åŠ è½½å¯èƒ½æ˜¯é¢‘ç¹çš„ã€‚è¿™é‡Œä½¿ç”¨HandlerThreadå¯ä»¥é¿å…é‡å¤çš„åˆ›å»ºåŠ è½½çº¿ç¨‹ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°±çœ‹LoaderTask.runå‡½æ•°ä¸­å…·ä½“åšäº†å“ªäº›ä»»åŠ¡ã€‚</p>
<p><em>packages/apps/Launcher3/src/com/android/launcher3/LauncherModel.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">          <span class="keyword">if</span> (mStopped) &#123;</div><div class="line">              <span class="keyword">return</span>;</div><div class="line">          &#125;</div><div class="line">          mIsLoaderTaskRunning = <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Optimize for end-user experience: if the Launcher is up and // running with the</span></div><div class="line">      <span class="comment">// All Apps interface in the foreground, load All Apps first. Otherwise, load the</span></div><div class="line">      <span class="comment">// workspace first (default).</span></div><div class="line">      keep_running: &#123;</div><div class="line">          <span class="keyword">if</span> (DEBUG_LOADERS) Log.d(TAG, <span class="string">"step 1: loading workspace"</span>);</div><div class="line">          <span class="comment">//å¯åŠ¨workspace</span></div><div class="line">          loadAndBindWorkspace();</div><div class="line">          <span class="keyword">if</span> (mStopped) &#123;</div><div class="line">              <span class="keyword">break</span> keep_running;</div><div class="line">          &#125;</div><div class="line">          waitForIdle();</div><div class="line">          <span class="comment">// second step</span></div><div class="line">          <span class="keyword">if</span> (DEBUG_LOADERS) Log.d(TAG, <span class="string">"step 2: loading all apps"</span>);</div><div class="line">          <span class="comment">//åŠ è½½åº”ç”¨</span></div><div class="line">          loadAndBindAllApps();</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//...</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>   </p>
<p>WorkSpaceå°±æ˜¯Androidæ¡Œé¢ä¸­çš„åˆ†å±ï¼Œæ¯ä¸ªåˆ†å±æœ‰è‹¥å¹²åº”ç”¨ã€‚å…ˆåŠ è½½å·¥ä½œåŒºï¼Œå†åŠ è½½åº”ç”¨æ›´ç¬¦åˆç”¨æˆ·çš„å¿ƒç†é¢„æœŸï¼Ÿå‡½æ•°loadAndBindAllAppsä¼šåˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡åº”ç”¨ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ä¿¡æ¯ï¼Œåˆ™ç›´æ¥å°†appæ˜¾ç¤ºåœ¨æ¡Œé¢ä¸Šå³å¯ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦å…ˆè°ƒç”¨å‡½æ•°loadAllAppsï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><em>packages/apps/Launcher3/src/com/android/luancher3/LauncherModel.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadAllApps</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">final</span> Callbacks oldCallbacks = mCallbacks.get();</div><div class="line"></div><div class="line">           <span class="comment">// Clear the list of apps</span></div><div class="line">           mBgAllAppsList.clear();</div><div class="line">           <span class="keyword">for</span> (UserHandleCompat user : profiles) &#123;</div><div class="line">               <span class="comment">// Query for the set of apps</span></div><div class="line">               <span class="comment">//è·å–æ‰€æœ‰çš„appä¿¡æ¯ï¼Œè¿™é‡Œæœ€ç»ˆè¿˜æ˜¯ä»PackageManagerServiceè·å–çš„åº”ç”¨ä¿¡æ¯</span></div><div class="line">               <span class="keyword">final</span> List&lt;LauncherActivityInfoCompat&gt; apps = mLauncherApps.getActivityList(<span class="keyword">null</span>, user);</div><div class="line">        </div><div class="line">               <span class="comment">// Create the ApplicationInfos</span></div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; apps.size(); i++) &#123;</div><div class="line">                   LauncherActivityInfoCompat app = apps.get(i);</div><div class="line">                   <span class="comment">//æŠŠæ¯ä¸ªåº”ç”¨ä¿¡æ¯å°è£…æˆAppInfo</span></div><div class="line">                   <span class="comment">// This builds the icon bitmaps.</span></div><div class="line">                   mBgAllAppsList.add(<span class="keyword">new</span> AppInfo(mContext, app, user, mIconCache));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//...</span></div><div class="line">           <span class="comment">// Huh? Shouldn't this be inside the Runnable below?</span></div><div class="line">           <span class="keyword">final</span> ArrayList&lt;AppInfo&gt; added = mBgAllAppsList.added;</div><div class="line">           mBgAllAppsList.added = <span class="keyword">new</span> ArrayList&lt;AppInfo&gt;();</div><div class="line">            </div><div class="line">           <span class="comment">//è¿™é‡Œä¸€ç›´è¿è¡Œåœ¨Launcherä¸­åˆ›å»ºçš„ä¸€ä¸ªHandlerThreadå­çº¿ç¨‹ä¸­</span></div><div class="line">           <span class="comment">//è·å–äº†åº”ç”¨ä¿¡æ¯åï¼Œéœ€è¦é€šçŸ¥ä¸»çº¿ç¨‹è¿›è¡Œuiæ›´æ–°ï¼ŒmHandleræ˜¯ä¸»çº¿ç¨‹çš„Handler</span></div><div class="line">           <span class="comment">// Post callback on main thread</span></div><div class="line">           mHandler.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   <span class="comment">//è¿™ä¸ªcallbackå°±æ˜¯launcher</span></div><div class="line">                   <span class="keyword">final</span> Callbacks callbacks = tryGetCallbacks(oldCallbacks);</div><div class="line">                   <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</div><div class="line">                      <span class="comment">//æ˜¾ç¤ºæ‰€æœ‰åº”ç”¨</span></div><div class="line">                       callbacks.bindAllApplications(added);</div><div class="line">                      <span class="comment">//...</span></div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="comment">//...</span></div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">           <span class="comment">//...</span></div><div class="line">       &#125;</div></pre></td></tr></table></figure>   </p>
<p>mLauncherApps.getActivityListè·å–appä¿¡æ¯çš„æ–¹æ³•æ˜¯é€šè¿‡å‘PackageManagerå‘é€è¯·æ±‚çš„æ–¹å¼å®ç°çš„ã€‚ä¸‹é¢å›åˆ°Launcherä¸»çº¿ç¨‹ï¼Œå¼€å§‹æ˜¾ç¤ºåº”ç”¨å›¾æ ‡ã€‚é¦–å…ˆçœ‹ä¸€çœ¼è¿™ä¸ªå›è°ƒå‡½æ•°ï¼š</p>
<p><em>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Add the icons for all apps.</div><div class="line">  *</div><div class="line">  * Implementation of the method from LauncherModel.Callbacks.</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindAllApplications</span><span class="params">(<span class="keyword">final</span> ArrayList&lt;AppInfo&gt; apps)</span> </span>&#123;</div><div class="line">     <span class="comment">//...</span></div><div class="line">     <span class="keyword">if</span> (mAppsView != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="comment">//mAppsViewç®¡ç†ç€æ‰€æœ‰åº”ç”¨çš„view</span></div><div class="line">         mAppsView.setApps(apps);</div><div class="line">     &#125;</div><div class="line">     <span class="comment">//...</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>   </p>
<p>mAppsViewæ˜¯ä¸€ä¸ªviewçš„å®¹å™¨ï¼Œç»´æŒäº†ä¸€ä¸ªAlphabeticalAppsListåˆ—è¡¨ï¼Œä¿å­˜åº”ç”¨çš„ä¿¡æ¯ã€‚å½“å‘å…¶ä¸­æ·»åŠ æ–°çš„åº”ç”¨ä¿¡æ¯åï¼Œä¼šå¯¹homeä¸Šçš„åº”ç”¨è¿›è¡Œæ›´æ–°ã€‚å½“homeä¸Šçš„å›¾æ ‡è¢«ç‚¹å‡»åï¼Œä¼šè§¦å‘å¯åŠ¨è¯¥åº”ç”¨ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-å¯åŠ¨ActivityManagerService&quot;&gt;&lt;a href=&quot;#1-å¯åŠ¨ActivityManagerService&quot; class=&quot;headerlink&quot; title=&quot;1. å¯åŠ¨ActivityManagerService&quot;&gt;&lt;/a&gt;1. å¯åŠ¨ActivityManagerService&lt;/h2&gt;&lt;p&gt;åœ¨å‰é¢ç¬¬14ç« è®²åˆ°ï¼Œåœ¨Systemè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šå¯åŠ¨ç³»ç»Ÿçš„ä¸€äº›åŸºæœ¬æœåŠ¡ã€‚å¯åŠ¨å°±æœ‰ActivityManagerServiceå’ŒPackageManagerServiceã€‚åœ¨SystemServerä¸­å¦‚ä¸‹å¯åŠ¨ActivityManagerServiceã€‚&lt;/p&gt;
&lt;p&gt;&lt;em&gt;frameworks/base/services/java/com/android/server/SystemServer.java&lt;/em&gt; :&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// Activity manager runs the show.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;mActivityManagerService = mSystemServiceManager.startService(ActivityManagerService.Lifecycle.class).getService();&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;   &lt;/p&gt;
&lt;p&gt;startServiceå°±æ˜¯åˆ›å»ºäº†ActivityManagerServiceçš„å®ä¾‹å¯¹è±¡mActivityManagerServiceï¼Œç„¶åå¯åŠ¨äº†ActivityManagerServiceçš„looperçº¿ç¨‹ã€‚åœ¨SystemServerå¯åŠ¨äº†åŸºæœ¬æœåŠ¡åï¼Œå°±ä¼šè°ƒç”¨mActivityManagerServiceçš„systemReadyå‡½æ•°æ¥å¯åŠ¨HomeActivityã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(17):Androidåº”ç”¨çš„å®‰è£…</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-17-Android%E5%BA%94%E7%94%A8%E7%9A%84%E5%AE%89%E8%A3%85/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-17-Androidåº”ç”¨çš„å®‰è£…/</id>
    <published>2017-02-14T07:00:58.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å­¦åˆ°çš„æ‰æ˜¯è‡ªå·±çš„ï¼Œå¹²æ´»éƒ½æ˜¯æ‰¯æ·¡</p>
</blockquote>
<h2 id="1-åº”ç”¨çš„å®‰è£…"><a href="#1-åº”ç”¨çš„å®‰è£…" class="headerlink" title="1. åº”ç”¨çš„å®‰è£…"></a>1. åº”ç”¨çš„å®‰è£…</h2><p>PackageManagerServiceè´Ÿè´£ç®¡ç†åº”ç”¨çš„å®‰è£…ã€‚åœ¨ç¬¬14ç« ä¸­è®²åˆ°ï¼ŒSystemServiceä¼šå¯åŠ¨PackageManagerServiceï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»SystemServiceå¯åŠ¨PackageManagerServiceå¼€å§‹åˆ†æã€‚</p>
<a id="more"></a>
<h3 id="1-1-PackageManagerService-main"><a href="#1-1-PackageManagerService-main" class="headerlink" title="1.1 PackageManagerService.main"></a>1.1 PackageManagerService.main</h3><p>åˆ›å»ºPackageManagerServiceå¯¹è±¡ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer, <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</div><div class="line">     <span class="comment">//å…ˆåˆ›å»ºä¸€ä¸ªPackageManagerServiceå¯¹è±¡</span></div><div class="line">     PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer, factoryTest, onlyCore);</div><div class="line">     <span class="comment">//å°†ä»–æ³¨å†Œåˆ°ServiceManageré‡Œé¢</span></div><div class="line">     ServiceManager.addService(<span class="string">"package"</span>, m);</div><div class="line">     <span class="keyword">return</span> m;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-2-PackageManagerService-PackageManagerService"><a href="#1-2-PackageManagerService-PackageManagerService" class="headerlink" title="1.2 PackageManagerService.PackageManagerService"></a>1.2 PackageManagerService.PackageManagerService</h3><p>PackageManagerServiceçš„æ„é€ å‡½æ•°ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></div><div class="line">           <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore) &#123;</div><div class="line">       <span class="comment">//...</span></div><div class="line"></div><div class="line">       mSettings = <span class="keyword">new</span> Settings(mPackages);</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line">       <span class="keyword">synchronized</span> (mInstallLock) &#123;</div><div class="line">       <span class="comment">// writer</span></div><div class="line">       <span class="keyword">synchronized</span> (mPackages) &#123;</div><div class="line">           <span class="comment">//ä¸€ä¸ªPackageManagerServiceè‡ªå·±çš„Looper</span></div><div class="line">           mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</div><div class="line">                   Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//çº¿ç¨‹å¯åŠ¨ï¼Œå¼€å¯è‡ªå·±çš„æ¶ˆæ¯å¾ªç¯é˜Ÿåˆ—</span></div><div class="line">           mHandlerThread.start();</div><div class="line">           <span class="comment">//å¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªHandlerè¯¥çº¿ç¨‹</span></div><div class="line">           mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</div><div class="line"></div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//è·å–æ–‡ä»¶è·¯å¾„</span></div><div class="line">           File dataDir = Environment.getDataDirectory();</div><div class="line">           mAppDataDir = <span class="keyword">new</span> File(dataDir, <span class="string">"data"</span>);</div><div class="line">           mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>);</div><div class="line">           mAppLib32InstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);</div><div class="line">           mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();</div><div class="line">           mUserAppDataDir = <span class="keyword">new</span> File(dataDir, <span class="string">"user"</span>);</div><div class="line">           mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);</div><div class="line"></div><div class="line">           sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>,</div><div class="line">                   mInstallLock, mPackages);</div><div class="line"></div><div class="line">ã€€ã€€ <span class="comment">//ã€€è·å–æƒé™é…ç½®æ–‡ä»¶çš„ä¸­çš„æƒé™</span></div><div class="line">           <span class="comment">// Propagate permission configuration in to package manager.</span></div><div class="line">           ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</div><div class="line">                   = systemConfig.getPermissions();</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;permConfig.size(); i++) &#123;</div><div class="line">               SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</div><div class="line">               BasePermission bp = mSettings.mPermissions.get(perm.name);</div><div class="line">               <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</div><div class="line">                   bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</div><div class="line">                   mSettings.mPermissions.put(perm.name, bp);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</div><div class="line">                   bp.setGids(perm.gids, perm.perUser);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">ã€€ã€€ <span class="comment">//è·å–å…±äº«åº“</span></div><div class="line">           ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</div><div class="line">               mSharedLibraries.put(libConfig.keyAt(i),</div><div class="line">                       <span class="keyword">new</span> SharedLibraryEntry(libConfig.valueAt(i), <span class="keyword">null</span>));</div><div class="line">           &#125;</div><div class="line"></div><div class="line">          ã€€<span class="comment">//æ¢å¤ä¸Šä¸€æ¬¡åº”ç”¨å®‰è£…ä¿¡æ¯ï¼Œè§1.3</span></div><div class="line">           mRestoredSettings = mSettings.readLPw(<span class="keyword">this</span>, sUserManager.getUsers(<span class="keyword">false</span>),</div><div class="line">                   mSdkVersion, mOnlyCore);</div><div class="line"></div><div class="line">           <span class="comment">/**</span></div><div class="line">            * Add everything in the in the boot class path to the</div><div class="line">            * list of process files because dexopt will have been run</div><div class="line">            * if necessary during zygote startup.</div><div class="line">            */</div><div class="line">           <span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</div><div class="line">           <span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">           File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</div><div class="line"></div><div class="line">           <span class="comment">// Gross hack for now: we know this file doesn't contain any</span></div><div class="line">           <span class="comment">// code, so don't dexopt it to avoid the resulting log spew.</span></div><div class="line">           alreadyDexOpted.add(frameworkDir.getPath() + <span class="string">"/framework-res.apk"</span>);</div><div class="line"></div><div class="line">           <span class="comment">// Gross hack for now: we know this file is only part of</span></div><div class="line">           <span class="comment">// the boot class path for art, so don't dexopt it to</span></div><div class="line">           <span class="comment">// avoid the resulting log spew.</span></div><div class="line">           alreadyDexOpted.add(frameworkDir.getPath() + <span class="string">"/core-libart.jar"</span>);</div><div class="line"></div><div class="line">           <span class="comment">/**</span></div><div class="line">            * å°†ä¸€äº›åº”ç”¨dexoptè½¬åŒ–</div><div class="line">            * There are a number of commands implemented in Java, which</div><div class="line">            * we currently need to do the dexopt on so that they can be</div><div class="line">            * run from a non-root shell.</div><div class="line">            */</div><div class="line"></div><div class="line">          ã€€<span class="comment">//...</span></div><div class="line"></div><div class="line">           <span class="comment">//è®¾å¤‡å‚å•†æä¾›çš„åº”ç”¨</span></div><div class="line">           <span class="comment">// Collect vendor overlay packages.</span></div><div class="line">           <span class="comment">// (Do this before scanning any apps.)</span></div><div class="line">           <span class="comment">// For security and version matching reason, only consider</span></div><div class="line">           <span class="comment">// overlay packages if they reside in VENDOR_OVERLAY_DIR.</span></div><div class="line">           File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</div><div class="line">           scanDirLI(vendorOverlayDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                   | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">// èµ„æºå‹çš„ç¨‹åº</span></div><div class="line">           <span class="comment">// Find base frameworks (resource packages without code).</span></div><div class="line">           scanDirLI(frameworkDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                   | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">                   | PackageParser.PARSE_IS_PRIVILEGED,</div><div class="line">                   scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€  <span class="comment">//ç‰¹æƒåº”ç”¨</span></div><div class="line">           <span class="comment">// Collected privileged system packages.</span></div><div class="line">           <span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</div><div class="line">           scanDirLI(privilegedAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                   | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">                   | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line">           <span class="comment">// Collect ordinary system packages.</span></div><div class="line">           <span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</div><div class="line">           scanDirLI(systemAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                   | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line">           <span class="comment">// Collect all vendor packages.</span></div><div class="line">           File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               vendorAppDir = vendorAppDir.getCanonicalFile();</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               <span class="comment">// failed to look up canonical path, continue with original one</span></div><div class="line">           &#125;</div><div class="line">           scanDirLI(vendorAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                   | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line">           <span class="comment">// Collect all OEM packages.</span></div><div class="line">           <span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</div><div class="line">           scanDirLI(oemAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">                   | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (DEBUG_UPGRADE) Log.v(TAG, <span class="string">"Running installd update commands"</span>);</div><div class="line">           mInstaller.moveFiles();</div><div class="line"></div><div class="line">           <span class="comment">// Prune any system packages that no longer exist.</span></div><div class="line">           <span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">          ã€€<span class="comment">//...</span></div><div class="line"></div><div class="line"></div><div class="line">           <span class="comment">//look for any incomplete package installations</span></div><div class="line">           ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</div><div class="line">           <span class="comment">//clean up list</span></div><div class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</div><div class="line">               <span class="comment">//clean up here</span></div><div class="line">               cleanupInstallFailedPackage(deletePkgsList.get(i));</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//delete tmp files</span></div><div class="line">           deleteTempPackageFiles();</div><div class="line"></div><div class="line">           <span class="comment">// Remove any shared userIDs that have no associated packages</span></div><div class="line">           mSettings.pruneSharedUsersLPw();</div><div class="line">           <span class="comment">//...</span></div><div class="line"></div><div class="line">           <span class="comment">// Now that we know all the packages we are keeping,</span></div><div class="line">           <span class="comment">// read and update their last usage times.</span></div><div class="line">           mPackageUsage.readLP();</div><div class="line"></div><div class="line">           <span class="comment">// If the platform SDK has changed since the last time we booted,</span></div><div class="line">           <span class="comment">// we need to re-grant app permission to catch any new ones that</span></div><div class="line">           <span class="comment">// appear.  This is really a hack, and means that apps can in some</span></div><div class="line">           <span class="comment">// cases get permissions that the user didn't initially explicitly</span></div><div class="line">           <span class="comment">// allow...  it would be nice to have some better way to handle</span></div><div class="line">           <span class="comment">// this situation.</span></div><div class="line">           <span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</div><div class="line">           <span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</div><div class="line">               Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></div><div class="line">                       + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</div><div class="line">               updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</div><div class="line">           &#125;</div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//ä¸ºç”³è¯·äº†ç‰¹å®šèµ„æºçš„è®¿é—®æƒé™çš„åº”ç”¨åˆ†é…ç”¨æˆ·ç»„id</span></div><div class="line">           updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</div><div class="line">           ver.sdkVersion = mSdkVersion;</div><div class="line"></div><div class="line">           <span class="comment">//å°†åº”ç”¨å®‰è£…ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°çš„é…ç½®æ–‡ä»¶</span></div><div class="line">           <span class="comment">// can downgrade to reader</span></div><div class="line">           mSettings.writeLPr();</div><div class="line"></div><div class="line"></div><div class="line">       &#125; <span class="comment">// synchronized (mPackages)</span></div><div class="line">       &#125; <span class="comment">// synchronized (mInstallLock)</span></div><div class="line"></div><div class="line">       <span class="comment">// Now after opening every single application zip, make sure they</span></div><div class="line">       <span class="comment">// are all flushed.  Not really needed, but keeps things nice and</span></div><div class="line">       <span class="comment">// tidy.</span></div><div class="line">       Runtime.getRuntime().gc();</div><div class="line"></div><div class="line">       <span class="comment">// Expose private service for system components to use.</span></div><div class="line">       LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-3-Settings-readLPw"><a href="#1-3-Settings-readLPw" class="headerlink" title="1.3 Settings.readLPw"></a>1.3 Settings.readLPw</h3><p>è¯»å–ä¿å­˜çš„åº”ç”¨ä¿¡æ¯ã€‚<br><em>frameworks/base/services/core/java/com/android/server/pm/Settings.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">readLPw</span><span class="params">(PackageManagerService service, List&lt;UserInfo&gt; users, <span class="keyword">int</span> sdkVersion,</span></span></div><div class="line">            <span class="keyword">boolean</span> onlyCore) &#123;</div><div class="line">        FileInputStream str = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (mBackupSettingsFilename.exists()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//è·å–/data/system/packages-backup.xmlæ–‡ä»¶</span></div><div class="line">                str = <span class="keyword">new</span> FileInputStream(mBackupSettingsFilename);</div><div class="line">                <span class="comment">//å¦‚æœbackupä¸å­˜åœ¨ï¼Œåˆ™è·å–/data/system/packages.xmlæ–‡ä»¶</span></div><div class="line">                <span class="comment">//...</span></div><div class="line">            &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</div><div class="line">                <span class="comment">// We'll try for the normal settings file.</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">	<span class="comment">//...</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//...</span></div><div class="line">                str = <span class="keyword">new</span> FileInputStream(mSettingsFilename);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//ç”¨parserè§£æxmlæ–‡ä»¶</span></div><div class="line">            XmlPullParser parser = Xml.newPullParser();</div><div class="line">            parser.setInput(str, StandardCharsets.UTF_8.name());</div><div class="line">            <span class="comment">//...</span></div><div class="line">            <span class="keyword">int</span> outerDepth = parser.getDepth();</div><div class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</div><div class="line">                    &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</div><div class="line">                <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                 </div><div class="line">                <span class="comment">//è·å–åº”ç”¨çš„å„é¡¹å‚æ•°</span></div><div class="line">                String tagName = parser.getName();</div><div class="line">                <span class="keyword">if</span> (tagName.equals(<span class="string">"package"</span>)) &#123;</div><div class="line">                    <span class="comment">//è·å–ä¸Šæ¬¡åˆ†é…ç»™ä»–çš„åº”ç”¨ç”¨æˆ·IDï¼Œè§1.4</span></div><div class="line">                    readPackageLPw(parser);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permissions"</span>)) &#123;</div><div class="line">                    readPermissionsLPw(mPermissions, parser);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission-trees"</span>)) &#123;</div><div class="line">                    readPermissionsLPw(mPermissionTrees, parser);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"shared-user"</span>)) &#123;</div><div class="line">                    <span class="comment">//è·å–ä¸Šæ¬¡åˆ†é…çš„å…±äº«ç”¨æˆ·IDï¼Œè§1.6</span></div><div class="line">                    readSharedUserLPw(parser);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> &#123;</div><div class="line">                  <span class="comment">//...</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;packages&gt;: "</span></div><div class="line">                            + parser.getName());</div><div class="line">                    XmlUtils.skipCurrentTag(parser);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            str.close();</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</div><div class="line">           <span class="comment">//...</span></div><div class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</div><div class="line">           <span class="comment">//....</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">//...</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-4-Settings-readPackageLPw"><a href="#1-4-Settings-readPackageLPw" class="headerlink" title="1.4 Settings.readPackageLPw"></a>1.4 Settings.readPackageLPw</h3><p>è¯»å–packageä¿¡æ¯ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/Settings.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPackageLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</div><div class="line">       String name = <span class="keyword">null</span>;</div><div class="line">       <span class="comment">//...</span></div><div class="line">       String idStr = <span class="keyword">null</span>;</div><div class="line">       String sharedIdStr = <span class="keyword">null</span>;</div><div class="line"><span class="comment">//...</span></div><div class="line">    </div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</div><div class="line">           realName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"realName"</span>);</div><div class="line">           idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</div><div class="line">           <span class="comment">//...</span></div><div class="line">           <span class="comment">//åå­—ä¸èƒ½ä¸ºnull</span></div><div class="line">           <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">               PackageManagerService.reportSettingsProblem(Log.WARN,</div><div class="line">                       <span class="string">"Error in package manager settings: &lt;package&gt; has no name at "</span></div><div class="line">                               + parser.getPositionDescription());</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePathStr == <span class="keyword">null</span>) &#123;</div><div class="line">               PackageManagerService.reportSettingsProblem(Log.WARN,</div><div class="line">                       <span class="string">"Error in package manager settings: &lt;package&gt; has no codePath at "</span></div><div class="line">                               + parser.getPositionDescription());</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="comment">//è¯¥åº”ç”¨ä¸Šæ¬¡å·²ç»åˆ†é…è¿‡IDï¼Œæ‰€ä»¥è¿™æ¬¡è¿˜ä½¿ç”¨è¯¥id,è§1.5</span></div><div class="line">               packageSetting = addPackageLPw(name.intern(), realName, <span class="keyword">new</span> File(codePathStr),</div><div class="line">                       <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiString,</div><div class="line">                       secondaryCpuAbiString, cpuAbiOverrideString, userId, versionCode, pkgFlags,</div><div class="line">                       pkgPrivateFlags);</div><div class="line">               <span class="comment">//...</span></div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sharedIdStr != <span class="keyword">null</span>) &#123;</div><div class="line">               userId = sharedIdStr != <span class="keyword">null</span> ? Integer.parseInt(sharedIdStr) : <span class="number">0</span>;</div><div class="line">               <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">//å¦‚æœä¸Šæ¬¡ä½¿ç”¨çš„æ˜¯å…±äº«idï¼Œåˆ™è¯´æ˜ä¸Šæ¬¡è¯¥appæ²¡æœ‰ç‹¬ç«‹çš„id</span></div><div class="line">                   <span class="comment">//æ‰€ä»¥è¿™æ¬¡ä¸èƒ½ç›´æ¥å°†è¯¥idåˆ†é…ç»™ä»–ï¼Œè¦å…ˆå°†å…¶ä¿å­˜èµ·æ¥ä»¥åå¤„ç†</span></div><div class="line">                   packageSetting = <span class="keyword">new</span> PendingPackage(name.intern(), realName, <span class="keyword">new</span> File(</div><div class="line">                           codePathStr), <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr,</div><div class="line">                           primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString,</div><div class="line">                           userId, versionCode, pkgFlags, pkgPrivateFlags);</div><div class="line">                   <span class="comment">//...</span></div><div class="line">                   mPendingPackages.add((PendingPackage) packageSetting);</div><div class="line">                  <span class="comment">//...</span></div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  <span class="comment">//...</span></div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">//...</span></div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line">           <span class="comment">//...</span></div><div class="line">       &#125;</div><div class="line">     <span class="comment">//...</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-5-Setttings-addPackageLPw"><a href="#1-5-Setttings-addPackageLPw" class="headerlink" title="1.5 Setttings.addPackageLPw"></a>1.5 Setttings.addPackageLPw</h3><p>ä¸ºè¯¥packageåˆ†é…UIDï¼Œåˆ›å»ºä¿å­˜packageä¿¡æ¯çš„PackageSettingå¯¹è±¡ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/Settings.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function">PackageSetting <span class="title">addPackageLPw</span><span class="params">(String name, String realName, File codePath, File resourcePath,</span></span></div><div class="line">        String legacyNativeLibraryPathString, String primaryCpuAbiString, String secondaryCpuAbiString,</div><div class="line">        String cpuAbiOverrideString, <span class="keyword">int</span> uid, <span class="keyword">int</span> vc, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags) &#123;</div><div class="line">    <span class="comment">//æ¯ä¸€ä¸ªappçš„ä¿¡æ¯éƒ½ä¿å­˜äºä¸€ä¸ªPackageSettingå¯¹è±¡ä¸­</span></div><div class="line">    PackageSetting p = mPackages.get(name);</div><div class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//è¯¥åº”ç”¨å·²ç»æœ‰å¯¹åº”çš„PackageSettingå¯¹è±¡äº†ï¼Œæ— éœ€å†æ¬¡æ·»åŠ </span></div><div class="line">        <span class="keyword">if</span> (p.appId == uid) &#123;</div><div class="line">            <span class="keyword">return</span> p;</div><div class="line">        &#125;</div><div class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</div><div class="line">                <span class="string">"Adding duplicate package, keeping first: "</span> + name);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ä¸ºè¯¥appåˆ›å»ºä¸€ä¸ªPackageSetting</span></div><div class="line">    p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</div><div class="line">            legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</div><div class="line">            cpuAbiOverrideString, vc, pkgFlags, pkgPrivateFlags);</div><div class="line">    p.appId = uid;</div><div class="line">    <span class="comment">//åœ¨ç³»ç»Ÿä¸­ä¿ç•™å€¼ä¸ºuidçš„Linuxç”¨æˆ·IDï¼Œä¼šåœ¨ä¸‹é¢è¯¦è§£</span></div><div class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, p, name)) &#123;</div><div class="line">        <span class="comment">//mPackagesä¿å­˜åˆ›å»ºçš„app PackageSettingå¯¹è±¡</span></div><div class="line">        mPackages.put(name, p);</div><div class="line">        <span class="keyword">return</span> p;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>   </p>
<p>åœ¨ç³»ç»Ÿä¸­ä¿ç•™æŒ‡å®šçš„UIDã€‚è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œä¸€å…±å¯ä»¥åˆ†é…10000ä¸ªuidç»™åº”ç”¨ç¨‹åºï¼Œå°äº10000çš„uidæ˜¯åˆ†é…ç»™ç‰¹æƒç”¨æˆ·çš„ã€‚è¿™äº›ç‰¹æƒç”¨æˆ·çš„uidå¯ä»¥é€šè¿‡å…±äº«çš„å½¢å¼ç»™å…¶å®ƒåº”ç”¨ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæƒ³ä¿®æ”¹ç³»ç»Ÿæ—¶é—´çš„çš„åº”ç”¨å¯ä»¥å…±äº«â€android.uid.systemâ€çš„ç‰¹æƒç”¨æˆ·çš„uidï¼Œå³åœ¨é…ç½®æ–‡ä»¶ä¸­å°†å®ƒçš„android:sharedUserIdçš„å±æ€§è®¾ç½®ä¸ºâ€œandroid.uid.systemâ€ã€‚uidä¸èƒ½é‡å¤ï¼Œä½†æ˜¯shareduidæ˜¯å¯ä»¥å…±äº«çš„ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/Settings.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj, Object name)</span> </span>&#123;</div><div class="line">    <span class="comment">//åˆ†é…çš„uidä¸èƒ½è¶…è¿‡LAST_APPLICATION_UIDï¼Œ19999</span></div><div class="line">    <span class="keyword">if</span> (uid &gt; Process.LAST_APPLICATION_UID) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//åˆ†é…çš„uidåº”è¯¥å¤§äºç­‰äºFIRST_APPLICATION_UIDï¼Œ10000</span></div><div class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</div><div class="line">        <span class="keyword">int</span> N = mUserIds.size();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</div><div class="line">        <span class="keyword">while</span> (index &gt;= N) &#123;</div><div class="line">            <span class="comment">//å°†ä¸­é—´æ²¡åˆ†é…çš„uidå…ˆç½®ä¸ºç©º</span></div><div class="line">            mUserIds.add(<span class="keyword">null</span>);</div><div class="line">            N++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mUserIds.get(index) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//è¯¥uidé‡å¤äº†ï¼Œåˆ†é…å¤±è´¥</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//æ­£å¼åˆ†é…uidï¼Œæ‰€æœ‰çš„uidè¢«mUserIdsç®¡ç†</span></div><div class="line">        mUserIds.set(index, obj);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//è¿™é‡Œæ˜¯ç‰¹æƒç”¨æˆ·çš„uid</span></div><div class="line">        <span class="keyword">if</span> (mOtherUserIds.get(uid) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//uidå·²ç»åˆ†é…è¿‡ï¼Œè¿”å›å¤±è´¥</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        mOtherUserIds.put(uid, obj);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>åˆ°è¿™é‡Œï¼Œåº”ç”¨çš„uidå·²ç»åˆ†é…å®Œæˆã€‚ä¸‹é¢å›åˆ°1.3ï¼Œçœ‹å¦‚ä½•è¯»å–shareduidã€‚</p>
<h3 id="1-6-Setttings-readSharedUserLPw"><a href="#1-6-Setttings-readSharedUserLPw" class="headerlink" title="1.6 Setttings.readSharedUserLPw"></a>1.6 Setttings.readSharedUserLPw</h3><p>è¯»å–å…±äº«uidã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/Settings.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSharedUserLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,IOException </span>&#123;</div><div class="line">    String name = <span class="keyword">null</span>;</div><div class="line">    String idStr = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</div><div class="line">    SharedUserSetting su = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</div><div class="line">        idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</div><div class="line">        <span class="keyword">int</span> userId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</div><div class="line">        <span class="comment">//è¯¥å…±äº«idæ˜¯ç³»ç»Ÿåº”ç”¨è¿˜æ˜¯ç”¨æˆ·ç±»å‹çš„åº”ç”¨</span></div><div class="line">        <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"system"</span>))) &#123;</div><div class="line">            pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//...</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId == <span class="number">0</span>) &#123;</div><div class="line">           <span class="comment">//...</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//åœ¨ç³»ç»Ÿä¸­ä¸ºè¯¥åº”ç”¨ç”³è¯·è¯¥userIdï¼Œè§1.7</span></div><div class="line">            <span class="keyword">if</span> ((su = addSharedUserLPw(name.intern(), userId, pkgFlags, pkgPrivateFlags))</div><div class="line">                    == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">//...</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</div><div class="line"> <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line"><span class="comment">//....</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        XmlUtils.skipCurrentTag(parser);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-7-Settings-addSharedUserLPw"><a href="#1-7-Settings-addSharedUserLPw" class="headerlink" title="1.7 Settings.addSharedUserLPw"></a>1.7 Settings.addSharedUserLPw</h3><p>æ·»åŠ å…±äº«ç”¨æˆ·ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/Settings.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</div><div class="line">        SharedUserSetting s = mSharedUsers.get(name);</div><div class="line">        <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (s.userId == uid) &#123;</div><div class="line">                <span class="keyword">return</span> s;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//æ·»åŠ uidå’Œå·²ç»æ·»åŠ çš„ä¸åŒï¼Œåˆ™å¤±è´¥è¿”å›</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//mSharedUsersä¸­æ²¡æœ‰è¯¥å…±äº«ç”¨æˆ·idï¼Œåˆ™åˆ›å»ºä¸€ä¸ªSharedUserSetting</span></div><div class="line">        s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags, pkgPrivateFlags);</div><div class="line">        s.userId = uid;</div><div class="line">        <span class="comment">//åœ¨ç³»ç»Ÿä¸­ä¸ºå®ƒåˆ†é…è¯¥uidï¼Œé‡å¤1.6</span></div><div class="line">        <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</div><div class="line">	    <span class="comment">//åˆ†é…æˆåŠŸï¼Œè®°å½•ä¸‹æ¥</span></div><div class="line">            mSharedUsers.put(name, s);</div><div class="line">            <span class="keyword">return</span> s;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>   </p>
<p>åœ¨1.4ä¸­ï¼ŒmPendingPackagesä¿å­˜äº†ä¸€äº›ä½¿ç”¨å…±äº«ç”¨æˆ·idçš„packageã€‚ç°åœ¨å·²ç»è§£æå®Œæ¯•å…±äº«ç”¨æˆ·çš„ä¿¡æ¯ï¼Œåœ¨1.3 readLPwå‡½æ•°ä¸­å°†ä¼šå¤„ç†è¿™äº›packageäº†ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/Settings.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            <span class="keyword">final</span> PendingPackage pp = mPendingPackages.get(i);</div><div class="line">            Object idObj = getUserIdLPr(pp.sharedId);</div><div class="line">            <span class="keyword">if</span> (idObj != <span class="keyword">null</span> &amp;&amp; idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123;</div><div class="line">                <span class="comment">//è·å¾—å…±äº«ç”¨æˆ·ä¿¡æ¯ï¼Œè¯´æ˜è¯¥packageä½¿ç”¨çš„å…±äº«ç”¨æˆ·idæ˜¯æœ‰æ•ˆçš„ï¼Œå°†åœ¨ä¸‹é¢å°èŠ‚åˆ†æ</span></div><div class="line">                PackageSetting p = getPackageLPw(pp.name, <span class="keyword">null</span>, pp.realName,</div><div class="line">                        (SharedUserSetting) idObj, pp.codePath, pp.resourcePath,</div><div class="line">                        pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString,</div><div class="line">                        pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags,</div><div class="line">                        <span class="keyword">null</span>, <span class="keyword">true</span> <span class="comment">/* add */</span>, <span class="keyword">false</span> <span class="comment">/* allowInstall */</span>);</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">//...</span></div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                p.copyFrom(pp);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idObj != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">//è¯¥packageä½¿ç”¨äº†ä¸€ä¸ªéå…±äº«çš„id</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">//ä½¿ç”¨çš„å…±äº«idä¸å­˜åœ¨</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mPendingPackages.clear();</div></pre></td></tr></table></figure>   </p>
<h3 id="1-8-PackageManagerService-scanDirLI"><a href="#1-8-PackageManagerService-scanDirLI" class="headerlink" title="1.8 PackageManagerService.scanDirLI"></a>1.8 PackageManagerService.scanDirLI</h3><p>åˆ°æ­¤ï¼ŒPackageManagerServiceå·²ç»å°†ä¸Šä¸€æ¬¡ä¿å­˜çš„åº”ç”¨ä¿¡æ¯æ¢å¤å®Œæ¯•ï¼Œåœ¨1.2ä¸­æ¥ä¸‹æ¥éœ€è¦è¿›ä¸€æ­¥å®‰è£…å„ä¸ªç›®å½•ä¸‹çš„åº”ç”¨ã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> File[] files = dir.listFiles();</div><div class="line">    <span class="comment">//ä¾æ¬¡è®¿é—®æ–‡ä»¶å¤¹ä¸­çš„æ¯ä¸ªapkæ–‡ä»¶</span></div><div class="line">    <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</div><div class="line">                &amp;&amp; !PackageInstallerService.isStageName(file.getName());</div><div class="line">        <span class="keyword">if</span> (!isPackage) &#123;</div><div class="line">            <span class="comment">// Ignore entries which are not packages</span></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            scanPackageLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK,</div><div class="line">                    scanFlags, currentTime, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</div><div class="line">            <span class="comment">//åˆ é™¤æ— æ•ˆçš„æ–‡ä»¶</span></div><div class="line">            <span class="comment">// Delete invalid userdata apps</span></div><div class="line">            <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &amp;&amp;</div><div class="line">                    e.error == PackageManager.INSTALL_FAILED_INVALID_APK) &#123;</div><div class="line">                <span class="keyword">if</span> (file.isDirectory()) &#123;</div><div class="line">                    mInstaller.rmPackageDir(file.getAbsolutePath());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    file.delete();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-9-PackageManagerService-scanPackageLI"><a href="#1-9-PackageManagerService-scanPackageLI" class="headerlink" title="1.9 PackageManagerService.scanPackageLI"></a>1.9 PackageManagerService.scanPackageLI</h3><p><em>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></div><div class="line">           <span class="keyword">long</span> currentTime, UserHandle user) <span class="keyword">throws</span> PackageManagerException &#123;</div><div class="line">       <span class="comment">//...</span></div><div class="line">       PackageParser pp = <span class="keyword">new</span> PackageParser();</div><div class="line">       <span class="comment">//...</span></div><div class="line">       <span class="keyword">final</span> PackageParser.Package pkg;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//è§£æç›®æ ‡æ–‡ä»¶</span></div><div class="line">           pkg = pp.parsePackage(scanFile, parseFlags);</div><div class="line">       &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</div><div class="line">           <span class="comment">//...</span></div><div class="line">       &#125;</div><div class="line">       <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-10-PackageParser-parsePackage"><a href="#1-10-PackageParser-parsePackage" class="headerlink" title="1.10 PackageParser.parsePackage"></a>1.10 PackageParser.parsePackage</h3><p><em>frameworks/base/core/java/android/content/pm/PackageParser.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</div><div class="line">      <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</div><div class="line">          <span class="comment">//ä¸€ä¸ªç›®å½•ä¸‹æ˜¯ä¸€ä¸ªåº”ç”¨</span></div><div class="line">          <span class="keyword">return</span> parseClusterPackage(packageFile, flags);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//ä¸€ä¸ªæ•´ä½“çš„åº”ç”¨</span></div><div class="line">          <span class="keyword">return</span> parseMonolithicPackage(packageFile, flags);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-11-PackageParser-parseMonolithicPackage"><a href="#1-11-PackageParser-parseMonolithicPackage" class="headerlink" title="1.11 PackageParser.parseMonolithicPackage"></a>1.11 PackageParser.parseMonolithicPackage</h3><p><em>frameworks/base/core/java/android/content/pm/PackageParser.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</div><div class="line">      <span class="comment">//...</span></div><div class="line">      <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assets, flags);</div><div class="line">          pkg.codePath = apkFile.getAbsolutePath();</div><div class="line">          <span class="keyword">return</span> pkg;</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          IoUtils.closeQuietly(assets);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-12-PackageParser-parseBaseApk"><a href="#1-12-PackageParser-parseBaseApk" class="headerlink" title="1.12 PackageParser.parseBaseApk"></a>1.12 PackageParser.parseBaseApk</h3><p><em>frameworks/base/core/java/android/content/pm/PackageParser.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(File apkFile, AssetManager assets, <span class="keyword">int</span> flags)</span></span></div><div class="line">        <span class="keyword">throws</span> PackageParserException &#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</div><div class="line">    mArchiveSourcePath = apkFile.getAbsolutePath();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cookie = loadApkIntoAssetManager(assets, apkPath, flags);</div><div class="line"></div><div class="line">    Resources res = <span class="keyword">null</span>;</div><div class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</div><div class="line">        assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">                Build.VERSION.RESOURCES_SDK_INT);</div><div class="line">        <span class="comment">//è·å–AndroidManifest.xmlæ–‡ä»¶</span></div><div class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</div><div class="line"></div><div class="line">        <span class="comment">//è§£æAndroidManifest.xmlæ–‡ä»¶</span></div><div class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(res, parser, flags, outError);</div><div class="line">       <span class="comment">//...</span></div><div class="line">        <span class="keyword">return</span> pkg;</div><div class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</div><div class="line">       <span class="comment">//...</span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        IoUtils.closeQuietly(parser);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><em>frameworks/base/core/java/android/content/pm/PackageParser.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags,</span></span></div><div class="line">           String[] outError) <span class="keyword">throws</span> XmlPullParserException, IOException &#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> trustedOverlay = (flags &amp; PARSE_TRUSTED_OVERLAY) != <span class="number">0</span>;</div><div class="line"></div><div class="line">       AttributeSet attrs = parser;</div><div class="line"></div><div class="line">       <span class="keyword">final</span> String pkgName;</div><div class="line">       <span class="keyword">final</span> String splitName;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, attrs, flags);</div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ <span class="comment">//è·å–packageåç§°</span></div><div class="line">           pkgName = packageSplit.first;</div><div class="line">           splitName = packageSplit.second;</div><div class="line">       &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</div><div class="line">           <span class="comment">//...</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//åˆ›å»ºPackageå¯¹è±¡</span></div><div class="line">       <span class="keyword">final</span> Package pkg = <span class="keyword">new</span> Package(pkgName);</div><div class="line">       <span class="keyword">boolean</span> foundApp = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">       TypedArray sa = res.obtainAttributes(attrs,</div><div class="line">               com.android.internal.R.styleable.AndroidManifest);</div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//åº”ç”¨ç‰ˆæœ¬ä¿¡æ¯</span></div><div class="line">       pkg.mVersionCode = pkg.applicationInfo.versionCode = sa.getInteger(</div><div class="line">               com.android.internal.R.styleable.AndroidManifest_versionCode, <span class="number">0</span>);</div><div class="line">       <span class="comment">//...</span></div><div class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//ç”¨æˆ·å…±äº«id</span></div><div class="line">       String str = sa.getNonConfigurationString(</div><div class="line">               com.android.internal.R.styleable.AndroidManifest_sharedUserId, <span class="number">0</span>);</div><div class="line">       <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">           String nameError = validateName(str, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">           <span class="keyword">if</span> (nameError != <span class="keyword">null</span> &amp;&amp; !<span class="string">"android"</span>.equals(pkgName)) &#123;</div><div class="line">               outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; specifies bad sharedUserId name \""</span></div><div class="line">                   + str + <span class="string">"\": "</span> + nameError;</div><div class="line">               mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_SHARED_USER_ID;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//è®¾ç½®å…±äº«idåè¡¨ç¤ºè¦å’Œå…¶å®ƒåº”ç”¨å…±äº«ä¸€ä¸ªid</span></div><div class="line">           pkg.mSharedUserId = str.intern();</div><div class="line">           pkg.mSharedUserLabel = sa.getResourceId(</div><div class="line">                   com.android.internal.R.styleable.AndroidManifest_sharedUserLabel, <span class="number">0</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//...</span></div><div class="line"></div><div class="line">       <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</div><div class="line">               &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</div><div class="line">           <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           String tagName = parser.getName();</div><div class="line">           <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123;</div><div class="line">               <span class="comment">//...</span></div><div class="line">               <span class="comment">//è¿›ä¸€æ­¥è§£æapplicationé¡¹çš„å†…å®¹</span></div><div class="line">               <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, attrs, flags, outError)) &#123;</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">               &#125;</div><div class="line">	<span class="comment">//...</span></div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-permission"</span>)) &#123;</div><div class="line">               <span class="comment">//è·å–ç”³è¯·çš„æƒé™</span></div><div class="line">               <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser, attrs)) &#123;</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">   <span class="comment">//...</span></div><div class="line">&#125;</div><div class="line">       <span class="keyword">return</span> pkg;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><br>ä¸€ä¸ªåº”ç”¨å¯ä»¥ç”³è¯·å¤šä¸ªæƒé™ï¼Œåº”ç”¨æƒé™æ˜¯å’Œç”¨æˆ·ç»„IDå¯¹åº”çš„ã€‚åº”ç”¨ç”³è¯·æƒé™å°±æ˜¯è·å¾—è¯¥ç”¨æˆ·ç»„idçš„è¿‡ç¨‹ã€‚</p>
<h3 id="1-13"><a href="#1-13" class="headerlink" title="1.13"></a>1.13</h3><p><em>framework/base/core/java/android/content/pm/PackageParser.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></div><div class="line">            XmlPullParser parser, AttributeSet attrs, <span class="keyword">int</span> flags, String[] outError)</div><div class="line">        <span class="keyword">throws</span> XmlPullParserException, IOException &#123;</div><div class="line">      </div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</div><div class="line">        <span class="keyword">int</span> type;</div><div class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</div><div class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</div><div class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">         </div><div class="line">            String tagName = parser.getName();</div><div class="line">            <span class="comment">//è§£æå‡ºactivity</span></div><div class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</div><div class="line">                Activity a = parseActivity(owner, res, parser, attrs, flags, outError, <span class="keyword">false</span>,</div><div class="line">                        owner.baseHardwareAccelerated);</div><div class="line">                <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</div><div class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                owner.activities.add(a);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</div><div class="line">                <span class="comment">//è§£æå‡ºreceiver</span></div><div class="line">                Activity a = parseActivity(owner, res, parser, attrs, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">                <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</div><div class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                owner.receivers.add(a);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;</div><div class="line">                <span class="comment">//è§£æservice</span></div><div class="line">                Service s = parseService(owner, res, parser, attrs, flags, outError);</div><div class="line">                <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</div><div class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                owner.services.add(s);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;</div><div class="line">                <span class="comment">//è§£æprovider</span></div><div class="line">                Provider p = parseProvider(owner, res, parser, attrs, flags, outError);</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                owner.providers.add(p);</div><div class="line"></div><div class="line">            &#125; </div><div class="line">        &#125;</div><div class="line">            <span class="comment">//...</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>   </p>
<h3 id="1-14-ä¸‹é¢æ­¥éª¤ç¬¼ç»Ÿè®²ä¸€ä¸‹"><a href="#1-14-ä¸‹é¢æ­¥éª¤ç¬¼ç»Ÿè®²ä¸€ä¸‹" class="headerlink" title="1.14 ä¸‹é¢æ­¥éª¤ç¬¼ç»Ÿè®²ä¸€ä¸‹"></a>1.14 ä¸‹é¢æ­¥éª¤ç¬¼ç»Ÿè®²ä¸€ä¸‹</h3><p>åˆ°è¿™é‡Œï¼ŒPackageManagerServiceå·²ç»è§£æå®Œæˆä¸€ä¸ªapkæ–‡ä»¶ã€‚ä¸‹é¢å›åˆ°1.9 scanPackageLIä¸­ï¼Œç»§ç»­ä¸‹é¢çš„å·¥ä½œã€‚1.9æ­¥ä¸­ä¼šè°ƒç”¨é‡è½½å‡½æ•°scanPackageLIç»§ç»­è§£æè·å¾—çš„packageã€‚é‡è½½å‡½æ•°ä¼šè°ƒç”¨scanPackageDirtyLIæ¥åˆ†æpackageã€‚</p>
<p>è¿™ä¸€æ­¥ä¼šä¸ºpackageåˆ†é…idï¼Œå½“ç„¶è¯¥packageå¯èƒ½ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå…±äº«idã€‚é¦–å…ˆï¼Œæ¯ä¸ªpackageä¿¡æ¯ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªPackageSettingå¯¹è±¡ä¸­ï¼Œç„¶åå°†å…¶æ”¾åˆ°mPackagesè¿™ä¸ªHashMapä¸­ã€‚</p>
<p>å› ä¸ºåœ¨å‰é¢æ­¥éª¤ä¸­å·²ç»ä»ä¸Šä¸€æ¬¡å®‰è£…çš„åº”ç”¨ä¿¡æ¯ä¸­è¯»å–äº†ä¸€äº›packageä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦å…ˆåœ¨HashMapä¸­ç¡®å®šä¸€ä¸‹è¿™ä¸ªæ–°è§£æçš„åº”ç”¨æ˜¯å¦æ˜¯å·²ç»åœ¨mPackagesä¸­ã€‚å¦‚æœå·²ç»å­˜åœ¨ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè€åº”ç”¨ï¼Œå°±ç›´æ¥å°†PackageSetting è¿”å›ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™æ–°å»ºä¸€ä¸ªPackageSettingï¼Œä¸‹é¢å¼€å§‹ä¸ºå®ƒåˆ†é…uidï¼š       </p>
<pre><code>1. ä½¿ç”¨å…±äº«idã€‚å°†pkgçš„uidè®¾ç½®ä¸ºæƒ³è¦å…±äº«çš„uidã€‚
2. ä½¿ç”¨åŸæ¥çš„uidã€‚ç¦ç”¨çš„ç³»ç»Ÿç¨‹åºä½¿ç”¨å®ƒåŸæ¥çš„uidã€‚
3. ä½¿ç”¨æ–°çš„uidã€‚åˆ›å»ºä¸€ä¸ªæ–°çš„uidç»™pkgã€‚
4. ä½¿ç”¨first application uidã€‚æ‰€æœ‰åº”ç”¨ä½¿ç”¨åŒä¸€ä¸ªuidã€‚
</code></pre><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä¸ºæ–°çš„åº”ç”¨åˆ†é…æ–°uidã€‚mUserIdsç®¡ç†äº†æ‰€æœ‰çš„åˆ†é…ç»™ç”¨æˆ·çš„uidï¼Œè¿™é‡Œä¼šåœ¨è§„å®šçš„èŒƒå›´å†…æ‰¾åˆ°ä¸€ä¸ªuidåˆ†é…ã€‚ </p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæ‰€æœ‰çš„å®‰è£…äº†åº”ç”¨éƒ½å­˜åœ¨PackageManagerServiceçš„mPackagesä¸­ï¼Œä¸‹é¢éœ€è¦ä¾æ¬¡ä¸ºè¿™äº›åº”ç”¨åˆ†é…æƒé™ã€‚åœ¨è®¾å¤‡<code>/system/etc/permissions/platform.xml</code>æ–‡ä»¶ä¸­ï¼Œè¡¨è¿°äº†è¯¥è®¾å¤‡çš„èµ„æºè®¿é—®æƒé™åˆ—è¡¨ã€‚å¦‚ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH"</span> &gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">permission</span></span></div></pre></td></tr></table></figure>   
<p>gidæŒ‡æ˜äº†è¯¥èµ„æºæƒé™æ‰€åœ¨çš„ç”¨æˆ·ç»„ï¼Œå½“ç„¶ä¸€ä¸ªæƒé™å¯ä»¥æ‹¥æœ‰å¤šä¸ªç”¨æˆ·ç»„ã€‚åº”ç”¨è·å–æƒé™å°±æ˜¯åŠ å…¥ç›¸åº”çš„ç”¨æˆ·ç»„ã€‚Packageçš„ç”³è¯·çš„æƒé™å·²ç»ä¿å­˜åˆ°å®ƒå¯¹åº”çš„PackageSettingå¯¹è±¡ä¸­ï¼Œå¦‚æœå½“å‰packageä½¿ç”¨çš„æ˜¯å…±äº«uidï¼Œåˆ™å®ƒè·å¾—æƒé™ä¸å®ƒå…±äº«çš„linuxç”¨æˆ·çš„èµ„æºæƒé™ç›¸åŒã€‚å¯¹äºæœ‰è‡ªå·±ç‹¬ç«‹uidçš„åº”ç”¨ï¼Œå®ƒä¼šé¦–å…ˆè·å¾—ä¸€ç»„é»˜è®¤çš„ç”¨æˆ·æƒé™ï¼Œè¿™æ˜¯æ‰€æœ‰åº”ç”¨éƒ½å…·æœ‰çš„åŸºæœ¬æƒé™ã€‚ç„¶åä¼šä¸€ä¸€éªŒè¯åº”ç”¨ç”³è¯·çš„æƒé™æ˜¯å¦åˆæ³•ï¼Œå¦‚æœåˆæ³•ï¼Œåˆ™ä¼šä¸ºå…¶å¢åŠ è¯¥é¡¹æƒé™ã€‚</p>
<p>ç°åœ¨ï¼Œåº”ç”¨å·²ç»è¢«å®‰è£…ã€åˆ†é…uidå’Œåˆ†é…æƒé™ï¼Œæ¥ä¸‹æ¥éœ€è¦å°†è¿™äº›åº”ç”¨çš„ä¿¡æ¯ä¿å­˜ä¸‹æ¥ä»¥å¤‡ä¸‹æ¬¡ä½¿ç”¨ã€‚ä¿å­˜çš„ä½ç½®å°±æ˜¯<code>/data/system/packages.xml</code>ã€‚æ³¨æ„ï¼Œåœ¨ä¿å­˜uidæ—¶ï¼ŒuserIdå’ŒsharedUserIdåªèƒ½æœ‰ä¸€ä¸ªã€‚</p>
<p>Androidç³»ç»Ÿå°±æ˜¯é€šè¿‡ç”¨æˆ·idå’Œç”¨æˆ·ç»„idæ¥é™åˆ¶åº”ç”¨çš„èµ„æºè®¿é—®æƒé™ï¼Œé˜²æ­¢ç ´åå…¶å®ƒåº”ç”¨çš„æ•°æ®ã€‚åˆ†é…çš„uidå’Œgidä¼šåœ¨åˆ›å»ºåº”ç”¨è¿›ç¨‹æ—¶ä½¿ç”¨ï¼Œæ˜¯è¯¥è¿›ç¨‹åœ¨ç‰¹å®šçš„ç”¨æˆ·ç»„ä¸‹è¿è¡Œã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å­¦åˆ°çš„æ‰æ˜¯è‡ªå·±çš„ï¼Œå¹²æ´»éƒ½æ˜¯æ‰¯æ·¡&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;1-åº”ç”¨çš„å®‰è£…&quot;&gt;&lt;a href=&quot;#1-åº”ç”¨çš„å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;1. åº”ç”¨çš„å®‰è£…&quot;&gt;&lt;/a&gt;1. åº”ç”¨çš„å®‰è£…&lt;/h2&gt;&lt;p&gt;PackageManagerServiceè´Ÿè´£ç®¡ç†åº”ç”¨çš„å®‰è£…ã€‚åœ¨ç¬¬14ç« ä¸­è®²åˆ°ï¼ŒSystemServiceä¼šå¯åŠ¨PackageManagerServiceï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»SystemServiceå¯åŠ¨PackageManagerServiceå¼€å§‹åˆ†æã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(16):Androidåº”ç”¨çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æ¨¡å‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-16-Android%E5%BA%94%E7%94%A8%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%B6%88%E6%81%AF%E5%BE%AA%E7%8E%AF%E6%A8%A1%E5%9E%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-16-Androidåº”ç”¨çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯æ¨¡å‹/</id>
    <published>2017-02-14T06:53:14.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¯»ä¹¦ä¸å®œæ‹–æ²“</p>
</blockquote>
<h2 id="0-èƒŒæ™¯"><a href="#0-èƒŒæ™¯" class="headerlink" title="0. èƒŒæ™¯"></a>0. èƒŒæ™¯</h2><p>Androidåº”ç”¨çš„ä¸»çº¿ç¨‹ä¸ºActivityThreadï¼Œåœ¨ç¬¬ï¼ˆ10ï¼‰ç« å·²ç»è®²è¿‡ï¼Œå®ƒä¸»è¦è´Ÿè´£å¤„ç†ç•Œé¢äº‹ä»¶ï¼Œæ‰€ä»¥å¼€å‘è€…åº”è¯¥é¿å…åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†è€—æ—¶çš„ä»»åŠ¡ã€‚ä¸ºäº†å‡è½»ä¸»çº¿ç¨‹çš„è´Ÿæ‹…ï¼Œå¼€å‘è€…åº”è¯¥å¯ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†è€—æ—¶çš„ä»»åŠ¡ã€‚åœ¨Androidä¸­å¯ä»¥åˆ›å»ºå¤šç§çº¿ç¨‹ï¼Œæœ‰çš„çº¿ç¨‹å¯ä»¥æœ‰è‡ªå·±çš„æ¶ˆæ¯å¾ªç¯ï¼Œæœ‰çš„çº¿ç¨‹åˆ™å¯ä»¥å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯æ¥ä½¿å¾—ç•Œé¢å‘ç”Ÿæ”¹å˜ã€‚</p>
<p>##1. ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯</p>
<p>åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼šActivityManagerServiceçº¿ç¨‹è¯·æ±‚Zygoteè¿›ç¨‹åˆ›å»ºåº”ç”¨è¿›ç¨‹ï¼›Zygoteé€šè¿‡forkæ¥åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹å°†ActivityThreadçš„mainä½œä¸ºå…¥å£è¿›å…¥Looperå¾ªç¯ï¼›Looperä¼šè°ƒç”¨é™æ€æˆå‘˜å‡½æ•°prepareMainLooperåˆ›å»ºä¸€ä¸ªLooperå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨è¯¥åº”ç”¨è¿›ç¨‹ä¸­ï¼Œè¯¥æ–¹æ³•åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ã€‚<br><a id="more"></a></p>
<h2 id="2-å­çº¿ç¨‹HandlerThread"><a href="#2-å­çº¿ç¨‹HandlerThread" class="headerlink" title="2. å­çº¿ç¨‹HandlerThread"></a>2. å­çº¿ç¨‹HandlerThread</h2><p>Androidåº”ç”¨ä¸­ï¼Œåˆ›å»ºå­çº¿ç¨‹å¯ä»¥å’Œjavaæ¡Œé¢åº”ç”¨ä¸€æ ·ï¼Œåˆ›å»ºä¸€ä¸ªThreadå­ç±»ï¼Œå®ç°runå‡½æ•°ï¼Œç„¶åstartå³å¯ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼æ˜¯æ²¡æœ‰æ¶ˆæ¯å¾ªç¯çš„ï¼Œæ˜¯ä¸€ç§æ¯”è¾ƒç®€å•çš„æ–¹æ³•ã€‚</p>
<p>å¦ä¸€ç§åˆ™æ˜¯ä½¿ç”¨Androidå®šåˆ¶ç‰ˆçš„Threadâ€“HandlerThreadã€‚HanlderThre    adçš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå®Œå…¨å¯ä»¥æ¨¡ä»¿å®ƒå®ç°ä¸€ä¸ªè‡ªå·±çš„å¸¦æœ‰æ¶ˆæ¯å¾ªç¯çš„Threadï¼Œæˆ–è€…å®ç°ä¸€ä¸ªé›†æˆHandlerThreadçš„å­ç±»ã€‚</p>
<p><em>frameworks/base/core/java/android/os/HandlerThread.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Handy class for starting a new thread that has a looper. The looper can then be</div><div class="line"> * used to create handler classes. Note that start() must still be called.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> mPriority;</div><div class="line">    <span class="keyword">int</span> mTid = -<span class="number">1</span>;</div><div class="line">    Looper mLooper;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerThread</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(name);</div><div class="line">        mPriority = Process.THREAD_PRIORITY_DEFAULT;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Constructs a HandlerThread.</div><div class="line">     * <span class="doctag">@param</span> name</div><div class="line">     * <span class="doctag">@param</span> priority The priority to run the thread at. The value supplied must be from</div><div class="line">     * &#123;<span class="doctag">@link</span> android.os.Process&#125; and not from java.lang.Thread.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HandlerThread</span><span class="params">(String name, <span class="keyword">int</span> priority)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(name);</div><div class="line">        mPriority = priority;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Call back method that can be explicitly overridden if needed to execute some</div><div class="line">     * setup before Looper loops.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLooperPrepared</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        mTid = Process.myTid();</div><div class="line">        <span class="comment">//å‡†å¤‡äº†looper</span></div><div class="line">        Looper.prepare();</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="comment">//è·å¾—è‡ªå·±çš„looper</span></div><div class="line">            mLooper = Looper.myLooper();</div><div class="line">            notifyAll();</div><div class="line">        &#125;</div><div class="line">        Process.setThreadPriority(mPriority);</div><div class="line">        onLooperPrepared();</div><div class="line">        <span class="comment">//è¿›å…¥æ¶ˆæ¯å¾ªç¯</span></div><div class="line">        Looper.loop();</div><div class="line">        mTid = -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This method returns the Looper associated with this thread. If this thread not been started</div><div class="line">     * or for any reason is isAlive() returns false, this method will return null. If this thread</div><div class="line">     * has been started, this method will block until the looper has been initialized.</div><div class="line">     * <span class="doctag">@return</span> The looper.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Looper <span class="title">getLooper</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isAlive()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If the thread has been started, wait until the looper has been created.</span></div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">while</span> (isAlive() &amp;&amp; mLooper == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    wait();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mLooper;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Quits the handler thread's looper.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * Causes the handler thread's looper to terminate without processing any</div><div class="line">     * more messages in the message queue.</div><div class="line">     * &lt;/p&gt;&lt;p&gt;</div><div class="line">     * Any attempt to post messages to the queue after the looper is asked to quit will fail.</div><div class="line">     * For example, the &#123;<span class="doctag">@link</span> Handler#sendMessage(Message)&#125; method will return false.</div><div class="line">     * &lt;/p&gt;&lt;p class="note"&gt;</div><div class="line">     * Using this method may be unsafe because some messages may not be delivered</div><div class="line">     * before the looper terminates.  Consider using &#123;<span class="doctag">@link</span> #quitSafely&#125; instead to ensure</div><div class="line">     * that all pending work is completed in an orderly manner.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> True if the looper looper has been asked to quit or false if the</div><div class="line">     * thread had not yet started running.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #quitSafely</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        Looper looper = getLooper();</div><div class="line">        <span class="keyword">if</span> (looper != <span class="keyword">null</span>) &#123;</div><div class="line">            looper.quit();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Quits the handler thread's looper safely.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * Causes the handler thread's looper to terminate as soon as all remaining messages</div><div class="line">     * in the message queue that are already due to be delivered have been handled.</div><div class="line">     * Pending delayed messages with due times in the future will not be delivered.</div><div class="line">     * &lt;/p&gt;&lt;p&gt;</div><div class="line">     * Any attempt to post messages to the queue after the looper is asked to quit will fail.</div><div class="line">     * For example, the &#123;<span class="doctag">@link</span> Handler#sendMessage(Message)&#125; method will return false.</div><div class="line">     * &lt;/p&gt;&lt;p&gt;</div><div class="line">     * If the thread has not been started or has finished (that is if</div><div class="line">     * &#123;<span class="doctag">@link</span> #getLooper&#125; returns null), then false is returned.</div><div class="line">     * Otherwise the looper is asked to quit and true is returned.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> True if the looper looper has been asked to quit or false if the</div><div class="line">     * thread had not yet started running.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">quitSafely</span><span class="params">()</span> </span>&#123;</div><div class="line">        Looper looper = getLooper();</div><div class="line">        <span class="keyword">if</span> (looper != <span class="keyword">null</span>) &#123;</div><div class="line">            looper.quitSafely();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the identifier of this thread. See Process.myTid().</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getThreadId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mTid;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>   </p>
<p>ä»HandlerThreadçš„æºç å¯ä»¥çœ‹å‡ºå®ƒæä¾›äº†åŸºæœ¬çš„å¼€å…³åŠŸèƒ½ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•æ–¹ä¾¿ã€‚å…·ä½“å¦‚ä½•ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆå®ä¾‹åŒ–ä¸€ä¸ªHandlerThreadå¯¹è±¡ï¼Œç„¶åå¯åŠ¨è¿™ä¸ªthreadã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HandlerThread handleThread = <span class="keyword">new</span> HandlerThread(<span class="string">"Handler Thread"</span>);</div><div class="line"><span class="comment">//ç„¶åå¯åŠ¨å®ƒï¼Œå› ä¸ºHandlerThreadæ˜¯Threadçš„å­ç±»ï¼Œæ‰€ä»¥å¯åŠ¨æ–¹æ³•å¹¶æ— å·®å¼‚</span></div><div class="line">handleThread.start();</div></pre></td></tr></table></figure></p>
<p>ç„¶ååˆ›å»ºä¸€ä¸ªå®ç°äº†Runnableæ¥å£çš„ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ThreadTask</span><span class="params">()</span></span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//é‡å†™è¯¥æ–¹æ³•</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</div><div class="line">	   <span class="comment">//ä½ çš„ä»»åŠ¡</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªRunnableçš„å®ä¾‹å¯¹è±¡ï¼Œç„¶åä¸¢ç»™HandleThreadæ¥å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ThreadTask threadTask = <span class="keyword">new</span> ThreadTask();</div><div class="line"><span class="comment">//ä¸ºHandlerThreadçš„Looperåˆ›å»ºä¸€ä¸ªHandler</span></div><div class="line">Handler handler = <span class="keyword">new</span> Handler(handlerThread.getLooper);</div><div class="line"><span class="comment">//é€šè¿‡Handlerå°†ä»»åŠ¡ç»™HandlerThreadæ¥æ‰§è¡Œ</span></div><div class="line">handler.post(threadTask);</div></pre></td></tr></table></figure>
<p>åœ¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†åˆ°è¯¥ä»»åŠ¡æ—¶ï¼ŒthreadTaskçš„runå‡½æ•°å°±ä¼šè¢«è°ƒç”¨æ‰§è¡Œã€‚</p>
<h2 id="3-å¼‚æ­¥ä»»åŠ¡AsyncTask"><a href="#3-å¼‚æ­¥ä»»åŠ¡AsyncTask" class="headerlink" title="3. å¼‚æ­¥ä»»åŠ¡AsyncTask"></a>3. å¼‚æ­¥ä»»åŠ¡AsyncTask</h2><p>ä¸€ä¸ªAsyncTaskçš„ä¾‹å­ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>, <span class="title">String</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">//è¿™ä¸€æ­¥æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨çš„  </span></div><div class="line">    <span class="comment">//onPreExecuteæ–¹æ³•ç”¨äºåœ¨æ‰§è¡Œåå°ä»»åŠ¡å‰åšä¸€äº›UIæ“ä½œ  </span></div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;  </div><div class="line">        Log.i(TAG, <span class="string">"onPreExecute() called"</span>);  </div><div class="line">        textView.setText(<span class="string">"loading..."</span>);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">//è¿™ä¸€æ­¥æ˜¯å¼‚æ­¥çº¿ç¨‹çš„ä¸»è¦è¿‡ç¨‹</span></div><div class="line">    <span class="comment">//doInBackgroundæ–¹æ³•å†…éƒ¨æ‰§è¡Œåå°ä»»åŠ¡,ä¸å¯åœ¨æ­¤æ–¹æ³•å†…ä¿®æ”¹UI  </span></div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(String... params)</span> </span>&#123;  </div><div class="line">        Log.i(TAG, <span class="string">"doInBackground(Params... params) called"</span>);  </div><div class="line">        <span class="comment">//...</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(baos.toByteArray(), <span class="string">"gb2312"</span>);  </div><div class="line">    &#125;  </div><div class="line">    </div><div class="line">    <span class="comment">//è¿™ä¸€æ­¥æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨</span></div><div class="line">    <span class="comment">//onProgressUpdateæ–¹æ³•ç”¨äºæ›´æ–°è¿›åº¦ä¿¡æ¯  </span></div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onProgressUpdate</span><span class="params">(Integer... progresses)</span> </span>&#123;  </div><div class="line">        Log.i(TAG, <span class="string">"onProgressUpdate(Progress... progresses) called"</span>);  </div><div class="line">        progressBar.setProgress(progresses[<span class="number">0</span>]);  </div><div class="line">        textView.setText(<span class="string">"loading..."</span> + progresses[<span class="number">0</span>] + <span class="string">"%"</span>);  </div><div class="line">    &#125;  </div><div class="line">    </div><div class="line">    <span class="comment">//ä¸»çº¿ç¨‹è°ƒç”¨</span></div><div class="line">    <span class="comment">//onPostExecuteæ–¹æ³•ç”¨äºåœ¨æ‰§è¡Œå®Œåå°ä»»åŠ¡åæ›´æ–°UI,æ˜¾ç¤ºç»“æœ  </span></div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String result)</span> </span>&#123;  </div><div class="line">        Log.i(TAG, <span class="string">"onPostExecute(Result result) called"</span>);  </div><div class="line">        textView.setText(result);  </div><div class="line">  </div><div class="line">        execute.setEnabled(<span class="keyword">true</span>);  </div><div class="line">        cancel.setEnabled(<span class="keyword">false</span>);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">//ä¸»çº¿ç¨‹è°ƒç”¨</span></div><div class="line">    <span class="comment">//onCancelledæ–¹æ³•ç”¨äºåœ¨å–æ¶ˆæ‰§è¡Œä¸­çš„ä»»åŠ¡æ—¶æ›´æ”¹UI  </span></div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCancelled</span><span class="params">()</span> </span>&#123;  </div><div class="line">        Log.i(TAG, <span class="string">"onCancelled() called"</span>);  </div><div class="line">        textView.setText(<span class="string">"cancelled"</span>);  </div><div class="line">        progressBar.setProgress(<span class="number">0</span>);  </div><div class="line">  </div><div class="line">        execute.setEnabled(<span class="keyword">true</span>);  </div><div class="line">        cancel.setEnabled(<span class="keyword">false</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div></pre></td></tr></table></figure></p>
<p>å­çº¿ç¨‹å¦‚æœæƒ³å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œåˆ™éœ€è¦é€šè¿‡ä¸»çº¿ç¨‹çš„Handlerã€‚è¿™é‡ŒAsyncTaskè¿è¡Œäºå­çº¿ç¨‹ï¼Œä½†æ˜¯æ— éœ€Handlerä¹Ÿå¯ä»¥å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚AsyncTaskç±»çš„å…·ä½“å®ç°å¦‚ä¸‹ã€‚</p>
<p><em>frameworks/base/core/java/android/os/AsyncTask.java</em>  :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTask</span>&lt;<span class="title">Params</span>, <span class="title">Progress</span>, <span class="title">Result</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="comment">//è´Ÿè´£åˆ›å»ºçº¿ç¨‹ï¼Œæ”¾å…¥sPoolWorkQueueä¸­</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadFactory sThreadFactory = <span class="keyword">new</span> ThreadFactory() &#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger mCount = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"AsyncTask #"</span> + mCount.getAndIncrement());</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></div><div class="line">    <span class="comment">//å¦‚æœé˜Ÿåˆ—å·²ç©ºï¼Œåˆ™è¯•å›¾è·å–ä»»åŠ¡çš„çº¿ç¨‹åˆ™ä¼šé˜»å¡</span></div><div class="line">    <span class="comment">//å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¯•å›¾å‘å…¶ä¸­åŠ å…¥ä»»åŠ¡çš„çº¿ç¨‹ä¹Ÿä¼šé˜»å¡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</div><div class="line">            <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">128</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * An &#123;<span class="doctag">@link</span> Executor&#125; that can be used to execute tasks in parallel.</div><div class="line">     * ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç”¨æ¥æ‰§è¡ŒsPoolWorkQueueä¸­çš„ä»»åŠ¡ï¼Œä¸‹é¢çœ‹å…¶å¦‚ä½•æ‰§è¡Œçº¿ç¨‹</div><div class="line">     * è¿™é‡Œè®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ç­‰å‚æ•°</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR</div><div class="line">            = <span class="keyword">new</span> ThreadPoolExecutor(CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE,</div><div class="line">                    TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * An &#123;<span class="doctag">@link</span> Executor&#125; that executes tasks one at a time in serial</div><div class="line">     * order.  This serialization is global to a particular process.</div><div class="line">     * è¯¥çº¿ç¨‹æ‰§è¡Œå™¨æ˜¯é¡ºåºæ‰§è¡Œ</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SERIAL_EXECUTOR = <span class="keyword">new</span> SerialExecutor();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_POST_RESULT = <span class="number">0x1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_POST_PROGRESS = <span class="number">0x2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Executor sDefaultExecutor = SERIAL_EXECUTOR;</div><div class="line">    <span class="comment">//åˆ›å»ºå½“å‰çº¿ç¨‹çš„ä¸€ä¸ªhandlerï¼Œå¦‚ä¸»çº¿ç¨‹</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InternalHandler sHandler;</div><div class="line">    </div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WorkerRunnable&lt;Params, Result&gt; mWorker;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FutureTask&lt;Result&gt; mFuture;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>sThreadFactoryï¼ŒsPoolWorkQueueå’ŒTHREAD_POOL_EXECUTORéƒ½æ˜¯å…¨å±€é™æ€å˜é‡ã€‚åœ¨ä¸€ä¸ªAppè¿›ç¨‹ä¸­ï¼Œå› æ­¤ï¼Œæ‰€æœ‰ä½¿ç”¨AsyncTaskçš„å¼‚æ­¥çº¿ç¨‹ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¿™æ ·å¯ä»¥é¿å…åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ± å ç”¨èµ„æºã€‚</p>
<p>ThreadPoolExecutoråœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼šæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©æ˜¯å¦åˆ›å»ºçº¿ç¨‹ï¼Œå…·ä½“å¦‚ä¸‹ï¼š   </p>
<ol>
<li>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œæ–°æ·»åŠ çš„ä»»åŠ¡ã€‚</li>
<li>å¦‚æœå¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™<ul>
<li>sPoolWorkQueueæœªæ»¡ï¼Œåˆ™å°†æ–°ä»»åŠ¡ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­</li>
<li>å¦‚æœå·²æ»¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œæ–°çš„ä»»åŠ¡</li>
</ul>
</li>
<li>å¦‚æœçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°å·²ç»å¤§äº/ç­‰äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦‚æœé˜Ÿåˆ—ä¸æ»¡ï¼Œåˆ™æ”¾å…¥é˜Ÿåˆ—ï¼›å¦‚æœå·²æ»¡ï¼Œåˆ™æ‹’ç»æ–°ä»»åŠ¡ã€‚</li>
</ol>
<p>InternalHandlerç±»çš„å®ä¾‹å¯¹è±¡sHandleræ˜¯åˆ›å»ºAsyncTaskçš„çº¿ç¨‹çš„Handlerï¼Œè¿™é‡Œå‡è®¾æ˜¯ä¸»çº¿ç¨‹ã€‚</p>
<p><em>frameworks/base/core/java/android/os/AsyncTask.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InternalHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(Looper.getMainLooper());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="comment">//è¿™ä¸ªå‡½æ•°æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­</span></div><div class="line">            AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> MESSAGE_POST_RESULT:</div><div class="line">                    <span class="comment">// There is only one result</span></div><div class="line">                    <span class="comment">//å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æŸåå‘é€ç»“æœï¼Œè¿™é‡Œå¤„ç†è¿™ä¸ªç»“æœ</span></div><div class="line">                    result.mTask.finish(result.mData[<span class="number">0</span>]);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MESSAGE_POST_PROGRESS:</div><div class="line">                    <span class="comment">//å¼‚æ­¥ä»»åŠ¡å®è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨publishProgressæ¥å‘å¸ƒä¸­é—´ç»“æœ</span></div><div class="line">                    <span class="comment">//è¿™ä¸€æ­¥å°±æ˜¯ä¸»çº¿ç¨‹å¤„ç†è¯¥ä¸­é—´ç»“æœ</span></div><div class="line">                    result.mTask.onProgressUpdate(result.mData);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­resultæ˜¯ä¸€ä¸ªAsyncTaskResultï¼Œé‡Œé¢ä¿å­˜äº†ç»“æœä¿¡æ¯å’Œå…¶å¯¹åº”çš„AsyncTaskã€‚</p>
<p><em>frameworks/base/core/java/android/os/AsyncTask.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"RawUseOfParameterizedType"</span>&#125;)</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTaskResult</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> AsyncTask mTask;</div><div class="line">    <span class="keyword">final</span> Data[] mData;</div><div class="line"></div><div class="line">    AsyncTaskResult(AsyncTask task, Data... data) &#123;</div><div class="line">        mTask = task;</div><div class="line">        mData = data;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>WorkerRunnableç±»çš„å®ä¾‹mWorkerå®ç°å¦‚ä¸‹ï¼Œä¿å­˜äº†å¼‚æ­¥ä»»åŠ¡çš„è¾“å…¥æ•°æ®ï¼š</p>
<p><em>frameworks/base/core/java/android/os/AsyncTask.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerRunnable</span>&lt;<span class="title">Params</span>, <span class="title">Result</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Result</span>&gt; </span>&#123;</div><div class="line">    Params[] mParams;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>äº†è§£äº†AsyncTaskçš„æˆå‘˜å˜é‡åï¼Œä¸‹é¢çœ‹ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åˆ›å»ºçš„å®Œæ•´è¿‡ç¨‹ã€‚</p>
<h3 id="3-1-AsyncTaskçš„æ„é€ å‡½æ•°"><a href="#3-1-AsyncTaskçš„æ„é€ å‡½æ•°" class="headerlink" title="3.1 AsyncTaskçš„æ„é€ å‡½æ•°"></a>3.1 AsyncTaskçš„æ„é€ å‡½æ•°</h3><p><em>frameworks/base/core/java/android/os/AsyncTask.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Creates a new asynchronous task. This constructor must be invoked on the UI thread.</div><div class="line"> * çœ‹æ¥AsyncTaskåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºå•Šï¼</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//è¿™é‡Œå®ç°äº†ä¸€ä¸ªWorkerRunnableçš„åŒ¿åç±»ï¼ŒåŒæ—¶å®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡mWorker</span></div><div class="line">    <span class="comment">//è¿™é‡Œé¢å°è£…äº†æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">    mWorker = <span class="keyword">new</span> WorkerRunnable&lt;Params, Result&gt;() &#123;</div><div class="line">        <span class="comment">//å¼‚æ­¥çº¿ç¨‹é‡Œæ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            mTaskInvoked.set(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">            <span class="comment">//noinspection unchecked</span></div><div class="line">            <span class="comment">//è¿™é‡Œæœ‰ç”¨æˆ·å®šä¹‰çš„æ‰€è¦æ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">            Result result = doInBackground(mParams);</div><div class="line">            Binder.flushPendingCommands();</div><div class="line">            <span class="keyword">return</span> postResult(result);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">//åˆå°†mWorkerå°è£…å¦‚FutureTaskï¼ŒåŒæ ·å°è£…äº†è¦æ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">    mFuture = <span class="keyword">new</span> FutureTask&lt;Result&gt;(mWorker) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                postResultIfNotInvoked(get());</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                android.util.Log.w(LOG_TAG, e);</div><div class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"An error occurred while executing doInBackground()"</span>,</div><div class="line">                        e.getCause());</div><div class="line">            &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</div><div class="line">                postResultIfNotInvoked(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure> </p>
<h3 id="3-2-AsyncTaskçš„æ‰§è¡Œ"><a href="#3-2-AsyncTaskçš„æ‰§è¡Œ" class="headerlink" title="3.2 AsyncTaskçš„æ‰§è¡Œ"></a>3.2 AsyncTaskçš„æ‰§è¡Œ</h3><p>åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡ŒAsyncTaskæ—¶ï¼Œéœ€è¦è°ƒç”¨executeæ¥æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œè¯¥æ–¹æ³•åˆä¼šè°ƒç”¨å¦‚ä¸‹å‡½æ•°æ¥æ‰§è¡Œä»»åŠ¡ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯executeå‡½æ•°æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œå¼‚æ­¥ä»»åŠ¡è¿˜æ²¡å¼€å§‹ã€‚</p>
<p><em>frameworks/base/core/java/android/os/AsyncTask.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MainThread</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title">executeOnExecutor</span><span class="params">(Executor exec,</span></span></div><div class="line">          Params... params) &#123;</div><div class="line">      <span class="comment">//...</span></div><div class="line">      mStatus = Status.RUNNING;</div><div class="line">      <span class="comment">//åœ¨ä¸»çº¿ç¨‹é‡Œè¿è¡Œæ‰§è¡Œå‰çš„ä»»åŠ¡</span></div><div class="line">      onPreExecute();</div><div class="line"></div><div class="line">      mWorker.mParams = params;</div><div class="line">      <span class="comment">//execæ˜¯ä¸€ä¸ªSerialExecute</span></div><div class="line">      exec.execute(mFuture);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>SerialExecutoræ‰§è¡Œå™¨çš„æ‰§è¡Œè¿‡ç¨‹ã€‚<br><em>frameworks/base/core/java/android/os/AsyncTask.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> ArrayDeque&lt;Runnable&gt;();</div><div class="line">        Runnable mActive;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</div><div class="line">            <span class="comment">//æŠŠmFutureå°è£…å…¥Runnableï¼Œç„¶åæ”¾åœ¨é˜Ÿåˆ—mTasksä¸­</span></div><div class="line">            mTasks.offer(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        r.run();</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        <span class="comment">//åœ¨ç»“æŸè¯¥ä»»åŠ¡ä¹‹å‰ï¼ŒæŠŠé˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ªä»»åŠ¡æ”¾å…¥çº¿ç¨‹æ± </span></div><div class="line">                        scheduleNext();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//å¼€å§‹æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡</span></div><div class="line">                scheduleNext();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//ç¬¬ä¸€ä¸ªä»»åŠ¡æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œ</span></div><div class="line">                THREAD_POOL_EXECUTOR.execute(mActive);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><br>åˆ°è¿™é‡Œå·²ç»å°†ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± æ¥å¯åŠ¨ï¼Œç”¨æˆ·å®šä¹‰çš„doInBackgroundå·²ç»å¼€å§‹è¿è¡Œã€‚</p>
<h3 id="3-3-å¼‚æ­¥çº¿ç¨‹å‘é€æ¶ˆæ¯"><a href="#3-3-å¼‚æ­¥çº¿ç¨‹å‘é€æ¶ˆæ¯" class="headerlink" title="3.3 å¼‚æ­¥çº¿ç¨‹å‘é€æ¶ˆæ¯"></a>3.3 å¼‚æ­¥çº¿ç¨‹å‘é€æ¶ˆæ¯</h3><p>å¼‚æ­¥çº¿ç¨‹å¯ä»¥é€šè¿‡publishProgresså‘é€æ¶ˆæ¯ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WorkerThread</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishProgress</span><span class="params">(Progress... values)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isCancelled()) &#123;</div><div class="line">            <span class="comment">//è·å¾—ä¸»çº¿ç¨‹çš„handler--sHandlerï¼Œé€šè¿‡å®ƒå‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯</span></div><div class="line">            getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</div><div class="line">                    <span class="keyword">new</span> AsyncTaskResult&lt;Progress&gt;(<span class="keyword">this</span>, values)).sendToTarget();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ä¸»çº¿ç¨‹é€šè¿‡sHandlerçš„handleMessageå‡½æ•°æ¥å¤„ç†è¯¥æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨ç”¨æˆ·è‡ªå·±å®ç°çš„onProgressUpdateå‡½æ•°æ¥å®ç°UIçš„æ›´æ–°ã€‚</p>
<h3 id="3-4-å¼‚æ­¥ä»»åŠ¡ç»“æŸ"><a href="#3-4-å¼‚æ­¥ä»»åŠ¡ç»“æŸ" class="headerlink" title="3.4 å¼‚æ­¥ä»»åŠ¡ç»“æŸ"></a>3.4 å¼‚æ­¥ä»»åŠ¡ç»“æŸ</h3><p>åœ¨å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åï¼Œä¼šè°ƒç”¨FutureTaskçš„doneå‡½æ•°æ¥å¤„ç†ç»“æŸäº‹ä»¶ã€‚è¿™é‡Œä¸»è¦å¤„ç†çš„å°±æ˜¯å¼‚æ­¥ä»»åŠ¡å¤„ç†å®Œæˆåï¼Œæœ€åçš„è¿”å›å€¼ã€‚æœ€åçš„ç»“æœé€šè¿‡å¦‚ä¸‹å‡½æ•°å‘é€ç»™ä¸»çº¿ç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Result <span class="title">postResult</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">       Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT,</div><div class="line">               <span class="keyword">new</span> AsyncTaskResult&lt;Result&gt;(<span class="keyword">this</span>, result));</div><div class="line">       message.sendToTarget();</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>å‰é¢å·²ç»è®²è¿‡ï¼Œä¸»çº¿ç¨‹ä¼šè°ƒç”¨handleré‡Œçš„result.mTask.finish(result.mData[0])æ¥å¤„ç†ç»“æœã€‚finishå‡½æ•°å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(Result result)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">            <span class="comment">//è¿™äº›éƒ½æ˜¯ç”¨æˆ·å¯ä»¥é‡å†™çš„</span></div><div class="line">            <span class="comment">//æ¥å®ç°è‡ªå·±çš„åŠŸèƒ½</span></div><div class="line">            onCancelled(result);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">            onPostExecute(result);</div><div class="line">      &#125;</div><div class="line">      mStatus = Status.FINISHED;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4. æ€»ç»“"></a>4. æ€»ç»“</h2><p>è¿™é‡Œä¸»è¦ä»‹ç»äº†androidåº”ç”¨é‡Œçš„å‡ ç§çº¿ç¨‹çš„è¿è¡Œæœºåˆ¶ã€‚</p>
<p>æ™®é€šjavaçº¿ç¨‹Threadæ˜¯æœ€ç®€å•çš„ä¸€ç§æ–¹æ³•ï¼Œä½†æ˜¯æ¯”è¾ƒéš¾ç®¡ç†ï¼Œä¸ä¸»çº¿ç¨‹é€šä¿¡ä¸»è¦é handlerã€‚è€Œä¸”ï¼Œè¯¥ä¸­çº¿ç¨‹åªèƒ½å‘ä¸»çº¿ç¨‹å‘æ¶ˆæ¯ï¼Œè€Œä¸»çº¿ç¨‹æ— æ³•å‘å­çº¿ç¨‹å‘æ¶ˆæ¯ã€‚</p>
<p>HandlerThreadåˆ™æ˜¯å¯ä»¥æœ‰è‡ªå·±çš„looperå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°†ä»»åŠ¡å‘é€å…¥æ¶ˆæ¯é˜Ÿåˆ—æ¥å®ç°å¼‚æ­¥ä»»åŠ¡çš„å¤„ç†ï¼ŒåŒæ—¶è¿˜æ–¹ä¾¿ç®¡ç†ã€‚ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹å¯ä»¥é€šè¿‡å¯¹æ–¹çš„Handlerç›¸äº’å‘é€æ¶ˆæ¯ã€‚</p>
<p>AsyncTaskæ˜¯æ¯”è¾ƒé€‚ç”¨äºAndroidåº”ç”¨çš„ä¸€ç§å¼‚æ­¥ä»»åŠ¡å®ç°æ–¹å¼ã€‚è™½ç„¶å½’æ ¹ç»“åº•è¿˜æ˜¯é€šè¿‡handleræ¥å‘ä¸»è¿›ç¨‹å‘æ¶ˆæ¯ï¼Œä½†æ˜¯æ•´ä¸ªå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹çš„åˆ’åˆ†å’Œç®¡ç†æ›´ä¸ºç§‘å­¦ï¼Œå±è”½äº†å†…éƒ¨å®ç°çš„å¤æ‚ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´ä¸ºç®€å•å®ç”¨çš„æ¥å£ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¯»ä¹¦ä¸å®œæ‹–æ²“&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;0-èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#0-èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;0. èƒŒæ™¯&quot;&gt;&lt;/a&gt;0. èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;Androidåº”ç”¨çš„ä¸»çº¿ç¨‹ä¸ºActivityThreadï¼Œåœ¨ç¬¬ï¼ˆ10ï¼‰ç« å·²ç»è®²è¿‡ï¼Œå®ƒä¸»è¦è´Ÿè´£å¤„ç†ç•Œé¢äº‹ä»¶ï¼Œæ‰€ä»¥å¼€å‘è€…åº”è¯¥é¿å…åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†è€—æ—¶çš„ä»»åŠ¡ã€‚ä¸ºäº†å‡è½»ä¸»çº¿ç¨‹çš„è´Ÿæ‹…ï¼Œå¼€å‘è€…åº”è¯¥å¯ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†è€—æ—¶çš„ä»»åŠ¡ã€‚åœ¨Androidä¸­å¯ä»¥åˆ›å»ºå¤šç§çº¿ç¨‹ï¼Œæœ‰çš„çº¿ç¨‹å¯ä»¥æœ‰è‡ªå·±çš„æ¶ˆæ¯å¾ªç¯ï¼Œæœ‰çš„çº¿ç¨‹åˆ™å¯ä»¥å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯æ¥ä½¿å¾—ç•Œé¢å‘ç”Ÿæ”¹å˜ã€‚&lt;/p&gt;
&lt;p&gt;##1. ä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¾ªç¯&lt;/p&gt;
&lt;p&gt;åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼šActivityManagerServiceçº¿ç¨‹è¯·æ±‚Zygoteè¿›ç¨‹åˆ›å»ºåº”ç”¨è¿›ç¨‹ï¼›Zygoteé€šè¿‡forkæ¥åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹å°†ActivityThreadçš„mainä½œä¸ºå…¥å£è¿›å…¥Looperå¾ªç¯ï¼›Looperä¼šè°ƒç”¨é™æ€æˆå‘˜å‡½æ•°prepareMainLooperåˆ›å»ºä¸€ä¸ªLooperå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨è¯¥åº”ç”¨è¿›ç¨‹ä¸­ï¼Œè¯¥æ–¹æ³•åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(15):Androidåº”ç”¨è¿›ç¨‹çš„å¯åŠ¨</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-15-Android%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%90%AF%E5%8A%A8/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-15-Androidåº”ç”¨è¿›ç¨‹çš„å¯åŠ¨/</id>
    <published>2017-02-14T06:46:42.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è‡ªå·±å¼€å¿ƒå°±å¥½ï¼Œä½•å¿…ç®¡ä»–äººçƒ¦æ¼</p>
</blockquote>
<h2 id="1-åº”ç”¨è¿›ç¨‹åˆ›å»º"><a href="#1-åº”ç”¨è¿›ç¨‹åˆ›å»º" class="headerlink" title="1. åº”ç”¨è¿›ç¨‹åˆ›å»º"></a>1. åº”ç”¨è¿›ç¨‹åˆ›å»º</h2><p>ActivityManagerServiceè´Ÿè´£ç®¡ç†åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºã€‚è¿™ä¸€èŠ‚ä¼šè®²è¿°å¦‚ä½•ä»ActivityManagerServiceç”³è¯·åˆ›å»ºä¸€ä¸ªappè¿›ç¨‹ï¼Œç„¶åä»zygoteå…‹éš†ä¸€ä¸ªè¿›ç¨‹çš„è¿‡ç¨‹ã€‚</p>
<p><img src="http://img.blog.csdn.net/20161202144012631" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br><a id="more"></a></p>
<h3 id="1-1-ActivityManagerService-startProcessLocked"><a href="#1-1-ActivityManagerService-startProcessLocked" class="headerlink" title="1.1 ActivityManagerService.startProcessLocked"></a>1.1 ActivityManagerService.startProcessLocked</h3><p><em>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</div><div class="line"><span class="comment">//...        </span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//...</span></div><div class="line">           <span class="keyword">int</span> uid = app.uid;</div><div class="line">           <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</div><div class="line">           <span class="comment">//...</span></div><div class="line">           app.gids = gids;</div><div class="line">           app.requiredAbi = requiredAbi;</div><div class="line">           app.instructionSet = instructionSet;</div><div class="line"></div><div class="line">           <span class="comment">// Start the process.  It will either succeed and return a result containing</span></div><div class="line">           <span class="comment">// the PID of the new process, or else throw a RuntimeException.</span></div><div class="line">           <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</div><div class="line">           <span class="comment">//Androidåº”ç”¨çš„è¿›ç¨‹å…¥å£android.app.ActivityThread</span></div><div class="line">           <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</div><div class="line">    <span class="comment">//å¯åŠ¨appè¿›ç¨‹</span></div><div class="line">           Process.ProcessStartResult startResult = Process.start(entryPoint,</div><div class="line">                   app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">                   app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</div><div class="line">                   app.info.dataDir, entryPointArgs);</div><div class="line">           <span class="comment">//...</span></div><div class="line">       &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">           <span class="comment">// XXX do better error recovery.</span></div><div class="line">           <span class="comment">//...</span></div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-2-Process-start"><a href="#1-2-Process-start" class="headerlink" title="1.2 Process.start"></a>1.2 Process.start</h3><p>è¿™ä¸€æ­¥ç›´æ¥äº¤ç»™ä¸‹ä¸€æ­¥æ¥å¤„ç†ã€‚</p>
<h3 id="1-3-Process-startViaZygote"><a href="#1-3-Process-startViaZygote" class="headerlink" title="1.3 Process.startViaZygote"></a>1.3 Process.startViaZygote</h3><p><em>frameworks/base/core/java/android/os/Process.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Starts a new process via the zygote mechanism.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> processClass Class name whose static main() to run</div><div class="line"> * <span class="doctag">@param</span> niceName 'nice' process name to appear in ps</div><div class="line"> * <span class="doctag">@param</span> uid a POSIX uid that the new process should setuid() to</div><div class="line"> * <span class="doctag">@param</span> gid a POSIX gid that the new process shuold setgid() to</div><div class="line"> * <span class="doctag">@param</span> gids null-ok; a list of supplementary group IDs that the</div><div class="line"> * new process should setgroup() to.</div><div class="line"> * <span class="doctag">@param</span> debugFlags Additional flags.</div><div class="line"> * <span class="doctag">@param</span> targetSdkVersion The target SDK version for the app.</div><div class="line"> * <span class="doctag">@param</span> seInfo null-ok SELinux information for the new process.</div><div class="line"> * <span class="doctag">@param</span> abi the ABI the process should use.</div><div class="line"> * <span class="doctag">@param</span> instructionSet null-ok the instruction set to use.</div><div class="line"> * <span class="doctag">@param</span> appDataDir null-ok the data directory of the app.</div><div class="line"> * <span class="doctag">@param</span> extraArgs Additional arguments to supply to the zygote process.</div><div class="line"> * <span class="doctag">@return</span> An object that describes the result of the attempt to start the process.</div><div class="line"> * <span class="doctag">@throws</span> ZygoteStartFailedEx if process start failed for any reason</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">startViaZygote</span><span class="params">(<span class="keyword">final</span> String processClass,</span></span></div><div class="line">                              <span class="keyword">final</span> String niceName,</div><div class="line">                              <span class="keyword">final</span> <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> gid,</div><div class="line">                              <span class="keyword">final</span> <span class="keyword">int</span>[] gids,</div><div class="line">                              <span class="keyword">int</span> debugFlags, <span class="keyword">int</span> mountExternal,</div><div class="line">                              <span class="keyword">int</span> targetSdkVersion,</div><div class="line">                              String seInfo,</div><div class="line">                              String abi,</div><div class="line">                              String instructionSet,</div><div class="line">                              String appDataDir,</div><div class="line">                              String[] extraArgs)</div><div class="line">                              <span class="keyword">throws</span> ZygoteStartFailedEx &#123;</div><div class="line">    <span class="keyword">synchronized</span>(Process.class) &#123;</div><div class="line">        ArrayList&lt;String&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">		</div><div class="line">        <span class="comment">//è®¾ç½®ä¸€äº›åŸºæœ¬å‚æ•°</span></div><div class="line">        <span class="comment">// --runtime-args, --setuid=, --setgid=,</span></div><div class="line">        <span class="comment">// and --setgroups= must go first</span></div><div class="line">        argsForZygote.add(<span class="string">"--runtime-args"</span>);</div><div class="line">        argsForZygote.add(<span class="string">"--setuid="</span> + uid);</div><div class="line">        argsForZygote.add(<span class="string">"--setgid="</span> + gid);</div><div class="line"> <span class="comment">//...</span></div><div class="line">        argsForZygote.add(<span class="string">"--target-sdk-version="</span> + targetSdkVersion);</div><div class="line"></div><div class="line">        <span class="comment">// --setgroups is a comma-separated list</span></div><div class="line">        <span class="keyword">if</span> (gids != <span class="keyword">null</span> &amp;&amp; gids.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">            sb.append(<span class="string">"--setgroups="</span>);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> sz = gids.length;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</div><div class="line">                    sb.append(<span class="string">','</span>);</div><div class="line">                &#125;</div><div class="line">                sb.append(gids[i]);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            argsForZygote.add(sb.toString());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (niceName != <span class="keyword">null</span>) &#123;</div><div class="line">            argsForZygote.add(<span class="string">"--nice-name="</span> + niceName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (seInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            argsForZygote.add(<span class="string">"--seinfo="</span> + seInfo);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (instructionSet != <span class="keyword">null</span>) &#123;</div><div class="line">            argsForZygote.add(<span class="string">"--instruction-set="</span> + instructionSet);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (appDataDir != <span class="keyword">null</span>) &#123;</div><div class="line">            argsForZygote.add(<span class="string">"--app-data-dir="</span> + appDataDir);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        argsForZygote.add(processClass);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (extraArgs != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (String arg : extraArgs) &#123;</div><div class="line">                argsForZygote.add(arg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//ç»§ç»­äº¤ç»™ä¸‹ä¸€æ­¥å¤„ç†ï¼Œè¿™é‡Œé€šè¿‡å‡½æ•°openZygoteSocketIfNeededå’ŒZygoteå»ºç«‹äº†è¿æ¥</span></div><div class="line">        <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å‡½æ•°openZygoteSocketIfNeededä¼šåœ¨zygoteåœ°å€ä¸Šå»ºç«‹ä¸€ä¸ªsocketè¿æ¥ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªinput streamå’Œoutput streamã€‚</p>
<h3 id="1-4-Process-zygoteSendArgsAndGetResult"><a href="#1-4-Process-zygoteSendArgsAndGetResult" class="headerlink" title="1.4 Process.zygoteSendArgsAndGetResult"></a>1.4 Process.zygoteSendArgsAndGetResult</h3><p><em>frameworks/base/core/java/android/os/Process.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Sends an argument list to the zygote process, which starts a new child</div><div class="line"> * and returns the child's pid. Please note: the present implementation</div><div class="line"> * replaces newlines in the argument list with spaces.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> ZygoteStartFailedEx if process start failed for any reason</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">(</span></span></div><div class="line">        ZygoteState zygoteState, ArrayList&lt;String&gt; args)</div><div class="line">        <span class="keyword">throws</span> ZygoteStartFailedEx &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * See com.android.internal.os.ZygoteInit.readArgumentList()</div><div class="line">         * Presently the wire format to the zygote process is:</div><div class="line">         * a) a count of arguments (argc, in essence)</div><div class="line">         * b) a number of newline-separated argument strings equal to count</div><div class="line">         *</div><div class="line">         * After the zygote process reads these it will write the pid of</div><div class="line">         * the child or -1 on failure, followed by boolean to</div><div class="line">         * indicate whether a wrapper process was used.</div><div class="line">         */</div><div class="line">        <span class="keyword">final</span> BufferedWriter writer = zygoteState.writer;</div><div class="line">        <span class="keyword">final</span> DataInputStream inputStream = zygoteState.inputStream;</div><div class="line"> <span class="comment">//ç›´æ¥ç”¨å·²ç»å»ºç«‹å¥½çš„input stream</span></div><div class="line">        writer.write(Integer.toString(args.size()));</div><div class="line">        writer.newLine();</div><div class="line">        <span class="comment">//ä¾æ¬¡å†™å…¥æ¯ä¸ªå‚æ•°</span></div><div class="line">        <span class="keyword">int</span> sz = args.size();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sz; i++) &#123;</div><div class="line">            String arg = args.get(i);</div><div class="line">            <span class="keyword">if</span> (arg.indexOf(<span class="string">'\n'</span>) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(</div><div class="line">                        <span class="string">"embedded newlines not allowed"</span>);</div><div class="line">            &#125;</div><div class="line">            writer.write(arg);</div><div class="line">            writer.newLine();</div><div class="line">        &#125;</div><div class="line">        writer.flush();</div><div class="line"> <span class="comment">//è·å–åˆ›å»ºè¿›ç¨‹çš„ç»“æœï¼Œå¦‚æœè¿›ç¨‹pidå°äº0ï¼Œåˆ™è¯´æ˜æ²¡æœ‰åˆ›å»ºæˆåŠŸ</span></div><div class="line">        <span class="comment">// Should there be a timeout on this?</span></div><div class="line">        ProcessStartResult result = <span class="keyword">new</span> ProcessStartResult();</div><div class="line">        result.pid = inputStream.readInt();</div><div class="line">        <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(<span class="string">"fork() failed"</span>);</div><div class="line">        &#125;</div><div class="line">        result.usingWrapper = inputStream.readBoolean();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">        zygoteState.close();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteStartFailedEx(ex);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###1.5 ZygoteInit.runSelectLoop<br>ActivityManagerServiceé€šè¿‡socketå°†å‚æ•°ä¼ é€’ç»™zygoteè¿›ç¨‹åï¼Œåˆ›å»ºappè¿›ç¨‹çš„ä»»åŠ¡å°±äº¤ç»™zygoteç»§ç»­å®ç°äº†ã€‚è®©æˆ‘ä»¬å†æ¬¡å›åˆ°zygoteçš„å¾ªç¯ä¸­ã€‚</p>
<p><em>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</em> ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</div><div class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</div><div class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</div><div class="line"></div><div class="line">    fds.add(sServerSocket.getFileDescriptor());</div><div class="line">    peers.add(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</div><div class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</div><div class="line">            pollFds[i].fd = fds.get(i);</div><div class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Os.poll(pollFds, -<span class="number">1</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">//ActivityManagerServiceå’Œæˆ‘å»ºç«‹è¿æ¥</span></div><div class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                peers.add(newPeer);</div><div class="line">                fds.add(newPeer.getFileDesciptor());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//å¤„ç†ActivityManagerServiceå‘é€çš„è¯·æ±‚</span></div><div class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();</div><div class="line">                <span class="keyword">if</span> (done) &#123;</div><div class="line">                    peers.remove(i);</div><div class="line">                    fds.remove(i);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-6-ZygoteConnection-runOnce"><a href="#1-6-ZygoteConnection-runOnce" class="headerlink" title="1.6 ZygoteConnection.runOnce"></a>1.6 ZygoteConnection.runOnce</h3><p><em>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Reads one start command from the command socket. If successful,</div><div class="line"> * a child is forked and a &#123;<span class="doctag">@link</span> ZygoteInit.MethodAndArgsCaller&#125;</div><div class="line"> * exception is thrown in that child while in the parent process,</div><div class="line"> * the method returns normally. On failure, the child is not</div><div class="line"> * spawned and messages are printed to the log and stderr. Returns</div><div class="line"> * a boolean status value indicating whether an end-of-file on the command</div><div class="line"> * socket has been encountered.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> false if command socket should continue to be read from, or</div><div class="line"> * true if an end-of-file has been encountered.</div><div class="line"> * <span class="doctag">@throws</span> ZygoteInit.MethodAndArgsCaller trampoline to invoke main()</div><div class="line"> * method in child process</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</div><div class="line"></div><div class="line">    String args[];</div><div class="line">    Arguments parsedArgs = <span class="keyword">null</span>;</div><div class="line">    FileDescriptor[] descriptors;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"> <span class="comment">//è¯»å–ä¼ å…¥çš„å‚æ•°</span></div><div class="line">        args = readArgumentList();</div><div class="line">        descriptors = mSocket.getAncillaryFileDescriptors();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">      <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// EOF reached.</span></div><div class="line">        closeSocket();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** the stderr of the most recent request, if avail */</span></div><div class="line">    PrintStream newStderr = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (descriptors != <span class="keyword">null</span> &amp;&amp; descriptors.length &gt;= <span class="number">3</span>) &#123;</div><div class="line">        newStderr = <span class="keyword">new</span> PrintStream(</div><div class="line">                <span class="keyword">new</span> FileOutputStream(descriptors[<span class="number">2</span>]));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pid = -<span class="number">1</span>;</div><div class="line">    FileDescriptor childPipeFd = <span class="keyword">null</span>;</div><div class="line">    FileDescriptor serverPipeFd = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//...</span></div><div class="line">        <span class="comment">//forkä¸€ä¸ªè¿›ç¨‹</span></div><div class="line">        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</div><div class="line">                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</div><div class="line">                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</div><div class="line">                parsedArgs.appDataDir);</div><div class="line">    &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">     <span class="comment">//...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// in child</span></div><div class="line">            IoUtils.closeQuietly(serverPipeFd);</div><div class="line">            serverPipeFd = <span class="keyword">null</span>;</div><div class="line">            <span class="comment">//åœ¨å­è¿›ç¨‹ä¸­è¿›ä¸€æ­¥å¤„ç†</span></div><div class="line">            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</div><div class="line">            <span class="comment">// should never get here, the child is expected to either</span></div><div class="line">            <span class="comment">// throw ZygoteInit.MethodAndArgsCaller or exec().</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// in parent...pid of &lt; 0 means failure</span></div><div class="line">            IoUtils.closeQuietly(childPipeFd);</div><div class="line">            childPipeFd = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        IoUtils.closeQuietly(childPipeFd);</div><div class="line">        IoUtils.closeQuietly(serverPipeFd);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-7-ZygoteConnection-handleChildProc"><a href="#1-7-ZygoteConnection-handleChildProc" class="headerlink" title="1.7 ZygoteConnection.handleChildProc"></a>1.7 ZygoteConnection.handleChildProc</h3><p><em>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Handles post-fork setup of child proc, closing sockets as appropriate,</div><div class="line">    * reopen stdio as appropriate, and ultimately throwing MethodAndArgsCaller</div><div class="line">    * if successful or returning if failed.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> parsedArgs non-null; zygote args</div><div class="line">    * <span class="doctag">@param</span> descriptors null-ok; new file descriptors for stdio if available.</div><div class="line">    * <span class="doctag">@param</span> pipeFd null-ok; pipe for communication back to Zygote.</div><div class="line">    * <span class="doctag">@param</span> newStderr null-ok; stream to use for stderr until stdio</div><div class="line">    * is reopened.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@throws</span> ZygoteInit.MethodAndArgsCaller on success to</div><div class="line">    * trampoline to code that invokes static main.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleChildProc</span><span class="params">(Arguments parsedArgs,</span></span></div><div class="line">           FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream newStderr)</div><div class="line">           <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * By the time we get here, the native code has closed the two actual Zygote</div><div class="line">        * socket connections, and substituted /dev/null in their place.  The LocalSocket</div><div class="line">        * objects still need to be closed properly.</div><div class="line">        */</div><div class="line"></div><div class="line">       closeSocket();</div><div class="line">       ZygoteInit.closeServerSocket();</div><div class="line"></div><div class="line">       </div><div class="line"></div><div class="line">       <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</div><div class="line">           Process.setArgV0(parsedArgs.niceName);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// End of the postFork event.</span></div><div class="line"><span class="comment">//...</span></div><div class="line">       <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">           WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                   parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                   VMRuntime.getCurrentInstructionSet(),</div><div class="line">                   pipeFd, parsedArgs.remainingArgs);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//ç»§ç»­åˆå§‹åŒ–è¿›ç¨‹</span></div><div class="line">           RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,</div><div class="line">                   parsedArgs.remainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-8-RuntimeInit-zygoteInit"><a href="#1-8-RuntimeInit-zygoteInit" class="headerlink" title="1.8 RuntimeInit.zygoteInit"></a>1.8 RuntimeInit.zygoteInit</h3><p>è¿™é‡Œå¼€å§‹è°ƒç”¨android.app.ActivityThreadçš„mainå‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</div><div class="line"></div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</div><div class="line">    redirectLogStreams();</div><div class="line"></div><div class="line">    commonInit();</div><div class="line">    <span class="comment">//å¯åŠ¨Binderçº¿ç¨‹æ± ï¼Œå°†åœ¨ä¸‹é¢è¯¦ç»†åˆ†ænativeéƒ¨åˆ†</span></div><div class="line">    nativeZygoteInit();</div><div class="line">    <span class="comment">//è¿™é‡Œè°ƒç”¨çš„ä¸å†æ˜¯systemçš„mainå‡½æ•°äº†ï¼Œè€Œæ˜¯ActivityThreadçš„mainå‡½æ•°ï¼Œå°†åœ¨ä¸‹é¢ç« èŠ‚åˆ†æ</span></div><div class="line">    applicationInit(targetSdkVersion, argv, classLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>åˆ°è¿™é‡Œä¸€ä¸ªAndroid appçš„è¿›ç¨‹å°±å·²ç»åˆ›å»ºå¥½äº†ã€‚</p>
<h2 id="2-Binderçº¿ç¨‹æ± çš„å¯åŠ¨"><a href="#2-Binderçº¿ç¨‹æ± çš„å¯åŠ¨" class="headerlink" title="2. Binderçº¿ç¨‹æ± çš„å¯åŠ¨"></a>2. Binderçº¿ç¨‹æ± çš„å¯åŠ¨</h2><p>Appè¿›ç¨‹åˆ›å»ºè¿‡ç¨‹ä¸­ä¼šå»ºç«‹ä¸€ä¸ªBinderçº¿ç¨‹æ± ï¼Œç”¨æ¥å¤„ç†è¿›ç¨‹é—´çš„Binderé€šä¿¡ã€‚</p>
<p><img src="http://img.blog.csdn.net/20161202144038070" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="2-1-RuntimeInit-nativeZygoteInit"><a href="#2-1-RuntimeInit-nativeZygoteInit" class="headerlink" title="2.1 RuntimeInit.nativeZygoteInit"></a>2.1 RuntimeInit.nativeZygoteInit</h3><p><em>frameworks/base/core/jni/AndroidRuntime.cpp</em> :</p>
<p>è¿™é‡Œç›´æ¥è°ƒç”¨äº†ä¸€ä¸ªAndroidRuntimeå…¨å±€å¯¹è±¡gCurRuntimeçš„onZygoteInitå‡½æ•°ã€‚è¿™ä¸ªå…¨å±€å¯¹è±¡æ˜¯åœ¨zygoteè¿›ç¨‹ä¸­åˆ›å»ºäº†ï¼Œè¿™é‡Œæ˜¯é€šè¿‡å¤åˆ¶zygoteçš„è¿›ç¨‹è·å¾—çš„è¯¥å¯¹è±¡ã€‚</p>
<h3 id="2-2-AppRuntime-onZygoteInit"><a href="#2-2-AppRuntime-onZygoteInit" class="headerlink" title="2.2 AppRuntime.onZygoteInit"></a>2.2 AppRuntime.onZygoteInit</h3><p><em>frameworks/base/cmds/app_main.cpp</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">virtual <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></div><div class="line">  &#123;</div><div class="line">      sp&lt;ProcessState&gt; proc = ProcessState::self();</div><div class="line">      ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</div><div class="line">      proc-&gt;startThreadPool();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-3-ProcessState-startThreadPool"><a href="#2-3-ProcessState-startThreadPool" class="headerlink" title="2.3 ProcessState.startThreadPool"></a>2.3 ProcessState.startThreadPool</h3><p>å¯åŠ¨Binderçº¿ç¨‹æ± çº¿ç¨‹ï¼Œ appè¿›ç¨‹ä»è€Œå…·æœ‰è¿›ç¨‹é—´binderé€šä¿¡çš„èƒ½åŠ›ã€‚<br><em>frameworks/native/libs/binder/PorcessState.cpp</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> ProcessState::startThreadPool()</div><div class="line">&#123;</div><div class="line">    <span class="function">AutoMutex <span class="title">_l</span><span class="params">(mLock)</span></span>;</div><div class="line">    <span class="keyword">if</span> (!mThreadPoolStarted) &#123;</div><div class="line">        mThreadPoolStarted = <span class="keyword">true</span>;</div><div class="line">        <span class="comment">//å¯åŠ¨ä¸€ä¸ªBinderçº¿ç¨‹æ± çš„çº¿ç¨‹ï¼Œä»è€Œå¯ä»¥æ”¯æŒBinderè¿›ç¨‹é—´é€šä¿¡äº†</span></div><div class="line">        spawnPooledThread(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="3-Appè¿›ç¨‹æ¶ˆæ¯å¾ªç¯çš„åˆ›å»º"><a href="#3-Appè¿›ç¨‹æ¶ˆæ¯å¾ªç¯çš„åˆ›å»º" class="headerlink" title="3. Appè¿›ç¨‹æ¶ˆæ¯å¾ªç¯çš„åˆ›å»º"></a>3. Appè¿›ç¨‹æ¶ˆæ¯å¾ªç¯çš„åˆ›å»º</h2><p>åœ¨1.8ä¸­ï¼ŒRuntimeInitè°ƒç”¨å‡½æ•°applicationInitæ¥å¯åŠ¨ActivityThreadçš„mainå‡½æ•°ã€‚<br><img src="http://img.blog.csdn.net/20161202144053195" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="3-1-RuntimeInit-applicationInit"><a href="#3-1-RuntimeInit-applicationInit" class="headerlink" title="3.1 RuntimeInit.applicationInit"></a>3.1 RuntimeInit.applicationInit</h3><p>è®¾ç½®äº†heapçš„ç›®æ ‡ä½¿ç”¨ç‡ï¼Œç„¶åè°ƒç”¨äº†ä¸‹ä¸€æ­¥çš„é™æ€å‡½æ•°ã€‚</p>
<h3 id="3-2-RuntimeInit-invokeStaticMain"><a href="#3-2-RuntimeInit-invokeStaticMain" class="headerlink" title="3.2 RuntimeInit.invokeStaticMain"></a>3.2 RuntimeInit.invokeStaticMain</h3><p>è¿™ä¸€æ­¥ç»ˆäºå¼€å§‹ä»è¿™ä¸ªåˆ›å»ºçš„æ–°è¿›ç¨‹ä¸­è°ƒç”¨ActivityThreadçš„mainå‡½æ•°äº†ã€‚ä¸è¿‡è°ƒç”¨çš„æ–¹å¼æœ‰ç‚¹å¥‡æ€ªï¼Œè¿™é‡Œæ˜¯é€šè¿‡æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸çš„å½¢å¼ï¼Œæ¥æ¸…ç©ºå½“å‰æ ˆä¸­çš„ç§¯å‹çš„å‡½æ•°ï¼Œç›´åˆ°å›é€€åˆ°ZygoteInit.mainå‡½æ•°ä¸­ã€‚å› ä¸ºè¯¥appè¿›ç¨‹æ˜¯ä»zygoteè¿›ç¨‹ä¸­forkå‡ºæ¥çš„ï¼Œæ‰€ä»¥æ ˆçš„å†…å®¹ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å¯ä»¥ä¼šé€€åˆ°ZygoteInit.mainå‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Invokes a static "main(argv[]) method on class "className".</div><div class="line">    * Converts various failing exceptions into RuntimeExceptions, with</div><div class="line">    * the assumption that they will then cause the VM instance to exit.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> className Fully-qualified class name</div><div class="line">    * <span class="doctag">@param</span> argv Argument vector for main()</div><div class="line">    * <span class="doctag">@param</span> classLoader the classLoader to load &#123;<span class="doctag">@className</span>&#125; with</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">           <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">       Class&lt;?&gt; cl;</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">//é€šè¿‡ç±»ååŠ è½½è¯¥ç±»ï¼Œè¿™é‡Œå°±æ˜¯ActivityThreadç±»</span></div><div class="line">           cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</div><div class="line">       &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">         <span class="comment">//...</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Method m;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//è·å¾—ActivityThreadçš„mainæ–¹æ³•</span></div><div class="line">           m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</div><div class="line">       &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</div><div class="line">          <span class="comment">//...</span></div><div class="line">       &#125;</div><div class="line"><span class="comment">//...</span></div><div class="line">       <span class="comment">/*</span></div><div class="line">        * This throw gets caught in ZygoteInit.main(), which responds</div><div class="line">        * by invoking the exception's run() method. This arrangement</div><div class="line">        * clears up all the stack frames that were required in setting</div><div class="line">        * up the process.</div><div class="line">        * è¿™é‡Œé€šè¿‡æŠ›å‡ºå¼‚å¸¸æ¥å›åˆ°stackä¸­çš„æŸä¸€ä¸ªå‡½æ•°çš„åšæ³•è¿˜çœŸæ˜¯å¤´ä¸€æ¬¡è§</div><div class="line">        */</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-3-ZygoteInit-main"><a href="#3-3-ZygoteInit-main" class="headerlink" title="3.3 ZygoteInit.main"></a>3.3 ZygoteInit.main</h3><p>åœ¨Zygoteè¿›ç¨‹é‡Œï¼Œä¼šè¿›å…¥æ— é™çš„å¾ªç¯ã€‚ä½†æ˜¯ï¼Œåœ¨appè¿›ç¨‹é‡Œï¼Œè¿›å…¥è¿™ä¸ªå¾ªç¯æ˜¯æ²¡æœ‰ä½œç”¨ï¼Œæ‰€ä»¥éœ€è¦è·³å‡ºå¾ªç¯ï¼Œç»§ç»­å‰è¿›ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//...</span></div><div class="line">        Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</div><div class="line">        <span class="comment">//Zygoteè¿›ç¨‹ä¼šä¸€ç›´åœ¨å¾ªç¯ä¸­</span></div><div class="line">        <span class="comment">//è™½ç„¶appè¿›ç¨‹åœ¨è¿™ä¸ªå¾ªç¯é‡Œåˆ›å»ºï¼Œä½†æ˜¯å®ƒéœ€è¦è·³å‡ºè¿™ä¸ªå¾ªç¯ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ</span></div><div class="line">        runSelectLoop(abiList);</div><div class="line"></div><div class="line">        closeServerSocket();</div><div class="line">    &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</div><div class="line">        <span class="comment">//æ‰€ä»¥appè¿›ç¨‹å°±è·³åˆ°äº†è¿™é‡Œ</span></div><div class="line">        caller.run();</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">        Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</div><div class="line">        closeServerSocket();</div><div class="line">        <span class="keyword">throw</span> ex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-4-MethodAndArgsCaller-run"><a href="#3-4-MethodAndArgsCaller-run" class="headerlink" title="3.4 MethodAndArgsCaller.run"></a>3.4 MethodAndArgsCaller.run</h3><p>è¿™é‡Œå°±æ˜¯å›åˆ°ZygoteInit.mainé‡Œè°ƒç”¨ActivityThreadçš„mainå‡½æ•°ï¼Œç›®çš„å°±æ˜¯æ¸…ç†å‡†å¤‡appè¿›ç¨‹ä¸­å½¢æˆçš„è°ƒç”¨å †æ ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         <span class="comment">//å°±æ˜¯è°ƒç”¨äº†ActivityThreadçš„mainå‡½æ•°</span></div><div class="line">         mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</div><div class="line">     &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">      <span class="comment">//...</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ActivityThread-main"><a href="#ActivityThread-main" class="headerlink" title="ActivityThread.main"></a>ActivityThread.main</h3><p>è¿™é‡Œå°±æ˜¯å›åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„å‰§æƒ…äº†ï¼Œä¸å†èµ˜è¿°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è‡ªå·±å¼€å¿ƒå°±å¥½ï¼Œä½•å¿…ç®¡ä»–äººçƒ¦æ¼&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;1-åº”ç”¨è¿›ç¨‹åˆ›å»º&quot;&gt;&lt;a href=&quot;#1-åº”ç”¨è¿›ç¨‹åˆ›å»º&quot; class=&quot;headerlink&quot; title=&quot;1. åº”ç”¨è¿›ç¨‹åˆ›å»º&quot;&gt;&lt;/a&gt;1. åº”ç”¨è¿›ç¨‹åˆ›å»º&lt;/h2&gt;&lt;p&gt;ActivityManagerServiceè´Ÿè´£ç®¡ç†åº”ç”¨è¿›ç¨‹çš„åˆ›å»ºã€‚è¿™ä¸€èŠ‚ä¼šè®²è¿°å¦‚ä½•ä»ActivityManagerServiceç”³è¯·åˆ›å»ºä¸€ä¸ªappè¿›ç¨‹ï¼Œç„¶åä»zygoteå…‹éš†ä¸€ä¸ªè¿›ç¨‹çš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20161202144012631&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(14):Zygoteå’ŒSystemè¿›ç¨‹çš„å¯åŠ¨</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-14-Zygote%E5%92%8CSystem%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%90%AF%E5%8A%A8/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-14-Zygoteå’ŒSystemè¿›ç¨‹çš„å¯åŠ¨/</id>
    <published>2017-02-14T06:33:16.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>å†ä¸å­¦ä¹ æˆ‘ä»¬å°±è€äº†</p>
</blockquote>
<h2 id="0-Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ"><a href="#0-Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ" class="headerlink" title="0. Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ"></a>0. Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ</h2><p>Zygoteæ˜¯è¿›ç¨‹å­µåŒ–å™¨ï¼ŒAndroidç³»ç»Ÿä¸­å…¶ä»–æœåŠ¡è¿›ç¨‹éƒ½æ˜¯æ‹·è´äºå®ƒã€‚Zygoteåœ¨è®¾è®¡æ¨¡å¼ä¸­å¯¹åº”äº<code>prototype</code>ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥é€šè¿‡æ‹·è´Zygoteæ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚</p>
<h2 id="1-Zygoteè„šæœ¬å¯åŠ¨"><a href="#1-Zygoteè„šæœ¬å¯åŠ¨" class="headerlink" title="1. Zygoteè„šæœ¬å¯åŠ¨"></a>1. Zygoteè„šæœ¬å¯åŠ¨</h2><p>åœ¨å¼€æœºæ—¶ï¼Œinitè¿›ç¨‹ä¼šè°ƒç”¨å¦‚ä¸‹è„šæœ¬å¯åŠ¨è¿›ç¨‹ã€‚</p>
<p><em>system/core/rootdir/init.zygote32_64.rc</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">service zygote /system/bin/app_process32 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></div><div class="line">    <span class="title">socket</span> <span class="title">zygote</span> <span class="title">stream</span> 660 <span class="title">root</span> <span class="title">system</span></div><div class="line">    <span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">android_power</span>/<span class="title">request_state</span> <span class="title">wake</span></div><div class="line">    <span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">power</span>/<span class="title">state</span> <span class="title">on</span></div><div class="line">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">media</span></div><div class="line">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">netd</span></div><div class="line">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">foreground</span>/<span class="title">tasks</span></div></pre></td></tr></table></figure></p>
<p><code>service</code>è¡¨æ˜è¯¥è¿›ç¨‹æ˜¯ä½œä¸ºä¸€ä¸ªæœåŠ¡æ¥å¯åŠ¨çš„ï¼Œ<code>--start-system-server</code>æŒ‡æ˜äº†è¯¥è¿›ç¨‹å¯åŠ¨åï¼Œéœ€è¦å¯åŠ¨systemæœåŠ¡ã€‚è¯¥è¿›ç¨‹å¯¹åº”çš„ç«¯å£æƒé™660ï¼Œåå­—ä¸ºzygoteï¼Œå…¶å®ƒè¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥ç«¯å£å’Œå®ƒè¿›è¡Œé€šä¿¡ã€‚</p>
<a id="more"></a>
<h3 id="1-1-initè¿›ç¨‹åˆ›å»ºæ–°çš„app-process"><a href="#1-1-initè¿›ç¨‹åˆ›å»ºæ–°çš„app-process" class="headerlink" title="1.1 initè¿›ç¨‹åˆ›å»ºæ–°çš„app_process"></a>1.1 initè¿›ç¨‹åˆ›å»ºæ–°çš„app_process</h3><p>åœ¨initè¿›ç¨‹ä¸­ï¼Œå¯åŠ¨serviceè¿›ç¨‹çš„è¿‡ç¨‹å¦‚ä¸‹ã€‚</p>
<p><em>system/core/init/init.cpp</em> :<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">service_start</span><span class="params">(<span class="keyword">struct</span> service *svc, <span class="keyword">const</span> <span class="keyword">char</span> *dynamic_args)</span></span></div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="title">NOTICE</span><span class="params">(<span class="string">"Starting service '%s'...\n"</span>, svc-&gt;name)</span>;</div><div class="line">    <span class="comment">//åˆ›å»ºæ–°è¿›ç¨‹</span></div><div class="line">    <span class="keyword">pid_t</span> pid = fork();</div><div class="line">    <span class="comment">//åœ¨æ–°å»ºçš„è¿›ç¨‹ä¸­</span></div><div class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">struct</span> socketinfo *si;</div><div class="line">        <span class="keyword">struct</span> svcenvinfo *ei;</div><div class="line">        <span class="keyword">char</span> tmp[<span class="number">32</span>];</div><div class="line">        <span class="keyword">int</span> fd, sz;</div><div class="line">        <span class="comment">//ä¾æ¬¡åˆ›å»ºserviceä¸­çš„socket</span></div><div class="line">        <span class="keyword">for</span> (si = svc-&gt;sockets; si; si = si-&gt;next) &#123;</div><div class="line">            <span class="keyword">int</span> socket_type = (</div><div class="line">                    !<span class="built_in">strcmp</span>(si-&gt;type, <span class="string">"stream"</span>) ? SOCK_STREAM :</div><div class="line">                        (!<span class="built_in">strcmp</span>(si-&gt;type, <span class="string">"dgram"</span>) ? SOCK_DGRAM : SOCK_SEQPACKET));</div><div class="line">            <span class="comment">//åˆ›å»ºsocket</span></div><div class="line">            <span class="keyword">int</span> s = create_socket(si-&gt;name, socket_type,</div><div class="line">                                  si-&gt;perm, si-&gt;uid, si-&gt;gid, si-&gt;socketcon ?: scon);</div><div class="line">            <span class="keyword">if</span> (s &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">//å‘å¸ƒsocket</span></div><div class="line">                publish_socket(si-&gt;name, s);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line">	<span class="comment">//å°†å‚æ•°æ‹·è´è¿›svcç»“æ„ä½“ä¸­</span></div><div class="line">        <span class="keyword">if</span> (!dynamic_args) &#123;</div><div class="line">            <span class="comment">//æ²¡æœ‰å‚æ•°çš„æƒ…å†µ</span></div><div class="line">            <span class="comment">//svc-&gt;args[0]å¯¹åº”äº/system/bin/app_process32</span></div><div class="line">            <span class="comment">//ä¸‹ä¸€æ­¥ä¼šåŠ è½½è¯¥ç¨‹åºï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°</span></div><div class="line">            <span class="keyword">if</span> (execve(svc-&gt;args[<span class="number">0</span>], (<span class="keyword">char</span>**) svc-&gt;args, (<span class="keyword">char</span>**) ENV) &lt; <span class="number">0</span>) &#123;</div><div class="line">                ERROR(<span class="string">"cannot execve('%s'): %s\n"</span>, svc-&gt;args[<span class="number">0</span>], strerror(errno));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">char</span> *arg_ptrs[INIT_PARSER_MAXARGS+<span class="number">1</span>];</div><div class="line">            <span class="keyword">int</span> arg_idx = svc-&gt;nargs;</div><div class="line">            <span class="keyword">char</span> *tmp = strdup(dynamic_args);</div><div class="line">            <span class="keyword">char</span> *next = tmp;</div><div class="line">            <span class="keyword">char</span> *bword;</div><div class="line"></div><div class="line">            <span class="comment">/* Copy the static arguments */</span></div><div class="line">            <span class="built_in">memcpy</span>(arg_ptrs, svc-&gt;args, (svc-&gt;nargs * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *)));</div><div class="line"></div><div class="line">            <span class="keyword">while</span>((bword = strsep(&amp;next, <span class="string">" "</span>))) &#123;</div><div class="line">                arg_ptrs[arg_idx++] = bword;</div><div class="line">                <span class="keyword">if</span> (arg_idx == INIT_PARSER_MAXARGS)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            arg_ptrs[arg_idx] = <span class="literal">NULL</span>;</div><div class="line">            execve(svc-&gt;args[<span class="number">0</span>], (<span class="keyword">char</span>**) arg_ptrs, (<span class="keyword">char</span>**) ENV);</div><div class="line">        &#125;</div><div class="line">        _exit(<span class="number">127</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-2-socketåˆ›å»ºå’Œå‘å¸ƒ"><a href="#1-2-socketåˆ›å»ºå’Œå‘å¸ƒ" class="headerlink" title="1.2 socketåˆ›å»ºå’Œå‘å¸ƒ"></a>1.2 socketåˆ›å»ºå’Œå‘å¸ƒ</h3><p>ä¸‹é¢ä¸»è¦åˆ†æä¸€ä¸‹<code>create_socket</code>å’Œ<code>publish_socket</code>ä¸¤ä¸ªå‡½æ•°ï¼Œæ¥è¯´æ˜zygoteçš„socketå¦‚ä½•åˆ›å»ºçš„ã€‚</p>
<p>åˆ›å»ºsocketã€‚<br><em>system/core/init/util.cpp</em> :<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * create_socket - creates a Unix domain socket in ANDROID_SOCKET_DIR</div><div class="line"> * ("/dev/socket") as dictated in init.rc. This socket is inherited by the</div><div class="line"> * daemon. We communicate the file descriptor's value via the environment</div><div class="line"> * variable ANDROID_SOCKET_ENV_PREFIX&lt;name&gt; ("ANDROID_SOCKET_foo").</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> type, <span class="keyword">mode_t</span> perm, <span class="keyword">uid_t</span> uid,</span></span></div><div class="line">                  <span class="keyword">gid_t</span> gid, <span class="keyword">const</span> <span class="keyword">char</span> *socketcon)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> sockaddr_un addr;</div><div class="line">    <span class="keyword">int</span> fd, ret;</div><div class="line">    <span class="keyword">char</span> *filecon;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (socketcon)</div><div class="line">        setsockcreatecon(socketcon);</div><div class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªsocket</span></div><div class="line">    fd = socket(PF_UNIX, type, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to open socket '%s': %s\n"</span>, name, strerror(errno));</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (socketcon)</div><div class="line">        setsockcreatecon(<span class="literal">NULL</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªsocketåœ°å€addr</span></div><div class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span> , <span class="keyword">sizeof</span>(addr));</div><div class="line">    addr.sun_family = AF_UNIX;</div><div class="line">    <span class="comment">//è®¾ç½®åœ°å€çš„æ–‡ä»¶ä½ç½®ï¼Œè¿™é‡Œå°±æ˜¯/dev/socket/zygote</span></div><div class="line">    <span class="built_in">snprintf</span>(addr.sun_path, <span class="keyword">sizeof</span>(addr.sun_path), ANDROID_SOCKET_DI<span class="string">R"/%s"</span>,</div><div class="line">             name);</div><div class="line"></div><div class="line">    ret = unlink(addr.sun_path);</div><div class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span> &amp;&amp; errno != ENOENT) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to unlink old socket '%s': %s\n"</span>, name, strerror(errno));</div><div class="line">        <span class="keyword">goto</span> out_close;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    filecon = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (sehandle) &#123;</div><div class="line">        ret = selabel_lookup(sehandle, &amp;filecon, addr.sun_path, S_IFSOCK);</div><div class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>)</div><div class="line">            setfscreatecon(filecon);</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="comment">//å°†æƒ³è¦å­˜å‚¨socketçš„æ–‡ä»¶åœ°å€addrå’Œsocketæ–‡ä»¶æè¿°ç¬¦fdç»‘å®šèµ·æ¥</span></div><div class="line">    ret = bind(fd, (<span class="keyword">struct</span> sockaddr *) &amp;addr, <span class="keyword">sizeof</span> (addr));</div><div class="line">    <span class="keyword">if</span> (ret) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to bind socket '%s': %s\n"</span>, name, strerror(errno));</div><div class="line">        <span class="keyword">goto</span> out_unlink;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setfscreatecon(<span class="literal">NULL</span>);</div><div class="line">    freecon(filecon);</div><div class="line"></div><div class="line">    <span class="comment">//è®¾ç½®ç”¨æˆ·ç»„root system</span></div><div class="line">    chown(addr.sun_path, uid, gid);</div><div class="line">    <span class="comment">//è®¾ç½®æƒé™660</span></div><div class="line">    chmod(addr.sun_path, perm);</div><div class="line"></div><div class="line">    INFO(<span class="string">"Created socket '%s' with mode '%o', user '%d', group '%d'\n"</span>,</div><div class="line">         addr.sun_path, perm, uid, gid);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> fd;</div><div class="line"></div><div class="line">out_unlink:</div><div class="line">    unlink(addr.sun_path);</div><div class="line">out_close:</div><div class="line">    close(fd);</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å‘å¸ƒsocketã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publish_socket</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> fd)</span></span></div><div class="line">&#123;    </div><div class="line">    <span class="comment">//å‰ç¼€ä¸ºANDROID_SOCKET_</span></div><div class="line">    <span class="keyword">char</span> key[<span class="number">64</span>] = ANDROID_SOCKET_ENV_PREFIX;</div><div class="line">    <span class="keyword">char</span> val[<span class="number">64</span>];</div><div class="line">    <span class="comment">//æ‹¼æ¥å‡ºkey</span></div><div class="line">    strlcpy(key + <span class="keyword">sizeof</span>(ANDROID_SOCKET_ENV_PREFIX) - <span class="number">1</span>,</div><div class="line">            name,</div><div class="line">            <span class="keyword">sizeof</span>(key) - <span class="keyword">sizeof</span>(ANDROID_SOCKET_ENV_PREFIX));</div><div class="line">    <span class="comment">//å°†fdå†™å…¥val</span></div><div class="line">    <span class="built_in">snprintf</span>(val, <span class="keyword">sizeof</span>(val), <span class="string">"%d"</span>, fd);</div><div class="line">    <span class="comment">//å°†keyï¼Œvalueå†™å…¥ç¯å¢ƒå˜é‡ä¸­ï¼Œä»¥ä¾¿å…¶ä»–è¿›ç¨‹è®¿é—®</span></div><div class="line">    add_environment(key, val);</div><div class="line"></div><div class="line">    <span class="comment">/* make sure we don't close-on-exec */</span></div><div class="line">    fcntl(fd, F_SETFD, <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="2-Zygoteè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹"><a href="#2-Zygoteè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="2. Zygoteè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹"></a>2. Zygoteè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹</h2><p>Zygote è¿›ç¨‹çš„å¯åŠ¨ä»app_processçš„mainå‡½æ•°å¼€å§‹ã€‚</p>
<p><img src="http://img.blog.csdn.net/20161129224041801" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="2-1-app-process-main"><a href="#2-1-app-process-main" class="headerlink" title="2.1 app_process.main"></a>2.1 app_process.main</h3><p>åˆ¤æ–­éœ€è¦å¯åŠ¨çš„è¿›ç¨‹çš„ç§ç±»ã€‚</p>
<p><em>frameworks/base/cmds/app_process/app_main.cpp</em> :<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">int main(int argc, char* const argv[])</div><div class="line">&#123;</div><div class="line">    //é’ˆå¯¹æ—§å†…æ ¸åšçš„å¤„ç†...</div><div class="line"></div><div class="line">    //åˆ›å»ºAppRuntimeå¯¹è±¡</div><div class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</div><div class="line">    // Process command line arguments</div><div class="line">    // ignore argv[0]</div><div class="line">    argc--;</div><div class="line">    argv++;</div><div class="line"></div><div class="line">    // Everything up to '--' or first non '-' arg goes to the vm.</div><div class="line">    //</div><div class="line">    // The first argument after the VM args is the "parent dir", which</div><div class="line">    // is currently unused.</div><div class="line">    //</div><div class="line">    // After the parent dir, we expect one or more the following internal</div><div class="line">    // arguments :</div><div class="line">    // ä¸åŒçš„è¿›ç¨‹ç±»å‹</div><div class="line">    // --zygote : Start in zygote mode</div><div class="line">    // --start-system-server : Start the system server.</div><div class="line">    // --application : Start in application (stand alone, non zygote) mode.</div><div class="line">    // --nice-name : The nice name for this process.</div><div class="line">    //</div><div class="line">    // For non zygote starts, these arguments will be followed by</div><div class="line">    // the main class name. All remaining arguments are passed to</div><div class="line">    // the main method of this class.</div><div class="line">    //</div><div class="line">    // For zygote starts, all remaining arguments are passed to the zygote.</div><div class="line">    // main function.</div><div class="line">    //</div><div class="line">    // Note that we must copy argument string values since we will rewrite the</div><div class="line">    // entire argument block when we apply the nice name to argv0.</div><div class="line"></div><div class="line">    int i;</div><div class="line">    for (i = 0; i &lt; argc; i++) &#123;</div><div class="line">        if (argv[i][0] != '-') &#123;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        if (argv[i][1] == '-' &amp;&amp; argv[i][2] == 0) &#123;</div><div class="line">            ++i; // Skip --.</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        runtime.addOption(strdup(argv[i]));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Parse runtime arguments.  Stop at first unrecognized option.</div><div class="line">    bool zygote = false;</div><div class="line">    bool startSystemServer = false;</div><div class="line">    bool application = false;</div><div class="line">    String8 niceName;</div><div class="line">    String8 className;</div><div class="line">   </div><div class="line">    //åˆ¤æ–­éœ€è¦åˆ›å»ºä½•ç§ç±»å‹çš„è¿›ç¨‹</div><div class="line">    ++i;  // Skip unused "parent dir" argument.</div><div class="line">    while (i &lt; argc) &#123;</div><div class="line">        const char* arg = argv[i++];</div><div class="line">        if (strcmp(arg, "--zygote") == 0) &#123;</div><div class="line">	    //è¿™é‡Œæ˜¯Zygoteè¿›ç¨‹</div><div class="line">            zygote = true;</div><div class="line">            niceName = ZYGOTE_NICE_NAME;</div><div class="line">        &#125; else if (strcmp(arg, "--start-system-server") == 0) &#123;</div><div class="line">            //åŒæ—¶éœ€è¦å¼€å¯SystemServer</div><div class="line">            startSystemServer = true;</div><div class="line">        &#125; else if (strcmp(arg, "--application") == 0) &#123;</div><div class="line">            application = true;</div><div class="line">        &#125; else if (strncmp(arg, "--nice-name=", 12) == 0) &#123;</div><div class="line">            niceName.setTo(arg + 12);</div><div class="line">        &#125; else if (strncmp(arg, "--", 2) != 0) &#123;</div><div class="line">            className.setTo(arg);</div><div class="line">            break;</div><div class="line">        &#125; else &#123;</div><div class="line">            --i;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Vector&lt;String8&gt; args;</div><div class="line">    if (!className.isEmpty()) &#123;</div><div class="line">        // We're not in zygote mode, the only argument we need to pass</div><div class="line">        // to RuntimeInit is the application argument.</div><div class="line">        //</div><div class="line">        // The Remainder of args get passed to startup class main(). Make</div><div class="line">        // copies of them before we overwrite them with the process name.</div><div class="line">        args.add(application ? String8("application") : String8("tool"));</div><div class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</div><div class="line">    &#125; else &#123;</div><div class="line">        // We're in zygote mode.</div><div class="line">        maybeCreateDalvikCache();</div><div class="line">	</div><div class="line">        if (startSystemServer) &#123;</div><div class="line">	    //ä½œä¸ºå‚æ•°ä¼ é€’ç»™Zygoteè¿›ç¨‹</div><div class="line">            args.add(String8("start-system-server"));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">	//... </div><div class="line">	</div><div class="line">        String8 abiFlag("--abi-list=");</div><div class="line">        abiFlag.append(prop);</div><div class="line">        args.add(abiFlag);</div><div class="line"></div><div class="line">        // In zygote mode, pass all remaining arguments to the zygote</div><div class="line">        // main() method.</div><div class="line">        for (; i &lt; argc; ++i) &#123;</div><div class="line">            args.add(String8(argv[i]));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!niceName.isEmpty()) &#123;</div><div class="line">	//è¿™é‡Œè¿›ç¨‹åå­—å°±æ˜¯zygote</div><div class="line">        runtime.setArgv0(niceName.string());</div><div class="line">        set_process_name(niceName.string());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (zygote) &#123;</div><div class="line">        //å¯åŠ¨Zygoteï¼Œæ¥ä¸‹æ¥ä¼šä¸»è¦åˆ†æstartå‡½æ•°</div><div class="line">        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);</div><div class="line">    &#125; else if (className) &#123;</div><div class="line">        runtime.start("com.android.internal.os.RuntimeInit", args, zygote);</div><div class="line">    &#125; else &#123;</div><div class="line">        fprintf(stderr, "Error: no class name or --zygote supplied.\n");</div><div class="line">        app_usage();</div><div class="line">        LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");</div><div class="line">        return 10;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-2-AndroidRuntime-start"><a href="#2-2-AndroidRuntime-start" class="headerlink" title="2.2 AndroidRuntime.start"></a>2.2 AndroidRuntime.start</h3><p>åˆ›å»ºè™šæ‹Ÿæœºï¼Œè¿è¡Œjavaå‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/jni/AndroidRuntime.cpp</em> :<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Start the Android runtime.  This involves starting the virtual machine</div><div class="line"> * and calling the "static void main(String[] args)" method in the class</div><div class="line"> * named by "className".</div><div class="line"> *</div><div class="line"> * Passes the main function two arguments, the class name and the specified</div><div class="line"> * options string.</div><div class="line"> */</div><div class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</div><div class="line">&#123;</div><div class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºå®ä¾‹</span></div><div class="line">    <span class="comment">/* start the virtual machine */</span></div><div class="line">    JniInvocation jni_invocation;</div><div class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</div><div class="line">    JNIEnv* env;</div><div class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    onVmCreated(env);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Register android functions.</div><div class="line">     */</div><div class="line">    <span class="comment">//æ³¨å†ŒJNIæ–¹æ³•</span></div><div class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * å°†å‚æ•°è½¬åŒ–ä¸ºjavaå¯¹è±¡</div><div class="line">     * We want to call main() with a String array with arguments in it.</div><div class="line">     * At present we have two arguments, the class name and an option string.</div><div class="line">     * Create an array to hold them.</div><div class="line">     */</div><div class="line">    jclass stringClass;</div><div class="line">    jobjectArray strArray;</div><div class="line">    jstring classNameStr;</div><div class="line"></div><div class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</div><div class="line">    assert(stringClass != <span class="literal">NULL</span>);</div><div class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</div><div class="line">    assert(strArray != <span class="literal">NULL</span>);</div><div class="line">    classNameStr = env-&gt;NewStringUTF(className);</div><div class="line">    assert(classNameStr != <span class="literal">NULL</span>);</div><div class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</div><div class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</div><div class="line">        assert(optionsStr != <span class="literal">NULL</span>);</div><div class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Start VM.  This thread becomes the main thread of the VM, and will</div><div class="line">     * not return until the VM exits.</div><div class="line">     */</div><div class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</div><div class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</div><div class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</div><div class="line">        <span class="comment">/* keep going */</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//æ‰¾åˆ°mainå‡½æ•°</span></div><div class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</div><div class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</div><div class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</div><div class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</div><div class="line">            <span class="comment">/* keep going */</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//è°ƒç”¨com.android.internal.os.ZygoteInitç±»çš„mainå‡½æ•°</span></div><div class="line">            <span class="comment">//å‚æ•°æ”¾åœ¨strArrayé‡Œ</span></div><div class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></div><div class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</div><div class="line">                threadExitUncaughtException(env);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">free</span>(slashClassName);</div><div class="line"></div><div class="line">    ALOGD(<span class="string">"Shutting down VM\n"</span>);</div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</div><div class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</div><div class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-3-ZygoteInit-main"><a href="#2-3-ZygoteInit-main" class="headerlink" title="2.3 ZygoteInit.main"></a>2.3 ZygoteInit.main</h3><p><em>frameworks/base/core/java/com/android/internal/os/Zygoteinit.java</em> :<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//è§£æå‚æ•°</span></div><div class="line">           RuntimeInit.enableDdms();</div><div class="line">           <span class="comment">// Start profiling the zygote initialization.</span></div><div class="line">           SamplingProfilerIntegration.start();</div><div class="line"></div><div class="line">           boolean startSystemServer = <span class="literal">false</span>;</div><div class="line">           String socketName = <span class="string">"zygote"</span>;</div><div class="line">           String abiList = null;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</div><div class="line">               <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</div><div class="line">                   startSystemServer = <span class="literal">true</span>;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">                   abiList = argv[i].substring(ABI_LIST_ARG.length());</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;</div><div class="line">                   socketName = argv[i].substring(SOCKET_NAME_ARG.length());</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unknown command line argument: "</span> + argv[i]);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (abiList == null) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No ABI list supplied."</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//æ³¨å†ŒSocketï¼Œåˆ›å»ºä¸€ä¸ªsocketæœåŠ¡ç«¯</span></div><div class="line">           registerZygoteSocket(socketName);</div><div class="line">           <span class="comment">//...</span></div><div class="line"></div><div class="line">           <span class="comment">// Do an initial gc to clean up after startup</span></div><div class="line">           gcAndFinalize();</div><div class="line"></div><div class="line">           <span class="comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span></div><div class="line">           <span class="comment">// Zygote.</span></div><div class="line">           Trace.setTracingEnabled(<span class="literal">false</span>);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (startSystemServer) &#123;</div><div class="line">               <span class="comment">//å¯åŠ¨ç³»ç»ŸæœåŠ¡</span></div><div class="line">               startSystemServer(abiList, socketName);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           Log.i(TAG, <span class="string">"Accepting command socket connections"</span>);</div><div class="line">           <span class="comment">//å¾ªç¯ç­‰å¾…å…¶ä»–æœåŠ¡å‘zygote socketå‘é€è¯·æ±‚</span></div><div class="line">           runSelectLoop(abiList);</div><div class="line"></div><div class="line">           closeServerSocket();</div><div class="line">       &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</div><div class="line">           caller.run();</div><div class="line">       &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">           Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</div><div class="line">           closeServerSocket();</div><div class="line">           <span class="keyword">throw</span> ex;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-4-ZygoteInit-registerZygoteSocket"><a href="#2-4-ZygoteInit-registerZygoteSocket" class="headerlink" title="2.4 ZygoteInit.registerZygoteSocket"></a>2.4 ZygoteInit.registerZygoteSocket</h3><p>åˆ›å»ºäº†zygote socketçš„serverç«¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Registers a server socket for zygote command connections</div><div class="line">  *</div><div class="line">  * <span class="doctag">@throws</span> RuntimeException when open fails</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerZygoteSocket</span><span class="params">(String socketName)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (sServerSocket == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">int</span> fileDesc;</div><div class="line">         <span class="comment">//æ‹¼æ¥å‡ºsocketåç§°ANDROID_SOCKET_zygote</span></div><div class="line">         <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             <span class="comment">//ç¯å¢ƒå˜é‡ä¸­åœ¨ä¸Šé¢å­˜å‚¨äº†è¯¥keyä¸‹å¯¹åº”çš„value</span></div><div class="line">             String env = System.getenv(fullSocketName);</div><div class="line">             <span class="comment">//è·å–socketçš„æ–‡ä»¶æè¿°ç¬¦</span></div><div class="line">             fileDesc = Integer.parseInt(env);</div><div class="line">         &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">" unset or invalid"</span>, ex);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</div><div class="line">             fd.setInt$(fileDesc);</div><div class="line">             <span class="comment">//åˆ›å»ºsocket serverï¼Œå¹¶ä¸”ä¿ç•™åœ¨ä¸€ä¸ªé™æ€å˜é‡sServerSocketä¸­</span></div><div class="line">             sServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</div><div class="line">         &#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                     <span class="string">"Error binding to local socket '"</span> + fileDesc + <span class="string">"'"</span>, ex);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="2-5-ZygoteInit-startSystemServer"><a href="#2-5-ZygoteInit-startSystemServer" class="headerlink" title="2.5  ZygoteInit.startSystemServer"></a>2.5  ZygoteInit.startSystemServer</h3><p>ä»zygoteä¸­forkä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å•ç‹¬å¤„ç†system serverã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">    * Prepare the arguments and fork for the system server process.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></div><div class="line">           <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException &#123;</div><div class="line"><span class="comment">//...</span></div><div class="line">       <span class="comment">/* Hardcoded command line to start the system server */</span></div><div class="line">       String args[] = &#123;</div><div class="line">           <span class="string">"--setuid=1000"</span>,</div><div class="line">           <span class="string">"--setgid=1000"</span>,</div><div class="line">           <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007"</span>,</div><div class="line">           <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</div><div class="line">           <span class="string">"--nice-name=system_server"</span>,</div><div class="line">           <span class="string">"--runtime-args"</span>,</div><div class="line">           <span class="string">"com.android.server.SystemServer"</span>, <span class="comment">//è¿™å°±æ˜¯System serverçš„ç±»å</span></div><div class="line">       &#125;;</div><div class="line">       ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="keyword">int</span> pid;</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</div><div class="line">           ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</div><div class="line">           ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</div><div class="line">           <span class="comment">//ä»zygoteä¸­forkå‡ºä¸€ä¸ªè¿›ç¨‹</span></div><div class="line">           <span class="comment">/* Request to fork the system server process */</span></div><div class="line">           pid = Zygote.forkSystemServer(</div><div class="line">                   parsedArgs.uid, parsedArgs.gid,</div><div class="line">                   parsedArgs.gids,</div><div class="line">                   parsedArgs.debugFlags,</div><div class="line">                   <span class="keyword">null</span>,</div><div class="line">                   parsedArgs.permittedCapabilities,</div><div class="line">                   parsedArgs.effectiveCapabilities);</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/* For child process */</span></div><div class="line">       <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</div><div class="line">               waitForSecondaryZygote(socketName);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//åœ¨å­è¿›ç¨‹ä¸­å¯åŠ¨System server,åœ¨ç¬¬3èŠ‚ä¸­è¯¦ç»†åˆ†æ</span></div><div class="line">           handleSystemServerProcess(parsedArgs);</div><div class="line">       &#125;</div><div class="line"><span class="comment">//çˆ¶è¿›ç¨‹è¿”å›</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="2-6-ZygoteInit-runSelectLoop"><a href="#2-6-ZygoteInit-runSelectLoop" class="headerlink" title="2.6 ZygoteInit.runSelectLoop"></a>2.6 ZygoteInit.runSelectLoop</h3><p>Zygoteå¯åŠ¨æ— é™å¾ªç¯ï¼Œç­‰å¾…è¯·æ±‚ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">    * Runs the zygote process's select loop. Accepts new connections as</div><div class="line">    * they happen, and reads commands from connections one spawn-request's</div><div class="line">    * worth at a time.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@throws</span> MethodAndArgsCaller in a child process when a main() should</div><div class="line">    * be executed.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</div><div class="line">       ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</div><div class="line">       ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</div><div class="line"><span class="comment">//ä¸€ä¸ªzygote socketæ–‡ä»¶æè¿°ç¬¦</span></div><div class="line">       fds.add(sServerSocket.getFileDescriptor());</div><div class="line">       peers.add(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">    <span class="comment">//å°†ç°æœ‰çš„fdå…ˆå­˜å…¥pollFds</span></div><div class="line">           StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</div><div class="line">               pollFds[i] = <span class="keyword">new</span> StructPollfd();</div><div class="line">               pollFds[i].fd = fds.get(i);</div><div class="line">               pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               Os.poll(pollFds, -<span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//ä¸€æ¬¡å¾ªç¯æœ€å¤šè®©ä¸€ä¸ªpeeræ¥å…¥ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¤„ç†å¤šä¸ªpeerçš„è¯·æ±‚</span></div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">               <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">//æ˜¯å¦æœ‰è¯·æ±‚å†™å…¥ï¼Œæ²¡æœ‰å°±ç»§ç»­</span></div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="comment">//æœ‰äººåœ¨zygoteä¸Šå†™å…¥è¯·æ±‚ï¼Œè·å¾—è¯¥peer</span></div><div class="line">                   <span class="comment">//è¿™ä¸€æ­¥åªæ˜¯peerå’Œzygoteå»ºç«‹è¿æ¥ï¼Œpeerè¿˜æœªå‘é€å…·ä½“è¯·æ±‚</span></div><div class="line">                   ZygoteConnection newPeer = acceptCommandPeer(abiList);</div><div class="line">                   peers.add(newPeer);</div><div class="line">                   <span class="comment">//å°†å…¶åŠ å…¥æ–‡ä»¶æè¿°ç¬¦fdsä¸­ï¼Œè¯¥peerä¼šå‘å…¶å¯¹åº”çš„fdå†™å…¥è¯·æ±‚</span></div><div class="line">                   <span class="comment">//è¿™ä¸€æ­¥ä¸ä¼šå¤„ç†ï¼Œå› ä¸ºè¯¥peeræ²¡æœ‰åœ¨pollFdsä¸­</span></div><div class="line">                   fds.add(newPeer.getFileDesciptor());</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">//æœ‰peerå‘å…¶fdå†™å…¥è¯·æ±‚,è¿™é‡Œå¼€å§‹å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå¤„ç†å®Œæ¯•ååˆ é™¤</span></div><div class="line">                   <span class="keyword">boolean</span> done = peers.get(i).runOnce();</div><div class="line">                   <span class="keyword">if</span> (done) &#123;</div><div class="line">                       peers.remove(i);</div><div class="line">                       fds.remove(i);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2 id="3-Systemè¿›ç¨‹çš„å¯åŠ¨"><a href="#3-Systemè¿›ç¨‹çš„å¯åŠ¨" class="headerlink" title="3. Systemè¿›ç¨‹çš„å¯åŠ¨"></a>3. Systemè¿›ç¨‹çš„å¯åŠ¨</h2><p>æ¥ç€2.5ï¼ŒZygote forkå‡ºä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥å¯åŠ¨System serverã€‚æ¥ä¸‹æ¥çœ‹åœ¨è¿™ä¸ªæ–°è¿›ç¨‹ä¸­å¦‚ä½•å¯åŠ¨çš„System serverã€‚</p>
<p><img src="http://img.blog.csdn.net/20161129224216177" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="3-1-ZygoteInit-handleSystemServerProcess"><a href="#3-1-ZygoteInit-handleSystemServerProcess" class="headerlink" title="3.1 ZygoteInit.handleSystemServerProcess"></a>3.1 ZygoteInit.handleSystemServerProcess</h3><p><em>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">/**</span></div><div class="line">    * Finish remaining work for the newly forked system server process.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleSystemServerProcess</span><span class="params">(</span></span></div><div class="line">           ZygoteConnection.Arguments parsedArgs)</div><div class="line">           <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">       <span class="comment">//å› ä¸ºforkäº†Zygoteçš„è¿›ç¨‹ï¼Œæ‰€ä»¥ä¼šå¤åˆ¶å®ƒçš„socket</span></div><div class="line">       <span class="comment">//SystemServerç”¨ä¸ç€è¿™ä¸ªsocketï¼Œå…ˆå…³äº†å†è¯´</span></div><div class="line">       closeServerSocket();</div><div class="line"></div><div class="line">       <span class="comment">// set umask to 0077 so new files and directories will default to owner-only permissions.</span></div><div class="line">       Os.umask(S_IRWXG | S_IRWXO);</div><div class="line"></div><div class="line"><span class="comment">//è®¾ç½®è¿›ç¨‹å</span></div><div class="line">       <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</div><div class="line">           Process.setArgV0(parsedArgs.niceName);</div><div class="line">       &#125;</div><div class="line"></div><div class="line"><span class="comment">//è·å–system serverç±»çš„è·¯å¾„</span></div><div class="line">       <span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</div><div class="line">       <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">           performSystemServerDexOpt(systemServerClasspath);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line">           String[] args = parsedArgs.remainingArgs;</div><div class="line">           <span class="comment">// If we have a non-null system server class path, we'll have to duplicate the</span></div><div class="line">           <span class="comment">// existing arguments and append the classpath to it. ART will handle the classpath</span></div><div class="line">           <span class="comment">// correctly when we exec a new process.</span></div><div class="line">           <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">               String[] amendedArgs = <span class="keyword">new</span> String[args.length + <span class="number">2</span>];</div><div class="line">               amendedArgs[<span class="number">0</span>] = <span class="string">"-cp"</span>;</div><div class="line">               amendedArgs[<span class="number">1</span>] = systemServerClasspath;</div><div class="line">               System.arraycopy(parsedArgs.remainingArgs, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, parsedArgs.remainingArgs.length);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           WrapperInit.execApplication(parsedArgs.invokeWith,</div><div class="line">                   parsedArgs.niceName, parsedArgs.targetSdkVersion,</div><div class="line">                   VMRuntime.getCurrentInstructionSet(), <span class="keyword">null</span>, args);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           ClassLoader cl = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">               cl = <span class="keyword">new</span> PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());</div><div class="line">               Thread.currentThread().setContextClassLoader(cl);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">/*</span></div><div class="line">            * è¿›ä¸€æ­¥å¯åŠ¨System server</div><div class="line">            * Pass the remaining arguments to SystemServer.</div><div class="line">            */</div><div class="line">           RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/* should never reach here */</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-2-RuntimeInit-zygoteInit"><a href="#3-2-RuntimeInit-zygoteInit" class="headerlink" title="3.2 RuntimeInit.zygoteInit"></a>3.2 RuntimeInit.zygoteInit</h3><p><em>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The main function called when started through the zygote process. This</div><div class="line"> * could be unified with main(), if the native code in nativeFinishInit()</div><div class="line"> * were rationalized with Zygote startup.&lt;p&gt;</div><div class="line"> *</div><div class="line"> * Current recognized args:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> *   &lt;li&gt; &lt;code&gt; [--] &amp;lt;start class name&amp;gt;  &amp;lt;args&amp;gt;</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> targetSdkVersion target SDK version</div><div class="line"> * <span class="doctag">@param</span> argv arg strings</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</div><div class="line"></div><div class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</div><div class="line">    redirectLogStreams();</div><div class="line">    </div><div class="line">    <span class="comment">//åšä¸€äº›åŸºæœ¬çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚æ—¶é—´ã€logç­‰</span></div><div class="line">    commonInit();</div><div class="line">    <span class="comment">//è¿›å…¥nativeéƒ¨åˆ†ï¼Œå°†æ¥ç« èŠ‚å†è®²</span></div><div class="line">    nativeZygoteInit();</div><div class="line">    <span class="comment">//è¿›ä¸€æ­¥å¯åŠ¨system</span></div><div class="line">    applicationInit(targetSdkVersion, argv, classLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-3-RuntimeInit-applicationInit"><a href="#3-3-RuntimeInit-applicationInit" class="headerlink" title="3.3 RuntimeInit.applicationInit"></a>3.3 RuntimeInit.applicationInit</h3><p>è¿™ä¸€æ­¥å¼€å§‹è°ƒç”¨SystemServerçš„mainå‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">           <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">       <span class="comment">// If the application calls System.exit(), terminate the process</span></div><div class="line">       <span class="comment">// immediately without running any shutdown hooks.  It is not possible to</span></div><div class="line">       <span class="comment">// shutdown an Android application gracefully.  Among other things, the</span></div><div class="line">       <span class="comment">// Android runtime shutdown hooks close the Binder driver, which can cause</span></div><div class="line">       <span class="comment">// leftover running threads to crash before the process actually exits.</span></div><div class="line">       nativeSetExitWithoutCleanup(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">       <span class="comment">// We want to be fairly aggressive about heap utilization, to avoid</span></div><div class="line">       <span class="comment">// holding on to a lot of memory that isn't needed.</span></div><div class="line">       VMRuntime.getRuntime().setTargetHeapUtilization(<span class="number">0.75f</span>);</div><div class="line">       VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);</div><div class="line"></div><div class="line">       <span class="keyword">final</span> Arguments args;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           args = <span class="keyword">new</span> Arguments(argv);</div><div class="line">       &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">           Slog.e(TAG, ex.getMessage());</div><div class="line">           <span class="comment">// let the process exit</span></div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// The end of of the RuntimeInit event (see #zygoteInit).</span></div><div class="line">       Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line"><span class="comment">//å¯åŠ¨éœ€è¦å¯åŠ¨çš„ç±»çš„mainå‡½æ•°ï¼Œè¿™é‡Œå°±æ˜¯com.android.server.SystemServer</span></div><div class="line">       <span class="comment">// Remaining arguments are passed to the start class's static main</span></div><div class="line">       invokeStaticMain(args.startClass, args.startArgs, classLoader);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-4-SystemServer-main"><a href="#3-4-SystemServer-main" class="headerlink" title="3.4 SystemServer.main"></a>3.4 SystemServer.main</h3><p>è¿™é‡Œç›´æ¥newäº†ä¸€ä¸ªSystemServerï¼Œç„¶åè°ƒç”¨å®ƒçš„runå‡½æ•°ã€‚</p>
<h3 id="3-5-SystemService-run"><a href="#3-5-SystemService-run" class="headerlink" title="3.5 SystemService.run"></a>3.5 SystemService.run</h3><p>è¿™ä¸€æ­¥å¼€å§‹ä¾æ¬¡å¯åŠ¨å„ç§serviceã€‚</p>
<p><em>frameworks/base/services/java/com/android/server/SystemServer.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">//...</span></div><div class="line">       <span class="comment">//è®¾ç½®ç³»ç»Ÿæ—¶é—´ã€è¯­è¨€ç­‰</span></div><div class="line">       <span class="keyword">if</span> (!SystemProperties.get(<span class="string">"persist.sys.language"</span>).isEmpty()) &#123;</div><div class="line">           <span class="keyword">final</span> String languageTag = Locale.getDefault().toLanguageTag();</div><div class="line"></div><div class="line">           SystemProperties.set(<span class="string">"persist.sys.locale"</span>, languageTag);</div><div class="line">           SystemProperties.set(<span class="string">"persist.sys.language"</span>, <span class="string">""</span>);</div><div class="line">           SystemProperties.set(<span class="string">"persist.sys.country"</span>, <span class="string">""</span>);</div><div class="line">           SystemProperties.set(<span class="string">"persist.sys.localevar"</span>, <span class="string">""</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line"><span class="comment">//... </span></div><div class="line"><span class="comment">//ä¸€äº›è™šæ‹Ÿæœºå†…å­˜ï¼Œå †æ ˆçš„è®¾ç½®</span></div><div class="line"> </div><div class="line"><span class="comment">//è¯¥çº¿ç¨‹å°±æ˜¯ä¸»çº¿ç¨‹</span></div><div class="line">       <span class="comment">// Prepare the main looper thread (this thread).</span></div><div class="line">       android.os.Process.setThreadPriority(</div><div class="line">               android.os.Process.THREAD_PRIORITY_FOREGROUND);</div><div class="line">       android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</div><div class="line">       Looper.prepareMainLooper();</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"><span class="comment">//åˆ›å»ºSystemServiceManager</span></div><div class="line">       <span class="comment">// Create the system service manager.</span></div><div class="line">       mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</div><div class="line">       LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</div><div class="line"></div><div class="line">       <span class="comment">// Start services.</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">//å¼€å§‹ä¾æ¬¡å¯åŠ¨å„ç§æœåŠ¡ï¼Œä¸‹ä¸€èŠ‚è¯¦ç»†è§£é‡Š</span></div><div class="line">           startBootstrapServices();</div><div class="line">           startCoreServices();</div><div class="line">           startOtherServices();</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">         <span class="comment">//...</span></div><div class="line">       &#125;</div><div class="line">       <span class="comment">//æ°¸è¿œçš„å¾ªç¯..</span></div><div class="line">       <span class="comment">// Loop forever.</span></div><div class="line">       Looper.loop();</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-6-å„ç§serviceå¯åŠ¨"><a href="#3-6-å„ç§serviceå¯åŠ¨" class="headerlink" title="3.6 å„ç§serviceå¯åŠ¨"></a>3.6 å„ç§serviceå¯åŠ¨</h3><h4 id="startBootstrapServices"><a href="#startBootstrapServices" class="headerlink" title="startBootstrapServices"></a>startBootstrapServices</h4><p>è¿™é‡Œé¢å¯åŠ¨çš„æœåŠ¡æœ‰ï¼š<code>Installer</code>ï¼Œ<code>ActivityManagerService</code>ï¼Œ<code>PowerManagerService</code>ï¼Œ<code>LightsService</code>ï¼Œ<code>DisplayManagerService</code>ï¼Œ<code>PackageManagerService</code>ï¼Œ<code>SensorService</code>ï¼ˆéå…·ä½“ï¼‰ã€‚</p>
<p>è¿™äº›serviceæœ‰çš„ä¼šåˆ›å»ºè‡ªå·±ç‹¬ç«‹çš„ServiceThreadï¼Œæ˜¯HandlerThreadçš„å­ç±»ï¼Œå®ƒä»¬æœ‰ç€è‡ªå·±çš„looperå¾ªç¯ã€‚<code>startService</code>å‡½æ•°å°†æ‰€æœ‰çš„serviceçš„å¯åŠ¨è¿‡ç¨‹ç»Ÿä¸€ç®¡ç†ï¼ŒæŠ½è±¡ä¸ºæ³¨å†Œã€å¯åŠ¨ä¸¤æ­¥éª¤ã€‚</p>
<p><em>frameworks/base/services/java/com/android/server/SystemServer.java</em> :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Starts the small tangle of critical services that are needed to get</div><div class="line">     * the system off the ground.  These services have complex mutual dependencies</div><div class="line">     * which is why we initialize them all in one place here.  Unless your service</div><div class="line">     * is also entwined in these dependencies, it should be initialized in one of</div><div class="line">     * the other functions.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Wait for installd to finish starting up so that it has a chance to</span></div><div class="line">        <span class="comment">// create critical directories such as /data/user with the appropriate</span></div><div class="line">        <span class="comment">// permissions.  We need this to complete before we initialize other services.</span></div><div class="line">        Installer installer = mSystemServiceManager.startService(Installer.class);</div><div class="line"></div><div class="line">        <span class="comment">// Activity manager runs the show.</span></div><div class="line">        mActivityManagerService = mSystemServiceManager.startService(</div><div class="line">                ActivityManagerService.Lifecycle.class).getService();</div><div class="line">        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</div><div class="line">        mActivityManagerService.setInstaller(installer);</div><div class="line"></div><div class="line">        <span class="comment">// Power manager needs to be started early because other services need it.</span></div><div class="line">        <span class="comment">// Native daemons may be watching for it to be registered so it must be ready</span></div><div class="line">        <span class="comment">// to handle incoming binder calls immediately (including being able to verify</span></div><div class="line">        <span class="comment">// the permissions for those calls).</span></div><div class="line">        mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</div><div class="line"></div><div class="line">        <span class="comment">// Now that the power manager has been started, let the activity manager</span></div><div class="line">        <span class="comment">// initialize power management features.</span></div><div class="line">        mActivityManagerService.initPowerManagement();</div><div class="line"></div><div class="line">        <span class="comment">// Manages LEDs and display backlight so we need it to bring up the display.</span></div><div class="line">        mSystemServiceManager.startService(LightsService.class);</div><div class="line"></div><div class="line">        <span class="comment">// Display manager is needed to provide display metrics before package manager</span></div><div class="line">        <span class="comment">// starts up.</span></div><div class="line">        mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</div><div class="line"></div><div class="line">        <span class="comment">// We need the default display before we can initialize the package manager.</span></div><div class="line">        mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</div><div class="line"></div><div class="line">        <span class="comment">// Only run "core" apps if we're encrypting the device.</span></div><div class="line">        String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</div><div class="line">        <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Detected encryption in progress - only parsing core apps"</span>);</div><div class="line">            mOnlyCore = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Device encrypted - only parsing core apps"</span>);</div><div class="line">            mOnlyCore = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Start the package manager.</span></div><div class="line">        Slog.i(TAG, <span class="string">"Package Manager"</span>);</div><div class="line">        mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</div><div class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</div><div class="line">        mFirstBoot = mPackageManagerService.isFirstBoot();</div><div class="line">        mPackageManager = mSystemContext.getPackageManager();</div><div class="line"></div><div class="line">        Slog.i(TAG, <span class="string">"User Service"</span>);</div><div class="line">        ServiceManager.addService(Context.USER_SERVICE, UserManagerService.getInstance());</div><div class="line"></div><div class="line">        <span class="comment">// Initialize attribute cache used to cache resources from packages.</span></div><div class="line">        AttributeCache.init(mSystemContext);</div><div class="line"></div><div class="line">        <span class="comment">// Set up the Application instance for the system process and get started.</span></div><div class="line">        mActivityManagerService.setSystemProcess();</div><div class="line"></div><div class="line">        <span class="comment">// The sensor service needs access to package manager service, app ops</span></div><div class="line">        <span class="comment">// service, and permissions service, therefore we start it after them.</span></div><div class="line">        startSensorService();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h4 id="startCoreServices"><a href="#startCoreServices" class="headerlink" title="startCoreServices"></a>startCoreServices</h4><p>è¿™ä¸€æ­¥å¯åŠ¨çš„serivceæœ‰ï¼šBatteryServiceï¼ŒUsageStatsServiceï¼ŒWebViewUpdateServiceã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Starts some essential services that are not tangled up in the bootstrap process.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startCoreServices</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Tracks the battery level.  Requires LightService.</span></div><div class="line">    mSystemServiceManager.startService(BatteryService.class);</div><div class="line"></div><div class="line">    <span class="comment">// Tracks application usage stats.</span></div><div class="line">    mSystemServiceManager.startService(UsageStatsService.class);</div><div class="line">    mActivityManagerService.setUsageStatsManager(</div><div class="line">            LocalServices.getService(UsageStatsManagerInternal.class));</div><div class="line">    <span class="comment">// Update after UsageStatsService is available, needed before performBootDexOpt.</span></div><div class="line">    mPackageManagerService.getUsageStatsIfNoPackageUsageInfo();</div><div class="line"></div><div class="line">    <span class="comment">// Tracks whether the updatable WebView is in a ready state and watches for update installs.</span></div><div class="line">    mSystemServiceManager.startService(WebViewUpdateService.class);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="startOtherService"><a href="#startOtherService" class="headerlink" title="startOtherService"></a>startOtherService</h4><p>è¿™ä¸€æ­¥å¯åŠ¨serviceåˆå¤šåˆæ‚ï¼Œä¸»è¦æœ‰å¦‚ä¸‹è¿™äº›ï¼Œå…¶å®ƒè¿˜æœ‰ä¸å†ä¸€ä¸€åˆ—ä¸¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">AccountManagerService accountManager = <span class="keyword">null</span>;</div><div class="line">       ContentService contentService = <span class="keyword">null</span>;</div><div class="line">       VibratorService vibrator = <span class="keyword">null</span>;</div><div class="line">       IAlarmManager alarm = <span class="keyword">null</span>;</div><div class="line">       IMountService mountService = <span class="keyword">null</span>;</div><div class="line">       NetworkManagementService networkManagement = <span class="keyword">null</span>;</div><div class="line">       NetworkStatsService networkStats = <span class="keyword">null</span>;</div><div class="line">       NetworkPolicyManagerService networkPolicy = <span class="keyword">null</span>;</div><div class="line">       ConnectivityService connectivity = <span class="keyword">null</span>;</div><div class="line">       NetworkScoreService networkScore = <span class="keyword">null</span>;</div><div class="line">       NsdService serviceDiscovery= <span class="keyword">null</span>;</div><div class="line">       WindowManagerService wm = <span class="keyword">null</span>;</div><div class="line">       UsbService usb = <span class="keyword">null</span>;</div><div class="line">       SerialService serial = <span class="keyword">null</span>;</div><div class="line">       NetworkTimeUpdateService networkTimeUpdater = <span class="keyword">null</span>;</div><div class="line">       CommonTimeManagementService commonTimeMgmtService = <span class="keyword">null</span>;</div><div class="line">       InputManagerService inputManager = <span class="keyword">null</span>;</div><div class="line">       TelephonyRegistry telephonyRegistry = <span class="keyword">null</span>;</div><div class="line">       ConsumerIrService consumerIr = <span class="keyword">null</span>;</div><div class="line">       AudioService audioService = <span class="keyword">null</span>;</div><div class="line">       MmsServiceBroker mmsService = <span class="keyword">null</span>;</div><div class="line">       EntropyMixer entropyMixer = <span class="keyword">null</span>;</div><div class="line">       CameraService cameraService = <span class="keyword">null</span>;</div></pre></td></tr></table></figure>
<h2 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4. æ€»ç»“"></a>4. æ€»ç»“</h2><p>å†™åˆ°è¿™é‡Œï¼Œæœ‰ç‚¹å‡Œä¹±ï¼Œå¤ªå¤šçš„è¿›ç¨‹å’Œçº¿ç¨‹åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­è¢«åˆ›å»ºã€‚æˆ‘ç”¨ä¸‹å›¾æ¥æ¢³ç†è¿™éƒ¨åˆ†è¿›ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œå¸Œæœ›è®©ä½ ä¸€ç›®äº†ç„¶å§ã€‚</p>
<p><img src="http://img.blog.csdn.net/20161129224233704" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;å†ä¸å­¦ä¹ æˆ‘ä»¬å°±è€äº†&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;0-Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ&quot;&gt;&lt;a href=&quot;#0-Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;0. Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ&quot;&gt;&lt;/a&gt;0. Zygoteæœ‰ä»€ä¹ˆåµç”¨ï¼Ÿ&lt;/h2&gt;&lt;p&gt;Zygoteæ˜¯è¿›ç¨‹å­µåŒ–å™¨ï¼ŒAndroidç³»ç»Ÿä¸­å…¶ä»–æœåŠ¡è¿›ç¨‹éƒ½æ˜¯æ‹·è´äºå®ƒã€‚Zygoteåœ¨è®¾è®¡æ¨¡å¼ä¸­å¯¹åº”äº&lt;code&gt;prototype&lt;/code&gt;ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥é€šè¿‡æ‹·è´Zygoteæ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-Zygoteè„šæœ¬å¯åŠ¨&quot;&gt;&lt;a href=&quot;#1-Zygoteè„šæœ¬å¯åŠ¨&quot; class=&quot;headerlink&quot; title=&quot;1. Zygoteè„šæœ¬å¯åŠ¨&quot;&gt;&lt;/a&gt;1. Zygoteè„šæœ¬å¯åŠ¨&lt;/h2&gt;&lt;p&gt;åœ¨å¼€æœºæ—¶ï¼Œinitè¿›ç¨‹ä¼šè°ƒç”¨å¦‚ä¸‹è„šæœ¬å¯åŠ¨è¿›ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;em&gt;system/core/rootdir/init.zygote32_64.rc&lt;/em&gt; :&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;service zygote /system/bin/app_process32 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;title&quot;&gt;socket&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;zygote&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;stream&lt;/span&gt; 660 &lt;span class=&quot;title&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;system&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;title&quot;&gt;onrestart&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;write&lt;/span&gt; /&lt;span class=&quot;title&quot;&gt;sys&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;android_power&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;request_state&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;wake&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;title&quot;&gt;onrestart&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;write&lt;/span&gt; /&lt;span class=&quot;title&quot;&gt;sys&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;power&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;on&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;title&quot;&gt;onrestart&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;restart&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;media&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;title&quot;&gt;onrestart&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;restart&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;netd&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;title&quot;&gt;writepid&lt;/span&gt; /&lt;span class=&quot;title&quot;&gt;dev&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;cpuset&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;foreground&lt;/span&gt;/&lt;span class=&quot;title&quot;&gt;tasks&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;service&lt;/code&gt;è¡¨æ˜è¯¥è¿›ç¨‹æ˜¯ä½œä¸ºä¸€ä¸ªæœåŠ¡æ¥å¯åŠ¨çš„ï¼Œ&lt;code&gt;--start-system-server&lt;/code&gt;æŒ‡æ˜äº†è¯¥è¿›ç¨‹å¯åŠ¨åï¼Œéœ€è¦å¯åŠ¨systemæœåŠ¡ã€‚è¯¥è¿›ç¨‹å¯¹åº”çš„ç«¯å£æƒé™660ï¼Œåå­—ä¸ºzygoteï¼Œå…¶å®ƒè¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥ç«¯å£å’Œå®ƒè¿›è¡Œé€šä¿¡ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(13):Inputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-13-Input%E6%B6%88%E6%81%AF%E7%9A%84%E5%88%86%E5%8F%91%E8%BF%87%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-13-Inputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹/</id>
    <published>2017-02-14T06:29:02.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹"><a href="#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹" class="headerlink" title="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹"></a>Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹</h1><blockquote>
<p>è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚å­¦æ ¡ç”µè„‘å¥½æ¸£ï¼Œçœ‹æºç æ—¶å¡åŠå¤©</p>
</blockquote>
<hr>
<p>å…ˆå›é¡¾ä¸€ä¸‹å‰ä¸¤ç¯‡æ–‡ç« ã€‚åœ¨è®¾å¤‡æ²¡æœ‰äº‹ä»¶è¾“å…¥çš„æ—¶å€™ï¼ŒInputReaderå’ŒInputDispatcheréƒ½å¤„äºç¡çœ çŠ¶æ€ã€‚å½“è¾“å…¥äº‹ä»¶å‘ç”Ÿï¼ŒInputReaderé¦–å…ˆè¢«æ¿€æ´»ï¼Œç„¶åå‘é€è¯»å–æ¶ˆæ¯ï¼Œæ¿€æ´»Dispatcherã€‚Dispatcherè¢«æ¿€æ´»ä»¥åï¼Œå°†æ¶ˆæ¯å‘é€ç»™å½“å‰æ¿€æ´»çª—å£çš„ä¸»çº¿ç¨‹ï¼Œç„¶åç¡çœ ç­‰å¾…ä¸»çº¿ç¨‹å¤„ç†å®Œè¿™ä¸ªäº‹ä»¶ã€‚ä¸»çº¿ç¨‹è¢«æ¿€æ´»åï¼Œä¼šå¤„ç†ç›¸åº”çš„æ¶ˆæ¯ï¼Œå¤„ç†å®Œæ¯•ååé¦ˆç»™Dispatcherï¼Œä»è€ŒDispatcherå¯ä»¥ç»§ç»­å‘é€æ¶ˆæ¯ã€‚</p>
<h2 id="1-InputReaderè·å–äº‹ä»¶"><a href="#1-InputReaderè·å–äº‹ä»¶" class="headerlink" title="1. InputReaderè·å–äº‹ä»¶"></a>1. InputReaderè·å–äº‹ä»¶</h2><p>å›é¡¾ä¸€ä¸‹ç¬¬11ç« 4.2ä¸­ï¼ŒInputReaderçº¿ç¨‹åœ¨è·å–äº‹ä»¶ä»¥åï¼Œä¼šè°ƒç”¨<code>processEventsLocked(mEventBuffer, count);</code>å¤„ç†äº‹ä»¶ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160927222615741" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<a id="more"></a>
<h3 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h3><p>è¿™é‡Œå…ˆæ ¹æ®eventçš„ç§ç±»è¿›è¡Œåˆ†é—¨åˆ«ç±»çš„å¤„ç†ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputReader.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputReader::processEventsLocked(<span class="keyword">const</span> RawEvent* rawEvents, <span class="keyword">size_t</span> count) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> RawEvent* rawEvent = rawEvents; count;) &#123;</div><div class="line">        <span class="keyword">int32_t</span> type = rawEvent-&gt;type;</div><div class="line">        <span class="keyword">size_t</span> batchSize = <span class="number">1</span>;</div><div class="line">      </div><div class="line">        <span class="keyword">if</span> (type &lt; EventHubInterface::FIRST_SYNTHETIC_EVENT) &#123;</div><div class="line">            <span class="comment">//å¦‚æœè¿™é‡Œè·å¾—æ˜¯åˆæˆäº‹ä»¶</span></div><div class="line">            <span class="comment">//è¿™é‡Œä¸€æ¬¡è¦å°†è¯¥è¾“å…¥è®¾å¤‡ä¸­çš„ä¸€ç»„äº‹ä»¶éƒ½è·å–å‡ºæ¥</span></div><div class="line">            <span class="keyword">int32_t</span> deviceId = rawEvent-&gt;deviceId;</div><div class="line">            <span class="keyword">while</span> (batchSize &lt; count) &#123;</div><div class="line">                <span class="keyword">if</span> (rawEvent[batchSize].type &gt;= EventHubInterface::FIRST_SYNTHETIC_EVENT</div><div class="line">                        || rawEvent[batchSize].deviceId != deviceId) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                batchSize += <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//å¤„ç†è¿™äº›äº‹ä»¶</span></div><div class="line">            processEventsForDeviceLocked(deviceId, rawEvent, batchSize);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//è¿™äº›æ˜¯ä¸€äº›è®¾å¤‡çŠ¶å†µçš„äº‹ä»¶ï¼Œæ²¡å¿…è¦å°†è¿™äº›æ¶ˆæ¯å‘é€å‡ºå»ï¼Œç•™ç»™è‡ªå·±å¤„ç†å°±å¯ä»¥äº†</span></div><div class="line">            <span class="keyword">switch</span> (rawEvent-&gt;type) &#123;</div><div class="line">            <span class="keyword">case</span> EventHubInterface::DEVICE_ADDED:</div><div class="line">                addDeviceLocked(rawEvent-&gt;when, rawEvent-&gt;deviceId);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> EventHubInterface::DEVICE_REMOVED:</div><div class="line">                removeDeviceLocked(rawEvent-&gt;when, rawEvent-&gt;deviceId);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> EventHubInterface::FINISHED_DEVICE_SCAN:</div><div class="line">                handleConfigurationChangedLocked(rawEvent-&gt;when);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                ALOG_ASSERT(<span class="literal">false</span>); <span class="comment">// can't happen</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        count -= batchSize;</div><div class="line">        rawEvent += batchSize;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-2"><a href="#1-2" class="headerlink" title="1.2"></a>1.2</h3><p>å‡†å¤‡å°†äº‹ä»¶äº¤ç»™è®¾å¤‡è¿›è¡Œå¤„ç†ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputReader.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputReader::processEventsForDeviceLocked(<span class="keyword">int32_t</span> deviceId,</div><div class="line">        <span class="keyword">const</span> RawEvent* rawEvents, <span class="keyword">size_t</span> count) &#123;  </div><div class="line">    <span class="comment">//åˆ¤æ–­è®¾å¤‡æ˜¯å¦æ˜¯å·²çŸ¥çš„</span></div><div class="line">    <span class="keyword">ssize_t</span> deviceIndex = mDevices.indexOfKey(deviceId);</div><div class="line">    <span class="keyword">if</span> (deviceIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">        ALOGW(<span class="string">"Discarding event for unknown deviceId %d."</span>, deviceId);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//è·å¾—è®¾å¤‡</span></div><div class="line">    InputDevice* device = mDevices.valueAt(deviceIndex);</div><div class="line">    <span class="keyword">if</span> (device-&gt;isIgnored()) &#123;</div><div class="line">        <span class="comment">//ALOGD("Discarding event for ignored deviceId %d.", deviceId);</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//äº¤ç»™è®¾å¤‡è¿›è¡Œå¤„ç†</span></div><div class="line">    device-&gt;process(rawEvents, count);</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<h3 id="1-3"><a href="#1-3" class="headerlink" title="1.3"></a>1.3</h3><p>ç”¨deviceä¸­çš„mapperå»æ˜ å°„ä¼ å…¥çš„äº‹ä»¶ï¼Œç„¶åå†å¤„ç†ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputReader.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputDevice::process(<span class="keyword">const</span> RawEvent* rawEvents, <span class="keyword">size_t</span> count) &#123;</div><div class="line">    <span class="comment">// Process all of the events in order for each mapper.</span></div><div class="line">    <span class="comment">// We cannot simply ask each mapper to process them in bulk because mappers may</span></div><div class="line">    <span class="comment">// have side-effects that must be interleaved.  For example, joystick movement events and</span></div><div class="line">    <span class="comment">// gamepad button presses are handled by different mappers but they should be dispatched</span></div><div class="line">    <span class="comment">// in the order received.</span></div><div class="line">    <span class="comment">//ä¸€ä¸ªè®¾å¤‡å¯èƒ½æœ‰å¤šç§ç±»å‹çš„eventï¼Œæ‰€æœ‰æœ‰å¤šä¸ªmapperï¼Œä½†æ˜¯éœ€è¦ä¿æŒeventçš„é¡ºåºæ€§</span></div><div class="line">    <span class="comment">//æ‰€ä»¥è¿™é‡Œé‡‡ç”¨å…ˆå¾ªç¯eventï¼Œå†å¾ªç¯mapperçš„æ–¹å¼</span></div><div class="line">    <span class="keyword">size_t</span> numMappers = mMappers.size();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> RawEvent* rawEvent = rawEvents; count--; rawEvent++) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mDropUntilNextSync) &#123;</div><div class="line">            <span class="keyword">if</span> (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_REPORT) &#123;</div><div class="line">                mDropUntilNextSync = <span class="literal">false</span>;</div><div class="line">                <span class="comment">//..</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//..</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_DROPPED) &#123;</div><div class="line">            <span class="comment">//..</span></div><div class="line">            mDropUntilNextSync = <span class="literal">true</span>;</div><div class="line">            reset(rawEvent-&gt;when);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; numMappers; i++) &#123;</div><div class="line">                InputMapper* mapper = mMappers[i];</div><div class="line">                <span class="comment">//ç”¨æ¯ä¸€ç§mapperå°è¯•å¤„ç†event</span></div><div class="line">                mapper-&gt;process(rawEvent);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-4"><a href="#1-4" class="headerlink" title="1.4"></a>1.4</h3><p>è¿™é‡ŒInputMapperç§ç±»å¾ˆå¤šï¼Œæ¯ä¸ªäº‹ä»¶å¤„ç†æ–¹æ³•å„ä¸ç›¸åŒï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸å†è¯¦è¿°ã€‚å…¶ä¸­æœ‰å¦‚ä¸‹çš„InputMapperï¼š</p>
<blockquote>
<p>SwitchInputMapper, VibratorInputMapper, KeyboardInputMapper,  CursorInputMapper, TouchInputMapper, SingleTouchInputMapper, MultiTouchInputMapper, JoystickInputMapper</p>
</blockquote>
<p>è¿™äº›æ–¹æ³•å¤„ç†åˆ°æœ€åï¼Œä¼šè°ƒç”¨<code>getListener()-&gt;notifyXXX(&amp;args)</code>ï¼Œè®©Dispatcherè¿›è¡Œåˆ†å‘ï¼ŒXXXæ ¹æ®ä¸åŒçš„Mapperæœ‰ç›¸åº”çš„åå­—ã€‚åœ¨åˆ›å»ºInputReaderæ—¶ï¼Œå°†InputDispatcherä½œä¸ºå‚æ•°ä¼ å…¥ï¼ŒåŒæ—¶å»ºç«‹äº†QueuedInputListeneræ¥å­˜æ”¾è¿™ä¸ªInputDispatcherï¼Œä¼°è®¡æ˜¯å‡†å¤‡å°†æ¥å¤„ç†å¤šä¸ªInputDispatcherã€‚æ‰€ä»¥è¿™é‡ŒgetListenerè·å–çš„å°±æ˜¯å½“åˆå»ºç«‹çš„InputDispatcherå¯¹è±¡ã€‚</p>
<h3 id="1-5"><a href="#1-5" class="headerlink" title="1.5"></a>1.5</h3><p>è¿™é‡Œè™½ç„¶å·²ç»å¼€å§‹è°ƒç”¨InputDispatcherçš„å‡½æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨InputReaderçº¿ç¨‹ä¸­ã€‚è¿™é‡Œå¼€å§‹å‘InputDispatcherçš„é˜Ÿåˆ—ä¸­æ’å…¥äº‹ä»¶ï¼Œå¹¶ä¸”æŠŠInputDispatcherå”¤é†’äº†ã€‚å› ä¸ºnotifyXXXå‡½æ•°åŒæ ·æ˜¯é’ˆå¯¹ä¸åŒçš„è¾“å…¥æœ‰ç€ä¸åŒçš„å¤„ç†ï¼Œæ‰€ä»¥ä¸å†è¯¦è¿°ï¼Œæˆªå–ä¸€æ®µMotionEventçš„ä»£ç ç‰‡æ®µã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">//é’ˆå¯¹æ¯ç§eventï¼Œéƒ½ä¼šæƒ³å°†å…¶å°è£…æˆä¸€ä¸ªEventEntry</span></div><div class="line"> <span class="comment">// Just enqueue a new motion event.</span></div><div class="line"> MotionEntry* newEntry = <span class="keyword">new</span> MotionEntry(args-&gt;eventTime,</div><div class="line">              args-&gt;deviceId, args-&gt;source, policyFlags,</div><div class="line">              args-&gt;action, args-&gt;actionButton, args-&gt;flags,</div><div class="line">              args-&gt;metaState, args-&gt;buttonState,</div><div class="line">              args-&gt;edgeFlags, args-&gt;xPrecision, args-&gt;yPrecision, args-&gt;downTime,</div><div class="line">              args-&gt;displayId,</div><div class="line">              args-&gt;pointerCount, args-&gt;pointerProperties, args-&gt;pointerCoords, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line"><span class="comment">//ç„¶ååŠ å…¥é˜Ÿåˆ—</span></div><div class="line">needWake = enqueueInboundEventLocked(newEntry);</div><div class="line"></div><div class="line"><span class="comment">//...</span></div><div class="line"><span class="comment">//å”¤é†’Looperçº¿ç¨‹</span></div><div class="line"><span class="keyword">if</span> (needWake) &#123;</div><div class="line">      mLooper-&gt;wake();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>å°†ä¸€ä¸ªäº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ä¹‹åï¼Œä¼šæ ¹æ®needWakeå‚æ•°å†³å®šæ˜¯å¦è¦å”¤é†’çº¿ç¨‹ã€‚å¦‚æœè¦å”¤é†’ï¼Œåˆ™è°ƒç”¨Looperçš„wakeå‡½æ•°å°±å¯ä»¥äº†ï¼Œå’ŒåŸæ¥é“ç†ä¸€æ ·ã€‚åœ¨æœ‰äº›æ—¶å€™ï¼Œæœ‰äº‹ä»¶æ·»åŠ è¿›å»ï¼Œä¸ä¸€å®šè¦å”¤é†’çº¿ç¨‹ï¼Œæ¯”å¦‚çº¿ç¨‹æ­£åœ¨ç­‰å¾…åº”ç”¨åé¦ˆäº‹ä»¶å¤„ç†å®Œæ¯•çš„æ¶ˆæ¯ã€‚</p>
<h3 id="1-6"><a href="#1-6" class="headerlink" title="1.6"></a>1.6</h3><p>å®å®åœ¨åœ¨çš„å°†è¿™ä¸ªEventEntryæ”¾å…¥é˜Ÿåˆ—mInboundQueueä¸­äº†ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> InputDispatcher::enqueueInboundEventLocked(EventEntry* entry) &#123;</div><div class="line">    <span class="comment">//å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œéœ€è¦å”¤é†’</span></div><div class="line">    <span class="keyword">bool</span> needWake = mInboundQueue.isEmpty();</div><div class="line">    <span class="comment">//å°†äº‹ä»¶åŠ å…¥é˜Ÿåˆ—</span></div><div class="line">    mInboundQueue.enqueueAtTail(entry);</div><div class="line">    traceInboundQueueLengthLocked();</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (entry-&gt;type) &#123;</div><div class="line">    <span class="comment">//è¿™é‡Œä¼šä¼˜åŒ–Appåˆ‡æ¢çš„äº‹ä»¶ï¼Œå¦‚æœä¸Šä¸€ä¸ªAppè¿˜æœ‰äº‹ä»¶æ²¡å¤„ç†å®Œï¼Œä¹Ÿæ²¡åé¦ˆäº‹ä»¶å¤„ç†å®Œæ¯•æ¶ˆæ¯</span></div><div class="line">    <span class="comment">//åˆ™æ¸…ç©ºä¹‹å‰çš„äº‹ä»¶ï¼Œåˆ‡æ¢ä¸‹ä¸€ä¸ªåº”ç”¨</span></div><div class="line">    <span class="keyword">case</span> EventEntry::TYPE_KEY: &#123;</div><div class="line">        <span class="comment">// Optimize app switch latency.</span></div><div class="line">        <span class="comment">// If the application takes too long to catch up then we drop all events preceding</span></div><div class="line">        <span class="comment">// the app switch key.</span></div><div class="line">        KeyEntry* keyEntry = <span class="keyword">static_cast</span>&lt;KeyEntry*&gt;(entry);</div><div class="line">        <span class="keyword">if</span> (isAppSwitchKeyEventLocked(keyEntry)) &#123;</div><div class="line">            <span class="keyword">if</span> (keyEntry-&gt;action == AKEY_EVENT_ACTION_DOWN) &#123;</div><div class="line">                mAppSwitchSawKeyDown = <span class="literal">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyEntry-&gt;action == AKEY_EVENT_ACTION_UP) &#123;</div><div class="line">                <span class="keyword">if</span> (mAppSwitchSawKeyDown) &#123;</div><div class="line">#<span class="keyword">if</span> DEBUG_APP_SWITCH</div><div class="line">                    ALOGD(<span class="string">"App switch is pending!"</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                    mAppSwitchDueTime = keyEntry-&gt;eventTime + APP_SWITCH_TIMEOUT;</div><div class="line">                    mAppSwitchSawKeyDown = <span class="literal">false</span>;</div><div class="line">                    needWake = <span class="literal">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å½“ä¸€ä¸ªéå½“å‰æ¿€æ´»appçš„ç‚¹å‡»äº‹ä»¶å‘ç”Ÿï¼Œä¼šæ¸…ç©ºä¹‹å‰çš„äº‹ä»¶</span></div><div class="line">    <span class="comment">//ä»è¿™ä¸ªæ–°çš„ç‚¹å‡»äº‹ä»¶å¼€å§‹</span></div><div class="line">    <span class="keyword">case</span> EventEntry::TYPE_MOTION: &#123;</div><div class="line">        <span class="comment">// Optimize case where the current application is unresponsive and the user</span></div><div class="line">        <span class="comment">// decides to touch a window in a different application.</span></div><div class="line">        <span class="comment">// If the application takes too long to catch up then we drop all events preceding</span></div><div class="line">        <span class="comment">// the touch into the other window.</span></div><div class="line">        MotionEntry* motionEntry = <span class="keyword">static_cast</span>&lt;MotionEntry*&gt;(entry);</div><div class="line">        <span class="keyword">if</span> (motionEntry-&gt;action == AMOTION_EVENT_ACTION_DOWN</div><div class="line">                &amp;&amp; (motionEntry-&gt;source &amp; AINPUT_SOURCE_CLASS_POINTER)</div><div class="line">                &amp;&amp; mInputTargetWaitCause == INPUT_TARGET_WAIT_CAUSE_APPLICATION_NOT_READY</div><div class="line">                &amp;&amp; mInputTargetWaitApplicationHandle != <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="keyword">int32_t</span> displayId = motionEntry-&gt;displayId;</div><div class="line">            <span class="keyword">int32_t</span> x = <span class="keyword">int32_t</span>(motionEntry-&gt;pointerCoords[<span class="number">0</span>].</div><div class="line">                    getAxisValue(AMOTION_EVENT_AXIS_X));</div><div class="line">            <span class="keyword">int32_t</span> y = <span class="keyword">int32_t</span>(motionEntry-&gt;pointerCoords[<span class="number">0</span>].</div><div class="line">                    getAxisValue(AMOTION_EVENT_AXIS_Y));</div><div class="line">            sp&lt;InputWindowHandle&gt; touchedWindowHandle = findTouchedWindowAtLocked(displayId, x, y);</div><div class="line">            <span class="keyword">if</span> (touchedWindowHandle != <span class="literal">NULL</span></div><div class="line">                    &amp;&amp; touchedWindowHandle-&gt;inputApplicationHandle</div><div class="line">                            != mInputTargetWaitApplicationHandle) &#123;</div><div class="line">                <span class="comment">// User touched a different application than the one we are waiting on.</span></div><div class="line">                <span class="comment">// Flag the event, and start pruning the input queue.</span></div><div class="line">                mNextUnblockedEvent = motionEntry;</div><div class="line">                needWake = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> needWake;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>è¿™é‡Œåšäº†ä¸¤ç§ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯åœ¨å½“å‰Appçª—å£å¤„ç†äº‹ä»¶è¿‡æ…¢ï¼ŒåŒæ—¶ä½ åˆè§¦å‘å…¶ä»–Appçš„äº‹ä»¶æ—¶ï¼ŒDispatcherå°±ä¼šä¸¢å¼ƒå…ˆå‰çš„äº‹ä»¶ï¼Œä»è¿™ä¸ªå¼€å§‹å”¤é†’Dispatcherã€‚è¿™æ ·åšå¾ˆåˆæƒ…åˆç†ï¼Œç”¨æˆ·åœ¨ä½¿ç”¨æ—¶ï¼Œä¼šé‡åˆ°Appç”±äºå¼€å‘è€…æ°´å¹³æœ‰é™å¯¼è‡´å¤„ç†äº‹ä»¶è¿‡æ…¢æƒ…å†µï¼Œè¿™æ—¶ç”¨æˆ·ç­‰çš„ä¸è€çƒ¦ï¼Œåˆ™åº”è¯¥è®©ç”¨æˆ·è½»æ¾çš„åˆ‡æ¢åˆ°å…¶å®ƒAppï¼Œè€Œä¸æ˜¯é˜»å¡åœ¨é‚£ã€‚æ‰€ä»¥ï¼Œäº‹ä»¶æ— æ³•å“åº”åªä¼šå‘ç”Ÿåœ¨Appå†…éƒ¨ï¼Œè€Œä¸ä¼šå½±å“åº”ç”¨çš„åˆ‡æ¢ï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒã€‚Appçš„è´¨é‡é—®é¢˜ä¸ä¼šå½±å“ç³»ç»Ÿçš„è¿è½¬ï¼ŒAndroidåœ¨è¿™ç‚¹ä¸Šåšçš„å¾ˆäººæ€§ã€‚</p>
<h2 id="2-InputDispatcheråˆ†å‘äº‹ä»¶"><a href="#2-InputDispatcheråˆ†å‘äº‹ä»¶" class="headerlink" title="2. InputDispatcheråˆ†å‘äº‹ä»¶"></a>2. InputDispatcheråˆ†å‘äº‹ä»¶</h2><p>åœ¨ç¬¬11ç« ä¸­3.2ä¸­ï¼ŒDispatcherè°ƒç”¨å‡½æ•°<code>dispatchOnceInnerLocked(&amp;nextWakeupTime);</code>æ¥åˆ†é…é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160927223056508" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="2-1"><a href="#2-1" class="headerlink" title="2.1"></a>2.1</h3><p>ä»é˜Ÿåˆ—ä¸­è·å–eventï¼Œç„¶åå‡†å¤‡å¤„ç†ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputDispatcher::dispatchOnceInnerLocked(<span class="keyword">nsecs_t</span>* nextWakeupTime) &#123;</div><div class="line">    <span class="keyword">nsecs_t</span> currentTime = now();</div><div class="line"></div><div class="line">    <span class="comment">// Reset the key repeat timer whenever normal dispatch is suspended while the</span></div><div class="line">    <span class="comment">// device is in a non-interactive state.  This is to ensure that we abort a key</span></div><div class="line">    <span class="comment">// repeat if the device is just coming out of sleep.</span></div><div class="line">    <span class="keyword">if</span> (!mDispatchEnabled) &#123;</div><div class="line">        resetKeyRepeatLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If dispatching is frozen, do not process timeouts or try to deliver any new events.</span></div><div class="line">    <span class="keyword">if</span> (mDispatchFrozen) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å¯¹Appåˆ‡æ¢çš„æƒ…å†µçš„ä¼˜åŒ–</span></div><div class="line">    <span class="comment">// Optimize latency of app switches.</span></div><div class="line">    <span class="comment">// Essentially we start a short timeout when an app switch key (HOME / ENDCALL) has</span></div><div class="line">    <span class="comment">// been pressed.  When it expires, we preempt dispatch and drop all other pending events.</span></div><div class="line">    <span class="keyword">bool</span> isAppSwitchDue = mAppSwitchDueTime &lt;= currentTime;</div><div class="line">    <span class="keyword">if</span> (mAppSwitchDueTime &lt; *nextWakeupTime) &#123;</div><div class="line">        <span class="comment">//å¦‚æœæœ‰åˆ‡æ¢Appçš„eventï¼Œä¸”æ—¶é—´å°äºè®¾å®šçš„æ—¶é—´</span></div><div class="line">        <span class="comment">//åˆ™å°†ç­‰å¾…äº‹ä»¶è®¾ä¸ºå°è€…</span></div><div class="line">        *nextWakeupTime = mAppSwitchDueTime;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Ready to start a new event.</span></div><div class="line">    <span class="comment">// If we don't already have a pending event, go grab one.</span></div><div class="line">    <span class="keyword">if</span> (! mPendingEvent) &#123;</div><div class="line">        <span class="keyword">if</span> (mInboundQueue.isEmpty()) &#123;</div><div class="line">            <span class="comment">//é˜Ÿåˆ—æ˜¯ç©ºçš„æƒ…å†µ</span></div><div class="line">            <span class="keyword">if</span> (isAppSwitchDue) &#123;</div><div class="line">                <span class="comment">// The inbound queue is empty so the app switch key we were waiting</span></div><div class="line">                <span class="comment">// for will never arrive.  Stop waiting for it.</span></div><div class="line">                resetPendingAppSwitchLocked(<span class="literal">false</span>);</div><div class="line">                isAppSwitchDue = <span class="literal">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Synthesize a key repeat if appropriate.</span></div><div class="line">            <span class="comment">//å¦‚æœæœ‰è¿ç»­é‡å¤äº‹ä»¶å‘ç”Ÿï¼Œåˆ™åˆ¶é€ é‡å¤äº‹ä»¶</span></div><div class="line">            <span class="keyword">if</span> (mKeyRepeatState.lastKeyEntry) &#123;</div><div class="line">                <span class="keyword">if</span> (currentTime &gt;= mKeyRepeatState.nextRepeatTime) &#123;</div><div class="line">                    mPendingEvent = synthesizeKeyRepeatLocked(currentTime);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (mKeyRepeatState.nextRepeatTime &lt; *nextWakeupTime) &#123;</div><div class="line">                        *nextWakeupTime = mKeyRepeatState.nextRepeatTime;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Nothing to do if there is no pending event.</span></div><div class="line">            <span class="comment">//å¦‚æœçœŸæ— äº‹å¯åšï¼Œä¸‹æ¬¡ç¡çœ å¯èƒ½æ¯”è¾ƒä¹…</span></div><div class="line">            <span class="keyword">if</span> (!mPendingEvent) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Inbound queue has at least one entry.</span></div><div class="line">            <span class="comment">//ä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªEvent</span></div><div class="line">            mPendingEvent = mInboundQueue.dequeueAtHead();</div><div class="line">            traceInboundQueueLengthLocked();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Poke user activity for this event.</span></div><div class="line">        <span class="keyword">if</span> (mPendingEvent-&gt;policyFlags &amp; POLICY_FLAG_PASS_TO_USER) &#123;</div><div class="line">            pokeUserActivityLocked(mPendingEvent);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//é‡ç½®ANRT</span></div><div class="line">        <span class="comment">// Get ready to dispatch the event.</span></div><div class="line">        resetANRTimeoutsLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Now we have an event to dispatch.</span></div><div class="line">    <span class="comment">// All events are eventually dequeued and processed this way, even if we intend to drop them.</span></div><div class="line">    <span class="keyword">bool</span> done = <span class="literal">false</span>;</div><div class="line">    DropReason dropReason = DROP_REASON_NOT_DROPPED;</div><div class="line">    <span class="keyword">if</span> (!(mPendingEvent-&gt;policyFlags &amp; POLICY_FLAG_PASS_TO_USER)) &#123;</div><div class="line">        dropReason = DROP_REASON_POLICY;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mDispatchEnabled) &#123;</div><div class="line">        dropReason = DROP_REASON_DISABLED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mNextUnblockedEvent == mPendingEvent) &#123;</div><div class="line">        mNextUnblockedEvent = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//åˆ†ç±»å¤„ç†Event</span></div><div class="line">    <span class="keyword">switch</span> (mPendingEvent-&gt;type) &#123;</div><div class="line">    <span class="keyword">case</span> EventEntry::TYPE_CONFIGURATION_CHANGED: &#123;</div><div class="line">        ConfigurationChangedEntry* typedEntry =</div><div class="line">                <span class="keyword">static_cast</span>&lt;ConfigurationChangedEntry*&gt;(mPendingEvent);</div><div class="line">        done = dispatchConfigurationChangedLocked(currentTime, typedEntry);</div><div class="line">        dropReason = DROP_REASON_NOT_DROPPED; <span class="comment">// configuration changes are never dropped</span></div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> EventEntry::TYPE_DEVICE_RESET: &#123;</div><div class="line">        DeviceResetEntry* typedEntry =</div><div class="line">                <span class="keyword">static_cast</span>&lt;DeviceResetEntry*&gt;(mPendingEvent);</div><div class="line">        done = dispatchDeviceResetLocked(currentTime, typedEntry);</div><div class="line">        dropReason = DROP_REASON_NOT_DROPPED; <span class="comment">// device resets are never dropped</span></div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> EventEntry::TYPE_KEY: &#123;</div><div class="line">        KeyEntry* typedEntry = <span class="keyword">static_cast</span>&lt;KeyEntry*&gt;(mPendingEvent);</div><div class="line">        <span class="keyword">if</span> (isAppSwitchDue) &#123;</div><div class="line">            <span class="keyword">if</span> (isAppSwitchKeyEventLocked(typedEntry)) &#123;</div><div class="line">                <span class="comment">//è¿™ä¸ªEventå°±æ˜¯SwitchEventï¼Œæˆ‘å·²ç»å¤„ç†</span></div><div class="line">                <span class="comment">//é‡ç½®Appåˆ‡æ¢çš„çŠ¶æ€ä¸ºfalse</span></div><div class="line">                resetPendingAppSwitchLocked(<span class="literal">true</span>);</div><div class="line">                isAppSwitchDue = <span class="literal">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED) &#123;</div><div class="line">                <span class="comment">//å¦‚æœæ˜¯å…¶ä»–äº‹ä»¶ï¼Œåˆ™ä¸¢å¼ƒï¼Œå› ä¸ºæ­£åœ¨switch</span></div><div class="line">                dropReason = DROP_REASON_APP_SWITCH;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED</div><div class="line">                &amp;&amp; isStaleEventLocked(currentTime, typedEntry)) &#123;</div><div class="line">            dropReason = DROP_REASON_STALE;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; mNextUnblockedEvent) &#123;</div><div class="line">            dropReason = DROP_REASON_BLOCKED;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//åˆ†å‘KeyEvent</span></div><div class="line">        done = dispatchKeyLocked(currentTime, typedEntry, &amp;dropReason, nextWakeupTime);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> EventEntry::TYPE_MOTION: &#123;</div><div class="line">        MotionEntry* typedEntry = <span class="keyword">static_cast</span>&lt;MotionEntry*&gt;(mPendingEvent);</div><div class="line">        <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; isAppSwitchDue) &#123;</div><div class="line">            dropReason = DROP_REASON_APP_SWITCH;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED</div><div class="line">                &amp;&amp; isStaleEventLocked(currentTime, typedEntry)) &#123;</div><div class="line">            dropReason = DROP_REASON_STALE;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; mNextUnblockedEvent) &#123;</div><div class="line">            dropReason = DROP_REASON_BLOCKED;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//åˆ†å‘Motion Event</span></div><div class="line">        done = dispatchMotionLocked(currentTime, typedEntry,</div><div class="line">                &amp;dropReason, nextWakeupTime);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        ALOG_ASSERT(<span class="literal">false</span>);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (done) &#123;</div><div class="line">        <span class="keyword">if</span> (dropReason != DROP_REASON_NOT_DROPPED) &#123;</div><div class="line">            dropInboundEventLocked(mPendingEvent, dropReason);</div><div class="line">        &#125;</div><div class="line">        mLastDropReason = dropReason;</div><div class="line">        <span class="comment">//å°†mPendingEventç½®ä¸ºnull</span></div><div class="line">        releasePendingEventLocked();</div><div class="line">        <span class="comment">//æˆ‘å·²ç»å¤„ç†çš„eventï¼Œæ‰€ä»¥éœ€è¦å°†ç¡çœ è®¾ç½®æ—¶é—´å°ä¸€ç‚¹</span></div><div class="line">        *nextWakeupTime = LONG_LONG_MIN;  <span class="comment">// force next poll to wake up immediately</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h3><p>è¿™ä¸€æ­¥æ ¹æ®Eventçš„ç§ç±»ï¼Œç•¥æœ‰ä¸åŒã€‚æœ‰<code>dispatchMotionLocked</code>å’Œ<code>dispatchKeyLocked</code>ç­‰ã€‚ä¸»è¦è¿‡ç¨‹ç±»ä¼¼ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦ä¸¢å¼ƒè¯¥eventï¼Œç„¶åè·å¾—ç›®æ ‡Windowï¼Œå†å‘ç›®æ ‡windowå‘é€eventã€‚ä»£ç ç‰‡å¦‚ä¸‹ï¼š</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//..</span></div><div class="line"><span class="comment">// Identify targets.</span></div><div class="line">Vector&lt;InputTarget&gt; inputTargets;</div><div class="line"><span class="comment">//..</span></div><div class="line">injectionResult = findTouchedWindowTargetsLocked(currentTime, entry, inputTargets, nextWakeupTime, &amp;conflictingPointerActions);</div><div class="line"><span class="comment">//..</span></div><div class="line">dispatchEventLocked(currentTime, entry, inputTargets);</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œè°ƒç”¨<code>findTouchedWindowTargetsLocked()</code>æ¥è·å–ç›®æ ‡Windowã€‚åœ¨å‰é¢12ç« 3.6ä¸­ï¼Œå°†mFocusedWindowHandleå‚æ•°è®¾ç½®ä¸ºäº†å½“å‰æ¿€æ´»çš„Windowï¼Œæ‰€ä»¥ç›®å‰è¿”å›çš„inputTargetså°±æ˜¯å°†mFocusedWindowHandleå°è£…åçš„ç»“æœã€‚</p>
<h3 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h3><p>å‘æ¯ä¸€ä¸ªç›®æ ‡å‘é€eventã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputDispatcher::dispatchEventLocked(<span class="keyword">nsecs_t</span> currentTime,</div><div class="line">        EventEntry* eventEntry, <span class="keyword">const</span> Vector&lt;InputTarget&gt;&amp; inputTargets) &#123;</div><div class="line"></div><div class="line">    pokeUserActivityLocked(eventEntry);</div><div class="line">    <span class="comment">//å‘æ¯ä¸€ä¸ªç›®æ ‡å‘é€event</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; inputTargets.size(); i++) &#123;</div><div class="line">        <span class="keyword">const</span> InputTarget&amp; inputTarget = inputTargets.itemAt(i);</div><div class="line">        <span class="comment">//è·å–ç›®æ ‡çš„connection</span></div><div class="line">        <span class="keyword">ssize_t</span> connectionIndex = getConnectionIndexLocked(inputTarget.inputChannel);</div><div class="line">        <span class="keyword">if</span> (connectionIndex &gt;= <span class="number">0</span>) &#123;</div><div class="line">            sp&lt;Connection&gt; connection = mConnectionsByFd.valueAt(connectionIndex);</div><div class="line">            prepareDispatchCycleLocked(currentTime, connection, eventEntry, &amp;inputTarget);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//..</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-4"><a href="#2-4" class="headerlink" title="2.4"></a>2.4</h3><p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputDispatcher::prepareDispatchCycleLocked(<span class="keyword">nsecs_t</span> currentTime,</div><div class="line">        <span class="keyword">const</span> sp&lt;Connection&gt;&amp; connection, EventEntry* eventEntry, <span class="keyword">const</span> InputTarget* inputTarget) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Skip this event if the connection status is not normal.</span></div><div class="line">    <span class="comment">// We don't want to enqueue additional outbound events if the connection is broken.</span></div><div class="line">    <span class="keyword">if</span> (connection-&gt;status != Connection::STATUS_NORMAL) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">    <span class="comment">// Split a motion event if needed.</span></div><div class="line">    <span class="keyword">if</span> (inputTarget-&gt;flags &amp; InputTarget::FLAG_SPLIT) &#123;</div><div class="line">        <span class="comment">//Motion eventä¸€èˆ¬ä¸ºè¿ç»­çš„åŸºæœ¬eventç»„åˆè€Œæˆ</span></div><div class="line">        <span class="comment">//æ‰€ä»¥å¯ä»¥åˆ†å‰²</span></div><div class="line">        MotionEntry* originalMotionEntry = <span class="keyword">static_cast</span>&lt;MotionEntry*&gt;(eventEntry);</div><div class="line">        <span class="keyword">if</span> (inputTarget-&gt;pointerIds.count() != originalMotionEntry-&gt;pointerCount) &#123;</div><div class="line">            MotionEntry* splitMotionEntry = splitMotionEvent(</div><div class="line">                    originalMotionEntry, inputTarget-&gt;pointerIds);</div><div class="line">            <span class="keyword">if</span> (!splitMotionEntry) &#123;</div><div class="line">                <span class="keyword">return</span>; <span class="comment">// split event was dropped</span></div><div class="line">            &#125;</div><div class="line">            enqueueDispatchEntriesLocked(currentTime, connection,</div><div class="line">                    splitMotionEntry, inputTarget);</div><div class="line">            splitMotionEntry-&gt;release();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Not splitting.  Enqueue dispatch entries for the event as is.</span></div><div class="line">    enqueueDispatchEntriesLocked(currentTime, connection, eventEntry, inputTarget);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-5"><a href="#2-5" class="headerlink" title="2.5"></a>2.5</h3><p>è¿™ä¸€æ­¥å…ˆåˆ¤æ–­ç›®æ ‡Connectionæ˜¯å¦ç©ºï¼Œç„¶åå‘å…¶é˜Ÿåˆ—åŠ å…¥eventã€‚å¦‚æœåŸæ¥é˜Ÿåˆ—ä¸ºç©ºï¼Œè¯´æ˜å¯ä»¥è¿›ä¸€æ­¥åˆ†å‘eventï¼›å¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜æ—§eventè¿˜æ²¡æœ‰å¤„ç†å®Œæ¯•ï¼Œåˆ™ä¸è¿›ä¸€æ­¥åˆ†å‘ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> wasEmpty = connection-&gt;outboundQueue.isEmpty();</div><div class="line"></div><div class="line"><span class="comment">// Enqueue dispatch entries for the requested modes.</span></div><div class="line"><span class="comment">//å°†eventæ”¾å…¥outboundQueueä¸­ï¼Œçœç•¥..</span></div><div class="line"></div><div class="line"><span class="comment">// If the outbound queue was previously empty, start the dispatch cycle going.</span></div><div class="line"><span class="keyword">if</span> (wasEmpty &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123;</div><div class="line">    startDispatchCycleLocked(currentTime, connection);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-6"><a href="#2-6" class="headerlink" title="2.6"></a>2.6</h3><p>å¾ªç¯çš„å–å‡ºé˜Ÿåˆ—ä¸­çš„eventï¼Œç„¶åäº¤ç»™connectionå‘é€ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputDispatcher::startDispatchCycleLocked(<span class="keyword">nsecs_t</span> currentTime,</div><div class="line">        <span class="keyword">const</span> sp&lt;Connection&gt;&amp; connection) &#123;</div><div class="line"></div><div class="line">    <span class="comment">//å°†outboundQueueä¸­çš„entryä¸€ä¸€è¿›è¡Œå¤„ç†</span></div><div class="line">    <span class="keyword">while</span> (connection-&gt;status == Connection::STATUS_NORMAL</div><div class="line">            &amp;&amp; !connection-&gt;outboundQueue.isEmpty()) &#123;</div><div class="line">        <span class="comment">//è·å–é¦–éƒ¨çš„entry</span></div><div class="line">        DispatchEntry* dispatchEntry = connection-&gt;outboundQueue.head;</div><div class="line">        dispatchEntry-&gt;deliveryTime = currentTime;</div><div class="line"></div><div class="line">        <span class="comment">// Publish the event.</span></div><div class="line">        <span class="keyword">status_t</span> status;</div><div class="line">        EventEntry* eventEntry = dispatchEntry-&gt;eventEntry;</div><div class="line">        <span class="keyword">switch</span> (eventEntry-&gt;type) &#123;</div><div class="line">        <span class="keyword">case</span> EventEntry::TYPE_KEY: &#123;</div><div class="line">            KeyEntry* keyEntry = <span class="keyword">static_cast</span>&lt;KeyEntry*&gt;(eventEntry);</div><div class="line">            <span class="comment">//..</span></div><div class="line">            </div><div class="line">            <span class="comment">// Publish the key event.</span></div><div class="line">            status = connection-&gt;inputPublisher.publishKeyEvent(dispatchEntry-&gt;seq,</div><div class="line">                    keyEntry-&gt;deviceId, keyEntry-&gt;source,</div><div class="line">                    dispatchEntry-&gt;resolvedAction, dispatchEntry-&gt;resolvedFlags,</div><div class="line">                    keyEntry-&gt;keyCode, keyEntry-&gt;scanCode,</div><div class="line">                    keyEntry-&gt;metaState, keyEntry-&gt;repeatCount, keyEntry-&gt;downTime,</div><div class="line">                    keyEntry-&gt;eventTime);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> EventEntry::TYPE_MOTION: &#123;</div><div class="line">            MotionEntry* motionEntry = <span class="keyword">static_cast</span>&lt;MotionEntry*&gt;(eventEntry);</div><div class="line"></div><div class="line">            <span class="comment">// Set the X and Y offset depending on the input source.</span></div><div class="line">            <span class="comment">//..</span></div><div class="line">            </div><div class="line">            <span class="comment">// Publish the motion event.</span></div><div class="line">            status = connection-&gt;inputPublisher.publishMotionEvent(dispatchEntry-&gt;seq,</div><div class="line">                    motionEntry-&gt;deviceId, motionEntry-&gt;source,</div><div class="line">                    dispatchEntry-&gt;resolvedAction, motionEntry-&gt;actionButton,</div><div class="line">                    dispatchEntry-&gt;resolvedFlags, motionEntry-&gt;edgeFlags,</div><div class="line">                    motionEntry-&gt;metaState, motionEntry-&gt;buttonState,</div><div class="line">                    xOffset, yOffset, motionEntry-&gt;xPrecision, motionEntry-&gt;yPrecision,</div><div class="line">                    motionEntry-&gt;downTime, motionEntry-&gt;eventTime,</div><div class="line">                    motionEntry-&gt;pointerCount, motionEntry-&gt;pointerProperties,</div><div class="line">                    usingCoords);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Check the result.</span></div><div class="line">    </div><div class="line">        <span class="comment">// Re-enqueue the event on the wait queue.</span></div><div class="line">        <span class="comment">//ä»outboundQueueä¸­ç§»é™¤</span></div><div class="line">        connection-&gt;outboundQueue.dequeue(dispatchEntry);</div><div class="line">        traceOutboundQueueLengthLocked(connection);</div><div class="line">        <span class="comment">//åŠ å…¥waitQueue</span></div><div class="line">        connection-&gt;waitQueue.enqueueAtTail(dispatchEntry);</div><div class="line">        traceWaitQueueLengthLocked(connection);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-7"><a href="#2-7" class="headerlink" title="2.7"></a>2.7</h3><p>è¿™ä¸€æ­¥åŒæ ·æœ‰å¤šç§æƒ…å†µï¼Œæœ‰publishMotionEventå’ŒpublishKeyEventã€‚åŸºæœ¬æ€è·¯ç›¸è¿‘ã€‚å…ˆå°è£…æˆmessageï¼Œæœ€åéƒ½è°ƒç”¨äº†<code>mChannel-&gt;sendMessage(&amp;msg)</code>ã€‚<br><em>frameworks/native/libs/input/InputTransport.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">InputMessage msg;</div><div class="line">msg.header.type = InputMessage::TYPE_MOTION;</div><div class="line">msg.body.motion.seq = seq;</div><div class="line">msg.body.motion.deviceId = deviceId;</div><div class="line">msg.body.motion.source = source;</div><div class="line">msg.body.motion.action = action;</div><div class="line">msg.body.motion.actionButton = actionButton;</div><div class="line">msg.body.motion.flags = flags;</div><div class="line">msg.body.motion.edgeFlags = edgeFlags;</div><div class="line">msg.body.motion.metaState = metaState;</div><div class="line">msg.body.motion.buttonState = buttonState;</div><div class="line">msg.body.motion.xOffset = xOffset;</div><div class="line">msg.body.motion.yOffset = yOffset;</div><div class="line">msg.body.motion.xPrecision = xPrecision;</div><div class="line">msg.body.motion.yPrecision = yPrecision;</div><div class="line">msg.body.motion.downTime = downTime;</div><div class="line">msg.body.motion.eventTime = eventTime;</div><div class="line">msg.body.motion.pointerCount = pointerCount;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</div><div class="line">    msg.body.motion.pointers[i].properties.copyFrom(pointerProperties[i]);</div><div class="line">    msg.body.motion.pointers[i].coords.copyFrom(pointerCoords[i]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> mChannel-&gt;sendMessage(&amp;msg);</div></pre></td></tr></table></figure></p>
<h3 id="2-8"><a href="#2-8" class="headerlink" title="2.8"></a>2.8</h3><p>è¿™ä¸€æ­¥å°±è¦åƒä¿å­˜çš„æ–‡ä»¶æè¿°ç¬¦<code>mFd</code>ä¸­å†™å…¥æ•°æ®äº†ã€‚</p>
<p><em>frameworks/native/libs/input/InputTransport.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">size_t</span> msgLength = msg-&gt;size();</div><div class="line"><span class="keyword">ssize_t</span> nWrite;</div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">    nWrite = ::send(mFd, msg, msgLength, MSG_DONTWAIT | MSG_NOSIGNAL);</div><div class="line">&#125; <span class="keyword">while</span> (nWrite == <span class="number">-1</span> &amp;&amp; errno == EINTR);</div></pre></td></tr></table></figure><br>åˆ°è¿™é‡Œï¼ŒDispatcherç»ˆäºæŠŠeventé€šè¿‡å½“åˆå»ºç«‹çš„Channel pairå‘é€ç»™äº†åº”ç”¨windowã€‚è¿™é‡Œå’Œæ—§ç‰ˆæœ¬å¾ˆä¸åŒï¼Œå½“åˆéœ€è¦å…ˆå°†eventæ”¾å…¥å…±äº«å†…å­˜ï¼Œç„¶åå‘é€ä¸€ä¸ªä¿¡å·è¿›è¡Œé€šçŸ¥ã€‚</p>
<h2 id="3-å½“å‰æ¿€æ´»Windowè·å¾—æ¶ˆæ¯"><a href="#3-å½“å‰æ¿€æ´»Windowè·å¾—æ¶ˆæ¯" class="headerlink" title="3. å½“å‰æ¿€æ´»Windowè·å¾—æ¶ˆæ¯"></a>3. å½“å‰æ¿€æ´»Windowè·å¾—æ¶ˆæ¯</h2><p>è¿™ä¸€èŠ‚æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å›å¿†å¤§é‡çš„å‰é¢å‡ ç« çš„ç»†èŠ‚å’Œä¸€å®šçš„é€»è¾‘æ¨ç†ï¼ˆè¿è’™å¸¦çŒœï¼‰èƒ½åŠ›ã€‚</p>
<p>å…ˆæ¥å›å¿†ä¸€ä¸‹ç¬¬12ç« 4.5èŠ‚ï¼Œåœ¨InputChannelæ³¨å†Œåˆ°Clientæ—¶ï¼Œæœ€åä¸€æ­¥åšäº†ä»€ä¹ˆã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mMessageQueue-&gt;getLooper()-&gt;addFd(fd, <span class="number">0</span>, events, <span class="keyword">this</span>, <span class="literal">NULL</span>);</div></pre></td></tr></table></figure><br>è¿™é‡Œç»™ä¸»çº¿ç¨‹çš„Looperæ·»åŠ çš„ä¸€ä¸ªéœ€è¦ç›‘å¬fdï¼Œè¿™ä¸ªfdæ˜¯Clientç«¯çš„InputChannelçš„æ–‡ä»¶æè¿°ç¬¦ã€‚<code>addFd</code>å‡½æ•°çš„ç¬¬4ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™é‡ŒthisæŒ‡NativeInputEventReceiverå¯¹è±¡ï¼Œå®ƒæ˜¯LooperCallbackçš„å­ç±»ã€‚<code>addFd</code>å‡½æ•°æ–°å»ºäº†ä¸€ä¸ªRequestå¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š</p>
<p><em>system/core/libutils/Looper.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Request request;</div><div class="line">request.fd = fd;</div><div class="line">request.ident = ident;</div><div class="line">request.events = events;</div><div class="line">request.seq = mNextRequestSeq++;</div><div class="line"><span class="comment">//å›è°ƒå‡½æ•°æŒ‡æ˜æ˜¯ä¸Šä¸€æ­¥ä¼ å…¥çš„NativeInputEventReceiverå¯¹è±¡</span></div><div class="line">request.callback = callback;</div><div class="line">request.data = data;</div><div class="line"><span class="comment">//..</span></div><div class="line"><span class="comment">//å°†requestä»¥fdä¸ºå…³é”®å­—åŠ å…¥mRequests</span></div><div class="line">mRequests.add(fd, request);</div></pre></td></tr></table></figure></p>
<p>å†æ¬¡å›å¿†ç¬¬10ç« 1.6ï¼Œä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹è¢«é˜»å¡çš„åœ°æ–¹ã€‚ä»£ç å¦‚ä¸‹ï¼š<br><em>system/core/libutils/Looper.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> Looper::pollInner(<span class="keyword">int</span> timeoutMillis) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Adjust the timeout based on when the next message is due.</span></div><div class="line">    <span class="comment">//..</span></div><div class="line">    <span class="comment">//æ¸…ç©ºmResponsesæ•°ç»„</span></div><div class="line">    <span class="comment">// Poll.</span></div><div class="line">    <span class="keyword">int</span> result = POLL_WAKE;</div><div class="line">    mResponses.clear();</div><div class="line">    mResponseIndex = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// We are about to idle.</span></div><div class="line">    mPolling = <span class="literal">true</span>;</div><div class="line">    <span class="comment">//ç­‰å¾…epollç›‘æµ‹åˆ°IOäº‹ä»¶</span></div><div class="line">    <span class="keyword">struct</span> epoll_event eventItems[EPOLL_MAX_EVENTS];</div><div class="line">    <span class="keyword">int</span> eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</div><div class="line"></div><div class="line">    <span class="comment">//..</span></div><div class="line"></div><div class="line">    <span class="comment">// Handle all events.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; eventCount; i++) &#123;</div><div class="line">        <span class="keyword">int</span> fd = eventItems[i].data.fd;</div><div class="line">        <span class="keyword">uint32_t</span> epollEvents = eventItems[i].events;</div><div class="line">        <span class="keyword">if</span> (fd == mWakeEventFd) &#123;</div><div class="line">            <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) &#123;</div><div class="line">                <span class="comment">//è¿™é‡Œå¤„ç†çš„å”¤é†’äº‹ä»¶</span></div><div class="line">                awoken();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ALOGW(<span class="string">"Ignoring unexpected epoll events 0x%x on wake event fd."</span>, epollEvents);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">	    <span class="comment">//è¿™é‡Œå¤„ç†çš„æ˜¯inputäº‹ä»¶</span></div><div class="line">            <span class="keyword">ssize_t</span> requestIndex = mRequests.indexOfKey(fd);</div><div class="line">            <span class="keyword">if</span> (requestIndex &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">int</span> events = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT;</div><div class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT;</div><div class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR;</div><div class="line">                <span class="keyword">if</span> (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP;</div><div class="line">                <span class="comment">//å°†eventåŠ å…¥mResponses</span></div><div class="line">                pushResponse(events, mRequests.valueAt(requestIndex));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="comment">//..</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">Done: ;</div><div class="line"></div><div class="line">    <span class="comment">//éå†æ¯ä¸€ä¸ªå­˜åœ¨mResponsesçš„event</span></div><div class="line">    <span class="comment">// Invoke all response callbacks.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mResponses.size(); i++) &#123;</div><div class="line">        Response&amp; response = mResponses.editItemAt(i);</div><div class="line">        <span class="keyword">if</span> (response.request.ident == POLL_CALLBACK) &#123;</div><div class="line">            <span class="keyword">int</span> fd = response.request.fd;</div><div class="line">            <span class="keyword">int</span> events = response.events;</div><div class="line">            <span class="keyword">void</span>* data = response.request.data;</div><div class="line">            <span class="comment">// Invoke the callback.  Note that the file descriptor may be closed by</span></div><div class="line">            <span class="comment">// the callback (and potentially even reused) before the function returns so</span></div><div class="line">            <span class="comment">// we need to be a little careful when removing the file descriptor afterwards.</span></div><div class="line">            <span class="comment">//è¿™ä¸€æ­¥å¼€å§‹è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè¯´æ˜è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸‹æœ‰äººè¾“å…¥çš„event</span></div><div class="line">            <span class="keyword">int</span> callbackResult = response.request.callback-&gt;handleEvent(fd, events, data);</div><div class="line">            <span class="keyword">if</span> (callbackResult == <span class="number">0</span>) &#123;</div><div class="line">                removeFd(fd, response.request.seq);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Clear the callback reference in the response structure promptly because we</span></div><div class="line">            <span class="comment">// will not clear the response vector itself until the next poll.</span></div><div class="line">            response.request.callback.clear();</div><div class="line">            result = POLL_CALLBACK;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>è¿™ä¸€æ­¥å¤„ç†wakeäº‹ä»¶å·²ç»åœ¨ç¬¬10ç« ç¬¬1èŠ‚è®²è¿°è¿‡äº†ï¼Œè¿™é‡Œéœ€è¦å¤„ç†çš„å¦ä¸€ç§äº‹ä»¶input eventã€‚å¯¹input eventï¼Œå…ˆå°†å…¶æ”¾å…¥mResponsesæ•°ç»„ï¼Œç„¶åä¾æ¬¡è°ƒç”¨ä»–ä»¬çš„å›è°ƒå‡½æ•°ã€‚è¿™é‡Œå°±æ˜¯NativeInputEventReceiverçš„handleEventå‡½æ•°äº†ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160930132531316" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="3-1"><a href="#3-1" class="headerlink" title="3.1"></a>3.1</h3><p>Eventåˆ†ä¸ºInputå’ŒOutputï¼Œè¿™é‡Œæ˜¯äº‹ä»¶è¾“å…¥ï¼Œæ‰€ä»¥å…ˆçœ‹Inputåˆ†æ”¯ã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> NativeInputEventReceiver::handleEvent(<span class="keyword">int</span> receiveFd, <span class="keyword">int</span> events, <span class="keyword">void</span>* data) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (events &amp; ALOOPER_EVENT_INPUT) &#123;</div><div class="line">        JNIEnv* env = AndroidRuntime::getJNIEnv();</div><div class="line">        <span class="keyword">status_t</span> status = consumeEvents(env, <span class="literal">false</span> <span class="comment">/*consumeBatches*/</span>, <span class="number">-1</span>, <span class="literal">NULL</span>);</div><div class="line">        mMessageQueue-&gt;raiseAndClearException(env, <span class="string">"handleReceiveCallback"</span>);</div><div class="line">        <span class="keyword">return</span> status == OK || status == NO_MEMORY ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (events &amp; ALOOPER_EVENT_OUTPUT) &#123;</div><div class="line">      <span class="comment">//..</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h3><p>å¼€å§‹ä»ç›®æ ‡Channelä¸­è¯»å‡ºeventï¼Œç„¶ååŒ…è£…æˆjavaå±‚çš„å¯¹è±¡ï¼Œå¼€å§‹è°ƒç”¨javaå‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> NativeInputEventReceiver::consumeEvents(JNIEnv* env,</div><div class="line">        <span class="keyword">bool</span> consumeBatches, <span class="keyword">nsecs_t</span> frameTime, <span class="keyword">bool</span>* outConsumedBatch) &#123;</div><div class="line"></div><div class="line">    ScopedLocalRef&lt;jobject&gt; receiverObj(env, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">bool</span> skipCallbacks = <span class="literal">false</span>;</div><div class="line">    <span class="comment">//å¾ªç¯ä»Channelä¸­è¯»å‡ºevent</span></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="keyword">uint32_t</span> seq;</div><div class="line">        InputEvent* inputEvent;</div><div class="line">        <span class="comment">//è¿™ä¸€æ­¥å¼€å§‹ä»Channelä¸­è¯»å–eventï¼Œå­˜å…¥inputEventä¸­</span></div><div class="line">        <span class="keyword">status_t</span> status = mInputConsumer.consume(&amp;mInputEventFactory,</div><div class="line">                consumeBatches, frameTime, &amp;seq, &amp;inputEvent);</div><div class="line">        <span class="keyword">if</span> (status) &#123;</div><div class="line">            <span class="keyword">if</span> (status == WOULD_BLOCK) &#123;</div><div class="line">                <span class="keyword">if</span> (!skipCallbacks &amp;&amp; !mBatchedInputEventPending</div><div class="line">                        &amp;&amp; mInputConsumer.hasPendingBatch()) &#123;</div><div class="line">                    <span class="comment">// There is a pending batch.  Come back later.</span></div><div class="line">                    <span class="comment">//..</span></div><div class="line">                <span class="keyword">return</span> OK;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> status;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!skipCallbacks) &#123;</div><div class="line">            <span class="keyword">if</span> (!receiverObj.get()) &#123;</div><div class="line">                <span class="comment">//è¿™é‡Œçš„mReceiverWeakGlobalæ˜¯javaå±‚çš„InputEventReceiver</span></div><div class="line">                receiverObj.reset(jniGetReferent(env, mReceiverWeakGlobal));</div><div class="line">                <span class="comment">//..</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//æ ¹æ®ä¸åŒçš„InputEventç§ç±»ï¼Œå°†å…¶è½¬åŒ–ä¸ºjavaå±‚çš„inputEventObj</span></div><div class="line">            jobject inputEventObj;</div><div class="line">            <span class="keyword">switch</span> (inputEvent-&gt;getType()) &#123;</div><div class="line">            <span class="keyword">case</span> AINPUT_EVENT_TYPE_KEY:</div><div class="line">                inputEventObj = android_view_KeyEvent_fromNative(env,</div><div class="line">                        <span class="keyword">static_cast</span>&lt;KeyEvent*&gt;(inputEvent));</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> AINPUT_EVENT_TYPE_MOTION: &#123;</div><div class="line">                MotionEvent* motionEvent = <span class="keyword">static_cast</span>&lt;MotionEvent*&gt;(inputEvent);</div><div class="line">                <span class="keyword">if</span> ((motionEvent-&gt;getAction() &amp; AMOTION_EVENT_ACTION_MOVE) &amp;&amp; outConsumedBatch) &#123;</div><div class="line">                    *outConsumedBatch = <span class="literal">true</span>;</div><div class="line">                &#125;</div><div class="line">                inputEventObj = android_view_MotionEvent_obtainAsCopy(env, motionEvent);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                assert(<span class="literal">false</span>); <span class="comment">// InputConsumer should prevent this from ever happening</span></div><div class="line">                inputEventObj = <span class="literal">NULL</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (inputEventObj) &#123;</div><div class="line">                <span class="comment">//å¼€å§‹è°ƒç”¨javaå±‚çš„dispatchInputEventå‡½æ•°</span></div><div class="line">                env-&gt;CallVoidMethod(receiverObj.get(),</div><div class="line">                        gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj);</div><div class="line">                env-&gt;DeleteLocalRef(inputEventObj);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="comment">//..</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (skipCallbacks) &#123;</div><div class="line">            <span class="comment">//ä¸éœ€è¦è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œåˆ™å¯ä»¥ç›´æ¥åé¦ˆå®Œæˆä¿¡å·</span></div><div class="line">            mInputConsumer.sendFinishedSignal(seq, <span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>æˆ‘ä»¬å…ˆçœ‹å¦‚ä½•ä»Channelä¸­è·å–eventçš„ï¼Œ3.3ã€‚ç„¶åè®²è§£javaå±‚çš„åˆ†å‘è¿‡ç¨‹ï¼Œ3.4ã€‚</p>
<h3 id="3-3"><a href="#3-3" class="headerlink" title="3.3"></a>3.3</h3><p>ä»Chuannelä¸­è¯»å–ä¸€ä¸ªï¼ˆä¸€ç»„ï¼‰eventã€‚</p>
<p><em>frameworks/native/libs/input/InputTransport.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> InputConsumer::consume(InputEventFactoryInterface* factory,</div><div class="line">        <span class="keyword">bool</span> consumeBatches, <span class="keyword">nsecs_t</span> frameTime, <span class="keyword">uint32_t</span>* outSeq, InputEvent** outEvent) &#123;</div><div class="line"></div><div class="line">    *outSeq = <span class="number">0</span>;</div><div class="line">    *outEvent = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Fetch the next input message.</span></div><div class="line">    <span class="comment">// Loop until an event can be returned or no additional events are received.</span></div><div class="line">    <span class="keyword">while</span> (!*outEvent) &#123;</div><div class="line">        <span class="keyword">if</span> (mMsgDeferred) &#123;</div><div class="line">            <span class="comment">// mMsg contains a valid input message from the previous call to consume</span></div><div class="line">            <span class="comment">// that has not yet been processed.</span></div><div class="line">            mMsgDeferred = <span class="literal">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Receive a fresh message.</span></div><div class="line">            <span class="comment">//ä»Channelä¸­è¯»å–ä¸€ä¸ªMessage</span></div><div class="line">            <span class="keyword">status_t</span> result = mChannel-&gt;receiveMessage(&amp;mMsg);</div><div class="line">            <span class="keyword">if</span> (result) &#123;</div><div class="line">                <span class="comment">// Consume the next batched event unless batches are being held for later.</span></div><div class="line">                <span class="comment">//..</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//æ ¹æ®messageç§ç±»æ„é€ event</span></div><div class="line">        <span class="keyword">switch</span> (mMsg.header.type) &#123;</div><div class="line">        <span class="keyword">case</span> InputMessage::TYPE_KEY: &#123;</div><div class="line">            KeyEvent* keyEvent = factory-&gt;createKeyEvent();</div><div class="line">            <span class="keyword">if</span> (!keyEvent) <span class="keyword">return</span> NO_MEMORY;</div><div class="line">            </div><div class="line">            initializeKeyEvent(keyEvent, &amp;mMsg);</div><div class="line">            *outSeq = mMsg.body.key.seq;</div><div class="line">            *outEvent = keyEvent;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> AINPUT_EVENT_TYPE_MOTION: &#123;</div><div class="line">            <span class="comment">//å¯¹Motion eventï¼Œéœ€è¦å¤„ç†æˆæ‰¹çš„eventäº‹ä»¶</span></div><div class="line">            <span class="comment">//..</span></div><div class="line">            MotionEvent* motionEvent = factory-&gt;createMotionEvent();</div><div class="line">            <span class="keyword">if</span> (! motionEvent) <span class="keyword">return</span> NO_MEMORY;</div><div class="line"></div><div class="line">            updateTouchState(&amp;mMsg);</div><div class="line">            initializeMotionEvent(motionEvent, &amp;mMsg);</div><div class="line">            *outSeq = mMsg.body.motion.seq;</div><div class="line">            *outEvent = motionEvent;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> UNKNOWN_ERROR;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>mChannel-&gt;receiveMessage(&amp;mMsg)</code>å‡½æ•°åœ¨InputChannelä¸­ä¸»è¦å¦‚ä¸‹å®ç°ï¼Œè°ƒç”¨socketå‡½æ•°recvä»mFdä¸­è¯»å‡ºæ•°æ®ã€‚</p>
<p><em>frameworks/native/libs/input/InputTransport.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nRead = ::recv(mFd, msg, <span class="keyword">sizeof</span>(InputMessage), MSG_DONTWAIT);</div></pre></td></tr></table></figure></p>
<h3 id="3-4"><a href="#3-4" class="headerlink" title="3.4"></a>3.4</h3><p>å›åˆ°javaå±‚ï¼Œåœ¨è·å¾—eventåï¼Œå°±éœ€è¦è¿›è¡Œåˆ†å‘äº†ã€‚receiverObjæŒ‡å‘çš„æ˜¯ä¸€ä¸ªInputEventReceiverå¯¹è±¡ï¼Œè¿™é‡Œå…¶å®æ˜¯å®ƒçš„å­ç±»WindowInputEventReceiverå¯¹è±¡ï¼Œè§ç¬¬12ç« ç¬¬4èŠ‚ã€‚<code>dispatchInputEvent</code>å‡½æ•°è¿˜æ˜¯ç»§æ‰¿çš„çˆ¶ç±»çš„ï¼Œæ²¡æœ‰é‡å†™ã€‚</p>
<h3 id="3-5"><a href="#3-5" class="headerlink" title="3.5"></a>3.5</h3><p>è¿™ä¸€æ­¥ç›´æ¥è°ƒç”¨äº†ä¸‹ä¸€æ­¥ã€‚</p>
<h3 id="3-6"><a href="#3-6" class="headerlink" title="3.6"></a>3.6</h3><p>å°†eventæ’å…¥ç­‰å¾…äº‹ä»¶é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç„¶åå¼€å§‹è°ƒåº¦è¿™äº›æ¶ˆæ¯ã€‚</p>
<p><em>frameworks/base/core/java/android/view/ViewRootImpl.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueInputEvent</span><span class="params">(InputEvent event,</span></span></div><div class="line">          InputEventReceiver receiver, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> processImmediately) &#123;</div><div class="line">      adjustInputEventForCompatibility(event);</div><div class="line">      <span class="comment">//å°†eventå’Œreceiverå°è£…åœ¨ä¸€èµ·</span></div><div class="line">      QueuedInputEvent q = obtainQueuedInputEvent(event, receiver, flags);</div><div class="line"></div><div class="line">      <span class="comment">// Always enqueue the input event in order, regardless of its time stamp.</span></div><div class="line">      <span class="comment">// We do this because the application or the IME may inject key events</span></div><div class="line">      <span class="comment">// in response to touch events and we want to ensure that the injected keys</span></div><div class="line">      <span class="comment">// are processed in the order they were received and we cannot trust that</span></div><div class="line">      <span class="comment">// the time stamp of injected events are monotonic.</span></div><div class="line">      <span class="comment">//æ‰¾åˆ°å°¾éƒ¨æ’å…¥</span></div><div class="line">      QueuedInputEvent last = mPendingInputEventTail;</div><div class="line">      <span class="keyword">if</span> (last == <span class="keyword">null</span>) &#123;</div><div class="line">          mPendingInputEventHead = q;</div><div class="line">          mPendingInputEventTail = q;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          last.mNext = q;</div><div class="line">          mPendingInputEventTail = q;</div><div class="line">      &#125;</div><div class="line">      mPendingInputEventCount += <span class="number">1</span>;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (processImmediately) &#123;</div><div class="line">          <span class="comment">//ç«‹å³å¤„ç†æ‰€æœ‰çš„InputEvent</span></div><div class="line">          doProcessInputEvents();</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//å‘é€ä¸€ä¸ªæé†’æ¶ˆæ¯</span></div><div class="line">          scheduleProcessInputEvents();</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><br>è¿™é‡Œä¼šæœ‰ä¸¤ç§ä¸åŒçš„å¤„ç†eventçš„æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯ç«‹å³å¤„ç†ï¼›å¦ä¸€ç§æ˜¯å‘ä¸»çº¿ç¨‹Looperå‘é€<code>MSG_PROCESS_INPUT_EVENTS</code>æ¶ˆæ¯ã€‚è¿™é‡Œé€‰æ‹©ç«‹å³å¤„ç†ã€‚</p>
<h3 id="3-7"><a href="#3-7" class="headerlink" title="3.7"></a>3.7</h3><p>è¿™é‡Œä¼šæŠŠç­‰å¾…åœ¨é˜Ÿåˆ—ä¸­çš„eventï¼Œä¸€å£æ°”å…¨å¤„ç†äº†ã€‚è¿™ä¸€æ­¥ä¼šå¾ªç¯æ‹¿å‡ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªeventï¼Œç„¶åè°ƒç”¨ä¸‹ä¸€æ­¥è¿›è¡Œå¤„ç†ã€‚</p>
<h3 id="3-8"><a href="#3-8" class="headerlink" title="3.8"></a>3.8</h3><p>å‡†å¤‡äº¤ç»™stageå¤„ç†ã€‚</p>
<p><em>frameworks/base/core/java/android/view/ViewRootImpl.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverInputEvent</span><span class="params">(QueuedInputEvent q)</span> </span>&#123;</div><div class="line"><span class="comment">//...</span></div><div class="line"><span class="comment">//ä¸‹é¢å¼€å§‹ä»æŸä¸ªstageå¼€å§‹</span></div><div class="line"><span class="comment">//å¯»æ‰¾é€‚åˆçš„stageè¿›è¡Œå¤„ç†</span></div><div class="line">       InputStage stage;</div><div class="line">       <span class="keyword">if</span> (q.shouldSendToSynthesizer()) &#123;</div><div class="line">           stage = mSyntheticInputStage;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           stage = q.shouldSkipIme() ? mFirstPostImeInputStage : mFirstInputStage;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (stage != <span class="keyword">null</span>) &#123;</div><div class="line">           stage.deliver(q);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           finishInputEvent(q);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-9"><a href="#3-9" class="headerlink" title="3.9"></a>3.9</h3><p>ä¸‹é¢å°±è®²è§£ä¸€ä¸‹stageæ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚stageå¯ä»¥è¯´æ˜¯å¤„ç†eventçš„ä¸åŒé˜¶æ®µï¼Œå¦‚æœä¸Šä¸€ä¸ªstageå¤„ç†ä¸äº†ï¼Œå°±äº¤ç»™ä¸‹ä¸€ä¸ªstageå¤„ç†ï¼Œæ€»æœ‰ä¸€ä¸ªstageå¯ä»¥å°†eventå¤„ç†æ‰ã€‚è¿™é‡Œstageçš„å¤„ç†é¡ºåºå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://img.blog.csdn.net/20160927223222813" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>NativePrelmeInputStage: Delivers pre-ime input events to a native activity. Does not support pointer events. å…¶å®æˆ‘ä¹Ÿä¸æ¸…æ¥šåˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œæ²¡æœ‰æƒ³åˆ°å…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚</li>
<li>ViewPreImeInputStage: Delivers pre-ime input events to the view hierarchy. Does not support pointer events. è¿™ä¸€æ­¥åªå¤„ç†KeyEventï¼Œåœ¨InputMethodå¤„ç†è¿™ä¸ªKeyEventä¹‹å‰ï¼Œå¯ä»¥æˆªè·è¿™ä¸ªeventã€‚å…¸å‹çš„ä¾‹å­æ˜¯å¤„ç†BACK keyã€‚</li>
<li>ImeInputStage: Delivers input events to the ime. Does not support pointer events. å°†eventäº¤ç»™IputMethodManagerå¤„ç†ã€‚</li>
<li>EarlyPostImeInputStage: Performs early processing of post-ime input events. åœ¨äº¤ç»™ä¸‹ä¸€é˜¶æ®µä¹‹å‰ï¼Œå…ˆå¤„ç†ç­›é€‰ä¸€äº›eventã€‚</li>
<li>NativePostImeInputStage: Delivers post-ime input events to a native activity. å°è¯•è®©InputQueueå‘é€eventç»™native activityã€‚</li>
<li>ViewPostImeInputStage: Delivers post-ime input events to the view hierarchy. å°†eventå‘é€ç»™viewçš„å±‚æ¬¡ç»“æ„ä¸­ã€‚</li>
<li>SyntheticInputStage: Performs synthesis of new input events from unhandled input events. æœ€åä¸€ä¸ªé˜¶æ®µï¼Œå¤„ç†ç»¼åˆäº‹ä»¶ï¼Œæ¯”å¦‚trackball, joystickç­‰ã€‚</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬æš‚ä¸”ç ”ç©¶ç¬¬6ç§stageï¼Œè¿™ä¸ªstageå’ŒViewæœ‰ç›´æ¥å…³ç³»ã€‚</p>
<h3 id="3-10"><a href="#3-10" class="headerlink" title="3.10"></a>3.10</h3><p>è¿™é‡Œæ ¹æ®eventçš„ç±»å‹åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬å…ˆå…³æ³¨ä¸€ä¸‹PointerEventå¦‚ä½•å¤„ç†çš„ã€‚</p>
<h3 id="3-11"><a href="#3-11" class="headerlink" title="3.11"></a>3.11</h3><p>å°†eventäº¤ç»™mViewæ¥å¤„ç†ï¼Œè¿™é‡ŒmViewå°±æ˜¯ä¸€ä¸ªDecorViewå¯¹è±¡ã€‚</p>
<h3 id="3-12"><a href="#3-12" class="headerlink" title="3.12"></a>3.12</h3><p>è¿™ä¸€æ­¥æ˜¯DecorViewç»§æ‰¿è‡ªViewçš„æ–¹æ³•ï¼Œå°†eventåˆ†ä¸ºTouchEventå’ŒGenericMotionEventæ¥å¤„ç†ã€‚å…ˆçœ‹TouchEventå¦‚ä½•å¤„ç†ã€‚</p>
<h3 id="3-13"><a href="#3-13" class="headerlink" title="3.13"></a>3.13</h3><p>DecorViewé‡å†™äº†è¯¥å‡½æ•°ã€‚è¿™é‡Œè°ƒç”¨<code>getCallback</code>å‡½æ•°æ¥è·å–ä¸€ä¸ªå›è°ƒå¯¹è±¡ã€‚è¯¥å‡½æ•°æ˜¯PhoneWindowç»§æ‰¿è‡ªWindowç±»çš„æ–¹æ³•ï¼Œè·å¾—æ˜¯mCallbackã€‚é‚£ä¹ˆè¿™ä¸ªmCallbackåˆ°åº•æ˜¯è°å‘¢ï¼Ÿ</p>
<p>å›é¡¾ä¸€ä¸‹Activityçš„åˆ›å»ºè¿‡ç¨‹ï¼Œåœ¨Activityåˆ›å»ºä»¥åä¼šè°ƒç”¨attachå‡½æ•°å¯¹Activityè¿›è¡Œä¸€å®šçš„åˆå§‹åŒ–ï¼Œå…¶ä¸­å°±åˆ›å»ºäº†PhoneWindowï¼ŒåŒæ—¶è®¾ç½®äº†callbackä¸ºActivityå®ƒè‡ªå·±ã€‚æ‰€ä»¥è¿™ä¸€æ­¥è·å¾—æ˜¯ä¸€ä¸ªActivityå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„å‡½æ•°ç»§ç»­åˆ†å‘eventã€‚</p>
<h3 id="3-14"><a href="#3-14" class="headerlink" title="3.14"></a>3.14</h3><p>Eventäº¤åˆ°Activityæ‰‹ä¸­è¿›è¡Œå¤„ç†ã€‚ä¸ºä»€ä¹ˆä¼šå…ˆäº¤ç»™Activityå¤„ç†ï¼Ÿç›®çš„æ˜¯è®©å¼€å‘è€…å¯ä»¥é‡å†™è¿™ä¸ªå‡½æ•°ï¼Œä»è€Œå¯ä»¥åœ¨åˆ†å‘è¿™ä¸ªäº‹ä»¶ä¹‹å‰è¿›è¡Œæˆªè·ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Called to process touch screen events.  You can override this to</div><div class="line"> * intercept all touch screen events before they are dispatched to the</div><div class="line"> * window.  Be sure to call this implementation for touch screen events</div><div class="line"> * that should be handled normally.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> ev The touch screen event.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> boolean Return true if this event was consumed.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">        onUserInteraction();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ç»•ä¸€åœˆæœ‰äº¤ç»™PhoneWindowå¤„ç†</span></div><div class="line">    <span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ²¡æœ‰viewå¯ä»¥å¤„ç†ï¼Œé‚£ä¹ˆactivityè‡ªå·±å¤„ç†</span></div><div class="line">    <span class="comment">//é»˜è®¤å°±æ˜¯æ”¾å¼ƒï¼Œä¹Ÿå¯ä»¥é‡å†™å®ç°ç‰¹å®šåŠŸèƒ½</span></div><div class="line">    <span class="keyword">return</span> onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-15"><a href="#3-15" class="headerlink" title="3.15"></a>3.15</h3><p>ä»€ä¹ˆä¹Ÿæ²¡åšï¼Œå°†eventä¼ å›DecorViewï¼Œè®©å®ƒå¤„ç†ã€‚</p>
<p>###3.16<br>è¿™é‡ŒDecorViewåˆäº¤ç»™dispatchTouchEventå¤„ç†ã€‚è¿™é‡Œçš„dispatchTouchEventæ˜¯æºè‡ªçˆ¶ç±»ViewGroupçš„å‡½æ•°ï¼Œè€Œä¸æ˜¯è‡ªå·±é‡å†™çš„å‡½æ•°ã€‚</p>
<p>###3.17<br>ViewGroupæ˜¯Viewçš„å­ç±»ã€‚å®ƒç®¡ç†äº†ä¸€ç»„Viewåœ¨mChildrenæ•°ç»„ä¸­ï¼ŒæŒ‰ç…§è®¾è®¡æ¨¡å¼çš„è¯´æ³•å«Compositeæ¨¡å¼ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160927225350157" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<p>è¿™ä¸€æ­¥ä¼šä¾æ¬¡è®¿é—®æ¯ä¸ªå­viewï¼Œåˆ¤æ–­ä»–ä»¬æ˜¯å¦å¯ä»¥å¤„ç†è¯¥eventï¼Œå¦‚æœèƒ½å°±äº¤ç»™å®ƒå¤„ç†ï¼›æ²¡äººèƒ½å¤„ç†å°±è‡ªå·±å¤„ç†ã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œéƒ½ä¼šè°ƒç”¨ä¸‹ä¸€æ­¥<code>dispatchTransformedTouchEvent</code>å‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/java/android/view/ViewGroup.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    <span class="comment">//..</span></div><div class="line">    <span class="comment">// If the event targets the accessibility focused view and this is it, start</span></div><div class="line">    <span class="comment">// normal event dispatch. Maybe a descendant is what will handle the click.</span></div><div class="line">    <span class="keyword">if</span> (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123;</div><div class="line">        ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">//å¦‚æœWindowæ²¡æœ‰è¢«é®ä½ï¼Œæ‰è¿›è¡Œä»¥ä¸‹è¿‡ç¨‹</span></div><div class="line">    <span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</div><div class="line">        <span class="comment">//..</span></div><div class="line">        TouchTarget newTouchTarget = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</div><div class="line">                <span class="comment">//..</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line">                <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line">                    <span class="comment">// Find a child that can receive the event.</span></div><div class="line">                    <span class="comment">// Scan children from front to back.</span></div><div class="line">                    <span class="comment">//æ ¹æ®zåæ ‡è¿›è¡Œæ’åºï¼Œä»å°åˆ°å¤§çš„é¡ºåº</span></div><div class="line">                    <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</div><div class="line">                    <span class="comment">//ä¹Ÿå¯ä»¥è‡ªå·±å®šåˆ¶é¡ºåº</span></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line">                            &amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line">                    <span class="comment">//æ‰€æœ‰å­Viewå­˜æ”¾åœ¨mChildrenä¸­</span></div><div class="line">                    <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">                    <span class="comment">//æŒ‰zçš„å€¼ï¼Œä»å¤§åˆ°å°å¼€å§‹éå†</span></div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> childIndex = customOrder</div><div class="line">                                ? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line">                        <span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line">                                ? children[childIndex] : preorderedList.get(childIndex);</div><div class="line"></div><div class="line">                        <span class="comment">// If there is a view that has accessibility focus we want it</span></div><div class="line">                        <span class="comment">// to get the event first and if not handled we will perform a</span></div><div class="line">                        <span class="comment">// normal dispatch. We may do a double iteration but this is</span></div><div class="line">                        <span class="comment">// safer given the timeframe.</span></div><div class="line">                        <span class="comment">//å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªviewå»è·å¾—è¿™ä¸ªeventï¼Œä¸€ç›´å¾ªç¯åˆ°é‚£ä¸ªviewä¸ºæ­¢</span></div><div class="line">                        <span class="keyword">if</span> (childWithAccessibilityFocus != <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="keyword">if</span> (childWithAccessibilityFocus != child) &#123;</div><div class="line">                                <span class="keyword">continue</span>;</div><div class="line">                            &#125;</div><div class="line">                            childWithAccessibilityFocus = <span class="keyword">null</span>;</div><div class="line">                            i = childrenCount - <span class="number">1</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">//åˆ¤æ–­è¯¥viewæ˜¯å¦å¯ä»¥æ¥å—è¿™ä¸ªeventï¼Œæ˜¯å¦åœ¨è¿™ä¸ªviewèŒƒå›´å†…</span></div><div class="line">                        <span class="keyword">if</span> (!canViewReceivePointerEvents(child)</div><div class="line">                                || !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</div><div class="line">                            ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">//å¦‚æœè¯¥childæ­£åœ¨å¤„ç†ä¸Šä¸€ä¸ªevent</span></div><div class="line">                        newTouchTarget = getTouchTarget(child);</div><div class="line">                        <span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// Child is already receiving touch within its bounds.</span></div><div class="line">                            <span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></div><div class="line">                            newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//å°è¯•å»å‘è¯¥childå‘é€event</span></div><div class="line">                        <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line">                            <span class="comment">// Child wants to receive touch within its bounds.</span></div><div class="line">                            <span class="comment">//..</span></div><div class="line">                            <span class="comment">//å°†childåŠ å…¥mFirstTouchTargetä¸ºé¦–çš„é˜Ÿåˆ—å¤´éƒ¨</span></div><div class="line">                            newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">                            alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//..</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Dispatch to touch targets.</span></div><div class="line">        <span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</div><div class="line">     <span class="comment">//æ²¡æœ‰childå¯ä»¥å¤„ç†ï¼Œé‚£ä¹ˆå°±è‡ªå·±å¤„ç†</span></div><div class="line">            <span class="comment">// No touch targets so treat this as an ordinary view.</span></div><div class="line">            handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</div><div class="line">                    TouchTarget.ALL_POINTER_IDS);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></div><div class="line">            <span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></div><div class="line">            TouchTarget predecessor = <span class="keyword">null</span>;</div><div class="line">            TouchTarget target = mFirstTouchTarget;</div><div class="line">            <span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> TouchTarget next = target.next;</div><div class="line">                <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</div><div class="line">                    handled = <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">//..</span></div><div class="line">                    <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</div><div class="line">                            target.child, target.pointerIdBits)) &#123;</div><div class="line">                        handled = <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//..</span></div><div class="line">                &#125;</div><div class="line">                predecessor = target;</div><div class="line">                target = next;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//..</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-18"><a href="#3-18" class="headerlink" title="3.18"></a>3.18</h3><p>ViewGroupä¼šå†³å®šè‡ªå·±å¤„ç†è¿˜æ˜¯äº¤ç»™childå¤„ç†ã€‚åœ¨ViewGroupè‡ªå·±å¤„ç†ï¼Œæˆ–è€…childä¸ºä¸å†æ˜¯ä¸€ä¸ªViewGroupæ—¶ï¼Œåˆ™å¼€å§‹è°ƒç”¨Viewçš„dispatchTouchEventå‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/java/android/view/ViewGroup.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//çœç•¥äº†è®¡ç®—åæ ‡ä¾¿å®œçš„è¿‡ç¨‹</span></div><div class="line"><span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">	<span class="comment">//ViewGroupå†³å®šè‡ªå·±å¤„ç†</span></div><div class="line">	handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="comment">//äº¤ç»™childå¤„ç†ï¼Œchildå¯èƒ½æ˜¯ä¸ªview</span></div><div class="line">	<span class="comment">//ä¹Ÿå¯èƒ½è¿˜æ˜¯ä¸ªViewGroupï¼Œè¿™å°±é‡å¤3.17æ­¥éª¤</span></div><div class="line">        handled = child.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-19"><a href="#3-19" class="headerlink" title="3.19"></a>3.19</h3><p>è¿™ä¸€æ­¥å°±ä¼šè°ƒç”¨ç”¨æˆ·è‡ªå·±å®ç°çš„Listenerï¼›å¦‚æœæ²¡æœ‰Listenerï¼Œåˆ™ä¼šè°ƒç”¨viewé»˜è®¤çš„å¤„ç†å‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/java/android/view/View.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">      <span class="comment">// If the event should be handled by accessibility focus first.</span></div><div class="line">      <span class="keyword">if</span> (event.isTargetAccessibilityFocus()) &#123;</div><div class="line">          <span class="comment">// We don't have focus or no virtual descendant has it, do not handle the event.</span></div><div class="line">          <span class="keyword">if</span> (!isAccessibilityFocusedViewOrHost()) &#123;</div><div class="line">              <span class="comment">//è¯¥Viewä¸å¯è®¿é—®çš„çŠ¶æ€ï¼Œè¿”å›</span></div><div class="line">              <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">      <span class="comment">//..</span></div><div class="line">      <span class="comment">//å…ˆåˆ¤æ–­è¯¥Viewæ˜¯å¦è¢«é®æŒ¡ï¼Œæ²¡è¢«é®æŒ¡æ‰è¿›è¡Œå¤„ç†</span></div><div class="line">      <span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">          <span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line">          <span class="comment">//è·å¾—æ³¨å†Œçš„Listenerï¼Œçœ‹æ˜¯å¦æœ‰æ³¨å†ŒOnTouchListener</span></div><div class="line">          ListenerInfo li = mListenerInfo;</div><div class="line">          <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line">                  &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">                  &amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line">                    <span class="comment">//è°ƒç”¨Listenerçš„å›è°ƒå‡½æ•°ï¼Œå¤„ç†event</span></div><div class="line">              result = <span class="keyword">true</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">//Viewä¹Ÿå¯ä»¥é‡‡ç”¨é»˜è®¤çš„å¤„ç†onTouchEvent</span></div><div class="line">          <span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">              result = <span class="keyword">true</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//..</span></div><div class="line">      <span class="keyword">return</span> result;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><br>é»˜è®¤å¤„ç†å‡½æ•°onTouchEventä¼šå¤„ç†ä¸€äº›åŸºæœ¬çš„æ“ä½œï¼Œæ¯”å¦‚buttonçš„æŒ‰ä¸‹æ¾å¼€çš„æ•ˆæœï¼Œæ»šåŠ¨å®¹å™¨äº§ç”Ÿæ»šåŠ¨çš„æ•ˆæœç­‰ã€‚</p>
<h3 id="3-20"><a href="#3-20" class="headerlink" title="3.20"></a>3.20</h3><p>åœ¨InputStageå®Œæˆå¤„ç†eventçš„ä»»åŠ¡åï¼Œä¼šå¼€å§‹è¿”å›å®Œæˆçš„æ¶ˆæ¯ã€‚</p>
<h3 id="3-21"><a href="#3-21" class="headerlink" title="3.21"></a>3.21</h3><p>å¼€å§‹è°ƒç”¨c++å‡½æ•°ã€‚</p>
<h3 id="3-22"><a href="#3-22" class="headerlink" title="3.22"></a>3.22</h3><p>å°†æŒ‡é’ˆè½¬åŒ–ä¸ºNativeInputEventReceiveræŒ‡é’ˆï¼Œäº¤ç»™å®ƒæ¥å¤„ç†ã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputEventReceiver.cpp ï¼š</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sp&lt;NativeInputEventReceiver&gt; receiver = <span class="keyword">reinterpret_cast</span>&lt;NativeInputEventReceiver*&gt;(receiverPtr);</div><div class="line"></div><div class="line"><span class="keyword">status_t</span> status = receiver-&gt;finishInputEvent(seq, handled);</div></pre></td></tr></table></figure></p>
<h3 id="3-23"><a href="#3-23" class="headerlink" title="3.23"></a>3.23</h3><p>InputConsumerä¾æ¬¡å¤„ç†æ¯ä¸ªsequenceï¼Œå‘é€å®Œæˆä¿¡å·ã€‚</p>
<h3 id="3-24"><a href="#3-24" class="headerlink" title="3.24"></a>3.24</h3><p>å‘channelå‘é€å®Œæˆæ¶ˆæ¯ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> InputConsumer::sendUnchainedFinishedSignal(<span class="keyword">uint32_t</span> seq, <span class="keyword">bool</span> handled) &#123;</div><div class="line">    InputMessage msg;</div><div class="line">    msg.header.type = InputMessage::TYPE_FINISHED;</div><div class="line">    msg.body.finished.seq = seq;</div><div class="line">    msg.body.finished.handled = handled;</div><div class="line">    <span class="keyword">return</span> mChannel-&gt;sendMessage(&amp;msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‘Channelå†™å…¥äº‹ä»¶åï¼Œå¤„äºç¡çœ çš„InputDispatcherè¢«å”¤é†’ï¼Œå¼€å§‹åˆ†å‘ä¸‹ä¸€ä¸ªeventã€‚</p>
<h2 id="æœ€åè¯´ä¸¤å¥"><a href="#æœ€åè¯´ä¸¤å¥" class="headerlink" title="æœ€åè¯´ä¸¤å¥"></a>æœ€åè¯´ä¸¤å¥</h2><p>åˆ°è¿™é‡Œï¼ŒInput eventçš„å¤„ç†æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œå¿ƒå¥½ç´¯ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹&quot;&gt;&lt;/a&gt;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ13ï¼‰ï¼šInputæ¶ˆæ¯çš„åˆ†å‘è¿‡ç¨‹&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚å­¦æ ¡ç”µè„‘å¥½æ¸£ï¼Œçœ‹æºç æ—¶å¡åŠå¤©&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;p&gt;å…ˆå›é¡¾ä¸€ä¸‹å‰ä¸¤ç¯‡æ–‡ç« ã€‚åœ¨è®¾å¤‡æ²¡æœ‰äº‹ä»¶è¾“å…¥çš„æ—¶å€™ï¼ŒInputReaderå’ŒInputDispatcheréƒ½å¤„äºç¡çœ çŠ¶æ€ã€‚å½“è¾“å…¥äº‹ä»¶å‘ç”Ÿï¼ŒInputReaderé¦–å…ˆè¢«æ¿€æ´»ï¼Œç„¶åå‘é€è¯»å–æ¶ˆæ¯ï¼Œæ¿€æ´»Dispatcherã€‚Dispatcherè¢«æ¿€æ´»ä»¥åï¼Œå°†æ¶ˆæ¯å‘é€ç»™å½“å‰æ¿€æ´»çª—å£çš„ä¸»çº¿ç¨‹ï¼Œç„¶åç¡çœ ç­‰å¾…ä¸»çº¿ç¨‹å¤„ç†å®Œè¿™ä¸ªäº‹ä»¶ã€‚ä¸»çº¿ç¨‹è¢«æ¿€æ´»åï¼Œä¼šå¤„ç†ç›¸åº”çš„æ¶ˆæ¯ï¼Œå¤„ç†å®Œæ¯•ååé¦ˆç»™Dispatcherï¼Œä»è€ŒDispatcherå¯ä»¥ç»§ç»­å‘é€æ¶ˆæ¯ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-InputReaderè·å–äº‹ä»¶&quot;&gt;&lt;a href=&quot;#1-InputReaderè·å–äº‹ä»¶&quot; class=&quot;headerlink&quot; title=&quot;1. InputReaderè·å–äº‹ä»¶&quot;&gt;&lt;/a&gt;1. InputReaderè·å–äº‹ä»¶&lt;/h2&gt;&lt;p&gt;å›é¡¾ä¸€ä¸‹ç¬¬11ç« 4.2ä¸­ï¼ŒInputReaderçº¿ç¨‹åœ¨è·å–äº‹ä»¶ä»¥åï¼Œä¼šè°ƒç”¨&lt;code&gt;processEventsLocked(mEventBuffer, count);&lt;/code&gt;å¤„ç†äº‹ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160927222615741&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(12):InputChannelçš„æ³¨å†Œè¿‡ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-12-InputChannel%E7%9A%84%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-12-InputChannelçš„æ³¨å†Œè¿‡ç¨‹/</id>
    <published>2017-02-14T06:24:58.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ </p>
</blockquote>
<p>InputManagerå¯ä»¥è·å¾—è¾“å…¥äº‹ä»¶å¹¶åˆ†å‘ï¼ŒActivityéœ€è¦å¤„ç†è¿™äº›è¾“å…¥äº‹ä»¶ã€‚é‚£ä¹ˆï¼Œè¿™ä¸¤è€…ä¹‹é—´å¦‚ä½•å»ºç«‹çš„è¿æ¥å‘¢ï¼Ÿè¿™å°±éœ€è¦InputChannelä½œä¸ºæ¡¥æ¢å»ºç«‹ä¸¤è€…ä¹‹é—´çš„é€šé“ã€‚</p>
<h2 id="1-ViewRootImplåˆ›å»ºInputChannel"><a href="#1-ViewRootImplåˆ›å»ºInputChannel" class="headerlink" title="1. ViewRootImplåˆ›å»ºInputChannel"></a>1. ViewRootImplåˆ›å»ºInputChannel</h2><p>è¿™é‡ŒViewRootç±»å·²ç»æ¶ˆå¤±äº†ï¼Œç”±ViewRootImplæ›¿ä»£ã€‚Activityåœ¨åˆ›å»ºæ—¶ä¼šå°†è‡ªå·±çš„DecorViewè®¾ç½®ç»™å¯¹åº”çš„ViewRootImplã€‚</p>
<p><img src="http://img.blog.csdn.net/20160924164736978" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<a id="more"></a>
<h3 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h3><p>è¿™ä¸€æ­¥ä¼šåˆ›å»ºclientçš„InputChannelï¼Œå¹¶ä¸”å°†å½“å‰å¯åŠ¨çš„Activityçš„çª—å£ä¼ é€’ç»™WindowManagerServiceã€‚</p>
<p><em>frameworks/base/core/java/android/view/ViewRootImpl.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * We have one child</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//å°†viewè®¾ç½®ä¸ºä¼ å…¥çš„DecorView</span></div><div class="line">            mView = view;</div><div class="line">            <span class="comment">//..</span></div><div class="line"></div><div class="line">            mAdded = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">int</span> res; <span class="comment">/* = WindowManagerImpl.ADD_OKAY; */</span></div><div class="line"></div><div class="line">            <span class="comment">//æ–°å»ºInputChannel</span></div><div class="line">            <span class="keyword">if</span> ((mWindowAttributes.inputFeatures</div><div class="line">                    &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</div><div class="line">                mInputChannel = <span class="keyword">new</span> InputChannel();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mOrigWindowType = mWindowAttributes.type;</div><div class="line">                mAttachInfo.mRecomputeGlobalAttributes = <span class="keyword">true</span>;</div><div class="line">                collectViewAttributes();</div><div class="line">                <span class="comment">//mWindowSessionæ˜¯ä¸€ä¸ªBinderä»£ç†å¯¹è±¡</span></div><div class="line">                <span class="comment">//å®ƒå¼•ç”¨äº†è¿è¡Œåœ¨WindowManagerServiceä¸­çš„ä¸€ä¸ªç±»å‹ä¸ºSessionçš„Binderæœ¬åœ°å¯¹è±¡</span></div><div class="line">                <span class="comment">//å‘WindowManagerServiceæ·»åŠ æ­£åœ¨å¯åŠ¨çš„Activityçš„çª—å£</span></div><div class="line">                <span class="comment">//è¿™é‡Œè¿˜ä¼šå°†InputChannelä¼ é€’è¿‡å»</span></div><div class="line">                res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</div><div class="line">                        getHostVisibility(), mDisplay.getDisplayId(),</div><div class="line">                        mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</div><div class="line">                        mAttachInfo.mOutsets, mInputChannel);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                <span class="comment">//..</span></div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="comment">//..</span></div><div class="line">            &#125;</div><div class="line">            <span class="comment">//..</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span> (view <span class="keyword">instanceof</span> RootViewSurfaceTaker) &#123;</div><div class="line">                mInputQueueCallback =</div><div class="line">                    ((RootViewSurfaceTaker)view).willYouTakeTheInputQueue();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mInputChannel != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (mInputQueueCallback != <span class="keyword">null</span>) &#123;</div><div class="line">                    mInputQueue = <span class="keyword">new</span> InputQueue();</div><div class="line">                    mInputQueueCallback.onInputQueueCreated(mInputQueue);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//å°†InputChannelå’Œä¸»çº¿ç¨‹å…³è”èµ·æ¥ï¼Œåœ¨ä¸‹é¢ä¼šè¯¦ç»†è®²è§£</span></div><div class="line">                mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel,</div><div class="line">                        Looper.myLooper());</div><div class="line">            &#125;</div><div class="line">            view.assignParent(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-2"><a href="#1-2" class="headerlink" title="1.2"></a>1.2</h3><p>è¿™ä¸€æ­¥æ˜¯è¿›ç¨‹é—´çš„è¯·æ±‚ï¼Œä»åº”ç”¨è¿›ç¨‹è½¬åˆ°WindowManagerServiceè¿›ç¨‹ï¼Œå¯¹åº”äº1.1ä¸­çš„å‡½æ•°addToDisplayã€‚è¿™é‡Œä¼šè¡¥è¶³ä¸€äº›å‚æ•°ï¼Œå¼€å§‹è°ƒç”¨ä¸‹ä¸€æ­¥å‡½æ•°ã€‚</p>
<h3 id="1-3"><a href="#1-3" class="headerlink" title="1.3"></a>1.3</h3><p>è¿™ä¸€æ­¥ä¹Ÿæ˜¯è°ƒæ•´ä¸€äº›å‚æ•°ï¼Œç„¶åäº¤ç»™WindowManagerServiceæ¥å¤„ç†ã€‚</p>
<h3 id="1-4"><a href="#1-4" class="headerlink" title="1.4"></a>1.4</h3><p>è¿™é‡Œä¼šå°†ä¼ å…¥çš„Windowå­˜å…¥Mapæ¥è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼ŒåŒæ—¶åˆ›å»ºäº†ä¸€å¯¹server/clientç«¯çš„InputChannelã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addWindow</span><span class="params">(Session session, IWindow client, <span class="keyword">int</span> seq,</span></span></div><div class="line">         WindowManager.LayoutParams attrs, <span class="keyword">int</span> viewVisibility, <span class="keyword">int</span> displayId,</div><div class="line">         Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</div><div class="line">         InputChannel outInputChannel) &#123;</div><div class="line"></div><div class="line">         <span class="comment">//å…ˆå¯¹æ·»åŠ çš„windowåšä¸€äº›æ£€æŸ¥ï¼Œçœç•¥..</span></div><div class="line"></div><div class="line">         <span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªWindowSateteå¯¹è±¡</span></div><div class="line">         WindowState win = <span class="keyword">new</span> WindowState(<span class="keyword">this</span>, session, client, token,</div><div class="line">                 attachedWindow, appOp[<span class="number">0</span>], seq, attrs, viewVisibility, displayContent);</div><div class="line"></div><div class="line">         <span class="comment">//..</span></div><div class="line">         </div><div class="line">         <span class="keyword">if</span> (outInputChannel != <span class="keyword">null</span> &amp;&amp; (attrs.inputFeatures</div><div class="line">                 &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == <span class="number">0</span>) &#123;</div><div class="line">             String name = win.makeInputChannelName();</div><div class="line">             <span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªInputChannelå¯¹ï¼Œåœ¨1.5ä¸­è¯¦ç»†è®²è§£</span></div><div class="line">             InputChannel[] inputChannels = InputChannel.openInputChannelPair(name);</div><div class="line">             <span class="comment">//ä¸€ä¸ªæ”¾åœ¨WindowStateé‡Œä½œä¸ºserverç«¯çš„InputChannel</span></div><div class="line">             win.setInputChannel(inputChannels[<span class="number">0</span>]);</div><div class="line">             <span class="comment">//ä¸€ä¸ªè½¬åŒ–ä¸ºclientä¼ é€’è¿‡æ¥çš„outInputChannel</span></div><div class="line">             inputChannels[<span class="number">1</span>].transferTo(outInputChannel);</div><div class="line">             <span class="comment">//ä»ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„1.1å¯çŸ¥ï¼ŒInputManagerä½œä¸ºå‚æ•°ä¼ å…¥</span></div><div class="line">             <span class="comment">//WindowManagerServiceçš„æ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å­˜æ”¾åœ¨mInputManagerä¸­</span></div><div class="line">             <span class="comment">//ä¸‹é¢ç« èŠ‚ä¼šè¯¦ç»†è®²è¿°å¦‚ä½•æ³¨å†Œserverç«¯çš„InputChannel</span></div><div class="line">             mInputManager.registerInputChannel(win.mInputChannel, win.mInputWindowHandle);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="comment">// From now on, no exceptions or errors allowed!</span></div><div class="line">         <span class="comment">//å°†winæ”¾å…¥mWindowMapï¼Œä»¥clientçš„binderä¸ºå…³é”®å­—</span></div><div class="line">         mWindowMap.put(client.asBinder(), win);</div><div class="line">       </div><div class="line">         <span class="comment">//å°†winåŠ å…¥ç›¸åº”çš„listï¼Œçœç•¥..</span></div><div class="line"></div><div class="line">         mInputMonitor.setUpdateInputWindowsNeededLw();</div><div class="line"></div><div class="line">         <span class="keyword">boolean</span> focusChanged = <span class="keyword">false</span>;</div><div class="line">         <span class="keyword">if</span> (win.canReceiveKeys()) &#123;</div><div class="line">             focusChanged = updateFocusedWindowLocked(UPDATE_FOCUS_WILL_ASSIGN_LAYERS,</div><div class="line">                     <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>);</div><div class="line">             <span class="keyword">if</span> (focusChanged) &#123;</div><div class="line">                 imMayMove = <span class="keyword">false</span>;</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (imMayMove) &#123;</div><div class="line">             moveInputMethodWindowsIfNeededLocked(<span class="keyword">false</span>);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         assignLayersLocked(displayContent.getWindowList());</div><div class="line">         <span class="comment">// Don't do layout here, the window must call</span></div><div class="line">         <span class="comment">// relayout to be displayed, so we'll do it there.</span></div><div class="line"></div><div class="line">         <span class="keyword">if</span> (focusChanged) &#123;</div><div class="line">             mInputMonitor.setInputFocusLw(mCurrentFocus, <span class="keyword">false</span> <span class="comment">/*updateInputWindows*/</span>);</div><div class="line">         &#125;</div><div class="line">         mInputMonitor.updateInputWindowsLw(<span class="keyword">false</span> <span class="comment">/*force*/</span>);</div><div class="line"></div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">return</span> res;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-5"><a href="#1-5" class="headerlink" title="1.5"></a>1.5</h3><p>è¿™ä¸€æ­¥ä¼šå°†ä»»åŠ¡äº¤ç»™c++å±‚æ¥å¤„ç†ã€‚</p>
<h3 id="1-6"><a href="#1-6" class="headerlink" title="1.6"></a>1.6</h3><p>è¿™ä¸€æ­¥å¯¹åº”çš„c++çš„å‡½æ•°ä¸º<code>android_view_InputChannel_nativeOpenInputChannelPair</code>ï¼Œå®ƒä¼šåˆ›å»ºä¸¤ä¸ªInputChannelï¼Œå¹¶è¿”å›ã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputChannel.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> jobjectArray <span class="title">android_view_InputChannel_nativeOpenInputChannelPair</span><span class="params">(JNIEnv* env,</span></span></div><div class="line">        jclass clazz, jstring nameObj) &#123;</div><div class="line">    <span class="comment">//å°†java Stringå˜ä¸ºchar*</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* nameChars = env-&gt;GetStringUTFChars(nameObj, <span class="literal">NULL</span>);</div><div class="line">    <span class="function">String8 <span class="title">name</span><span class="params">(nameChars)</span></span>;</div><div class="line">    env-&gt;ReleaseStringUTFChars(nameObj, nameChars);</div><div class="line"></div><div class="line">    sp&lt;InputChannel&gt; serverChannel;</div><div class="line">    sp&lt;InputChannel&gt; clientChannel;</div><div class="line">    <span class="comment">//åˆ›å»ºc++å±‚çš„ä¸¤ä¸ªChannelï¼Œå°†åœ¨ä¸‹ä¸€æ­¥è¯¦ç»†è®²è§£</span></div><div class="line">    <span class="keyword">status_t</span> result = InputChannel::openInputChannelPair(name, serverChannel, clientChannel);</div><div class="line">    </div><div class="line">    jobjectArray channelPair = env-&gt;NewObjectArray(<span class="number">2</span>, gInputChannelClassInfo.clazz, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºjavaçš„server channel</span></div><div class="line">    jobject serverChannelObj = android_view_InputChannel_createInputChannel(env,</div><div class="line">            <span class="keyword">new</span> NativeInputChannel(serverChannel));</div><div class="line">    <span class="comment">//åˆ›å»ºjavaçš„client channel</span></div><div class="line">    jobject clientChannelObj = android_view_InputChannel_createInputChannel(env,</div><div class="line">            <span class="keyword">new</span> NativeInputChannel(clientChannel));</div><div class="line">    <span class="comment">//å­˜å…¥javaæ•°ç»„</span></div><div class="line">    env-&gt;SetObjectArrayElement(channelPair, <span class="number">0</span>, serverChannelObj);</div><div class="line">    env-&gt;SetObjectArrayElement(channelPair, <span class="number">1</span>, clientChannelObj);</div><div class="line">    <span class="keyword">return</span> channelPair;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="1-7"><a href="#1-7" class="headerlink" title="1.7"></a>1.7</h3><p>æ³¨æ„ï¼Œè¿™ä¸€æ­¥çœŸçš„è¦åˆ›å»ºChannelPairäº†ã€‚</p>
<p><em>frameworks/native/libs/input/InputTransport.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> InputChannel::openInputChannelPair(<span class="keyword">const</span> String8&amp; name,</div><div class="line">        sp&lt;InputChannel&gt;&amp; outServerChannel, sp&lt;InputChannel&gt;&amp; outClientChannel) &#123;</div><div class="line">    <span class="keyword">int</span> sockets[<span class="number">2</span>];</div><div class="line">    <span class="comment">//è¿™ä¸ªsocketpairå»ºç«‹çš„æ˜¯ä¸€ä¸ªå¯ä»¥åŒå‘é€šä¿¡çš„ç®¡é“ï¼Œåˆ›å»ºä¸€å¯¹å¥—æ¥å­—æè¿°ç¬¦</span></div><div class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_SEQPACKET, <span class="number">0</span>, sockets)) &#123;</div><div class="line">        <span class="keyword">status_t</span> result = -errno;</div><div class="line">        ALOGE(<span class="string">"channel '%s' ~ Could not create socket pair.  errno=%d"</span>,</div><div class="line">                name.<span class="built_in">string</span>(), errno);</div><div class="line">        outServerChannel.clear();</div><div class="line">        outClientChannel.clear();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//è®¾ç½®ç®¡é“ç¼“å­˜çš„å¤§å°</span></div><div class="line">    <span class="keyword">int</span> bufferSize = SOCKET_BUFFER_SIZE;</div><div class="line">    setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</div><div class="line">    setsockopt(sockets[<span class="number">0</span>], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</div><div class="line">    setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</div><div class="line">    setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_RCVBUF, &amp;bufferSize, <span class="keyword">sizeof</span>(bufferSize));</div><div class="line"></div><div class="line">    <span class="comment">//å¼€å§‹new ä¸¤ä¸ªInputChannel</span></div><div class="line">    String8 serverChannelName = name;</div><div class="line">    serverChannelName.append(<span class="string">" (server)"</span>);</div><div class="line">    outServerChannel = <span class="keyword">new</span> InputChannel(serverChannelName, sockets[<span class="number">0</span>]);</div><div class="line"></div><div class="line">    String8 clientChannelName = name;</div><div class="line">    clientChannelName.append(<span class="string">" (client)"</span>);</div><div class="line">    outClientChannel = <span class="keyword">new</span> InputChannel(clientChannelName, sockets[<span class="number">1</span>]);</div><div class="line">    <span class="keyword">return</span> OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>socketpairåˆ›å»ºäº†ä¸€å¯¹æ— åçš„å¥—æ¥å­—æè¿°ç¬¦ï¼ˆåªèƒ½åœ¨AF_UNIXåŸŸä¸­ä½¿ç”¨ï¼‰ï¼Œæè¿°ç¬¦å­˜å‚¨äºä¸€ä¸ªäºŒå…ƒæ•°ç»„s[2] .è¿™å¯¹å¥—æ¥å­—å¯ä»¥è¿›è¡ŒåŒå·¥é€šä¿¡ï¼Œæ¯ä¸€ä¸ªæè¿°ç¬¦æ—¢å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ã€‚è¿™ä¸ªåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ä¹Ÿå¯ä»¥è¿›è¡Œé€šä¿¡ï¼Œå‘s[0]ä¸­å†™å…¥ï¼Œå°±å¯ä»¥ä»s[1]ä¸­è¯»å–ï¼ˆåªèƒ½ä»s[1]ä¸­è¯»å–ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨s[1]ä¸­å†™å…¥ï¼Œç„¶åä»s[0]ä¸­è¯»å–ï¼›ä½†æ˜¯ï¼Œè‹¥æ²¡æœ‰åœ¨0ç«¯å†™å…¥ï¼Œè€Œä»1ç«¯è¯»å–ï¼Œåˆ™1ç«¯çš„è¯»å–æ“ä½œä¼šé˜»å¡ï¼Œå³ä½¿åœ¨1ç«¯å†™å…¥ï¼Œä¹Ÿä¸èƒ½ä»1è¯»å–ï¼Œä»ç„¶é˜»å¡ï¼›åä¹‹äº¦ç„¶ã€‚<a href="http://liulixiaoyao.blog.51cto.com/1361095/533469/" target="_blank" rel="external">è¯¥æ®µè§£é‡Šæ¥è‡ª</a>ã€‚</p>
<p>è¿™é‡Œnewäº†ä¸¤ä¸ªInputChannelï¼Œè¯¥ç±»çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<p><em>frameworks/native/libs/input/InputTransport.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">InputChannel::InputChannel(<span class="keyword">const</span> String8&amp; name, <span class="keyword">int</span> fd) :</div><div class="line">        mName(name), mFd(fd) &#123;</div><div class="line">   <span class="comment">//..</span></div><div class="line">   <span class="keyword">int</span> result = fcntl(mFd, F_SETFL, O_NONBLOCK);</div><div class="line">   <span class="comment">//..</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><br>è¿™é‡Œå°†æè¿°ç¬¦mFdè®¾ç½®ä¸ºnonblockã€‚</p>
<p>æ˜¾ç„¶ï¼Œè¿™é‡Œå’ŒAndroid 2.3ç‰ˆæœ¬æœ‰ç€å¾ˆå¤§åŒºåˆ«ã€‚åœ¨æ—§ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„æ˜¯åŒ¿åå…±äº«å†…å­˜å’Œä¸¤ä¸ªpipeæ¥å®ç°åŒå‘çš„é€šä¿¡ã€‚æ˜¾ç„¶ï¼Œæ–°ç‰ˆæœ¬åˆ©ç”¨çš„linuxç³»ç»Ÿçš„æ–°æœºåˆ¶ï¼Œæ›´ä¸ºç®€æ´é«˜æ•ˆã€‚</p>
<p>ä»¥ä¸Šæ­¥éª¤å®åœ¨æ–°Activityå»ºç«‹ï¼Œçª—å£å¼€å§‹åˆ›å»ºæ—¶æ‰§è¡Œçš„ã€‚è¿™é‡Œä¸»è¦å°±è®©WindowManagerServiceå»ºç«‹ä¸€å¯¹InputChannelï¼Œå°†Activityçš„Windowå’ŒInputDispatcherå»ºç«‹èµ·è¿æ¥ï¼Œä»è€Œä¼ è¾“è¾“å…¥äº‹ä»¶ã€‚</p>
<h2 id="2-Serverç«¯æ³¨å†ŒInputChannel"><a href="#2-Serverç«¯æ³¨å†ŒInputChannel" class="headerlink" title="2. Serverç«¯æ³¨å†ŒInputChannel"></a>2. Serverç«¯æ³¨å†ŒInputChannel</h2><p>åœ¨1.4ä¸­ï¼Œåˆ›å»ºäº†ä¸€å¯¹InputChannelï¼Œå…¶ä¸­Serverç«¯çš„InputChannelä¼šæ³¨å†Œè¿›InputManagerServiceã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mInputManager.registerInputChannel(win.mInputChannel, win.mInputWindowHandle);</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160924164829942" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="2-1"><a href="#2-1" class="headerlink" title="2.1"></a>2.1</h3><p>è¿™ä¸€æ­¥å°±æ£€éªŒäº†ä¸€ä¸‹ä¼ å…¥çš„InputChannelæ˜¯å¦ä¸ºç©ºã€‚ä¸‹é¢ä¸€è¨€ä¸åˆå°±å¼€å§‹è°ƒç”¨nativeå‡½æ•°ã€‚</p>
<h3 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h3><p><em>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å°†æŒ‡é’ˆè½¬åŒ–ä¸ºNativeInputManager</span></div><div class="line">NativeInputManager* im = <span class="keyword">reinterpret_cast</span>&lt;NativeInputManager*&gt;(ptr);</div><div class="line"><span class="comment">//å°†javaçš„InputChannelå¯¹è±¡è½¬åŒ–ä¸ºä¸€ä¸ªc++å±‚çš„InputChannelå¯¹è±¡</span></div><div class="line">sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env,</div><div class="line">        inputChannelObj);</div><div class="line"><span class="comment">//å°†InputWindowHandleè½¬åŒ–ä¸ºc++å±‚çš„InputWindowHandler</span></div><div class="line">sp&lt;InputWindowHandle&gt; inputWindowHandle =</div><div class="line">        android_server_InputWindowHandle_getHandle(env, inputWindowHandleObj);</div><div class="line"></div><div class="line"><span class="comment">//å°†æ³¨å†Œä»»åŠ¡äº¤ç»™NativeInputManager</span></div><div class="line"><span class="keyword">status_t</span> status = im-&gt;registerInputChannel(env, inputChannel, inputWindowHandle, monitor);</div><div class="line"><span class="comment">//..</span></div></pre></td></tr></table></figure></p>
<h3 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h3><p>è¿™ä¸€æ­¥é€šè¿‡NativeInputManagerä¸­çš„InputManagerï¼ŒInputManageré€šè¿‡InputDispatcheræ¥æ³¨å†ŒInputChannelã€‚<br><em>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mInputManager-&gt;getDispatcher()-&gt;registerInputChannel(</div><div class="line">            inputChannel, inputWindowHandle, monitor);</div></pre></td></tr></table></figure></p>
<h3 id="2-4"><a href="#2-4" class="headerlink" title="2.4"></a>2.4</h3><p>ç»ˆäºï¼Œå°†Serverç«¯çš„InputChanneläº¤ç»™äº†InputDispatcherã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">AutoMutex _l(mLock);</div><div class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦è¯¥InputChannelå·²ç»æ·»åŠ è¿‡</span></div><div class="line"><span class="keyword">if</span> (getConnectionIndexLocked(inputChannel) &gt;= <span class="number">0</span>) &#123;</div><div class="line">    ALOGW(<span class="string">"Attempted to register already registered input channel '%s'"</span>,</div><div class="line">            inputChannel-&gt;getName().<span class="built_in">string</span>());</div><div class="line">    <span class="keyword">return</span> BAD_VALUE;</div><div class="line">&#125;</div><div class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªConnection</span></div><div class="line">sp&lt;Connection&gt; connection = <span class="keyword">new</span> Connection(inputChannel, inputWindowHandle, monitor);</div><div class="line"></div><div class="line"><span class="comment">//è·å¾—InputChannelçš„æ–‡ä»¶æè¿°ç¬¦</span></div><div class="line"><span class="keyword">int</span> fd = inputChannel-&gt;getFd();</div><div class="line"><span class="comment">//å°†Connection ä»¥æ–‡ä»¶æè¿°ç¬¦ä¸ºå…³é”®å­—ï¼Œæ·»åŠ å…¥m</span></div><div class="line">mConnectionsByFd.add(fd, connection);</div><div class="line"></div><div class="line"><span class="comment">//..</span></div><div class="line"><span class="comment">//å°†æ–‡ä»¶æè¿°ç¬¦æ·»åŠ Looperï¼Œè®©Looperç›‘æ§InputChannelçš„IOäº‹ä»¶</span></div><div class="line"><span class="comment">//å½“IOäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šè°ƒç”¨å›è°ƒå‡½æ•°handleReceiveCallback</span></div><div class="line">mLooper-&gt;addFd(fd, <span class="number">0</span>, ALOOPER_EVENT_INPUT, handleReceiveCallback, <span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<p>åˆ°è¿™ä¸€æ­¥ï¼ŒInputDispatcherå·²ç»å°†InputChannelçš„Serverç«¯ç®¡ç†èµ·æ¥äº†ã€‚å½“Dispatcherå°†ä¸€ä¸ªäº‹ä»¶é€šè¿‡Channelå‘é€ç»™åº”ç”¨ç¨‹åºçª—å£ä»¥åï¼Œä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°åº”ç”¨çª—å£å†æ¬¡é€šè¿‡è¿™ä¸ªChannelè¿”å›ä¸€ä¸ªæ¶ˆæ¯å°†å…¶æ¿€æ´»ï¼ŒDispatcheræ‰å‡†å¤‡å‘é€ä¸‹ä¸€ä¸ªæ¶ˆæ¯ã€‚</p>
<p>è¿™é‡Œåˆ›å»ºçš„Connectionï¼ŒConnectionä¸­åˆåˆ›å»ºäº†InputPublisherã€‚InputPublisherå¯ä»¥ç›´æ¥å°†æ¶ˆæ¯é€šè¿‡è¿™ä¸ªInputChannelå‘é€å‡ºå»ã€‚</p>
<h2 id="3-å‘InputManagerServiceæ³¨å†Œå½“å‰æ¿€æ´»çš„åº”ç”¨ç¨‹åºçª—å£"><a href="#3-å‘InputManagerServiceæ³¨å†Œå½“å‰æ¿€æ´»çš„åº”ç”¨ç¨‹åºçª—å£" class="headerlink" title="3. å‘InputManagerServiceæ³¨å†Œå½“å‰æ¿€æ´»çš„åº”ç”¨ç¨‹åºçª—å£"></a>3. å‘InputManagerServiceæ³¨å†Œå½“å‰æ¿€æ´»çš„åº”ç”¨ç¨‹åºçª—å£</h2><p>å†æ¬¡å›é¡¾ä¸€ä¸‹1.4çš„ï¼Œåœ¨1.4ä¸­WindowManagerServiceåœ¨ç„¦ç‚¹å‘ç”Ÿæ”¹å˜æ—¶ï¼Œéœ€è¦æ”¹å˜Focused Windowã€‚è¿™é‡Œä¼šåœ¨InputMonitorä¸­æ³¨å†Œå½“å‰æ¿€æ´»çš„çª—å£ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160924164924027" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="3-1"><a href="#3-1" class="headerlink" title="3.1"></a>3.1</h3><p>åœ¨InputMonitorä¸­ï¼Œæœ‰mInputFocusä¿å­˜ç€å½“å‰æ¿€æ´»çš„çª—å£ï¼Œè¿™é‡Œä¼šå°†mInputFocusè®¾ç½®ä¸ºä¼ å…¥çš„newWindowã€‚ç„¶åè°ƒç”¨updateInputWindowLWç»§ç»­æ›´æ–°æ¿€æ´»çš„çª—å£ã€‚</p>
<h3 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h3><p>åœ¨1.4ä¸­ï¼Œæ¯ä¸ªwindowä¼šè¢«åŠ å…¥ä¸€ä¸ªWindow Listã€‚è¿™é‡Œä¼šéå†è¿™äº›Listä¸­çš„Windowsï¼Œç„¶åå°†è¿™äº›windowsè¿›ä¸€æ­¥äº¤ç»™InputManagerServiceå¤„ç†ã€‚</p>
<p><em>rameworks/base/services/core/java/com/android/server/wm/InputMonitor.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Populate the input window list with information about all of the windows that</span></div><div class="line"><span class="comment">// could potentially receive input.</span></div><div class="line"><span class="comment">// As an optimization, we could try to prune the list of windows but this turns</span></div><div class="line"><span class="comment">// out to be difficult because only the native code knows for sure which window</span></div><div class="line"><span class="comment">// currently has touch focus.</span></div><div class="line"><span class="comment">//..</span></div><div class="line"></div><div class="line"><span class="comment">// Add all windows on the default display.</span></div><div class="line"><span class="comment">//mServiceæŒ‡WindowManagerService</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> numDisplays = mService.mDisplayContents.size();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = <span class="number">0</span>; displayNdx &lt; numDisplays; ++displayNdx) &#123;</div><div class="line">    WindowList windows = mService.mDisplayContents.valueAt(displayNdx).getWindowList();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> winNdx = windows.size() - <span class="number">1</span>; winNdx &gt;= <span class="number">0</span>; --winNdx) &#123;</div><div class="line">        <span class="keyword">final</span> WindowState child = windows.get(winNdx);</div><div class="line">        <span class="keyword">final</span> InputChannel inputChannel = child.mInputChannel;</div><div class="line">        <span class="keyword">final</span> InputWindowHandle inputWindowHandle = child.mInputWindowHandle;</div><div class="line">        <span class="keyword">if</span> (inputChannel == <span class="keyword">null</span> || inputWindowHandle == <span class="keyword">null</span> || child.mRemoved) &#123;</div><div class="line">            <span class="comment">// Skip this window because it cannot possibly receive input.</span></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//..</span></div><div class="line">        </div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = child.mAttrs.flags;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = child.mAttrs.privateFlags;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> type = child.mAttrs.type;</div><div class="line">        <span class="comment">//åªæœ‰ä¸€ä¸ªwindowå¯ä»¥è·å¾—Focus</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> hasFocus = (child == mInputFocus);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isVisible = child.isVisibleLw();</div><div class="line"></div><div class="line">        <span class="comment">//..</span></div><div class="line">        addInputWindowHandleLw(inputWindowHandle, child, flags, type, isVisible, hasFocus,</div><div class="line">                hasWallpaper);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Send windows to native code.</span></div><div class="line"><span class="comment">//å°†è¿™äº›windowsäº¤ç»™InputManagerç»§ç»­è¿›è¡Œæ³¨å†Œ</span></div><div class="line">mService.mInputManager.setInputWindows(mInputWindowHandles);</div><div class="line"></div><div class="line"><span class="comment">// Clear the list in preparation for the next round.</span></div><div class="line">clearInputWindowHandlesLw();</div></pre></td></tr></table></figure></p>
<h3 id="3-3"><a href="#3-3" class="headerlink" title="3.3"></a>3.3</h3><p>è¿™ä¸€æ­¥InputManagerServiceå°†ä»»åŠ¡äº¤ç»™äº†c++å±‚ã€‚</p>
<h3 id="3-4"><a href="#3-4" class="headerlink" title="3.4"></a>3.4</h3><p>è¿›å…¥c++å±‚ï¼Œå°†è¿™äº›windowHandlesäº¤ç»™NativeInputManagerã€‚</p>
<p><em>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nativeSetInputWindows</span><span class="params">(JNIEnv* env, jclass <span class="comment">/* clazz */</span>,</span></span></div><div class="line">        jlong ptr, jobjectArray windowHandleObjArray) &#123;</div><div class="line">    <span class="comment">//å°†ptrè½¬åŒ–ä¸ºæŒ‡é’ˆ</span></div><div class="line">    NativeInputManager* im = <span class="keyword">reinterpret_cast</span>&lt;NativeInputManager*&gt;(ptr);</div><div class="line">    <span class="comment">//windowHandleObjArrayæ˜¯ä¼ å…¥çš„windowHandles</span></div><div class="line">    im-&gt;setInputWindows(env, windowHandleObjArray);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-5"><a href="#3-5" class="headerlink" title="3.5"></a>3.5</h3><p>è¿™ä¸€æ­¥å…ˆå°†javaçš„windowHandleå˜ä¸ºc++å¯¹è±¡ï¼Œç„¶åè¿™äº›windowHandleè¢«äº¤ç»™InputDispatcherå¤„ç†ã€‚</p>
<p><em>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (windowHandleObjArray) &#123;</div><div class="line">      jsize length = env-&gt;GetArrayLength(windowHandleObjArray);</div><div class="line">      <span class="comment">//å°†javaå¯¹è±¡è½¬åŒ–ä¸ºc++å¯¹è±¡</span></div><div class="line">      <span class="keyword">for</span> (jsize i = <span class="number">0</span>; i &lt; length; i++) &#123;</div><div class="line">          jobject windowHandleObj = env-&gt;GetObjectArrayElement(windowHandleObjArray, i);</div><div class="line">          <span class="keyword">if</span> (! windowHandleObj) &#123;</div><div class="line">              <span class="keyword">break</span>; <span class="comment">// found null element indicating end of used portion of the array</span></div><div class="line">          &#125;</div><div class="line"></div><div class="line">          sp&lt;InputWindowHandle&gt; windowHandle =</div><div class="line">                  android_server_InputWindowHandle_getHandle(env, windowHandleObj);</div><div class="line">          <span class="keyword">if</span> (windowHandle != <span class="literal">NULL</span>) &#123;</div><div class="line">              windowHandles.push(windowHandle);</div><div class="line">          &#125;</div><div class="line">          env-&gt;DeleteLocalRef(windowHandleObj);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//å°†è¿™äº›windowHandlesäº¤ç»™Dispatcherå¤„ç†</span></div><div class="line">  mInputManager-&gt;getDispatcher()-&gt;setInputWindows(windowHandles);</div></pre></td></tr></table></figure></p>
<h3 id="3-6"><a href="#3-6" class="headerlink" title="3.6"></a>3.6</h3><p>InputDispatcherè·Ÿæ–°WindowHandleï¼Œå¹¶ä¸”æ›´æ–°Focused windowã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp ï¼š</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="comment">// acquire lock</span></div><div class="line">    AutoMutex _l(mLock);</div><div class="line"></div><div class="line">    <span class="comment">//æ¸…ç†æ—§çš„WindowHandle</span></div><div class="line">    Vector&lt;sp&lt;InputWindowHandle&gt; &gt; oldWindowHandles = mWindowHandles;</div><div class="line">    mWindowHandles = inputWindowHandles;</div><div class="line"></div><div class="line">    sp&lt;InputWindowHandle&gt; newFocusedWindowHandle;</div><div class="line">    <span class="keyword">bool</span> foundHoveredWindow = <span class="literal">false</span>;</div><div class="line">    <span class="comment">//æ‰¾åˆ°æ–°çš„Focused WindowHandle</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; mWindowHandles.size(); i++) &#123;</div><div class="line">        <span class="keyword">const</span> sp&lt;InputWindowHandle&gt;&amp; windowHandle = mWindowHandles.itemAt(i);</div><div class="line">        <span class="keyword">if</span> (!windowHandle-&gt;updateInfo() || windowHandle-&gt;getInputChannel() == <span class="literal">NULL</span>) &#123;</div><div class="line">            mWindowHandles.removeAt(i--);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (windowHandle-&gt;getInfo()-&gt;hasFocus) &#123;</div><div class="line">            newFocusedWindowHandle = windowHandle;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (windowHandle == mLastHoverWindowHandle) &#123;</div><div class="line">            foundHoveredWindow = <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!foundHoveredWindow) &#123;</div><div class="line">        mLastHoverWindowHandle = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mFocusedWindowHandle != newFocusedWindowHandle) &#123;</div><div class="line">        <span class="comment">//æ—§çš„FocusedWindowå’Œæ–°çš„ä¸åŒï¼Œåˆ™éœ€è¦åœæ­¢å‘æ—§çš„Channelä¸­å‘é€æ¶ˆæ¯</span></div><div class="line">        <span class="keyword">if</span> (mFocusedWindowHandle != <span class="literal">NULL</span>) &#123;</div><div class="line">            sp&lt;InputChannel&gt; focusedInputChannel = mFocusedWindowHandle-&gt;getInputChannel();</div><div class="line">            <span class="keyword">if</span> (focusedInputChannel != <span class="literal">NULL</span>) &#123;</div><div class="line">                synthesizeCancelationEventsForInputChannelLocked(</div><div class="line">                        focusedInputChannel, options);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//è®¾ç½®æ–°çš„Focused Window</span></div><div class="line">        mFocusedWindowHandle = newFocusedWindowHandle;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Release information for windows that are no longer present.</span></div><div class="line">    <span class="comment">// This ensures that unused input channels are released promptly.</span></div><div class="line">    <span class="comment">// Otherwise, they might stick around until the window handle is destroyed</span></div><div class="line">    <span class="comment">// which might not happen until the next GC.</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; oldWindowHandles.size(); i++) &#123;</div><div class="line">        <span class="keyword">const</span> sp&lt;InputWindowHandle&gt;&amp; oldWindowHandle = oldWindowHandles.itemAt(i);</div><div class="line">        <span class="keyword">if</span> (!hasWindowHandleLocked(oldWindowHandle)) &#123;</div><div class="line">            <span class="comment">//é‡Šæ”¾å·²ç»ä¸å­˜åœ¨çš„æ—§Window</span></div><div class="line">            oldWindowHandle-&gt;releaseInfo();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="comment">// release lock</span></div><div class="line"></div><div class="line"><span class="comment">// Wake up poll loop since it may need to make new input dispatching choices.</span></div><div class="line">mLooper-&gt;wake();</div></pre></td></tr></table></figure></p>
<p>åˆ°è¿™é‡Œï¼ŒInputDispatcherè·å–äº†å’Œæ¿€æ´»çš„Windowçš„åŒå‘é€šä¿¡é€šé“ï¼ŒåŒæ—¶Dispatcherä¹ŸçŸ¥é“äº†æ˜¯å“ªä¸ªWindowå¤„äºFocusedçŠ¶æ€ã€‚åªè¦Clientç«¯å°†é€šä¿¡é€šé“å»ºç«‹å®Œæ¯•ï¼Œåˆ™Dispatcherå¯ä»¥å‘Activityçš„Windowå‘é€æ¶ˆæ¯äº†ã€‚</p>
<h2 id="4-Clientç«¯æ³¨å†ŒInputChannel"><a href="#4-Clientç«¯æ³¨å†ŒInputChannel" class="headerlink" title="4. Clientç«¯æ³¨å†ŒInputChannel"></a>4. Clientç«¯æ³¨å†ŒInputChannel</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mInputEventReceiver = <span class="keyword">new</span> WindowInputEventReceiver(mInputChannel, Looper.myLooper());</div></pre></td></tr></table></figure>
<p>åœ¨1.1ä¸­ï¼Œé€šè¿‡WindowSessionæ·»åŠ Windowå’ŒInputChannelåï¼ŒmInputChannelå¯¹è±¡å·²ç»è½¬åŒ–ä¸ºåŒå‘é€šé“ä¸­çš„clientç«¯é€šé“äº†ï¼Œä»1.4å¯ä»¥çŸ¥é“ã€‚ç„¶åï¼Œè¯¥æ­¥éª¤åˆåˆ›å»ºäº†ä¸€ä¸ªWindowInputEventReceiverç±»çš„å¯¹è±¡mInputEventReceiverï¼Œå®ƒå°†mInputChannelå’Œä¸»çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚</p>
<p>ä¸‹é¢å°±çœ‹ä¸€ä¸‹WindowInputEventReceiverçš„æ„é€ è¿‡ç¨‹ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160924165000028" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="4-1"><a href="#4-1" class="headerlink" title="4.1"></a>4.1</h3><p>WindowInputEventReceiveræ˜¯InputEventReceiverçš„å­ç±»ï¼Œå…·ä½“æ„é€ è¿‡ç¨‹åœ¨InputEventReceiverä¸­ã€‚</p>
<h3 id="4-2"><a href="#4-2" class="headerlink" title="4.2"></a>4.2</h3><p>è¿™ä¸€æ­¥åˆå¼€å§‹è°ƒç”¨nativeå‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/java/android/view/InputEventReceiver.java:</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mInputChannel = inputChannel;</div><div class="line">mMessageQueue = looper.getQueue();</div><div class="line">mReceiverPtr = nativeInit(<span class="keyword">new</span> WeakReference&lt;InputEventReceiver&gt;(<span class="keyword">this</span>), inputChannel, mMessageQueue);</div></pre></td></tr></table></figure></p>
<h3 id="4-3"><a href="#4-3" class="headerlink" title="4.3"></a>4.3</h3><p>åˆ›å»ºc++å±‚çš„NativeInputEventReceiverã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputEventReceiver.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">nativeInit</span><span class="params">(JNIEnv* env, jclass clazz, jobject receiverWeak,</span></span></div><div class="line">        jobject inputChannelObj, jobject messageQueueObj) &#123;</div><div class="line">    <span class="comment">//å°†javaå¯¹è±¡è½¬åŒ–ä¸ºc++å¯¹è±¡</span></div><div class="line">    sp&lt;InputChannel&gt; inputChannel = android_view_InputChannel_getInputChannel(env,</div><div class="line">            inputChannelObj);</div><div class="line">    <span class="comment">//ä¼ å…¥çš„java MessageQueueè½¬åŒ–ä¸ºc++çš„MessageQueue</span></div><div class="line">    sp&lt;MessageQueue&gt; messageQueue = android_os_MessageQueue_getMessageQueue(env, messageQueueObj);</div><div class="line"></div><div class="line">    <span class="comment">//..</span></div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªNativeInputEventReceiverï¼Œæ„é€ å‡½æ•°åœ¨ä¸‹é¢</span></div><div class="line">    sp&lt;NativeInputEventReceiver&gt; receiver = <span class="keyword">new</span> NativeInputEventReceiver(env,</div><div class="line">            receiverWeak, inputChannel, messageQueue);</div><div class="line">    <span class="comment">//å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–</span></div><div class="line">    <span class="keyword">status_t</span> status = receiver-&gt;initialize();</div><div class="line"></div><div class="line">    <span class="comment">//è¿”å›ä¸€ä¸ªNativeInputEventReceiverçš„æŒ‡é’ˆ</span></div><div class="line">    receiver-&gt;incStrong(gInputEventReceiverClassInfo.clazz); <span class="comment">// retain a reference for the object</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;jlong&gt;(receiver.get());</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>NativeInputEventReceiverçš„æ„é€ å‡½æ•°ã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputEventReceiver.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">NativeInputEventReceiver::NativeInputEventReceiver(JNIEnv* env,</div><div class="line">        jobject receiverWeak, <span class="keyword">const</span> sp&lt;InputChannel&gt;&amp; inputChannel,</div><div class="line">        <span class="keyword">const</span> sp&lt;MessageQueue&gt;&amp; messageQueue) :</div><div class="line">        mReceiverWeakGlobal(env-&gt;NewGlobalRef(receiverWeak)),</div><div class="line">        mInputConsumer(inputChannel), mMessageQueue(messageQueue),</div><div class="line">        mBatchedInputEventPending(<span class="literal">false</span>), mFdEvents(<span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (kDebugDispatchCycle) &#123;</div><div class="line">        ALOGD(<span class="string">"channel '%s' ~ Initializing input event receiver."</span>, getInputChannelName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="4-4"><a href="#4-4" class="headerlink" title="4.4"></a>4.4</h3><p>è¿™ä¸€æ­¥è°ƒç”¨å‡½æ•°setFdEventsï¼Œå‚æ•°ä¸º<code>ALOOPER_EVENT_INPUT</code>ã€‚</p>
<h3 id="4-5"><a href="#4-5" class="headerlink" title="4.5"></a>4.5</h3><p>å°†ä¼ å…¥çš„Channelè®©ä¸»çº¿ç¨‹ç›‘å¬èµ·æ¥ï¼Œä»¥ä¾¿å¤„ç†ä¼ å…¥çš„æ¶ˆæ¯ã€‚</p>
<p><em>frameworks/base/core/jni/android_view_InputEventReceiver.cpp</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> NativeInputEventReceiver::setFdEvents(<span class="keyword">int</span> events) &#123;'</div><div class="line">    <span class="keyword">if</span> (mFdEvents != events) &#123;</div><div class="line">        mFdEvents = events;</div><div class="line">        <span class="comment">//è·å–Channelçš„æ–‡ä»¶æè¿°ç¬¦</span></div><div class="line">        <span class="keyword">int</span> fd = mInputConsumer.getChannel()-&gt;getFd();</div><div class="line">        <span class="keyword">if</span> (events) &#123;</div><div class="line">	    <span class="comment">//è·å–Looperï¼Œç»™å…¶æ·»åŠ ç›‘å¬fdçš„IOäº‹ä»¶çš„è¯·æ±‚</span></div><div class="line">	    <span class="comment">//MessageQueueçš„Looperä¸ºä¸»çº¿ç¨‹Looperï¼Œå¦‚æœLooperè¿›å…¥ç¡çœ </span></div><div class="line">	    <span class="comment">//åˆ™ä¼šè¢«Channelä¸Šå†™å…¥çš„äº‹ä»¶å”¤é†’ï¼Œä»è€Œå¯ä»¥å¤„ç†æ–°æ¥çš„æ¶ˆæ¯</span></div><div class="line">            mMessageQueue-&gt;getLooper()-&gt;addFd(fd, <span class="number">0</span>, events, <span class="keyword">this</span>, <span class="literal">NULL</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mMessageQueue-&gt;getLooper()-&gt;removeFd(fd);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>è¿™é‡Œç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”ŸIOäº‹ä»¶æ—¶ï¼Œè°ƒç”¨çš„å›è°ƒå‡½æ•°å°±æ˜¯NativeInputEventReceiverè‡ªå·±ï¼Œå› ä¸ºå®ƒä¸ºLooperCallbackå­ç±»ã€‚</p>
<p>åŒæ—¶æ³¨æ„è¿™é‡Œçš„Looperå°±æ˜¯åº”ç”¨ä¸»çº¿ç¨‹çš„Looperï¼Œè¿™é‡Œå‘å…¶epollå¤šæ·»åŠ äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿›è¡Œç›‘å¬ï¼Œå› ä¸ºepollå¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªepollçš„IOäº‹ä»¶ã€‚åŒæ—¶è®¾å®šäº†ç›‘å¬çš„ç±»å‹ä¸ºALOOPER_EVENT_INPUTã€‚</p>
<p>å›å¿†ä¸‹ç¬¬10ç« çš„1.6æ­¥éª¤ä¸­epoll_waitè¿›å…¥çš„ç¡çœ åï¼Œä¼šç›‘å¬mWakeEventFdæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ã€‚ä¸ä»…å¦‚æ­¤ï¼Œè¿™ä¸€æ­¥è¿˜ä¼šç›‘å¬æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶ï¼Œè¿™é‡Œå°±åŒ…æ‹¬å»ºç«‹çš„InputChannelçš„æ–‡ä»¶æè¿°ç¬¦ã€‚æ‰€ä»¥åœ¨ä¸»çº¿ç¨‹é€šè¿‡è°ƒç”¨pollInnerè¿›å…¥ç¡çœ ä»¥åï¼Œè¢«å”¤é†’åä¼šåˆ¤æ–­å‘ç”Ÿäº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å“ªä¸€ä¸ªã€‚</p>
<p><em>system/core/libutils/Looper.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (fd == mWakeEventFd) &#123;</div><div class="line">          <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) &#123;</div><div class="line">              awoken();</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              ALOGW(<span class="string">"Ignoring unexpected epoll events 0x%x on wake event fd."</span>, epollEvents);</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">ssize_t</span> requestIndex = mRequests.indexOfKey(fd);</div><div class="line">          <span class="keyword">if</span> (requestIndex &gt;= <span class="number">0</span>) &#123;</div><div class="line">              <span class="keyword">int</span> events = <span class="number">0</span>;</div><div class="line">              <span class="keyword">if</span> (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT;</div><div class="line">              <span class="keyword">if</span> (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT;</div><div class="line">              <span class="keyword">if</span> (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR;</div><div class="line">              <span class="keyword">if</span> (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP;</div><div class="line">              pushResponse(events, mRequests.valueAt(requestIndex));</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              ALOGW(<span class="string">"Ignoring unexpected epoll events 0x%x on fd %d that is "</span></div><div class="line">                      <span class="string">"no longer registered."</span>, epollEvents, fd);</div><div class="line">          &#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<p>åˆ°è¿™é‡Œï¼ŒInputChannelåœ¨Clientç«¯ä¹Ÿè¿›è¡Œäº†ç›‘å¬ï¼Œæ•´ä¸ªå®Œæ•´çš„windowæ‰€åœ¨çš„åº”ç”¨ä¸»çº¿ç¨‹å’ŒInputDispatcherçº¿ç¨‹ä¹‹é—´çš„åŒå‘Channelå·²ç»å»ºç«‹å®Œæ¯•ï¼ŒåŒæ—¶InputDispatcherçŸ¥é“å“ªä¸€ä¸ªwindowå¤„äºæ¿€æ´»çŠ¶æ€ï¼Œå› ä¸ºå®ƒçŸ¥é“å‘å“ªä¸€ä¸ªwindowå‘é€æ¶ˆæ¯ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;InputManagerå¯ä»¥è·å¾—è¾“å…¥äº‹ä»¶å¹¶åˆ†å‘ï¼ŒActivityéœ€è¦å¤„ç†è¿™äº›è¾“å…¥äº‹ä»¶ã€‚é‚£ä¹ˆï¼Œè¿™ä¸¤è€…ä¹‹é—´å¦‚ä½•å»ºç«‹çš„è¿æ¥å‘¢ï¼Ÿè¿™å°±éœ€è¦InputChannelä½œä¸ºæ¡¥æ¢å»ºç«‹ä¸¤è€…ä¹‹é—´çš„é€šé“ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-ViewRootImplåˆ›å»ºInputChannel&quot;&gt;&lt;a href=&quot;#1-ViewRootImplåˆ›å»ºInputChannel&quot; class=&quot;headerlink&quot; title=&quot;1. ViewRootImplåˆ›å»ºInputChannel&quot;&gt;&lt;/a&gt;1. ViewRootImplåˆ›å»ºInputChannel&lt;/h2&gt;&lt;p&gt;è¿™é‡ŒViewRootç±»å·²ç»æ¶ˆå¤±äº†ï¼Œç”±ViewRootImplæ›¿ä»£ã€‚Activityåœ¨åˆ›å»ºæ—¶ä¼šå°†è‡ªå·±çš„DecorViewè®¾ç½®ç»™å¯¹åº”çš„ViewRootImplã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160924164736978&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(11):Androidçš„InputManagerServiceçš„å·¥ä½œè¿‡ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-11-Android%E7%9A%84InputManagerService%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-11-Androidçš„InputManagerServiceçš„å·¥ä½œè¿‡ç¨‹/</id>
    <published>2017-02-14T06:11:12.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚  </p>
</blockquote>
<h2 id="1-åˆ›å»ºInputManager"><a href="#1-åˆ›å»ºInputManager" class="headerlink" title="1. åˆ›å»ºInputManager"></a>1. åˆ›å»ºInputManager</h2><p>è¿™é‡Œå’Œè€ç½—å½“å¹´çš„ç‰ˆæœ¬æœ‰å¾ˆå¤§ä¸åŒäº†ï¼Œæœ‰äº†InputManagerServiceç®¡ç†InputManagerã€‚</p>
<p><img src="http://img.blog.csdn.net/20160921173810675" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<a id="more"></a>
<h3 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h3><p>æƒ³è¦æ¢ç´¢å¦‚ä½•å¯åŠ¨çš„ç›¸å…³serverï¼Œéœ€è¦ä»SystemServerå¼€å§‹æ¢å¯»ã€‚ä»SystemServerçš„è¿›ç¨‹å¼€å§‹è¿è¡Œå¼€å§‹ï¼Œå®ƒå°±ä¼šåˆ›å»ºä¸€äº›ç³»ç»Ÿserverï¼Œè¿™é‡Œå°±ä¼šå¯åŠ¨other servicesã€‚</p>
<p>å…¶ä¸­ï¼Œä¼šåˆ›å»ºInput Managerå’ŒWindow Managerä¸¤ä¸ªæœåŠ¡ã€‚</p>
<p><em>frameworks/base/services/java/com/android/server/SystemServer.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Slog.i(TAG, <span class="string">"Input Manager"</span>);</div><div class="line">inputManager = <span class="keyword">new</span> InputManagerService(context);</div><div class="line"></div><div class="line">Slog.i(TAG, <span class="string">"Window Manager"</span>);</div><div class="line">wm = WindowManagerService.main(context, inputManager,</div><div class="line">		mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL,</div><div class="line">		!mFirstBoot, mOnlyCore);</div><div class="line">ServiceManager.addService(Context.WINDOW_SERVICE, wm);</div><div class="line">ServiceManager.addService(Context.INPUT_SERVICE, inputManager);</div><div class="line"><span class="comment">//..</span></div><div class="line">inputManager.start();</div></pre></td></tr></table></figure></p>
<h3 id="1-2"><a href="#1-2" class="headerlink" title="1.2"></a>1.2</h3><p>å…ˆæ¥ä»”ç»†ç«¯è¯¦ä¸€ä¸‹InputManagerServiceçš„æ„é€ å‡½æ•°ã€‚è¿™é‡Œä¼šè°ƒç”¨c++å±‚çš„åˆå§‹åŒ–å‡½æ•°ã€‚<br><em>frameworks/base/services/core/java/com/android/server/input/InputManagerService.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.mHandler = <span class="keyword">new</span> InputManagerHandler(DisplayThread.get().getLooper);</div><div class="line"><span class="comment">//..</span></div><div class="line">mPtr = nativeInit(<span class="keyword">this</span>, mContext, mHandler.getLooper().getQueue());</div></pre></td></tr></table></figure></p>
<p>æ³¨æ„è¿™é‡Œå°†DisplayThreadçš„Looperä¼ é€’è¿‡å»ï¼ŒDisplayThreadæ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼çš„ç±»ï¼Œå®ƒä¼šå¯åŠ¨å”¯ä¸€çš„çº¿ç¨‹ã€‚åŒæ—¶DisplayThreadæ˜¯ä¸€ä¸ªHandlerThreadçš„å­ç±»ï¼Œå®ç°äº†Looperå¾ªç¯æœºåˆ¶ã€‚DisplayThreadæ˜¯ç”¨æ¥æ‰§è¡Œå’Œæ˜¾ç¤ºæœ‰å…³çš„æ“ä½œï¼Œæ˜¾ç¤ºæ“ä½œä¸€èˆ¬éœ€è¦æ¯”è¾ƒå°çš„å»¶è¿Ÿã€‚DisplayThreadåªèƒ½è¢«WindowManagerã€DisplayManagerï¼ŒInputManagerç”¨æ¥æ‰§è¡Œä¸€äº›å¿«é€Ÿåœ°å®æ—¶æ“ä½œã€‚</p>
<h3 id="1-3"><a href="#1-3" class="headerlink" title="1.3"></a>1.3</h3><p>è¿™ä¸€æ­¥é¦–å…ˆå°†javaå±‚çš„MessageQueueå˜ä¸ºäº†c++çš„MessageQueueã€‚ç„¶åæ„é€ äº†ä¸€ä¸ªNativeInputManagerå¯¹è±¡ï¼Œæœ€åå°†æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆ<code>im</code>è¿”å›ç»™javaå±‚ã€‚</p>
<p><em>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NativeInputManager* im = <span class="keyword">new</span> NativeInputManager(contextObj, serviceObj, messageQueue-&gt;getLooper());</div></pre></td></tr></table></figure></p>
<h3 id="1-4"><a href="#1-4" class="headerlink" title="1.4"></a>1.4</h3><p>åœ¨æ„é€ NativeInputManageræ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªInputManagerå¯¹è±¡mInputManagerã€‚</p>
<p><em>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sp&lt;EventHub&gt; eventHub = <span class="keyword">new</span> EventHub();</div><div class="line">mInputManager = <span class="keyword">new</span> InputManager(eventHub, <span class="keyword">this</span>, <span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<h3 id="1-5"><a href="#1-5" class="headerlink" title="1.5"></a>1.5</h3><p>è¿™ä¸€æ­¥ä¼šåˆ›å»ºä¸€ä¸ªdispatcherè´Ÿè´£åˆ†å‘è¾“å…¥äº‹ä»¶ï¼Œä¸€ä¸ªreaderè´Ÿè´£è·å–äº‹ä»¶ã€‚<br><em>frameworks/native/services/inputflinger/InputManager.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mDispatcher = <span class="keyword">new</span> InputDispatcher(dispatcherPolicy);</div><div class="line">mReader = <span class="keyword">new</span> InputReader(eventHub, readerPolicy, mDispatcher);</div><div class="line">initialize();</div></pre></td></tr></table></figure></p>
<h3 id="1-6"><a href="#1-6" class="headerlink" title="1.6"></a>1.6</h3><p>è¿™é‡Œä¼šåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œåœ¨ä»¥åçš„æ­¥éª¤ä¸­ä¼šç”¨æ¥è¿è¡Œå‰é¢åˆ›å»ºçš„dispathcerå’Œreaderã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputManager.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mReaderThread = <span class="keyword">new</span> InputReaderThread(mReader);</div><div class="line">mDispatcherThread = <span class="keyword">new</span> InputDispatcherThread(mDispatcher);</div></pre></td></tr></table></figure></p>
<h2 id="2-å¯åŠ¨InputManager"><a href="#2-å¯åŠ¨InputManager" class="headerlink" title="2. å¯åŠ¨InputManager"></a>2. å¯åŠ¨InputManager</h2><p>å°†è§†çº¿å†æ¬¡å›åˆ°SystemServerä¸­ï¼Œåœ¨åˆ›å»ºå®ŒInputManagerServiceåï¼Œéœ€è¦å°†è¿™ä¸ªServiceå¯åŠ¨ï¼ŒåŒæ ·æ˜¯åœ¨1.1çš„startOtherServiceså‡½æ•°é‡Œï¼Œè°ƒç”¨äº†InputManagerServiceçš„æˆå‘˜å‡½æ•°startã€‚</p>
<p><img src="http://img.blog.csdn.net/20160921173838750" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="2-1"><a href="#2-1" class="headerlink" title="2.1"></a>2.1</h3><p>è¿™é‡Œé¦–å…ˆè°ƒç”¨äº†c++å±‚çš„nativeStartï¼Œç„¶åInputManagerServiceå°†è‡ªå·±äº¤ç»™Watchdogç›‘è§†ã€‚ç„¶åæ³¨å†Œäº†PointerSpeedSettingå’ŒShowTouchesSettingä¸¤ä¸ªObserverã€‚</p>
<p><em>frameworks/base/services/core/java/com/android/server/input/InputManagerService.java :</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">nativeStart(mPtr);</div><div class="line"></div><div class="line"><span class="comment">// Add ourself to the Watchdog monitors.</span></div><div class="line">Watchdog.getInstance().addMonitor(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">registerPointerSpeedSettingObserver();</div><div class="line">registerShowTouchesSettingObserver();</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸¤ä¸ªObserveræš‚æ—¶è¿˜æ²¡ææ¸…æ¥šæ˜¯å¹²ä»€ä¹ˆçš„ã€‚</p>
<h3 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h3><p>è¿™ä¸€æ­¥å°†ä¼ æ¥çš„ptrå‚æ•°è½¬åŒ–ä¸ºä¸€ä¸ªNativeInputManageræŒ‡é’ˆï¼ŒåŒæ—¶å¼€å§‹å¯åŠ¨NativeInputManagerä¸­çš„InputManagerã€‚</p>
<p><em>frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NativeInputManager* im = <span class="keyword">reinterpret_cast</span>&lt;NativeInputManager*&gt;(ptr);</div><div class="line"><span class="keyword">status_t</span> result = im-&gt;getInputManager()-&gt;start();</div></pre></td></tr></table></figure></p>
<h3 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h3><p>è¿™é‡Œä¼šå¯åŠ¨åœ¨1.6ä¸­åˆ›å»ºçš„ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«ç”¨æ¥åˆ†å‘å’Œç›‘å¬Inputäº‹ä»¶ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputManager.cpp ï¼š</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> result = mDispatcherThread-&gt;run(<span class="string">"InputDispatcher"</span>, PRIORITY_URGENT_DISPLAY);</div><div class="line">result = mReaderThread-&gt;run(<span class="string">"InputReader"</span>, PRIORITY_URGENT_DISPLAY);)</div></pre></td></tr></table></figure></p>
<h2 id="3-å¯åŠ¨InputDispatcher"><a href="#3-å¯åŠ¨InputDispatcher" class="headerlink" title="3. å¯åŠ¨InputDispatcher"></a>3. å¯åŠ¨InputDispatcher</h2><p>åœ¨2.3ä¸­è¿è¡Œçš„çº¿ç¨‹ä»¥threadLoopä¸ºå…¥å£ï¼Œå¼€å§‹è¿›å…¥å¾ªç¯ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160921173903504" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="3-1"><a href="#3-1" class="headerlink" title="3.1"></a>3.1</h3><p>è¿™ä¸€æ­¥ç›´æ¥å°†ä»»åŠ¡äº¤ç»™InputDispatcherçš„dispatchOnceå‡½æ•°ã€‚</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> InputDispatcherThread::threadLoop() &#123;</div><div class="line">	mDispatcher-&gt;dispatchOnce();</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h3><p>æ•´ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š</p>
<p><em>frameworks/native/services/inputflinger/InputDispatcher.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> InputDispatcher::dispatchOnce() &#123;</div><div class="line"></div><div class="line">	<span class="keyword">nsecs_t</span> nextWakeupTime = LONG_LONG_MAX;</div><div class="line">	&#123;</div><div class="line">		<span class="comment">// acquire lock</span></div><div class="line">		AutoMutex _l(mLock);</div><div class="line">		mDispatcherIsAliveCondition.broadcast();</div><div class="line"></div><div class="line">		<span class="comment">// Run a dispatch loop if there are no pending commands.</span></div><div class="line">		<span class="comment">// The dispatch loop might enqueue commands to run afterwards.</span></div><div class="line">		<span class="keyword">if</span> (!haveCommandsLocked()) &#123;</div><div class="line">			dispatchOnceInnerLocked(&amp;nextWakeupTime);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Run all pending commands if there are any.</span></div><div class="line">		<span class="comment">// If any commands were run then force the next poll to wake up immediately.</span></div><div class="line">		<span class="keyword">if</span> (runCommandsLockedInterruptible()) &#123;</div><div class="line">			nextWakeupTime = LONG_LONG_MIN;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="comment">// release lock</span></div><div class="line"></div><div class="line">	<span class="keyword">nsecs_t</span> currentTime = now();</div><div class="line">	<span class="keyword">int</span> timeoutMillis = toMillisecondTimeoutDelay(currentTime, nextWakeupTime);</div><div class="line">	mLooper-&gt;pollOnce(timeoutMillis);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>åœ¨è¿™ä¸€æ­¥éª¤ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰Commandè¿˜æœªè¢«æ‰§è¡Œï¼Œå¦‚æœæœ‰å»æ‰§è¡ŒCommandã€‚å¦åˆ™ï¼Œè°ƒç”¨dispatchOnceInnerLockedå‡½æ•°å»è·å–äº‹ä»¶ï¼Œè¿™é‡Œä¼šå°†nextWakeupTimeä¼ é€’è¿‡å»ï¼Œè®©å…¶è®¾ç½®åˆé€‚çš„è‹é†’æ—¶é—´ï¼Œå…·ä½“å†…å®¹åœ¨ä»¥åè®²è§£ã€‚ç„¶årunCommandsLockedInterruptibleå‡½æ•°ä¼šæ‰§è¡Œç¼“å­˜çš„Commandï¼Œå¦‚æœæœ‰Commandåœ¨è¿™ä¸€æ­¥ä¸­è¢«æ‰§è¡Œï¼Œåˆ™éœ€è¦å°†è‹é†’äº‹ä»¶è®¾ç½®ä¸º<code>LONG_LONG_MIN</code>ï¼Œå› ä¸ºæ‰§è¡Œè¿™äº›å‘½ä»¤éœ€è¦è€—è´¹äº‹ä»¶ï¼Œåœ¨è¿™æœŸé—´å¯èƒ½å·²ç»æœ‰è¾“å…¥äº‹ä»¶å‘ç”Ÿäº†ï¼Œæ‰€æœ‰ä¸‹æ¬¡å¾ªç¯ä¸éœ€è¦ç­‰å¾…ã€‚</p>
<p>æœ€åï¼Œæ ¹æ®ç­‰å¾…æ—¶é—´å’Œå½“å‰æ—¶é—´ï¼Œè®¡ç®—å‡ºéœ€è¦ç¡çœ çš„æ—¶é—´ï¼Œé€šè¿‡pollOnceè¿›å…¥ç¡çœ ï¼Œç­‰å¾…å”¤é†’ï¼Œæˆ–è€…è¶…æ—¶ã€‚</p>
<h3 id="3-3"><a href="#3-3" class="headerlink" title="3.3"></a>3.3</h3><p>è¿™é‡Œå’Œä¸Šä¸€ä¸ªç« èŠ‚ä¸­çš„pollOnceé“ç†ç›¸åŒã€‚</p>
<h3 id="3-4"><a href="#3-4" class="headerlink" title="3.4"></a>3.4</h3><p>è¿™é‡Œä¼šè°ƒç”¨epoll_waitå‡½æ•°ï¼Œä½¿å…¶åœ¨mEpollFdæ‰€æè¿°çš„epollä¸Šç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè¿™ä¸ªepollç›‘å¬ç€æ–‡ä»¶æè¿°ç¬¦çš„è¯»å†™äº‹ä»¶ã€‚å¦‚æœæœ‰äººåœ¨pipä¸­å†™å…¥ï¼Œåˆ™ä¼šè¿”å›ï¼Œå¦åˆ™ç­‰å¾…æŒ‡å®šæ—¶é—´åè¿”å›ã€‚</p>
<p><em>system/core/libutils/Looper.cpp</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);</div></pre></td></tr></table></figure></p>
<h2 id="4-å¯åŠ¨InputReader"><a href="#4-å¯åŠ¨InputReader" class="headerlink" title="4. å¯åŠ¨InputReader"></a>4. å¯åŠ¨InputReader</h2><p>åœ¨2.3ä¸­è¿è¡Œçš„çº¿ç¨‹ä»¥threadLoopä¸ºå…¥å£ï¼Œå¼€å§‹è¿›å…¥å¾ªç¯ã€‚</p>
<p><img src="http://img.blog.csdn.net/20160921173918126" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="4-1"><a href="#4-1" class="headerlink" title="4.1"></a>4.1</h3><p>è¿™ä¸€æ­¥ä¸3.1ä¸€æ ·ï¼Œå°†ä»»åŠ¡ä¸¢ç»™InputReaderå¤„ç†ã€‚</p>
<h3 id="4-2"><a href="#4-2" class="headerlink" title="4.2"></a>4.2</h3><p>è¿™ä¸€æ­¥ä¼šå°è¯•ä»mEventHubä¸­è·å–äº‹ä»¶ï¼Œå¦‚æœè·å–ä¸€äº›äº‹ä»¶ï¼Œåˆ™è¿›è¡Œå¤„ç†ã€‚<br><em>frameworks/native/services/inputflinger/InputReader.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä»EventHubä¸­è·å–eventï¼Œè¿™é‡Œå…ˆè¯¦ç»†è®²è§£è¿™ä¸€æ­¥</span></div><div class="line"><span class="keyword">size_t</span> count = mEventHub-&gt;getEvents(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE);</div><div class="line"><span class="comment">//çœç•¥..</span></div><div class="line"><span class="keyword">if</span> (count) &#123;</div><div class="line">	<span class="comment">//äº‹ä»¶å¤„ç†ï¼Œå°†åœ¨åé¢åšå®¢ä¸­è®²è§£</span></div><div class="line">	processEventsLocked(mEventBuffer, count);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>è¿™é‡Œæˆ‘ä»¬å…ˆè€ƒè™‘å¦‚ä½•ä»EventHubä¸­è·å–äº‹ä»¶çš„ã€‚</p>
<h3 id="4-3"><a href="#4-3" class="headerlink" title="4.3"></a>4.3</h3><p>é¦–å…ˆè¿™ä¸€ä¸ªå‡½æ•°ä¸æ˜¯å°±è·å¾—ä¸€ä¸ªeventè¿™ä¹ˆç®€å•ï¼Œå®ƒæ˜¯æƒ³è·å¾—ä¸€ç»„eventï¼Œè¿™é‡Œå’Œæ—§ç‰ˆæœ¬æœ‰æ‰€ä¸åŒï¼Œå¯è§å·¥ç¨‹å¸ˆå¯¹ç³»ç»Ÿåšäº†ä¼˜åŒ–ã€‚è¿™ä¸€æ­¥å†…å®¹æ¯”è¾ƒåˆ°ï¼Œè®©æˆ‘ä»¬é€šè¿‡æ³¨é‡Šæ¥è®²è§£ã€‚</p>
<p><em>frameworks/native/services/inputflinger/EventHub.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">size_t</span> EventHub::getEvents(<span class="keyword">int</span> timeoutMillis, RawEvent* buffer, <span class="keyword">size_t</span> bufferSize) &#123;</div><div class="line">    ALOG_ASSERT(bufferSize &gt;= <span class="number">1</span>);</div><div class="line">    AutoMutex _l(mLock);</div><div class="line">    <span class="keyword">struct</span> input_event readBuffer[bufferSize];</div><div class="line">    <span class="comment">//event æŒ‡å‘äº†å­˜å‚¨äº‹ä»¶çš„ä½ç½®</span></div><div class="line">    RawEvent* event = buffer;</div><div class="line">    <span class="keyword">size_t</span> capacity = bufferSize;</div><div class="line">    <span class="keyword">bool</span> awoken = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">//å¼€å§‹å¾ªç¯è·å–äº‹ä»¶,ç›®çš„æ˜¯å¡«å……buffer</span></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="keyword">nsecs_t</span> now = systemTime(SYSTEM_TIME_MONOTONIC);</div><div class="line"></div><div class="line">        <span class="comment">// Reopen input devices if needed.</span></div><div class="line">        <span class="comment">//å¦‚æœéœ€è¦é‡æ–°æ‰“å¼€è¾“å…¥è®¾å¤‡ï¼Œåˆ™é¦–å…ˆè¦å…³é—­æ‰€æœ‰çš„è®¾å¤‡</span></div><div class="line">        <span class="keyword">if</span> (mNeedToReopenDevices) &#123;</div><div class="line">            mNeedToReopenDevices = <span class="literal">false</span>;</div><div class="line">            ALOGI(<span class="string">"Reopening all input devices due to a configuration change."</span>);</div><div class="line">            closeAllDevicesLocked();</div><div class="line">            mNeedToScanDevices = <span class="literal">true</span>;</div><div class="line">            <span class="keyword">break</span>; <span class="comment">// return to the caller before we actually rescan</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Report any devices that had last been added/removed.</span></div><div class="line">        <span class="comment">//è¿™é‡Œä¼šç§»é™¤æ‰€æœ‰å…³é—­çš„è®¾å¤‡</span></div><div class="line">        <span class="keyword">while</span> (mClosingDevices) &#123;</div><div class="line">            Device* device = mClosingDevices;</div><div class="line">            ALOGV(<span class="string">"Reporting device closed: id=%d, name=%s\n"</span>,</div><div class="line">                 device-&gt;id, device-&gt;path.<span class="built_in">string</span>());</div><div class="line">            mClosingDevices = device-&gt;next;</div><div class="line">            <span class="comment">//åˆ›å»ºäº†ä¸€ä¸ªè®¾å¤‡removedçš„event</span></div><div class="line">            event-&gt;when = now;</div><div class="line">            event-&gt;deviceId = device-&gt;id == mBuiltInKeyboardId ? BUILT_IN_KEYBOARD_ID : device-&gt;id;</div><div class="line">            event-&gt;type = DEVICE_REMOVED;</div><div class="line">            event += <span class="number">1</span>;</div><div class="line">            <span class="keyword">delete</span> device;</div><div class="line">            mNeedToSendFinishedDeviceScan = <span class="literal">true</span>;</div><div class="line">            <span class="keyword">if</span> (--capacity == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">	<span class="comment">//å¦‚æœä¸Šé¢æ­¥éª¤å…³é—­äº†è®¾å¤‡ï¼Œè¿™é‡Œéœ€è¦é‡æ–°æ‰«ææ‰€æœ‰çš„è®¾å¤‡</span></div><div class="line">        <span class="keyword">if</span> (mNeedToScanDevices) &#123;</div><div class="line">            mNeedToScanDevices = <span class="literal">false</span>;</div><div class="line">            <span class="comment">//ä¸‹é¢ä¼šè¯¦ç»†è®²è§£è¿™é‡Œå¦‚ä½•è·å–è¾“å…¥è®¾å¤‡çš„</span></div><div class="line">            scanDevicesLocked();</div><div class="line">            mNeedToSendFinishedDeviceScan = <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">	<span class="comment">//è¿™é‡Œä¼šæ·»åŠ æ­£åœ¨å¼€å¯çš„è®¾å¤‡</span></div><div class="line">        <span class="keyword">while</span> (mOpeningDevices != <span class="literal">NULL</span>) &#123;</div><div class="line">            Device* device = mOpeningDevices;</div><div class="line">            ALOGV(<span class="string">"Reporting device opened: id=%d, name=%s\n"</span>,</div><div class="line">                 device-&gt;id, device-&gt;path.<span class="built_in">string</span>());</div><div class="line">            mOpeningDevices = device-&gt;next;</div><div class="line">            <span class="comment">//åŒæ ·è¿™é‡Œä¼šåˆ›å»ºè®¾å¤‡æ·»åŠ çš„event</span></div><div class="line">            event-&gt;when = now;</div><div class="line">            event-&gt;deviceId = device-&gt;id == mBuiltInKeyboardId ? <span class="number">0</span> : device-&gt;id;</div><div class="line">            event-&gt;type = DEVICE_ADDED;</div><div class="line">            event += <span class="number">1</span>;</div><div class="line">            mNeedToSendFinishedDeviceScan = <span class="literal">true</span>;</div><div class="line">            <span class="keyword">if</span> (--capacity == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mNeedToSendFinishedDeviceScan) &#123;</div><div class="line">            mNeedToSendFinishedDeviceScan = <span class="literal">false</span>;</div><div class="line">            event-&gt;when = now;</div><div class="line">            event-&gt;type = FINISHED_DEVICE_SCAN;</div><div class="line">            event += <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (--capacity == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">	<span class="comment">//ä»¥ä¸Šæ­¥éª¤ä¸»è¦æ˜¯è´Ÿè´£é‡æ–°è·å–æ¥å…¥çš„è®¾å¤‡ï¼Œä¸‹é¢å°†ä¼šè´Ÿè´£è·å¾—è®¾å¤‡ä¸­çš„event</span></div><div class="line">	</div><div class="line">        <span class="comment">// Grab the next input event.</span></div><div class="line">        <span class="keyword">bool</span> deviceChanged = <span class="literal">false</span>;</div><div class="line">        <span class="comment">//å¼€å§‹å¾ªç¯è·å–pendingçš„event</span></div><div class="line">        <span class="comment">//å½“å‰å¤„ç†çš„Eventåºå·æ˜¯å¦å°äºæ­£åœ¨ç­‰å¾…çš„äº‹ä»¶æ•°ç›®ï¼Œè¿™é‡Œä¼šå¾ªç¯è¯»å‡ºæ‰€æœ‰ç­‰å¾…çš„äº‹ä»¶</span></div><div class="line">        <span class="keyword">while</span> (mPendingEventIndex &lt; mPendingEventCount) &#123;</div><div class="line">	    <span class="comment">//è·å–ä¸€ä¸ªeventé¡¹</span></div><div class="line">            <span class="keyword">const</span> <span class="keyword">struct</span> epoll_event&amp; eventItem = mPendingEventItems[mPendingEventIndex++];</div><div class="line">	    <span class="comment">//å¦‚æœè¿™æ˜¯ä¸ªINotifyäº‹ä»¶</span></div><div class="line">            <span class="keyword">if</span> (eventItem.data.u32 == EPOLL_ID_INOTIFY) &#123;</div><div class="line">                <span class="keyword">if</span> (eventItem.events &amp; EPOLLIN) &#123;</div><div class="line">                    mPendingINotify = <span class="literal">true</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    ALOGW(<span class="string">"Received unexpected epoll event 0x%08x for INotify."</span>, eventItem.events);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">	    <span class="comment">//å¦‚æœè¿™æ˜¯ä¸€ä¸ªId wakeäº‹ä»¶ï¼Œåˆ™è¯»å‡ºmWakeReadPipeFdçš„æ•°æ®ï¼Œè®©ç­‰å¾…åœ¨è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„çº¿ç¨‹å¾—åˆ°å”¤é†’	</span></div><div class="line">            <span class="keyword">if</span> (eventItem.data.u32 == EPOLL_ID_WAKE) &#123;</div><div class="line">                <span class="keyword">if</span> (eventItem.events &amp; EPOLLIN) &#123;</div><div class="line">                    ALOGV(<span class="string">"awoken after wake()"</span>);</div><div class="line">                    awoken = <span class="literal">true</span>;</div><div class="line">                    <span class="keyword">char</span> buffer[<span class="number">16</span>];</div><div class="line">                    <span class="keyword">ssize_t</span> nRead;</div><div class="line">                    <span class="keyword">do</span> &#123;</div><div class="line">                        nRead = read(mWakeReadPipeFd, buffer, <span class="keyword">sizeof</span>(buffer));</div><div class="line">                    &#125; <span class="keyword">while</span> ((nRead == <span class="number">-1</span> &amp;&amp; errno == EINTR) || nRead == <span class="keyword">sizeof</span>(buffer));</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    ALOGW(<span class="string">"Received unexpected epoll event 0x%08x for wake read pipe."</span>,</div><div class="line">                            eventItem.events);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">	   </div><div class="line">	    <span class="comment">//è¿™é‡Œå¼€å§‹å¤„ç†å…¶å®ƒéç‰¹æ®Šçš„event</span></div><div class="line">	    <span class="comment">//è·å–eventé¡¹å¯¹åº”çš„è®¾å¤‡çš„ç¼–å·</span></div><div class="line">            <span class="keyword">ssize_t</span> deviceIndex = mDevices.indexOfKey(eventItem.data.u32);</div><div class="line">            <span class="keyword">if</span> (deviceIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">                ALOGW(<span class="string">"Received unexpected epoll event 0x%08x for unknown device id %d."</span>,</div><div class="line">                        eventItem.events, eventItem.data.u32);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//è·å–è®¾å¤‡ï¼Œæ‰€æœ‰å·²çŸ¥çš„è®¾å¤‡éƒ½æ”¾åœ¨äº†mDevicesä¸­</span></div><div class="line">            Device* device = mDevices.valueAt(deviceIndex);</div><div class="line">            <span class="keyword">if</span> (eventItem.events &amp; EPOLLIN) &#123;</div><div class="line">                <span class="comment">//ä»è¿™ä¸ªè®¾å¤‡ä¸­è¯»å‡ºæ•°æ®æµï¼Œå¹¶ä¸”å­˜å…¥readBufferä¸‹</span></div><div class="line">                <span class="keyword">int32_t</span> readSize = read(device-&gt;fd, readBuffer,</div><div class="line">                        <span class="keyword">sizeof</span>(<span class="keyword">struct</span> input_event) * capacity);</div><div class="line">                <span class="keyword">if</span> (readSize == <span class="number">0</span> || (readSize &lt; <span class="number">0</span> &amp;&amp; errno == ENODEV)) &#123;</div><div class="line">                    <span class="comment">// Device was removed before INotify noticed.</span></div><div class="line">	            <span class="comment">//å…ˆå¤„ç†ä¸€äº›å¼‚å¸¸æƒ…å†µï¼Œå…ˆçœç•¥</span></div><div class="line">	            <span class="comment">//...</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123; </div><div class="line">                    <span class="comment">//é”®ç›˜äº‹ä»¶çš„idéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä¸€ç›´è®¾ç½®ä¸º0</span></div><div class="line">                    <span class="keyword">int32_t</span> deviceId = device-&gt;id == mBuiltInKeyboardId ? <span class="number">0</span> : device-&gt;id;</div><div class="line"></div><div class="line">                    <span class="keyword">size_t</span> count = <span class="keyword">size_t</span>(readSize) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> input_event);</div><div class="line">                    <span class="comment">//å¼€å§‹å¾ªç¯ï¼Œä»è®¾å¤‡ä¸­è¯»å‡ºæ¯ä¸€ä¸ªevent</span></div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                        <span class="keyword">struct</span> input_event&amp; iev = readBuffer[i];</div><div class="line">                       </div><div class="line">                        <span class="comment">//è¿™é‡Œåšäº†è®¸å¤šå¤„ç†äº‹ä»¶å¼‚å¸¸æ—¶é—´çš„å·¥ä½œï¼Œå…ˆç•¥è¿‡</span></div><div class="line">                        <span class="comment">//...</span></div><div class="line">                        </div><div class="line">                        <span class="comment">//å°†è·å–çš„äº‹ä»¶å­˜å…¥event</span></div><div class="line">                        event-&gt;deviceId = deviceId;</div><div class="line">                        event-&gt;type = iev.type;</div><div class="line">                        event-&gt;code = iev.code;</div><div class="line">                        event-&gt;value = iev.value;</div><div class="line">                        <span class="comment">//eventæŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå®¹é‡ä¹Ÿéšä¹‹å‡å°‘ä¸€ä¸ª</span></div><div class="line">                        event += <span class="number">1</span>;</div><div class="line">                        capacity -= <span class="number">1</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (capacity == <span class="number">0</span>) &#123;</div><div class="line">                        <span class="comment">// The result buffer is full.  Reset the pending event index</span></div><div class="line">                        <span class="comment">// so we will try to read the device again on the next iteration.</span></div><div class="line">                        <span class="comment">//bufferå·²ç»å¡«æ»¡ï¼Œé€€å‡ºå¤„ç†pending eventçš„å¾ªç¯ï¼Œå°†indexå›åˆ°ä¸Šä¸€ä¸ªä½ç½®ï¼Œå› ä¸ºè¯¥è®¾å¤‡eventè¿˜æ²¡è¯»å®Œï¼Œä¸‹æ¬¡å†æ¥ç€è¯»</span></div><div class="line">                        mPendingEventIndex -= <span class="number">1</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (eventItem.events &amp; EPOLLHUP) &#123;</div><div class="line">	          <span class="comment">//å¤„ç†ä¸€äº›å…¶å®ƒæƒ…å†µï¼Œçœç•¥</span></div><div class="line">	          <span class="comment">//...</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="comment">//åœ¨è¯»å‡ºæ‰€æœ‰eventåï¼Œæ‰èƒ½å…³é—­è®¾å¤‡ï¼Œè¿™é‡Œçœç•¥äº†å¯¹æ­¤çš„å¤„ç†è¿‡ç¨‹</span></div><div class="line">        <span class="comment">//...</span></div><div class="line">        </div><div class="line">        <span class="comment">//åˆ°è¿™é‡Œè¯´æ˜pending eventå·²ç»å¤„ç†å®Œï¼Œæˆ–è€…bufferå·²ç»å¡æ»¡ã€‚bufferå¡æ»¡æˆ–è€…å­˜äº†ä¸€äº›äº‹ä»¶ï¼Œåˆ™é€€å‡ºæœ€å¤–å±‚å¡«å……bufferçš„å¾ªç¯</span></div><div class="line">        <span class="comment">// Return now if we have collected any events or if we were explicitly awoken.</span></div><div class="line">        <span class="keyword">if</span> (event != buffer || awoken) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//è¿™é‡Œå¤„ç†äº†ä¸€äº›wake lockçš„äº‹æƒ…ï¼Œçœç•¥</span></div><div class="line">        <span class="comment">//...</span></div><div class="line">        </div><div class="line">        <span class="comment">//åˆ°è¿™ä¸€æ­¥è¯´æ˜bufferé‡Œæ²¡æœ‰å¡«ä»»ä½•äº‹ä»¶ï¼ŒåŒæ—¶ä¹Ÿæ²¡æœ‰pending event</span></div><div class="line">        <span class="comment">//æ‰€ä»¥éœ€è¦ç­‰å¾…æœ‰äººå‘deviceæ–‡ä»¶æè¿°ç¬¦é‡Œå†™å…¥ä¸€äº›äº‹ä»¶</span></div><div class="line">        <span class="keyword">int</span> pollResult = epoll_wait(mEpollFd, mPendingEventItems, EPOLL_MAX_EVENTS, timeoutMillis);</div><div class="line">        </div><div class="line">        <span class="comment">//æ—¶é—´å·²åˆ°ï¼Œè¿˜æ˜¯æ²¡æœ‰äº‹ä»¶ï¼Œé‚£å’±å°±ç»“æŸå§</span></div><div class="line">        <span class="keyword">if</span> (pollResult == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Timed out.</span></div><div class="line">            mPendingEventCount = <span class="number">0</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å‡ºé”™äº†ï¼Œè®©æˆ‘ç¡ä¸€ä¼šï¼Œä¸‹æ¬¡å†å°è¯•</span></div><div class="line">        <span class="keyword">if</span> (pollResult &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// An error occurred.</span></div><div class="line">            mPendingEventCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Sleep after errors to avoid locking up the system.</span></div><div class="line">            <span class="comment">// Hopefully the error is transient.</span></div><div class="line">            <span class="keyword">if</span> (errno != EINTR) &#123;</div><div class="line">                ALOGW(<span class="string">"poll failed (errno=%d)\n"</span>, errno);</div><div class="line">                usleep(<span class="number">100000</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Some events occurred.</span></div><div class="line">            mPendingEventCount = <span class="keyword">size_t</span>(pollResult);</div><div class="line">            <span class="comment">//è·å–äº†ä¸€äº›eventï¼Œé‚£ä¹ˆç»§ç»­å¾ªç¯ï¼Œå¡«å……bufferï¼</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// All done, return the number of events we read.</span></div><div class="line">    <span class="keyword">return</span> event - buffer;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="4-4"><a href="#4-4" class="headerlink" title="4.4"></a>4.4</h3><p>ä»è¿™é‡Œå¼€å§‹æ‰«æè®¾å¤‡ã€‚åœ¨ç ”ç©¶è¿™ä¸ªå‡½æ•°å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹<code>DEVICE_PATH</code>çš„æ¥å¤´ï¼š</p>
<p><em>frameworks/native/services/inputflinger/EventHub.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è¿™ä¸€æ®µä»£ç ä½äºEventHubçš„æ„é€ å‡½æ•°ä¸­ï¼Œè¿™é‡Œä½¿ç”¨äº†linuxçš„inotifyæœºåˆ¶</span></div><div class="line"><span class="comment">//inotifyæœºåˆ¶å¯ä»¥ç›‘æ§æ–‡ä»¶çš„å˜åŒ–</span></div><div class="line"><span class="comment">//å› æ­¤ç³»ç»Ÿå¯ä»¥å®æ—¶ç›‘æ§è®¾å¤‡çš„æ·»åŠ å’Œç§»é™¤</span></div><div class="line">mINotifyFd = inotify_init();</div><div class="line"><span class="keyword">int</span> result = inotify_add_watch(mINotifyFd, DEVICE_PATH, IN_DELETE | IN_CREATE);</div></pre></td></tr></table></figure></p>
<p><em>frameworks/native/services/inputflinger/EventHub.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> EventHub::scanDevicesLocked() &#123;</div><div class="line">     <span class="comment">//æ‰«æç›®å½•ï¼š/dev/input</span></div><div class="line">    <span class="keyword">status_t</span> res = scanDirLocked(DEVICE_PATH);</div><div class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"scan dir failed for %s\n"</span>, DEVICE_PATH);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mDevices.indexOfKey(VIRTUAL_KEYBOARD_ID) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿé”®ç›˜</span></div><div class="line">        createVirtualKeyboardLocked();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="4-5"><a href="#4-5" class="headerlink" title="4.5"></a>4.5</h3><p>è¿™é‡Œå¼€å§‹æ‰«æ<code>/dev/input/</code>ç›®å½•ä¸‹çš„æ‰€æœ‰è®¾å¤‡ã€‚</p>
<p><em>frameworks/native/services/inputflinger/EventHub.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> EventHub::scanDirLocked(<span class="keyword">const</span> <span class="keyword">char</span> *dirname)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> devname[PATH_MAX];</div><div class="line">    <span class="keyword">char</span> *filename;</div><div class="line">    DIR *dir;</div><div class="line">    <span class="keyword">struct</span> dirent *de;</div><div class="line">    dir = opendir(dirname);</div><div class="line">    <span class="keyword">if</span>(dir == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    <span class="built_in">strcpy</span>(devname, dirname);</div><div class="line">    filename = devname + <span class="built_in">strlen</span>(devname);</div><div class="line">    <span class="comment">//filenameæŒ‡å‘äº†devnameç›®å½•çš„å°¾ç«¯ï¼Œæ–¹ä¾¿åœ¨å…¶åé¢æ·»åŠ è®¾å¤‡æ–‡ä»¶</span></div><div class="line">    *filename++ = <span class="string">'/'</span>;</div><div class="line">    <span class="comment">//è¯»å–è¯¥ç›®å½•ä¸‹çš„æ¯ä¸€ä¸ªè®¾å¤‡æ–‡ä»¶</span></div><div class="line">    <span class="keyword">while</span>((de = readdir(dir))) &#123;</div><div class="line">        <span class="keyword">if</span>(de-&gt;d_name[<span class="number">0</span>] == <span class="string">'.'</span> &amp;&amp;</div><div class="line">           (de-&gt;d_name[<span class="number">1</span>] == <span class="string">'\0'</span> ||</div><div class="line">            (de-&gt;d_name[<span class="number">1</span>] == <span class="string">'.'</span> &amp;&amp; de-&gt;d_name[<span class="number">2</span>] == <span class="string">'\0'</span>)))</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        <span class="built_in">strcpy</span>(filename, de-&gt;d_name);</div><div class="line">        <span class="comment">//æ‰“å¼€è®¾å¤‡ï¼Œdevnameé‡Œæ˜¯è®¾å¤‡çš„ç»å¯¹è·¯å¾„</span></div><div class="line">        openDeviceLocked(devname);</div><div class="line">    &#125;</div><div class="line">    closedir(dir);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="4-6"><a href="#4-6" class="headerlink" title="4.6"></a>4.6</h3><p><em>frameworks/native/services/inputflinger/EventHub.cpp :</em><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">status_t</span> EventHub::openDeviceLocked(<span class="keyword">const</span> <span class="keyword">char</span> *devicePath) &#123;</div><div class="line">    <span class="keyword">char</span> buffer[<span class="number">80</span>];</div><div class="line"></div><div class="line">    <span class="comment">//æ‰“å¼€æ–‡ä»¶</span></div><div class="line">    <span class="keyword">int</span> fd = open(devicePath, O_RDWR | O_CLOEXEC);</div><div class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"could not open %s, %s\n"</span>, devicePath, strerror(errno));</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    InputDeviceIdentifier identifier;</div><div class="line"></div><div class="line">    <span class="comment">// Get device name.</span></div><div class="line">    <span class="keyword">if</span>(ioctl(fd, EVIOCGNAME(<span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>), &amp;buffer) &lt; <span class="number">1</span>) &#123;</div><div class="line">        <span class="comment">//fprintf(stderr, "could not get device name for %s, %s\n", devicePath, strerror(errno));</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        buffer[<span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>] = <span class="string">'\0'</span>;</div><div class="line">        identifier.name.setTo(buffer);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Check to see if the device is on our excluded list</span></div><div class="line">    <span class="comment">//åˆ é™¤æ’é™¤çš„è®¾å¤‡</span></div><div class="line"> </div><div class="line">    <span class="comment">//ä¸€ä¸‹æ­¥éª¤ä»æ–‡ä»¶ä¸­è·å–deviceçš„åŸºæœ¬ä¿¡æ¯</span></div><div class="line">    <span class="comment">//...</span></div><div class="line">    <span class="comment">// Get device driver version.</span></div><div class="line">    <span class="comment">// Get device identifier.</span></div><div class="line">    <span class="comment">// Get device physical location.</span></div><div class="line">    <span class="comment">// Get device unique id.</span></div><div class="line">    <span class="comment">// Fill in the descriptor.</span></div><div class="line">    <span class="comment">// Make file descriptor non-blocking for use with poll().</span></div><div class="line"></div><div class="line">    <span class="comment">//åˆ›å»ºdeviceå¯¹è±¡</span></div><div class="line">    <span class="comment">// Allocate device.  (The device object takes ownership of the fd at this point.)</span></div><div class="line">    <span class="keyword">int32_t</span> deviceId = mNextDeviceId++;</div><div class="line">    Device* device = <span class="keyword">new</span> Device(fd, deviceId, String8(devicePath), identifier);</div><div class="line">    <span class="comment">//æ ¹æ®deviceçš„ç‰¹å¾ï¼Œè®¾ç½®deviceçš„classå‚æ•°</span></div><div class="line">    <span class="comment">//...</span></div><div class="line">    </div><div class="line">    <span class="comment">// Register with epoll.</span></div><div class="line">    <span class="keyword">struct</span> epoll_event eventItem;</div><div class="line">    <span class="built_in">memset</span>(&amp;eventItem, <span class="number">0</span>, <span class="keyword">sizeof</span>(eventItem));</div><div class="line">    eventItem.events = EPOLLIN;</div><div class="line">    <span class="keyword">if</span> (mUsingEpollWakeup) &#123;</div><div class="line">        eventItem.events |= EPOLLWAKEUP;</div><div class="line">    &#125;</div><div class="line">    eventItem.data.u32 = deviceId;</div><div class="line">    <span class="comment">//å°†è¯¥deviceçš„æ–‡ä»¶fdäº¤ç»™epollç›‘è§†ï¼Œä»¥åŠæ—¶è·å¾—å®ƒçš„å˜åŒ–</span></div><div class="line">    <span class="keyword">if</span> (epoll_ctl(mEpollFd, EPOLL_CTL_ADD, fd, &amp;eventItem)) &#123;</div><div class="line">        ALOGE(<span class="string">"Could not add device fd to epoll instance.  errno=%d"</span>, errno);</div><div class="line">        <span class="keyword">delete</span> device;</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//å¤„ç†æ—¶é’Ÿé—®é¢˜..</span></div><div class="line"></div><div class="line">    <span class="comment">//æ·»åŠ device</span></div><div class="line">    addDeviceLocked(device);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div></pre></td></tr></table></figure></p>
<h3 id="4-7"><a href="#4-7" class="headerlink" title="4.7"></a>4.7</h3><p>è¿™ä¸€æ­¥æ¯”è¾ƒè½»æ¾ï¼Œå°†åˆ›å»ºå¥½çš„deviceå¯¹è±¡æ”¾å…¥mDeviceså³å¯ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> EventHub::addDeviceLocked(Device* device) &#123;</div><div class="line">    mDevices.add(device-&gt;id, device);</div><div class="line">    device-&gt;next = mOpeningDevices;</div><div class="line">    mOpeningDevices = device;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¯·å¯¹ç…§AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;1-åˆ›å»ºInputManager&quot;&gt;&lt;a href=&quot;#1-åˆ›å»ºInputManager&quot; class=&quot;headerlink&quot; title=&quot;1. åˆ›å»ºInputManager&quot;&gt;&lt;/a&gt;1. åˆ›å»ºInputManager&lt;/h2&gt;&lt;p&gt;è¿™é‡Œå’Œè€ç½—å½“å¹´çš„ç‰ˆæœ¬æœ‰å¾ˆå¤§ä¸åŒäº†ï¼Œæœ‰äº†InputManagerServiceç®¡ç†InputManagerã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160921173810675&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android Monkey æºä»£ç é˜…è¯»</title>
    <link href="http://itanch.github.io/2017/02/14/Android-Monkey-%E6%BA%90%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>http://itanch.github.io/2017/02/14/Android-Monkey-æºä»£ç é˜…è¯»/</id>
    <published>2017-02-14T06:09:32.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0-MonkeyåŸºæœ¬ä¿¡æ¯"><a href="#0-MonkeyåŸºæœ¬ä¿¡æ¯" class="headerlink" title="0. MonkeyåŸºæœ¬ä¿¡æ¯"></a>0. MonkeyåŸºæœ¬ä¿¡æ¯</h2><p>ç›®å‰è¯¥å·¥å…·ä½äºæºä»£ç çš„ä½ç½®ï¼š<code>development/cmds/monkey</code>ã€‚</p>
<p>ç”Ÿæˆçš„jaråŒ…ä½äºï¼š<code>out/traget/product/generic/system/framework/monkey.jar</code>ã€‚</p>
<p>åœ¨è®¾å¤‡ä¸­ï¼Œå¯åŠ¨monkeyçš„è„šæœ¬ä½äº<code>/system/bin/monkey</code>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Script to start "monkey" on the device, which has a very rudimentary</span></div><div class="line"><span class="comment"># shell.</span></div><div class="line"><span class="comment">#</span></div><div class="line">base=/system</div><div class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$base</span>/framework/monkey.jar</div><div class="line"><span class="built_in">trap</span> <span class="string">""</span> HUP</div><div class="line"><span class="built_in">exec</span> app_process <span class="variable">$base</span>/bin com.android.commands.monkey.Monkey $*</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="1-Monkeyå¼€å§‹å¯åŠ¨"><a href="#1-Monkeyå¼€å§‹å¯åŠ¨" class="headerlink" title="1. Monkeyå¼€å§‹å¯åŠ¨"></a>1. Monkeyå¼€å§‹å¯åŠ¨</h2><p><img src="http://img.blog.csdn.net/20160916145356103" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>mainå‡½æ•°åªæ˜¯è®¾ç½®äº†è¿›ç¨‹çš„åç§°ï¼Œä¸»è¦è¿‡ç¨‹åœ¨runå‡½æ•°ä¸­æ‰§è¡Œã€‚</li>
<li>è·å–å‚æ•°ï¼Œåˆå§‹åŒ–å‚æ•°å’Œéšæœºæ•°ã€‚ç„¶åå®ƒä¼šè·å–ç³»ç»Ÿçš„ä¸€äº›æœåŠ¡ï¼Œè§1.3ã€‚è·å–éœ€è¦å¯åŠ¨çš„main activityï¼Œè§1.4ã€‚åˆ›å»ºä¸€ä¸ªMonkeySourceRoandomå¯¹è±¡mEventSourceï¼Œç”±ä»–ç®¡ç†éšæœºäº‹ä»¶çš„ç”Ÿæˆï¼Œè¿™é‡Œé¦–å…ˆè®©å®ƒç”Ÿæˆäº†ä¸€ä¸ªå¯åŠ¨main activityçš„äº‹ä»¶æ”¾å…¥äº†é˜Ÿåˆ—ã€‚monkeyè¿˜æ”¯æŒé€šè¿‡è„šæœ¬ã€ç½‘ç»œè·å–äº‹ä»¶ï¼Œè¿™é‡Œåªè¯´é»˜è®¤çš„éšæœºæƒ…å†µã€‚ä¸‹é¢ï¼Œå®ƒå¯åŠ¨Network Monitorã€‚æ¥ç€ï¼Œå¯åŠ¨Monkeyçš„å¾ªç¯è¿‡ç¨‹ï¼Œè§1.5ã€‚ç­‰å¾…æµ‹è¯•ç»“æŸåï¼Œåˆ™è¾“å‡ºæµ‹è¯•æŠ¥å‘Šã€‚</li>
<li>è·å–ä¸€äº›ç³»ç»ŸæœåŠ¡ï¼Œæœ‰ActivityManagerã€WindowManagerã€PackageManagerã€‚ç»™ActivityManagerè®¾ç½®äº†ä¸€ä¸ªActivityControllerå¯¹è±¡ï¼Œè¯¥å¯¹è±¡æä¾›äº†Activityå¯åŠ¨ã€crashè·å–ã€åº”ç”¨æ— å“åº”ç­‰åŠŸèƒ½ã€‚æœ€åï¼Œè¿˜æ³¨å†Œäº†ä¸€ä¸ªç½‘ç»œçŠ¶æ€çš„ç›‘å¬å™¨ã€‚</li>
<li>ä»PackageManagerä¸­è·å–ç¬¦åˆæ¡ä»¶çš„main activityï¼Œç„¶åæ·»åŠ å…¥<code>mMainApps</code>ä¸­ã€‚</li>
<li>è¿™ä¸€æ­¥å°±ä¼šå¾ªç¯çš„ç”Ÿæˆæµ‹è¯•äº‹ä»¶è§1.6ã€è§¦å‘äº‹ä»¶1.10ã€‚</li>
<li>ä»é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªäº‹ä»¶è¿”å›ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ç”Ÿæˆä¸€ä¸ªæ”¾å…¥é˜Ÿåˆ—ï¼Œè§1.7ã€‚</li>
<li>è¿™é‡Œå…ˆç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œæ ¹æ®éšæœºæ•°èŒƒå›´ï¼Œå†³å®šå…·ä½“ç”Ÿæˆå“ªä¸€ä¸ªäº‹ä»¶ã€‚è¿™é‡Œæœ‰ç‚¹å‡»ã€æ‹–åŠ¨ã€ç¼©æ”¾ï¼ˆå‰ä¸‰ä¸ªï¼Œè§1.8ï¼‰ã€è½¨è¿¹çƒï¼ˆå·²ç»ä¸å¸¸ç”¨äº†ï¼Œå¯ä»¥å¿½ç•¥ï¼‰ã€æ—‹è½¬ã€æƒé™ï¼ˆè§1.9ï¼‰å’Œé”®ç›˜äº‹ä»¶ã€‚</li>
<li>è¿™é‡Œä¼šé¦–å…ˆåˆ©ç”¨DisplayManagerè·å¾—å±å¹•çš„å®é™…å¤§å°ï¼Œç„¶åéšæœºçš„ç”Ÿæˆç”Ÿæˆç‚¹åæ ‡ã€‚Touchåªéœ€è¦ä¸€ç‚¹å°±å¤Ÿäº†ï¼Œè€ŒDragåˆ™éœ€è¦ç”Ÿæˆä¸€ç³»åˆ—çš„ç‚¹ï¼Œè¿™é‡Œåˆ©ç”¨äº†randomWalkå‡½æ•°æ¥éšæœºçš„ç§»åŠ¨æ¥ç”Ÿæˆä¸‹ä¸€ä¸ªç‚¹åæ ‡ï¼Œç„¶åå°†è¿™ä¸€ç³»åˆ—ç‚¹åæ ‡å°è£…æˆäº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ã€‚ä¸¤æŒ‡ç¼©æ”¾åŒæ ·ä½¿ç”¨äº†å’ŒDragç±»ä¼¼çš„æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯å°†ä¸€ä¸ªç‚¹å˜ä¸ºä¸¤ä¸ªç‚¹ã€‚</li>
<li>ä»ç›®æ ‡packageä¸­çš„æƒé™åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªï¼Œç„¶åç”Ÿæˆä¸€ä¸ªMonkeyPersissionEventã€‚</li>
<li>MonkeyEventæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…·ä½“çš„å®ç°åœ¨å…¶å­ç±»ä¸­ã€‚MotionEventé€šè¿‡InputManageræ³¨å…¥äº‹ä»¶ã€‚æ—‹è½¬MonkeyRotationEventé€šè¿‡WindowManagerè¿›è¡Œæ—‹è½¬ã€‚MonkeyPermissionEventåˆ©ç”¨PackageManageræˆäºˆã€æ’¤é”€åº”ç”¨çš„ä¸€äº›æƒé™ã€‚MonkeyKeyEventåŒæ ·æ˜¯ä½¿ç”¨InputManagerè¿›è¡Œæ³¨å…¥ã€‚</li>
<li>è¿™é‡Œè¿˜æœ‰ä¸€äº›å…¶å®ƒäº‹ä»¶ã€‚MonkeyActivityEventçš„äº‹ä»¶æ˜¯ç”±ActivityManagerå¯åŠ¨çš„ã€‚MonkeyCommandEventåˆ™å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰§è¡Œå‘½ä»¤å³å¯ã€‚MonkeyFlipEventï¼Œå”¤èµ·é”®ç›˜çš„æ“ä½œï¼Œè¿™é‡Œæ˜¯å‘<code>/dev/input/event0</code>å†™å…¥äº†ä¸€ç»„å­—èŠ‚ã€‚MonkeyGetAppFrameRateEventå’ŒMonkeyGetFrameRateEventï¼Œè·å–åº”ç”¨å¸§é¢‘ï¼Œé€šè¿‡å‘½ä»¤è¡Œæ‰§è¡Œæ¥å®ç°ã€‚MonkeyInstrumentationEvent, åˆ©ç”¨ActivityManagerå¯åŠ¨Instrumentationç»„ä»¶ã€‚MonkeyNoopEventï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼Œå‘µå‘µã€‚MonkeyPowerEventï¼Œä»logä¿¡æ¯ä¸­è·å–ç”µé‡ä¿¡æ¯ã€‚MonkeyThrottleEventå’ŒMonkeyWaitEventï¼ŒThread.sleepä¼‘çœ ä¸€æ®µæ—¶é—´ã€‚</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0-MonkeyåŸºæœ¬ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#0-MonkeyåŸºæœ¬ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;0. MonkeyåŸºæœ¬ä¿¡æ¯&quot;&gt;&lt;/a&gt;0. MonkeyåŸºæœ¬ä¿¡æ¯&lt;/h2&gt;&lt;p&gt;ç›®å‰è¯¥å·¥å…·ä½äºæºä»£ç çš„ä½ç½®ï¼š&lt;code&gt;development/cmds/monkey&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ç”Ÿæˆçš„jaråŒ…ä½äºï¼š&lt;code&gt;out/traget/product/generic/system/framework/monkey.jar&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è®¾å¤‡ä¸­ï¼Œå¯åŠ¨monkeyçš„è„šæœ¬ä½äº&lt;code&gt;/system/bin/monkey&lt;/code&gt;:&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Script to start &quot;monkey&quot; on the device, which has a very rudimentary&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# shell.&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;base=/system&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt; CLASSPATH=&lt;span class=&quot;variable&quot;&gt;$base&lt;/span&gt;/framework/monkey.jar&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;trap&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; HUP&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; app_process &lt;span class=&quot;variable&quot;&gt;$base&lt;/span&gt;/bin com.android.commands.monkey.Monkey $*&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(10):Androidåº”ç”¨ç¨‹åºçš„æ¶ˆæ¯å¤„ç†æœºåˆ¶</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-10-Android%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-10-Androidåº”ç”¨ç¨‹åºçš„æ¶ˆæ¯å¤„ç†æœºåˆ¶/</id>
    <published>2017-02-14T06:07:55.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><blockquote>
<p>åŸæ¥å†™å¥½çš„åšå®¢è¢«CSDNç»™å‘äº†ï¼Œæ³•å…‹ï¼Œåªèƒ½é å›å¿†é‡å†™ã€‚    </p>
</blockquote>
<ol>
<li>Androidåº”ç”¨ç¨‹åºçš„å››ç§ç»„ä»¶çš†è¿è¡ŒäºActivityThreadä¹‹ä¸­ã€‚ActivityThreadåŒ…å«æœ‰ç¨‹åºå…¥å£mainï¼ŒåŒæ—¶å®ƒä¼šå¯åŠ¨ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯ä¼šè½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥å¤„ç†å‘é€ç»™å®ƒçš„æ¶ˆæ¯ã€‚è€Œå››ç§ç»„ä»¶åˆ™è¢«è¿™ä¸ªçº¿ç¨‹ç»Ÿä¸€ç®¡ç†ã€‚æ‰€ä»¥ï¼ŒActivityThreadè¿™ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹ï¼Œåƒä¸€ä¸ªæ— ä¼‘æ­¢çš„è½¬åŠ¨çš„æ³•æ¡ï¼Œè€Œå››ä¸ªç»„ä»¶åˆ™åƒæ˜¯è¢«é©±åŠ¨å››ä¸ªé½¿è½®ï¼Œéœ€è¦å®ƒä»¬è½¬åŠ¨æ—¶æ‰ä¼šåœ¨æ³•æ¡çš„å¸¦åŠ¨ä¸‹è¿›è¡Œè½¬åŠ¨ã€‚</li>
<li>ä¸»çº¿ç¨‹ä¸­æœ‰ä¸€ä¸ªLooperï¼ŒLooperæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå…¶ä¸­åˆæœ‰ä¸€ä¸ªMessageQueueæ¥ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ã€‚MessageQueueåˆæœ‰ä¸€ä¸ªmPtrå˜é‡ï¼Œè®°å½•äº†c++å±‚å¯¹åº”çš„NativeMessageQueueçš„ä½ç½®ã€‚NativeMessageQueueä¹Ÿæœ‰ä¸€ä¸ªc++å±‚çš„Looperï¼Œå®ƒè´Ÿè´£ç®¡ç†pipï¼Œè€Œpipåˆ™æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„é€šé“ã€‚ </li>
</ol>
<a id="more"></a>
<h2 id="1-çº¿ç¨‹æ¶ˆæ¯å¾ªç¯"><a href="#1-çº¿ç¨‹æ¶ˆæ¯å¾ªç¯" class="headerlink" title="1. çº¿ç¨‹æ¶ˆæ¯å¾ªç¯"></a>1. çº¿ç¨‹æ¶ˆæ¯å¾ªç¯</h2><p><img src="http://img.blog.csdn.net/20160916145806480" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>ActivityThreadä¼šç”±æ­¤è¿›å…¥å¾ªç¯ã€‚é€šè¿‡ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œä»MessageQueueé‡Œè·å–Messageï¼Œè¿™é‡Œå¯èƒ½ä¼šè¢«é˜»å¡ï¼Œè§1.2ã€‚è·å–æ¶ˆæ¯åï¼Œåˆ†å‘æ¶ˆæ¯åˆ°å“åº”çš„çš„ç»„ä»¶ã€‚</li>
<li>è°ƒç”¨nativePollOnceå‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„æ¶ˆæ¯ï¼Œè§1.3ã€‚å¦‚æœæœ‰æ–°æ¶ˆæ¯ï¼Œåˆ™åˆ¤æ–­æ—¶æœºæ˜¯å¦å·²åˆ°ï¼Œæ—¶æœºåˆ°äº†åˆ™å°†Messageè¿”å›ã€‚å¦‚æœæ—¶æœºæœªåˆ°ï¼Œæˆ–è€…è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œåˆ™å…ˆæ‰§è¡Œä¸€äº›<code>IdleHandler</code>ã€‚</li>
<li>è¿™ä¸€æ­¥å°†ptrç¿»è¯‘æˆä¸€ä¸ªNativeMessageQueueçš„å¯¹è±¡æŒ‡é’ˆï¼Œç„¶åå°†ä»»åŠ¡äº¤ç»™å®ƒæ¥å¤„ç†ã€‚ç›®å‰è¯¥c++æ–‡ä»¶ä½äº<code>frameworks/base/core/jni</code>ç›®å½•ä¸‹ã€‚</li>
<li>NativeMessageåˆå°†ä»»åŠ¡äº¤ç»™c++å±‚çš„Looperæ¥å¤„ç†ã€‚</li>
<li>Looper.cppæ–‡ä»¶ä½äº<code>system/core/libutils</code>ã€‚è¿™é‡ŒåŒæ ·ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­è°ƒç”¨pollInneræ¥åˆ¤æ–­æ—¶å€™æœ‰æ–°æ¶ˆæ¯ã€‚</li>
<li>Looperä¸­æœ‰ä¸€ä¸ªepollå®ä¾‹ï¼Œepollæ˜¯ç”¨æ¥ç›‘å¬IOè¯»å†™çš„ä¸€ç§æœºåˆ¶ï¼Œè¿™é‡Œæ¥ç›‘å¬pipæ˜¯å¦æœ‰è¯»å†™äº‹ä»¶ã€‚è¿™é‡Œä½¿ç”¨epoll_waitæ¥ç­‰å¾…epollä¸­çš„è¯»å†™äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šæ ¹æ®è®¾å®šç¡çœ ä¸€æ®µæ—¶é—´ã€‚å¦‚æœæœ‰äº‹ä»¶ï¼Œåˆ™å¯¹æ¯”è¯¥äº‹ä»¶æè¿°ç¬¦æ˜¯å¦ä¸ºmWakeEventFdæ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨awokenã€‚</li>
<li>å°è¯•ä»mWakeEventFdæ–‡ä»¶æè¿°ç¬¦ä¸­è¯»å‡ºæ•°æ®ï¼Œé‡Œé¢çš„æ•°æ®å¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ã€‚</li>
</ol>
<h2 id="2-çº¿ç¨‹æ¶ˆæ¯å‘é€è¿‡ç¨‹"><a href="#2-çº¿ç¨‹æ¶ˆæ¯å‘é€è¿‡ç¨‹" class="headerlink" title="2. çº¿ç¨‹æ¶ˆæ¯å‘é€è¿‡ç¨‹"></a>2. çº¿ç¨‹æ¶ˆæ¯å‘é€è¿‡ç¨‹</h2><p>Handlerç”¨æ¥å‘ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚å®ƒå†…éƒ¨æœ‰mLooperå’ŒmQueueï¼Œåœ¨æ„é€ Handleræ—¶ï¼Œä¼šå°†å®ƒæ‰€åœ¨çº¿ç¨‹ä¸­çš„Looperè·å–ï¼Œæ”¾å…¥mLooperã€‚<br><img src="http://img.blog.csdn.net/20160918112806764" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>å‘é€ä¸€ä¸ªæ¶ˆæ¯ã€‚</li>
<li>åŠ å…¥å»¶è¿Ÿçš„å‘é€æ¶ˆæ¯ã€‚</li>
<li>åœ¨æŸä¸ªæ—¶é—´ç‚¹å‘é€æ¶ˆæ¯ï¼Œè¿™é‡Œä¼šå°†è¿™ä¸ªæ¶ˆæ¯å’Œå‘é€æ—¶åˆ»æ”¾å…¥é˜Ÿåˆ—ã€‚</li>
<li>å°†messageçš„targetè®¾ä¸ºè¯¥Handlerï¼Œç„¶åå°†messageæ”¾å…¥mQueueã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ ¹æ®æ—¶é—´è¿›è¡Œæ’åºï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ä¼šæ ¹æ®è¯¥æ¶ˆæ¯çš„æ—¶é—´ï¼Œå°†æ¶ˆæ¯æ’å…¥åˆ°é€‚åˆçš„ä½ç½®ã€‚å¦‚æœé˜Ÿåˆ—å¤´å‘ç”Ÿå˜åŒ–ï¼Œå°±è¦è¿›å…¥nativeä¸–ç•Œï¼Œå”¤é†’ç­‰å¾…çš„äººã€‚</li>
<li>è¿™ä¸€å‡½æ•°å¯¹åº”c++ä¸­çš„<code>android_os_MessageQueue_nativeWake</code>ã€‚è¿™é‡Œä¼šå°†ä¼ å…¥çš„ptrè½¬åŒ–ä¸ºä¸€ä¸ªNativeMessageQueueçš„æŒ‡é’ˆã€‚</li>
<li>è°ƒç”¨mLooperçš„wakeå‡½æ•°ã€‚</li>
<li>è¿™ä¸€æ­¥ä¼šå‘mWakeEventFdæè¿°å†™å…¥ä¸€ä¸ªæ•°æ®â€1â€ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œå°±æ˜¯æƒ³è§¦å‘ä¸€ä¸ªIOäº‹ä»¶ï¼Œç„¶åè®©ç­‰å¾…è¿™ä¸ªIOäº‹ä»¶çš„epoll_waitè§¦å‘ã€‚</li>
</ol>
<h2 id="3-çº¿ç¨‹æ¶ˆæ¯å¤„ç†"><a href="#3-çº¿ç¨‹æ¶ˆæ¯å¤„ç†" class="headerlink" title="3. çº¿ç¨‹æ¶ˆæ¯å¤„ç†"></a>3. çº¿ç¨‹æ¶ˆæ¯å¤„ç†</h2><p><img src="http://img.blog.csdn.net/20160918165035114" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>å†æ¬¡å›åˆ°looperå‡½æ•°ï¼Œåœ¨ç¬¬1èŠ‚ä¸­ï¼Œçº¿ç¨‹ä¼šé˜»å¡åœ¨è¯¥å‡½æ•°ä¸­ï¼Œç›´åˆ°è·å–äº†ä¸€ä¸ªæ¶ˆæ¯ã€‚å¦‚æœè·å¾—çš„æ¶ˆæ¯ä¸ºnullï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚å¦åˆ™ï¼Œè·å–æ¶ˆæ¯çš„targetï¼Œä»2.4å¯çŸ¥targetä¸ºä¸€ä¸ªHandlerï¼Œä¸‹é¢çœ‹è¿™ä¸ªHandlerå¦‚ä½•æ´¾å‘æ¶ˆæ¯ã€‚</li>
<li>è¿™é‡Œè¦å¤„ç†ä¸‰ç§æƒ…å†µï¼šç¬¬ä¸€ç§ï¼Œmessageæä¾›äº†è‡ªå·±çš„å›è°ƒå‡½æ•°ï¼Œè§3.3ï¼›ç¬¬äºŒç§ï¼Œä½¿ç”¨Handleræä¾›å›è°ƒå‡½æ•°mCallbackï¼Œè§3.4ï¼›ç¬¬ä¸‰ç§ï¼Œç”±Handlerç»§ç»­å¤„ç†è§3.5ã€‚</li>
<li>è¿™é‡Œmessageçš„callbackå‚æ•°æŒ‡å‘çš„æ˜¯ä¸€ä¸ªRunnableçš„å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ç›´æ¥å¯åŠ¨è¿™ä¸ªå¯¹è±¡çš„runå‡½æ•°å³å¯ã€‚</li>
<li>CallBackæ¥å£ä¸­åªæœ‰handleMessageå‡½æ•°ï¼Œè¿™é‡Œéœ€è¦åœ¨å®šä¹‰Handleræ—¶ï¼Œè®¾å®šä¸€ä¸ªå®ç°CallBackæ¥å£çš„å¯¹è±¡ã€‚</li>
<li>åŒæ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦å­ç±»æ¥å…·ä½“å®ç°çš„å‡½æ•°ã€‚ä¸€èˆ¬æˆ‘ä»¬åœ¨å®šä¹‰ä¸€ä¸ªHandleræ—¶ï¼Œå®šä¹‰çš„æ˜¯ä¸€ä¸ªHandlerå­ç±»ï¼Œåœ¨handleMessageå‡½æ•°ä¸­å®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚</li>
</ol>
<h2 id="4-æ¥ç€è¯´ä¸¤å¥"><a href="#4-æ¥ç€è¯´ä¸¤å¥" class="headerlink" title="4. æ¥ç€è¯´ä¸¤å¥"></a>4. æ¥ç€è¯´ä¸¤å¥</h2><p>åœ¨1.2ä¸­æ¶‰åŠåˆ°çš„IdleHandlerï¼Œåœ¨æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†æ—¶ï¼Œä¼šè°ƒè¿”å›è¿™ä¸ªç©ºé—²Handlerã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªHandlerå¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>åœ¨MessageQueueä¸­ï¼Œæœ‰mIdleHandlersæ¥å­˜æ”¾IdleHandlerã€‚åœ¨nextå‡½æ•°ä¸­ï¼Œå¦‚æœæ²¡æœ‰è·å¾—ä¸€ä¸ªæ¶ˆæ¯ï¼Œåˆ™ä¼šå¼€å§‹å¤„ç†idlerã€‚è¿™é‡Œä¼šåˆ¤æ–­æ˜¯å¦æœ‰idleråœ¨mIdleHandlersä¸­ï¼Œæ²¡æœ‰æˆ–è€…åŸæ¥å·²ç»å‘é€è¿‡ä¸€ä¸ªäº†ï¼Œåˆ™æ— éœ€å‘é€ï¼Œæ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹çš„ä¸€æ¬¡nextè°ƒç”¨ï¼Œæœ€å¤šåªä¼šå‘é€ä¸€æ¬¡idlerã€‚</p>
<p>å¦‚æœæœ‰idlerï¼Œä¸”ä¸ºç¬¬ä¸€æ¬¡å‘é€ï¼Œåˆ™å¼€å§‹å¤„ç†è¿™äº›idlerã€‚è¿™é‡Œä¼šè°ƒç”¨IdleHandlerçš„queueIdlerå‡½æ•°ã€‚åŒæ ·ï¼Œè¿™é‡Œéœ€è¦è‡ªå·±å®ç°IdlerHandleræ¥å£ï¼Œæ¥å¤„ç†ä¸€äº›ä¸ç´§æ€¥çš„äº‹æƒ…ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#åŸºç¡€çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;/a&gt;åŸºç¡€çŸ¥è¯†&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;åŸæ¥å†™å¥½çš„åšå®¢è¢«CSDNç»™å‘äº†ï¼Œæ³•å…‹ï¼Œåªèƒ½é å›å¿†é‡å†™ã€‚    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;ol&gt;
&lt;li&gt;Androidåº”ç”¨ç¨‹åºçš„å››ç§ç»„ä»¶çš†è¿è¡ŒäºActivityThreadä¹‹ä¸­ã€‚ActivityThreadåŒ…å«æœ‰ç¨‹åºå…¥å£mainï¼ŒåŒæ—¶å®ƒä¼šå¯åŠ¨ä¸€ä¸ªå¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯ä¼šè½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¥å¤„ç†å‘é€ç»™å®ƒçš„æ¶ˆæ¯ã€‚è€Œå››ç§ç»„ä»¶åˆ™è¢«è¿™ä¸ªçº¿ç¨‹ç»Ÿä¸€ç®¡ç†ã€‚æ‰€ä»¥ï¼ŒActivityThreadè¿™ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹ï¼Œåƒä¸€ä¸ªæ— ä¼‘æ­¢çš„è½¬åŠ¨çš„æ³•æ¡ï¼Œè€Œå››ä¸ªç»„ä»¶åˆ™åƒæ˜¯è¢«é©±åŠ¨å››ä¸ªé½¿è½®ï¼Œéœ€è¦å®ƒä»¬è½¬åŠ¨æ—¶æ‰ä¼šåœ¨æ³•æ¡çš„å¸¦åŠ¨ä¸‹è¿›è¡Œè½¬åŠ¨ã€‚&lt;/li&gt;
&lt;li&gt;ä¸»çº¿ç¨‹ä¸­æœ‰ä¸€ä¸ªLooperï¼ŒLooperæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå…¶ä¸­åˆæœ‰ä¸€ä¸ªMessageQueueæ¥ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ã€‚MessageQueueåˆæœ‰ä¸€ä¸ªmPtrå˜é‡ï¼Œè®°å½•äº†c++å±‚å¯¹åº”çš„NativeMessageQueueçš„ä½ç½®ã€‚NativeMessageQueueä¹Ÿæœ‰ä¸€ä¸ªc++å±‚çš„Looperï¼Œå®ƒè´Ÿè´£ç®¡ç†pipï¼Œè€Œpipåˆ™æ˜¯è¿›ç¨‹é—´é€šä¿¡çš„é€šé“ã€‚ &lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(9):ContentProvideræ•°æ®æ›´æ–°é€šçŸ¥</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-9-ContentProvider%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E9%80%9A%E7%9F%A5/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-9-ContentProvideræ•°æ®æ›´æ–°é€šçŸ¥/</id>
    <published>2017-02-14T06:05:43.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…"><a href="#1-ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…" class="headerlink" title="1. ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…"></a><em>1.</em> ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…</h2><p><img src="http://img.blog.csdn.net/20160908190740714" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>ç”¨æˆ·ï¼ˆæ¯”å¦‚ä¸€ä¸ªActivityï¼‰æƒ³è¦å®æ—¶è·å¾—æŸé¡¹å†…å®¹çš„å˜åŒ–ï¼Œéœ€è¦æ³¨å†Œç›¸åº”çš„è§‚å¯Ÿè€…ã€‚è¿™ä¸ªè§‚å¯Ÿè€…å¯ä»¥è‡ªå®šï¼Œä½†æ˜¯éœ€è¦ç»§æ‰¿<code>ContentObserver</code>ç±»ï¼Œè¿™ä¸ªç±»çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ªHandleå‚æ•°ï¼Œè¿™ä¸ªHandleå°±æ˜¯ç”¨æ¥å‘ç”¨æˆ·å‘é€æ•°æ®å˜åŒ–æ¶ˆæ¯çš„ã€‚ç„¶åå°†observerä½œä¸ºå‚æ•°ï¼Œåˆ©ç”¨ContentResolverçš„è¿™ä¸ªå‡½æ•°è¿›è¡Œæ³¨å†Œã€‚</li>
<li>åœ¨1.1ä¸­æƒ³è¦æ³¨å†Œobserverï¼Œé¦–å…ˆè¦åˆ©ç”¨è¯¥æ­¥éª¤è·å–<code>ContentService</code>ã€‚ContentServiceæ˜¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œç”±ServiceManagerç®¡ç†ã€‚è¿™ä¸€æ­¥è·å–çš„å®é™…ä¸Šå¸‚ContentServiceçš„Binderä»£ç†å¯¹è±¡ã€‚</li>
<li>åœ¨1.1ä¸­æ³¨å†Œçš„observerå®é™…ä¼ é€’çš„æ˜¯observerçš„Transportç±»å‹çš„Binderä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥è¦ä»observerä¸­è·å¾—è¿™ä¸ªtransportã€‚</li>
<li>è¿™ä¸€æ­¥ä¸ºè¿›ç¨‹é—´å‡½æ•°è°ƒç”¨ã€‚è¿™ä¸€æ­¥ä¼šå°†observeråŠ å…¥åˆ°mRootNodeä¸­ï¼Œå› ä¸ºContentServiceç”¨ä¸€æ£µæ ‘æ¥ç»´æŠ¤æ‰€æœ‰æ³¨å†Œåˆ°è¿™é‡Œçš„è§‚æµ‹è€…ã€‚ç”¨æ ‘ç»“æ„æ˜¯å› ä¸ºURIå¤©ç„¶çš„æ ‘çŠ¶ç»“æ„ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªåœ¨æ ‘ä¸Šå¯»æ‰¾å’Œæ·»åŠ èŠ‚ç‚¹çš„é€’å½’å‡½æ•°ã€‚åœ¨æŒ‰ç…§URIçš„å±‚æ¬¡ç»“æ„å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹æ—¶ï¼Œå¯èƒ½ä¼šåˆ›é€ æ–°çš„èŠ‚ç‚¹ã€‚ç›´åˆ°åŒ¹é…äº†æœ€åçš„èŠ‚ç‚¹ï¼Œå°†observerå°è£…åœ¨ObserverEntryä¸­ï¼Œæ·»åŠ è¿›è¯¥èŠ‚ç‚¹ã€‚</li>
</ol>
<a id="more"></a>
<h2 id="2-Content-Providerå‘é€æ›´æ–°æ¶ˆæ¯"><a href="#2-Content-Providerå‘é€æ›´æ–°æ¶ˆæ¯" class="headerlink" title="2. Content Providerå‘é€æ›´æ–°æ¶ˆæ¯"></a><em>2</em>. Content Providerå‘é€æ›´æ–°æ¶ˆæ¯</h2><p><img src="http://img.blog.csdn.net/20160908190715901" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>Content Providerå¦‚æœæƒ³è¦å‘é€æ›´æ–°é€šçŸ¥ï¼Œéœ€è¦è°ƒç”¨ontifyChangeå‡½æ•°ã€‚è¿™ä¸€æ­¥ä»¥æ–°çš„URIã€å’ŒObserverä¸ºå‚æ•°ï¼Œè¿™é‡Œå°†Observerè®¾ç½®ä¸ºnullã€‚è¿™ä¸€æ­¥ä¼šåšä¸€äº›æ£€æµ‹URIã€observeræ˜¯å¦ä¸ºç©ºçš„å·¥ä½œã€‚æœ€åï¼Œä»ç„¶æ˜¯è·å–ä¸€ä¸ªContentServiceçš„è¿›ç¨‹é—´é€šè®¯ä»£ç†ï¼Œç„¶åè°ƒç”¨ContentServiceçš„notifyChangeå‡½æ•°ã€‚</li>
<li>åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œä¼šä»æ ¹èŠ‚ç‚¹mRootNodeä¸­æ”¶é›†æ‰€æœ‰çš„Observerï¼Œè§2.3ã€‚ç„¶åä¾æ¬¡è°ƒç”¨è¿™äº›Observerçš„onChangeå‡½æ•°ï¼Œè§2.4ã€‚</li>
<li>è¿™ä¸€æ­¥ä¼šæ ¹æ®URIæŒ‡ç¤ºçš„è·¯å¾„ï¼Œä¾æ¬¡éå†æ ‘ä¸Šçš„èŠ‚ç‚¹ã€‚å¯¹äºç»è¿‡çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦å°†è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰å¯¹è¿™ä¸ªæ¶ˆæ¯æ„Ÿå…´è¶£çš„observeréƒ½å°è£…æˆObserverCallæ·»åŠ è¿›å…¥ã€‚</li>
<li>è¿™ä¸€æ­¥ä¹Ÿæ˜¯è¿›ç¨‹é—´çš„å‡½æ•°è°ƒç”¨ã€‚è¿™é‡ŒTransportåˆå°†æ¶ˆæ¯æŠ›ç»™ContentObserverå¤„ç†ã€‚</li>
<li>ContentObserverå°†æ¶ˆæ¯å°è£…è¿›ä¸€ä¸ªNotificationRunnableå‡½æ•°ï¼Œç„¶ååˆ©ç”¨mHandler å°†å…¶postç»™åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹å¤„ç†ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œã€‚è¿™å°†è¦è°ƒç”¨å®ƒçˆ¶ç±»çš„onChangeå‡½æ•°ã€‚</li>
<li>è¿è¡Œè‡ªå·±é‡å†™çš„ContentObserverçš„onChangeå‡½æ•°ï¼Œæ¶ˆæ¯å‘é€å®Œæ¯•ã€‚</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…&quot;&gt;&lt;a href=&quot;#1-ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…&quot; class=&quot;headerlink&quot; title=&quot;1. ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…&quot;&gt;&lt;/a&gt;&lt;em&gt;1.&lt;/em&gt; ç”¨æˆ·æ³¨å†Œå†…å®¹è§‚å¯Ÿè€…&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160908190740714&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç”¨æˆ·ï¼ˆæ¯”å¦‚ä¸€ä¸ªActivityï¼‰æƒ³è¦å®æ—¶è·å¾—æŸé¡¹å†…å®¹çš„å˜åŒ–ï¼Œéœ€è¦æ³¨å†Œç›¸åº”çš„è§‚å¯Ÿè€…ã€‚è¿™ä¸ªè§‚å¯Ÿè€…å¯ä»¥è‡ªå®šï¼Œä½†æ˜¯éœ€è¦ç»§æ‰¿&lt;code&gt;ContentObserver&lt;/code&gt;ç±»ï¼Œè¿™ä¸ªç±»çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ªHandleå‚æ•°ï¼Œè¿™ä¸ªHandleå°±æ˜¯ç”¨æ¥å‘ç”¨æˆ·å‘é€æ•°æ®å˜åŒ–æ¶ˆæ¯çš„ã€‚ç„¶åå°†observerä½œä¸ºå‚æ•°ï¼Œåˆ©ç”¨ContentResolverçš„è¿™ä¸ªå‡½æ•°è¿›è¡Œæ³¨å†Œã€‚&lt;/li&gt;
&lt;li&gt;åœ¨1.1ä¸­æƒ³è¦æ³¨å†Œobserverï¼Œé¦–å…ˆè¦åˆ©ç”¨è¯¥æ­¥éª¤è·å–&lt;code&gt;ContentService&lt;/code&gt;ã€‚ContentServiceæ˜¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡ï¼Œç”±ServiceManagerç®¡ç†ã€‚è¿™ä¸€æ­¥è·å–çš„å®é™…ä¸Šå¸‚ContentServiceçš„Binderä»£ç†å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨1.1ä¸­æ³¨å†Œçš„observerå®é™…ä¼ é€’çš„æ˜¯observerçš„Transportç±»å‹çš„Binderä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥è¦ä»observerä¸­è·å¾—è¿™ä¸ªtransportã€‚&lt;/li&gt;
&lt;li&gt;è¿™ä¸€æ­¥ä¸ºè¿›ç¨‹é—´å‡½æ•°è°ƒç”¨ã€‚è¿™ä¸€æ­¥ä¼šå°†observeråŠ å…¥åˆ°mRootNodeä¸­ï¼Œå› ä¸ºContentServiceç”¨ä¸€æ£µæ ‘æ¥ç»´æŠ¤æ‰€æœ‰æ³¨å†Œåˆ°è¿™é‡Œçš„è§‚æµ‹è€…ã€‚ç”¨æ ‘ç»“æ„æ˜¯å› ä¸ºURIå¤©ç„¶çš„æ ‘çŠ¶ç»“æ„ã€‚&lt;/li&gt;
&lt;li&gt;è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªåœ¨æ ‘ä¸Šå¯»æ‰¾å’Œæ·»åŠ èŠ‚ç‚¹çš„é€’å½’å‡½æ•°ã€‚åœ¨æŒ‰ç…§URIçš„å±‚æ¬¡ç»“æ„å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹æ—¶ï¼Œå¯èƒ½ä¼šåˆ›é€ æ–°çš„èŠ‚ç‚¹ã€‚ç›´åˆ°åŒ¹é…äº†æœ€åçš„èŠ‚ç‚¹ï¼Œå°†observerå°è£…åœ¨ObserverEntryä¸­ï¼Œæ·»åŠ è¿›è¯¥èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(8):ContentProvideræ•°æ®ä¼ è¾“è¿‡ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-8-ContentProvider%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E8%BF%87%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-8-ContentProvideræ•°æ®ä¼ è¾“è¿‡ç¨‹/</id>
    <published>2017-02-14T06:03:37.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ </p>
</blockquote>
<h2 id="1-ç”¨æˆ·å¼€å§‹æŸ¥è¯¢"><a href="#1-ç”¨æˆ·å¼€å§‹æŸ¥è¯¢" class="headerlink" title="1. ç”¨æˆ·å¼€å§‹æŸ¥è¯¢"></a><em>1</em>. ç”¨æˆ·å¼€å§‹æŸ¥è¯¢</h2><p><img src="http://img.blog.csdn.net/20160905214338676" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>ç”¨æˆ·è°ƒç”¨<code>query</code>å‡½æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚é¦–å…ˆå°è¯•è·å¾—providerï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤ç§ï¼Œå…ˆæ˜¯unstableï¼Œåæ˜¯stableï¼Œæš‚æ—¶æ²¡æœ‰åˆ†æ¸…è¿™ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ã€‚åœ¨å°è¯•è·å–Providerçš„è¿‡ç¨‹ä¸­ï¼Œå°†ä¼šç±»ä¼¼äºç¬¬7ç¯‡æ–‡ç« ä¸­çš„è¿‡ç¨‹ã€‚è¿™é‡Œå‡è®¾è¯¥ç”¨æˆ·å·²ç»æœ‰è¯¥providerçš„è®°å½•ï¼Œè·å–è¿‡ç¨‹è§1.2ã€‚åœ¨å–å¾—provideråï¼Œè§1.5ã€‚</li>
<li>ç»§ç»­è·å–Providerã€‚</li>
<li>ç»§ç»­è·å–Providerã€‚</li>
<li>ActivityThreadå°†æ‰€æœ‰å·²ç»è·å¾—çš„Provideræ”¾åœ¨mProviderMapä¸­ã€‚è¿™é‡Œå‡è®¾éœ€è¦è·å–çš„Providerå­˜åœ¨ï¼Œè¿”å›ä¸€ä¸ª<code>IContentProvider</code>ç±»å‹çš„providerï¼Œè¿™ä¸ªæ¥å£æŒ‡å‘äº†Content Providerçš„ä¸€ä¸ªTransportä»£ç†å¯¹è±¡ï¼Œå³ContentProviderProxyå¯¹è±¡ã€‚</li>
<li>ä½¿ç”¨providerçš„ä»£ç†è¿›è¡ŒæŸ¥è¯¢ã€‚è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ª<code>BulkCursorToCursorAdaptor</code>å¯¹è±¡ã€‚è¯¥ç‰ˆæœ¬æ²¡æœ‰åˆ›å»ºCursorWindowå¯¹è±¡ï¼Œå³æ²¡æœ‰åˆ›å»ºåŒ¿åå†…å­˜ï¼Œå’Œæ—§ç‰ˆæœ¬æœ‰äº›åŒºåˆ«ã€‚é‚£ä¹ˆï¼Œæ–°ç‰ˆæœ¬ä¸­åœ¨å“ªé‡Œåˆ›å»ºå…±äº«çš„å†…å­˜åŒºå‘¢ï¼Ÿæœ€åï¼Œå‡†å¤‡é€šè¿‡è¿›ç¨‹é—´é€šä¿¡å‘é€æ¶ˆæ¯ï¼Œç­‰å¾…è¿”å›çš„BulkCursorDescriptorï¼Œç„¶åå¯ä»¥è·å¾—å¯¹åº”çš„BulkCursorToCursorAdaptorï¼Œå³ä¸€ä¸ªAbstractWindowedCursorã€‚</li>
</ol>
<a id="more"></a>
<h2 id="2-Content-Providerå¤„ç†äº‹åŠ¡"><a href="#2-Content-Providerå¤„ç†äº‹åŠ¡" class="headerlink" title="2. Content Providerå¤„ç†äº‹åŠ¡"></a><em>2</em>. Content Providerå¤„ç†äº‹åŠ¡</h2><p><img src="http://img.blog.csdn.net/20160905214406127" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>è¯¥å‡½æ•°è´Ÿè´£å¤„ç†<code>QUERY_TRANSACTION</code>äº‹åŠ¡ã€‚é¦–å…ˆå°†ä¼ å…¥çš„æ•°æ®è§£æå‡ºæ¥ï¼Œç„¶ååˆ©ç”¨å…¶å­ç±»Transportè¿›è¡ŒæŸ¥è¯¢ï¼Œä»2.2~2.6ï¼Œè·å¾—ä¸€ä¸ªSQLiteCursorå¯¹è±¡ã€‚ç„¶åç”¨SQLiteCursorå°è£…æˆCursorToBulkCursorAdapterå¯¹è±¡ã€‚ç„¶ååˆ›å»ºBulkCursorDescriptorï¼Œä»2.7~2.11ï¼Œç›®çš„å°±æ˜¯åˆ›å»ºwindowï¼Œå°†æ•°æ®æ”¾å…¥windowã€‚ç„¶åå°†BulkCursorDescriptorå­˜å…¥replyï¼Œé‡Œé¢åŒ…å«äº†SQLiteCursorçš„binderæœ¬åœ°å¯¹è±¡ï¼Œå› ä¸ºSQLiteCursoré‡Œåˆå«æœ‰windowï¼Œæœ€åè¿”å›ç»™ç”¨æˆ·åï¼Œç”¨æˆ·å¯ä»¥è·å¾—windowé‡Œå­˜å‚¨çš„å†…å®¹ã€‚</li>
<li>è¿™é‡Œä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥æ•°æ®ï¼Œå¦‚æœæœ‰æƒé™ï¼Œåˆ™è°ƒç”¨è‡ªå·±å®ç°çš„ContentProviderå­ç±»çš„queryå‡½æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
<li>è¯¥å‡½æ•°éœ€è¦åœ¨å­ç±»ä¸­é‡è½½ï¼Œå®ç°è‡ªå·±çš„æŸ¥è¯¢è¿‡ç¨‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å‡è®¾ä½¿ç”¨äº†æ•°æ®åº“æŸ¥è¯¢ã€‚</li>
<li>è¿™é‡Œä¼šé¦–å…ˆæ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ›å»ºä¸€æ¡SQLæŸ¥è¯¢è¯­å¥ï¼Œç„¶ååœ¨æ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚</li>
<li>è¿™ä¸€æ­¥ä¼šåˆ›å»ºä¸€ä¸ªæ•°æ®æŸ¥è¯¢driverï¼Œç”¨æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªSQLiteCursorå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº†databaseã€driverã€queryã€‚ä¸‹é¢å°±æ˜¯å°†SQLiteCursorè¿”å›ï¼Œä¸€ç›´è¿”å›åˆ°2.1ä¸­ã€‚</li>
<li>è¯¥æ­¥éª¤ä¼šå¯¹åˆ›å»ºçš„BulkCursorDescriptorè¿›è¡Œä¸€å®šçš„åˆå§‹åŒ–ã€‚</li>
<li>è·å¾—ç”¨æˆ·éœ€è¦çš„æ•°æ®æ¡æ•°ã€‚å¼€å§‹æ—¶ä¸º-1ï¼Œè¯´æ˜å°šæœªæ‰§è¡ŒæŸ¥è¯¢è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸‹é¢è¦æ‰§è¡ŒæŸ¥è¯¢æ•°æ®ï¼ŒåŒæ—¶å°†æ•°æ®æ”¾å…¥å†…å­˜å…±äº«åŒºwindowã€‚</li>
<li>å› ä¸ºwindowè¿˜æ²¡åˆ›å»ºï¼Œæ‰€ä»¥ç¬¬ä¸€ä»¶äº‹æ˜¯å…ˆåˆ›å»ºå…±äº«å†…å­˜åŒºwindowï¼Œè§2.10ã€‚ç„¶åå¡«å……windowï¼Œè§2.11ã€‚</li>
<li>è¿™ä¸€æ­¥ä¼šåˆ›å»ºæ–°çš„windowæˆ–è€…æ¸…ç©ºæ—§çš„windowä»¥é‡å¤åˆ©ç”¨ã€‚è¿™é‡Œçš„windowä»¥æ•°æ®åº“çš„è·¯å¾„ä¸ºåç§°ã€‚åˆ›å»ºCursorWindowçš„è¿‡ç¨‹ä¼šè°ƒç”¨nativeå‡½æ•°ï¼Œè§3.1~3.3ï¼Œæ‰€ä»¥ï¼Œæ–°çš„Androidç‰ˆæœ¬æ”¾å¼ƒäº†åŸæ¥åœ¨ç”¨æˆ·ä¸­åˆ›å»ºwindowçš„æ¨¡å¼ï¼Œè€Œæ˜¯åœ¨Content Providerä¸­ç»Ÿä¸€åˆ›å»ºã€ç®¡ç†windowã€‚</li>
<li>å¡«å……windowï¼Œè¿™é‡ŒåŒæ ·ä¼šä½¿ç”¨sqlçš„ä¸€äº›æ–¹æ³•ï¼Œæœ€åè½è„šäºè°ƒç”¨nativeå‡½æ•°ï¼Œè§4.1~4.3ã€‚æ‰§è¡Œåˆ°è¿™é‡Œï¼Œéœ€è¦æŸ¥è¯¢çš„æ•°æ®å·²ç»è¢«å­˜å‚¨äºwindowä¸­ã€‚</li>
</ol>
<h2 id="3-Provideråˆ›å»ºwindowçš„nativeè¿‡ç¨‹"><a href="#3-Provideråˆ›å»ºwindowçš„nativeè¿‡ç¨‹" class="headerlink" title="3. Provideråˆ›å»ºwindowçš„nativeè¿‡ç¨‹"></a><em>3</em>. Provideråˆ›å»ºwindowçš„nativeè¿‡ç¨‹</h2><p><img src="http://img.blog.csdn.net/20160906191744953" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>åœ¨2.10ä¸­ï¼Œä¼šåˆ›å»ºCursorWindowå¯¹è±¡ï¼Œæ‰€ä»¥ï¼ŒSQLiteCursorè°ƒç”¨äº†CursorWindowçš„æ„é€ å‡½æ•°ã€‚åœ¨è¯¥æ­¥éª¤ä¸­ï¼Œä¼šè®¾ç½®windowçš„å¤§å°ï¼Œè¯¥å¤§å°ä¼šåœ¨èµ„æºæ–‡ä»¶xmlä¸­è®¾ç½®ã€‚ç„¶ååˆ›å»ºwindowçš„è¿‡ç¨‹å°±äº¤ç»™c++ä»£ç å®Œæˆã€‚</li>
<li><code>android_database_CursorWindow.cpp</code>ä½äº<em>frameworks/base/core/jni/</em>ç›®å½•ä¸‹ã€‚è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªCursorWindowå¯¹è±¡windowï¼Œè§3.3ã€‚ç„¶åç”¨<code>reinterpret_cast</code>å‡½æ•°å°†windowæŒ‡é’ˆç±»å‹å˜ä¸ºjlongè¿”å›ã€‚</li>
<li>è¿™é‡Œå°±ä¼šåˆ›å»ºåŒ¿åå†…å­˜å—ã€‚è¿™é‡Œä½¿ç”¨äº†åŒ¿åå†…å­˜åˆ†é…çš„æœºåˆ¶ï¼Œæš‚ä¸æ·±ç©¶ã€‚</li>
</ol>
<h2 id="4-Providerå¡«å……windowçš„nativeè¿‡ç¨‹"><a href="#4-Providerå¡«å……windowçš„nativeè¿‡ç¨‹" class="headerlink" title="4. Providerå¡«å……windowçš„nativeè¿‡ç¨‹"></a><em>4</em>. Providerå¡«å……windowçš„nativeè¿‡ç¨‹</h2><p><img src="http://img.blog.csdn.net/20160906191803016" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>åœ¨2.11ä¸­ï¼Œä¼šå¯¹æ­¥éª¤3ä¸­åˆ›å»ºçš„windowè¿›è¡Œå¡«å……ã€‚è¿™ä¸€æ­¥ä¼šè·å¾—ä¸€ä¸ªSQLiteConnectionå¯¹è±¡ï¼Œç„¶åé€šè¿‡è¿™ä¸ªconnectionè¿›è¡Œæ•°æ®åº“æ“ä½œã€‚</li>
<li>è¿™é‡Œå¼€å§‹è°ƒç”¨native codeæ‰§è¡Œæ•°æ®æŸ¥è¯¢ï¼ŒåŒæ—¶å¡«å……windowã€‚</li>
<li>è¿™é‡Œä¼šé€šè¿‡sqlite3ä¸€è¡Œä¸€è¡Œçš„å°†æ•°æ®copyå…¥windowï¼Œè¿™é‡Œæš‚ä¸æ·±ç©¶sqlite3å¦‚ä½•åœ¨c++ä¸­çš„ä½¿ç”¨è¿‡ç¨‹ã€‚</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;1-ç”¨æˆ·å¼€å§‹æŸ¥è¯¢&quot;&gt;&lt;a href=&quot;#1-ç”¨æˆ·å¼€å§‹æŸ¥è¯¢&quot; class=&quot;headerlink&quot; title=&quot;1. ç”¨æˆ·å¼€å§‹æŸ¥è¯¢&quot;&gt;&lt;/a&gt;&lt;em&gt;1&lt;/em&gt;. ç”¨æˆ·å¼€å§‹æŸ¥è¯¢&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160905214338676&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç”¨æˆ·è°ƒç”¨&lt;code&gt;query&lt;/code&gt;å‡½æ•°è¿›è¡ŒæŸ¥è¯¢ã€‚é¦–å…ˆå°è¯•è·å¾—providerï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤ç§ï¼Œå…ˆæ˜¯unstableï¼Œåæ˜¯stableï¼Œæš‚æ—¶æ²¡æœ‰åˆ†æ¸…è¿™ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ã€‚åœ¨å°è¯•è·å–Providerçš„è¿‡ç¨‹ä¸­ï¼Œå°†ä¼šç±»ä¼¼äºç¬¬7ç¯‡æ–‡ç« ä¸­çš„è¿‡ç¨‹ã€‚è¿™é‡Œå‡è®¾è¯¥ç”¨æˆ·å·²ç»æœ‰è¯¥providerçš„è®°å½•ï¼Œè·å–è¿‡ç¨‹è§1.2ã€‚åœ¨å–å¾—provideråï¼Œè§1.5ã€‚&lt;/li&gt;
&lt;li&gt;ç»§ç»­è·å–Providerã€‚&lt;/li&gt;
&lt;li&gt;ç»§ç»­è·å–Providerã€‚&lt;/li&gt;
&lt;li&gt;ActivityThreadå°†æ‰€æœ‰å·²ç»è·å¾—çš„Provideræ”¾åœ¨mProviderMapä¸­ã€‚è¿™é‡Œå‡è®¾éœ€è¦è·å–çš„Providerå­˜åœ¨ï¼Œè¿”å›ä¸€ä¸ª&lt;code&gt;IContentProvider&lt;/code&gt;ç±»å‹çš„providerï¼Œè¿™ä¸ªæ¥å£æŒ‡å‘äº†Content Providerçš„ä¸€ä¸ªTransportä»£ç†å¯¹è±¡ï¼Œå³ContentProviderProxyå¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨providerçš„ä»£ç†è¿›è¡ŒæŸ¥è¯¢ã€‚è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ª&lt;code&gt;BulkCursorToCursorAdaptor&lt;/code&gt;å¯¹è±¡ã€‚è¯¥ç‰ˆæœ¬æ²¡æœ‰åˆ›å»ºCursorWindowå¯¹è±¡ï¼Œå³æ²¡æœ‰åˆ›å»ºåŒ¿åå†…å­˜ï¼Œå’Œæ—§ç‰ˆæœ¬æœ‰äº›åŒºåˆ«ã€‚é‚£ä¹ˆï¼Œæ–°ç‰ˆæœ¬ä¸­åœ¨å“ªé‡Œåˆ›å»ºå…±äº«çš„å†…å­˜åŒºå‘¢ï¼Ÿæœ€åï¼Œå‡†å¤‡é€šè¿‡è¿›ç¨‹é—´é€šä¿¡å‘é€æ¶ˆæ¯ï¼Œç­‰å¾…è¿”å›çš„BulkCursorDescriptorï¼Œç„¶åå¯ä»¥è·å¾—å¯¹åº”çš„BulkCursorToCursorAdaptorï¼Œå³ä¸€ä¸ªAbstractWindowedCursorã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(7):Content Providerçš„å¯åŠ¨</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-7-ContentProvider%E7%9A%84%E5%90%AF%E5%8A%A8/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-7-ContentProviderçš„å¯åŠ¨/</id>
    <published>2017-02-14T06:01:17.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚   </p>
</blockquote>
<h2 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h2><ul>
<li>Content Providerè¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œå®ƒæœ¬äº‹å°±æ˜¯ä¸€ä¸ªAndroidåº”ç”¨ç¨‹åºã€‚</li>
<li>Binderè¿›ç¨‹é—´é€šä¿¡åªé€‚åˆä¼ é€’ä½“ç§¯è¾ƒå°çš„æ•°æ®ç»“æ„ï¼Œä¸é€‚åˆå¤§é‡æ•°æ®çš„ä¼ è¾“ã€‚æ‰€ä»¥éœ€è¦é‡‡ç”¨åŒ¿åå…±äº«å†…å­˜æ¥ä¼ è¾“ä½“ç§¯è¾ƒå¤§çš„æ•°æ®ã€‚</li>
<li>Cursorå¯¹è±¡é€šè¿‡åŒ¿åå…±äº«å†…å­˜æ¥ä¼ è¾“æ•°æ®ï¼Œè€ŒBundleæ˜¯é€šè¿‡Binderä¼ é€’æ•°æ®ã€‚</li>
</ul>
<a id="more"></a>
<h2 id="1-ç”¨æˆ·å¼€å§‹è°ƒç”¨Provider"><a href="#1-ç”¨æˆ·å¼€å§‹è°ƒç”¨Provider" class="headerlink" title="1. ç”¨æˆ·å¼€å§‹è°ƒç”¨Provider"></a><em>1</em>. ç”¨æˆ·å¼€å§‹è°ƒç”¨Provider</h2><p>é¦–å…ˆï¼ŒActivityé›†æˆçš„ContextWrapperä¸­æœ‰æˆå‘˜å‡½æ•°<code>getContentResolver</code>ï¼Œç”¨è¯¥å‡½æ•°å¯ä»¥è·å¾—ä¸€ä¸ªContentResolverå¯¹è±¡ã€‚è¯¥ContentResolverå¯¹è±¡æ˜¯åœ¨ContextImplå¯¹è±¡å»ºç«‹æ—¶åˆ›å»ºçš„ä¸€ä¸ªApplicationContentResolverå¯¹è±¡ã€‚</p>
<p>ä¸‹é¢ä»ContentResolver.acquireProviderå¼€å§‹ã€‚<br><img src="http://img.blog.csdn.net/20160902220256938" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>æ­¥éª¤1çš„ä¸»è¦ç›®çš„æ˜¯éªŒè¯URIæ˜¯å¦æ­£ç¡®ï¼Œç„¶åå°±ä¼šå°†acquireProviderçš„ä»»åŠ¡äº¤ç»™å­ç±»æ¥å®ç°ï¼Œè¿™é‡Œå®ƒå°†ä»»åŠ¡ä¼ é€’ç»™ApplicationContentResolverã€‚</li>
<li>æ­¥éª¤2ç›´æ¥å°†ä»»åŠ¡ç»™ä¸»çº¿ç¨‹å¤„ç†ã€‚</li>
<li>æ­¥éª¤3å°†ä¼šå°è¯•ä»å·²æœ‰çš„Providerä¸­è·å–ç›®æ ‡Providerï¼ŒActivityThreadå°†å·²ç»è®¿é—®è¿‡çš„Provideræ”¾å…¥mProviderMapä¸­ï¼Œå¦‚æœå…¶ä¸­å«æœ‰éœ€è¦è·å–çš„Providerï¼Œåªéœ€è¦å¢åŠ å¯¹å…¶çš„å¼•ç”¨æ•°ç›®å³å¯ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦è¯·æ±‚ActivityManageræ¥è·å–Providerï¼ˆè§1.4ï¼‰ï¼ŒActivityManageræœ€åä¼šè¿”å›ä¸€ä¸ªContentProviderHolderï¼ˆè§2.2ï¼Œè§6.1ï¼‰ã€‚æœ€åï¼Œéœ€è¦å°†è·å¾—çš„ContentProviderHolderè¿›è¡Œinstall(è§1.5)ã€‚</li>
<li>è¿™é‡Œå‡è®¾æ²¡æœ‰ç°æˆçš„Providerï¼Œåˆ™éœ€è¦äº¤ç»™ActivityManagerè¿›è¡Œå¤„ç†ã€‚</li>
<li>è¿™ä¸€æ­¥å’Œ5.7æ˜¯ä¸€æ ·çš„å‡½æ•°ï¼ŒåŒºåˆ«åœ¨äºè¿™é‡Œçš„holderä¸ä¸ºnullï¼Œæ‰€ä»¥ä¸éœ€è¦è‡ªå·±é€šè¿‡ç±»åŠ è½½åˆ›å»ºProviderï¼Œåªéœ€è¦å°†è¿™ä¸ªProvideræ”¾å…¥mProviderRefCountMapä¸­ï¼Œå¯¹å…¶å¼•ç”¨åŠ 1ã€‚</li>
</ol>
<h2 id="2-ActivityManagerå¤„ç†è¯·æ±‚"><a href="#2-ActivityManagerå¤„ç†è¯·æ±‚" class="headerlink" title="2. ActivityManagerå¤„ç†è¯·æ±‚"></a><em>2</em>. ActivityManagerå¤„ç†è¯·æ±‚</h2><p><img src="http://img.blog.csdn.net/20160902220401299" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>è¿™ä¸€æ­¥æ£€éªŒè°ƒç”¨è€…calleræ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¯´æ˜æ²¡æœ‰åº”ç”¨åœ¨è¯·æ±‚Providerï¼Œåˆ™æ— éœ€ç»§ç»­è¿›è¡Œã€‚</li>
<li>è¿™ä¸€æ­¥æ‰€åšçš„å¤„ç†æ¯”è¾ƒå¤šã€‚é¦–å…ˆï¼ŒManageré¦–å…ˆæ ¹æ®nameåœ¨mProviderMapä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ ¹æ®Classæ¥æŸ¥æ‰¾æ˜¯å¦å·²ç»å¯åŠ¨ã€‚å¦‚æœä»ç„¶æ²¡æœ‰ï¼Œåˆ™æ„å»º<code>ContentProviderRecord</code>ï¼Œé‡Œé¢åŒ…å«äº†<code>ProviderInfo</code>,<code>ApplicationInfo</code>ç­‰é‡è¦ä¿¡æ¯ã€‚ç„¶åï¼Œå¦‚æœæ˜¯<em>multiprocess</em>å±æ€§ä¸º<code>true</code>ï¼Œåˆ™å°†è¯¥<code>ContentProviderRecord</code>ç›´æ¥è¿”å›ç»™è°ƒç”¨è€…ï¼Œè®©å…¶å®ä¾‹åŒ–ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾è¯¥å±æ€§ä¸ºfalseï¼Œéœ€è¦åˆ›å»ºæ–°çš„è¿›ç¨‹æ¥å¯åŠ¨è¯¥Providerã€‚ä¸‹é¢å°±è¦å¼€å§‹å¯åŠ¨æ–°çš„è¿›ç¨‹ï¼Œä¼šåœ¨2.3ä¸­è¯¦ç»†è®²è¿°ï¼Œç„¶åå°†Recordæ”¾å…¥mProviderã€‚æœ€åï¼ŒActivityManagerè¿›å…¥å¾ªç¯ç­‰å¾…providerå¯åŠ¨ï¼Œåœ¨å‘ç°providerå¯åŠ¨åï¼ˆè§6.1ï¼‰ï¼Œåˆ™é€€å‡ºå¾ªç¯ï¼Œå°†ContentProviderHolderè¿”å›ç»™ç”¨æˆ·ï¼ˆè§1.3ï¼‰ã€‚</li>
<li>è¿™ä¸€æ­¥å°±æ˜¯è¿›å…¥å¯åŠ¨æ–°è¿›ç¨‹çš„å‡†å¤‡å·¥ä½œã€‚</li>
</ol>
<h2 id="3-æ–°è¿›ç¨‹çš„å¯åŠ¨"><a href="#3-æ–°è¿›ç¨‹çš„å¯åŠ¨" class="headerlink" title="3. æ–°è¿›ç¨‹çš„å¯åŠ¨"></a><em>3</em>. æ–°è¿›ç¨‹çš„å¯åŠ¨</h2><p><img src="http://img.blog.csdn.net/20160902220422830" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>è¿™é‡Œçš„å¯åŠ¨è¿‡ç¨‹å’ŒåŸæ¥ä¸€æ ·ã€‚</p>
<h2 id="4-ActivityManagerå¤„ç†æ–°çš„è¿›ç¨‹"><a href="#4-ActivityManagerå¤„ç†æ–°çš„è¿›ç¨‹" class="headerlink" title="4. ActivityManagerå¤„ç†æ–°çš„è¿›ç¨‹"></a><em>4</em>. ActivityManagerå¤„ç†æ–°çš„è¿›ç¨‹</h2><p><img src="http://img.blog.csdn.net/20160902220440500" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>è·å–æ–°è¿›ç¨‹pidã€‚</li>
<li>è¿™ä¸€æ­¥å…ˆæ ¹æ®pidè·å¾—å¯¹åº”çš„ProcessRecordï¼Œç„¶åå¡«å……ProcessRecordçš„ä¿¡æ¯ã€‚ç„¶åï¼Œè·å–éœ€è¦åœ¨è¯¥è¿›ç¨‹ä¸­å¯åŠ¨çš„Providerçš„åˆ—è¡¨ï¼Œå°†åœ¨4.3ä¸­è¯¦è§£ã€‚æ¥ä¸‹æ¥ä¾æ¬¡å¯åŠ¨è¯¥è¿›ç¨‹ä¸­çš„Content Providerï¼ˆåœ¨4.4ä¸­è¯¦è§£ï¼‰ã€Activityã€Serviceå’ŒBroadcast Receiverã€‚</li>
<li>è¿™ä¸€æ­¥é€šè¿‡PackageManagerè·å¾—æ‰€æœ‰çš„è¯¥åº”ç”¨è¿›ç¨‹ä¸‹éœ€è¦å¯åŠ¨çš„Providerï¼Œç„¶åä¸ºå…¶åˆ›å»ºContentProviderRecordï¼Œæ”¾å…¥mProviderMapã€‚</li>
<li>å‡†å¤‡å‘æ–°è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚</li>
</ol>
<h2 id="5-Content-Provideråœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨"><a href="#5-Content-Provideråœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨" class="headerlink" title="5. Content Provideråœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨"></a><em>5</em>. Content Provideråœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨</h2><p><img src="http://img.blog.csdn.net/20160902220538532" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>å°†æ”¶åˆ°çš„æ•°æ®å°è£…æˆä¸€ä¸ªAppBindDataï¼Œå‡†å¤‡å‘é€åˆ°ä¸»çº¿ç¨‹ä¸­ã€‚</li>
<li>å‘é€æ¶ˆæ¯ã€‚</li>
<li>å‘é€æ¶ˆæ¯ã€‚</li>
<li>å¤„ç†å¼‚æ­¥æ¶ˆæ¯ã€‚</li>
<li>å‡†å¤‡å¯åŠ¨æ‰€æœ‰çš„Providerã€‚</li>
<li>è¿™ä¸€æ­¥å°†ä¼ é€’è¿‡æ¥çš„æ¯ä¸€ä¸ª<code>ProviderInfo</code>é€šè¿‡<code>installProvider</code>å‡½æ•°ï¼ˆè§5.7ï¼‰å°è£…æˆäº†<code>ContentProviderHolder</code>ã€‚ç„¶åå°†æ‰€æœ‰ç”Ÿæˆçš„<code>ContentProviderHolder</code>å‘ŠçŸ¥ç»™ActivityManagerï¼ˆè§5.11ï¼‰ã€‚</li>
<li>è¿™ä¸€æ­¥æ ¹æ®Providerçš„ç±»åï¼Œä½¿ç”¨ClassLoaderå®ä¾‹åŒ–ä¸€ä¸ªContentProviderå¯¹è±¡ï¼Œå¹¶å¯¹å…¶è¿›è¡Œä¸€å®šçš„åˆå§‹åŒ–ï¼ˆè§5.8ã€5.9ï¼‰å·¥ä½œã€‚ç„¶åï¼Œåˆ›å»ºå¯¹åº”çš„ProviderClientRecordï¼Œå°†å…¶æ”¾å…¥mLocalProviderså’ŒmLocalProvidersByNameã€‚</li>
<li>è·å–è¯¥Providerçš„ç±»å‹ä¸ºTransportçš„Binderæœ¬åœ°å¯¹è±¡ã€‚è¿™ä¸ªBinderå°†ä¼šå‘ŠçŸ¥ç»™ActivityManagerServiceï¼Œç„¶åæœ‰å®ƒå†å‘ŠçŸ¥ç»™éœ€è¦ä½¿ç”¨è¯¥Providerçš„å…¶å®ƒç»„ä»¶ã€‚ç„¶åå…¶å®ƒè¿›ç¨‹ç»„ä»¶å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªBinderæ¥ä½¿ç”¨è¿™ä¸ªprovideräº†ã€‚</li>
<li>è¿™é‡Œä¼šè®¾ç½®è¯¥providerçš„contextï¼ŒåŒæ—¶è®¾ç½®è¯»å†™æƒé™ã€‚æœ€åä¼šè°ƒç”¨é‡å†™çš„onCreateå‡½æ•°ã€‚</li>
<li>è°ƒç”¨è‡ªå·±å®ç°çš„onCreateå‡½æ•°ã€‚</li>
<li>å°†è‡ªå·±çš„Providerå‘ŠçŸ¥ç»™ActivityManagerã€‚</li>
</ol>
<h2 id="6-ActivityManagerå‘å¸ƒProvider"><a href="#6-ActivityManagerå‘å¸ƒProvider" class="headerlink" title="6. ActivityManagerå‘å¸ƒProvider"></a><em>6</em>. ActivityManagerå‘å¸ƒProvider</h2><p><img src="http://img.blog.csdn.net/20160902220606286" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<ol>
<li>è¿™ä¸€æ­¥ä¼šå°†ActivityManageråˆ©ç”¨è·å¾—çš„ContentProviderHolderå¯¹è®°å½•çš„ContentProviderRecordçš„providerè¿›è¡Œå¡«å……ï¼ŒåŒæ—¶å°†è¯¥ContentProviderRecordæ”¾å…¥mProviderMapã€‚æœ€åå°†è¯¥Recordç§»é™¤mLaunchingProvidersã€‚åœ¨2.2ä¸­ç­‰å¾…çš„ActivityManagerServiceçº¿ç¨‹å¾ªç¯ç­‰å¾…å‘ç°providerä¸ä¸ºnullï¼Œé€€å‡ºå¾ªç¯ï¼Œè¿”å›ContentProviderHolderç»™ç”¨æˆ·ï¼ˆè§1.3ï¼‰ã€‚</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚   &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;åŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#åŸºæœ¬çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬çŸ¥è¯†&quot;&gt;&lt;/a&gt;åŸºæœ¬çŸ¥è¯†&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Content Providerè¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œå®ƒæœ¬äº‹å°±æ˜¯ä¸€ä¸ªAndroidåº”ç”¨ç¨‹åºã€‚&lt;/li&gt;
&lt;li&gt;Binderè¿›ç¨‹é—´é€šä¿¡åªé€‚åˆä¼ é€’ä½“ç§¯è¾ƒå°çš„æ•°æ®ç»“æ„ï¼Œä¸é€‚åˆå¤§é‡æ•°æ®çš„ä¼ è¾“ã€‚æ‰€ä»¥éœ€è¦é‡‡ç”¨åŒ¿åå…±äº«å†…å­˜æ¥ä¼ è¾“ä½“ç§¯è¾ƒå¤§çš„æ•°æ®ã€‚&lt;/li&gt;
&lt;li&gt;Cursorå¯¹è±¡é€šè¿‡åŒ¿åå…±äº«å†…å­˜æ¥ä¼ è¾“æ•°æ®ï¼Œè€ŒBundleæ˜¯é€šè¿‡Binderä¼ é€’æ•°æ®ã€‚&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(6)å¹¿æ’­æœºåˆ¶</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-%E5%B9%BF%E6%92%AD%E6%9C%BA%E5%88%B6/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-6-å¹¿æ’­æœºåˆ¶/</id>
    <published>2017-02-14T05:57:56.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶"><a href="#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶" class="headerlink" title="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶"></a>Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶</h1><blockquote>
<p>è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚    </p>
</blockquote>
<h2 id="æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨"><a href="#æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨" class="headerlink" title="æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨"></a>æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨</h2><h3 id="Step1-Activityå¼€å§‹æ³¨å†Œ"><a href="#Step1-Activityå¼€å§‹æ³¨å†Œ" class="headerlink" title="Step1. Activityå¼€å§‹æ³¨å†Œ"></a>Step1. Activityå¼€å§‹æ³¨å†Œ</h3><p><img src="http://img.blog.csdn.net/20160821154639757" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<a id="more"></a>
<h3 id="Step2-ActivityManagerServiceå¤„ç†æ³¨å†Œ"><a href="#Step2-ActivityManagerServiceå¤„ç†æ³¨å†Œ" class="headerlink" title="Step2. ActivityManagerServiceå¤„ç†æ³¨å†Œ"></a>Step2. ActivityManagerServiceå¤„ç†æ³¨å†Œ</h3><p><img src="http://img.blog.csdn.net/20160821154752054" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h2 id="å‘é€å¹¿æ’­"><a href="#å‘é€å¹¿æ’­" class="headerlink" title="å‘é€å¹¿æ’­"></a>å‘é€å¹¿æ’­</h2><h3 id="Step1-Activityå‘é€å¹¿æ’­"><a href="#Step1-Activityå‘é€å¹¿æ’­" class="headerlink" title="Step1. Activityå‘é€å¹¿æ’­"></a>Step1. Activityå‘é€å¹¿æ’­</h3><p><img src="http://img.blog.csdn.net/20160821154940083" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="Step2-ActivityManagerServiceå¤„ç†å¹¿æ’­æ¶ˆæ¯"><a href="#Step2-ActivityManagerServiceå¤„ç†å¹¿æ’­æ¶ˆæ¯" class="headerlink" title="Step2. ActivityManagerServiceå¤„ç†å¹¿æ’­æ¶ˆæ¯"></a>Step2. ActivityManagerServiceå¤„ç†å¹¿æ’­æ¶ˆæ¯</h3><p><img src="http://img.blog.csdn.net/20160821155023461" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h3 id="Step3-Activityæ¥æ”¶å¹¿æ’­"><a href="#Step3-Activityæ¥æ”¶å¹¿æ’­" class="headerlink" title="Step3. Activityæ¥æ”¶å¹¿æ’­"></a>Step3. Activityæ¥æ”¶å¹¿æ’­</h3><p><img src="http://img.blog.csdn.net/20160821155114881" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶&quot;&gt;&lt;a href=&quot;#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶&quot; class=&quot;headerlink&quot; title=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶&quot;&gt;&lt;/a&gt;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ6ï¼‰ï¼šå¹¿æ’­æœºåˆ¶&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨&quot;&gt;&lt;a href=&quot;#æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨&quot; class=&quot;headerlink&quot; title=&quot;æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨&quot;&gt;&lt;/a&gt;æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨&lt;/h2&gt;&lt;h3 id=&quot;Step1-Activityå¼€å§‹æ³¨å†Œ&quot;&gt;&lt;a href=&quot;#Step1-Activityå¼€å§‹æ³¨å†Œ&quot; class=&quot;headerlink&quot; title=&quot;Step1. Activityå¼€å§‹æ³¨å†Œ&quot;&gt;&lt;/a&gt;Step1. Activityå¼€å§‹æ³¨å†Œ&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160821154639757&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(5):Serviceåœ¨è¿›ç¨‹å†…ç»‘å®š</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-Service%E5%9C%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E7%BB%91%E5%AE%9A/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-5-Serviceåœ¨è¿›ç¨‹å†…ç»‘å®š/</id>
    <published>2017-02-14T05:56:11.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š"><a href="#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š" class="headerlink" title="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š"></a>Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š</h1><blockquote>
<p>è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ </p>
</blockquote>
<h2 id="Step1-Activityå¼€å§‹å¯åŠ¨Service"><a href="#Step1-Activityå¼€å§‹å¯åŠ¨Service" class="headerlink" title="Step1. Activityå¼€å§‹å¯åŠ¨Service"></a>Step1. Activityå¼€å§‹å¯åŠ¨Service</h2><p><img src="http://img.blog.csdn.net/20160818225346176" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<a id="more"></a>
<h2 id="Step2-ActivityManagerServiceä¸­å‡†å¤‡"><a href="#Step2-ActivityManagerServiceä¸­å‡†å¤‡" class="headerlink" title="Step2. ActivityManagerServiceä¸­å‡†å¤‡"></a>Step2. ActivityManagerServiceä¸­å‡†å¤‡</h2><p><img src="http://img.blog.csdn.net/20160819144636114" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„æœ‰ä¸¤æ¬¡è¿›ç¨‹é—´é€šä¿¡ï¼Œå…ˆè®²ç¬¬7æ­¥ (Step3)ï¼Œå†è®²ç¬¬9æ­¥(Step4)ã€‚</p>
<h2 id="Step3-Serviceåˆ›å»º"><a href="#Step3-Serviceåˆ›å»º" class="headerlink" title="Step3. Serviceåˆ›å»º"></a>Step3. Serviceåˆ›å»º</h2><p><img src="http://img.blog.csdn.net/20160818225823568" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h2 id="Step4-Serviceå…¬å¸ƒIBinder"><a href="#Step4-Serviceå…¬å¸ƒIBinder" class="headerlink" title="Step4. Serviceå…¬å¸ƒIBinder"></a>Step4. Serviceå…¬å¸ƒIBinder</h2><p><img src="http://img.blog.csdn.net/20160818225912992" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h2 id="Step5-ActivityManagerServiceå…¬å¸ƒService"><a href="#Step5-ActivityManagerServiceå…¬å¸ƒService" class="headerlink" title="Step5. ActivityManagerServiceå…¬å¸ƒService"></a>Step5. ActivityManagerServiceå…¬å¸ƒService</h2><p><img src="http://img.blog.csdn.net/20160819144711212" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h2 id="Step6-Activityå»ºç«‹Connection"><a href="#Step6-Activityå»ºç«‹Connection" class="headerlink" title="Step6. Activityå»ºç«‹Connection"></a>Step6. Activityå»ºç«‹Connection</h2><p><img src="http://img.blog.csdn.net/20160818230007631" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š&quot;&gt;&lt;a href=&quot;#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š&quot; class=&quot;headerlink&quot; title=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š&quot;&gt;&lt;/a&gt;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ5ï¼‰ï¼šServiceåœ¨è¿›ç¨‹å†…ç»‘å®š&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚ &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Step1-Activityå¼€å§‹å¯åŠ¨Service&quot;&gt;&lt;a href=&quot;#Step1-Activityå¼€å§‹å¯åŠ¨Service&quot; class=&quot;headerlink&quot; title=&quot;Step1. Activityå¼€å§‹å¯åŠ¨Service&quot;&gt;&lt;/a&gt;Step1. Activityå¼€å§‹å¯åŠ¨Service&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160818225346176&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(4):Serviceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-4-Service%E5%9C%A8%E6%96%B0%E8%BF%9B%E7%A8%8B%E4%B8%AD%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-4-Serviceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹/</id>
    <published>2017-02-14T05:54:43.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹"><a href="#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹"></a>Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹</h1><blockquote>
<p>è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚   </p>
</blockquote>
<h2 id="Step1-Activityå¼€å§‹å¯åŠ¨Service"><a href="#Step1-Activityå¼€å§‹å¯åŠ¨Service" class="headerlink" title="Step1. Activityå¼€å§‹å¯åŠ¨Service"></a>Step1. Activityå¼€å§‹å¯åŠ¨Service</h2><p><img src="http://img.blog.csdn.net/20160818135053514" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°">  </p>
<a id="more"></a>
<h2 id="Step2-ActivityManagerServiceå‡†å¤‡"><a href="#Step2-ActivityManagerServiceå‡†å¤‡" class="headerlink" title="Step2. ActivityManagerServiceå‡†å¤‡"></a>Step2. ActivityManagerServiceå‡†å¤‡</h2><p><img src="http://img.blog.csdn.net/20160818135157155" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°">    </p>
<h2 id="Step3-ActivityThreadæ–°è¿›ç¨‹å¯åŠ¨"><a href="#Step3-ActivityThreadæ–°è¿›ç¨‹å¯åŠ¨" class="headerlink" title="Step3. ActivityThreadæ–°è¿›ç¨‹å¯åŠ¨"></a>Step3. ActivityThreadæ–°è¿›ç¨‹å¯åŠ¨</h2><p><img src="http://img.blog.csdn.net/20160818135237858" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°">   </p>
<h2 id="Step4-ActivityManagerServiceå¯åŠ¨ç­‰å¾…çš„Service"><a href="#Step4-ActivityManagerServiceå¯åŠ¨ç­‰å¾…çš„Service" class="headerlink" title="Step4. ActivityManagerServiceå¯åŠ¨ç­‰å¾…çš„Service"></a>Step4. ActivityManagerServiceå¯åŠ¨ç­‰å¾…çš„Service</h2><p><img src="http://img.blog.csdn.net/20160818135341778" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<h2 id="Step5-Serveråˆ›å»º"><a href="#Step5-Serveråˆ›å»º" class="headerlink" title="Step5. Serveråˆ›å»º"></a>Step5. Serveråˆ›å»º</h2><p><img src="http://img.blog.csdn.net/20160818135416357" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;/a&gt;Androidç³»ç»Ÿæºç é˜…è¯»ï¼ˆ4ï¼‰ï¼šServiceåœ¨æ–°è¿›ç¨‹ä¸­å¯åŠ¨è¿‡ç¨‹&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚   &lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Step1-Activityå¼€å§‹å¯åŠ¨Service&quot;&gt;&lt;a href=&quot;#Step1-Activityå¼€å§‹å¯åŠ¨Service&quot; class=&quot;headerlink&quot; title=&quot;Step1. Activityå¼€å§‹å¯åŠ¨Service&quot;&gt;&lt;/a&gt;Step1. Activityå¼€å§‹å¯åŠ¨Service&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160818135053514&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;  &lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(3):å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-3-%E5%AD%90Activity%E5%9C%A8%E8%BF%9B%E7%A8%8B%E5%86%85%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-3-å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹/</id>
    <published>2017-02-14T05:51:41.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚</p>
</blockquote>
<h2 id="å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹"><a href="#å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹"></a>å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹</h2><h3 id="Step1-Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity"><a href="#Step1-Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity" class="headerlink" title="Step1. Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity"></a>Step1. Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity</h3><p><img src="http://img.blog.csdn.net/20160817155832276" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>è¿™é‡Œå’Œä»Launcherå¯åŠ¨è¿‡ç¨‹å‡ ä¹æ²¡åˆ†åˆ«ï¼Œä½†æ˜¯å¯åŠ¨æœ‰äº›å‚æ•°çš„è®¾ç½®è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚</p>
<a id="more"></a>
<h3 id="Step2-ActivityManagerServiceå‡†å¤‡"><a href="#Step2-ActivityManagerServiceå‡†å¤‡" class="headerlink" title="Step2. ActivityManagerServiceå‡†å¤‡"></a>Step2. ActivityManagerServiceå‡†å¤‡</h3><p><img src="http://img.blog.csdn.net/20160817160041764" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>åŒæ ·è¿™äº›ä¼šå…ˆåœæ­¢æ­£åœ¨æœ€å‰ç«¯çš„Activityã€‚</p>
<h3 id="Step3-æ—§Activityåœæ­¢"><a href="#Step3-æ—§Activityåœæ­¢" class="headerlink" title="Step3. æ—§Activityåœæ­¢"></a>Step3. æ—§Activityåœæ­¢</h3><p><img src="http://img.blog.csdn.net/20160817160321578" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>åŒæ ·è¿™é‡Œéœ€è¦åœ¨å®Œæˆåœæ­¢è¿‡ç¨‹åå‘ŠçŸ¥ActivityManagerServiceã€‚</p>
<h3 id="Step4-ActivityManagerServiceç»§ç»­å‡†å¤‡"><a href="#Step4-ActivityManagerServiceç»§ç»­å‡†å¤‡" class="headerlink" title="Step4.  ActivityManagerServiceç»§ç»­å‡†å¤‡"></a>Step4.  ActivityManagerServiceç»§ç»­å‡†å¤‡</h3><p><img src="http://img.blog.csdn.net/20160817160534704" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>ä¸‡äº‹ä¿±å¤‡ï¼Œåªå¾…çœŸçš„å¯åŠ¨Activityã€‚</p>
<h3 id="Step5-æ–°Activityåˆ›å»º"><a href="#Step5-æ–°Activityåˆ›å»º" class="headerlink" title="Step5. æ–°Activityåˆ›å»º"></a>Step5. æ–°Activityåˆ›å»º</h3><p><img src="http://img.blog.csdn.net/20160817160656204" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>åˆ°è¿™é‡Œå¯åŠ¨å®Œæ¯•ã€‚</p>
<h2 id="Task-Process-and-Activity"><a href="#Task-Process-and-Activity" class="headerlink" title="Task, Process and Activity"></a>Task, Process and Activity</h2><p>è¿™å‡ ä¸ªæ¦‚å¿µçœŸçš„å¾ˆè®©äººæ··æ·†ï¼Œæœ€åŸºæœ¬çš„ä¸€å¥è¯æ˜¯å®ƒä»¬å‡ ä¸ªæ˜¯å®Œå…¨ä¸åŒçš„æŠ½è±¡æ¦‚å¿µã€‚</p>
<p>å…ˆè¯´Processå’ŒActivityã€‚ä¸€ä¸ªApplicationå¯ä»¥å¤šä¸ªActivityå’Œå¤šä¸ªProcessã€‚ä¸¤ä¸ªActivityå¯ä»¥è¿è¡Œåœ¨ç›¸åŒçš„Processé‡Œï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„Processé‡Œï¼Œè¿™é‡Œå¯ä»¥åœ¨AndroidManifest.xmlä¸­è®¾ç½®<code>android:process</code>ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯è¿è¡Œåœ¨åŒä¸€ä¸ªProcessé‡Œçš„ã€‚å¹¶ä¸”è¯¥è¿›ç¨‹ä¸­çš„Activityã€Serviceéƒ½æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥Serviceä¹Ÿä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ¦‚å¿µï¼Œä¸å¯ä»¥ç›´æ¥åœ¨Serviceä¸­è¿è¡Œè€—æ—¶çš„ä»»åŠ¡ã€‚</p>
<p>TaskåŒæ ·å’ŒProcessæ²¡æœ‰ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚Taskæ˜¯æè¿°Activityè·³è½¬çŠ¶æ€çš„æ ˆï¼Œåˆ©ç”¨åé€€æ“ä½œæ˜¯åœ¨åŒä¸€ä¸ªæ ˆä¸­è¿›è¡ŒActivityçš„å›é€€ï¼›åŒæ ·ï¼ŒæŸä¸€ä¸ªActivityå¯åŠ¨äº†å…¶å®ƒApplicationçš„Activityï¼ˆæ¯”å¦‚ä½ çš„appè°ƒç”¨äº†ç³»ç»Ÿè‡ªå¸¦çš„ç›¸å†Œappï¼‰ï¼Œè¿™ä¸¤ä¸ªActivityåŒæ ·ä¼šæ”¾ç½®äºåŒä¸€ä¸ªæ ˆä¸­ï¼Œè™½ç„¶è¿™ä¸¤ä¸ªacitivityæ˜æ˜¾ä¸åœ¨åŒä¸€ä¸ªApplicationä¸­ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸åœ¨åŒä¸€ä¸ªProcessä¸­ã€‚Taskåœ¨ç”¨æˆ·é€šè¿‡ä»»åŠ¡ç®¡ç†å™¨æ¥åˆ‡æ¢æ—¶ï¼Œåˆ™ä¼šå‘ç”Ÿäº¤æ¢ã€‚å°†å‰å°çš„Taskæ”¾åˆ°åé¢ï¼Œä½ é€‰æ‹©çš„Taskåˆ™ä¼šç½®äºæœ€å‰ç«¯ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;/a&gt;å­Activityåœ¨è¿›ç¨‹å†…çš„å¯åŠ¨è¿‡ç¨‹&lt;/h2&gt;&lt;h3 id=&quot;Step1-Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity&quot;&gt;&lt;a href=&quot;#Step1-Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity&quot; class=&quot;headerlink&quot; title=&quot;Step1. Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity&quot;&gt;&lt;/a&gt;Step1. Activityå¼€å§‹å¯åŠ¨å¦ä¸€ä¸ªActivity&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;http://img.blog.csdn.net/20160817155832276&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot;&gt;&lt;br&gt;è¿™é‡Œå’Œä»Launcherå¯åŠ¨è¿‡ç¨‹å‡ ä¹æ²¡åˆ†åˆ«ï¼Œä½†æ˜¯å¯åŠ¨æœ‰äº›å‚æ•°çš„è®¾ç½®è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(2):æ ¹Activityç»„ä»¶çš„å¯åŠ¨è¿‡ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2-%E6%A0%B9Activity%E7%BB%84%E4%BB%B6%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-2-æ ¹Activityç»„ä»¶çš„å¯åŠ¨è¿‡ç¨‹/</id>
    <published>2017-02-14T05:34:58.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚</p>
</blockquote>
<h2 id="ä»£ç æ‘˜æŠ„"><a href="#ä»£ç æ‘˜æŠ„" class="headerlink" title="ä»£ç æ‘˜æŠ„"></a>ä»£ç æ‘˜æŠ„</h2><h3 id="ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher"><a href="#ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher" class="headerlink" title="ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher"></a>ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher</h3><p>ç›®å‰ç‰ˆæœ¬å·²ç»ä»Launcher2ï¼ˆpackages/apps/Launcher2/src/com/android/launcher2ï¼‰è¿›åŒ–ä¸ºLauncher3ï¼ˆpackages/apps/Launcher3/src/com/android/launcher3ï¼‰ã€‚ä¸¤ä¸ªç‰ˆæœ¬çš„Launcheræœ‰ç€ä¸€å®šçš„å·®å¼‚ï¼Œè€ç½—ä¹¦ä¸­ä»¥Launcher2ä¸ºå‡ºå‘ç‚¹ã€‚</p>
<a id="more"></a>
<p><strong>packages/apps/Launcher2/src/com/android/launcher2/Launcher.java</strong>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</div><div class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// Only launch using the new animation if the shortcut has not opted out (this is a</span></div><div class="line">        <span class="comment">// private contract between launcher and may be ignored in the future).</span></div><div class="line">        <span class="keyword">boolean</span> useLaunchAnimation = (v != <span class="keyword">null</span>) &amp;&amp;</div><div class="line">                !intent.hasExtra(INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION);</div><div class="line">        UserHandle user = (UserHandle) intent.getParcelableExtra(ApplicationInfo.EXTRA_PROFILE);</div><div class="line">        LauncherApps launcherApps = (LauncherApps)</div><div class="line">                <span class="keyword">this</span>.getSystemService(Context.LAUNCHER_APPS_SERVICE);</div><div class="line">        <span class="keyword">if</span> (useLaunchAnimation) &#123;</div><div class="line">            ActivityOptions opts = ActivityOptions.makeScaleUpAnimation(v, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">                    v.getMeasuredWidth(), v.getMeasuredHeight());</div><div class="line">            <span class="keyword">if</span> (user == <span class="keyword">null</span> || user.equals(android.os.Process.myUserHandle())) &#123;</div><div class="line">                <span class="comment">// Could be launching some bookkeeping activity</span></div><div class="line">                startActivity(intent, opts.toBundle());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                launcherApps.startMainActivity(intent.getComponent(), user,</div><div class="line">                        intent.getSourceBounds(),</div><div class="line">                        opts.toBundle());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (user == <span class="keyword">null</span> || user.equals(android.os.Process.myUserHandle())) &#123;</div><div class="line">                startActivity(intent);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                launcherApps.startMainActivity(intent.getComponent(), user,</div><div class="line">                        intent.getSourceBounds(), <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</div><div class="line">        Log.e(TAG, <span class="string">"Launcher does not have the permission to launch "</span> + intent +</div><div class="line">                <span class="string">". Make sure to create a MAIN intent-filter for the corresponding activity "</span> +</div><div class="line">                <span class="string">"or use the exported attribute for this activity. "</span></div><div class="line">                + <span class="string">"tag="</span>+ tag + <span class="string">" intent="</span> + intent, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startActivitySafely</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        success = startActivity(v, intent, tag);</div><div class="line">    &#125; <span class="keyword">catch</span> (ActivityNotFoundException e) &#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</div><div class="line">        Log.e(TAG, <span class="string">"Unable to launch. tag="</span> + tag + <span class="string">" intent="</span> + intent, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> success;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</strong>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</div><div class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// Only launch using the new animation if the shortcut has not opted out (this is a</span></div><div class="line">        <span class="comment">// private contract between launcher and may be ignored in the future).</span></div><div class="line">        <span class="keyword">boolean</span> useLaunchAnimation = (v != <span class="keyword">null</span>) &amp;&amp;</div><div class="line">                !intent.hasExtra(INTENT_EXTRA_IGNORE_LAUNCH_ANIMATION);</div><div class="line">        LauncherAppsCompat launcherApps = LauncherAppsCompat.getInstance(<span class="keyword">this</span>);</div><div class="line">        UserManagerCompat userManager = UserManagerCompat.getInstance(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        UserHandleCompat user = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (intent.hasExtra(AppInfo.EXTRA_PROFILE)) &#123;</div><div class="line">            <span class="keyword">long</span> serialNumber = intent.getLongExtra(AppInfo.EXTRA_PROFILE, -<span class="number">1</span>);</div><div class="line">            user = userManager.getUserForSerialNumber(serialNumber);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Bundle optsBundle = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (useLaunchAnimation) &#123;</div><div class="line">            ActivityOptions opts = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (Utilities.ATLEAST_MARSHMALLOW) &#123;</div><div class="line">                <span class="keyword">int</span> left = <span class="number">0</span>, top = <span class="number">0</span>;</div><div class="line">                <span class="keyword">int</span> width = v.getMeasuredWidth(), height = v.getMeasuredHeight();</div><div class="line">                <span class="keyword">if</span> (v <span class="keyword">instanceof</span> TextView) &#123;</div><div class="line">                    <span class="comment">// Launch from center of icon, not entire view</span></div><div class="line">                    Drawable icon = Workspace.getTextViewIcon((TextView) v);</div><div class="line">                    <span class="keyword">if</span> (icon != <span class="keyword">null</span>) &#123;</div><div class="line">                        Rect bounds = icon.getBounds();</div><div class="line">                        left = (width - bounds.width()) / <span class="number">2</span>;</div><div class="line">                        top = v.getPaddingTop();</div><div class="line">                        width = bounds.width();</div><div class="line">                        height = bounds.height();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                opts = ActivityOptions.makeClipRevealAnimation(v, left, top, width, height);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Utilities.ATLEAST_LOLLIPOP) &#123;</div><div class="line">                <span class="comment">// Below L, we use a scale up animation</span></div><div class="line">                opts = ActivityOptions.makeScaleUpAnimation(v, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">                                v.getMeasuredWidth(), v.getMeasuredHeight());</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Utilities.ATLEAST_LOLLIPOP_MR1) &#123;</div><div class="line">                <span class="comment">// On L devices, we use the device default slide-up transition.</span></div><div class="line">                <span class="comment">// On L MR1 devices, we a custom version of the slide-up transition which</span></div><div class="line">                <span class="comment">// doesn't have the delay present in the device default.</span></div><div class="line">                opts = ActivityOptions.makeCustomAnimation(<span class="keyword">this</span>,</div><div class="line">                        R.anim.task_open_enter, R.anim.no_anim);</div><div class="line">            &#125;</div><div class="line">            optsBundle = opts != <span class="keyword">null</span> ? opts.toBundle() : <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span> || user.equals(UserHandleCompat.myUserHandle())) &#123;</div><div class="line">            <span class="comment">// Could be launching some bookkeeping activity</span></div><div class="line">            startActivity(intent, optsBundle);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// TODO Component can be null when shortcuts are supported for secondary user</span></div><div class="line">            launcherApps.startActivityForProfile(intent.getComponent(), user,</div><div class="line">                    intent.getSourceBounds(), optsBundle);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</div><div class="line">        Log.e(TAG, <span class="string">"Launcher does not have the permission to launch "</span> + intent +</div><div class="line">                <span class="string">". Make sure to create a MAIN intent-filter for the corresponding activity "</span> +</div><div class="line">                <span class="string">"or use the exported attribute for this activity. "</span></div><div class="line">                + <span class="string">"tag="</span>+ tag + <span class="string">" intent="</span> + intent, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startActivitySafely</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (mIsSafeModeEnabled &amp;&amp; !Utilities.isSystemApp(<span class="keyword">this</span>, intent)) &#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.safemode_shortcut_error, Toast.LENGTH_SHORT).show();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        success = startActivity(v, intent, tag);</div><div class="line">    &#125; <span class="keyword">catch</span> (ActivityNotFoundException e) &#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</div><div class="line">        Log.e(TAG, <span class="string">"Unable to launch. tag="</span> + tag + <span class="string">" intent="</span> + intent, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> success;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Androidçš„Singletonæ¨¡å¼çš„å®ç°"><a href="#Androidçš„Singletonæ¨¡å¼çš„å®ç°" class="headerlink" title="Androidçš„Singletonæ¨¡å¼çš„å®ç°"></a>Androidçš„Singletonæ¨¡å¼çš„å®ç°</h3><p>åœ¨<strong>frameworks/base/core/java/android/app/ActivityManagerNative.java</strong>ä¸­<code>IActivityManager</code>æ˜¯ä¸€ä¸ªå•åˆ©æ¨¡å¼ï¼Œæ‰€ä»¥Androidå®ç°äº†ä¸€ä¸ªå¾ˆæ ‡å‡†çš„Singletonã€‚åœ¨è€ç½—ç‰ˆæœ¬é‡Œï¼Œæ²¡æœ‰ä½¿ç”¨è¿™ä¸ªç±»ã€‚</p>
<p><strong>framework/base/core/java/android/util/Singleton.java</strong>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Singleton helper class for lazily initialization.</div><div class="line"> *</div><div class="line"> * Modeled after frameworks/base/include/utils/Singleton.h</div><div class="line"> *</div><div class="line"> * <span class="doctag">@hide</span></div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T mInstance;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">create</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                mInstance = create();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> mInstance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ActivityManagerService"><a href="#ActivityManagerService" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h3><p>æ˜¾ç„¶ï¼ŒAcitivityManagerServiceçš„ä½ç½®ç”±<code>frameworks/base/services/java/com/android/service/am/ActivityManagerService.java</code>è½¬ç§»è‡³<code>frameworks/base/services/core/java/com/android/service/am/ActivityManagerService.java</code>ã€‚åŒæ—¶<code>startActivity</code>å‡½æ•°ä¹Ÿæœ‰æ‰€æ”¹å˜ï¼š</p>
<p><strong>frameworks/base/services/core/java/com/android/service/am/ActivityManagerService.java</strong>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) &#123;</div><div class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">        resultWho, requestCode, startFlags, profilerInfo, options,</div><div class="line">        UserHandle.getCallingUserId());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId) &#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</div><div class="line">    userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</div><div class="line">            <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></div><div class="line">    <span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸»è¦çš„å˜åŒ–æ˜¯æ·»åŠ äº†ç”¨æˆ·çš„æ¦‚å¿µï¼ŒåŒæ—¶åŠ å…¥äº†mStackSupervisorï¼ˆActivityStackSuperVisorï¼‰æ¥ç®¡ç†ActivityStackã€‚</p>
<h2 id="æ ¹Activityå¯åŠ¨è¿‡ç¨‹"><a href="#æ ¹Activityå¯åŠ¨è¿‡ç¨‹" class="headerlink" title="æ ¹Activityå¯åŠ¨è¿‡ç¨‹"></a>æ ¹Activityå¯åŠ¨è¿‡ç¨‹</h2><p>ä¸‹é¢å°†ç”¨é¡ºåºå›¾æ¥å±•ç¤ºæ ¹Activityæ˜¯å¦‚ä½•ä»æ¡Œé¢å¯åŠ¨çš„ã€‚</p>
<h3 id="Step1-Launcherå¯åŠ¨ä¸€ä¸ªAPP"><a href="#Step1-Launcherå¯åŠ¨ä¸€ä¸ªAPP" class="headerlink" title="Step1. Launcherå¯åŠ¨ä¸€ä¸ªAPP"></a>Step1. Launcherå¯åŠ¨ä¸€ä¸ªAPP</h3><p><img src="http://img.blog.csdn.net/20160816201736649" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>å½“ç”¨æˆ·ç‚¹å‡»æŸä¸€ä¸ªåº”ç”¨å›¾æ ‡ï¼Œæ„å‘³ç€éœ€è¦å¯åŠ¨ä¸€ä¸ªåº”ç”¨çš„æ ¹Activityã€‚Launcherä¹Ÿæ˜¯ä¸€ä¸ªåº”ç”¨ï¼Œå’Œæ™®é€šåº”ç”¨å¯åŠ¨Activityè¿‡ç¨‹ç±»ä¼¼ã€‚è¿™é‡Œå±•ç¤ºäº†åœ¨Launcherä¸­çš„è¿›è¡Œçš„æ­¥éª¤ï¼Œæœ€åé€šè¿‡Binderä¸ActivityMangerServiceè¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œå‘ŠçŸ¥å®ƒæ¥å¯åŠ¨Activityã€‚</p>
<h3 id="Step2-ActivityMangerServiceè¿›è¡Œå‡†å¤‡å·¥ä½œ"><a href="#Step2-ActivityMangerServiceè¿›è¡Œå‡†å¤‡å·¥ä½œ" class="headerlink" title="Step2. ActivityMangerServiceè¿›è¡Œå‡†å¤‡å·¥ä½œ"></a>Step2. ActivityMangerServiceè¿›è¡Œå‡†å¤‡å·¥ä½œ</h3><p><img src="http://img.blog.csdn.net/20160817161257468" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>è¿™é‡Œä¸»è¦å·¥ä½œå°±è¡Œå°†éœ€è¦å¯åŠ¨çš„Activityæ”¾ç½®äºæ ˆé¡¶ï¼Œç­‰å¾…å¯åŠ¨ã€‚åœ¨å¯åŠ¨æ–°Activityå‰ï¼Œéœ€è¦å°†æ—§çš„Activityå…ˆåœæ­¢ä¸‹æ¥ã€‚</p>
<h3 id="Step3-æ—§Activityåœæ­¢"><a href="#Step3-æ—§Activityåœæ­¢" class="headerlink" title="Step3. æ—§Activityåœæ­¢"></a>Step3. æ—§Activityåœæ­¢</h3><p><img src="http://img.blog.csdn.net/20160816203017385" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>åœ¨è¿™é‡Œï¼Œéœ€è¦åœæ­¢çš„Activityå°±æ˜¯Launcherçš„Activityã€‚åœ¨å®Œæˆåœæ­¢çš„è¿‡ç¨‹åï¼Œéœ€è¦å‘ŠçŸ¥ActivityMangerServiceã€‚</p>
<h3 id="Step4-ActivityMangerServiceç»§ç»­å‡†å¤‡"><a href="#Step4-ActivityMangerServiceç»§ç»­å‡†å¤‡" class="headerlink" title="Step4. ActivityMangerServiceç»§ç»­å‡†å¤‡"></a>Step4. ActivityMangerServiceç»§ç»­å‡†å¤‡</h3><p><img src="http://img.blog.csdn.net/20160816203325622" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>è¿™é‡Œä¼šå‘ç°è¯¥Activityè¿˜æ²¡æœ‰è¿›ç¨‹å¯ä»¥è¿è¡Œï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯åŠ¨ä¸€ä¸ªæ–°çš„ActvityThreadè¿›ç¨‹ã€‚</p>
<h3 id="Step5-ActivityThreadè¿›ç¨‹å¯åŠ¨"><a href="#Step5-ActivityThreadè¿›ç¨‹å¯åŠ¨" class="headerlink" title="Step5. ActivityThreadè¿›ç¨‹å¯åŠ¨"></a>Step5. ActivityThreadè¿›ç¨‹å¯åŠ¨</h3><p><img src="http://img.blog.csdn.net/20160816203708629" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>ç­‰è¿›ç¨‹å¯åŠ¨å®Œæ¯•åï¼ŒåŒæ ·éœ€è¦ActivityMangerServiceï¼Œä»¥ä¾¿å®ƒå°†ç­‰å¾…è¯¥è¿›ç¨‹çš„Activityå¯åŠ¨èµ·æ¥ã€‚</p>
<h3 id="Step6-ActivityMangerServiceç»§ç»­å¯åŠ¨"><a href="#Step6-ActivityMangerServiceç»§ç»­å¯åŠ¨" class="headerlink" title="Step6. ActivityMangerServiceç»§ç»­å¯åŠ¨"></a>Step6. ActivityMangerServiceç»§ç»­å¯åŠ¨</h3><p><img src="http://img.blog.csdn.net/20160816205231942" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>è¿™é‡Œä¼šå°†ç­‰å¾…è¯¥è¿›ç¨‹çš„Activityå’ŒServiceå¯åŠ¨èµ·æ¥ã€‚</p>
<h3 id="Step7-æ–°Activityå¯åŠ¨"><a href="#Step7-æ–°Activityå¯åŠ¨" class="headerlink" title="Step7. æ–°Activityå¯åŠ¨"></a>Step7. æ–°Activityå¯åŠ¨</h3><p><img src="http://img.blog.csdn.net/20160816205319833" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>åˆ°è¿™é‡Œï¼Œå¯åŠ¨è¿‡ç¨‹ç»“æŸ</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;è¯¥ç³»åˆ—åªè®°å½•é˜…è¯»ä»£ç æ—¶é‡åˆ°çš„é—®é¢˜å’Œå¿ƒå¾—ä½“ä¼šï¼Œå…·ä½“ä»£ç è®²è§£å¯ä»¥å‚è€ƒè€ç½—çš„ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹ï¼Œæˆ‘å°±ä¸ç­é—¨å¼„æ–§äº†ã€‚æˆ‘ç¼–è¯‘çš„AOSPç‰ˆæœ¬ï¼š6.0.1_r50ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ä»£ç æ‘˜æŠ„&quot;&gt;&lt;a href=&quot;#ä»£ç æ‘˜æŠ„&quot; class=&quot;headerlink&quot; title=&quot;ä»£ç æ‘˜æŠ„&quot;&gt;&lt;/a&gt;ä»£ç æ‘˜æŠ„&lt;/h2&gt;&lt;h3 id=&quot;ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher&quot;&gt;&lt;a href=&quot;#ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher&quot; class=&quot;headerlink&quot; title=&quot;ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher&quot;&gt;&lt;/a&gt;ä¸¤ä¸ªç‰ˆæœ¬çš„Launcher&lt;/h3&gt;&lt;p&gt;ç›®å‰ç‰ˆæœ¬å·²ç»ä»Launcher2ï¼ˆpackages/apps/Launcher2/src/com/android/launcher2ï¼‰è¿›åŒ–ä¸ºLauncher3ï¼ˆpackages/apps/Launcher3/src/com/android/launcher3ï¼‰ã€‚ä¸¤ä¸ªç‰ˆæœ¬çš„Launcheræœ‰ç€ä¸€å®šçš„å·®å¼‚ï¼Œè€ç½—ä¹¦ä¸­ä»¥Launcher2ä¸ºå‡ºå‘ç‚¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Androidç³»ç»Ÿæºç é˜…è¯»(1):ç¼–è¯‘</title>
    <link href="http://itanch.github.io/2017/02/14/Android%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-1-%E7%BC%96%E8%AF%91/"/>
    <id>http://itanch.github.io/2017/02/14/Androidç³»ç»Ÿæºç é˜…è¯»-1-ç¼–è¯‘/</id>
    <published>2017-02-14T05:31:31.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-ç¼–è¯‘è¿‡ç¨‹"><a href="#1-ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="1. ç¼–è¯‘è¿‡ç¨‹"></a>1. ç¼–è¯‘è¿‡ç¨‹</h2><p>å‚è€ƒ<a href="https://source.android.com/source/building.html" target="_blank" rel="external">å®˜æ–¹</a>ï¼Œæ³¨æ„ç»†èŠ‚ã€‚ </p>
<p>ç¼–è¯‘ç‰ˆæœ¬<code>6.0.1_r50</code>ã€‚</p>
<h3 id="1-1-ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#1-1-ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="1.1 ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶"></a>1.1 ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶</h3><p>å¦‚æœæƒ³è¦å°†ç¼–è¯‘å¥½çš„imgåˆ·å…¥ç‰©ç†è®¾å¤‡ï¼Œè€Œä¸æ˜¯è™šæ‹Ÿæœºï¼Œä¸€å®šè¦å…ˆä¸‹è½½å¥½è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¾åœ¨AOSPçš„æ ¹ç›®å½•ä¸‹ã€‚</p>
<p><a href="https://developers.google.com/android/nexus/drivers" target="_blank" rel="external">äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½</a>ã€‚ä¸‹è½½å®Œæ¯•åå¹¶è§£å‹åï¼Œä¼šæœ‰shæ–‡ä»¶ç”Ÿæˆï¼›è¿è¡Œshæ–‡ä»¶ï¼Œä¼šåœ¨AOSPç›®å½•ä¸‹ç”Ÿæˆ<code>vendor/</code>æ–‡ä»¶å¤¹ï¼Œå¿…è¦çš„æ–‡ä»¶ä¼šæ”¾åœ¨é‡Œé¢ã€‚ç„¶åå†æ‰§è¡Œç¼–è¯‘ã€‚</p>
<a id="more"></a>
<h3 id="1-2-ç¼–è¯‘"><a href="#1-2-ç¼–è¯‘" class="headerlink" title="1.2 ç¼–è¯‘"></a>1.2 ç¼–è¯‘</h3><p>å…ˆæ¸…ç†ä¸€ä¸‹æ—§çš„ç”Ÿæˆæ–‡ä»¶ï¼Œä¸ªäººè®¤ä¸ºå¾ˆæœ‰å¿…è¦ã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">make clobber</div><div class="line">``` </div><div class="line"></div><div class="line">ç„¶åè®¾ç½®ç¯å¢ƒå˜é‡:  </div><div class="line">```sh</div><div class="line">$ <span class="built_in">source</span> build/envsetup.sh</div><div class="line"><span class="comment"># æˆ–è€…</span></div><div class="line">$ . build/envsetup.sh</div></pre></td></tr></table></figure></p>
<p>è®¾ç½®java ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œæ ¹æ®ä½ çš„AOSPé€‰æ‹©javaç‰ˆæœ¬ï¼Œè®¾ç½®é€‚å½“çš„javaè·¯å¾„:<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>export JAVA_HOME=<span class="regexp">/usr/lib</span><span class="regexp">/jvm/java</span>-<span class="number">7</span>-openjdk-amd64</div><div class="line"><span class="variable">$ </span>export PATH=<span class="variable">$JAVA_HOME</span>/<span class="symbol">bin:</span><span class="variable">$PATH</span></div></pre></td></tr></table></figure></p>
<p>è®¾ç½®ç¼“å­˜åŒºåŸŸï¼Œæ ¹æ®è‡ªå·±æƒ…å†µè®¾ç½®ï¼š<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">export USE_CCACHE=<span class="number">1</span></div><div class="line">export CCACHE_DIR=<span class="regexp">/home/</span>tianchi<span class="regexp">/Project/</span>.ccache </div><div class="line">prebuilts<span class="regexp">/misc/</span>linux-x86<span class="regexp">/ccache/</span>ccache -M <span class="number">50</span>G</div></pre></td></tr></table></figure></p>
<p>é€‰æ‹©éœ€è¦ç¼–è¯‘çš„ç›®æ ‡ï¼š<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">launch</span></div><div class="line"><span class="comment">#é€‰æ‹©ä½ æƒ³è¦ç¼–è¯‘çš„ç‰ˆæœ¬</span></div></pre></td></tr></table></figure></p>
<p>å¼€å§‹ç¼–è¯‘ï¼Œè®¾ç½®ç¼–è¯‘æ—¶ç”¨åˆ°çš„å†…æ ¸æ•°ç›®ï¼Œè¿™é‡Œå†™ï¼”ï¼š<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>make -j4</div></pre></td></tr></table></figure></p>
<p>ç¨ç­‰å‡ ä¸ªå°æ—¶ï¼Œå‘µå‘µï¼Œå¥‡è¿¹å°±ä¼šå‘ç”Ÿã€‚ç”Ÿæˆçš„ç»“æœä½äº<code>out/target/product/flo/</code>ï¼Œ<code>flo</code>æ˜¯æˆ‘Nexus 7çš„å‹å·ï¼Œå’Œlaunchæ—¶é€‰æ‹©çš„ç‰ˆæœ¬ç›¸åŒã€‚</p>
<h2 id="2-åˆ·å…¥çœŸæœº"><a href="#2-åˆ·å…¥çœŸæœº" class="headerlink" title="2. åˆ·å…¥çœŸæœº"></a>2. åˆ·å…¥çœŸæœº</h2><p>å°†ç¼–è¯‘å¥½çš„imgæ–‡ä»¶åˆ·å…¥è®¾å¤‡æ¯”è¾ƒå®¹æ˜“ï¼Œå…³é”®ç‚¹åœ¨äºå‰é¢æ­¥éª¤ï¼šä¸‹è½½äº†ç¬¬ä¸‰æ–¹åŒ…ï¼Œé€‰æ‹©äº†æ­£ç¡®çš„ç¼–è¯‘ç‰ˆæœ¬ã€‚</p>
<p>é‡å¯è®¾å¤‡è¿›å…¥fastbootæ¨¡å¼ï¼Œä½¿ç”¨å‘½ä»¤ï¼Œè¿™é‡Œåˆ·å…¥çš„Nexus7ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ fastboot -<span class="selector-tag">p</span> flo flashall</div></pre></td></tr></table></figure></p>
<h2 id="3-å¯åŠ¨emulatoré—®é¢˜"><a href="#3-å¯åŠ¨emulatoré—®é¢˜" class="headerlink" title="3. å¯åŠ¨emulatoré—®é¢˜"></a>3. å¯åŠ¨emulatoré—®é¢˜</h2><p>æƒ³è¦åœ¨è™šæ‹Ÿæœºé‡Œè·‘èµ·æ¥ï¼Œéœ€è¦åœ¨<code>launch</code>æ­¥éª¤ä¸­é€‰æ‹©æ­£ç¡®çš„è™šæ‹Ÿæœºç‰ˆæœ¬ï¼Œé»˜è®¤ç¬¬ä¸€ä¸ªã€‚</p>
<p>ç›¸å…³å·¥å…·emulatorå’Œkernel-qemué»˜è®¤æ”¾ç½®ç›®å½•å·²ç»ä¸åœ¨<code>out/host/linux-xxx/bin</code>ï¼Œå·²ç»è¿ç§»åˆ°<code>prebuilts/android-emulator/linux-x86_64/emulator</code>å’Œ<code>/prebuilts/qemu-kernel/x86_64/kernel-qemu</code>ç­‰ç›¸å¯¹åº”çš„ä½ç½®ã€‚  </p>
<p>å¸¸ç”¨çš„å¯åŠ¨å‘½ä»¤ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">prebuilts/android-emulator/linux-x86_64/emulator -kernel ./prebuilts/qemu-k ernel/x86_64/kernel-qemu -sysdir out/target/product/generic/ -system system.img -data userdata.img -ramdisk ramdisk.img</div><div class="line">```  </div><div class="line">è¯¥å‘½ä»¤å¯åŠ¨ä¼šå‡ºç°å„ç§å„æ ·çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</div></pre></td></tr></table></figure></p>
<p>qemu: could not load initrd â€˜ramdisk.imgâ€™<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">è™½ç„¶æœ‰äººå·²ç»ç»™å‡ºäº†ç›¸å…³è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚å»æ‰`-ramdisk ramdisk.img`ï¼Œæˆ–è€…ä¿®æ”¹`chmod -R <span class="number">777</span> out/target/product/generic/`æ¥å¢åŠ æƒé™ï¼Œæˆ–è€…ä¿®æ”¹`/prebuilts/qemu-k ernel/x86_64/kernel-qemu`ä¸ºåˆé€‚çš„ç³»ç»Ÿç‰ˆæœ¬ã€‚è¿™äº›è§£å†³æ–¹æ³•æœ‰çš„ä¸å¤ªæœ‰æ•ˆï¼Œæ€»ä¹‹ä¸æ˜¯å¾ˆä¼˜ç¾ï¼Œå…¶å®å®˜æ–¹å·²ç»æä¾›äº†ä¸€ä¸ªå¯åŠ¨emulatorçš„çœå¿ƒæ–¹æ³•ï¼š   </div><div class="line">```sh</div><div class="line"># é¦–å…ˆåŠ å…¥åŸºæœ¬çš„ç¯å¢ƒå˜é‡</div><div class="line">$ source build/envsetup.sh</div><div class="line"></div><div class="line"># é€‰æ‹©éœ€è¦å¯åŠ¨çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå› ä¸ºæˆ‘ç¼–è¯‘çš„<span class="number">1</span>ï¼Œæ‰€ä»¥ä¸€å®šè¦é€‰æ‹©<span class="number">1</span>.</div><div class="line">$ lunch</div><div class="line"></div><div class="line">You're building on Linux</div><div class="line"></div><div class="line"><span class="symbol">Lunch menu... pick a combo:</span></div><div class="line">     <span class="number">1</span>. aosp_arm-eng</div><div class="line">     <span class="number">2</span>. aosp_arm64-eng</div><div class="line">     <span class="number">3</span>. aosp_mips-eng</div><div class="line">     <span class="number">4</span>. aosp_mips64-eng</div><div class="line">     <span class="number">5</span>. aosp_x86-eng</div><div class="line">     <span class="number">6</span>. aosp_x86_64-eng</div><div class="line">     <span class="number">7</span>. aosp_deb-userdebug</div><div class="line">     <span class="number">8</span>. aosp_flo-userdebug</div><div class="line">     <span class="number">9</span>. full_fugu-userdebug</div><div class="line">     <span class="number">10</span>. aosp_fugu-userdebug</div><div class="line">     <span class="number">11</span>. mini_emulator_arm64-userdebug</div><div class="line">     <span class="number">12</span>. m_e_arm-userdebug</div><div class="line">     <span class="number">13</span>. mini_emulator_mips-userdebug</div><div class="line">     <span class="number">14</span>. mini_emulator_x86_64-userdebug</div><div class="line">     <span class="number">15</span>. mini_emulator_x86-userdebug</div><div class="line">     <span class="number">16</span>. aosp_flounder-userdebug</div><div class="line">     <span class="number">17</span>. aosp_angler-userdebug</div><div class="line">     <span class="number">18</span>. aosp_bullhead-userdebug</div><div class="line">     <span class="number">19</span>. aosp_hammerhead-userdebug</div><div class="line">     <span class="number">20</span>. aosp_hammerhead_fp-userdebug</div><div class="line">     <span class="number">21</span>. aosp_shamu-userdebug</div><div class="line"> </div><div class="line"># å¯åŠ¨emulator</div><div class="line">$ emulator</div></pre></td></tr></table></figure></p>
<h2 id="4-åœ¨Android-Studioä¸­é˜…è¯»æºç "><a href="#4-åœ¨Android-Studioä¸­é˜…è¯»æºç " class="headerlink" title="4. åœ¨Android Studioä¸­é˜…è¯»æºç "></a>4. åœ¨Android Studioä¸­é˜…è¯»æºç </h2><p>Androidå·¥ç¨‹å¸ˆå¾ˆåœ°é“ï¼Œè€ƒè™‘åˆ°äº†å¦‚ä½•æ–¹ä¾¿çš„å°†é¡¹ç›®å¯¼å…¥AndroidStudioã€‚åœ¨ç¼–è¯‘å®Œæˆï¼Œç¯å¢ƒå˜é‡é…ç½®å¥½çš„å‰æä¸‹ï¼Œè¿›è¡Œä¸‹é¢æ­¥éª¤ã€‚</p>
<h3 id="4-1-ç”Ÿæˆidegen"><a href="#4-1-ç”Ÿæˆidegen" class="headerlink" title="4.1 ç”Ÿæˆidegen"></a>4.1 ç”Ÿæˆidegen</h3><p>ç¼–è¯‘idegen:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mmm development<span class="regexp">/tools/i</span>degen</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œidegen:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ development<span class="regexp">/tools/i</span>degen<span class="regexp">/idegen.sh</span></div></pre></td></tr></table></figure></p>
<p>ç„¶åï¼Œä½ å°±å›åœ¨AOSPç›®å½•ä¸‹å‘ç°ï½€android.iprï½€ç­‰æ–‡ä»¶ã€‚</p>
<h3 id="4-2-å¯¼å…¥"><a href="#4-2-å¯¼å…¥" class="headerlink" title="4.2 å¯¼å…¥"></a>4.2 å¯¼å…¥</h3><p>æ‰“å¼€AndroidStudioï¼Œé€‰æ‹©å¯¼å…¥å·²æœ‰çš„é¡¹ç›®ï¼Œé€‰æ‹©android.iprã€‚è¿™é‡Œéœ€è¦å¯¼å…¥ä¸€æ®µæ—¶é—´ã€‚</p>
<p>å¯¼å…¥åä¼šå‘ç°é”™è¯¯ç™¾å‡ºã€‚é¦–å…ˆæ‰“å¼€Project Structureï¼Œé€‰æ‹©ï½€SDKsï½€æ·»åŠ ä¸€ä¸ªSDKï¼Œæˆ‘è¿™é‡Œéœ€è¦1.7ï¼š<br><img src="http://img.blog.csdn.net/20160930163851944" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>æ¸…ç†ClassPathä¸‹çš„æ‰€æœ‰jaråŒ…ï¼Œç„¶åä¿å­˜ã€‚</p>
<p>é€‰æ‹©<code>Project</code>ï¼Œé€‰æ‹©Project SDKä¸ºæ–°å»ºçš„SDKï¼ŒProject language levelä¹Ÿè®¾ç½®ä¸ºå¯¹åº”çš„ç­‰çº§ã€‚<br><img src="http://img.blog.csdn.net/20160930164516796" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<p>é€‰æ‹©<code>Modules</code>ï¼Œåœ¨<code>Dependencies</code>æ ‡ç­¾ä¸‹ï¼Œåˆ é™¤jar ä¾èµ–ï¼Œæœ€åå¦‚ä¸‹ï¼š<br><img src="http://img.blog.csdn.net/20160930164739735" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
<p>ç„¶ååœ¨<code>Modules</code>ä¸‹ï¼Œ<code>Sources</code>æ ‡ç­¾ä¸‹ï¼Œé€‰æ‹©<code>out/target/common/R</code>æ–‡ä»¶ï¼Œé€‰æ‹©å³é”®Sourceã€‚<br><img src="http://img.blog.csdn.net/20160930165042758" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"><br>è¿™é‡Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¼šå› ä¸ºRæ–‡ä»¶è¿‡å¤§ï¼Œå¯¼è‡´ä¾ç„¶æŠ¥é”™ã€‚è¿™æ—¶éœ€è¦ä¿®æ”¹AndroidStudioåº”ç”¨ç›®å½•ä¸‹<code>Android_Studio/bin/idea.properties</code>æ–‡ä»¶ï¼Œæ‰¾åˆ°filesizeï¼Œå°†å‚æ•°ä¿®æ”¹å¤§ä¸€äº›ã€‚<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">idea<span class="selector-class">.max</span><span class="selector-class">.intellisense</span><span class="selector-class">.filesize</span>=<span class="number">5000</span></div></pre></td></tr></table></figure></p>
<h2 id="Android-stack"><a href="#Android-stack" class="headerlink" title="Android stack"></a>Android stack</h2><p>è¿™ä¸ªå›¾åº”è¯¥æ—¶æ—¶å›é¡¾ä¸€ä¸‹ã€‚<br><img src="http://img.blog.csdn.net/20160805212247341" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-ç¼–è¯‘è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#1-ç¼–è¯‘è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;1. ç¼–è¯‘è¿‡ç¨‹&quot;&gt;&lt;/a&gt;1. ç¼–è¯‘è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;å‚è€ƒ&lt;a href=&quot;https://source.android.com/source/building.html&quot;&gt;å®˜æ–¹&lt;/a&gt;ï¼Œæ³¨æ„ç»†èŠ‚ã€‚ &lt;/p&gt;
&lt;p&gt;ç¼–è¯‘ç‰ˆæœ¬&lt;code&gt;6.0.1_r50&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&quot;1-1-ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶&quot;&gt;&lt;a href=&quot;#1-1-ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶&quot; class=&quot;headerlink&quot; title=&quot;1.1 ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶&quot;&gt;&lt;/a&gt;1.1 ä¸‹è½½ç¬¬ä¸‰æ–¹äºŒè¿›åˆ¶æ–‡ä»¶&lt;/h3&gt;&lt;p&gt;å¦‚æœæƒ³è¦å°†ç¼–è¯‘å¥½çš„imgåˆ·å…¥ç‰©ç†è®¾å¤‡ï¼Œè€Œä¸æ˜¯è™šæ‹Ÿæœºï¼Œä¸€å®šè¦å…ˆä¸‹è½½å¥½è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ”¾åœ¨AOSPçš„æ ¹ç›®å½•ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://developers.google.com/android/nexus/drivers&quot;&gt;äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½&lt;/a&gt;ã€‚ä¸‹è½½å®Œæ¯•åå¹¶è§£å‹åï¼Œä¼šæœ‰shæ–‡ä»¶ç”Ÿæˆï¼›è¿è¡Œshæ–‡ä»¶ï¼Œä¼šåœ¨AOSPç›®å½•ä¸‹ç”Ÿæˆ&lt;code&gt;vendor/&lt;/code&gt;æ–‡ä»¶å¤¹ï¼Œå¿…è¦çš„æ–‡ä»¶ä¼šæ”¾åœ¨é‡Œé¢ã€‚ç„¶åå†æ‰§è¡Œç¼–è¯‘ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Nexus7ææœºæ•™ç¨‹</title>
    <link href="http://itanch.github.io/2017/02/14/Nexus7%E6%90%9E%E6%9C%BA%E6%95%99%E7%A8%8B/"/>
    <id>http://itanch.github.io/2017/02/14/Nexus7ææœºæ•™ç¨‹/</id>
    <published>2017-02-14T05:28:37.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç³»ç»Ÿå‡†å¤‡"><a href="#ç³»ç»Ÿå‡†å¤‡" class="headerlink" title="ç³»ç»Ÿå‡†å¤‡"></a>ç³»ç»Ÿå‡†å¤‡</h2><p>è¿™é‡Œï¼Œæˆ‘å‡†å¤‡äº†Nexus 7ï¼ˆwifiç¬¬äºŒç‰ˆï¼‰ä½œä¸ºæµ‹è¯•æœºå‹ï¼ŒAndroidç‰ˆæœ¬4.4.2ã€‚ç”±äºè¯¥æœºå™¨æ˜¯ä¸€ä¸ªæ–°æœºå™¨ï¼Œè¿˜æ²¡æ¿€æ´»ï¼Œéœ€è¦åœ¨WLANç•Œé¢è”ç½‘æ¿€æ´»ï¼Œå¦åˆ™æ— æ³•è¿›å…¥ç³»ç»Ÿã€‚æˆ‘å·²ç»å°è¯•è¿‡ä½¿ç”¨ä»£ç†IPï¼Œæˆ–è€…ä½¿ç”¨ç¿»å¢™çš„å…¶å®ƒæ‰‹æœºä½œä¸ºçƒ­ç‚¹ï¼Œéƒ½ä»¥å¤±è´¥å‘Šç»ˆã€‚æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œæˆ‘è¦ä»‹ç»ä¸€ç§ç»•è¿‡Nexus 7æ¿€æ´»çš„æ–¹æ³•ã€‚</p>
<h2 id="åˆ·å…¥recovery"><a href="#åˆ·å…¥recovery" class="headerlink" title="åˆ·å…¥recovery"></a>åˆ·å…¥recovery</h2><p>è¯¥è¿‡ç¨‹ç”¨äºNexus 7ç»•è¿‡æ¿€æ´»å’Œè®¾å¤‡rootï¼Œæœ‰ä¸ªå¥½ä½¿çš„recoveryä¹Ÿå¾ˆå¿…è¦ã€‚</p>
<p>é¦–å…ˆä¿è¯ç”µè„‘å·²ç»å®‰è£…<a href="https://developer.android.com/studio/command-line/adb.html" target="_blank" rel="external">ADB</a>ç¯å¢ƒï¼Œè¿™é‡Œä¸å†èµ˜è¿°å®‰è£…è¿‡ç¨‹ã€‚ç¡®ä¿<code>fastboot</code>å‘½ä»¤å¯ä»¥åœ¨ç»ˆç«¯æ‰§è¡Œå³å¯ã€‚</p>
<p>æˆ‘åœ¨è¿™é‡Œæ¨èTWRP recoveryï¼Œç”¨èµ·æ¥å¾ˆé¡ºæ‰‹ã€‚åœ¨ <a href="https://twrp.me/Devices/" target="_blank" rel="external">TeamWin - TWRP</a> æ‰¾åˆ°è‡ªå·±éœ€è¦çš„recoveryï¼Œæˆ‘åœ¨è¿™é‡Œé€‰æ‹©<a href="https://twrp.me/devices/asusnexus72013wifi.html" target="_blank" rel="external">Asus Nexus 7 2013 Wi-Fi (flo)</a>ï¼Œè¿™ä¸ªä¸€å®šè¦å’Œè‡ªå·±ç§»åŠ¨è®¾å¤‡åŒ¹é…ã€‚</p>
<p>ä¸‹è½½å¥½<code>twrp-xxxx.img</code>æ–‡ä»¶ï¼Œå…³æœºåï¼ŒæŒ‰Power+Volumn downæ¥é‡å¯æ‰‹æœºï¼Œè¿›å…¥fastbootæ¨¡å¼ã€‚è¿™æ—¶ï¼Œä¿è¯è®¾å¤‡å’Œç”µè„‘é€šè¿‡USBè¿æ¥ï¼ŒåŒæ—¶ä½¿ç”¨å‘½ä»¤ï¼Œå¯ä»¥åœ¨ç»ˆç«¯æ˜¾ç¤ºè®¾å¤‡åç§°ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ adb devices</div></pre></td></tr></table></figure></p>
<p>å¦‚æœæ‰‹æœºåˆå§‹çŠ¶æ€ä¸ºåŠ é”çŠ¶æ€ï¼Œæ‰€ä»¥é¦–å…ˆè¦è§£é”ï¼š<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>fastboot oem unlock</div></pre></td></tr></table></figure></p>
<p>è§£é”æˆåŠŸåï¼Œç„¶ååˆ·å…¥recoveryï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ fastboot flash recovery twrp.img</div></pre></td></tr></table></figure></p>
<p>åˆ·å…¥recoveryï¼ŒæˆåŠŸä¼šæ˜¾ç¤ºä¸€äº›Okeyå­—æ ·ã€‚æˆåŠŸåˆ·å…¥ä»¥åï¼Œå…³é—­è®¾å¤‡ï¼Œä½¿ç”¨Power+Volumn upè¿›å…¥recoveryæ¨¡å¼ï¼Œç­‰å¾…ä¸€å°ä¼šï¼Œå¦‚æœé•¿æ—¶é—´åœç•™åœ¨twrpåˆå§‹ç•Œé¢ï¼Œå¯ä»¥ç‚¹å‡»éŸ³é‡ä¸Šæˆ–ä¸‹é”®æ¥è§‚å¯Ÿæ˜¯å¦å·²ç»è¿›å…¥ã€‚å¦‚æœrecoveryæ— æ³•è¿›å…¥ï¼Œæœ‰å¯èƒ½æ˜¯åˆ·å…¥çš„recoveryå’Œè®¾å¤‡ç‰ˆæœ¬ä¸ä¸€è‡´ã€‚</p>
<p>Recoveryä¸ä»…ä»…ç”¨äºNexus 7ç»•è¿‡æ¿€æ´»ï¼Œä¸€ä¼šrootæ‰‹æœºæ—¶ï¼Œä¹Ÿéœ€è¦ç”¨åˆ°ã€‚</p>
<h2 id="æ¿€æ´»Nexus-7"><a href="#æ¿€æ´»Nexus-7" class="headerlink" title="æ¿€æ´»Nexus 7"></a>æ¿€æ´»Nexus 7</h2><p>Twrp recoveryæä¾›äº†å¾ˆäººæ€§åŒ–çš„ç•Œé¢ï¼Œå¯ä»¥ä½¿ç”¨ç‚¹å‡»æ“ä½œã€‚ä½ éœ€è¦é¦–å…ˆåˆ©ç”¨recoveryçš„æŒ‚åœ¨åŠŸèƒ½(mount)ï¼Œå°†/systemåˆ†åŒºæŒ‚åœ¨ä¸Šï¼Œç„¶ååœ¨è®¡ç®—æœºç»ˆç«¯è¿›å…¥è®¾å¤‡ç³»ç»Ÿæ–‡ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ adb shell</div><div class="line">$ cd /system</div></pre></td></tr></table></figure></p>
<p>è¿™æ—¶å¯ä»¥çœ‹åˆ°æ–‡ä»¶<code>build.prop</code>ï¼Œå¯ä»¥ç§<code>cat</code>æˆ–è€…<code>vi</code>æ¥çœ‹é‡Œé¢å†…å®¹ï¼Œå…¶ä¸­é‡è¦è¯­å¥<code>ro.setupwizard.network_required=true</code>ï¼Œè¿™ä¸ªå°±æ˜¯è¦æ±‚ç½‘ç»œéªŒè¯çš„é…ç½®ã€‚è¿™é‡Œï¼Œæ— è®ºä½ ç”¨ä½•ç§æ–¹æ³•ï¼ŒæŠŠ<code>true</code>æ”¹ä¸º<code>false</code>ï¼Œä¿å­˜å³å¯ã€‚</p>
<p>é‡å¯æ‰‹æœºï¼Œå¦‚æœå¡åœ¨ç­‰å¾…ç•Œé¢ï¼Œåˆ™æŒ‰éŸ³é‡é”®ï¼Œçœ‹æ—¶å€™å¯ä»¥è¿›å…¥ï¼ˆå…¶å®æˆ‘ä¹Ÿä¸çŸ¥å…¶ä¸­åŸå§”ï¼Œåªæ˜¯è¿™æ ·è¯•äº†ä¸€ä¸‹ï¼Œå°½é‡è€å¿ƒç­‰å¾…ä¸€æ®µæ—¶é—´ï¼‰ã€‚è¿›å…¥åä¼šå‘ç°è¿›å…¥äº†æ­£å¸¸çš„åˆå§‹åŒ–æ­¥éª¤ï¼Œåˆ°è¾¾WLANè¿æ¥æ¿€æ´»æ—¶ï¼Œå‘ç°ä¸‹é¢ç¥å¥‡çš„å¤šäº†ä¸€ä¸ªæŒ‰é’®â€œè·³è¿‡â€ï¼è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°ä¸€äº›ç½‘ç»œé”™è¯¯ä»€ä¹ˆçš„ï¼Œä¸å¿…å…³å¿ƒï¼Œåªè¦ä¸€æ­¥æ­¥åˆå§‹åŒ–ï¼Œå°±å¯ä»¥æœ€ç»ˆè¿›å…¥ç³»ç»Ÿã€‚</p>
<h2 id="Root"><a href="#Root" class="headerlink" title="Root"></a>Root</h2><p>æ‰‹æœºå·²ç»rootè¯·è·³è¿‡æ­¤æ­¥éª¤ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨å›½å†…çš„rootå¤§å¸ˆã€ç²¾çµä¹‹æµçš„rootè½¯ä»¶è¿›è¡Œrootï¼Œä½†æ˜¯å¹¶ä¸æ¨èï¼Œå› ä¸ºå®ƒä»¬ä¼šé™„åŠ å®‰è£…ä¸€äº›åº”ç”¨ã€‚è¿™é‡Œæˆ‘æ¨èä½¿ç”¨<a href="http://forum.xda-developers.com/showthread.php?t=1538053" target="_blank" rel="external">SuperSU</a>ç»“åˆrecoveryè¿›è¡Œrootã€‚</p>
<p>é¦–å…ˆä¸‹è½½SuperSU <a href="http://download.chainfire.eu/supersu-stable" target="_blank" rel="external">zip</a>æ–‡ä»¶ï¼Œä¸‹è½½å®Œæ¯•åï¼Œå°†å…¶ä¼ å…¥æ‰‹æœºæŸä¸ªä½ç½®ï¼Œç„¶åé‡å¯è¿›å…¥recoveryæ¨¡å¼ã€‚</p>
<p>åœ¨recoveryé€‰æ‹©install è¿™ä¸ªzipæ–‡ä»¶å³å¯ã€‚é‡å¯åå¯ä»¥å‘ç°åº”ç”¨SuperSUï¼Œå¯ä»¥åˆ©ç”¨å®ƒç®¡ç†æ‰‹æœºæƒé™ã€‚</p>
<h2 id="åˆ·å…¥Androidå…¶å®ƒç‰ˆæœ¬"><a href="#åˆ·å…¥Androidå…¶å®ƒç‰ˆæœ¬" class="headerlink" title="åˆ·å…¥Androidå…¶å®ƒç‰ˆæœ¬"></a>åˆ·å…¥Androidå…¶å®ƒç‰ˆæœ¬</h2><p>Androidå®˜æ–¹æä¾›äº†å¾ˆæ–¹ä¾¿çš„imageèµ„æºï¼Œå…¶ä¸­ <a href="https://developers.google.com/android/nexus/images#nakasi" target="_blank" rel="external">Nexus factory image</a>åˆ—å‡ºäº†å¯ç”¨çš„æ‰€æœ‰Nexusé•œåƒï¼Œå¯»æ‰¾åˆ°é€‚åˆçš„é•œåƒè¿›è¡Œä¸‹è½½ï¼Œå»ºè®®éªŒè¯ä¸€ä¸‹MD5æ ¡éªŒç ã€‚ä¸‹è½½å®Œæ¯•åï¼Œå¯ä»¥æŒ‰ç…§å®˜ç½‘ä¸Šçš„æ•™ç¨‹åˆ·å…¥ç³»ç»Ÿï¼Œè¿‡ç¨‹æ¯”è¾ƒç®€å•ã€‚</p>
<p>æˆ‘åœ¨è¿™é‡Œåˆ·å…¥äº†Android 4.3 (JSS15Q)ç‰ˆæœ¬ï¼Œé™ä½äº†Nexusç³»ç»Ÿçš„ç‰ˆæœ¬ã€‚åˆ·æœºå®Œæ¯•åï¼Œå¯ä»¥é‡å¤ä¸Šé¢æ­¥éª¤ï¼Œåˆ·å…¥éœ€è¦çš„çš„å·¥å…·ã€‚éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ç»•è¿‡æ¿€æ´»æ—¶ï¼Œ4.3ç‰ˆæœ¬å’Œ4.4ç‰ˆæœ¬ç•¥æœ‰ä¸åŒã€‚åœ¨4.3ç‰ˆæœ¬ä¸­ï¼Œå‰é¢æ­¥éª¤ç›¸åŒï¼Œæœ€åä¿®æ”¹<code>build.prop</code>æ—¶ï¼Œåªè¦åŠ å…¥<code>ro.setupwizard.mode=DISABLED</code>è¯¥é…ç½®å³å¯ç»•è¿‡æ¿€æ´»ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç³»ç»Ÿå‡†å¤‡&quot;&gt;&lt;a href=&quot;#ç³»ç»Ÿå‡†å¤‡&quot; class=&quot;headerlink&quot; title=&quot;ç³»ç»Ÿå‡†å¤‡&quot;&gt;&lt;/a&gt;ç³»ç»Ÿå‡†å¤‡&lt;/h2&gt;&lt;p&gt;è¿™é‡Œï¼Œæˆ‘å‡†å¤‡äº†Nexus 7ï¼ˆwifiç¬¬äºŒç‰ˆï¼‰ä½œä¸ºæµ‹è¯•æœºå‹ï¼ŒAndroidç‰ˆæœ¬4.4.2ã€‚ç”±äºè¯¥æœºå™¨æ˜¯ä¸€ä¸ªæ–°æœºå™¨ï¼Œè¿˜æ²¡æ¿€æ´»ï¼Œ
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Android" scheme="http://itanch.github.io/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu PPTPD é…ç½®</title>
    <link href="http://itanch.github.io/2017/02/14/UbuntuPPTPD%E9%85%8D%E7%BD%AE/"/>
    <id>http://itanch.github.io/2017/02/14/UbuntuPPTPDé…ç½®/</id>
    <published>2017-02-14T05:12:48.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Serveré…ç½®"><a href="#Serveré…ç½®" class="headerlink" title="Serveré…ç½®"></a>Serveré…ç½®</h2><h3 id="å®‰è£…pptpd"><a href="#å®‰è£…pptpd" class="headerlink" title="å®‰è£…pptpd"></a>å®‰è£…pptpd</h3><p>é¦–å…ˆéœ€è¦å®‰è£…pptpdï¼Œubuntu é»˜è®¤å®‰è£…è¯¥å·¥å…·ã€‚ </p>
<a id="more"></a>
<h3 id="é…ç½®ç½‘ç»œ"><a href="#é…ç½®ç½‘ç»œ" class="headerlink" title="é…ç½®ç½‘ç»œ"></a>é…ç½®ç½‘ç»œ</h3><p>ç¼–è¾‘ <code>/etc/pptpd.conf</code>ï¼Œå–æ¶ˆä»¥ä¸‹ä¸¤è¡Œæ³¨é‡Šã€‚å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±è®¾å®šipåœ°å€èŒƒå›´ï¼Œè¿™é‡Œä½¿ç”¨é»˜è®¤çš„å°±å¯ä»¥ã€‚<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">localip <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></div><div class="line">remoteip <span class="number">192.168</span><span class="number">.0</span><span class="number">.234</span><span class="number">-238</span>,<span class="number">192.168</span><span class="number">.0</span><span class="number">.245</span></div></pre></td></tr></table></figure></p>
<h3 id="æ·»åŠ ç”¨æˆ·"><a href="#æ·»åŠ ç”¨æˆ·" class="headerlink" title="æ·»åŠ ç”¨æˆ·"></a>æ·»åŠ ç”¨æˆ·</h3><p>ç¼–è¾‘<code>/etc/ppp/chap-secrets</code>æ–‡ä»¶ï¼Œç”¨æˆ·åæ·»åŠ å¦‚ä¸‹ï¼š<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> # Secrets for authentication using CHAP</div><div class="line"> # client    server  secret          IP addresses</div><div class="line">   [client name]  *   <span class="string">"[password]"</span> *</div><div class="line">```  </div><div class="line">å…¶ä¸­clientçš„åå­—å’Œå¯†ç è‡ªå·±è®¾å®šå³å¯ï¼Œå…¶å®ƒä¸¤é¡¹é»˜è®¤<span class="string">"*"</span>å°±å¯ä»¥ã€‚</div><div class="line"></div><div class="line">### è®¾ç½®DNS</div><div class="line">ç¼–è¾‘`/etc/ppp/pptpd-options`ï¼Œæ‰¾åˆ°`ms-dns`éƒ¨åˆ†ï¼Œå–æ¶ˆæ³¨é‡Šï¼š</div></pre></td></tr></table></figure></p>
<p> ms-dns 223.5.5.5<br> ms-dns 223.6.6.6<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">é»˜è®¤çš„æ˜¯googleçš„DNSæœåŠ¡ï¼Œ`<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>`ã€‚å› ä¸ºå›½å†…ä½¿ç”¨ä¸ä¾¿ï¼Œè¿™é‡Œæˆ‘ä¿®æ”¹æˆé˜¿é‡Œçš„DNSæœåŠ¡ã€‚</div><div class="line"></div><div class="line">### å¼€å¯IPè½¬å‘</div><div class="line">ç¼–è¾‘`/etc/sysctl.conf`æ–‡ä»¶ï¼Œå–æ¶ˆæ³¨é‡Šï¼š</div></pre></td></tr></table></figure></p>
<p>net.ipv4.ip_forward=1<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">è¿è¡Œå‘½ä»¤ï¼Œä½¿é…ç½®ç”Ÿæ•ˆï¼š</div></pre></td></tr></table></figure></p>
<p>sysctl -p<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### iptableså®‰è£…</div><div class="line">å®‰è£…iptables:</div></pre></td></tr></table></figure></p>
<p>apt-get install iptables<br>iptables -t nat -I POSTROUTING -j MASQUERADE #æ¯æ¬¡è¿è¡Œå‰éœ€è¦è¿è¡Œè¯¥å‘½ä»¤<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### é‡å¯pptpd</div></pre></td></tr></table></figure></p>
<p>/etc/init.d/pptpd restart<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##Clienté…ç½®</div><div class="line">åœ¨ä½ éœ€è¦ä½¿ç”¨ä»£ç†çš„ubuntuè®¾å¤‡ä¸Šæ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶å®ƒå®¢æˆ·ç«¯ã€‚</div><div class="line"></div><div class="line">### å®‰è£…pptp</div><div class="line">ä¸€èˆ¬ç³»ç»Ÿå·²ç»é»˜è®¤å®‰è£…ã€‚</div></pre></td></tr></table></figure></p>
<p>sudo apt-get install pptp-linux<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### åˆ›å»ºä¸€ä¸ªè¿æ¥</div></pre></td></tr></table></figure></p>
<p>sudo pptpsetup â€“create [server name] â€“server [server ip] â€“username [client name] â€“password [password] â€“encrypt â€“start<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">æ‰§è¡Œå®Œä¸Šè¿°å‘½ä»¤åï¼Œä¼šåœ¨`/etc/ppp/chap-secrets`è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„ç”¨æˆ·ï¼š</div></pre></td></tr></table></figure></p>
<h1 id="added-by-pptpsetup-for-pptpd"><a href="#added-by-pptpsetup-for-pptpd" class="headerlink" title="added by pptpsetup for pptpd"></a>added by pptpsetup for pptpd</h1><p>[client name] [server name] â€œpasswordâ€ *<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">åœ¨`/etc/ppp/peers/pptpd`ä¸­ä¹Ÿä¼šæœ‰ç”Ÿæˆçš„ç›¸åº”ä¿¡æ¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œé»˜è®¤çš„æ˜¯ä¸ç”¨server çš„DNSé…ç½®çš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°<span class="built_in">ping</span> ipåœ°å€å¯ä»¥æˆåŠŸï¼Œ<span class="built_in">ping</span>ç½‘å€å´å¤±è´¥çš„DNSè§£æé”™è¯¯ï¼Œæ‰€ä»¥è¦åŠ ä¸Šå¦‚ä¸‹ä¸€è¡Œ:</div></pre></td></tr></table></figure></p>
<p>usepeerdns<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">åœ¨ä¸Šè¿°å‘½ä»¤æˆåŠŸåï¼Œ`ifconfig`å‘½ä»¤ä¸‹å›å‡ºç°ppp0ç«¯å£ã€‚</div><div class="line"></div><div class="line">### è·¯ç”±è®¾ç½®</div><div class="line">å°†ppp0è®¾ç½®ä¸ºé»˜è®¤è·¯ç”±ç«¯å£ï¼š</div></pre></td></tr></table></figure></p>
<p>ip route del default<br>ip route add default dev ppp0<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">è¿™æ ·é…ç½®åŸºæœ¬ç®—æˆåŠŸäº†ã€‚</div><div class="line"></div><div class="line">### æœåŠ¡å¼€å…³</div><div class="line">æˆ‘è‡ªå·±å†™äº†å¦‚ä¸‹å‘½ä»¤æ–¹ä¾¿å¼€å…³å’Œè·¯ç”±è®¾ç½®ï¼š</div><div class="line"></div><div class="line">æ‰“å¼€æœåŠ¡(éœ€è¦sudo):</div></pre></td></tr></table></figure></p>
<p>#!/bin/bash<br>pon [server name]<br>sleep 4<br>ip route del default<br>ip route add default dev ppp0<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">å…³é—­æœåŠ¡<span class="comment">(sudo)</span>:</div></pre></td></tr></table></figure></p>
<p>#!/bin/bash<br>poff pptpd<br>sleep 4<br>ip route del default<br>ip route add default via [your old route ip] dev eno1<br>```<br>è¿™é‡Œéœ€è¦è®°ä½åŸæ¥è®¾å¤‡çš„è·¯ç”±ipï¼Œä»¥ä¾¿åˆ é™¤åå†å›å¤ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Serveré…ç½®&quot;&gt;&lt;a href=&quot;#Serveré…ç½®&quot; class=&quot;headerlink&quot; title=&quot;Serveré…ç½®&quot;&gt;&lt;/a&gt;Serveré…ç½®&lt;/h2&gt;&lt;h3 id=&quot;å®‰è£…pptpd&quot;&gt;&lt;a href=&quot;#å®‰è£…pptpd&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…pptpd&quot;&gt;&lt;/a&gt;å®‰è£…pptpd&lt;/h3&gt;&lt;p&gt;é¦–å…ˆéœ€è¦å®‰è£…pptpdï¼Œubuntu é»˜è®¤å®‰è£…è¯¥å·¥å…·ã€‚ &lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="ubuntu" scheme="http://itanch.github.io/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Cocos2d-x å®‰è£…</title>
    <link href="http://itanch.github.io/2017/02/14/cocos2d-x%E5%AE%89%E8%A3%85/"/>
    <id>http://itanch.github.io/2017/02/14/cocos2d-xå®‰è£…/</id>
    <published>2017-02-14T05:02:41.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>hello cocos2d </p>
</blockquote>
<hr>
<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>å®‰è£…ç¯å¢ƒï¼šMac OS X<br>è¿è¡Œç›®æ ‡ï¼šAndroid<br>Cocos2dç‰ˆæœ¬ï¼šcocos2d-x-3.13.1ï¼ŒCocos Console 2.1</p>
<a id="more"></a>
<h2 id="Cocos2d-x-å®‰è£…"><a href="#Cocos2d-x-å®‰è£…" class="headerlink" title="Cocos2d-x å®‰è£…"></a>Cocos2d-x å®‰è£…</h2><h3 id="1-åŸºæœ¬å·¥å…·"><a href="#1-åŸºæœ¬å·¥å…·" class="headerlink" title="1. åŸºæœ¬å·¥å…·"></a>1. åŸºæœ¬å·¥å…·</h3><p>å®‰è£…Cocos2d-xï¼Œæœ€åŸºç¡€çš„æ˜¯å®‰è£…å‘½ä»¤è¡Œå·¥å…·ã€‚åœ¨å®‰è£…Cocosä¹‹å‰ï¼Œéœ€è¦ä¸€äº›å…¶å®ƒåŸºæœ¬å·¥å…·ï¼š</p>
<ul>
<li>JAVA SDK</li>
<li>Android SDK</li>
<li>Android NDK</li>
<li>Apache Ant</li>
<li>Python 2.7.5</li>
</ul>
<p>è¿™äº›åŸºæœ¬å·¥å…·æœ€å¥½å·²ç»é…ç½®åœ¨ç¯å¢ƒå˜é‡ä¸­ã€‚</p>
<h3 id="2-Cocos2d-x"><a href="#2-Cocos2d-x" class="headerlink" title="2. Cocos2d-x"></a>2. Cocos2d-x</h3><p>ä¸‹è½½æœ€æ–°çš„<a href="http://www.cocos2d-x.org/download" target="_blank" rel="external">Cocos2d-x</a>ï¼Œç„¶åè§£å‹ã€‚æ‰¾åˆ°<code>setup.py</code>ï¼Œç„¶åè¿è¡Œ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python setup.py</div></pre></td></tr></table></figure>
<p>ç„¶åå®ƒä¼šæé†’ä½ è¡¥è¶³ä¸€äº›ç¯å¢ƒå˜é‡çš„ç»å¯¹åœ°å€ï¼Œæœ€ååœ¨ä½ åŸæœ‰çš„Homeç›®å½•ä¸‹çš„<code>.bash_profile</code>åŸºç¡€ä¸Šå¢åŠ ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå¾ˆè´´å¿ƒã€‚</p>
<p>åœ¨æˆ‘çš„macä¸Šï¼Œè¡¥è¶³çš„ç¯å¢ƒå˜é‡å¦‚ä¸‹ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Add environment variable COCOS_CONSOLE_ROOT for cocos2d-x</span></div><div class="line"><span class="built_in">export</span> COCOS_CONSOLE_ROOT=/Users/Tianchi/Tool/cocos2d-x-3.13.1/tools/cocos2d-console/bin</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$COCOS_CONSOLE_ROOT</span>:<span class="variable">$PATH</span></div><div class="line"></div><div class="line"><span class="comment"># Add environment variable COCOS_X_ROOT for cocos2d-x</span></div><div class="line"><span class="built_in">export</span> COCOS_X_ROOT=/Users/Tianchi/Tool</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$COCOS_X_ROOT</span>:<span class="variable">$PATH</span></div><div class="line"></div><div class="line"><span class="comment"># Add environment variable COCOS_TEMPLATES_ROOT for cocos2d-x</span></div><div class="line"><span class="built_in">export</span> COCOS_TEMPLATES_ROOT=/Users/Tianchi/Tool/cocos2d-x-3.13.1/templates</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$COCOS_TEMPLATES_ROOT</span>:<span class="variable">$PATH</span></div><div class="line"></div><div class="line"><span class="comment"># Add environment variable NDK_ROOT for cocos2d-x</span></div><div class="line"><span class="built_in">export</span> NDK_ROOT=/Users/Tianchi/Tool/ndk</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$NDK_ROOT</span>:<span class="variable">$PATH</span></div><div class="line"></div><div class="line"><span class="comment"># Add environment variable ANDROID_SDK_ROOT for cocos2d-x</span></div><div class="line"><span class="built_in">export</span> ANDROID_SDK_ROOT=/Users/Tianchi/Tool/sdk</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$ANDROID_SDK_ROOT</span>:<span class="variable">$PATH</span></div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$ANDROID_SDK_ROOT</span>/tools:<span class="variable">$ANDROID_SDK_ROOT</span>/platform-tools:<span class="variable">$PATH</span></div><div class="line"></div><div class="line"><span class="comment"># Add environment variable ANT_ROOT for cocos2d-x</span></div><div class="line"><span class="built_in">export</span> ANT_ROOT=/usr/<span class="built_in">local</span>/apache-ant-1.9.4/bin</div><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$ANT_ROOT</span>:<span class="variable">$PATH</span></div></pre></td></tr></table></figure></p>
<p>æ˜¯å¦å®‰è£…æˆåŠŸï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cocos -v</div><div class="line">cocos2d-x<span class="number">-3.13</span><span class="number">.1</span></div><div class="line">Cocos Console <span class="number">2.1</span></div></pre></td></tr></table></figure></p>
<h3 id="3-New-Project"><a href="#3-New-Project" class="headerlink" title="3. New Project"></a>3. New Project</h3><p>åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cocos new &lt;game name&gt; -p &lt;package identifier&gt; <span class="_">-l</span> &lt;language&gt; <span class="_">-d</span> &lt;location&gt;</div></pre></td></tr></table></figure>
<p>æ ·ä¾‹ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cocos new MyGame -p com.MyCompany.MyGame <span class="_">-l</span> cpp <span class="_">-d</span> ~/MyCompany</div><div class="line"></div><div class="line">cocos new MyGame -p com.MyCompany.MyGame <span class="_">-l</span> lua <span class="_">-d</span> ~/MyCompany</div><div class="line"></div><div class="line">cocos new MyGame -p com.MyCompany.MyGame <span class="_">-l</span> js <span class="_">-d</span> ~/MyCompany</div></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘é¡¹ç›®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cocos compile <span class="_">-s</span> &lt;path to your project&gt; -p &lt;platform&gt; -m &lt;mode&gt; -o &lt;output directory&gt;</div></pre></td></tr></table></figure>
<p>æ ·ä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cocos compile <span class="_">-s</span> ~/MyCompany/MyGame -p ios -m release -o ~/MyCompany/MyGame/bin</div><div class="line"></div><div class="line">cocos compile <span class="_">-s</span> ~/MyCompany/MyGame -p android -m release -o ~/MyCompany/MyGame/bin</div><div class="line"></div><div class="line">cocos compile <span class="_">-s</span> c:\MyCompany\MyGame -p win32 -m release -o c:\MyCompany\MyGame\bin</div></pre></td></tr></table></figure>
<p>ç¼–è¯‘Androidåº”ç”¨ï¼Œéœ€è¦æŒ‡å®šç›®æ ‡ç‰ˆæœ¬<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cocos compile -p android --ap android-22</div></pre></td></tr></table></figure></p>
<p>ç¼–è¯‘æˆåŠŸåï¼Œå°±ä¼šåœ¨é¡¹ç›®ç›®å½•ä¸‹çš„<code>proj.android/bin</code>ä¸‹å‘ç°apkæ–‡ä»¶ï¼Œå¯ä»¥è¿›è¡Œå®‰è£…ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;hello cocos2d &lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒ&quot;&gt;&lt;/a&gt;ç¯å¢ƒ&lt;/h2&gt;&lt;p&gt;å®‰è£…ç¯å¢ƒï¼šMac OS X&lt;br&gt;è¿è¡Œç›®æ ‡ï¼šAndroid&lt;br&gt;Cocos2dç‰ˆæœ¬ï¼šcocos2d-x-3.13.1ï¼ŒCocos Console 2.1&lt;/p&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="Cocos2d-x" scheme="http://itanch.github.io/tags/Cocos2d-x/"/>
    
  </entry>
  
  <entry>
    <title>AngularJS--SB Admin</title>
    <link href="http://itanch.github.io/2016/01/15/AngularJS%E5%AD%A6%E4%B9%A0/"/>
    <id>http://itanch.github.io/2016/01/15/AngularJSå­¦ä¹ /</id>
    <published>2016-01-15T02:56:03.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»SB Adminå¼€å§‹å­¦ä¹ AngularJS!</p>
<p><a href="https://github.com/start-angular/sb-admin-angular" target="_blank" rel="external">SB Admin v2.0 rewritten in AngularJS</a>æ˜¯ä¸€ä¸ªSB Adminçš„AngularJSçš„å®ç°ï¼Œæºä»£ç ã€å®‰è£…å’Œè¿è¡Œå¯ä»¥å‚è€ƒä»¥ä¸Šé“¾æ¥ã€‚</p>
<h2 id="ä¸€äº›å·¥å…·"><a href="#ä¸€äº›å·¥å…·" class="headerlink" title="ä¸€äº›å·¥å…·"></a>ä¸€äº›å·¥å…·</h2><p><a href="https://nodejs.org" target="_blank" rel="external">Nodejs</a>å‡çº§ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo npm cache clean <span class="_">-f</span></div><div class="line">$ sudo npm install -g n</div><div class="line">$ sudo n stable</div><div class="line">$ sudo ln -sf /usr/<span class="built_in">local</span>/n/versions/node/&lt;VERSION&gt;/bin/node /usr/bin/node</div></pre></td></tr></table></figure></p>
<p>npmå‡çº§ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo npm install --global npm@latest</div></pre></td></tr></table></figure>  </p>
<p><a href="http://bower.io/" target="_blank" rel="external">Bower</a>æ˜¯ä¸€ä¸ªå¯¹webå¼€å‘è¿›è¡ŒåŒ…ç®¡ç†çš„å·¥å…·ã€‚  </p>
<p><a href="http://www.gruntjs.net/" target="_blank" rel="external">GRUNT</a>çš„ç›®çš„å°±æ˜¯è‡ªåŠ¨åŒ–ã€‚å¯¹äºéœ€è¦åå¤é‡å¤çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å‹ç¼©ï¼ˆminificationï¼‰ã€ç¼–è¯‘ã€å•å…ƒæµ‹è¯•ã€lintingç­‰ï¼Œè‡ªåŠ¨åŒ–å·¥å…·å¯ä»¥å‡è½»ä½ çš„åŠ³åŠ¨ï¼Œç®€åŒ–ä½ çš„å·¥ä½œã€‚å½“ä½ åœ¨ Gruntfile æ–‡ä»¶æ­£ç¡®é…ç½®å¥½äº†ä»»åŠ¡ï¼Œä»»åŠ¡è¿è¡Œå™¨å°±ä¼šè‡ªåŠ¨å¸®ä½ æˆ–ä½ çš„å°ç»„å®Œæˆå¤§éƒ¨åˆ†æ— èŠçš„å·¥ä½œã€‚  </p>
<p><a href="http://yeoman.io/" target="_blank" rel="external">Yeoman</a>ç”Ÿæˆwebåº”ç”¨çš„åŸºæœ¬æ¶æ„ã€‚<br><a id="more"></a></p>
<h2 id="Yeomanå…¥é—¨"><a href="#Yeomanå…¥é—¨" class="headerlink" title="Yeomanå…¥é—¨"></a>Yeomanå…¥é—¨</h2><p><img src="http://7xky03.com1.z0.glb.clouddn.com/yeoman.png" alt="yeoman">  </p>
<h3 id="1-å®‰è£…Bowerã€GRUNTå’ŒYeomanï¼š"><a href="#1-å®‰è£…Bowerã€GRUNTå’ŒYeomanï¼š" class="headerlink" title="1. å®‰è£…Bowerã€GRUNTå’ŒYeomanï¼š"></a>1. å®‰è£…Bowerã€GRUNTå’ŒYeomanï¼š</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo npm install --global yo bower grunt-cli</div></pre></td></tr></table></figure>
<h3 id="2-å®‰è£…generator"><a href="#2-å®‰è£…generator" class="headerlink" title="2. å®‰è£…generator"></a>2. å®‰è£…generator</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo npm install --global generator-karma generator-angular</div></pre></td></tr></table></figure>  
<h3 id="3-è¿è¡Œgenerator"><a href="#3-è¿è¡Œgenerator" class="headerlink" title="3. è¿è¡Œgenerator"></a>3. è¿è¡Œgenerator</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ yo angular</div></pre></td></tr></table></figure>
<h3 id="4-Yeomanæ€»ç»“"><a href="#4-Yeomanæ€»ç»“" class="headerlink" title="4. Yeomanæ€»ç»“"></a>4. Yeomanæ€»ç»“</h3><p>Yeomanç¡®å®æ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„webåº”ç”¨æ¶æ„å·¥å…·ï¼Œä»–å¯ä»¥å¸®ä½ å®Œæˆå¤§éƒ¨åˆ†ç¹ççš„å·¥ä½œï¼Œä»è€Œä½ å¯ä»¥æ›´ä¸“å¿ƒçš„å®ç°ä½ çš„åŠŸèƒ½ã€‚</p>
<h2 id="æºä»£ç åˆ†æ"><a href="#æºä»£ç åˆ†æ" class="headerlink" title="æºä»£ç åˆ†æ"></a>æºä»£ç åˆ†æ</h2><h3 id="1-index-html"><a href="#1-index-html" class="headerlink" title="1. index.html"></a>1. index.html</h3><p>ä½äºapp/ç›®å½•ä¸‹çš„index.htmlæ˜¯æ•´ä¸ªç½‘é¡µçš„ä¸»è¦å…¥å£ã€‚<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>=<span class="string">"sbAdminApp"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">ui-view</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="2-app-js"><a href="#2-app-js" class="headerlink" title="2. app.js"></a>2. app.js</h3><p>ä½äºapp/scripts/ç›®å½•ä¸‹ï¼Œåº”ç”¨çš„ä¸»è¦moduleã€‚  </p>
<p><strong>module</strong><br>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°sbAdminAppä½¿ç”¨äº†å¦‚ä¸‹moduleï¼š  </p>
<ul>
<li><strong>oc.lazyLoad</strong>ï¼šè‡ªåŠ¨çš„åŠ è½½ä¸€äº›moduleã€‚</li>
<li><strong>ui.router</strong>ï¼šAngularUI Routeræ˜¯ä¸€ä¸ªè·¯ç”±æ¡†æ¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒå°†åº”ç”¨æ¥å£ç»„ç»‡æˆä¸ºä¸€ä¸ªæœ‰ç©·çŠ¶æ€æœºï¼Œä¸åŒäºAngularè‡ªå¸¦çš„<code>$route</code>ï¼ˆæ ¹æ®URLè¿›è¡Œè·¯ç”±ï¼‰ï¼ŒUI-Routeråˆ™æ˜¯æ ¹æ®çŠ¶æ€è¿›è¡Œè·¯ç”±ã€‚  </li>
<li><strong>ui.bootstrap</strong>ï¼šç”¨AngularJSå¼€å‘çš„Bootstrapç»„ä»¶ã€‚  </li>
</ul>
<p><strong>config</strong><br><strong>stateProvider</strong>ï¼šç”±<em>ui.router</em>æä¾›ï¼ŒåŠŸèƒ½ç±»ä¼¼äºAngular v1çš„routerï¼Œä½†æ˜¯å®ƒåªä¸“æ³¨äºstateã€‚stateå°±æ˜¯åº”ç”¨ä¸­çš„æŸä¸€ä¸ªçŠ¶æ€ï¼Œåˆ°è¾¾æŸä¸€ä¸ªçŠ¶æ€æ—¶ï¼Œä¼šå°†templateæ’å…¥åˆ°ç›¸åº”ä½ç½®ã€‚è¯¥éƒ¨åˆ†çš„ä¸»è¦å·¥ä½œæ˜¯å°†stateã€htmlå’Œcontrollerå¯¹åº”èµ·æ¥ã€‚</p>
<p><code>resolve</code>å¯ä»¥æä¾›ç»™controllerä¸€äº›å®šåˆ¶çš„å†…å®¹ï¼Œé‡‡ç”¨<code>key:value</code>çš„æ ¼å¼ã€‚åœ¨è¿™é‡Œï¼Œä½¿ç”¨ocLazyLoadåŠ è½½äº†ä¸€äº›æ¨¡å—ã€‚</p>
<p>é¦–å…ˆåŠ è½½çš„æ˜¯<code>sbAdminApp</code>æ¨¡å—ä¸­çš„headeréƒ¨åˆ†ï¼Œç„¶åä¾æ¬¡ä¸ºheader-notificationã€sidebarå’Œsidebar-searchã€‚è¿™äº›éƒ¨åˆ†åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨äº†<code>module.directive</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥å¯¹æŒ‡å®šçš„å…ƒç´ é™„åŠ ä¸€äº›è¡Œä¸ºï¼Œå¦‚ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'sbAdminApp'</span>)</div><div class="line">.directive(<span class="string">'header'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">			<span class="attr">templateUrl</span>:<span class="string">'scripts/directives/header/header.html'</span>,</div><div class="line">			<span class="attr">restrict</span>: <span class="string">'E'</span>,</div><div class="line">			<span class="attr">replace</span>: <span class="literal">true</span>,</div><div class="line">		&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><br>è¿™é‡Œå°±æ˜¯åœ¨<code>main.html</code>çš„<code>&lt;header&gt;&lt;/header&gt;</code>å…ƒç´ æ›¿æ¢ä¸º<code>header.html</code>çš„å†…å®¹ã€‚  </p>
<p>ä»æºä»£ç ä¸­ä¸éš¾å‘ç°ï¼Œheaderã€header-notificationã€sidebarå’Œsidebar-searchæ–‡ä»¶çš„åŠ è½½æ˜¯æŒ‰ç…§ä¸€å®šçš„é¡ºåºçš„ï¼Œå› ä¸ºå‰åé¡ºåºåœ¨Viewä¸­è¡¨ç°ä¸ºåµŒå¥—çš„çˆ¶å­å…³ç³»ã€‚</p>
<p>ç„¶åï¼ŒåŠ è½½äº†<code>toggle-switch</code>ï¼Œä¸€ä¸ªå¼€å…³æ¨¡å—ï¼›<code>ngAnimate</code>ï¼ŒåŠ¨ç”»æ•ˆæœï¼›<code>ngCookies</code>ï¼Œè¯»å†™æµè§ˆå™¨cookiesï¼›<code>ngResource</code>ï¼ŒåŠ è½½èµ„æºå¯¹è±¡ï¼›<code>ngSanitize</code>ï¼Œå¯ä»¥å¯¹HTMLè¿›è¡Œæ¸…æ´ï¼›<code>ngTouch</code>ï¼Œå¯¹å¯è§¦æ‘¸è®¾å¤‡æä¾›æœåŠ¡ã€‚</p>
<p>å…¶å®ƒstateç±»ä¼¼ã€‚</p>
<p><strong>ocLazyLoadProvider</strong>ï¼šæ¥è‡ªäº<em>oc.lazyLoad</em>ï¼Œ<code>events:true</code>å¯ä»¥ä½¿å¾—åŠ è½½moduleæ—¶å¯ä»¥å‘é€å¹¿æ’­ã€‚  </p>
<p> <strong>urlRouterProvider</strong>ï¼šç”±<em>ui.router</em>æä¾›ï¼Œåœ¨è¿™é‡Œåªæ˜¯ç”¨å®ƒæ¥å¤„ç†å…¶å®ƒçŠ¶æ€ä¸‹çš„æƒ…å†µï¼Œç»Ÿä¸€é‡å®šå‘è‡³<code>/dashboard/home</code>ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»SB Adminå¼€å§‹å­¦ä¹ AngularJS!&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/start-angular/sb-admin-angular&quot;&gt;SB Admin v2.0 rewritten in AngularJS&lt;/a&gt;æ˜¯ä¸€ä¸ªSB Adminçš„AngularJSçš„å®ç°ï¼Œæºä»£ç ã€å®‰è£…å’Œè¿è¡Œå¯ä»¥å‚è€ƒä»¥ä¸Šé“¾æ¥ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä¸€äº›å·¥å…·&quot;&gt;&lt;a href=&quot;#ä¸€äº›å·¥å…·&quot; class=&quot;headerlink&quot; title=&quot;ä¸€äº›å·¥å…·&quot;&gt;&lt;/a&gt;ä¸€äº›å·¥å…·&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://nodejs.org&quot;&gt;Nodejs&lt;/a&gt;å‡çº§ï¼š&lt;br&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo npm cache clean &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo npm install -g n&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo n stable&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo ln -sf /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/n/versions/node/&amp;lt;VERSION&amp;gt;/bin/node /usr/bin/node&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;npmå‡çº§ï¼š&lt;br&gt;&lt;figure class=&quot;highlight sh&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo npm install --global npm@latest&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;  &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://bower.io/&quot;&gt;Bower&lt;/a&gt;æ˜¯ä¸€ä¸ªå¯¹webå¼€å‘è¿›è¡ŒåŒ…ç®¡ç†çš„å·¥å…·ã€‚  &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.gruntjs.net/&quot;&gt;GRUNT&lt;/a&gt;çš„ç›®çš„å°±æ˜¯è‡ªåŠ¨åŒ–ã€‚å¯¹äºéœ€è¦åå¤é‡å¤çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å‹ç¼©ï¼ˆminificationï¼‰ã€ç¼–è¯‘ã€å•å…ƒæµ‹è¯•ã€lintingç­‰ï¼Œè‡ªåŠ¨åŒ–å·¥å…·å¯ä»¥å‡è½»ä½ çš„åŠ³åŠ¨ï¼Œç®€åŒ–ä½ çš„å·¥ä½œã€‚å½“ä½ åœ¨ Gruntfile æ–‡ä»¶æ­£ç¡®é…ç½®å¥½äº†ä»»åŠ¡ï¼Œä»»åŠ¡è¿è¡Œå™¨å°±ä¼šè‡ªåŠ¨å¸®ä½ æˆ–ä½ çš„å°ç»„å®Œæˆå¤§éƒ¨åˆ†æ— èŠçš„å·¥ä½œã€‚  &lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://yeoman.io/&quot;&gt;Yeoman&lt;/a&gt;ç”Ÿæˆwebåº”ç”¨çš„åŸºæœ¬æ¶æ„ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="AngularJS" scheme="http://itanch.github.io/tags/AngularJS/"/>
    
      <category term="Yeoman" scheme="http://itanch.github.io/tags/Yeoman/"/>
    
      <category term="JavaScript" scheme="http://itanch.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>MESOS and MARATHONå®‰è£…</title>
    <link href="http://itanch.github.io/2015/11/16/MESOS%E5%AE%89%E8%A3%85/"/>
    <id>http://itanch.github.io/2015/11/16/MESOSå®‰è£…/</id>
    <published>2015-11-16T01:40:40.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åŸºæœ¬ç¯å¢ƒ"><a href="#åŸºæœ¬ç¯å¢ƒ" class="headerlink" title="åŸºæœ¬ç¯å¢ƒ"></a>åŸºæœ¬ç¯å¢ƒ</h3><p>ç³»ç»Ÿç¯å¢ƒï¼šubuntu14.04<br>mesos: 0.25.0  </p>
<h3 id="ä»æºä»£ç å®‰è£…"><a href="#ä»æºä»£ç å®‰è£…" class="headerlink" title="ä»æºä»£ç å®‰è£…"></a>ä»æºä»£ç å®‰è£…</h3><p>æ ¹æ®å®˜ç½‘<a href="http://mesos.apache.org/documentation/latest/getting-started/" target="_blank" rel="external">Getting Started</a>ä»‹ç»ï¼Œå°è¯•ä»æºä»£ç ç¼–è¯‘å®‰è£…ï¼Œä½†æœªæˆåŠŸã€‚åœ¨<code>make check</code>å‘½ä»¤æ‰§è¡Œæ—¶å‡ºç°ä¸€ä¸ªé”™è¯¯ï¼Œç»è¿‡åˆ†æç»ˆäºå‘ç°åŸå› åœ¨äºæµ‹è¯•ä¸­ä¼šé€šè¿‡å­—ç¬¦ä¸²æ¯”è¾ƒéªŒè¯ç»“æœï¼Œç”±äºæˆ‘çš„ç³»ç»Ÿæ˜¯ä¸­æ–‡ç³»ç»Ÿï¼Œæµ‹è¯•ä¸­é¢„æƒ³çš„ç»“æœæ˜¯è‹±æ–‡çš„ï¼Œæ‰€ä»¥å°±å¯¼è‡´é”™è¯¯ã€‚æœ€åï¼Œéœ€è¦èƒ½å¤Ÿè®¿é—®code.google.comæ‰èƒ½è¿›è¡Œ<code>make install</code>ã€‚  </p>
<p>ä»æºä»£ç å®‰è£…æ—¶ä¼šå®‰è£…ä¸€äº›ä¾èµ–åº“ï¼ŒåŒæ—¶ä¼šå®‰è£…openjdkã€‚<br><a id="more"></a></p>
<h3 id="apt-get"><a href="#apt-get" class="headerlink" title="apt-get"></a>apt-get</h3><p>æ ¹æ®<a href="https://open.mesosphere.com/getting-started/install/" target="_blank" rel="external">mesosphere</a>ä»‹ç»ï¼Œå¯ä»¥å®‰è£…ä»¥ä¸‹æ­¥éª¤è¿›è¡Œå®‰è£…ï¼š</p>
<ol>
<li><p>æ·»åŠ åº“  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E56151BF</div><div class="line">$ DISTRO=$(lsb_release -is | tr <span class="string">'[:upper:]'</span> <span class="string">'[:lower:]'</span>)</div><div class="line">$ CODENAME=$(lsb_release -cs)</div><div class="line">$ <span class="built_in">echo</span> <span class="string">"deb http://repos.mesosphere.com/<span class="variable">$&#123;DISTRO&#125;</span> <span class="variable">$&#123;CODENAME&#125;</span> main"</span> | \</div><div class="line">  sudo tee /etc/apt/sources.list.d/mesosphere.list</div><div class="line">$ sudo apt-get -y update</div></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£…  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get -y install mesos</div></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨master  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo mesos-master --ip=127.0.0.1 --work_dir=/var/lib/mesos</div></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨slave  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mesos-slave --master=127.0.0.1:5050</div></pre></td></tr></table></figure>
</li>
<li><p>ä»æµè§ˆå™¨è§‚å¯Ÿç»“æœ<code>http://127.0.0.1:5050</code>ã€‚</p>
</li>
</ol>
<h3 id="MARATHONå®‰è£…"><a href="#MARATHONå®‰è£…" class="headerlink" title="MARATHONå®‰è£…"></a>MARATHONå®‰è£…</h3><p>MARATHONä¾èµ–äºJava 8ã€‚å‚è€ƒ(mesosphere)[<a href="https://mesosphere.com/downloads/]çš„å†…å®¹ï¼Œå®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š" target="_blank" rel="external">https://mesosphere.com/downloads/]çš„å†…å®¹ï¼Œå®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š</a>  </p>
<ol>
<li><p>æ·»åŠ å¿…è¦çš„åº“  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update -y</div><div class="line">$ sudo DEBIAN_FRONTEND=noninteractive apt-get install -y python-software-properties software-properties-common</div><div class="line">$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv E56151BF</div><div class="line">$ DISTRO=$(lsb_release -is | tr <span class="string">'[:upper:]'</span> <span class="string">'[:lower:]'</span>)</div><div class="line">$ CODENAME=$(lsb_release -cs)</div><div class="line">$ sudo <span class="built_in">echo</span> <span class="string">"deb http://repos.mesosphere.io/<span class="variable">$&#123;DISTRO&#125;</span> <span class="variable">$&#123;CODENAME&#125;</span> main"</span> | tee /etc/apt/sources.list.d/mesosphere.list</div></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£…Java 8  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo add-apt-repository ppa:webupd8team/java</div><div class="line">$ sudo apt-get update -y</div><div class="line">$ sudo apt-get install -y oracle-java8-installer oracle-java8-set-default</div><div class="line">$ sudo apt-get -y install marathon</div></pre></td></tr></table></figure>
</li>
<li><p>è¿è¡ŒMARATHON</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ marathon --master zk://127.0.0.1:2181,127.0.0.1:2181/mesos --zk zk://127.0.0.1:2181,127.0.0.1:2181/marathon</div></pre></td></tr></table></figure>
</li>
<li><p>ä»æµè§ˆå™¨è§‚å¯Ÿç»“æœ<code>http://127.0.0.1:8080</code></p>
</li>
</ol>
<h3 id="MESOSçš„ä¸€äº›å‘½ä»¤"><a href="#MESOSçš„ä¸€äº›å‘½ä»¤" class="headerlink" title="MESOSçš„ä¸€äº›å‘½ä»¤"></a>MESOSçš„ä¸€äº›å‘½ä»¤</h3><p>To (start | stop | restart) mesos-master:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mesos-master (start | stop | restart)</div></pre></td></tr></table></figure>  </p>
<p>To (start | stop | restart) mesos-slave:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mesos-slave (start | stop | restart)</div></pre></td></tr></table></figure></p>
<p>If you want to disable these service from launching automatically on a reboot:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> manual &gt; /etc/init/mesos-master.override</div><div class="line"><span class="built_in">echo</span> manual &gt; /etc/init/mesos-slave.override</div><div class="line"><span class="built_in">echo</span> manual &gt; /etc/init/zookeeper.override</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;åŸºæœ¬ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#åŸºæœ¬ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬ç¯å¢ƒ&quot;&gt;&lt;/a&gt;åŸºæœ¬ç¯å¢ƒ&lt;/h3&gt;&lt;p&gt;ç³»ç»Ÿç¯å¢ƒï¼šubuntu14.04&lt;br&gt;mesos: 0.25.0  &lt;/p&gt;
&lt;h3 id=&quot;ä»æºä»£ç å®‰è£…&quot;&gt;&lt;a href=&quot;#ä»æºä»£ç å®‰è£…&quot; class=&quot;headerlink&quot; title=&quot;ä»æºä»£ç å®‰è£…&quot;&gt;&lt;/a&gt;ä»æºä»£ç å®‰è£…&lt;/h3&gt;&lt;p&gt;æ ¹æ®å®˜ç½‘&lt;a href=&quot;http://mesos.apache.org/documentation/latest/getting-started/&quot;&gt;Getting Started&lt;/a&gt;ä»‹ç»ï¼Œå°è¯•ä»æºä»£ç ç¼–è¯‘å®‰è£…ï¼Œä½†æœªæˆåŠŸã€‚åœ¨&lt;code&gt;make check&lt;/code&gt;å‘½ä»¤æ‰§è¡Œæ—¶å‡ºç°ä¸€ä¸ªé”™è¯¯ï¼Œç»è¿‡åˆ†æç»ˆäºå‘ç°åŸå› åœ¨äºæµ‹è¯•ä¸­ä¼šé€šè¿‡å­—ç¬¦ä¸²æ¯”è¾ƒéªŒè¯ç»“æœï¼Œç”±äºæˆ‘çš„ç³»ç»Ÿæ˜¯ä¸­æ–‡ç³»ç»Ÿï¼Œæµ‹è¯•ä¸­é¢„æƒ³çš„ç»“æœæ˜¯è‹±æ–‡çš„ï¼Œæ‰€ä»¥å°±å¯¼è‡´é”™è¯¯ã€‚æœ€åï¼Œéœ€è¦èƒ½å¤Ÿè®¿é—®code.google.comæ‰èƒ½è¿›è¡Œ&lt;code&gt;make install&lt;/code&gt;ã€‚  &lt;/p&gt;
&lt;p&gt;ä»æºä»£ç å®‰è£…æ—¶ä¼šå®‰è£…ä¸€äº›ä¾èµ–åº“ï¼ŒåŒæ—¶ä¼šå®‰è£…openjdkã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="MESOS" scheme="http://itanch.github.io/tags/MESOS/"/>
    
      <category term="ubuntu" scheme="http://itanch.github.io/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>MooseFSå®‰è£…</title>
    <link href="http://itanch.github.io/2015/09/22/MooseFS%E5%AE%89%E8%A3%85/"/>
    <id>http://itanch.github.io/2015/09/22/MooseFSå®‰è£…/</id>
    <published>2015-09-22T08:21:51.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>MooseFS is a Fault tolerant, Highly available, Highly performing, Scaling-out, Network distributed file system. It spreads data over several physical commodity servers, which are visible to the user as one resource. For standard file operations MooseFS acts like any other Unix-like file system:<br>        1.A hierarchical structure (directory tree)<br>    2.Stores POSIX file attributes (permissions, last access and modification times)<br>    3.Supports special files (block and character devices, pipes and sockets)<br>    4.Symbolic links (file names pointing to target files, not necessarily on MooseFS) and hard links (different names of files which refer to the same data on MooseFS)<br>    5.Access to the file system can be limited based on IP address and/or password</p>
</blockquote>
<h3 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>å®éªŒç¯å¢ƒï¼šä¸¤ä¸ªUbuntu14.04è®¡ç®—æœºã€‚<br>MooseFSç‰ˆæœ¬ï¼š2.0.76ã€‚  </p>
<p>MooseFS<a href="http://www.moosefs.org/" target="_blank" rel="external">å®˜ç½‘1</a>ï¼Œ<a href="http://moosefs.com/index.html" target="_blank" rel="external">å®˜ç½‘2</a>ã€‚æ®è§‚å¯Ÿï¼Œå®˜ç½‘2å†…å®¹è¾ƒæ–°ã€‚</p>
<p><a href="http://moosefs.com/download/ubuntudebian.html" target="_blank" rel="external">å‚è€ƒ1</a>ï¼Œ<a href="http://moosefs.com/Content/Downloads/MooseFS-2-0-60-User-Manual.pdf" target="_blank" rel="external">å‚è€ƒ2</a>ã€‚<br><a id="more"></a></p>
<h3 id="å®‰è£…master-åœ¨é€‰å®šçš„masterèŠ‚ç‚¹ä¸Šæ“ä½œ"><a href="#å®‰è£…master-åœ¨é€‰å®šçš„masterèŠ‚ç‚¹ä¸Šæ“ä½œ" class="headerlink" title="å®‰è£…master(åœ¨é€‰å®šçš„masterèŠ‚ç‚¹ä¸Šæ“ä½œ)"></a>å®‰è£…master(åœ¨é€‰å®šçš„masterèŠ‚ç‚¹ä¸Šæ“ä½œ)</h3><p>æ·»åŠ key:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ wget -O - http://ppa.moosefs.com/moosefs.key | sudo apt-key add -</div></pre></td></tr></table></figure>  </p>
<p>åœ¨æ–‡ä»¶<code>/etc/apt/sources.list.d/moosefs.list</code>ä¸­æ·»åŠ å¦‚ä¸‹è½¯ä»¶æºï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">deb http://ppa.moosefs.com/stable/apt/ubuntu/trusty trusty main</div></pre></td></tr></table></figure></p>
<p>æ›´æ–°è½¯ä»¶æºï¼Œå®‰è£…masterï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install moosefs-master</div></pre></td></tr></table></figure></p>
<p>æ‹·è´<code>/etc/mfs</code>ä¸‹çš„å¦‚ä¸‹æ–‡ä»¶ï¼Œå¯ä»¥æŒ‰éœ€ä¿®æ”¹å…¶ä¸­çš„å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤å€¼ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cp mfsmaster.cfg.dist mfsmaster.cfg</div><div class="line">$ cp mfsexports.cfg.dist mfsexports.cfg</div></pre></td></tr></table></figure></p>
<p>å¯åŠ¨ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo mfsmaster start</div></pre></td></tr></table></figure><br>å¯ä»¥ä¿®æ”¹<code>/etc/default/moosefs-ce-master</code>ä¸­çš„<code>MFSMASTER_ENABLE</code>ä¸º<code>true</code>ï¼Œä½¿å¾—è¯¥æœåŠ¡å¼€æœºå¯åŠ¨ã€‚</p>
<h3 id="å®‰è£…å…¶å®ƒå·¥å…·"><a href="#å®‰è£…å…¶å®ƒå·¥å…·" class="headerlink" title="å®‰è£…å…¶å®ƒå·¥å…·"></a>å®‰è£…å…¶å®ƒå·¥å…·</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install moosefs-cgi</div><div class="line">$ sudo apt-get install moosefs-cgiserv</div><div class="line">$ sudo apt-get install moosefs-cli</div></pre></td></tr></table></figure>  
<p>å¯åŠ¨mfscgiservï¼Œå¯ä»¥åœ¨æµè§ˆå™¨è§‚å¯Ÿmfsè¿è¡Œæƒ…å†µã€‚å¦‚æœæœ¬æœºä¸ºmasterï¼Œå¯ä»¥è®¿é—®<a href="http://127.0.0.1:9425" target="_blank" rel="external">http://127.0.0.1:9425</a>ã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo mfscgiserv start</div></pre></td></tr></table></figure></p>
<h3 id="å®‰è£…chunkserver-åœ¨é€‰å®šçš„chunkèŠ‚ç‚¹ä¸Šæ“ä½œ"><a href="#å®‰è£…chunkserver-åœ¨é€‰å®šçš„chunkèŠ‚ç‚¹ä¸Šæ“ä½œ" class="headerlink" title="å®‰è£…chunkserver(åœ¨é€‰å®šçš„chunkèŠ‚ç‚¹ä¸Šæ“ä½œ)"></a>å®‰è£…chunkserver(åœ¨é€‰å®šçš„chunkèŠ‚ç‚¹ä¸Šæ“ä½œ)</h3><p>é¦–å…ˆåƒå®‰è£…masterä¸€æ ·æ·»åŠ è½¯ä»¶æºï¼Œç„¶åå®‰è£…ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install moosefs-chunkserver</div></pre></td></tr></table></figure>  </p>
<p>åŒæ ·ï¼Œä¿®æ”¹<code>/etc/mfs</code>æ–‡ä»¶ä¸‹çš„å¦‚ä¸‹æ–‡ä»¶ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo cp mfschunkserver.cfg.dist mfschunkserver.cfg</div><div class="line">$ sudo cp mfshdd.cfg.dist mfshdd.cfg</div></pre></td></tr></table></figure><br>å…¶ä¸­ï¼Œ<code>mfschunkserver.cfg</code>æ–‡ä»¶çš„å‚æ•°<code>MASTER_HOST = mfsmaster</code>å¯ä»¥æŒ‡å®šmasterçš„hostnameï¼Œè¿™é‡Œéœ€è¦åœ¨<code>/etc/hosts</code>ä¸­å†™æ˜ï¼Œå¹¶ä¸”å¦‚æœmasterä¹Ÿä½œä¸ºchunkserveræ—¶ï¼Œhostsä¸­mfsmasterçš„ipä¸èƒ½ä½¿ç”¨127.0.0.1ã€‚</p>
<p>å»ºç«‹æ–‡ä»¶,æ–‡ä»¶åå­—å¯ä»¥å†™è‡ªå·±å–œæ¬¢çš„ï¼Œè¿™é‡Œå–åmfschunkï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /mnt/mfschunk</div><div class="line">$ chown -R mfs:mfs /mnt/mfschunk</div></pre></td></tr></table></figure></p>
<p>åœ¨<code>mfshdd.cfg</code>æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œ<code>/mnt/mfschunk</code>ã€‚å¯åŠ¨mfschunkserver:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo mfschunkserver start</div></pre></td></tr></table></figure></p>
<h3 id="å®‰è£…å®¢æˆ·ç«¯"><a href="#å®‰è£…å®¢æˆ·ç«¯" class="headerlink" title="å®‰è£…å®¢æˆ·ç«¯"></a>å®‰è£…å®¢æˆ·ç«¯</h3><p>å®‰è£…å®¢æˆ·ç«¯ï¼Œæ·»åŠ æŒ‚è½½ç‚¹ï¼Œè¿›è¡ŒæŒ‚è½½ã€‚mfsmasteråœ¨è¿™é‡Œä¸ºmasterçš„hostnameã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install moosefs-client</div><div class="line">$ sudo mkdir -p /mnt/mfs</div><div class="line">$ sudo mfsmount mfs -H mfsmaster</div></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ df -h</div><div class="line">mfsmaster:9421  1.3T   70G  1.2T    6% /mnt/mfs</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;MooseFS is a Fault tolerant, Highly available, Highly performing, Scaling-out, Network distributed file system. It spreads data over several physical commodity servers, which are visible to the user as one resource. For standard file operations MooseFS acts like any other Unix-like file system:&lt;br&gt;        1.A hierarchical structure (directory tree)&lt;br&gt;    2.Stores POSIX file attributes (permissions, last access and modification times)&lt;br&gt;    3.Supports special files (block and character devices, pipes and sockets)&lt;br&gt;    4.Symbolic links (file names pointing to target files, not necessarily on MooseFS) and hard links (different names of files which refer to the same data on MooseFS)&lt;br&gt;    5.Access to the file system can be limited based on IP address and/or password&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;åŸºæœ¬ä¿¡æ¯&quot;&gt;&lt;a href=&quot;#åŸºæœ¬ä¿¡æ¯&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬ä¿¡æ¯&quot;&gt;&lt;/a&gt;åŸºæœ¬ä¿¡æ¯&lt;/h3&gt;&lt;p&gt;å®éªŒç¯å¢ƒï¼šä¸¤ä¸ªUbuntu14.04è®¡ç®—æœºã€‚&lt;br&gt;MooseFSç‰ˆæœ¬ï¼š2.0.76ã€‚  &lt;/p&gt;
&lt;p&gt;MooseFS&lt;a href=&quot;http://www.moosefs.org/&quot;&gt;å®˜ç½‘1&lt;/a&gt;ï¼Œ&lt;a href=&quot;http://moosefs.com/index.html&quot;&gt;å®˜ç½‘2&lt;/a&gt;ã€‚æ®è§‚å¯Ÿï¼Œå®˜ç½‘2å†…å®¹è¾ƒæ–°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://moosefs.com/download/ubuntudebian.html&quot;&gt;å‚è€ƒ1&lt;/a&gt;ï¼Œ&lt;a href=&quot;http://moosefs.com/Content/Downloads/MooseFS-2-0-60-User-Manual.pdf&quot;&gt;å‚è€ƒ2&lt;/a&gt;ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="ubuntu" scheme="http://itanch.github.io/tags/ubuntu/"/>
    
      <category term="MooseFS" scheme="http://itanch.github.io/tags/MooseFS/"/>
    
  </entry>
  
  <entry>
    <title>slurmå®‰è£…</title>
    <link href="http://itanch.github.io/2015/09/10/slurm%E5%AE%89%E8%A3%85/"/>
    <id>http://itanch.github.io/2015/09/10/slurmå®‰è£…/</id>
    <published>2015-09-10T09:17:44.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><blockquote>
<p>Slurm is an open-source workload manager designed for Linux clusters of all sizes. It provides three key functions. First it allocates exclusive and/or non-exclusive access to resources (computer nodes) to users for some duration of time so they can perform work. Second, it provides a framework for starting, executing, and monitoring work (typically a parallel job) on a set of allocated nodes. Finally, it arbitrates contention for resources by managing a queue of pending work.  </p>
</blockquote>
<p>ç³»ç»Ÿï¼šubuntu 14.04ã€‚slurmç‰ˆæœ¬2.6.5ã€‚<br>èŠ‚ç‚¹ï¼š2ä¸ªç‹¬ç«‹çš„ubuntu14.04è®¡ç®—æœºã€‚<br><a id="more"></a></p>
<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>åœ¨ubuntuä¸­ï¼Œæœ€ç®€å•çš„å®‰è£…æ–¹æ³•æ˜¯ä½¿ç”¨apt-getï¼Œç›®å‰è‡ªåŠ¨å®‰è£…çš„slurmç‰ˆæœ¬ä¸º2.6.5ï¼Œå¹¶ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install slurm-llnl</div></pre></td></tr></table></figure>  </p>
<p>å®‰è£…slurmçš„åŒæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè›‹ç–¼çš„slurmç”¨æˆ·ï¼Œä½†æ˜¯è¿™ä¸ªç”¨æˆ·æ²¡æœ‰homeæ–‡ä»¶ï¼Œæ‰€ä»¥æ— æ³•åˆ‡æ¢åˆ°è¯¥ç”¨æˆ·ä¸‹è¿›è¡Œå·¥ä½œã€‚æˆ‘çš„å»ºè®®æ˜¯åˆ é™¤æ—§çš„slurmç”¨æˆ·ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸ºäº†mungeçš„æ­£ç¡®è¿è¡Œåšå‡†å¤‡ã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo deluser slurm</div></pre></td></tr></table></figure><br>ä½¿ç”¨slurmï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹å¿…é¡»åœ¨ç›¸åŒçš„ç”¨æˆ·ä¸‹å·¥ä½œï¼Œå»ºè®®æ–°å»ºä¸€ä¸ªslurmç”¨æˆ·ï¼Œå¿…é¡»æŒ‡å®šUIDï¼Œä¿è¯æ‰€æœ‰èŠ‚ç‚¹slurmç”¨æˆ·çš„UIDä¹Ÿç›¸åŒï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo adduser --uid &lt;ID&gt; &lt;new name&gt;</div></pre></td></tr></table></figure></p>
<h3 id="Munge"><a href="#Munge" class="headerlink" title="Munge"></a>Munge</h3><p>åœ¨å®‰è£…slurmçš„åŒæ—¶ï¼Œä¹Ÿä¼šå®‰è£…<a href="https://github.com/dun/munge/wiki/Installation-Guide" target="_blank" rel="external">munge</a>ã€‚  </p>
<blockquote>
<p>MUNGE (MUNGE Uid â€˜Nâ€™ Gid Emporium) is an authentication service for creating and validating credentials. It is designed to be highly scalable for use in an HPC cluster environment. It allows a process to authenticate the UID and GID of another local or remote process within a group of hosts having common users and groups. These hosts form a security realm that is defined by a shared cryptographic key. Clients within this security realm can create and validate credentials without the use of root privileges, reserved ports, or platform-specific methods.  </p>
</blockquote>
<p>1.ç”Ÿæˆkey<br>é¦–å…ˆç”Ÿæˆkeyï¼Œè‡ªåŠ¨ç”Ÿæˆè‡³<code>/ete/munge/munge.key</code>ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ create-munge-key</div></pre></td></tr></table></figure></p>
<p>2.éƒ¨ç½²<br>å°†keyæ‹·è´è‡³æ‰€æœ‰èŠ‚ç‚¹ã€‚æ‹·è´<code>/etc/munge/munge.key</code>åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„<code>/etc/munge/</code>ç›®å½•ä¸‹ã€‚</p>
<p>3.å¯åŠ¨<br>å¯åŠ¨mungeã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo /etc/init.d/munge start</div></pre></td></tr></table></figure>  </p>
<p>å‡ºç°é”™è¯¯ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* Starting MUNGE munged                                                 [fail]</div><div class="line">munged: Error: Logfile is insecure: group-writable permissions <span class="built_in">set</span> on <span class="string">"/var/log"</span></div></pre></td></tr></table></figure><br>å‡ºç°ä¸Šè¿°é”™è¯¯éœ€è¦ä¿®æ”¹logæ–‡ä»¶æƒé™ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo chmod g-w /var/<span class="built_in">log</span></div></pre></td></tr></table></figure>  </p>
<p>å‡ºç°é”™è¯¯ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* Starting MUNGE munged                                           [fail]</div><div class="line">munged: Error: Logfile is insecure: invalid ownership of <span class="string">"/var/log/munge"</span>  </div></pre></td></tr></table></figure><br>é¦–å…ˆå°è¯•ä½¿ç”¨sudoå¯åŠ¨ï¼Œè‹¥ä¸æˆåŠŸï¼Œåˆ™å‚è€ƒå¦‚ä¸‹ã€‚mungeå®‰è£…çš„æ‰€æœ‰æ–‡ä»¶ï¼Œé»˜è®¤ç”¨æˆ·ä¸ºmunge:mungeï¼Œå½“å‰ç”¨æˆ·å¦‚æœä¸æ˜¯mungeï¼Œå¯åŠ¨å‡ºç°é”™è¯¯ï¼š<br>éœ€è¦ä¿®æ”¹å¦‚ä¸‹æ–‡ä»¶çš„ç”¨æˆ·ï¼š<br>/etc/munge/<br>/var/lib/munge/<br>/var/log/munge/<br>/var/run/munge/<br>ä¿®æ”¹æ–‡ä»¶ç”¨æˆ·çš„å‘½ä»¤ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo chown -R &lt;user&gt;:&lt;group&gt; &lt;dir&gt;  </div></pre></td></tr></table></figure><br>ä¿®æ”¹/ete/init.d/mungeï¼Œå°†USERå˜é‡ä¿®æ”¹ä¸ºä½ çš„ç”¨æˆ·åã€‚</p>
<p>4.éªŒè¯<br>åœ¨slurmç”¨æˆ·ä¸‹éªŒè¯æœ¬æœºï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ munge -n | unmunge</div><div class="line">STATUS:           Success (0)</div><div class="line">ENCODE_HOST:      localhost (127.0.0.1)</div><div class="line">ENCODE_TIME:      2015-09-14 16:39:58 +0800 (1442219998)</div><div class="line">DECODE_TIME:      2015-09-14 16:39:58 +0800 (1442219998)</div><div class="line">TTL:              300</div><div class="line">CIPHER:           aes128 (4)</div><div class="line">MAC:              sha1 (3)</div><div class="line">ZIP:              none (0)</div><div class="line">UID:              slurm (1023)</div><div class="line">GID:              slurm (1023)</div><div class="line">LENGTH:           0</div></pre></td></tr></table></figure>  </p>
<p>éªŒè¯å…¶å®ƒèŠ‚ç‚¹ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ munge -n | ssh node01 unmunge</div><div class="line">STATUS:           Success (0)</div><div class="line">ENCODE_HOST:      localhost (127.0.0.1)</div><div class="line">ENCODE_TIME:      2015-09-14 16:40:09 +0800 (1442220009)</div><div class="line">DECODE_TIME:      2015-09-14 16:39:49 +0800 (1442219989)</div><div class="line">TTL:              300</div><div class="line">CIPHER:           aes128 (4)</div><div class="line">MAC:              sha1 (3)</div><div class="line">ZIP:              none (0)</div><div class="line">UID:              slurm (1023)</div><div class="line">GID:              slurm (1023)</div><div class="line">LENGTH:           0</div></pre></td></tr></table></figure>  </p>
<p>æ³¨æ„ï¼mungeè‡ªåŠ¨è®¤è¯çš„æ˜¯ç›¸åŒçš„ç”¨æˆ·ï¼Œå³UIDå’ŒGIDç›¸åŒï¼Œå¹¶ä¸æ˜¯æŒ‰ç…§ç”¨æˆ·åç§°æ¥åŒ¹é…ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºslurmç”¨æˆ·æ—¶å¿…é¡»æŒ‡å®šç›¸åŒçš„UIDå’ŒGIDã€‚  </p>
<h3 id="slurmé…ç½®æ–‡ä»¶"><a href="#slurmé…ç½®æ–‡ä»¶" class="headerlink" title="slurmé…ç½®æ–‡ä»¶"></a>slurmé…ç½®æ–‡ä»¶</h3><p>åœ¨å®‰è£…æ–‡ä»¶ä¸­æœ‰é…ç½®å·¥å…·ï¼š<br><code>slurm-xxx/doc/html/configurator.html.in</code><br>å¦‚æœä½¿ç”¨apt-getå®‰è£…ï¼Œåˆ™éœ€è¦æ ¹æ®è‡ªå·±slurmçš„ç‰ˆæœ¬ä¿¡æ¯ä¸‹è½½ç›¸åº”çš„taræ–‡ä»¶ï¼Œè§£å‹åä½¿ç”¨ï¼Œ<a href="http://www.schedmd.com/#archives" target="_blank" rel="external">slurmæ‰€æœ‰ç‰ˆæœ¬</a>ã€‚  </p>
<p>é…ç½®æ–‡ä»¶æ ·ä¾‹ï¼š<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># slurm.conf file generated by configurator.html.</span></div><div class="line"><span class="meta"># Put this file on all nodes of your cluster.</span></div><div class="line"><span class="meta"># See the slurm.conf man page for more information.</span></div><div class="line"><span class="meta">#</span></div><div class="line">ControlMachine=node00</div><div class="line"><span class="meta">#ControlAddr=</span></div><div class="line"><span class="meta">#BackupController=</span></div><div class="line"><span class="meta">#BackupAddr=</span></div><div class="line"><span class="meta">#</span></div><div class="line">AuthType=auth/munge</div><div class="line">CacheGroups=<span class="number">0</span></div><div class="line"><span class="meta">#CheckpointType=checkpoint/none</span></div><div class="line">CryptoType=crypto/munge</div><div class="line"><span class="meta">#DisableRootJobs=NO</span></div><div class="line"><span class="meta">#EnforcePartLimits=NO</span></div><div class="line"><span class="meta">#Epilog=</span></div><div class="line"><span class="meta">#EpilogSlurmctld=</span></div><div class="line"><span class="meta">#FirstJobId=1</span></div><div class="line"><span class="meta">#MaxJobId=999999</span></div><div class="line"><span class="meta">#GresTypes=</span></div><div class="line"><span class="meta">#GroupUpdateForce=0</span></div><div class="line"><span class="meta">#GroupUpdateTime=600</span></div><div class="line"><span class="meta">#JobCheckpointDir=/var/slurm/checkpoint</span></div><div class="line"><span class="meta">#JobCredentialPrivateKey=</span></div><div class="line"><span class="meta">#JobCredentialPublicCertificate=</span></div><div class="line"><span class="meta">#JobFileAppend=0</span></div><div class="line"><span class="meta">#JobRequeue=1</span></div><div class="line"><span class="meta">#JobSubmitPlugins=1</span></div><div class="line"><span class="meta">#KillOnBadExit=0</span></div><div class="line"><span class="meta">#LaunchType=launch/slurm</span></div><div class="line"><span class="meta">#Licenses=foo*4,bar</span></div><div class="line"><span class="meta">#MailProg=/bin/mail</span></div><div class="line"><span class="meta">#MaxJobCount=5000</span></div><div class="line"><span class="meta">#MaxStepCount=40000</span></div><div class="line"><span class="meta">#MaxTasksPerNode=128</span></div><div class="line">MpiDefault=none</div><div class="line"><span class="meta">#MpiParams=ports=#-#</span></div><div class="line"><span class="meta">#PluginDir=</span></div><div class="line"><span class="meta">#PlugStackConfig=</span></div><div class="line"><span class="meta">#PrivateData=jobs</span></div><div class="line">ProctrackType=proctrack/pgid</div><div class="line"><span class="meta">#Prolog=</span></div><div class="line"><span class="meta">#PrologSlurmctld=</span></div><div class="line"><span class="meta">#PropagatePrioProcess=0</span></div><div class="line"><span class="meta">#PropagateResourceLimits=</span></div><div class="line"><span class="meta">#PropagateResourceLimitsExcept=</span></div><div class="line"><span class="meta">#RebootProgram=</span></div><div class="line">ReturnToService=<span class="number">1</span></div><div class="line"><span class="meta">#SallocDefaultCommand=</span></div><div class="line">SlurmctldPidFile=/<span class="keyword">var</span>/run/slurmctld.pid</div><div class="line">SlurmctldPort=<span class="number">6817</span></div><div class="line">SlurmdPidFile=/<span class="keyword">var</span>/run/slurmd.pid</div><div class="line">SlurmdPort=<span class="number">6818</span></div><div class="line">SlurmdSpoolDir=/home/slurm/Slurm</div><div class="line">SlurmUser=slurm</div><div class="line"><span class="meta">#SlurmdUser=root</span></div><div class="line"><span class="meta">#SrunEpilog=</span></div><div class="line"><span class="meta">#SrunProlog=</span></div><div class="line">StateSaveLocation=/home/slurm/Slurm/out</div><div class="line">SwitchType=<span class="keyword">switch</span>/none</div><div class="line"><span class="meta">#TaskEpilog=</span></div><div class="line">TaskPlugin=task/none</div><div class="line"><span class="meta">#TaskPluginParam=</span></div><div class="line"><span class="meta">#TaskProlog=</span></div><div class="line"><span class="meta">#TopologyPlugin=topology/tree</span></div><div class="line"><span class="meta">#TmpFS=/tmp</span></div><div class="line"><span class="meta">#TrackWCKey=no</span></div><div class="line"><span class="meta">#TreeWidth=</span></div><div class="line"><span class="meta">#UnkillableStepProgram=</span></div><div class="line"><span class="meta">#UsePAM=0</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># TIMERS</span></div><div class="line"><span class="meta">#BatchStartTimeout=10</span></div><div class="line"><span class="meta">#CompleteWait=0</span></div><div class="line"><span class="meta">#EpilogMsgTime=2000</span></div><div class="line"><span class="meta">#GetEnvTimeout=2</span></div><div class="line"><span class="meta">#HealthCheckInterval=0</span></div><div class="line"><span class="meta">#HealthCheckProgram=</span></div><div class="line">InactiveLimit=<span class="number">30</span></div><div class="line">KillWait=<span class="number">30</span></div><div class="line"><span class="meta">#MessageTimeout=10</span></div><div class="line"><span class="meta">#ResvOverRun=0</span></div><div class="line">MinJobAge=<span class="number">300</span></div><div class="line"><span class="meta">#OverTimeLimit=0</span></div><div class="line">SlurmctldTimeout=<span class="number">120</span></div><div class="line">SlurmdTimeout=<span class="number">300</span></div><div class="line"><span class="meta">#UnkillableStepTimeout=60</span></div><div class="line"><span class="meta">#VSizeFactor=0</span></div><div class="line">Waittime=<span class="number">300</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># SCHEDULING</span></div><div class="line"><span class="meta">#DefMemPerCPU=0</span></div><div class="line">FastSchedule=<span class="number">1</span></div><div class="line"><span class="meta">#MaxMemPerCPU=0</span></div><div class="line"><span class="meta">#SchedulerRootFilter=1</span></div><div class="line"><span class="meta">#SchedulerTimeSlice=30</span></div><div class="line">SchedulerType=sched/backfill</div><div class="line">SchedulerPort=<span class="number">7321</span></div><div class="line">SelectType=select/linear</div><div class="line"><span class="meta">#SelectTypeParameters=</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># JOB PRIORITY</span></div><div class="line"><span class="meta">#PriorityFlags=</span></div><div class="line"><span class="meta">#PriorityType=priority/basic</span></div><div class="line"><span class="meta">#PriorityDecayHalfLife=</span></div><div class="line"><span class="meta">#PriorityCalcPeriod=</span></div><div class="line"><span class="meta">#PriorityFavorSmall=</span></div><div class="line"><span class="meta">#PriorityMaxAge=</span></div><div class="line"><span class="meta">#PriorityUsageResetPeriod=</span></div><div class="line"><span class="meta">#PriorityWeightAge=</span></div><div class="line"><span class="meta">#PriorityWeightFairshare=</span></div><div class="line"><span class="meta">#PriorityWeightJobSize=</span></div><div class="line"><span class="meta">#PriorityWeightPartition=</span></div><div class="line"><span class="meta">#PriorityWeightQOS=</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># LOGGING AND ACCOUNTING</span></div><div class="line"><span class="meta">#AccountingStorageEnforce=0</span></div><div class="line"><span class="meta">#AccountingStorageHost=</span></div><div class="line"><span class="meta">#AccountingStorageLoc=</span></div><div class="line"><span class="meta">#AccountingStoragePass=</span></div><div class="line"><span class="meta">#AccountingStoragePort=</span></div><div class="line">AccountingStorageType=accounting_storage/none</div><div class="line"><span class="meta">#AccountingStorageUser=</span></div><div class="line">AccountingStoreJobComment=YES</div><div class="line">ClusterName=cluster</div><div class="line"><span class="meta">#DebugFlags=</span></div><div class="line"><span class="meta">#JobCompHost=</span></div><div class="line"><span class="meta">#JobCompLoc=</span></div><div class="line"><span class="meta">#JobCompPass=</span></div><div class="line"><span class="meta">#JobCompPort=</span></div><div class="line">JobCompType=jobcomp/none</div><div class="line"><span class="meta">#JobCompUser=</span></div><div class="line">JobAcctGatherFrequency=<span class="number">30</span></div><div class="line">JobAcctGatherType=jobacct_gather/none</div><div class="line">SlurmctldDebug=<span class="number">3</span></div><div class="line"><span class="meta">#SlurmctldLogFile=</span></div><div class="line">SlurmdDebug=<span class="number">3</span></div><div class="line"><span class="meta">#SlurmdLogFile=</span></div><div class="line"><span class="meta">#SlurmSchedLogFile=</span></div><div class="line"><span class="meta">#SlurmSchedLogLevel=</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># POWER SAVE SUPPORT FOR IDLE NODES (optional)</span></div><div class="line"><span class="meta">#SuspendProgram=</span></div><div class="line"><span class="meta">#ResumeProgram=</span></div><div class="line"><span class="meta">#SuspendTimeout=</span></div><div class="line"><span class="meta">#ResumeTimeout=</span></div><div class="line"><span class="meta">#ResumeRate=</span></div><div class="line"><span class="meta">#SuspendExcNodes=</span></div><div class="line"><span class="meta">#SuspendExcParts=</span></div><div class="line"><span class="meta">#SuspendRate=</span></div><div class="line"><span class="meta">#SuspendTime=</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># COMPUTE NODES</span></div><div class="line">NodeName=node01 CPUs=<span class="number">1</span> State=UNKNOWN</div><div class="line">NodeName=node00 CPUs=<span class="number">1</span> State=UNKNOWN</div><div class="line">PartitionName=debug Nodes=node00,node01 Default=YES MaxTime=INFINITE State=UP</div></pre></td></tr></table></figure>  </p>
<p>å°†è¯¥é…ç½®æ–‡ä»¶æ‹·è´è‡³æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ”¾ç½®äº/etc/slurm-llnl/slurm.confä¸­ã€‚</p>
<h3 id="å¯åŠ¨å’Œæµ‹è¯•slurm"><a href="#å¯åŠ¨å’Œæµ‹è¯•slurm" class="headerlink" title="å¯åŠ¨å’Œæµ‹è¯•slurm"></a>å¯åŠ¨å’Œæµ‹è¯•slurm</h3><p>åˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸­å¯åŠ¨ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo /ete/init.d/slurm-llnl start</div></pre></td></tr></table></figure>  </p>
<p>æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sinfo</div></pre></td></tr></table></figure></p>
<p>æµ‹è¯•è„šæœ¬testï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#SBATCH -A &lt;account&gt;</span></div><div class="line"><span class="comment">#SBATCH -D /home/slurm/Slurm</span></div><div class="line"><span class="comment">#SBATCH -I</span></div><div class="line"><span class="comment">#SBATCH --time=00:30:00</span></div><div class="line"><span class="comment">#SBATCH --error=job.%J.err</span></div><div class="line"><span class="comment">#SBATCH --output=job.%J.out</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"hello world!"</span></div><div class="line">./hello.sh</div></pre></td></tr></table></figure></p>
<p>è¿è¡Œæµ‹è¯•è„šæœ¬:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sbatch <span class="built_in">test</span></div></pre></td></tr></table></figure></p>
<p>å½“æŸä¸€ä¸ªjobå› ä¸ºæŸäº›I/OåŸå› é˜»å¡ä»¥åï¼Œä¼šå¯¼è‡´æŸä¸ªèŠ‚ç‚¹ä¸€ç›´å¤„äºcompçŠ¶æ€ï¼Œé‡å¯è¯¥èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ scontrol update NodeName=OptiPlex State=DOWN Reason=hung_completing</div><div class="line">$ scontrol update NodeName=OptiPlex State=RESUME</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;è¯´æ˜&quot;&gt;&lt;a href=&quot;#è¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;è¯´æ˜&quot;&gt;&lt;/a&gt;è¯´æ˜&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;Slurm is an open-source workload manager designed for Linux clusters of all sizes. It provides three key functions. First it allocates exclusive and/or non-exclusive access to resources (computer nodes) to users for some duration of time so they can perform work. Second, it provides a framework for starting, executing, and monitoring work (typically a parallel job) on a set of allocated nodes. Finally, it arbitrates contention for resources by managing a queue of pending work.  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç³»ç»Ÿï¼šubuntu 14.04ã€‚slurmç‰ˆæœ¬2.6.5ã€‚&lt;br&gt;èŠ‚ç‚¹ï¼š2ä¸ªç‹¬ç«‹çš„ubuntu14.04è®¡ç®—æœºã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="ubuntu" scheme="http://itanch.github.io/tags/ubuntu/"/>
    
      <category term="slurm" scheme="http://itanch.github.io/tags/slurm/"/>
    
  </entry>
  
  <entry>
    <title>è±†ç“£ç”µå½±Top250è·å–</title>
    <link href="http://itanch.github.io/2015/08/29/%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1Top250%E8%8E%B7%E5%8F%96/"/>
    <id>http://itanch.github.io/2015/08/29/è±†ç“£ç”µå½±Top250è·å–/</id>
    <published>2015-08-29T12:53:09.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="è±†ç“£APIè¯´æ˜"><a href="#è±†ç“£APIè¯´æ˜" class="headerlink" title="è±†ç“£APIè¯´æ˜"></a>è±†ç“£APIè¯´æ˜</h3><p>è±†ç“£ä¸ºå¼€å‘è€…æä¾›äº†ç”¨äºåº”ç”¨å¼€å‘çš„<a href="http://developers.douban.com/wiki/?title=api_v2" target="_blank" rel="external">Apiæ¥å£</a>ï¼Œé€šè¿‡è¿™äº›Apiæ¥å£å¯ä»¥è·å¾—è±†ç“£çš„éƒ¨åˆ†å†…å®¹ã€‚  </p>
<p>è±†ç“£Api V2è®¤è¯ä½¿ç”¨äº†OAuth2ï¼Œä½¿å¾—ç”¨æˆ·çš„æˆæƒè¿‡ç¨‹æ›´ä¸ºå®‰å…¨ï¼Œè¿”å›æ•°æ®çš„æ ¼å¼ä¸ºjsonï¼Œä¾¿äºåº”ç”¨å¼€å‘è€…è§£æè·å¾—çš„æ•°æ®ã€‚è±†ç“£æ²¡æœ‰æä¾›å®˜æ–¹çš„SDKï¼Œä½†æ˜¯æä¾›äº†å…¶ä»–éå®˜æ–¹çš„åŸºäºå¤šç§è¯­è¨€çš„SDKï¼Œæˆ‘ä»¬é‡‡ç”¨äº†Javaè¯­è¨€çš„<a href="https://github.com/UglyTroLL/Douban-Java-SDK-OAuth2" target="_blank" rel="external">SDK</a>ã€‚ç”±äºè¯¥ç‰ˆæœ¬çš„Java SDKåŸºäºè¾ƒæ—©çš„è±†ç“£APIçš„v1ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œéƒ¨åˆ†ä¿®æ”¹é€‚åº”æ–°çš„v2ç‰ˆæœ¬ï¼Œå…¶ä¸­æˆ‘ä»¬ä¿®æ”¹äº†ç”µå½±ç›¸å…³çš„ä»£ç (<a href="https://github.com/ITanCh/Douban-Java-SDK-OAuth2" target="_blank" rel="external">æ–°çš„æºä»£ç </a>)ã€‚  </p>
<p>Java SDKä¸ºMavenå·¥ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨Mavenç¼–è¯‘æ‰“åŒ…ï¼š  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn package -Dmaven<span class="selector-class">.test</span><span class="selector-class">.skip</span>=true</div></pre></td></tr></table></figure>  
<p>ä¸ºäº†å°†æ‰€æœ‰ä¾èµ–ä¸€èµ·æ‰“åŒ…è¿›å»ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†fatjarå·¥å…·è¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆå¯ä»¥è°ƒç”¨çš„å‡½æ•°åº“(<a href="https://github.com/ITanCh/Douban-Java-SDK-OAuth2/raw/origin/Douban-Java-SDK-OAuth2-origin_fat.jar" target="_blank" rel="external">jar</a>)ã€‚<br><a id="more"></a></p>
<h3 id="APIä½¿ç”¨"><a href="#APIä½¿ç”¨" class="headerlink" title="APIä½¿ç”¨"></a>APIä½¿ç”¨</h3><h4 id="ç›¸å…³åº“"><a href="#ç›¸å…³åº“" class="headerlink" title="ç›¸å…³åº“"></a>ç›¸å…³åº“</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.app.AccessToken;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.app.DoubanException;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.app.RequestGrantScope;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanCastObject;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanDirectorObj;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanSubjectListObj;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.model.v2.DoubanSubjectObj;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.playground.BrowserLauncher;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.playground.PlayGround;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.provider.OAuthDoubanProvider;</div><div class="line"><span class="keyword">import</span> com.dongxuexidu.douban4j.service.DoubanBookMovieMusicService;</div></pre></td></tr></table></figure>  
<h4 id="AccessTokenè·å–"><a href="#AccessTokenè·å–" class="headerlink" title="AccessTokenè·å–"></a>AccessTokenè·å–</h4><p>é€šè¿‡è±†ç“£APIè·å–ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯æ—¶éœ€è¦è·å–AccessTokenï¼Œåœ¨Javaä¸­å¯ä»¥å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">testAccessToken</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			OAuthDoubanProvider oauth = <span class="keyword">new</span> OAuthDoubanProvider();</div><div class="line">			oauth.setApiKey(<span class="string">"your api key"</span>).setSecretKey(</div><div class="line">					<span class="string">"your secret key"</span>);</div><div class="line">			oauth.addScope(RequestGrantScope.BASIC_COMMON_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.SHUO_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.SHUO_WRITE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.BASIC_NOTE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.BOOK_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.EVENT_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.EVENT_WRITE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MAIL_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MAIL_WRITE_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MOVIE_READ_SCOPE)</div><div class="line">					.addScope(RequestGrantScope.MUSIC_READ_SCOPE);</div><div class="line">			oauth.setRedirectUrl(<span class="string">"http://www.liutianchi.com"</span>);</div><div class="line">			BrowserLauncher.openURL(oauth.getGetCodeRedirectUrl());</div><div class="line">			System.out.println(oauth.getGetCodeRedirectUrl());</div><div class="line">			System.out.print(<span class="string">"Put the code you got here.[Enter]:"</span>);</div><div class="line">			BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(</div><div class="line">					System.in));</div><div class="line">			String code = br.readLine();</div><div class="line">			System.out.println(<span class="string">"code : "</span> + code);</div><div class="line">			AccessToken at = oauth.tradeAccessTokenWithCode(code);</div><div class="line">			System.out.println(<span class="string">"at : "</span> + at.getAccessToken());</div><div class="line">			System.out.println(<span class="string">"uid : "</span> + at.getDoubanUserId());</div><div class="line">			<span class="keyword">return</span> at.getAccessToken();</div><div class="line">		&#125; <span class="keyword">catch</span> (DoubanException ex) &#123;</div><div class="line">			Logger.getLogger(PlayGround.class.getName()).log(Level.SEVERE,</div><div class="line">					<span class="keyword">null</span>, ex);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			Logger.getLogger(PlayGround.class.getName()).log(Level.SEVERE,</div><div class="line">					<span class="keyword">null</span>, ex);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>  </p>
<p>è·å–ç”µå½±Top250çš„åŸºæœ¬ä¿¡æ¯ä¸æ¶‰åŠç”¨æˆ·å†…å®¹ï¼Œæ‰€ä»¥ä¸å¿…è·å–AccessTokenã€‚  </p>
<h4 id="è·å–Top250ç”µå½±ID"><a href="#è·å–Top250ç”µå½±ID" class="headerlink" title="è·å–Top250ç”µå½±ID"></a>è·å–Top250ç”µå½±ID</h4><p>è™½ç„¶è±†ç“£æä¾›äº†è·å–Top250çš„APIï¼š  </p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/v2/movie/top250</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œé€šè¿‡ä¸Šè¿°æ–¹æ³•è·å–çš„ç”µå½±ä¿¡æ¯ä¸ºç®€å•å†…å®¹ï¼Œå…¶ä¸­æ¼”å‘˜æ•°ä¸º3ï¼Œæ— ç”µå½±çš„å›½å®¶ä¿¡æ¯ï¼Œæ— ç”µå½±å†…å®¹ç®€ä»‹ã€‚è¿™äº›å†…å®¹æ— æ³•è¾¾åˆ°æˆ‘ä»¬æ•°æ®åˆ†æçš„ç›®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆç»Ÿè®¡å‡ºTop250çš„IDï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹APIè·å–æ¯ä¸€éƒ¨ç”µå½±çš„è¯¦ç»†ä¿¡æ¯:  </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/v2/m</span>ovie<span class="regexp">/subject/</span>:id</div></pre></td></tr></table></figure>  
<p>è±†ç“£é™åˆ¶äº†ä¸€æ¬¡è·å–Top250çš„ç”µå½±æ•°ç›®æœ€å¤§ä¸º100ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œ3æ¬¡è¯·æ±‚ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getTop250ID</span><span class="params">()</span> </span>&#123;</div><div class="line">		DoubanBookMovieMusicService instance = <span class="keyword">new</span> DoubanBookMovieMusicService();</div><div class="line">		DoubanSubjectListObj results = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File dirFile = <span class="keyword">new</span> File(FILEPATH);</div><div class="line">			dirFile.mkdirs();</div><div class="line"></div><div class="line">			File idFile = <span class="keyword">new</span> File(dirFile, <span class="string">"movie_id"</span>);</div><div class="line">			<span class="keyword">if</span> (!idFile.exists())</div><div class="line">				idFile.createNewFile();</div><div class="line">			BufferedWriter out = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(idFile,</div><div class="line">					<span class="keyword">false</span>));</div><div class="line"></div><div class="line">			<span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (start &lt; <span class="number">300</span>) &#123;</div><div class="line"></div><div class="line">				<span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">while</span> (flag) &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						results = instance.getMoviesTop250(start, <span class="number">100</span>);</div><div class="line">						flag = <span class="keyword">false</span>;</div><div class="line">					&#125; <span class="keyword">catch</span> (NoHttpResponseException e) &#123;</div><div class="line">						System.out.println(<span class="string">"NoHttpResponseException"</span>);</div><div class="line">						Thread.sleep(<span class="number">1000</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				List&lt;DoubanSubjectObj&gt; movieList = results.getSubjects();</div><div class="line"></div><div class="line">				<span class="keyword">for</span> (DoubanSubjectObj result : movieList) &#123;</div><div class="line">					out.write(result.getId());</div><div class="line">					out.newLine();</div><div class="line">				&#125;</div><div class="line">				start += <span class="number">100</span>;</div><div class="line">				Thread.sleep(<span class="number">1000</span>);</div><div class="line">			&#125;</div><div class="line">			out.write(<span class="string">"#"</span>);</div><div class="line">			out.flush();</div><div class="line">			out.close();</div><div class="line">		&#125; <span class="keyword">catch</span> (DoubanException | IOException | InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>  
<p>å¦‚ä¸‹æ‰€ç¤ºä¸ºTop250çš„éƒ¨åˆ†ID:  </p>
<pre><code>1292052
1295644
1292720
1291546
1292063
1292001
1295124
1291561
</code></pre><h4 id="è·å–æ¯ä¸€éƒ¨ç”µå½±çš„ä¿¡æ¯"><a href="#è·å–æ¯ä¸€éƒ¨ç”µå½±çš„ä¿¡æ¯" class="headerlink" title="è·å–æ¯ä¸€éƒ¨ç”µå½±çš„ä¿¡æ¯"></a>è·å–æ¯ä¸€éƒ¨ç”µå½±çš„ä¿¡æ¯</h4><p>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getTop250Info</span><span class="params">()</span> </span>&#123;</div><div class="line">		File dirFile = <span class="keyword">new</span> File(FILEPATH);</div><div class="line">		File idFile = <span class="keyword">new</span> File(dirFile, <span class="string">"movie_id"</span>);</div><div class="line">		<span class="keyword">if</span> (!idFile.exists()) &#123;</div><div class="line">			System.err.println(<span class="string">"movie id file not exist!"</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		LinkedHashSet&lt;String&gt; castSet = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line">		LinkedHashSet&lt;String&gt; dirSet = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</div><div class="line"></div><div class="line">		BufferedWriter writer;</div><div class="line">		BufferedReader reader;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File mvFile = <span class="keyword">new</span> File(dirFile, <span class="string">"movie_info"</span>);</div><div class="line">			<span class="keyword">if</span> (!mvFile.exists())</div><div class="line">				mvFile.createNewFile();</div><div class="line">			writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(mvFile, <span class="keyword">false</span>));</div><div class="line"></div><div class="line">			reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(idFile));</div><div class="line"></div><div class="line">			DoubanBookMovieMusicService instance = <span class="keyword">new</span> DoubanBookMovieMusicService();</div><div class="line">			DoubanSubjectObj result = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">			String id = <span class="string">""</span>;</div><div class="line">			<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				id = reader.readLine();</div><div class="line">				<span class="keyword">if</span> (id == <span class="keyword">null</span> || id.equals(<span class="string">"#"</span>))</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				count++;</div><div class="line">				System.out.println(count + <span class="string">": "</span> + id);</div><div class="line"></div><div class="line">				<span class="keyword">long</span> l = Long.parseLong(id);</div><div class="line"></div><div class="line">				<span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">while</span> (flag) &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						result = instance.getV2MovieInfoById(l);</div><div class="line">						flag = <span class="keyword">false</span>;</div><div class="line">					&#125; <span class="keyword">catch</span> (NoHttpResponseException | SocketTimeoutException e) &#123;</div><div class="line">						System.out.println(<span class="string">"NoHttpResponseException"</span>);</div><div class="line">						Thread.sleep(<span class="number">2000</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(result.getId() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getTitle() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getRating().getAverage() + <span class="string">" "</span>);</div><div class="line"></div><div class="line">				List&lt;DoubanCastObject&gt; castList = result.getCasts();</div><div class="line">				<span class="keyword">boolean</span> first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (DoubanCastObject cast : castList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(cast.getId());</div><div class="line">					castSet.add(cast.getId());</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span>);</div><div class="line"></div><div class="line">				List&lt;DoubanDirectorObj&gt; dirList = result.getDirectors();</div><div class="line">				first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (DoubanDirectorObj dir : dirList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(dir.getId());</div><div class="line">					dirSet.add(dir.getId());</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span>);</div><div class="line"></div><div class="line">				List&lt;String&gt; strList = result.getCountries();</div><div class="line">				first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (String str : strList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(str);</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span>);</div><div class="line"></div><div class="line">				strList = result.getGenres();</div><div class="line">				first = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">for</span> (String str : strList) &#123;</div><div class="line">					<span class="keyword">if</span> (!first)</div><div class="line">						writer.write(<span class="string">"#"</span>);</div><div class="line">					writer.write(str);</div><div class="line">					first = <span class="keyword">false</span>;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(<span class="string">" "</span> + result.getYear());</div><div class="line">				writer.newLine();</div><div class="line">				writer.flush();</div><div class="line">				Thread.sleep(<span class="number">3000</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			reader.close();</div><div class="line">			writer.close();</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"Get movie !"</span>);</div><div class="line"></div><div class="line">			File castIdFile = <span class="keyword">new</span> File(dirFile, <span class="string">"cast_id"</span>);</div><div class="line">			<span class="keyword">if</span> (!castIdFile.exists())</div><div class="line">				castIdFile.createNewFile();</div><div class="line">			BufferedWriter castIdWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(</div><div class="line">					castIdFile, <span class="keyword">true</span>));</div><div class="line">			Iterator&lt;String&gt; it = castSet.iterator();</div><div class="line">			<span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">				castIdWriter.write(it.next());</div><div class="line">				castIdWriter.newLine();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			castIdWriter.write(<span class="string">"#"</span>);</div><div class="line">			castIdWriter.flush();</div><div class="line">			castIdWriter.close();</div><div class="line"></div><div class="line">			File dirIdFile = <span class="keyword">new</span> File(dirFile, <span class="string">"dir_id"</span>);</div><div class="line">			<span class="keyword">if</span> (!dirIdFile.exists())</div><div class="line">				dirIdFile.createNewFile();</div><div class="line">			BufferedWriter dirIdWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(</div><div class="line">					dirIdFile, <span class="keyword">true</span>));</div><div class="line">			it = dirSet.iterator();</div><div class="line">			<span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">				dirIdWriter.write(it.next());</div><div class="line">				dirIdWriter.newLine();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			dirIdWriter.write(<span class="string">"#"</span>);</div><div class="line">			dirIdWriter.flush();</div><div class="line">			dirIdWriter.close();</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException | DoubanException | InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è·å–ç”µå½±ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬åŒæ—¶åˆ©ç”¨å“ˆå¸Œé›†ç»Ÿè®¡äº†æ¼”å‘˜çš„IDå’Œå¯¼æ¼”çš„IDï¼Œç›®çš„æ˜¯ä¸ºäº†è¿›ä¸€æ­¥ç»Ÿè®¡å½±äººçš„å…·ä½“ä¿¡æ¯ã€‚  </p>
<p>åœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè±†ç“£ä¸ºäº†é˜²æ­¢æ¶æ„è®¿é—®ï¼Œå¯¹æ¯åˆ†é’Ÿè¯·æ±‚çš„æ¬¡æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œå®˜æ–¹æ–‡æ¡£è¯´ä¸º40æ¬¡/åˆ†é’Ÿï¼Œç»è¿‡å®éªŒå‘ç°ï¼Œè¿™ä¸ªæ—¶é—´å¹¶ä¸å‡†ç¡®ï¼Œæœ€åæˆ‘ä»¬é‡‡ç”¨3sä¸€æ¬¡çš„è¯·æ±‚è¿›è¡Œäº†è¿ç»­çš„è®¿é—®ã€‚å¦‚æœè¯·æ±‚æ¬¡æ•°è¿‡åº¦é¢‘ç¹ï¼Œåˆ™ä¼šå‡ºç°è­¦å‘Šé¡µé¢ï¼ŒåŒæ—¶å¯¼è‡´åœ¨è¯¥IPä¸‹è‹¥å¹²å°æ—¶å†…æ— æ³•ç»§ç»­è®¿é—®ã€‚</p>
<p>æœ€åè·å–çš„ç”µå½±ä¿¡æ¯éƒ¨åˆ†ç»“æœå¦‚ä¸‹æ‰€ç¤º(idï¼Œåç§°ï¼Œå¹³åˆ†ï¼Œæ¼”å‘˜idé›†åˆï¼Œå¯¼æ¼”idé›†åˆï¼Œå›½å®¶ï¼Œæ ‡ç­¾é›†åˆï¼Œå‘è¡Œå¹´ä»½)ï¼š  </p>
<pre><code>1292052 è‚–ç”³å…‹çš„æ•‘èµ 9.6 1054521#1054534#1041179#1000095 1047973 ç¾å›½ çŠ¯ç½ª#å‰§æƒ… 1994
1295644 è¿™ä¸ªæ€æ‰‹ä¸å¤ªå†· 9.4 1025182#1054454#1010507#1019050 1031876 æ³•å›½ å‰§æƒ…#åŠ¨ä½œ#çŠ¯ç½ª 1994
1292720 é˜¿ç”˜æ­£ä¼  9.4 1054450#1002676#1031848#1031912 1053564 ç¾å›½ å‰§æƒ…#çˆ±æƒ… 1994
1291546 éœ¸ç‹åˆ«å§¬ 9.4 1003494#1050265#1035641#1000905 1023040 ä¸­å›½å¤§é™†#é¦™æ¸¯ å‰§æƒ…#çˆ±æƒ…#åŒæ€§ 1993
1292063 ç¾ä¸½äººç”Ÿ 9.4 1041004#1000375#1000368#1082051 1041004 æ„å¤§åˆ© å‰§æƒ…#æˆ˜äº‰ 1997
1292001 æµ·ä¸Šé’¢ç´å¸ˆ 9.2 1025176#1010659#1027407#1009391 1018983 æ„å¤§åˆ© å‰§æƒ…#éŸ³ä¹ 1998
1295124 è¾›å¾·å‹’çš„åå• 9.4 1031220#1054393#1006956#1041165 1054440 ç¾å›½ å‰§æƒ…#å†å²#æˆ˜äº‰ 1993
1291561 åƒä¸åƒå¯» 9.2 1023337#1005438#1045797#1025558 1054439 æ—¥æœ¬ å‰§æƒ…#åŠ¨ç”»#å¥‡å¹» 2001
2131459 æœºå™¨äººæ€»åŠ¨å‘˜ 9.3 1009535#1000389#1018022#1049585 1036450 ç¾å›½ å–œå‰§#çˆ±æƒ…#ç§‘å¹» 2008
1292722 æ³°å¦å°¼å…‹å· 9.1 1041029#1054446#1031864#1010555 1022571 ç¾å›½ å‰§æƒ…#çˆ±æƒ…#ç¾éš¾ 1997
3541415 ç›—æ¢¦ç©ºé—´ 9.2 1041029#1101703#1012520#1027181 1054524 ç¾å›½#è‹±å›½ å‰§æƒ…#åŠ¨ä½œ#ç§‘å¹» 2010
3793023 ä¸‰å‚»å¤§é—¹å®è±å 9.1 1031931#1049635#1018290#1032430 1286677 å°åº¦ å‰§æƒ…#å–œå‰§#çˆ±æƒ… 2009  
</code></pre><p>å…¶ä¸­æ‰€æœ‰çš„æ¼”å‘˜å’Œå¯¼æ¼”çš„ä¿¡æ¯ç”¨è±†ç“£èµ‹äºˆçš„IDè¡¨ç¤ºï¼ŒIDæ˜¯è±†ç“£é‡‡ç”¨çš„å”¯ä¸€æ ‡ç¤ºå½±äººçš„åºå·ã€‚ç”±äºè±†ç“£æä¾›çš„ç”µå½±ä¿¡æ¯å†…å®¹ä¸å®Œå…¨è§„èŒƒï¼ŒåŒä¸€ä¸ªå½±äººå¯èƒ½åœ¨ä¸åŒç”µå½±ä¸­ä½¿ç”¨äº†ä¸åŒçš„åå­—ï¼Œä¾‹å¦‚åå­—æ‹¼å†™ã€ç¿»è¯‘ä¸åŒï¼Œæ‰€ä»¥é‡‡ç”¨IDè€Œä¸æ˜¯å½±äººçš„åå­—æ¥è¿›è¡Œæ•°æ®åˆ†æã€‚  </p>
<h4 id="è·å–å½±äººä¿¡æ¯"><a href="#è·å–å½±äººä¿¡æ¯" class="headerlink" title="è·å–å½±äººä¿¡æ¯"></a>è·å–å½±äººä¿¡æ¯</h4><p>å› ä¸ºéœ€è¦å¯¹ç”·å¥³æ¼”å‘˜è¿›è¡Œåˆ†åˆ«ç»Ÿè®¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹å½±äººçš„è¯¦ç»†ä¿¡æ¯åˆè¿›è¡Œäº†è·å–ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getCastInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">		File dirFile = <span class="keyword">new</span> File(FILEPATH);</div><div class="line">		File idFile = <span class="keyword">new</span> File(dirFile, <span class="string">"dir_id"</span>);</div><div class="line">		<span class="keyword">if</span> (!idFile.exists()) &#123;</div><div class="line">			System.err.println(<span class="string">"cast id file not exist!"</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		BufferedWriter writer;</div><div class="line">		BufferedReader reader;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			File infoFile = <span class="keyword">new</span> File(dirFile, <span class="string">"dir_info"</span>);</div><div class="line">			<span class="keyword">if</span> (!infoFile.exists())</div><div class="line">				infoFile.createNewFile();</div><div class="line">			writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(infoFile, <span class="keyword">false</span>));</div><div class="line"></div><div class="line">			reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(idFile));</div><div class="line"></div><div class="line">			DoubanBookMovieMusicService instance = <span class="keyword">new</span> DoubanBookMovieMusicService();</div><div class="line">			DoubanCastObject result = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">			String id = <span class="string">""</span>;</div><div class="line">			<span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">				id = reader.readLine();</div><div class="line">				<span class="keyword">if</span> (id == <span class="keyword">null</span> || id.equals(<span class="string">"#"</span>))</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				count++;</div><div class="line">				System.out.println(count + <span class="string">": "</span> + id);</div><div class="line"></div><div class="line">				<span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">				<span class="keyword">while</span> (flag) &#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						result = instance.getMoviesCast(id);</div><div class="line">						flag = <span class="keyword">false</span>;</div><div class="line">					&#125; <span class="keyword">catch</span> (NoHttpResponseException | SocketTimeoutException e) &#123;</div><div class="line">						System.out.println(<span class="string">"NoHttpResponseException"</span>);</div><div class="line">						Thread.sleep(<span class="number">2000</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				writer.write(result.getId() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getName() + <span class="string">" "</span>);</div><div class="line">				writer.write(result.getGender());</div><div class="line">				writer.newLine();</div><div class="line">				writer.flush();</div><div class="line">				Thread.sleep(<span class="number">4000</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			reader.close();</div><div class="line">			writer.close();</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"Get movie !"</span>);</div><div class="line"></div><div class="line">		&#125; <span class="keyword">catch</span> (IOException | DoubanException | InterruptedException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>è·å–çš„éƒ¨åˆ†æ¼”å‘˜ä¿¡æ¯å¦‚ä¸‹(idï¼Œåå­—ï¼Œæ€§åˆ«)ï¼š</p>
<pre><code>1054521 è’‚å§†Â·ç½—å®¾æ–¯ ç”·
1054534 æ‘©æ ¹Â·å¼—é‡Œæ›¼ ç”·
1041179 é²å‹ƒÂ·å†ˆé¡¿ ç”·
1000095 å¨å»‰å§†Â·èµ›å¾·å‹’ ç”·
1025182 è®©Â·é›·è¯º ç”·
1054454 å¨œå¡”è‰Â·æ³¢ç‰¹æ›¼ å¥³
1010507 åŠ é‡ŒÂ·å¥¥å¾·æ›¼ ç”·
1019050 ä¸¹å°¼Â·çˆ±ç½— ç”·
1054450 æ±¤å§†Â·æ±‰å…‹æ–¯ ç”·
1002676 ç½—å®¾Â·æ€€ç‰¹ å¥³
1031848 åŠ é‡ŒÂ·è¥¿å°¼æ–¯ ç”·
1031912 éº¦å‡¯å°”æ³°Â·å¨å»‰é€Š ç”·
1003494 å¼ å›½è£ ç”·
1050265 å¼ ä¸°æ¯… ç”·
1035641 å·©ä¿ å¥³
</code></pre><p>è·å–çš„å¯¼æ¼”ä¿¡æ¯å¦‚ä¸‹ï¼š  </p>
<pre><code>1047973 å¼—å…°å…‹Â·å¾·æ‹‰é‚¦ç‰¹ ç”·
1031876 å•å…‹Â·è´æ¾ ç”·
1053564 ç½—ä¼¯ç‰¹Â·æ³½ç±³å‰æ–¯ ç”·
1023040 é™ˆå‡¯æ­Œ ç”·
1041004 ç½—ä¼¯æ‰˜Â·è´å°¼å°¼ ç”·
1018983 æœ±å¡ä½©Â·æ‰˜çº³å¤šé›· ç”·
1054440 å²è’‚æ–‡Â·æ–¯çš®å°”ä¼¯æ ¼ ç”·
1054439 å®«å´éª ç”·  
</code></pre><h4 id="æ•°æ®å®Œå–„"><a href="#æ•°æ®å®Œå–„" class="headerlink" title="æ•°æ®å®Œå–„"></a>æ•°æ®å®Œå–„</h4><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè·å–çš„æºæ•°æ®å½¢å¼å¹¶ä¸è§„èŒƒï¼Œå½±äººçš„åå­—æ ¼å¼å¤šæ ·ï¼Œæœ‰çš„å½±äººæ²¡æœ‰æ€§åˆ«ä¿¡æ¯ï¼Œæ‰€ä»¥å¯¹æºæ•°æ®è¿›è¡Œè¿‡æ»¤ä¿®æ­£ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;è±†ç“£APIè¯´æ˜&quot;&gt;&lt;a href=&quot;#è±†ç“£APIè¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;è±†ç“£APIè¯´æ˜&quot;&gt;&lt;/a&gt;è±†ç“£APIè¯´æ˜&lt;/h3&gt;&lt;p&gt;è±†ç“£ä¸ºå¼€å‘è€…æä¾›äº†ç”¨äºåº”ç”¨å¼€å‘çš„&lt;a href=&quot;http://developers.douban.com/wiki/?title=api_v2&quot;&gt;Apiæ¥å£&lt;/a&gt;ï¼Œé€šè¿‡è¿™äº›Apiæ¥å£å¯ä»¥è·å¾—è±†ç“£çš„éƒ¨åˆ†å†…å®¹ã€‚  &lt;/p&gt;
&lt;p&gt;è±†ç“£Api V2è®¤è¯ä½¿ç”¨äº†OAuth2ï¼Œä½¿å¾—ç”¨æˆ·çš„æˆæƒè¿‡ç¨‹æ›´ä¸ºå®‰å…¨ï¼Œè¿”å›æ•°æ®çš„æ ¼å¼ä¸ºjsonï¼Œä¾¿äºåº”ç”¨å¼€å‘è€…è§£æè·å¾—çš„æ•°æ®ã€‚è±†ç“£æ²¡æœ‰æä¾›å®˜æ–¹çš„SDKï¼Œä½†æ˜¯æä¾›äº†å…¶ä»–éå®˜æ–¹çš„åŸºäºå¤šç§è¯­è¨€çš„SDKï¼Œæˆ‘ä»¬é‡‡ç”¨äº†Javaè¯­è¨€çš„&lt;a href=&quot;https://github.com/UglyTroLL/Douban-Java-SDK-OAuth2&quot;&gt;SDK&lt;/a&gt;ã€‚ç”±äºè¯¥ç‰ˆæœ¬çš„Java SDKåŸºäºè¾ƒæ—©çš„è±†ç“£APIçš„v1ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œéƒ¨åˆ†ä¿®æ”¹é€‚åº”æ–°çš„v2ç‰ˆæœ¬ï¼Œå…¶ä¸­æˆ‘ä»¬ä¿®æ”¹äº†ç”µå½±ç›¸å…³çš„ä»£ç (&lt;a href=&quot;https://github.com/ITanCh/Douban-Java-SDK-OAuth2&quot;&gt;æ–°çš„æºä»£ç &lt;/a&gt;)ã€‚  &lt;/p&gt;
&lt;p&gt;Java SDKä¸ºMavenå·¥ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨Mavenç¼–è¯‘æ‰“åŒ…ï¼š  &lt;/p&gt;
&lt;figure class=&quot;highlight stylus&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mvn package -Dmaven&lt;span class=&quot;selector-class&quot;&gt;.test&lt;/span&gt;&lt;span class=&quot;selector-class&quot;&gt;.skip&lt;/span&gt;=true&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;  
&lt;p&gt;ä¸ºäº†å°†æ‰€æœ‰ä¾èµ–ä¸€èµ·æ‰“åŒ…è¿›å»ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†fatjarå·¥å…·è¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆå¯ä»¥è°ƒç”¨çš„å‡½æ•°åº“(&lt;a href=&quot;https://github.com/ITanCh/Douban-Java-SDK-OAuth2/raw/origin/Douban-Java-SDK-OAuth2-origin_fat.jar&quot;&gt;jar&lt;/a&gt;)ã€‚&lt;br&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="è±†ç“£" scheme="http://itanch.github.io/tags/%E8%B1%86%E7%93%A3/"/>
    
      <category term="ç”µå½±" scheme="http://itanch.github.io/tags/%E7%94%B5%E5%BD%B1/"/>
    
  </entry>
  
  <entry>
    <title>Torqueå®‰è£…ç¬”è®°(å¤šubuntuèŠ‚ç‚¹)</title>
    <link href="http://itanch.github.io/2015/08/06/Torque%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>http://itanch.github.io/2015/08/06/Torqueå­¦ä¹ ç¬”è®°/</id>
    <published>2015-08-06T03:59:57.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>1.å®éªŒç³»ç»Ÿubuntu14.04ã€‚æ›´æ–°ç³»ç»Ÿè½¯ä»¶ï¼Œé˜²æ­¢ç›¸å…³è½¯ä»¶ç‰ˆæœ¬è¿‡ä½  </p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-<span class="built_in">get</span> <span class="keyword">update</span>  </div><div class="line">sudo apt-<span class="built_in">get</span> upgrade</div></pre></td></tr></table></figure>
<p>2.ä»å®˜ç½‘ä¸‹è½½Torqueï¼Œåœ¨è¿™é‡Œä¸ºTorque 5.1.1ã€‚  </p>
<p>3.è§£å‹æ–‡ä»¶</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -xzvf torque<span class="selector-class">.tar</span><span class="selector-class">.gz</span></div></pre></td></tr></table></figure>
<p>4.è¿è¡Œconfigureï¼Œå¯åŠ prefixæŒ‡å®šTorqueå‘½ä»¤å®‰è£…ä½ç½®ï¼Œä¹Ÿå¯ä¸åŠ ï¼Œä¸åŠ å‚æ•°å‘½ä»¤é»˜è®¤è£…åœ¨/usr/local/binå’Œ/usr/local/sbinä¸‹ã€‚åˆ©ç”¨configureå¯ä»¥æ£€æµ‹ä¾èµ–è½¯ä»¶ï¼ŒæŒ‰ç…§æç¤ºå®‰è£…è¿™äº›è½¯ä»¶ã€‚</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">.<span class="regexp">/configure --prefix=/u</span>sr<span class="regexp">/local/</span>torque</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>5.ç¼–è¯‘å®‰è£…</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">make</span>  </div><div class="line"><span class="built_in">make</span> install</div></pre></td></tr></table></figure>
<p>6.ç”Ÿæˆå­èŠ‚ç‚¹å®‰è£…åŒ…ï¼Œmomå’Œclientsä¸ºéœ€è¦æ‹·è´çš„æ–‡ä»¶ã€‚éœ€è¦å®‰è£…sshï¼Œubuntué»˜è®¤å®‰è£…openssh-clientï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å†å®‰è£…openssh-serverï¼Œè®©å…¶ä»–è®¡ç®—æœºç™»é™†ã€‚  </p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">make packages</div><div class="line"><span class="keyword">scp </span>tpackages name@ip:<span class="keyword">dir </span> <span class="comment">#éå¿…è¦</span></div><div class="line"><span class="keyword">scp </span>torque-package-mom-linux-x86_64.<span class="keyword">sh </span>name@ip:<span class="keyword">dir </span> </div><div class="line"><span class="keyword">scp </span>torque-package-clients-linux-x86_64.<span class="keyword">sh </span>name@ip:<span class="keyword">dir</span></div></pre></td></tr></table></figure>
<p>7.åœ¨å­èŠ‚ç‚¹ä¸Šå®‰è£…ï¼Œmomå’Œclientsã€‚</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo ./torque-<span class="keyword">package</span>-mom-linux-x86_64.sh <span class="comment">--install</span></div><div class="line">sudo ./torque-<span class="keyword">package</span>-clients-linux-x86_64.sh <span class="comment">--install</span></div></pre></td></tr></table></figure>
<p>8.é…ç½®ä¸»èŠ‚  </p>
<ul>
<li>å°†/usr/local/torque/binå’Œ/usr/local/torque/sbinæ·»åŠ è¿›ç¯å¢ƒå˜é‡ï¼Œè¿™é‡Œæˆ‘å°†å…¶æ·»åŠ å…¥.bashrcæ–‡ä»¶ã€‚  </li>
</ul>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export PATH=<span class="variable">$PATH</span><span class="symbol">:/usr/local/torque/bin</span><span class="symbol">:/usr/local/torque/sbin</span>  </div></pre></td></tr></table></figure>  
<ul>
<li>æ·»åŠ å…±äº«åº“åˆ°Torqueçš„é…ç½®æ–‡ä»¶ä¸­ï¼ˆå¦‚æœå‡ºç°æœ‰ä»€ä¹ˆåº“æ‰¾ä¸åˆ°ï¼Œåˆ™å¿…é¡»åŠ ä¸Šï¼‰  </li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">echo <span class="string">'/usr/local/lib'</span> &gt; /etc/ld<span class="selector-class">.so</span><span class="selector-class">.conf</span><span class="selector-class">.d</span>/torque<span class="selector-class">.conf</span></div><div class="line">ldconfig  </div></pre></td></tr></table></figure>
<ul>
<li>æ·»åŠ ä¸»èŠ‚ç‚¹åå­—ï¼š  </li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo ä¸»èŠ‚ç‚¹åå­— &gt; <span class="regexp">/var/</span>spool<span class="regexp">/torque/</span>server_name  </div></pre></td></tr></table></figure>  
<ul>
<li>åˆå§‹åŒ–serverdbæ–‡ä»¶ï¼Œåœ¨ä½¿ç”¨pbs_severä¹‹å‰å¿…é¡»å®Œæˆè¯¥æ­¥éª¤ï¼š</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./torque<span class="selector-class">.setup</span> ç”¨æˆ·å</div></pre></td></tr></table></figure>
<ul>
<li>æ·»åŠ å­èŠ‚ç‚¹ï¼Œnpä¸ºèŠ‚ç‚¹cpuæ ¸ä¸ªæ•°  </li>
</ul>
<p>vi /var/spool/torque/server_priv/nodes<br>å­èŠ‚ç‚¹çš„åå­—ä¸ºè®¡ç®—æœºåï¼Œè€Œéç”¨æˆ·åã€‚æ¯æ¬¡æ·»åŠ èŠ‚ç‚¹éœ€è¦é‡å¯pbs_severã€‚æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼ˆä¹Ÿå¯ä»¥å…ˆåœ¨å­èŠ‚ç‚¹å¯åŠ¨momï¼Œåœ¨ä¸»èŠ‚ç‚¹å¯åŠ¨serverï¼Œç„¶åç”¨å‘½ä»¤<code>qmgr -c &#39;create node ubuntu np=4&#39;</code>è¿›è¡Œæ·»åŠ èŠ‚ç‚¹ï¼‰ï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">å­èŠ‚ç‚¹<span class="number">1</span>åå­— np=<span class="number">4</span>  </div><div class="line">å­èŠ‚ç‚¹<span class="number">2</span>åå­— np=<span class="number">4</span></div></pre></td></tr></table></figure></p>
<ul>
<li>å¯åŠ¨</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">pbs_server</span></div><div class="line">pbs_sched  </div><div class="line">pbs_mom</div></pre></td></tr></table></figure>
<p>9.é…ç½®å­èŠ‚ç‚¹ï¼ŒåŒæ ·éœ€è¦æ·»åŠ ç¯å¢ƒå˜é‡ã€‚  </p>
<ul>
<li><p>ä¿®æ”¹config<br>ä½¿ç”¨make packages å‘½ä»¤ç”Ÿæˆmomå®‰è£…äºå­èŠ‚ç‚¹çš„ï¼Œæ— éœ€è¿›è¡Œè¿™ä¸€æ­¥ã€‚</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> vi <span class="meta-keyword">/var/</span>spool<span class="meta-keyword">/torque/</span>mom_priv/config  </div><div class="line">æ·»åŠ ï¼š  </div><div class="line">pbsserver ä¸»èŠ‚ç‚¹åç§°  </div><div class="line">logevent <span class="number">255</span>  </div></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ï¼š</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pbs_mom</div></pre></td></tr></table></figure>
<p>10.æ³¨æ„ï¼å› ä¸ºé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨äº†<em>ä¸»èŠ‚ç‚¹åç§°</em>å’Œ<em>å­èŠ‚ç‚¹åç§°</em>ï¼Œæ‰€ä»¥ä¸»ã€ä»èŠ‚ç‚¹éƒ½éœ€è¦ä¿®æ”¹</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/hosts  </div><div class="line">æ·»åŠ è¿™äº›åç§°å’Œå¯¹åº”çš„<span class="built_in">ip</span></div></pre></td></tr></table></figure>
<p>11.æ£€æŸ¥è¿è¡Œæƒ…å†µ<br>ä¿è¯åœ¨serverä¸Šè¿è¡Œ<code>trqauthd</code>ã€<code>pbs_server</code>ã€<code>pbs_sched</code>è¿™ä¸‰ä¸ªç¨‹åºã€‚<br>ä¿è¯åœ¨å­èŠ‚ç‚¹ä¸Šè¿è¡Œ<code>pbs_mom</code>ã€‚</p>
<p>12.å¸¸ç”¨å‘½ä»¤<br><code>pbsnodes</code>: å­èŠ‚ç‚¹ä¿¡æ¯ã€‚<br><code>qterm</code>: ç»“æŸpbs_serverã€‚<br><code>qsub</code>: æäº¤jobã€‚<br><code>qstat</code>: jobè¿è¡Œä¿¡æ¯ã€‚</p>
<p>13.æµ‹è¯•ï¼š<br>æ³¨æ„ï¼åœ¨æäº¤Jobæ—¶ï¼Œéœ€è¦ä¸»èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹ä¸ºç›¸åŒçš„ç”¨æˆ·åï¼ŒåŒæ—¶ä¿è¯æ“ä½œçš„æ–‡ä»¶ç›®å½•ä¹Ÿç›¸åŒã€‚<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">echo <span class="string">"sleep 300"</span> <span class="string">| qsub  </span></div><div class="line">qstat</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;1.å®éªŒç³»ç»Ÿubuntu14.04ã€‚æ›´æ–°ç³»ç»Ÿè½¯ä»¶ï¼Œé˜²æ­¢ç›¸å…³è½¯ä»¶ç‰ˆæœ¬è¿‡ä½  &lt;/p&gt;
&lt;figure class=&quot;highlight q&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-&lt;span class=&quot;built_in&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;update&lt;/span&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo apt-&lt;span class=&quot;built_in&quot;&gt;get&lt;/span&gt; upgrade&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2.ä»å®˜ç½‘ä¸‹è½½Torqueï¼Œåœ¨è¿™é‡Œä¸ºTorque 5.1.1ã€‚  &lt;/p&gt;
&lt;p&gt;3.è§£å‹æ–‡ä»¶&lt;/p&gt;
&lt;figure class=&quot;highlight stylus&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;tar -xzvf torque&lt;span class=&quot;selector-class&quot;&gt;.tar&lt;/span&gt;&lt;span class=&quot;selector-class&quot;&gt;.gz&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;4.è¿è¡Œconfigureï¼Œå¯åŠ prefixæŒ‡å®šTorqueå‘½ä»¤å®‰è£…ä½ç½®ï¼Œä¹Ÿå¯ä¸åŠ ï¼Œä¸åŠ å‚æ•°å‘½ä»¤é»˜è®¤è£…åœ¨/usr/local/binå’Œ/usr/local/sbinä¸‹ã€‚åˆ©ç”¨configureå¯ä»¥æ£€æµ‹ä¾èµ–è½¯ä»¶ï¼ŒæŒ‰ç…§æç¤ºå®‰è£…è¿™äº›è½¯ä»¶ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight awk&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;.&lt;span class=&quot;regexp&quot;&gt;/configure --prefix=/u&lt;/span&gt;sr&lt;span class=&quot;regexp&quot;&gt;/local/&lt;/span&gt;torque&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="ubuntu" scheme="http://itanch.github.io/tags/ubuntu/"/>
    
      <category term="Torque" scheme="http://itanch.github.io/tags/Torque/"/>
    
  </entry>
  
  <entry>
    <title>ubuntu14.04åŸºæœ¬é…ç½®</title>
    <link href="http://itanch.github.io/2015/08/06/ubuntu14-04%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/"/>
    <id>http://itanch.github.io/2015/08/06/ubuntu14-04åŸºæœ¬é…ç½®/</id>
    <published>2015-08-06T03:59:57.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ›´æ–°ï¼š"><a href="#æ›´æ–°ï¼š" class="headerlink" title="æ›´æ–°ï¼š"></a>æ›´æ–°ï¼š</h2><figure class="highlight q"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-<span class="built_in">get</span> <span class="keyword">update</span>  </div><div class="line">$ sudo apt-<span class="built_in">get</span> upgrade</div></pre></td></tr></table></figure>
<h2 id="å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š"><a href="#å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š" class="headerlink" title="å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š"></a>å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo<span class="built_in"> add-apt-repository </span>ppa:fcitx-team/nightly	<span class="comment">#æ·»åŠ fcitxæº</span></div><div class="line">$ sudo apt-get install fcitx  </div><div class="line"><span class="comment">#ä¸‹è½½æœç‹—è¾“å…¥æ³•åŒå‡»å®‰è£…</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="å®‰è£…JDKï¼š"><a href="#å®‰è£…JDKï¼š" class="headerlink" title="å®‰è£…JDKï¼š"></a>å®‰è£…JDKï¼š</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ä¸‹è½½æœ€è¿‘çš„jdkåŒ…  </span></div><div class="line">$ sudo mv jdk.tar.gz /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">jvm</span>/  </span></div><div class="line">$ cd /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">jvm</span>/  </span></div><div class="line">$ sudo tar -zxvf jdk.tar.gz  </div><div class="line">$ sudo rm jdk.tar.gz  </div><div class="line"></div><div class="line">$ sudo update-alternatives --install /usr/bin/java java /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">jvm</span>/<span class="title">jdk</span>/<span class="title">bin</span>/<span class="title">java</span> 300  </span></div><div class="line">$ sudo update-alternatives --install /usr/bin/javac javac /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">jvm</span>/<span class="title">jdk</span>/<span class="title">bin</span>/<span class="title">javac</span> 300</span></div><div class="line"></div><div class="line"><span class="comment">#é€‰æ‹©é»˜è®¤javaåº“</span></div><div class="line">$ sudo update-alternatives --config java  </div><div class="line">$ java -version	<span class="comment">#æµ‹è¯•</span></div></pre></td></tr></table></figure>
<h2 id="å®‰è£…Eclispe"><a href="#å®‰è£…Eclispe" class="headerlink" title="å®‰è£…Eclispe"></a>å®‰è£…Eclispe</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ä¸‹è½½æœ€æ–°çš„elipseåŒ…  </span></div><div class="line"></div><div class="line">$ sudo mv eclipse.tar.gz /opt/</div><div class="line">$ <span class="built_in">cd</span> /opt/</div><div class="line">$ sudo tar -zxvf eclipse.tar.gz</div><div class="line">$ sudo rm eclipse.tar.gz</div><div class="line"></div><div class="line"><span class="comment">#è‹¥æƒ³ä»å‘½ä»¤è¡Œå¯åŠ¨  </span></div><div class="line">$ sudo ln -sf /opt/eclipse/eclipse /usr/bin</div><div class="line"></div><div class="line"><span class="comment">#åˆ›å»ºæ¡Œé¢å›¾æ ‡  </span></div><div class="line">$ sudo vi /usr/share/applications/eclipse.desktop</div><div class="line"><span class="comment">#æ·»åŠ å¦‚ä¸‹å†…å®¹  </span></div><div class="line">[Desktop Entry]</div><div class="line">Type=Application</div><div class="line">Name=Eclipse</div><div class="line">Comment=Eclipse Integrated Development Environment</div><div class="line">Icon=/opt/eclipse/icon.xpm</div><div class="line">Exec=eclipse</div><div class="line">Terminal=<span class="literal">false</span></div><div class="line">Categories=Development;IDE;Java;</div></pre></td></tr></table></figure>
<h2 id="é…ç½®Android-SDK"><a href="#é…ç½®Android-SDK" class="headerlink" title="é…ç½®Android SDK:"></a>é…ç½®Android SDK:</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ä»å®˜ç½‘ä¸‹è½½æœ€æ–°çš„SDK</span></div><div class="line"></div><div class="line"><span class="comment">#å°†æ–‡ä»¶è§£å‹åˆ°ç›®æ ‡æ–‡ä»¶å¤¹/opt/</span></div><div class="line"></div><div class="line"><span class="variable">$ </span>cd /opt/android-sdk/tools</div><div class="line"></div><div class="line"><span class="variable">$ </span>sudo  ./android <span class="comment">#è¿è¡ŒAndroid SDK Manager,ä¸‹è½½platfor-toolså’Œbulid-tools</span></div><div class="line"></div><div class="line"><span class="variable">$ </span>sudo chmod <span class="number">777</span> android-sdk	<span class="comment">#ä¿®æ”¹æ‰€æœ‰æ–‡ä»¶çš„æƒé™,ä½¿ä¹‹å¯ä»¥è¿è¡Œ</span></div><div class="line"></div><div class="line"><span class="comment">#64ä½çš„ubuntu 13.10åŠä»¥ä¸Šç‰ˆæœ¬éœ€è¦å®‰è£…32ä½ç›¸å…³çš„åº“</span></div><div class="line"><span class="variable">$ </span>sudo dpkg --add-architecture i386</div><div class="line"><span class="variable">$ </span>sudo apt-get update</div><div class="line"><span class="variable">$ </span>sudo apt-get install <span class="symbol">libncurses5:</span>i386 libstdc++<span class="number">6</span><span class="symbol">:i386</span> <span class="symbol">zlib1g:</span>i386</div><div class="line"></div><div class="line"><span class="variable">$ </span>sudo vi /ect/profile  </div><div class="line"><span class="comment">#æ·»åŠ å¦‚ä¸‹å†…å®¹</span></div><div class="line">export PATH=<span class="regexp">/opt/android</span>-sdk-linux/platform-<span class="symbol">tools:</span><span class="variable">$PATH</span>  </div><div class="line">export PATH=<span class="regexp">/opt/android</span>-sdk-linux/<span class="symbol">tools:</span><span class="variable">$PATH</span></div><div class="line"><span class="variable">$ </span>source /ect/profile</div></pre></td></tr></table></figure>
<h2 id="Firefox-Flashæ’ä»¶"><a href="#Firefox-Flashæ’ä»¶" class="headerlink" title="Firefox Flashæ’ä»¶"></a>Firefox Flashæ’ä»¶</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#ä¸‹è½½æœ€æ–°çš„Flash Player</span></div><div class="line"></div><div class="line">$ tar -zxvf flash.tar.gz</div><div class="line"><span class="comment">#è·å–flashplayer.so</span></div><div class="line"></div><div class="line">$ sudo cp libflashplayer.so /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">mozilla</span>/<span class="title">plugins</span></span></div></pre></td></tr></table></figure>
<h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><ol>
<li>å–æ¶ˆæŸä¸ªè½¯ä»¶(tomcat)å¼€æœºè‡ªå¯åŠ¨ã€‚</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo <span class="keyword">update</span>-rc.d tomcat <span class="keyword">disable</span></div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ›´æ–°ï¼š&quot;&gt;&lt;a href=&quot;#æ›´æ–°ï¼š&quot; class=&quot;headerlink&quot; title=&quot;æ›´æ–°ï¼š&quot;&gt;&lt;/a&gt;æ›´æ–°ï¼š&lt;/h2&gt;&lt;figure class=&quot;highlight q&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo apt-&lt;span class=&quot;built_in&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;update&lt;/span&gt;  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo apt-&lt;span class=&quot;built_in&quot;&gt;get&lt;/span&gt; upgrade&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š&quot;&gt;&lt;a href=&quot;#å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š&quot;&gt;&lt;/a&gt;å®‰è£…æœç‹—è¾“å…¥æ³•ï¼š&lt;/h2&gt;&lt;figure class=&quot;highlight smali&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo&lt;span class=&quot;built_in&quot;&gt; add-apt-repository &lt;/span&gt;ppa:fcitx-team/nightly	&lt;span class=&quot;comment&quot;&gt;#æ·»åŠ fcitxæº&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo apt-get install fcitx  &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#ä¸‹è½½æœç‹—è¾“å…¥æ³•åŒå‡»å®‰è£…&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="http://itanch.github.io/tags/%E6%8A%80%E6%9C%AF/"/>
    
      <category term="ubuntu" scheme="http://itanch.github.io/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://itanch.github.io/2015/08/01/hello/"/>
    <id>http://itanch.github.io/2015/08/01/hello/</id>
    <published>2015-07-31T23:33:44.000Z</published>
    <updated>2017-02-23T07:42:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>Tianchiâ€™s Blogä»Šå¤©è¯ç”Ÿäº†ï¼<br><img src="http://7xky03.com1.z0.glb.clouddn.com/helloa.jpg" alt="image">  </p>
<blockquote>
<p>å¤«å›å­ä¹‹è¡Œï¼Œé™ä»¥ä¿®èº«ï¼Œä¿­ä»¥å…»å¾·ã€‚<br>éæ¾¹æ³Šæ— ä»¥æ˜å¿—ï¼Œéå®é™æ— ä»¥è‡´è¿œã€‚<br>å¤«å­¦é¡»é™ä¹Ÿï¼Œæ‰é¡»å­¦ä¹Ÿï¼Œéå­¦æ— ä»¥å¹¿æ‰ï¼Œéå¿—æ— ä»¥æˆå­¦ã€‚<br>æ·«æ…¢åˆ™ä¸èƒ½åŠ±ç²¾ï¼Œé™©èºåˆ™ä¸èƒ½å†¶æ€§ã€‚<br>å¹´ä¸æ—¶é©°ï¼Œæ„ä¸æ—¥å»ï¼Œé‚æˆæ¯è½ï¼Œå¤šä¸æ¥ä¸–ï¼Œæ‚²å®ˆç©·åºï¼Œå°†å¤ä½•åŠï¼  </p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Tianchiâ€™s Blogä»Šå¤©è¯ç”Ÿäº†ï¼&lt;br&gt;&lt;img src=&quot;http://7xky03.com1.z0.glb.clouddn.com/helloa.jpg&quot; alt=&quot;image&quot;&gt;  &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¤«å›å­ä¹‹è¡Œï¼Œé™ä»¥ä¿®èº«ï¼Œä¿­ä»¥å…»å¾·ã€‚&lt;b
    
    </summary>
    
    
      <category term="è®°å½•" scheme="http://itanch.github.io/tags/%E8%AE%B0%E5%BD%95/"/>
    
  </entry>
  
</feed>
