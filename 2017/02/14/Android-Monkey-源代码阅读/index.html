<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android Monkey 源代码阅读 · Tianchi's Blog</title><meta name="description" content="Android Monkey 源代码阅读 - Tian chi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/long.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://itanch.github.io/atom.xml" title="Tianchi's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/long.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/ITanCh" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android Monkey 源代码阅读</h1><div class="post-info">Feb 14, 2017</div><div class="post-content"><h2 id="0-Monkey基本信息"><a href="#0-Monkey基本信息" class="headerlink" title="0. Monkey基本信息"></a>0. Monkey基本信息</h2><p>目前该工具位于源代码的位置：<code>development/cmds/monkey</code>。</p>
<p>生成的jar包位于：<code>out/traget/product/generic/system/framework/monkey.jar</code>。</p>
<p>在设备中，启动monkey的脚本位于<code>/system/bin/monkey</code>:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Script to start "monkey" on the device, which has a very rudimentary</span></div><div class="line"><span class="comment"># shell.</span></div><div class="line"><span class="comment">#</span></div><div class="line">base=/system</div><div class="line"><span class="built_in">export</span> CLASSPATH=<span class="variable">$base</span>/framework/monkey.jar</div><div class="line"><span class="built_in">trap</span> <span class="string">""</span> HUP</div><div class="line"><span class="built_in">exec</span> app_process <span class="variable">$base</span>/bin com.android.commands.monkey.Monkey $*</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="1-Monkey开始启动"><a href="#1-Monkey开始启动" class="headerlink" title="1. Monkey开始启动"></a>1. Monkey开始启动</h2><p><img src="http://img.blog.csdn.net/20160916145356103" alt="这里写图片描述"></p>
<ol>
<li>main函数只是设置了进程的名称，主要过程在run函数中执行。</li>
<li>获取参数，初始化参数和随机数。然后它会获取系统的一些服务，见1.3。获取需要启动的main activity，见1.4。创建一个MonkeySourceRoandom对象mEventSource，由他管理随机事件的生成，这里首先让它生成了一个启动main activity的事件放入了队列。monkey还支持通过脚本、网络获取事件，这里只说默认的随机情况。下面，它启动Network Monitor。接着，启动Monkey的循环过程，见1.5。等待测试结束后，则输出测试报告。</li>
<li>获取一些系统服务，有ActivityManager、WindowManager、PackageManager。给ActivityManager设置了一个ActivityController对象，该对象提供了Activity启动、crash获取、应用无响应等功能。最后，还注册了一个网络状态的监听器。</li>
<li>从PackageManager中获取符合条件的main activity，然后添加入<code>mMainApps</code>中。</li>
<li>这一步就会循环的生成测试事件见1.6、触发事件1.10。</li>
<li>从队列中获取第一个事件返回。如果队列为空，则生成一个放入队列，见1.7。</li>
<li>这里先生成一个随机数，根据随机数范围，决定具体生成哪一个事件。这里有点击、拖动、缩放（前三个，见1.8）、轨迹球（已经不常用了，可以忽略）、旋转、权限（见1.9）和键盘事件。</li>
<li>这里会首先利用DisplayManager获得屏幕的实际大小，然后随机的生成生成点坐标。Touch只需要一点就够了，而Drag则需要生成一系列的点，这里利用了randomWalk函数来随机的移动来生成下一个点坐标，然后将这一系列点坐标封装成事件放入队列。两指缩放同样使用了和Drag类似的方法，只不过是将一个点变为两个点。</li>
<li>从目标package中的权限列表中获取一个，然后生成一个MonkeyPersissionEvent。</li>
<li>MonkeyEvent是一个抽象类，具体的实现在其子类中。MotionEvent通过InputManager注入事件。旋转MonkeyRotationEvent通过WindowManager进行旋转。MonkeyPermissionEvent利用PackageManager授予、撤销应用的一些权限。MonkeyKeyEvent同样是使用InputManager进行注入。</li>
<li>这里还有一些其它事件。MonkeyActivityEvent的事件是由ActivityManager启动的。MonkeyCommandEvent则启动一个进程，执行命令即可。MonkeyFlipEvent，唤起键盘的操作，这里是向<code>/dev/input/event0</code>写入了一组字节。MonkeyGetAppFrameRateEvent和MonkeyGetFrameRateEvent，获取应用帧频，通过命令行执行来实现。MonkeyInstrumentationEvent, 利用ActivityManager启动Instrumentation组件。MonkeyNoopEvent，什么也不做，呵呵。MonkeyPowerEvent，从log信息中获取电量信息。MonkeyThrottleEvent和MonkeyWaitEvent，Thread.sleep休眠一段时间。</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/14/Android系统源码阅读-11-Android的InputManagerService的工作过程/" class="prev">上一篇</a><a href="/2017/02/14/Android系统源码阅读-10-Android应用程序的消息处理机制/" class="next">下一篇</a></div><div data-thread-key="2017/02/14/Android-Monkey-源代码阅读/" data-title="Android Monkey 源代码阅读" data-url="http://itanch.github.io/2017/02/14/Android-Monkey-源代码阅读/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"tianchi"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2017 <a href="http://itanch.github.io">Tian chi</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>